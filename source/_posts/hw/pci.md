---
title: Resizable PCI BAR
date: 2025-03-12 15:00:41
tags: [Hardware]
categories: hardware
---

![PCIe Type 0 (Non-Bridge) Configuration Space Header](/images/pci/Pci-config-space.svg)

<!--more-->

# PCI config space (<span style="color: red;">256 Bytes per Device</span>)

PCI config space 本质上是 64 个 32-bit 寄存器

```
pci 0000:00:00.0: config space:
00000000: 86 80 34 3e
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 01 90 d1 fe
00000000: c1 02 00 00
00000000: 01 00 00 e0
00000000: 00 00 00 fc
00000000: 01 00 00 00
00000000: 01 00 00 fc
00000000: 01 00 00 00
00000000: 01 00 80 8b
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 09 00 10 01
00000000: 00 00 00 00
00000000: 00 33 fb d8
00000000: 00 70 30 42
00000000: 27 c5 24 9d
00000000: 00 b0 1b 42
00000000: 00 00 00 00
00000000: 20 79 05 00
00000000: 00 70 30 42
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 0d e1 c3 9d
00000000: 00 33 fb d8
00000000: 00 70 30 42
00000000: 00 70 30 42
00000000: 00 00 00 00
00000000: 08 00 00 00
00000000: 80 b8 01 42
00000000: 18 b6 01 42
00000000: 00 00 00 00
00000000: 00 b6 01 42
00000000: 80 b8 01 42
00000000: 18 b6 01 42
00000000: 63 73 cb 9d
00000000: 38 b6 01 42
00000000: 00 38 ff 41
00000000: ff ff ff ff
00000000: 00 00 00 00
00000000: 80 b8 01 42
00000000: a5 0e 2f 9e
00000000: b8 7a 05 00
00000000: 00 33 fb d8
00000000: 00 33 fb d8
00000000: 90 86 05 42
00000000: 80 b8 01 42
00000000: ad 77 25 9d
00000000: 90 86 05 42
00000000: 80 b8 01 42
00000000: 00 00 00 00
00000000: b8 00 00 00
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: c0 78 1f 9f
00000000: 00 38 ff 41
00000000: 01 00 00 00
00000000: 95 b8 ca 9d
00000000: 00 00 00 00
pci 0000:00:00.0: [8086:3e34] type 00 class 0x060000 conventional PCI endpoint
pci 0000:00:02.0: config space:
00000000: 86 80 a0 3e
00000000: 04 00 00 c0
00000000: 01 40 00 00
00000000: 00 00 00 00
00000000: 09 70 0c 01
00000000: c1 02 00 00
00000000: 00 00 01 00
00000000: 10 ac 92 00
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 01 00 22 00
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 00 33 fb d8
00000000: 00 70 30 42
00000000: 27 c5 24 9d
00000000: 00 c0 1b 42
00000000: 00 00 00 00
00000000: 20 79 05 00
00000000: 00 70 30 42
00000000: 00 00 00 00
00000000: 10 00 00 00
00000000: 10 00 00 00
00000000: 0d e1 c3 9d
00000000: 00 33 fb d8
00000000: 00 70 30 42
00000000: 00 70 30 42
00000000: 00 00 00 00
00000000: 18 00 00 00
00000000: 80 b8 01 42
00000000: 18 b6 01 42
00000000: 00 00 00 00
00000000: 00 b6 01 42
00000000: 80 b8 01 42
00000000: 18 b6 01 42
00000000: 63 73 cb 9d
00000000: 38 b6 01 42
00000000: 00 38 ff 41
00000000: ff ff ff ff
00000000: 00 00 00 00
00000000: 80 b8 01 42
00000000: a5 0e 2f 9e
00000000: b8 7a 05 00
00000000: 00 33 fb d8
00000000: 00 33 fb d8
00000000: 90 86 05 42
00000000: 80 b8 01 42
00000000: ad 77 25 9d
00000000: 90 86 05 42
00000000: 80 b8 01 42
00000000: 00 00 00 00
00000000: b8 00 00 00
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: 00 00 00 00
00000000: c0 78 1f 9f
00000000: 00 38 ff 41
00000000: 01 00 00 00
00000000: 95 b8 ca 9d
00000000: 00 00 00 00
pci 0000:00:02.0: [8086:3ea0] type 00 class 0x030000 PCIe Root Complex Integrated Endpoint
pci 0000:00:02.0: BAR 0 [mem 0xc0000000-0xc0ffffff 64bit]
pci 0000:00:02.0: BAR 2 [mem 0xb0000000-0xbfffffff 64bit pref]
pci 0000:00:02.0: BAR 4 [io  0x4000-0x403f]
pci 0000:00:02.0: Video device with shadowed ROM at [mem 0x000c0000-0x000dffff]
```
上面的 PCI config space dump 可以通过内核启动参数 <span style="background-color: yellow; padding: 4px;">pci=earlydump</span> 开启打印

## Access to config space

内核访问 PCI config space 的 API 都定义在 `drivers/pci/access.c` 中

```
int pci_read_config_byte(const struct pci_dev *dev, int where, u8 *val);
```

# 参考

- [osdev.org: PCI](https://wiki.osdev.org/PCI)
