<svg viewBox="0 0 1200 860" xmlns="http://www.w3.org/2000/svg" font-family="'Courier New', monospace">
  <defs>
    <marker id="mv" markerWidth="8" markerHeight="7" refX="7" refY="3.5" orient="auto">
      <path d="M0,0 L0,7 L8,3.5 z" fill="#888"/>
    </marker>
    <marker id="mv-A" markerWidth="9" markerHeight="8" refX="8" refY="4" orient="auto">
      <path d="M0,0 L0,8 L9,4 z" fill="#d97706"/>
    </marker>
    <marker id="mv-B" markerWidth="9" markerHeight="8" refX="8" refY="4" orient="auto">
      <path d="M0,0 L0,8 L9,4 z" fill="#7c3aed"/>
    </marker>
    <marker id="mv-C" markerWidth="9" markerHeight="8" refX="8" refY="4" orient="auto">
      <path d="M0,0 L0,8 L9,4 z" fill="#0369a1"/>
    </marker>
    <marker id="mv-D" markerWidth="9" markerHeight="8" refX="8" refY="4" orient="auto">
      <path d="M0,0 L0,8 L9,4 z" fill="#059669"/>
    </marker>
    <marker id="seq" markerWidth="7" markerHeight="6" refX="6" refY="3" orient="auto">
      <path d="M0,0 L0,6 L7,3 z" fill="#94a3b8"/>
    </marker>
    <filter id="sh">
      <feDropShadow dx="0" dy="1" stdDeviation="1.5" flood-opacity="0.12"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="1200" height="860" fill="#f8fafc"/>

  <!-- ═══════════════════════════════════════════
       TITLE
  ═══════════════════════════════════════════ -->
  <text x="600" y="30" text-anchor="middle" fill="#0f172a"
        font-size="15" font-weight="bold">
    drm/kirin DSI — Probe Ordering Fix  (commit 4280e1a0 · Maxime Ripard · 2021-10-25)
  </text>
  <text x="600" y="48" text-anchor="middle" fill="#64748b" font-size="10">
    同样的 5 个步骤，只是执行位置发生了移动  —  颜色相同 = 同一步骤
  </text>

  <!-- ═══════════════════════════════════════════
       LEGEND
  ═══════════════════════════════════════════ -->
  <rect x="30" y="56" width="1140" height="28" rx="4" fill="#f1f5f9" stroke="#e2e8f0" stroke-width="1"/>
  <!-- A -->
  <rect x="50"  y="63" width="14" height="14" rx="2" fill="#fef3c7" stroke="#d97706" stroke-width="1.5"/>
  <text x="70"  y="74" fill="#92400e" font-size="9.5" font-weight="bold">A  bridge lookup</text>
  <!-- B -->
  <rect x="200" y="63" width="14" height="14" rx="2" fill="#ede9fe" stroke="#7c3aed" stroke-width="1.5"/>
  <text x="220" y="74" fill="#4c1d95" font-size="9.5" font-weight="bold">B  component_add</text>
  <!-- C -->
  <rect x="370" y="63" width="14" height="14" rx="2" fill="#e0f2fe" stroke="#0369a1" stroke-width="1.5"/>
  <text x="390" y="74" fill="#0c4a6e" font-size="9.5" font-weight="bold">C  mipi_dsi_host_register</text>
  <!-- D -->
  <rect x="590" y="63" width="14" height="14" rx="2" fill="#dcfce7" stroke="#059669" stroke-width="1.5"/>
  <text x="610" y="74" fill="#064e3b" font-size="9.5" font-weight="bold">D  component_del  /  mipi_dsi_host_unregister</text>
  <!-- unchanged -->
  <rect x="870" y="63" width="14" height="14" rx="2" fill="#f1f5f9" stroke="#94a3b8" stroke-width="1.5"/>
  <text x="890" y="74" fill="#475569" font-size="9.5">位置不变的步骤</text>
  <!-- arrow legend -->
  <line x1="1000" y1="70" x2="1040" y2="70" stroke="#d97706" stroke-width="1.5" stroke-dasharray="4,3" marker-end="url(#mv-A)"/>
  <text x="1048" y="74" fill="#64748b" font-size="9.5">步骤移动方向</text>

  <!-- ═══════════════════════════════════════════
       COLUMN HEADERS
  ═══════════════════════════════════════════ -->
  <rect x="30"  y="92" width="530" height="26" rx="4" fill="#fee2e2" stroke="#fca5a5" stroke-width="1"/>
  <text x="295" y="109" text-anchor="middle" fill="#7f1d1d" font-size="11.5" font-weight="bold">
    BEFORE  (kirin9xx_dw_drm_dsi.c · broken)
  </text>

  <rect x="640" y="92" width="530" height="26" rx="4" fill="#dcfce7" stroke="#86efac" stroke-width="1"/>
  <text x="905" y="109" text-anchor="middle" fill="#14532d" font-size="11.5" font-weight="bold">
    AFTER  (dw_drm_dsi.c · fixed)
  </text>

  <!-- ═══════════════════════════════════════════
       BEFORE COLUMN  — boxes
       y positions: 128, 178, 228, 278, 338, 388, 448, 498
  ═══════════════════════════════════════════ -->

  <!-- dsi_probe() — unchanged -->
  <rect x="30" y="128" width="530" height="36" rx="4" fill="#f8fafc" stroke="#94a3b8" stroke-width="1.5" filter="url(#sh)"/>
  <text x="295" y="145" text-anchor="middle" fill="#334155" font-size="10.5" font-weight="bold">dsi_probe()</text>
  <text x="295" y="158" text-anchor="middle" fill="#64748b" font-size="9">alloc · platform_set_drvdata</text>
  <line x1="295" y1="164" x2="295" y2="177" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#seq)"/>

  <!-- [A] dsi_parse_dt  with bridge lookup -->
  <rect x="30" y="178" width="530" height="36" rx="4" fill="#fef3c7" stroke="#d97706" stroke-width="2" filter="url(#sh)"/>
  <text x="80"  y="193" fill="#92400e" font-size="9" font-weight="bold">A</text>
  <text x="295" y="193" text-anchor="middle" fill="#78350f" font-size="10.5" font-weight="bold">dsi_parse_dt()</text>
  <text x="295" y="207" text-anchor="middle" fill="#92400e" font-size="9">drm_of_find_panel_or_bridge()  ←  bridge lookup 在此</text>
  <line x1="295" y1="214" x2="295" y2="227" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#seq)"/>

  <!-- [B] component_add  directly in probe -->
  <rect x="30" y="228" width="530" height="36" rx="4" fill="#ede9fe" stroke="#7c3aed" stroke-width="2" filter="url(#sh)"/>
  <text x="80"  y="243" fill="#4c1d95" font-size="9" font-weight="bold">B</text>
  <text x="295" y="243" text-anchor="middle" fill="#4c1d95" font-size="10.5" font-weight="bold">component_add()  ←  probe 末尾直接调用</text>
  <text x="295" y="257" text-anchor="middle" fill="#5b21b6" font-size="9">等待 master (DPE) ready → 触发 dsi_bind()</text>
  <line x1="295" y1="264" x2="295" y2="277" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#seq)"/>

  <!-- dsi_bind — unchanged frame -->
  <rect x="30" y="278" width="530" height="96" rx="4" fill="#f8fafc" stroke="#94a3b8" stroke-width="1.5" filter="url(#sh)"/>
  <text x="295" y="295" text-anchor="middle" fill="#334155" font-size="10.5" font-weight="bold">dsi_bind()  [component bind callback]</text>
  <text x="295" y="310" text-anchor="middle" fill="#64748b" font-size="9">dw_drm_encoder_init()</text>

  <!-- [C] host_init inside bind -->
  <rect x="42" y="315" width="506" height="22" rx="3" fill="#e0f2fe" stroke="#0369a1" stroke-width="1.8"/>
  <text x="72"  y="328" fill="#0c4a6e" font-size="8.5" font-weight="bold">C</text>
  <text x="295" y="329" text-anchor="middle" fill="#0c4a6e" font-size="9" font-weight="bold">dsi_host_init()  →  mipi_dsi_host_register()  ←  在 bind 内部</text>

  <!-- [A'] bridge_init uses ptr from parse_dt -->
  <rect x="42" y="340" width="506" height="22" rx="3" fill="#fef3c7" stroke="#d97706" stroke-width="1.8"/>
  <text x="72"  y="353" fill="#92400e" font-size="8.5" font-weight="bold">A</text>
  <text x="295" y="354" text-anchor="middle" fill="#92400e" font-size="9" font-weight="bold">dsi_bridge_init()  uses dsi-&gt;bridge from parse_dt</text>

  <line x1="295" y1="374" x2="295" y2="387" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#seq)"/>

  <!-- dsi_host_attach — no-op in before -->
  <rect x="30" y="388" width="530" height="36" rx="4" fill="#f8fafc" stroke="#94a3b8" stroke-width="1.5" filter="url(#sh)"/>
  <text x="295" y="405" text-anchor="middle" fill="#334155" font-size="10.5" font-weight="bold">dsi_host_attach()  [MIPI DSI core callback]</text>
  <text x="295" y="419" text-anchor="middle" fill="#94a3b8" font-size="9">stores lanes/format — does NOT call component_add</text>
  <line x1="295" y1="424" x2="295" y2="437" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#seq)"/>

  <!-- dsi_remove -->
  <rect x="30" y="438" width="530" height="36" rx="4" fill="#f8fafc" stroke="#94a3b8" stroke-width="1.5" filter="url(#sh)"/>
  <text x="295" y="455" text-anchor="middle" fill="#334155" font-size="10.5" font-weight="bold">dsi_remove()</text>
  <!-- [D] component_del only — missing host_unregister -->
  <rect x="42" y="461" width="506" height="10" rx="2" fill="#dcfce7" stroke="#059669" stroke-width="1.5"/>
  <text x="72"  y="470" fill="#064e3b" font-size="8" font-weight="bold">D</text>
  <text x="295" y="470" text-anchor="middle" fill="#065f46" font-size="8" font-weight="bold">component_del()  only  —  host_unregister 缺失</text>

  <!-- dsi_host_detach — no-op in before -->
  <rect x="30" y="488" width="530" height="22" rx="4" fill="#f8fafc" stroke="#94a3b8" stroke-width="1.5" filter="url(#sh)"/>
  <text x="295" y="503" text-anchor="middle" fill="#94a3b8" font-size="9.5">dsi_host_detach()  — no-op</text>

  <!-- ═══════════════════════════════════════════
       AFTER COLUMN  — boxes
  ═══════════════════════════════════════════ -->

  <!-- dsi_probe — unchanged -->
  <rect x="640" y="128" width="530" height="36" rx="4" fill="#f8fafc" stroke="#94a3b8" stroke-width="1.5" filter="url(#sh)"/>
  <text x="905" y="145" text-anchor="middle" fill="#334155" font-size="10.5" font-weight="bold">dsi_probe()</text>
  <text x="905" y="158" text-anchor="middle" fill="#64748b" font-size="9">alloc · platform_set_drvdata</text>
  <line x1="905" y1="164" x2="905" y2="177" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#seq)"/>

  <!-- [A'] dsi_parse_dt  NO bridge lookup -->
  <rect x="640" y="178" width="530" height="36" rx="4" fill="#fef3c7" stroke="#d97706" stroke-width="2" filter="url(#sh)"/>
  <text x="690" y="193" fill="#92400e" font-size="9" font-weight="bold">A</text>
  <text x="905" y="193" text-anchor="middle" fill="#78350f" font-size="10.5" font-weight="bold">dsi_parse_dt()</text>
  <text x="905" y="207" text-anchor="middle" fill="#059669" font-size="9" font-weight="bold">clk + ioremap only  —  bridge lookup 已移走  ✓</text>
  <line x1="905" y1="214" x2="905" y2="227" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#seq)"/>

  <!-- [C'] host_init in probe -->
  <rect x="640" y="228" width="530" height="36" rx="4" fill="#e0f2fe" stroke="#0369a1" stroke-width="2" filter="url(#sh)"/>
  <text x="690" y="243" fill="#0c4a6e" font-size="9" font-weight="bold">C</text>
  <text x="905" y="243" text-anchor="middle" fill="#0c4a6e" font-size="10.5" font-weight="bold">dsi_host_init()  →  mipi_dsi_host_register()  ←  moved here  ✓</text>
  <text x="905" y="257" text-anchor="middle" fill="#0369a1" font-size="9">adv7533 可以 attach → MIPI DSI core 触发 host_attach 回调</text>
  <line x1="905" y1="264" x2="905" y2="277" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#seq)"/>

  <!-- dsi_host_attach  now calls component_add -->
  <rect x="640" y="278" width="530" height="36" rx="4" fill="#f8fafc" stroke="#94a3b8" stroke-width="1.5" filter="url(#sh)"/>
  <text x="905" y="295" text-anchor="middle" fill="#334155" font-size="10.5" font-weight="bold">dsi_host_attach()  [MIPI DSI core callback]</text>
  <!-- [B'] component_add moved here -->
  <rect x="652" y="301" width="506" height="10" rx="2" fill="#ede9fe" stroke="#7c3aed" stroke-width="1.8"/>
  <text x="682" y="310" fill="#4c1d95" font-size="8" font-weight="bold">B</text>
  <text x="905" y="310" text-anchor="middle" fill="#4c1d95" font-size="8" font-weight="bold">component_add()  ←  moved here, passively triggered  ✓</text>
  <line x1="905" y1="314" x2="905" y2="327" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#seq)"/>

  <!-- dsi_bind  clean -->
  <rect x="640" y="328" width="530" height="96" rx="4" fill="#f8fafc" stroke="#94a3b8" stroke-width="1.5" filter="url(#sh)"/>
  <text x="905" y="345" text-anchor="middle" fill="#334155" font-size="10.5" font-weight="bold">dsi_bind()  [component bind callback]</text>
  <text x="905" y="360" text-anchor="middle" fill="#64748b" font-size="9">dw_drm_encoder_init()</text>

  <!-- [A''] bridge lookup now in bind -->
  <rect x="652" y="365" width="506" height="22" rx="3" fill="#fef3c7" stroke="#d97706" stroke-width="1.8"/>
  <text x="682" y="378" fill="#92400e" font-size="8.5" font-weight="bold">A</text>
  <text x="905" y="379" text-anchor="middle" fill="#92400e" font-size="9" font-weight="bold">dsi_bridge_init()  →  drm_of_find_panel_or_bridge()  →  drm_bridge_attach()  ✓</text>

  <!-- [C-gone] no host_init here -->
  <rect x="652" y="390" width="506" height="16" rx="3" fill="#f0fdf4" stroke="#86efac" stroke-width="1"/>
  <text x="905" y="401" text-anchor="middle" fill="#059669" font-size="8.5">host_init 已移至 probe，此处无需再调用  ✓</text>

  <line x1="905" y1="424" x2="905" y2="437" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#seq)"/>

  <!-- dsi_host_detach  with component_del -->
  <rect x="640" y="438" width="530" height="36" rx="4" fill="#f8fafc" stroke="#94a3b8" stroke-width="1.5" filter="url(#sh)"/>
  <text x="905" y="455" text-anchor="middle" fill="#334155" font-size="10.5" font-weight="bold">dsi_host_detach()  [MIPI DSI core callback]</text>
  <!-- [D'] component_del moved here -->
  <rect x="652" y="461" width="506" height="10" rx="2" fill="#dcfce7" stroke="#059669" stroke-width="1.5"/>
  <text x="682" y="470" fill="#064e3b" font-size="8" font-weight="bold">D</text>
  <text x="905" y="470" text-anchor="middle" fill="#065f46" font-size="8" font-weight="bold">component_del()  ←  moved here, symmetric to attach  ✓</text>
  <line x1="905" y1="474" x2="905" y2="487" stroke="#94a3b8" stroke-width="1.2" marker-end="url(#seq)"/>

  <!-- dsi_remove  now has host_unregister -->
  <rect x="640" y="488" width="530" height="22" rx="4" fill="#f8fafc" stroke="#94a3b8" stroke-width="1.5" filter="url(#sh)"/>
  <!-- [D''] host_unregister added back -->
  <rect x="652" y="490" width="506" height="18" rx="2" fill="#dcfce7" stroke="#059669" stroke-width="1.5"/>
  <text x="682" y="502" fill="#064e3b" font-size="8" font-weight="bold">D</text>
  <text x="905" y="502" text-anchor="middle" fill="#065f46" font-size="8" font-weight="bold">dsi_remove()  →  mipi_dsi_host_unregister()  ←  symmetric to probe  ✓</text>

  <!-- ═══════════════════════════════════════════
       MOVEMENT ARROWS  (cross-column)
       showing where each colored step moved
  ═══════════════════════════════════════════ -->

  <!-- A: parse_dt(196) → bind bridge_init(351) -->
  <path d="M 562 196 C 610 196, 610 351, 638 351"
        fill="none" stroke="#d97706" stroke-width="1.8"
        stroke-dasharray="6,3" marker-end="url(#mv-A)"/>

  <!-- B: component_add in probe(246) → host_attach(305) -->
  <path d="M 562 246 C 602 246, 602 305, 638 305"
        fill="none" stroke="#7c3aed" stroke-width="1.8"
        stroke-dasharray="6,3" marker-end="url(#mv-B)"/>

  <!-- C: host_init in bind(326) → host_init in probe(246) -->
  <path d="M 562 326 C 600 326, 600 246, 638 246"
        fill="none" stroke="#0369a1" stroke-width="1.8"
        stroke-dasharray="6,3" marker-end="url(#mv-C)"/>

  <!-- D: component_del in remove(466) → host_detach(466) -->
  <path d="M 562 466 C 600 466, 600 466, 638 466"
        fill="none" stroke="#059669" stroke-width="1.8"
        stroke-dasharray="6,3" marker-end="url(#mv-D)"/>

  <!-- D: host_unregister missing(455) → dsi_remove(499) -->
  <path d="M 562 455 C 600 455, 600 499, 638 499"
        fill="none" stroke="#059669" stroke-width="1.8"
        stroke-dasharray="6,3" marker-end="url(#mv-D)"/>

  <!-- CENTER DIVIDER -->
  <line x1="600" y1="92" x2="600" y2="520" stroke="#cbd5e1" stroke-width="1" stroke-dasharray="4,4"/>

  <!-- ═══════════════════════════════════════════
       SUMMARY BAR
  ═══════════════════════════════════════════ -->
  <rect x="30" y="530" width="1140" height="22" rx="4" fill="#1e293b"/>
  <text x="600" y="545" text-anchor="middle" fill="#f1f5f9"
        font-size="10.5" font-weight="bold" letter-spacing="0.3">
    步骤移动总结  ·  4 moves  ·  步骤数量不变
  </text>

  <!-- Summary table -->
  <rect x="30" y="552" width="1140" height="130" rx="4" fill="#ffffff" stroke="#e2e8f0"/>

  <!-- col dividers -->
  <line x1="50"  y1="552" x2="50"  y2="682" stroke="#e2e8f0"/>
  <line x1="330" y1="552" x2="330" y2="682" stroke="#e2e8f0"/>
  <line x1="680" y1="552" x2="680" y2="682" stroke="#e2e8f0"/>

  <!-- header -->
  <rect x="30" y="552" width="1140" height="20" fill="#f8fafc"/>
  <text x="190" y="566" text-anchor="middle" fill="#475569" font-size="9.5" font-weight="bold">步骤</text>
  <text x="505" y="566" text-anchor="middle" fill="#475569" font-size="9.5" font-weight="bold">BEFORE 位置</text>
  <text x="910" y="566" text-anchor="middle" fill="#475569" font-size="9.5" font-weight="bold">AFTER 位置</text>

  <!-- row A -->
  <line x1="30" y1="590" x2="1170" y2="590" stroke="#f1f5f9"/>
  <rect x="55"  y="576" width="12" height="12" rx="2" fill="#fef3c7" stroke="#d97706" stroke-width="1.5"/>
  <text x="75"  y="586" fill="#78350f" font-size="9.5" font-weight="bold">A  bridge lookup</text>
  <text x="505" y="586" text-anchor="middle" fill="#78350f" font-size="9">dsi_parse_dt()  →  dsi_bind()  内的  dsi_bridge_init()</text>
  <text x="910" y="586" text-anchor="middle" fill="#059669" font-size="9">dsi_bind()  내  dsi_bridge_init()  [保证 bridge 已 probe]  ✓</text>

  <!-- row B -->
  <line x1="30" y1="616" x2="1170" y2="616" stroke="#f1f5f9"/>
  <rect x="55"  y="602" width="12" height="12" rx="2" fill="#ede9fe" stroke="#7c3aed" stroke-width="1.5"/>
  <text x="75"  y="612" fill="#4c1d95" font-size="9.5" font-weight="bold">B  component_add</text>
  <text x="505" y="612" text-anchor="middle" fill="#4c1d95" font-size="9">dsi_probe() 末尾  主动调用  [host 尚未注册！]</text>
  <text x="910" y="612" text-anchor="middle" fill="#059669" font-size="9">dsi_host_attach()  被动触发  [host 已注册，时序正确]  ✓</text>

  <!-- row C -->
  <line x1="30" y1="642" x2="1170" y2="642" stroke="#f1f5f9"/>
  <rect x="55"  y="628" width="12" height="12" rx="2" fill="#e0f2fe" stroke="#0369a1" stroke-width="1.5"/>
  <text x="75"  y="638" fill="#0c4a6e" font-size="9.5" font-weight="bold">C  host_register</text>
  <text x="505" y="638" text-anchor="middle" fill="#0c4a6e" font-size="9">dsi_bind()  内部  [component bind 之后才执行]</text>
  <text x="910" y="638" text-anchor="middle" fill="#059669" font-size="9">dsi_probe()  直接调用  [早于 component_add]  ✓</text>

  <!-- row D -->
  <line x1="30" y1="668" x2="1170" y2="668" stroke="#f1f5f9"/>
  <rect x="55"  y="654" width="12" height="12" rx="2" fill="#dcfce7" stroke="#059669" stroke-width="1.5"/>
  <text x="75"  y="664" fill="#064e3b" font-size="9.5" font-weight="bold">D  teardown 对称性</text>
  <text x="505" y="664" text-anchor="middle" fill="#b91c1c" font-size="9">component_del in remove  /  host_unregister 缺失</text>
  <text x="910" y="664" text-anchor="middle" fill="#059669" font-size="9">component_del in detach  /  host_unregister in remove  ✓</text>

  <!-- ═══════════════════════════════════════════
       FOOTER NOTE
  ═══════════════════════════════════════════ -->
  <rect x="30" y="692" width="1140" height="50" rx="4" fill="#fffbeb" stroke="#fde68a" stroke-width="1"/>
  <text x="600" y="710" text-anchor="middle" fill="#78350f" font-size="10.5" font-weight="bold">
    kirin9xx_dw_drm_dsi.c 与 BEFORE 模式一致，需将以上 4 个步骤按 AFTER 模式重新排序
  </text>
  <text x="600" y="728" text-anchor="middle" fill="#92400e" font-size="9.5">
    另有两个额外 bug 需同步修复：① DTS "mux-gpio" → "mux-gpios"（gpiod descriptor API 规范）
  </text>
  <text x="600" y="742" text-anchor="middle" fill="#92400e" font-size="9.5">
    ② devm_gpiod_get("mux", GPIOD_OUT_HIGH) → GPIOD_OUT_LOW  （HIGH 将 DSI SWITCH 拨向 Expansion 而非 ADV7535）
  </text>

</svg>
