<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>CUDA Thread Hierarchy vs OpenGL Compute Shader Thread Hierarchy</title>
    <url>/comp/compute-model/</url>
    <content><![CDATA[<h1 id="cuda-thread-hierarchy"><a class="markdownIt-Anchor" href="#cuda-thread-hierarchy"></a> CUDA Thread Hierarchy</h1>
<img src="/comp/compute-model/cuda-thread-hier.png" class="">
<span id="more"></span>
<p>CUDAä¸­çš„<code>kernel</code>æ˜¯ä¸€æ®µå¯åœ¨GPUç‹¬ç«‹è¿è¡Œçš„å°ç¨‹åºï¼Œè€Œä¸”è¿™æ®µç¨‹åºä¼šè¢«å®ä¾‹åŒ–(ç±»ä¼¼çš„è¯´æ³•è¿˜æœ‰<strong>launched</strong>, <strong>issued</strong>, <strong>executed</strong>, <strong>invoked</strong>)æˆéå¸¸å¤šçš„<code>thread</code>, è¿™äº›çº¿ç¨‹å¯<strong>å¹¶å‘åœ°</strong>åœ¨GPUä¸Šè¿è¡Œã€‚ç¨‹åºå‘˜æˆ–è€…è¯´ç¼–è¯‘å™¨å°†è¿™äº›çº¿ç¨‹ç»„ç»‡æˆ</p>
<ul>
<li>Thread</li>
<li>Thread Block</li>
<li>Grid of Thread Blocks</li>
</ul>
<h2 id="thread"><a class="markdownIt-Anchor" href="#thread"></a> Thread</h2>
<p>ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹å¿…ç„¶å±äºä¸€ä¸ª<code>Thread Block</code>, å®ƒæœ‰è‡ªå·±çš„</p>
<ul>
<li>thread ID</li>
<li>program counter</li>
<li>registers</li>
<li>per-thread private memory</li>
<li>inputs</li>
<li>output</li>
</ul>
<h2 id="thread-block"><a class="markdownIt-Anchor" href="#thread-block"></a> Thread Block</h2>
<p>ä¸€ä¸ª<code>Thread Block</code>å¿…ç„¶å±äºä¸€ä¸ª<code>Grid</code>, å®ƒæ˜¯ä¸€ç»„å¹¶å‘æ‰§è¡Œçš„çº¿ç¨‹çš„é›†åˆï¼Œè¿™äº›çº¿ç¨‹ä¹‹é—´å¯ä»¥é€šè¿‡<code>barrier synchronization</code>å’Œ<code>per-Block shared memory</code>äº’ç›¸ååŒ, å®ƒä¹Ÿæœ‰ä¸€ä¸ª<code>Block ID</code>ç”¨æ¥ç´¢å¼•å®ƒåœ¨<code>Grid</code>ä¸­çš„ä½ç½®ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dim3 blockDim;</span><br><span class="line">uint3 blockIdx;</span><br></pre></td></tr></table></figure>
<h2 id="grid-of-thread-blocks"><a class="markdownIt-Anchor" href="#grid-of-thread-blocks"></a> Grid of Thread Blocks</h2>
<p>ä¸€ä¸ª<code>Grid</code>ç”±ä¸€ç»„æ‰§è¡Œç›¸åŒ<code>kernel</code>çš„<code>Thread Blocks</code>ç»„æˆã€‚å¯ä»¥è¿™æ ·è¯´ï¼Œä¸€ä¸ª<code>Grid</code>æ˜¯æ‰€æœ‰æ‰§è¡ŒåŒä¸€ä¸ª<code>Kernel</code>çš„çº¿ç¨‹çš„é›†åˆã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dim3 gridDim;</span><br></pre></td></tr></table></figure>
<h1 id="cuda-thread-map"><a class="markdownIt-Anchor" href="#cuda-thread-map"></a> CUDA Thread Map</h1>
<p>CUDAçš„threadså±‚çº§ç»“æ„å¯ä»¥æ˜ å°„åˆ°GPUçš„processorsçš„å±‚çº§ç»“æ„ä¸Šã€‚</p>
<ul>
<li>ä¸€ä¸ªGPUæ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªgrids(kernels)</li>
<li>ä¸€ä¸ªSM(Streaming Multiprocessor)æ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªThread Blocks</li>
<li>CUDA Coreså’Œä¸€ä¸ªSMé‡Œçš„å…¶å®ƒæ‰§è¡Œå•å…ƒ(SFU, LDST)æ‰§è¡Œå¤šä¸ªçº¿ç¨‹</li>
</ul>
<p>SMæ‰§è¡Œçº¿ç¨‹çš„å•ä½æ˜¯<code>warp</code>, ä¸€èˆ¬æ˜¯32ä¸ªçº¿ç¨‹ä¸€ç»„ï¼Œä¸€ä¸ª<code>warp</code>é‡Œçš„32ä¸ªçº¿ç¨‹æ˜¯çœŸæ­£å¹¶è¡Œæ‰§è¡Œçš„ã€‚</p>
<img src="/comp/compute-model/cuda-thread-map.png" class="">
<h2 id="cuda-memory"><a class="markdownIt-Anchor" href="#cuda-memory"></a> CUDA Memory</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cudaError_t cudaMemcpy(void *dst,</span><br><span class="line">                       const void *src,</span><br><span class="line">                       size_t count,</span><br><span class="line">                       cudaMemcpyKind kind);</span><br></pre></td></tr></table></figure>
<p>é™¤äº†æœ€åä¸€ä¸ªå‚æ•°ï¼Œå…¶å®ƒå‚æ•°éƒ½é¡¾åçŸ¥æ„ã€‚<code>kind</code>æŒ‡ç¤ºå†…å­˜æ‹·è´çš„æ–¹å‘:</p>
<ul>
<li>cudaMemcpyHostToHost</li>
<li>cudaMemcpyHostToDevice</li>
<li>cudaMemcpyDeviceToHost</li>
<li>cudaMemcpyDeviceToDevice</li>
</ul>
<h1 id="opengl-compute-shader-thread-hierarchy"><a class="markdownIt-Anchor" href="#opengl-compute-shader-thread-hierarchy"></a> OpenGL Compute Shader Thread Hierarchy</h1>
<p>æœ‰äº†å‰é¢çš„CUDAçš„Thread Hierarchyçš„äº†è§£ï¼ŒOpenGLçš„Compute Shaderçš„çº¿ç¨‹å±‚çº§å°±å¥½ç†è§£äº†ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ã€‚ä¸€ä¸ªOpenGL <code>Compute Shader(cs)</code>å°±ç›¸å½“äºä¸€ä¸ªcudaä¸­çš„<code>kernel</code>å‡½æ•°ï¼Œ è¿™äº›ä»»åŠ¡æœ€ç»ˆè¢«åˆ†å‘åˆ°GPUçš„å„ä¸ªç‰©ç†æ ¸å¿ƒä¸Šå»æ‰§è¡Œã€‚åœ¨<code>cs</code>ä¸­ï¼Œå•ä¸ªä»»åŠ¡å«åš<code>work item</code>, é™¤äº†<code>work item</code>ä¹‹å¤–, è¿˜æœ‰ä»¥ä¸‹æ¦‚å¿µ:</p>
<ul>
<li>subgroups</li>
</ul>
<p>ä¹Ÿå°±æ˜¯<code>warps</code>æˆ–è€…<code>wavefronts</code>æˆ–è€…<code>Compute Units</code>, å®ƒä»¬å®é™…ä¸Šå°±æ˜¯<code>threads</code>, <code>shader cores</code>, <code>cuda cores</code></p>
<ul>
<li>local workgroup</li>
</ul>
<p>å®ƒçš„å¤§å°(ç»´åº¦)åœ¨<code>cs</code>ä¸­é€šè¿‡<code>layout</code>ä¿®é¥°ç¬¦æŒ‡å®š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">layout(local_size_x = 16, local_size_y = 16, local_size_z = 1) in;</span><br></pre></td></tr></table></figure>
<p><code>local workgroup</code>ç›¸å½“äºcudaçš„<a href="#thread-block">Thread Block</a></p>
<ul>
<li>global workgroup</li>
</ul>
<p>å®ƒçš„å¤§å°(ç»´åº¦)é€šè¿‡OpenGL APIè®¾ç½®, <code>glDispatchCompute</code>å‘èµ·ä¸€ä¸ªæˆ–å¤šä¸ªcompute work groups, æ­¤å¤„çš„work groupså°±æ˜¯<strong>local work group</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void glDispatchCompute(GLuint num_groups_x,</span><br><span class="line">                       GLuint num_groups_y,</span><br><span class="line">                       GLuint num_groups_z);</span><br></pre></td></tr></table></figure>
<p><code>global workgroup</code>ç›¸å½“äºcudaçš„<a href="#grid-of-thread-blocks">Grid</a></p>
<h1 id="cudaå’Œcompute-shaderå˜é‡å¯¹æ¯”"><a class="markdownIt-Anchor" href="#cudaå’Œcompute-shaderå˜é‡å¯¹æ¯”"></a> CUDAå’ŒCompute Shaderå˜é‡å¯¹æ¯”</h1>
<table>
<thead>
<tr>
<th style="text-align:left">type</th>
<th style="text-align:left">CUDA</th>
<th style="text-align:left">type</th>
<th style="text-align:left">Compute Shader</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">dim3</td>
<td style="text-align:left">gridDim</td>
<td style="text-align:left">uvec3</td>
<td style="text-align:left">gl_NumWorkGroups</td>
</tr>
<tr>
<td style="text-align:left">uint3</td>
<td style="text-align:left">blockIdx</td>
<td style="text-align:left">uvec3</td>
<td style="text-align:left">gl_WorkGroupID</td>
</tr>
<tr>
<td style="text-align:left">dim3</td>
<td style="text-align:left">blockDim</td>
<td style="text-align:left">const uvec3</td>
<td style="text-align:left">gl_WorkGroupSize</td>
</tr>
<tr>
<td style="text-align:left">uint3</td>
<td style="text-align:left">threadIdx</td>
<td style="text-align:left">uvec3</td>
<td style="text-align:left">gl_LocalInvocationID</td>
</tr>
<tr>
<td style="text-align:left">-</td>
<td style="text-align:left">-</td>
<td style="text-align:left">uvec3</td>
<td style="text-align:left">gl_GlobalInvocationID</td>
</tr>
<tr>
<td style="text-align:left">-</td>
<td style="text-align:left">-</td>
<td style="text-align:left">uint</td>
<td style="text-align:left">gl_LocalInvocationIndex</td>
</tr>
</tbody>
</table>
<p>References:</p>
<ol>
<li><a href="https://www.nvidia.com/content/PDF/fermi_white_papers/NVIDIAFermiComputeArchitectureWhitepaper.pdf">NVIDIA Fermi Architecture Whitepaper</a></li>
<li><a href="https://developer.download.nvidia.cn/compute/DevZone/docs/html/C/doc/CUDA_C_Programming_Guide.pdf">NVIDIA CUDA Programming Guide</a></li>
<li><a href="https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/glDispatchCompute.xhtml">glDispatchCompute</a></li>
</ol>
]]></content>
      <categories>
        <category>computing</category>
      </categories>
      <tags>
        <tag>CUDA</tag>
      </tags>
  </entry>
  <entry>
    <title>Machine Learning (ChatGPT said)</title>
    <url>/comp/machine-learning/</url>
    <content><![CDATA[<h1 id="é—®-æœºå™¨å­¦ä¹ æ·±åº¦å­¦ä¹ å’Œç¥ç»ç½‘ç»œè¿™äº›-ai-é¢†åŸŸçš„ä¸“ä¸šåè¯æœ‰ä»€ä¹ˆä¸åŒå’Œè”ç³»"><a class="markdownIt-Anchor" href="#é—®-æœºå™¨å­¦ä¹ æ·±åº¦å­¦ä¹ å’Œç¥ç»ç½‘ç»œè¿™äº›-ai-é¢†åŸŸçš„ä¸“ä¸šåè¯æœ‰ä»€ä¹ˆä¸åŒå’Œè”ç³»"></a> é—®: æœºå™¨å­¦ä¹ ï¼Œæ·±åº¦å­¦ä¹ å’Œç¥ç»ç½‘ç»œè¿™äº› AI é¢†åŸŸçš„ä¸“ä¸šåè¯æœ‰ä»€ä¹ˆä¸åŒå’Œè”ç³»ï¼Ÿ</h1>
<p><img src="/images/machine-learning/machine-learning.drawio.png" alt="Machine Learning branches" /></p>
]]></content>
      <categories>
        <category>computing</category>
      </categories>
      <tags>
        <tag>ML</tag>
      </tags>
  </entry>
  <entry>
    <title>ROCm</title>
    <url>/comp/rocm/</url>
    <content><![CDATA[<blockquote>
<h3 id="é«˜ç«¯ç¡…ç‰‡å¯ä»¥æ„å»ºå¸‚åœºä½†æœ€ç»ˆè½¯ä»¶æ”¯æŒå¾€å¾€å†³å®šäº†èµ¢å®¶å’Œè¾“å®¶"><a class="markdownIt-Anchor" href="#é«˜ç«¯ç¡…ç‰‡å¯ä»¥æ„å»ºå¸‚åœºä½†æœ€ç»ˆè½¯ä»¶æ”¯æŒå¾€å¾€å†³å®šäº†èµ¢å®¶å’Œè¾“å®¶"></a> <em>é«˜ç«¯ç¡…ç‰‡å¯ä»¥æ„å»ºå¸‚åœºï¼Œä½†æœ€ç»ˆï¼Œè½¯ä»¶æ”¯æŒå¾€å¾€å†³å®šäº†èµ¢å®¶å’Œè¾“å®¶</em></h3>
<p>â€“ Jack Huynh, AMD é«˜çº§å‰¯æ€»è£å…¼è®¡ç®—å’Œå›¾å½¢ä¸šåŠ¡é›†å›¢æ€»ç»ç†</p>
</blockquote>
<p>AMD çš„é€šç”¨è®¡ç®—å¹³å° ROCm (Radeon Open Compute) æ˜¯åœ¨é€šç”¨è®¡ç®—é¢†åŸŸä¸ NVIDIA çš„ CUDA ï¼ˆCompute Unified Device Architecture) ç›¸æŠ—è¡¡çš„è½¯ä»¶åŸºç¡€è®¾æ–½ã€‚ROCm å®ç°çš„å…¶å®æ˜¯ç”± AMD å‘èµ·çš„ HSA (Heterogeneous System Architecture) æ ‡å‡†ï¼Œæ‰€ä»¥å®ƒçš„è¿è¡Œæ—¶ä¸»è¦ç”± 3 ä¸ªéƒ¨åˆ†ç»„æˆ:</p>
<p>OOC: ROCm å¹³å°åˆå« Boltzmann å¹³å°ï¼ŒåŸå› æ®è¯´æ˜¯ä¸ºäº†çºªå¿µç»Ÿè®¡åŠ›å­¦å’Œçƒ­åŠ›å­¦é¢†åŸŸè‘—åç‰©ç†å­¦å®¶è·¯å¾·ç»´å¸ŒÂ·ç»å°”å…¹æ›¼ï¼Œä»–çš„å·¥ä½œå¯¹ç†è§£ç‰©è´¨çš„å¾®è§‚è¡Œä¸ºå’Œèƒ½é‡åˆ†å¸ƒæœ‰ç€æ·±è¿œçš„å½±å“ã€‚AMD é€‰å–è¿™ä¸ªåå­—ï¼Œå¯èƒ½æ˜¯ä¸ºäº†å¼ºè°ƒè¯¥å¹³å°åœ¨é«˜æ€§èƒ½è®¡ç®—é¢†åŸŸçš„å¼ºå¤§è®¡ç®—åŠ›å’Œç§‘å­¦è®¡ç®—çš„åº”ç”¨å‰æ™¯ã€‚</p>
<span id="more"></span>
<ul>
<li><a href="https://github.com/ROCm/clr">AMD Compute Common Language Runtimes</a>
<ul>
<li><a href="https://github.com/ROCm/HIP">HIP runtime</a> (C++ Heterogeneous-Compute Interface for Portability)
<ul>
<li>å¯ä»¥ç®—æ˜¯ä¸€ç§ C++ æ–¹è¨€</li>
<li>AMD æä¾›å·¥å…· <a href="https://github.com/ROCm/HIPIFY">HIPIFY</a> å¯ä»¥æŠŠ CUDA æºä»£ç ç¿»è¯‘æˆ HIP C++</li>
</ul>
</li>
<li><a href="https://www.khronos.org/opencl/">OpenCL runtime</a> ï¼ˆOpen Computing Language)
<ul>
<li>ç”± Khronos Group å‘å¸ƒçš„å¼€æ”¾å¼‚æ„ç³»ç»Ÿå¹¶è¡Œç¼–ç¨‹è¯­è¨€</li>
<li>è¯­è¨€é£æ ¼æ›´æ¥è¿‘ C</li>
</ul>
</li>
<li><a href="https://github.com/ROCm/clr/tree/amd-staging/rocclr">rocclr</a> HIP å’Œ OpenCL å…±ç”¨çš„ runtime</li>
</ul>
</li>
<li><a href="https://github.com/ROCm/HIP">HIP</a>
<ul>
<li>è¿™ä¸ªä»“åº“ä»¥å‰ä¸»è¦æä¾›ä¸€ä¸ª compiler driver utility <code>hipcc</code> è„šæœ¬ï¼Œç›®å‰ hipcc å·²ç»è¢«ç§»åˆ° AMD è‡ªå·± forked <a href="https://github.com/ROCm/llvm-project/tree/amd-staging/amd/hipcc">llvm-project/amd/hipcc</a></li>
<li>hipcc ä¹‹äº HIP-Clang å°±åƒ gcc ä¹‹äº GCC</li>
</ul>
</li>
<li><a href="https://github.com/ROCm/ROCR-Runtime">ROCR</a>
<ul>
<li>
<p>ROCt libhsakmt-staticdrm HSA Kernel Mode Trunk ç”¨æˆ·æ€åº“</p>
<ul>
<li>libhsakmt æ€»æ˜¯è¢«æ„å»ºæˆé™æ€åº“ .a</li>
<li>libhsakmt é€šè¿‡ DRM è®¾å¤‡èŠ‚ç‚¹ä¸ KFD äº¤äº’</li>
</ul>
</li>
<li>
<p>ROCr libhsa-runtime64</p>
<ul>
<li>ç”¨æˆ·å¯ä»¥é€šè¿‡ CMAKE å˜é‡ <code>BUILD_SHARED_LIBS</code> é€‰æ‹©æ„å»º libhsa-runtime64 ä¸ºé™æ€åº“æˆ–åŠ¨æ€åº“</li>
</ul>
</li>
<li>
<p>ROCR ä¸»è¦å‘ç”¨æˆ·æä¾› AMD GPU/NPU/HSA è®¾å¤‡å†…æ ¸é©±åŠ¨ (åŒ…æ‹¬ KFD å’Œ <a href="https://patchwork.freedesktop.org/series/136294/">XDNA</a>) çš„ç”¨æˆ·æ€å°è£…å’ŒæŠ½è±¡, ç±»ä¼¼ amdgpu.ko ä¸ libdrm_amdgpu çš„å…³ç³»ã€‚å®ƒçš„ libhsakmt é€šè¿‡ KFD æä¾›çš„ IOCTL ç›´æ¥è®¿é—® HSA ç¡¬ä»¶ï¼Œè€Œ libhsa-runtime64 ä¸»è¦å®ç° HSA æ ‡å‡†çš„ Core Profile å’Œå„å‚å®¶çš„æ‰©å±• (extension)ã€‚</p>
</li>
</ul>
</li>
</ul>
<p>å¯ä»¥è¯´ï¼ŒROCm çš„æ•´ä¸ªè¿è¡Œæ—¶ç¯å¢ƒåˆ†çš„ 3 å¤§å—ï¼Œåˆ†åˆ«è´Ÿè´£æ‰“é€š</p>
<ul>
<li>CLR   å‘ä¸Šï¼Œé¢å‘ç¼–ç¨‹è¯­è¨€</li>
<li>ROCR  å‘ä¸‹ï¼Œé¢å‘å†…æ ¸é©±åŠ¨</li>
<li>HIP   é¢å‘ç¼–è¯‘ç³»ç»Ÿ(HIP åŸæ¥æä¾›çš„ hipcc å·²å¹¶å…¥ ROCm/llvm-project)</li>
</ul>
<h1 id="clr"><a class="markdownIt-Anchor" href="#clr"></a> <a href="https://github.com/ROCm/clr">CLR</a></h1>
<p>æ‰€è°“ Common Language Runtimes, å°±æ˜¯æŒ‡ HIP å’Œ OpenCL ä¸¤ç§ç¼–ç¨‹è¯­è¨€çš„è¿è¡Œæ—¶, ç±»ä¼¼ C/C++ çš„ <a href="http://libc.so">libc.so</a> å’Œ <a href="http://libstdc++.so">libstdc++.so</a>ã€‚</p>
<ul>
<li><a href="http://libamdhip64.so">libamdhip64.so</a></li>
<li>libamdocl64.so.2.1.nnn</li>
</ul>
<p>è¿™ä¸¤ä¸ªåŠ¨æ€åº“å„è‡ªéƒ½éœ€è¦é“¾æ¥ rocclr</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">target_link_libraries(amdocl PUBLIC rocclr)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># ROCclr abstracts the usage of multiple AMD compilers and runtimes.</span><br><span class="line"># It is possible to support multiple backends concurrently in the same binary.</span><br><span class="line">option(ROCCLR_ENABLE_HSAIL &quot;Enable support for HSAIL compiler&quot; OFF)</span><br><span class="line">option(ROCCLR_ENABLE_LC    &quot;Enable support for LC compiler&quot;    ON)</span><br><span class="line">option(ROCCLR_ENABLE_HSA   &quot;Enable support for HSA runtime&quot;    ON)</span><br><span class="line">option(ROCCLR_ENABLE_PAL   &quot;Enable support for PAL runtime&quot;    OFF)</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæ— è®º amdhip64 è¿˜æ˜¯ amdocl ï¼Œå®ƒä»¬ä¹Ÿéƒ½è¦è°ƒåˆ°ç¼–è¯‘å™¨åç«¯ï¼Œåœ¨ CLR çš„å®ç°é‡Œæ”¯æŒä¸¤ä¸ªç¼–è¯‘å™¨åç«¯ï¼š</p>
<ul>
<li><code>ROCCLR_ENABLE_HSAIL</code> HSAIL (HSA Intermediate Language, ä¼¼ä¹å·²ç»åºŸå¼ƒ)
<ul>
<li>CLR çš„æºç ä¸­æ˜¯é€šè¿‡å® <code>WITH_COMPILER_LIB</code> guard</li>
</ul>
</li>
<li><code>ROCCLR_ENABLE_LC</code>    <a href="https://github.com/ROCm/llvm-project/tree/amd-staging/amd/comgr">COMGR</a> (Code Object Manager) ç›®å‰åœ¨ <code>ROCm/llvm-project/amd/comgr/</code> ä¸‹ç»´æŠ¤
<ul>
<li>CLR çš„æºç ä¸­æ˜¯é€šè¿‡å® <code>USE_COMGR_LIBRARY</code> guard</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bool Program::compileImpl(const std::string&amp; sourceCode,</span><br><span class="line">                          const std::vector&lt;const std::string*&gt;&amp; headers,</span><br><span class="line">                          const char** headerIncludeNames, amd::option::Options* options,</span><br><span class="line">                          const std::vector&lt;std::string&gt;&amp; preCompiledHeaders) &#123;</span><br><span class="line">  if (isLC()) &#123;</span><br><span class="line">    return compileImplLC(sourceCode, headers, headerIncludeNames, options, preCompiledHeaders);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return compileImplHSAIL(sourceCode, headers, headerIncludeNames, options);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CLR ä¹Ÿæ”¯æŒä¸¤ä¸ªè¿è¡Œæ—¶åç«¯ï¼š</p>
<ul>
<li><code>ROCCLR_ENABLE_HSA</code>
<ul>
<li>å¦‚æœä½¿ç”¨ HSA runtime, é‚£ä¹ˆ CLR éœ€è¦è°ƒç”¨ ROCR (libhsa-runtime64)</li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">find_package(hsa-runtime64 1.11 REQUIRED CONFIG</span><br><span class="line">  PATHS</span><br><span class="line">    /opt/rocm/</span><br><span class="line">    $&#123;ROCM_INSTALL_PATH&#125;</span><br><span class="line">  PATH_SUFFIXES</span><br><span class="line">    cmake/hsa-runtime64</span><br><span class="line">    lib/cmake/hsa-runtime64</span><br><span class="line">    lib64/cmake/hsa-runtime64)</span><br><span class="line">target_link_libraries(rocclr PUBLIC hsa-runtime64::hsa-runtime64)</span><br></pre></td></tr></table></figure>
</li>
<li><code>ROCCLR_ENABLE_PAL</code> <a href="https://github.com/GPUOpen-Drivers/pal">PAL</a> (Platform Abstraction Library)
<ul>
<li>å¦‚æœä½¿ç”¨ PAL runtime, rocclr éœ€è¦é“¾æ¥ <a href="http://libpal.so">libpal.so</a> å’Œ <a href="http://libamdhsaloader.so">libamdhsaloader.so</a></li>
</ul>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">find_package(AMD_PAL)</span><br><span class="line">find_package(AMD_HSA_LOADER)</span><br><span class="line">target_link_libraries(rocclr PUBLIC pal amdhsaloader)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="rocr"><a class="markdownIt-Anchor" href="#rocr"></a> <a href="https://github.com/ROCm/ROCR-Runtime">ROCR</a></h1>
<p>è®¡ç®—ä¸–ç•Œçš„ libdrm</p>
<p>ROCR æ˜¯ KMD çš„å°è£…(ä¸»è¦æ˜¯ KMD å®ç°çš„ ioctl å’Œè®¾å¤‡,å†…å­˜ç®¡ç†æ¥å£)ï¼Œç±»ä¼¼ libdrm, ä½† ROCR ä¹Ÿå¯¹é©±åŠ¨åŠ¨æœ¬èº«(å› ä¸ºKMDå¯èƒ½ä¼šæœ‰ KFD, AMDGPU, XDNA)è¿›è¡Œäº†æŠ½è±¡ï¼Œä¾¿äºæ‰©å±•åˆ°æ–°é©±åŠ¨æ¶æ„ã€‚ä¾‹å¦‚ï¼Œåœ¨æœ€è¿‘ ROCR å°±å¢åŠ äº†å¯¹ <a href="https://patchwork.freedesktop.org/series/136294/">AMD NPU é©±åŠ¨ XDNA</a> çš„æ”¯æŒã€‚</p>
<p>OOC: <a href="http://libhsa-runtime64.so">libhsa-runtime64.so</a> æ‰“å¼€çš„æ˜¯ <code>/dev/kfd</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hsa_status_t XdnaDriver::DiscoverDriver() &#123;</span><br><span class="line">  const int max_minor_num(64);</span><br><span class="line">  const std::string devnode_prefix(&quot;/dev/accel/accel&quot;);</span><br><span class="line"></span><br><span class="line">  for (int i = 0; i &lt; max_minor_num; ++i) &#123;</span><br><span class="line">    std::unique_ptr&lt;Driver&gt; xdna_drv(</span><br><span class="line">        new XdnaDriver(devnode_prefix + std::to_string(i)));</span><br><span class="line">    if (xdna_drv-&gt;Open() == HSA_STATUS_SUCCESS) &#123;</span><br><span class="line">      if (xdna_drv-&gt;QueryKernelModeDriver(</span><br><span class="line">              core::DriverQuery::GET_DRIVER_VERSION) == HSA_STATUS_SUCCESS) &#123;</span><br><span class="line">        core::Runtime::runtime_singleton_-&gt;RegisterDriver(xdna_drv);</span><br><span class="line">        return HSA_STATUS_SUCCESS;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        xdna_drv-&gt;Close();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return HSA_STATUS_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="rocmllvm-project"><a class="markdownIt-Anchor" href="#rocmllvm-project"></a> <a href="https://github.com/ROCm/llvm-project">ROCm/llvm-project</a></h1>
<p><a href="https://github.com/ROCm/llvm-project">ROCm/llvm-project</a> æ˜¯ AMD ä¸“ä¸º ROCm fork å‡ºæ¥çš„ LLVM ä»“åº“ï¼Œå®ƒé‡Œé¢åŒ…å«æ‰€æœ‰ <a href="https://github.com/llvm/llvm-project">llvm-project</a> ä¸Šæ¸¸å˜æ›´ï¼Œå†åŠ ä¸Š AMD ç‰¹æœ‰çš„ <strong>amd</strong> å­ç›®å½•ã€‚ åœ¨ amd ç›®å½•ä¸‹å­˜åœ¨ 3 ä¸ªç»„ä»¶:</p>
<ul>
<li>amd_comgr</li>
<li>device-libs</li>
<li>hipcc</li>
</ul>
<p>è¿™ 3 ä¸ªç»„ä»¶å¯ä»¥æœ‰ä¸¤ç§æ„å»ºæ–¹å¼:</p>
<ul>
<li>å› ä¸ºæ¯ä¸ªå­ç›®å½•ä¸‹éƒ½æœ‰è‡ªå·±çš„ CMakeLists.txt, æ‰€ä»¥å¯ä»¥é€šè¿‡ cmake çš„ <code>-S</code> é€‰é¡¹åˆ†åˆ«é€ä¸ªæ„å»º
<ul>
<li>è™½ç„¶è¿™ 3 ä¸ªç»„ä»¶æ˜¯å¯ä»¥ç‹¬ç«‹æ„å»ºçš„ï¼Œä½† amd_comgr ä¾èµ– device-libs</li>
</ul>
</li>
<li>ä¹Ÿå¯ä»¥é€šè¿‡ llvm æ„å»ºé€‰é¡¹ <code>LLVM_EXTERNAL_PROJECTS</code>, <code>LLVM_EXTERNAL_DEVICELIBS_SOURCE_DIR</code>, <code>LLVM_EXTERNAL_COMGR_SOURCE_DIR</code> ä¸ llvm ä¸€èµ·æ„å»º
<ul>
<li>è¿™ç§æ–¹å¼å¥½åƒéœ€è¦è¿è¡Œ <code>amd/utils/omnibus.sh</code>, è¯•äº†ä¸€ä¸‹æ²¡æœ‰æˆåŠŸï¼Œè¿˜æ˜¯ç¬¬ä¸€ç§æ–¹å¼ç›¸å¯¹ç®€å•äº›</li>
</ul>
</li>
</ul>
<p>æ„å»ºé¡ºåºåº”è¯¥åªèƒ½æ˜¯ï¼š</p>
<ul>
<li><code>cmake -S llvm -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=On -DCMAKE_INSTALL_PREFIX=~/.local/rocm/6.2.0/llvm -DLLVM_ENABLE_PROJECTS=&quot;clang;lld;llvm&quot; -DLLVM_TARGETS_TO_BUILD=&quot;BPF;AMDGPU;host&quot; -DLLVM_LIBDIR_SUFFIX=64 -DLLVM_BUILD_LLVM_DYLIB=OFF -DBUILD_SHARED_LIBS=OFF -DLLVM_USE_LINKER=gold</code>
<ul>
<li>æ„å»º comgr ä¸æ”¯æŒ shared libraries LLVM,  æ‰€ä»¥å¿…é¡»å°† LLVM ç¼–è¯‘æˆé™æ€åº“ (<code>-DBUILD_SHARED_LIBS=OFF</code>)</li>
<li><a href="https://github.com/ROCm/llvm-project/issues/37"><code>CMAKE_BUILD_TYPE</code> ä¸è¦é€‰ Debug æˆ– RelWithDebInfo, é™¤éä½ æœ‰è¶³å¤Ÿçš„ç¡¬ç›˜ç©ºé—´</a></li>
</ul>
</li>
<li><code> cmake -S amd/device-libs -B build-rocm -G &quot;Ninja&quot; -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=~/.local/rocm/6.2.0 -DLLVM_DIR=~/.local/rocm/6.2.0/llvm/lib64/cmake/llvm</code>
<ul>
<li><code>LLVM_DIR</code> è¦è®¾ç½®çš„æ˜¯åŒ…å« <code>LLVMConfig.cmake</code> çš„è·¯å¾„, è€Œä¸æ˜¯ <code>llvm-config --prefix</code> è¾“å‡ºçš„è·¯å¾„</li>
</ul>
</li>
<li><code>cmake -S amd/comgr -B build-rocm -G &quot;Ninja&quot; -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=~/.local/rocm/6.2.0 -DLLVM_DIR=~/.local/rocm/6.2.0/llvm/lib64/cmake/llvm -DCMAKE_MODULE_PATH=~/local/rocm/6.2.0/lib/cmake/AMDDeviceLibs</code></li>
</ul>
<h1 id="amdkfd"><a class="markdownIt-Anchor" href="#amdkfd"></a> <a href="https://github.com/ROCm/ROCK-Kernel-Driver">AMDKFD</a></h1>
<p>è®¡ç®—ä¸–ç•Œçš„ AMDGPU</p>
<p>AMDKFD æ˜¯ AMD Kernel Fusion Driver, å®ƒåŸºæœ¬ä¸Šæ˜¯ AMD HSA åœ¨å†…æ ¸ä¸­çš„å®ç°ï¼Œæ‰€ä»¥ ROCm/OpenCL éƒ½éœ€è¦å®ƒã€‚<a href="https://lwn.net/Articles/619581/">AMDKFD åœ¨ 2014 å¹´åˆå…¥ Linux kernel 3.19 çš„ä¸»çº¿</a>, è€Œåœ¨ 2018 å¹´ AMDKFD æ­£å¼ä¸ AMDGPU åˆå¹¶æˆä¸ºä¸€ä¸ªå•ä¸€å†…æ ¸æ¨¡å— <a href="https://lists.freedesktop.org/archives/amd-gfx/2018-July/023673.html">amdgpu.ko</a>ã€‚</p>
<p>OOC: AMD â€œFusionâ€ æ˜¯ AMD åœ¨ 2011 å¹´æ¨å‡ºçš„ä¸€ç³»åˆ—å¤„ç†å™¨ï¼Œæ—¨åœ¨å°† CPU å’Œ GPU é›†æˆåˆ°ä¸€ä¸ªèŠ¯ç‰‡ä¸Šï¼Œç§°ä¸º APU (åŠ é€Ÿå¤„ç†å•å…ƒ)ã€‚è¿™äº›å¤„ç†å™¨çš„ç›®æ ‡æ˜¯æä¾›æ›´é«˜çš„æ€§èƒ½å’Œèƒ½æ•ˆï¼Œç‰¹åˆ«æ˜¯åœ¨å›¾å½¢å’Œå¹¶è¡Œè®¡ç®—ä»»åŠ¡æ–¹é¢ã€‚</p>
<p>AMDKFD æœ‰ 3 ä¸ªå†…æ ¸é…ç½®é€‰é¡¹:</p>
<ul>
<li>HSA_AMD     åŸºæœ¬ä¸Šåœ¨ X86_64, ARM64 å’Œ PPC64 ç³»ç»Ÿä¸Šæ˜¯é»˜è®¤æ‰“å¼€çš„</li>
<li>HSA_AMD_SVM åŸºäº HMM çš„å…±äº«è™šæ‹Ÿå†…å­˜ç®¡ç†å™¨</li>
<li>HSA_AMD_P2P åŸºäº PCI_P2PDMA çš„å¤š GPU é—´æ•°æ®ä¼ è¾“åŠŸèƒ½</li>
</ul>
<h1 id="udna"><a class="markdownIt-Anchor" href="#udna"></a> <a href="https://winbuzzer.com/2024/09/10/amd-combines-rdna-and-cdna-into-udna-to-rival-nvidia-cuda-xcxwbn/">UDNA</a></h1>
<p>åœ¨æœªæ¥ï¼Œ AMD è®¡åˆ’å°† RDNA å’Œ CDNA æ¶æ„ç»Ÿä¸€ä¸º UDNA æ¶æ„ï¼Œå¹¶ä¸ºè¯¥æ¶æ„å¼•å…¥å¼ é‡è®¡ç®—å•å…ƒï¼Œä»¥æ›´å¥½åœ°æ”¯æŒ AI è®¡ç®—ï¼Œç»Ÿä¸€çš„ UDNA æ¶æ„å¯¹å¼€å‘è€…æ¥è¯´å°†æ›´å‹å¥½ï¼Œå¯ä»¥è®©å¼€å‘è€…åˆ©ç”¨ç›¸åŒçš„åº•å±‚å¾®æ¶æ„æ¥å®ç° AI, HPC å’Œæ¸¸æˆã€‚</p>
<h1 id="hsa"><a class="markdownIt-Anchor" href="#hsa"></a> <a href="https://hsafoundation.com/">HSA</a> vs <a href="https://uxlfoundation.org/">UXL</a></h1>
<p>HSA æ ‡å‡†æ˜¯ ROCm çš„åŸºçŸ³ä¹‹ä¸€ï¼Œå®ƒè®©ç”¨æˆ·åœ¨é€šç”¨è®¡ç®—é¢†åŸŸé™¤äº† CUDA ä¹‹å¤–èƒ½æœ‰å¦å¤–ä¸€ä¸ªé€‰æ‹©ã€‚è€Œ UXL (Unified Acceleration) Foundation æ—¨åœ¨ä¸ºä¸åŒæ¶æ„ä¸åŒå‚å•†çš„åŠ é€Ÿå™¨æ„å»ºç»Ÿä¸€çš„è½¯ä»¶ç”Ÿæ€ç³»ç»Ÿï¼Œä»è€Œä¹Ÿæˆä¸ºå¦ä¸€ä¸ªèƒ½ä¸ nVIDIA çš„ GPU å’Œ CUDA ç›¸æŠ—è¡¡çš„è®¡ç®—å¹³å°ã€‚</p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://rocm.docs.amd.com/en/latest/what-is-rocm.html">Whatâ€™s ROCm</a></li>
<li><a href="https://hsafoundation.com/standards/">Heterogeneous System Architecture standards</a></li>
<li><a href="https://www.hsafoundation.com/wp-content/uploads/2021/02/HSA-PRM-1.1.1.pdf">HSA Programmerâ€™s Reference Manual: HSAIL Virtual ISA</a></li>
<li><a href="https://lwn.net/Articles/619581/">AMDKFD Kernel Driver</a></li>
</ul>
]]></content>
      <categories>
        <category>computing</category>
      </categories>
      <tags>
        <tag>ROCm</tag>
      </tags>
  </entry>
  <entry>
    <title>HiKey970</title>
    <url>/hw/hikey970/</url>
    <content><![CDATA[<h1 id="ç¯å¢ƒå‡†å¤‡"><a class="markdownIt-Anchor" href="#ç¯å¢ƒå‡†å¤‡"></a> ç¯å¢ƒå‡†å¤‡</h1>
<h2 id="wsl2-ä½œä¸ºä¸Šä½æœº"><a class="markdownIt-Anchor" href="#wsl2-ä½œä¸ºä¸Šä½æœº"></a> WSL2 ä½œä¸ºä¸Šä½æœº</h2>
<h3 id="è¯†åˆ«-windows-11-host-çš„-usb-serial-device"><a class="markdownIt-Anchor" href="#è¯†åˆ«-windows-11-host-çš„-usb-serial-device"></a> è¯†åˆ« Windows 11 Host çš„ USB Serial Device</h3>
<p>åˆ†åˆ«åœ¨ Windows 11 ä¸Šå®‰è£… <a href="https://github.com/dorssel/usbipd-win">usbipd-win</a>ï¼Œ åœ¨ WSL2 ä¸Šå®‰è£… <a href="https://github.com/dorssel/usbipd-win/wiki/WSL-support">user space tools for USB/IP</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Microsoft Windows [ç‰ˆæœ¬ 10.0.22621.1702]</span><br><span class="line">(c) Microsoft Corporationã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</span><br><span class="line"></span><br><span class="line">C:\Windows\System32&gt;usbipd wsl list</span><br><span class="line">BUSID  VID:PID    DEVICE                                                        STATE</span><br><span class="line">1-9    046d:c534  USB è¾“å…¥è®¾å¤‡                                                  Not attached</span><br><span class="line">1-13   04e2:1410  USB ä¸²è¡Œè®¾å¤‡ (COM4)                                           Not attached</span><br></pre></td></tr></table></figure>
<h3 id="wsl2-ubuntu-2004-åˆ›å»º-devttyusb0"><a class="markdownIt-Anchor" href="#wsl2-ubuntu-2004-åˆ›å»º-devttyusb0"></a> WSL2 Ubuntu-20.04 åˆ›å»º /dev/ttyUSB0</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[Thu Jun 15 19:19:44 2023] vhci_hcd vhci_hcd.0: pdev(0) rhport(0) sockfd(3)</span><br><span class="line">[Thu Jun 15 19:19:44 2023] vhci_hcd vhci_hcd.0: devid(65546) speed(2) speed_str(full-speed)</span><br><span class="line">[Thu Jun 15 19:19:44 2023] vhci_hcd vhci_hcd.0: Device attached</span><br><span class="line">[Thu Jun 15 19:19:45 2023] vhci_hcd: vhci_device speed not set</span><br><span class="line">[Thu Jun 15 19:19:45 2023] usb 1-1: new full-speed USB device number 2 using vhci_hcd</span><br><span class="line">[Thu Jun 15 19:19:45 2023] vhci_hcd: vhci_device speed not set</span><br><span class="line">[Thu Jun 15 19:19:45 2023] usb 1-1: SetAddress Request (2) to port 0</span><br><span class="line">[Thu Jun 15 19:19:45 2023] usb 1-1: New USB device found, idVendor=04e2, idProduct=1410, bcdDevice= 0.03</span><br><span class="line">[Thu Jun 15 19:19:45 2023] usb 1-1: New USB device strings: Mfr=0, Product=0, SerialNumber=0</span><br><span class="line">[Thu Jun 15 19:19:45 2023] xr_serial 1-1:1.0: xr_serial converter detected</span><br><span class="line">[Thu Jun 15 19:19:45 2023] usb 1-1: xr_serial converter now attached to ttyUSB0</span><br></pre></td></tr></table></figure>
<h3 id="recovery-æ¨¡å¼åº”è¯¥è¿æ¥å“ªä¸ª-type-c-usb-serial-æ¥å£"><a class="markdownIt-Anchor" href="#recovery-æ¨¡å¼åº”è¯¥è¿æ¥å“ªä¸ª-type-c-usb-serial-æ¥å£"></a> Recovery æ¨¡å¼åº”è¯¥è¿æ¥å“ªä¸ª Type-C ï¼ˆUSB SERIAL) æ¥å£</h3>
<p>HiKey970 æœ‰ä¸¤ä¸ª Type-C æ¥å£ï¼Œè€Œä¸”å½“æ¿å­è¢«è®¾ç½®ä¸º Recovery æ¨¡å¼æ—¶ï¼Œä¸¤ä¸ªæ¥å£å‡ä¼šè¢«è¯†åˆ«ä¸ºâ€œä¸²å£â€ã€‚åœ¨å·¦æ‰‹è¾¹çš„ (J3101) æ˜¯ç”¨æ¥è®¿é—® Debug UART çš„ï¼Œè€Œåœ¨ HDMI å’Œ USB ä¸­é—´çš„é‚£ä¸ª(J1801)æ˜¯åœ¨ Recovery æ¨¡å¼ä¸‹ä½¿ç”¨çš„ã€‚è€Œä¸”è¿™ä¸¤ä¸ªæ¥å£æ˜¯ä¸¤ä¸ªä¸åŒå‚å®¶æä¾›çš„èŠ¯ç‰‡ï¼Œä½¿ç”¨å®Œå…¨ä¸åŒçš„å†…æ ¸é©±åŠ¨æ¨¡å—</p>
<p><img src="/images/hikey970/USB-Serial.png" alt="USB-to-Serial on Hikey970" /></p>
<ul>
<li>å‰è€…(J3101)ï¼š<br />
<code>Bus 001 Device 003: ID 04e2:1410 Exar Corp. XR21V1410 USB-UART IC</code></li>
</ul>
<p><img src="/images/hikey970/exar-USB-SER-driver.png" alt="Select CONFIG_USB_SERIAL_XR on WSL2 Kernal config" /></p>
<ul>
<li>åè€…(J1801)ï¼š<br />
<code>Bus 001 Device 002: ID 12d1:3609 Huawei Technologies Co., Ltd. USB SER</code></li>
</ul>
<p><img src="/images/hikey970/huawei-USB-SER-driver.png" alt="Select CONFIG_USB_SERIAL_OPTION on WSL2 Kernel config" /></p>
<h1 id="build-rootfsimg-and-bootimg"><a class="markdownIt-Anchor" href="#build-rootfsimg-and-bootimg"></a> Build rootfs.img and boot.img</h1>
<h2 id="bootimg"><a class="markdownIt-Anchor" href="#bootimg"></a> boot.img</h2>
<p><code>boot.img</code> ä¸»è¦æä¾› bootloader, æ‰€ä»¥å®ƒå¯ä»¥åªåŒ…å« <strong>grub.efi</strong>, Hikey970 ä½¿ç”¨çš„ boot.img æ˜¯ 64M å¤§å°</p>
<h2 id="rootfsimg"><a class="markdownIt-Anchor" href="#rootfsimg"></a> rootfs.img</h2>
<p><code>rootfs.img</code> å°±æ˜¯æ•´ä¸ªç³»ç»Ÿäº†(æ ¹æ–‡ä»¶ç³»ç»Ÿ)ï¼Œå†…æ ¸å¯æ‰§è¡Œæ–‡ä»¶(Image)å’Œè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶(.dtb) éƒ½åŒ…å«åœ¨å®ƒçš„ boot ç›®å½•é‡Œï¼ŒHikey970 ä½¿ç”¨çš„ rootfs.img åŸå§‹å¤§å°æ˜¯ 4.0GB, ä½†ç»è¿‡ android-tools å·¥å…·åŒ…é‡Œçš„ <code>img2simg</code> å¤„ç†ååªæœ‰ 716M</p>
<figure class="highlight plaintext"><figcaption><span>image ä¸ Raw image å¤§å°å¯¹æ¯”</span></figcaption><table><tr><td class="code"><pre><span class="line">-rw-r--r-- 1 luc luc 4.0G 11æœˆ26æ—¥ 06:48 rootfs.img</span><br><span class="line">-rw-r--r-- 1 luc luc 716M 11æœˆ18æ—¥ 21:47 rootfs.sparse.img</span><br></pre></td></tr></table></figure>
<h2 id="debootstrap"><a class="markdownIt-Anchor" href="#debootstrap"></a> debootstrap</h2>
<ul>
<li><code>/usr/sbin/qemu-debootstrap</code></li>
<li><code>/usr/sbin/debootstrap</code></li>
</ul>
<p>æ˜¯ä¸¤ä¸ª <strong>Shell è„šæœ¬</strong>, ä¸»è¦å°±æ˜¯é€šè¿‡ä¸‹è½½ç›¸åº”å¹³å°çš„ binariesï¼Œé€šè¿‡ <strong>chroot</strong> æ¥åˆ¶ä½œæ ¹æ–‡ä»¶ç³»ç»Ÿ</p>
<h1 id="fastboot"><a class="markdownIt-Anchor" href="#fastboot"></a> fastboot</h1>
<p>fastboot æ˜¯ç”¨æ¥ä» Host å‘å¼€å‘æ¿çƒ§å†™å›ºä»¶å’Œé•œåƒçš„å¸¸ç”¨å·¥å…·ä¹‹ä¸€ï¼Œåœ¨ Arch Linux ä¸Šå®ƒå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…</p>
<figure class="highlight plaintext"><figcaption><span>fastboot</span></figcaption><table><tr><td class="code"><pre><span class="line">yay -S android-sdk-platform-tools</span><br></pre></td></tr></table></figure>
<h2 id="fastboot-å¸¸ç”¨å‘½ä»¤"><a class="markdownIt-Anchor" href="#fastboot-å¸¸ç”¨å‘½ä»¤"></a> fastboot å¸¸ç”¨å‘½ä»¤</h2>
<figure class="highlight plaintext"><figcaption><span>bootloader è·å–å„ç§ä¿¡æ¯ï¼Œå¦‚ version, partition</span></figcaption><table><tr><td class="code"><pre><span class="line">fastboot getvar all</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>ID, å¯ä»¥ç”¨æ¥åˆ¤æ–­è®¾å¤‡æ˜¯å¦å·²ä¸ Host æ­£å¸¸è¿æ¥å°±ç»ª</span></figcaption><table><tr><td class="code"><pre><span class="line">fastboot devices</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">fastboot flash ptable 64gtoendprm_ptable.img</span><br><span class="line">fastboot flash xloader sec_xloader.img</span><br><span class="line">fastboot flash fastboot l-loader.bin</span><br><span class="line">fastboot flash fip fip.bin</span><br><span class="line">fastboot flash boot boot2grub.uefi.img</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>Sparse é•œåƒï¼ŒæŒ‡å®šä¼ è¾“å—å¤§å°ï¼Œæ¯ 8M ä¼ è¾“</span></figcaption><table><tr><td class="code"><pre><span class="line">fastboot -S 8M flash system rootfs.sparse.img</span><br></pre></td></tr></table></figure>
<h1 id="å¯åŠ¨"><a class="markdownIt-Anchor" href="#å¯åŠ¨"></a> å¯åŠ¨</h1>
<h2 id="bootloader"><a class="markdownIt-Anchor" href="#bootloader"></a> Bootloader</h2>
<figure class="highlight plaintext"><figcaption><span>mount -o loop boot2grub.uefi.img</span><a href="/mnt">link</a></figcaption><table><tr><td class="code"><pre><span class="line">âœ  /mnt ls -lh /mnt/EFI/BOOT</span><br><span class="line">æ€»è®¡ 881K</span><br><span class="line">-rwxr-xr-x 1 root root  29K 2018å¹´ 2æœˆ14æ—¥ fastboot.efi</span><br><span class="line">-rwxr-xr-x 1 root root 852K 2018å¹´ 2æœˆ14æ—¥ grubaa64.efi</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>/boot ç›®å½•</span></figcaption><table><tr><td class="code"><pre><span class="line">hikey970% ls -lhR /boot</span><br><span class="line">/boot:</span><br><span class="line">total 23M</span><br><span class="line">drwxr-xr-x 3 root root 4.0K Jun 12  2018 EFI</span><br><span class="line">-rw-r--r-- 1 root root  23M Jun 12  2018 Image</span><br><span class="line">drwxr-xr-x 2 root root 4.0K Jun 12  2018 grub</span><br><span class="line">-rw-r--r-- 1 root root  68K Jun 12  2018 kirin970-hikey970.dtb</span><br><span class="line"></span><br><span class="line">/boot/EFI:</span><br><span class="line">total 4.0K</span><br><span class="line">drwxr-xr-x 2 root root 4.0K Jun 12  2018 BOOT</span><br><span class="line"></span><br><span class="line">/boot/EFI/BOOT:</span><br><span class="line">total 32K</span><br><span class="line">-rw-r--r-- 1 root root 29K Jun 12  2018 fastboot.efi</span><br><span class="line"></span><br><span class="line">/boot/grub:</span><br><span class="line">total 4.0K</span><br><span class="line">-rw-r--r-- 1 root root 462 Jun 12  2018 grub.cfg</span><br></pre></td></tr></table></figure>
<p><img src="/images/hikey970/hikey970-boot.png" alt="Hikey970 boot ubuntu bionic" /></p>
<blockquote>
<p><strong>NOTE:</strong><br />
HiKey970 çš„è¾“å…¥ç”µå‹è¦æ±‚åœ¨ 8V ~ 18V ä¹‹é—´ï¼Œä½†æœ€å¥½ä½¿ç”¨ <strong>12V ä»¥ä¸Šæ¥è¿‘ 18V</strong>çš„è¾“å…¥ç”µå‹ï¼Œå¦åˆ™å¯èƒ½å‡ºç° <code>fastboot flash</code> æ—¶å‡ºç°æ¿å­è‡ªå·±é‡å¯çš„æ€ªç°è±¡<br />
<img src="/images/hikey970/hikey970-power.jpg" alt="Hikey970 Input Power Voltage" /></p>
</blockquote>
<h2 id="è¿æ¥-wifi"><a class="markdownIt-Anchor" href="#è¿æ¥-wifi"></a> è¿æ¥ WiFi</h2>
<p><img src="/images/hikey970/wifi-connect.png" alt="Hikey970 wifi" /></p>
<p><img src="/images/hikey970/hikey970-wifi-led.jpg" alt="Hikey970 WiFi LED indicator" /></p>
<h2 id="xfce4-æ¡Œé¢"><a class="markdownIt-Anchor" href="#xfce4-æ¡Œé¢"></a> xfce4 æ¡Œé¢</h2>
<p>åƒç°5,6å¹´çš„æ¿å­åˆå†ä¸€æ¬¡äº®äº†</p>
<p><img src="/images/hikey970/hikey970-xfce4.jpg" alt="Hikey970 xfce4" /></p>
<h1 id="åˆ¶ä½œ-rootfs-initramfs"><a class="markdownIt-Anchor" href="#åˆ¶ä½œ-rootfs-initramfs"></a> åˆ¶ä½œ rootfs, initramfs</h1>
<p>ç¯å¢ƒæ˜¯ qemu-system-aarch64 Debian 13 Trixie, æŠ˜è…¾äº†ä¸€åœˆï¼Œæœ€åè¿˜æ˜¯å‘ç° Ubuntu, Debian, Arch Linux è¿™3ä¸ªï¼Œè¿˜æ˜¯ Debian å¯¹ Aarch64 æ”¯æŒæœ€å¥½ï¼ŒUbuntu ç”šè‡³è¿˜ä¸€ä¸ªæ¡Œé¢ç‰ˆçš„ Arm å®‰è£…é•œåƒéƒ½æ²¡æœ‰(Armæ¶æ„çš„å®‰è£…é•œåƒä¼¼ä¹éƒ½æ˜¯æœåŠ¡å™¨ç‰ˆçš„)ã€‚</p>
<p><img src="/images/hikey970/debian-vs-ubuntu.png" alt="Debian vs. Ubuntu" /></p>
<h2 id="networkmanager-vs-wpasupplicant"><a class="markdownIt-Anchor" href="#networkmanager-vs-wpasupplicant"></a> NetworkManager vs wpasupplicant</h2>
<p>ç‚¹äº®å¹ç° Hikey970 ç”¨çš„æ˜¯ <a href="https://github.com/mengzhuo/hikey970-ubuntu-image">hikey970-ubuntu-image</a>, å®ƒçš„ rootfs é‡Œå®‰è£…çš„æ˜¯ NetworkManager, å½“æˆ‘è¯•ç€å°† hikey970-ubuntu-image è½¬æ¢æˆ hikey970-debian-image æ—¶ï¼Œå‘ç° debootstrap ä¼šå› ä¸ºå¥‡æ€ªçš„åŒ…ä¾èµ–é—®é¢˜ï¼Œæ— æ³•å®‰è£… NetworkManagerï¼Œ è€Œä¸”äº†è§£åˆ° wpasupplicant å¯ä»¥å®ŒæˆåŒæ ·çš„äº‹æƒ…(è¿æ¥ WiFi,è®©æ¿å­è”ç½‘), è€Œä¸”ä½“é‡æ›´å°ï¼Œæ›´é€‚åˆè¿™ç§å¼€å‘æ¿ã€‚</p>
<p>æ‰€ä»¥è¿™ä¸ª Debian 12 rootfs ç½‘ç»œè¿™å—ä½¿ç”¨äº† <strong>wpasupplicant</strong>, <strong>iw</strong>, <strong>iproute2</strong>, <strong>dhcpcd5</strong> å››å‰‘å®¢</p>
<ul>
<li>wpasupplicant</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=WPA supplicant daemon (interface %i)</span><br><span class="line">After=sys-subsystem-net-devices-%i.device</span><br><span class="line">Wants=sys-subsystem-net-devices-%i.device</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">ExecStart=/sbin/wpa_supplicant -c /etc/wpa_supplicant/wpa_supplicant.conf -i %i</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>Note:</p>
<ol>
<li>å½“ <code>systemctl enable wpa_supplicant@wlan0.service</code> æ—¶ systemd ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªç¬¦å·é“¾æ¥æ–‡ä»¶åˆ° <code>/etc/systemd/system/wpa_supplicant@.service</code>, è€Œæ–‡ä»¶é‡Œçš„ <code>%i</code> æ˜¯æ— çº¿ç½‘ç»œè®¾å¤‡æ¥å£åï¼Œå³ <strong>wlan0</strong>.</li>
<li>æ‰‹åŠ¨åˆ›å»º <code>/etc/wpa_supplicant/wpa_supplicant.conf</code> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wpa_passphrase &lt;SSID&gt; &lt;PASSWORD&gt; &gt;/etc/wpa_supplicant/wpa_supplicant.conf</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>iw</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iw dev wlan0 scan | grep &#x27;SSID:&#x27;</span><br><span class="line">iw dev wlan0 connect &lt;SSID&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>iproute2</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ip link show wlan0</span><br><span class="line">ip addr wlan0</span><br></pre></td></tr></table></figure>
<ul>
<li>dhcpcd5</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl enable dhcpcd.service</span><br><span class="line">systemctl start dhcpcd.service</span><br></pre></td></tr></table></figure>
<ul>
<li>ntpdate</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/sbin/ntpdate ntp.aliyun.com</span><br></pre></td></tr></table></figure>
<h1 id="display-on-hikey970"><a class="markdownIt-Anchor" href="#display-on-hikey970"></a> Display on HiKey970</h1>
<p><img src="/images/hikey970/hikey970-display.svg" alt="From claude.ai" /></p>
<h2 id="dsi-bridge-probe"><a class="markdownIt-Anchor" href="#dsi-bridge-probe"></a> <a href="https://lore.kernel.org/dri-devel/e5ec9763-37fe-6cd8-6eca-52792afbdb94@samsung.com/T/">DSI bridge probe</a></h2>
<p>DSI bridge driver probe <a href="https://gist.github.com/lucmann/7ae4bf26d49807a4d951db2e989a271c">é™·å…¥æ­»å¾ªç¯</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[    3.270639] [drm] the bridge node is adv7533</span><br><span class="line">[    3.270645] [drm] wait for external HDMI bridge driver.</span><br><span class="line">[    3.270832] of_irq_parse_raw:  /soc/gpio@e8a0c000:00000001,00000002</span><br><span class="line">[    3.270905] adv7511_probe dev-&gt;of_node (____ptrval____)</span><br><span class="line">[    3.270909] __devm_drm_bridge_alloc</span><br><span class="line">[    3.271426] adv7511_init_regulators</span><br><span class="line">[    3.330257] [drm] the bridge node is adv7533</span><br><span class="line">[    3.330264] [drm] wait for external HDMI bridge driver.</span><br><span class="line">[    3.330449] of_irq_parse_raw:  /soc/gpio@e8a0c000:00000001,00000002</span><br><span class="line">[    3.330522] adv7511_probe dev-&gt;of_node (____ptrval____)</span><br><span class="line">[    3.330526] __devm_drm_bridge_alloc</span><br><span class="line">[    3.331015] adv7511_init_regulators</span><br><span class="line">[    3.390209] [drm] the bridge node is adv7533</span><br><span class="line">[    3.390215] [drm] wait for external HDMI bridge driver.</span><br><span class="line">[    3.390397] of_irq_parse_raw:  /soc/gpio@e8a0c000:00000001,00000002</span><br><span class="line">[    3.390464] adv7511_probe dev-&gt;of_node (____ptrval____)</span><br><span class="line">[    3.390468] __devm_drm_bridge_alloc</span><br><span class="line">[    3.390937] adv7511_init_regulators</span><br><span class="line">[    3.446194] [drm] the bridge node is adv7533</span><br><span class="line">[    3.446200] [drm] wait for external HDMI bridge driver.</span><br></pre></td></tr></table></figure>
<p>æŒ‰ç…§ä¸Šæ¸¸å¯¹ hisilicon/kirin/dw_drm_dsi.c çš„<a href="https://lists.freedesktop.org/archives/freedreno/2021-October/012892.html">ä¿®æ”¹</a>ï¼Œå°† hikey9xx/gpu/kirin9xx_dw_drm_dsi.c ä¸­çš„ <code>dsi_probe()</code> åœ¨ probe ordering è°ƒæ•´åå¯è§£å†³æ­¤é—®é¢˜</p>
<p><img src="/images/hikey970/dsi_probe_ordering_comparison.svg" alt="From claude.ai" /></p>
<h1 id="panfrost-on-hikey970"><a class="markdownIt-Anchor" href="#panfrost-on-hikey970"></a> Panfrost on HiKey970</h1>
<p>PathorÂ© å’Œ Tyr(Rust) éƒ½æ˜¯ä¸º Valhall æ¶æ„ä»¥ä¸Šçš„ Mali GPU (å³åŸºäº Command Stream Frontend çš„ GPU) è€Œå†™çš„é©±åŠ¨, HiKey 970 (HI3670 SoC) æ­è½½çš„æ˜¯ Mali G72 MP12 (Bifrost)ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨ Panfrost é©±åŠ¨ã€‚ä¸Šé¢å¯ä»¥å¯åŠ¨çš„å†…æ ¸æ˜¯ v4.19, å½“æ—¶çš„ GPU é©±åŠ¨è¿˜æ˜¯ lima.</p>
<p>HiKey 970 å¼€å‘æ¿å¯¹åº”çš„ devicetree æºæ–‡ä»¶ <strong>hi3670-hikey970.dts</strong>ï¼Œ åœ¨ v4.19 æ—¶ä¹Ÿåˆå…¥äº†ä¸»çº¿ã€‚</p>
<blockquote>
<p>commit 5510ee99c0deb0c0235acee6498a6745c8317df1<br />
Refs: v4.19-rc1-6-g5510ee99c0de<br />
Author:     Manivannan Sadhasivam <a href="mailto:mani@kernel.org">mani@kernel.org</a><br />
AuthorDate: Fri Aug 10 23:23:39 2018 +0530<br />
Commit:     Wei Xu <a href="mailto:xuwei5@hisilicon.com">xuwei5@hisilicon.com</a><br />
CommitDate: Wed Sep 19 16:15:25 2018 +0100</p>
<pre><code>arm64: dts: Add devicetree support for HiKey970 board

Add devicetree support for HiKey970 development board which
based on Hi3670 SoC and is also one of the 96Boards Consumer
Edition and AI platform.

Only UART6 is enabled which is the default console required
by the 96Boards Consumer Edition Specification.

This patch has been tested on HiKey970 Board.

Signed-off-by: Manivannan Sadhasivam &lt;manivannan.sadhasivam@linaro.org&gt;
Signed-off-by: Wei Xu &lt;xuwei5@hisilicon.com&gt;
</code></pre>
<hr />
<p>arch/arm64/boot/dts/hisilicon/hi3670-hikey970.dts | 35 +++++++++++++++++++++++++++++++++++<br />
1 file changed, 35 insertions(+)</p>
</blockquote>
<h2 id="v619"><a class="markdownIt-Anchor" href="#v619"></a> v6.19</h2>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä½¿ç”¨ <a href="https://github.com/mengzhuo/hikey970-ubuntu-image">@mengzhuo/hikey970-ubuntu-image</a> å¯ä»¥æ­£å¸¸å¯åŠ¨ HiKey970ï¼Œè€Œä¸”å®‰è£…äº† Xfceï¼Œæ‰€ä»¥æˆ‘ fork äº†è¿™ä¸ªä»“åº“ï¼Œå°†å…¶æ›´åä¸º <a href="https://github.com/lucmann/hikey970-debian-image">hikey970-debian-image</a>ï¼Œå°†åŸºäº Ubuntu bionic (18.04 LTS) çš„ rootfs.img ç§»æ¤åˆ°åŸºäº Debian bookworm (12) çš„ rootfs.imgï¼Œå¹¶æˆåŠŸå¯åŠ¨ã€‚ä¹‹åå‡†å¤‡å°†è¿™å— 2018 å¹´ 3 æœˆå‘å¸ƒçš„æ¿å­ä½œä¸ºå­¦ä¹ å’Œæµ‹è¯•å†…æ ¸æœ€æ–°é©±åŠ¨çš„å¹³å°ï¼Œæ‰€ä»¥ç°åœ¨å°±çœ‹çœ‹ä¸»çº¿ç¼–è¯‘çš„è®¾å¤‡æ ‘ (arch/arm64/boot/dts/hisilicon/hi3670-hikey970.dtb) å’Œå†…æ ¸ (arch/arm64/boot/Image.gz) æ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨ã€‚</p>
<ul>
<li>kernel + dtb<br />
<img src="/images/hikey970/try-latest-kernel-on-hikey970.png" alt="Try latest kernel on hikey970" /></li>
<li>kernel only<br />
<img src="/images/hikey970/try-latest-kernel-on-hikey970-2.png" alt="Try latest kernel on hikey970" /></li>
</ul>
<h3 id="random-crng-init-done-took-70-minutes"><a class="markdownIt-Anchor" href="#random-crng-init-done-took-70-minutes"></a> <code>random: crng init done</code> took <strong>70</strong> minutes</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[    5.201987] random: perl: uninitialized urandom read (4 bytes read)</span><br><span class="line">[    5.202263] random: perl: uninitialized urandom read (4 bytes read)</span><br><span class="line">[FAILED] Failed to start systemd-raâ€¦rvice - Load/Save Random Seed.</span><br><span class="line">See &#x27;systemctl status systemd-random-seed.service&#x27; for details.</span><br><span class="line">         Starting systemd-tmpfiles-â€¦leanup of Temporary Directories...</span><br><span class="line">[  OK  ] Finished systemd-tmpfiles-â€¦ Cleanup of Temporary Directories.</span><br><span class="line">         Starting dpkg-db-backup.seâ€¦ly dpkg database backup service...</span><br><span class="line">         Starting logrotate.service - Rotate log files...</span><br><span class="line">[  OK  ] Finished dpkg-db-backup.seâ€¦aily dpkg database backup service.</span><br><span class="line">[  OK  ] Finished logrotate.service - Rotate log files.</span><br><span class="line">[ 4396.712657] random: crng init done</span><br><span class="line">[ 4396.712674] random: 4 urandom warning(s) missed due to ratelimiting</span><br></pre></td></tr></table></figure>
<p>crng init èŠ±è¿™ä¹ˆé•¿æ—¶é—´çš„åŸå› æ˜¯ç³»ç»Ÿ entropy sources ä¸è¶³ï¼Œå†…æ ¸ä¸€ç›´åœ¨å¡«å…… entropy pool, è¿™ç§æƒ…å†µåªå‘ç”Ÿåœ¨åˆ·å†™ç³»ç»Ÿåç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œä¹‹å entropy pool åº”è¯¥å›ºåŒ–åœ¨ UFS å­˜å‚¨é‡Œäº†ï¼Œå¯åŠ¨æ—¶é—´å°±æ­£å¸¸äº†ã€‚ä½†å› ä¸ºéœ€è¦é¢‘ç¹åˆ·å†™ç³»ç»Ÿï¼Œæ‰€ä»¥è¿˜æ˜¯å¾—è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å°è¯•äº† rng-tools5 å’Œ haveged åï¼Œå‘ç° haveged å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ç†è®ºä¸Š rng-tools5/rng-tools ä¹Ÿå¯ä»¥å€ŸåŠ© <code>/dev/hwrng</code> è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†ä¸çŸ¥ä¸ºä½• rngd æœåŠ¡å§‹ç»ˆ<a href="https://gist.githubusercontent.com/lucmann/bfabaac6a2c904877629dd3ce97229eb/raw/ceb01cbe992a09d8e1c20a944ea272c8145c7a67/rngd.log">ä¸èƒ½æ­£å¸¸å·¥ä½œ</a>ï¼Œæ€€ç–‘å¯èƒ½æ˜¯ Hi3670 SoC çš„ TRNG é©±åŠ¨æœ‰é—®é¢˜ã€‚</p>
<h3 id="sd-å¡ä¸è¯†åˆ«"><a class="markdownIt-Anchor" href="#sd-å¡ä¸è¯†åˆ«"></a> SD å¡ä¸è¯†åˆ«</h3>
<p>ç°è±¡ï¼šç³»ç»Ÿå¯åŠ¨å <code>lsblk</code> çœ‹ä¸åˆ° <code>/dev/mmcblk0</code></p>
<p>ä½¿ç”¨åŸæ¥çš„ <a href="https://github.com/mengzhuo/hikey970-ubuntu-image">hikey970-ubuntu-image (@mengzhuo)</a> é•œåƒï¼ŒSD å¡æ˜¯æ­£å¸¸è¯†åˆ«çš„ï¼Œè¿™å°±è¯´æ˜ç”µæºå’Œå¡æœ¬èº«æ²¡æœ‰é—®é¢˜(ä¹‹å‰å› ä¸ºä½¿ç”¨ 12V çš„ç”µæº, fastboot flash æ€»æ˜¯å¤±è´¥çš„æ•™è®­å¾ˆæ·±åˆ»ğŸ¶)ã€‚</p>
<p>å°†ä¸‹æ¥ä¸»è¦æ’æŸ¥è®¾å¤‡æ ‘å’Œå†…æ ¸é…ç½®çš„é—®é¢˜ï¼Œåœ¨è¿™é‡Œå’Œ ChatGPT/DeepSeek äº¤æµäº†å¾ˆå¤šï¼Œæ€»ä½“æ„Ÿè§‰ ChatGPT åœ¨è¿™æ–¹é¢æ¯” DeepSeek é è°±ä¸€ç‚¹ã€‚äº†è§£åˆ°äº† HI3670 SoC çš„ MMC æ§åˆ¶å™¨ä½¿ç”¨çš„æ˜¯ Synopsis DesignWare MMC, å®ƒæ˜¯ä¸€ç§ä¸éµå¾ª SD Host Controller Interface è§„èŒƒçš„å‚å®¶è‡ªå®šä¹‰æ¥å£ã€‚</p>
<h3 id="sd-å¡å¯åŠ¨"><a class="markdownIt-Anchor" href="#sd-å¡å¯åŠ¨"></a> SD å¡å¯åŠ¨</h3>
<p>SD å¡å¯åŠ¨æœ‰ä¸¤ä¸ªä¸»è¦é—®é¢˜:</p>
<ul>
<li><a href="https://github.com/lucmann/hikey970-debian-image/blob/hikey970-debian-image/hikey970_dual_boot_builder.sh">å‡†å¤‡å¥½ sdcard.img</a></li>
<li>è®© UEFI èƒ½å¤Ÿè¯†åˆ« sdcard ä¸Šçš„ boot åˆ†åŒº</li>
</ul>
<p><img src="/images/hikey970/BootManager.png" alt="Hikey970 BootManager" /><br />
<img src="/images/hikey970/DevicesList.png" alt="Hikey970 BootManager" /><br />
<img src="/images/hikey970/BootFromFile.png" alt="Hikey970 BootManager" /><br />
<img src="/images/hikey970/boot_sdcard_0x30a7d232_0x3f_0x7ffc1.png" alt="Hikey970 BootManager" /><br />
<img src="/images/hikey970/grub.png" alt="Hikey970 BootManager" /></p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://www.96boards.org/documentation/consumer/hikey/hikey970/hardware-docs/files/hikey970-user-manual.pdf">HiKey970 User Guide</a></li>
<li><a href="https://www.96boards.org/documentation/consumer/hikey/hikey970/installation/board-recovery.md.html">HiKey970 Board Recovery</a></li>
<li><a href="https://github.com/96boards/documentation/tree/master/consumer/hikey/hikey970">HiKey970 GitHub</a></li>
<li><a href="https://www.96boards.org/documentation/consumer/hikey/hikey620/installation/linux-sd-boot.md.html">Create a Bootable SD Card for HiKey</a></li>
<li><a href="https://releases.linaro.org/96boards/reference-platform/debian/hikey/">Linaro downloads</a></li>
<li><a href="https://lore.kernel.org/bpf/20200820100440.2d30dc02@coco.lan/T/">DRM driver for HiKey 970</a></li>
<li><a href="https://github.com/dorssel/usbipd-win/issues/59">usbipd-win github issues</a></li>
<li><a href="https://notes.leconiot.com/debootstrap.html">è·¨å¹³å°æ›´æ–°åˆ¶ä½œ rootfs</a></li>
<li><a href="https://www.collabora.com/news-and-blog/news-and-events/racing-karts-on-a-rust-gpu-kernel-driver.html">Racing karts on a Rust GPU kernel driver</a></li>
<li><a href="https://github.com/lucmann/hikey970-ubuntu-image">åˆ¶ä½œ Hikey970 çš„ rootfs</a></li>
<li><a href="https://uefi.org/sites/default/files/resources/UEFI_Shell_Spec_2_0_Errata_A.pdf">UEFI Shell Specification</a></li>
<li><a href="https://patchwork.kernel.org/project/dri-devel/patch/20190627151740.2277-1-matt.redfearn@thinci.com/">When should ADV7511 bridge attach to DSI host</a></li>
</ul>
]]></content>
      <categories>
        <category>hardware</category>
      </categories>
      <tags>
        <tag>Hardware</tag>
      </tags>
  </entry>
  <entry>
    <title>SiPEED LicheePi4A</title>
    <url>/hw/licheepi4a/</url>
    <content><![CDATA[<p><img src="/images/licheepi4a/lp4a-closeup.jpg" alt="LicheePi4A close-up" /></p>
<span id="more"></span>
<p><img src="/images/licheepi4a/lp4a-spec.png" alt="LicheePi4A specification" /><br />
<img src="/images/licheepi4a/lp4a-working.jpg" alt="LicheePi4A bring-up" /><br />
<img src="/images/licheepi4a/lp4a-desktop.jpg" alt="LicheePi4A desktop (debian)" /></p>
<h1 id="upstream-drivers"><a class="markdownIt-Anchor" href="#upstream-drivers"></a> Upstream Drivers</h1>
<ul>
<li><a href="https://patchwork.kernel.org/project/dri-devel/patch/20241203134137.2114847-12-m.wilczynski@samsung.com/">drm/imagination: Enable PowerVR driver for RISC-V (WIP)</a></li>
<li><a href="https://lore.kernel.org/all/20241120061848.196754-1-keith.zhao@starfivetech.com/">drm/verisilicon : support DC8200 and inno hdmi (WIP)</a><br />
(å¹³å¤´å“¥ TH1520 å’Œ èµ›æ˜‰ JH7110 éƒ½é›†æˆäº†æ˜¾ç¤ºæ§åˆ¶å™¨ IP - DC8200 (å¥½åƒæ¥è‡ªèŠ¯åŸ))</li>
</ul>
<h1 id="boot-from-sd-card"><a class="markdownIt-Anchor" href="#boot-from-sd-card"></a> Boot from SD-Card</h1>
<p>dd å†™å…¥ <a href="https://fast-mirror.isrc.ac.cn/revyos/extra/images/lpi4a/20250110/">img</a> åˆ° sd-card ä¹‹å lsblk</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS</span><br><span class="line">sda           8:0    1 119.1G  0 disk </span><br><span class="line">â”œâ”€sda1        8:1    1     2M  0 part </span><br><span class="line">â”œâ”€sda2        8:2    1   500M  0 part /media/luc/44c74757-aab2-4d25-9ed8-c29e027c3f3f</span><br><span class="line">â”œâ”€sda3        8:3    1     4G  0 part </span><br><span class="line">â””â”€sda4        8:4    1     5G  0 part /media/luc/f929e2c1-6c06-419a-9c7b-28f5ded4e665</span><br></pre></td></tr></table></figure>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<p><a href="https://docs.revyos.dev/en/docs/Installation/licheepi4a/">Installing RevyOS</a></p>
]]></content>
      <categories>
        <category>hardware</category>
      </categories>
      <tags>
        <tag>Hardware</tag>
      </tags>
  </entry>
  <entry>
    <title>é¾™èŠ¯ CPU &amp; GPU</title>
    <url>/hw/loongson/</url>
    <content><![CDATA[<h1 id="cpu"><a class="markdownIt-Anchor" href="#cpu"></a> CPU</h1>
<h2 id="ls3a6000"><a class="markdownIt-Anchor" href="#ls3a6000"></a> <a href="https://www.loongson.cn/product/show?id=26">LS3A6000</a></h2>
<p>é¾™èŠ¯çš„èŠ¯ç‰‡äº§å“å¯ä»¥åˆ†ä¸ºä¿¡æ¯åŒ–é¢†åŸŸå’Œå·¥æ§/åµŒå…¥å¼é¢†åŸŸ, 3A6000 ä¹Ÿæœ‰åˆ†åˆ«åº”ç”¨äºè¿™ä¸¤ä¸ªé¢†åŸŸçš„é…ç½®ï¼Œ7A2000åŒæ ·æœ‰ä¸¤ç§ã€‚3A6000 æ˜¯é¾™èŠ¯ç¬¬å››ä»£å¾®æ¶æ„çš„é¦–æ¬¾äº§å“ï¼ŒåŒæ ·é‡‡ç”¨é¾™èŠ¯è‡ªä¸»æŒ‡ä»¤é›†æ¶æ„LoongArch64(é¦–æ¬¾LoongArch64æ¶æ„çš„å¤„ç†å™¨æ˜¯<a href="https://www.loongson.cn/product/show?id=10">3A5000</a>)</p>
<span id="more"></span>
<h1 id="gpu"><a class="markdownIt-Anchor" href="#gpu"></a> GPU</h1>
<h2 id="ls7a2000"><a class="markdownIt-Anchor" href="#ls7a2000"></a> <a href="https://www.loongson.cn/product/show?id=16">LS7A2000</a></h2>
<p>7A2000æ˜¯ç¬¬äºŒä»£é¾™èŠ¯3å·ç³»åˆ—å¤„ç†å™¨é…ç½®æ¡¥ç‰‡ï¼Œç‰‡å†…é¦–æ¬¡é›†æˆäº†è‡ªç ”GPU(åº”è¯¥æ˜¯ Vivante GC2000), æ­é…32ä½DDR4æ˜¾å­˜æ¥å£ï¼Œæœ€å¤§æ”¯æŒ16GBæ˜¾å­˜å®¹é‡ã€‚</p>
<h2 id="å…³äºé©±åŠ¨"><a class="markdownIt-Anchor" href="#å…³äºé©±åŠ¨"></a> å…³äºé©±åŠ¨</h2>
<p>æ ¹æ®é¾™èŠ¯å·¥ç¨‹å¸ˆæäº¤çš„Linux å†…æ ¸é©±åŠ¨<a href="https://patchwork.freedesktop.org/series/133512/">è¡¥ä¸</a>ï¼ŒLS7A2000 æ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½ PCIe è®¾å¤‡(åŒæ—¶æœ‰2D, 3D åŠŸèƒ½)ï¼Œä¸ºäº†é¿å…å¯èƒ½çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œé©±åŠ¨é‡‡ç”¨äº†å†…æ ¸çš„ <a href="https://www.kernel.org/doc/html/latest/driver-api/component.html">component framework</a>ã€‚</p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<p><a href="https://blog.xen0n.name/posts/tinkering/loongarch-faq/">1. Unofficial LoongArch FAQ</a></p>
]]></content>
      <categories>
        <category>hardware</category>
      </categories>
      <tags>
        <tag>Hardware</tag>
      </tags>
  </entry>
  <entry>
    <title>Resizable PCI BAR</title>
    <url>/hw/pci/</url>
    <content><![CDATA[<p><img src="/images/pci/pci-configuration-space-memory-map.png" alt="pci-configuration-space-memory-map" /></p>
<span id="more"></span>
<h1 id="pci-config-space-span-stylecolor-red256-bytes-per-devicespan"><a class="markdownIt-Anchor" href="#pci-config-space-span-stylecolor-red256-bytes-per-devicespan"></a> PCI Config Space (<span style="color: red;">256 Bytes per Device</span>)</h1>
<p>PCI config space æœ¬è´¨ä¸Šæ˜¯ 64 ä¸ª 32-bit å¯„å­˜å™¨</p>
<p><img src="/images/pci/pci-configuration-space-headers.png" alt="Type 0 / 1 PCI Configuration Space Header" /></p>
<h2 id="pci-30-type-0-configuration-space-header"><a class="markdownIt-Anchor" href="#pci-30-type-0-configuration-space-header"></a> PCI 3.0 Type 0 Configuration Space Header</h2>
<p><strong>Type 0 Configuration Space Header</strong> ç”¨äºæœ€ç»ˆçš„å®é™…åŠŸèƒ½è®¾å¤‡ï¼Œä¹Ÿå°±æ˜¯ <strong>Endpoint Device</strong></p>
<h2 id="pci-30-type-1-configuration-space-header"><a class="markdownIt-Anchor" href="#pci-30-type-1-configuration-space-header"></a> PCI 3.0 Type 1 Configuration Space Header</h2>
<p><strong>Type 1 Configuration Space Header</strong> ç”¨äºè¿æ¥ä¸¤æ¡æ€»çº¿çš„è®¾å¤‡ï¼Œä¹Ÿå°±æ˜¯ <strong>Bridge Device</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pci 0000:00:00.0: config space:</span><br><span class="line">00000000: 86 80 34 3e</span><br><span class="line">00000004: 06 00 90 20</span><br><span class="line">00000008: 0c 00 00 06</span><br><span class="line">0000000c: 00 00 00 00 </span><br><span class="line">00000010: 00 00 00 00 &lt;- BAR0</span><br><span class="line">00000014: 00 00 00 00 &lt;- BAR1</span><br><span class="line">00000018: 00 00 00 00 &lt;- BAR2</span><br><span class="line">0000001c: 00 00 00 00 &lt;- BAR3</span><br><span class="line">00000020: 00 00 00 00 &lt;- BAR4</span><br><span class="line">00000024: 00 00 00 00 &lt;- BAR5</span><br><span class="line">00000028: 00 00 00 00</span><br><span class="line">0000002c: 28 10 20 09</span><br><span class="line">00000030: 00 00 00 00</span><br><span class="line">00000034: e0 00 00 00</span><br><span class="line">00000038: 00 00 00 00</span><br><span class="line">0000003c: 00 00 00 00</span><br><span class="line">00000040: 01 90 d1 fe</span><br><span class="line">00000044: 00 00 00 00</span><br><span class="line">00000048: 01 00 d1 fe</span><br><span class="line">0000004c: 00 00 00 00</span><br><span class="line">00000050: c1 02 00 00</span><br><span class="line">00000054: b1 80 00 00</span><br><span class="line">00000058: 47 00 70 8f</span><br><span class="line">0000005c: 07 01 00 8a</span><br><span class="line">00000060: 01 00 00 e0</span><br><span class="line">00000064: 00 00 00 00</span><br><span class="line">00000068: 01 80 d1 fe</span><br><span class="line">0000006c: 00 00 00 00</span><br><span class="line">00000070: 00 00 00 fc</span><br><span class="line">00000074: 01 00 00 00</span><br><span class="line">00000078: 00 0c 00 fc</span><br><span class="line">0000007c: 7f 00 00 00</span><br><span class="line">00000080: 01 00 00 00</span><br><span class="line">00000084: 00 00 00 00</span><br><span class="line">00000088: 1a 00 00 00</span><br><span class="line">0000008c: 00 00 00 00</span><br><span class="line">00000090: 01 00 00 fc</span><br><span class="line">00000094: 01 00 00 00</span><br><span class="line">00000098: 01 00 70 6c</span><br><span class="line">0000009c: 02 00 00 00</span><br><span class="line">000000a0: 01 00 00 00</span><br><span class="line">000000a4: 02 00 00 00</span><br><span class="line">000000a8: 01 00 80 6c</span><br><span class="line">000000ac: 02 00 00 00</span><br><span class="line">000000b0: 01 00 80 8b</span><br><span class="line">000000b4: 01 00 00 8b</span><br><span class="line">000000b8: 01 00 00 8a</span><br><span class="line">000000bc: 01 00 80 8f</span><br><span class="line">000000c0: 00 00 00 00</span><br><span class="line">000000c4: 00 00 00 00</span><br><span class="line">000000c8: 00 00 00 00</span><br><span class="line">000000cc: 00 00 00 00</span><br><span class="line">000000d0: 00 00 00 00</span><br><span class="line">000000d4: 00 00 00 00</span><br><span class="line">000000d8: 00 00 00 00</span><br><span class="line">000000dc: 00 00 00 00</span><br><span class="line">000000e0: 09 00 10 01</span><br><span class="line">000000e4: c1 60 61 7a</span><br><span class="line">000000e8: 8c 80 11 94</span><br><span class="line">000000ec: 00 c0 04 00</span><br><span class="line">000000f0: 00 00 00 00</span><br><span class="line">000000f4: c8 0f 0c 00</span><br><span class="line">000000f8: 00 00 00 00</span><br><span class="line">000000fc: 00 00 00 00</span><br><span class="line">pci 0000:00:00.0: [8086:3e34] type 00 class 0x060000 conventional PCI endpoint</span><br><span class="line">pci 0000:00:02.0: config space:</span><br><span class="line">00000000: 86 80 a0 3e</span><br><span class="line">00000004: 07 00 10 00</span><br><span class="line">00000008: 02 00 00 03</span><br><span class="line">0000000c: 00 00 00 00</span><br><span class="line">00000010: 04 00 00 c0 &lt;- BAR 0 * (type=mem)</span><br><span class="line">00000014: 00 00 00 00 &lt;- BAR 1</span><br><span class="line">00000018: 0c 00 00 b0 &lt;- BAR 2 * (type=mem)</span><br><span class="line">0000001c: 00 00 00 00 &lt;- BAR 3</span><br><span class="line">00000020: 01 40 00 00 &lt;- BAR 4 * (type=io)</span><br><span class="line">00000024: 00 00 00 00 &lt;- BAR 5</span><br><span class="line">00000028: 00 00 00 00</span><br><span class="line">0000002c: 28 10 20 09</span><br><span class="line">00000030: 00 00 00 00</span><br><span class="line">00000034: 40 00 00 00 &lt;- Capability Pointer : 40h</span><br><span class="line">00000038: 00 00 00 00</span><br><span class="line">0000003c: ff 01 00 00</span><br><span class="line">00000040: 09 70 0c 01 &lt;- Capability Next : 70h, ID: 09h (Vendor Specific)</span><br><span class="line">00000044: c1 60 61 7a</span><br><span class="line">00000048: 8c 80 11 94</span><br><span class="line">0000004c: 00 00 00 00</span><br><span class="line">00000050: c1 02 00 00</span><br><span class="line">00000054: b1 80 00 00</span><br><span class="line">00000058: 00 00 00 00</span><br><span class="line">0000005c: 01 00 80 8b</span><br><span class="line">00000060: 00 00 01 00</span><br><span class="line">00000064: 00 00 00 00</span><br><span class="line">00000068: 00 00 00 00</span><br><span class="line">0000006c: 00 00 00 00</span><br><span class="line">00000070: 10 ac 92 00 &lt;- Capability Next : ach, ID: 10h (PCI Express)</span><br><span class="line">00000074: 00 80 00 10</span><br><span class="line">00000078: 00 00 00 00</span><br><span class="line">0000007c: 00 00 00 00</span><br><span class="line">00000080: 00 00 00 00</span><br><span class="line">00000084: 00 00 00 00</span><br><span class="line">00000088: 00 00 00 00</span><br><span class="line">0000008c: 00 00 00 00</span><br><span class="line">00000090: 00 00 00 00</span><br><span class="line">00000094: 00 00 00 00</span><br><span class="line">00000098: 00 00 00 00</span><br><span class="line">0000009c: 00 00 00 00</span><br><span class="line">000000a0: 00 00 00 00</span><br><span class="line">000000a4: 00 00 00 00</span><br><span class="line">000000a8: 00 00 00 00</span><br><span class="line">000000ac: 05 d0 00 00 &lt;- Capability Next : d0h, ID: 05h (Message Signaled Interrupts)</span><br><span class="line">000000b0: 00 00 00 00</span><br><span class="line">000000b4: 00 00 00 00</span><br><span class="line">000000b8: 00 00 00 00</span><br><span class="line">000000bc: 00 00 00 00</span><br><span class="line">000000c0: 00 00 00 00</span><br><span class="line">000000c4: 00 00 00 00</span><br><span class="line">000000c8: 00 00 00 00</span><br><span class="line">000000cc: 00 00 00 00</span><br><span class="line">000000d0: 01 00 22 00 &lt;- Capability Last : 00h, ID: 01h (PCI Power Management Interface)</span><br><span class="line">000000d4: 00 00 00 00</span><br><span class="line">000000d8: 00 00 00 00</span><br><span class="line">000000dc: 00 00 00 00</span><br><span class="line">000000e0: 00 00 00 00</span><br><span class="line">000000e4: 00 00 00 00</span><br><span class="line">000000e8: 00 80 00 00</span><br><span class="line">000000ec: 00 00 00 00</span><br><span class="line">000000f0: 00 00 00 00</span><br><span class="line">000000f4: 00 00 00 00</span><br><span class="line">000000f8: 00 00 00 00</span><br><span class="line">000000fc: 18 00 e1 88</span><br><span class="line">pci 0000:00:02.0: [8086:3ea0] type 00 class 0x030000 PCIe Root Complex Integrated Endpoint</span><br><span class="line">pci 0000:00:02.0: BAR 0 [mem 0xc0000000-0xc0ffffff 64bit] &lt;- FB (mmapped Write-Combining)</span><br><span class="line">pci 0000:00:02.0: BAR 2 [mem 0xb0000000-0xbfffffff 64bit pref] &lt;- (mapped Write-Through)</span><br><span class="line">pci 0000:00:02.0: BAR 4 [io  0x4000-0x403f]</span><br><span class="line">pci 0000:00:02.0: Video device with shadowed ROM at [mem 0x000c0000-0x000dffff]</span><br><span class="line">...</span><br><span class="line">pci 0000:01:00.0: config space:</span><br><span class="line">00000000: de 10 13 1d</span><br><span class="line">00000004: 00 00 10 00</span><br><span class="line">00000008: a1 00 02 03</span><br><span class="line">0000000c: 00 00 00 00</span><br><span class="line">00000010: 00 00 00 c1 &lt;- BAR 0 * (type=mem)</span><br><span class="line">00000014: 0c 00 00 90 &lt;- BAR 1 * (type=mem)</span><br><span class="line">00000018: 00 00 00 00 &lt;- BAR 2</span><br><span class="line">0000001c: 0c 00 00 a0 &lt;- BAR 3 * (type=mem)</span><br><span class="line">00000020: 00 00 00 00 &lt;- BAR 4</span><br><span class="line">00000024: 01 30 00 00 &lt;- BAR 5 * (type=io)</span><br><span class="line">00000028: 00 00 00 00</span><br><span class="line">0000002c: 28 10 20 09</span><br><span class="line">00000030: 00 00 f8 ff</span><br><span class="line">00000034: 60 00 00 00 &lt;- Capability Pointer : 60h</span><br><span class="line">00000038: 00 00 00 00</span><br><span class="line">0000003c: ff 01 00 00</span><br><span class="line">00000040: 28 10 20 09</span><br><span class="line">00000044: 00 00 00 00</span><br><span class="line">00000048: 00 00 00 00</span><br><span class="line">0000004c: 00 00 00 00</span><br><span class="line">00000050: 00 00 00 00</span><br><span class="line">00000054: 01 00 00 00</span><br><span class="line">00000058: ce d6 23 00</span><br><span class="line">0000005c: 00 00 00 00</span><br><span class="line">00000060: 01 68 03 00 &lt;- Capability Next : 68h, ID: 01h (PCI Power Management Interface)</span><br><span class="line">00000064: 08 00 00 00</span><br><span class="line">00000068: 05 78 80 00 &lt;- Capability Next : 78h, ID: 05h (Message Signaled Interrupts)</span><br><span class="line">0000006c: 00 00 00 00</span><br><span class="line">00000070: 00 00 00 00</span><br><span class="line">00000074: 00 00 00 00</span><br><span class="line">00000078: 10 00 02 00 &lt;- Capability Last : 00h, ID: 10h (PCI Express)</span><br><span class="line">0000007c: e1 8d e8 07</span><br><span class="line">00000080: 30 29 09 00</span><br><span class="line">00000084: 43 4c 45 00</span><br><span class="line">00000088: 42 01 43 10</span><br><span class="line">0000008c: 00 00 00 00</span><br><span class="line">00000090: 00 00 00 00</span><br><span class="line">00000094: 00 00 00 00</span><br><span class="line">00000098: 00 00 00 00</span><br><span class="line">0000009c: 13 08 04 00</span><br><span class="line">000000a0: 00 00 00 00</span><br><span class="line">000000a4: 0e 00 00 00</span><br><span class="line">000000a8: 03 00 1e 00</span><br><span class="line">000000ac: 00 00 00 00</span><br><span class="line">000000b0: 00 00 00 00</span><br><span class="line">000000b4: 09 00 14 01</span><br><span class="line">000000b8: 00 00 00 00</span><br><span class="line">000000bc: 00 00 00 00</span><br><span class="line">000000c0: 00 00 00 00</span><br><span class="line">000000c4: 00 00 00 00</span><br><span class="line">000000c8: 00 00 00 00</span><br><span class="line">000000cc: 00 00 00 00</span><br><span class="line">000000d0: 00 00 00 00</span><br><span class="line">000000d4: 00 00 00 00</span><br><span class="line">000000d8: 00 00 00 00</span><br><span class="line">000000dc: 00 00 00 00</span><br><span class="line">000000e0: 00 00 00 00</span><br><span class="line">000000e4: 00 00 00 00</span><br><span class="line">000000e8: 00 00 00 00</span><br><span class="line">000000ec: 00 00 00 00</span><br><span class="line">000000f0: 00 00 00 00</span><br><span class="line">000000f4: 00 00 00 00</span><br><span class="line">000000f8: 00 00 00 00</span><br><span class="line">000000fc: 00 00 00 00</span><br><span class="line">pci 0000:01:00.0: [10de:1d13] type 00 class 0x030200 PCIe Endpoint</span><br><span class="line">pci 0000:01:00.0: BAR 0 [mem 0xc1000000-0xc1ffffff]</span><br><span class="line">pci 0000:01:00.0: BAR 1 [mem 0x90000000-0x9fffffff 64bit pref]</span><br><span class="line">pci 0000:01:00.0: BAR 3 [mem 0xa0000000-0xa1ffffff 64bit pref]</span><br><span class="line">pci 0000:01:00.0: BAR 5 [io  0x3000-0x307f]</span><br><span class="line">pci 0000:01:00.0: ROM [mem 0xfff80000-0xffffffff pref]</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ PCI config space dump å¯ä»¥é€šè¿‡å†…æ ¸å¯åŠ¨å‚æ•° <span style="background-color: yellow; padding: 4px;">pci=earlydump</span> å¼€å¯æ‰“å°ã€‚æ‰€è°“ <strong>earlydump</strong> æ˜¯æŒ‡æ‰“å°çš„æ˜¯å†…æ ¸<strong>æœªç»ä¿®æ”¹çš„</strong> config space, ä¹Ÿå°±æ˜¯è¯´æ˜¯ UEFI åˆå§‹åŒ–è¿‡çš„ config space, åƒ BAR é‡Œçš„ç‰©ç†åœ°å€ä¸€èˆ¬ä¸ä¼šæ˜¯è¿™ä¸ªè®¾å¤‡æœ€ç»ˆçš„ç‰©ç†å†…å­˜èµ·å§‹åœ°å€ï¼Œå†…æ ¸ä¸€èˆ¬éƒ½ä¼š<strong>é‡æ–°è§„åˆ’</strong> PCI è®¾å¤‡çš„ç‰©ç†å†…å­˜åœ°å€ç©ºé—´ï¼Œç”±å†…æ ¸é‡æ–°å¡«å…¥çš„ BAR å€¼ï¼Œå¯ä»¥é€šè¿‡</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lspci -xxx -s &lt;Bus:Dev.Func&gt;</span><br></pre></td></tr></table></figure>
<p>æˆ–</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xxd /sys/bus/pci/devices/&lt;Domain:Bus:Dev.Func&gt;/config</span><br></pre></td></tr></table></figure>
<p>æ¥æŸ¥çœ‹ã€‚</p>
<h1 id="pci-extended-config-space-span-stylecolor-red0x100-~-0xfffspan"><a class="markdownIt-Anchor" href="#pci-extended-config-space-span-stylecolor-red0x100-~-0xfffspan"></a> PCI Extended Config Space (<span style="color: red;">0x100 ~ 0xFFF</span>)</h1>
<p>PCI çš„ Capability æœ‰ Base å’Œ Extended ä¹‹åˆ†ï¼ŒBase Capability List åœ¨ PCI Config Space, è€Œ Extended Capability List åœ¨ Extended Config Spaceï¼Œå³åœ¨æ•´ä¸ªé…ç½®ç©ºé—´ 0x100 çš„ä½ç½®ã€‚</p>
<p>æŸ¥çœ‹æ–¹æ³•åŒä¸Š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lspci -xxxx -s &lt;Bus:Dev.Func&gt;</span><br></pre></td></tr></table></figure>
<p>æˆ–</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xxd /sys/bus/pci/devices/&lt;Domain:Bus:Dev.Func&gt;/config</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šéƒ½æ˜¯çº¯æ•°æ®å½¢å¼æ‰“å°ï¼Œå¦‚æœæƒ³ä»¥ Human-readable å½¢å¼çœ‹åˆ°ï¼Œè¯·ä½¿ç”¨</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lspci -vv -s &lt;Domain:Bus:Dev.Func&gt;</span><br></pre></td></tr></table></figure>
<h1 id="æ¶ˆå¤±çš„å—æ¡¥å’ŒåŒ—æ¡¥"><a class="markdownIt-Anchor" href="#æ¶ˆå¤±çš„å—æ¡¥å’ŒåŒ—æ¡¥"></a> æ¶ˆå¤±çš„å—æ¡¥å’ŒåŒ—æ¡¥</h1>
<p><img src="/images/pci/modern-computer.png" alt="" /></p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://wiki.osdev.org/PCI">osdev.org: PCI</a></li>
<li><a href="https://pcisig.com/sites/default/files/files/PCI_Code-ID_r_1_11__v24_Jan_2019.pdf">PCI Code and ID Assignment Specification,Rev. 1.11</a></li>
</ul>
]]></content>
      <categories>
        <category>hardware</category>
      </categories>
      <tags>
        <tag>Hardware</tag>
      </tags>
  </entry>
  <entry>
    <title>èŠ¯åŸ VPU</title>
    <url>/hw/verisilicon/</url>
    <content><![CDATA[<h1 id="hantro-vpu"><a class="markdownIt-Anchor" href="#hantro-vpu"></a> Hantro VPU</h1>
<p><a href="https://www.nexitventures.com/cases/hantro-products-oy/">Hantro Products OY</a> æ˜¯ä¸€å®¶ä¸“æ³¨äºè§†é¢‘ç¼–è§£ç æŠ€æœ¯çš„èŠ¬å…°å…¬å¸ï¼Œå®ƒçš„è§†é¢‘ç¼–ç  IP (Hantro H1) å’Œè§£ç  IP(Hantro G1) è¢«é›†æˆåœ¨ç‘èŠ¯å¾® RK3288 SoC ä¸Šã€‚å…¶å¼€æºé©±åŠ¨åœ¨ <a href="https://elixir.bootlin.com/linux/v6.10.6/source/drivers/media/platform/verisilicon">drivers/media/platform/verisilicon</a></p>
<span id="more"></span>
<ul>
<li>OOC
<ul>
<li>Hantro çš„ IP ä¸ºä»€ä¹ˆä¼šåœ¨èŠ¯åŸçš„<a href="https://www.verisilicon.com/cn/IPPortfolio/HantroVPUIP">è´§æ¶</a>ä¸Š</li>
<li>Hantro çš„åå­—å¥½åƒæ¥è‡ªä¸€ä¸ªèŠ¬å‰§(Shattered Dreams)è§’è‰²ï¼Œæœ‰ç‚¹åƒ Python<br />
<img src="/images/verisilicon/hantro.jpeg" alt="Hantro" /></li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>hardware</category>
      </categories>
      <tags>
        <tag>Hardware</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenGL ä¸­çš„ä¸€äº›æ¦‚å¿µå¯¹æ¯”</title>
    <url>/gfx/cg/</url>
    <content><![CDATA[<p><img src="/images/cg/fov.png" alt="Field-of-View" /></p>
<span id="more"></span>
<p>OpenGL (å¯èƒ½ä¹Ÿæœ‰å…¶å®ƒä¸ OpenGL æœ‰å…³çš„)ä¸­çš„æœ‰äº›æ¦‚å¿µå¾ˆç›¸ä¼¼ï¼Œæœ‰äº›æ ‡å‡†é‡Œä¹Ÿæ²¡æœ‰ç»™å‡ºä¸€ä¸ªæ˜ç¡®çš„å®šä¹‰ï¼Œæœ‰äº›å¦‚æœä»…ä»å­—é¢æ„æ€ç†è§£å¾ˆå®¹æ˜“æ··æ·†ï¼Œè¿™é‡Œå°†å¹³æ—¶è‡ªå·±æŸ¥è¯¢çš„èµ„æ–™åŠè‡ªå·±çš„ç†è§£æ•´ç†åˆ°ä¸€èµ·ï¼Œä»¥å¤‡ä¸æ—¶ä¹‹éœ€ã€‚</p>
<ul>
<li><a href="https://computergraphics.stackexchange.com/questions/9214/whats-the-difference-between-clipping-and-culling">Clip vs Cull</a></li>
<li><a href="https://graphicdesign.stackexchange.com/questions/45162/what-is-the-difference-between-glyph-and-font">Glyph vs Font</a></li>
</ul>
<h1 id="clip-vs-cull"><a class="markdownIt-Anchor" href="#clip-vs-cull"></a> Clip vs Cull</h1>
<ul>
<li>Clip æ˜¯ä¸€ä¸ª<strong>åšåŠ å‡æ³•</strong> çš„è¿‡ç¨‹ï¼Œå°±æ˜¯å®ƒä¼šå°†å¤„åœ¨ clip-space è¾¹ç•Œçš„å›¾å…ƒåˆ†æˆå¤šä¸ªå›¾å…ƒï¼Œæ–°ç”Ÿæˆçš„åœ¨ clip-space ä¹‹å¤–çš„å›¾å…ƒå°±ä¸¢å¼ƒæ‰äº†</li>
<li>Cull æ˜¯ä¸€ä¸ª<strong>åšçº¯å‡æ³•</strong> çš„è¿‡ç¨‹ï¼Œå®ƒä¸ä¼šç”Ÿæˆä»»ä½•æ–°çš„å›¾å…ƒï¼Œåªä¼šä¸¢å¼ƒå›¾å…ƒ</li>
</ul>
<h1 id="glfrustum"><a class="markdownIt-Anchor" href="#glfrustum"></a> <a href="https://blog.csdn.net/iteye_13202/article/details/82490241?spm=1001.2101.3001.6650.2&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-2-82490241-blog-133176951.235%5Ev43%5Epc_blog_bottom_relevance_base9&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-2-82490241-blog-133176951.235%5Ev43%5Epc_blog_bottom_relevance_base9&amp;utm_relevant_index=5"><code>glFrustum</code> vs <code>glm::perspective</code></a></h1>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">glFrustum(GLdouble left, GLdouble right, GLdouble bottom, GLdouble top, GLdouble zNear, GLdouble zFar);</span><br><span class="line">glm::mat4 <span class="title function_">glm::perspective</span><span class="params">(<span class="type">float</span> fovy, <span class="type">float</span> aspect, <span class="type">float</span> zNear, <span class="type">float</span> zFar)</span>;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸¤ç»„å‚æ•°ä¹‹é—´å¯ä»¥è½¬æ¢ï¼Œé¦–å…ˆ <code>zNear</code>, <code>zFar</code> æ˜¯ä¸€æ ·çš„ï¼Œä¸éœ€è¦è½¬æ¢ï¼Œå‰©ä¸‹å°±æ˜¯ <code>left, right, bottom, top</code> å’Œ <code>fovy, aspect</code> çš„å…³ç³»äº†ã€‚é¦–å…ˆ <code>left, right</code> å’Œ <code>bottom, top</code> åˆ†åˆ«æ˜¯ä»¥åŸç‚¹å¯¹ç§°çš„</p>
<h1 id="tessellation-vs-bÃ©zier"><a class="markdownIt-Anchor" href="#tessellation-vs-bÃ©zier"></a> Tessellation vs BÃ©zier</h1>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Tessellation (OpenGL)</th>
<th>BÃ©zier Curves/Surfaces</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Definition</strong></td>
<td>A technique that subdivides geometry into smaller pieces.</td>
<td>A mathematical way to define smooth curves/surfaces.</td>
</tr>
<tr>
<td><strong>Input</strong></td>
<td>Low-poly mesh, patches</td>
<td>Control points defining the shape</td>
</tr>
<tr>
<td><strong>Output</strong></td>
<td>Subdivided triangles</td>
<td>Interpolated curve/surface points</td>
</tr>
<tr>
<td><strong>Hardware Acceleration</strong></td>
<td>Uses GPU tessellation shaders</td>
<td>Requires CPU or GPU evaluation</td>
</tr>
<tr>
<td><strong>Level of Detail</strong></td>
<td>Dynamically adjustable</td>
<td>Fixed resolution unless re-evaluated</td>
</tr>
<tr>
<td><strong>Use Case</strong></td>
<td>Real-time rendering, adaptive detail</td>
<td>CAD, animation, precision modeling</td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>DRI Configuration Infrastructure</title>
    <url>/gfx/driconf/</url>
    <content><![CDATA[<h1 id="introduction"><a class="markdownIt-Anchor" href="#introduction"></a> Introduction</h1>
<p><strong>driconf</strong> æ˜¯ä¸€ä¸ªåŸºäº XML çš„ DRI é©±åŠ¨é…ç½®æœºåˆ¶ï¼Œå®ƒåŒæ—¶æä¾›ç³»ç»ŸèŒƒå›´çš„å’Œæ¯ç”¨æˆ·çš„é…ç½®æ–¹å¼ (å¦‚æœåŒæ—¶å­˜åœ¨ï¼Œåè€…è¦†ç›–å‰è€…)ã€‚driconf æä¾›ç»Ÿä¸€çš„é…ç½®æ ¼å¼ï¼Œå¹¶æ•´ç†å‡ºé©±åŠ¨å¸¸è§çš„é…ç½®é€‰é¡¹ï¼Œæ–¹ä¾¿æ˜“ç”¨ã€‚ driconf ä¸ä»…å¯ä»¥é’ˆå¯¹æŒ‡å®šè®¾å¤‡ï¼ŒæŒ‡å®š screen, æŒ‡å®šé©±åŠ¨è®¾ç½®é€‰é¡¹ï¼Œè€Œä¸”å¯ä»¥é’ˆå¯¹æ¯ä¸ªåº”ç”¨è®¾ç½®é€‰é¡¹ã€‚</p>
<span id="more"></span>
<p>ä¸€ä¸ª drirc XML æ–‡ä»¶çš„ç¤ºä¾‹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">driconf</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">device</span> <span class="attr">screen</span>=<span class="string">&quot;0&quot;</span> <span class="attr">driver</span>=<span class="string">&quot;swrast&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">name</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- Default options for all applications --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;pp_nogreen&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">name</span>=<span class="string">&quot;specific_application&quot;</span> <span class="attr">executable</span>=<span class="string">&quot;application_executable&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- Specific options for &#x27;specific_application&#x27; --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;option_name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;option_value&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Add more application-specific settings here --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">device</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Add more device-specific settings here --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">driconf</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç¤ºä¾‹ä¸­ç”¨äº† 4 ä¸ª XML å…ƒç´ ï¼Œdrirc æ–‡ä»¶æ”¯æŒ 5 ä¸ª XML å…ƒç´ :</p>
<ul>
<li><code>&lt;driconf&gt;&lt;/driconf&gt;</code></li>
<li><code>&lt;device&gt;&lt;/device&gt;</code></li>
<li><code>&lt;application&gt;&lt;/application&gt;</code></li>
<li><code>&lt;engine&gt;&lt;/engine&gt;</code></li>
<li><code>&lt;option ... /&gt;</code></li>
</ul>
<p>Option çš„å€¼ç±»å‹å¯ä»¥æ˜¯ä»¥ä¸‹ 5 ç§, ä½† bool ç±»å‹çš„å€¼åœ¨ XML æ–‡ä»¶ä¸­åªèƒ½å¡« <code>true/false</code>, ä¸èƒ½å¡« <code>0/1</code>, è¿™åº”è¯¥å’Œ XML Parser æœ‰å…³ã€‚enum å’Œ int ç±»å‹åœ¨ XML æ–‡ä»¶ä¸­éƒ½æ˜¯å¡«æ•°å­—ã€‚</p>
<ul>
<li>bool</li>
<li>enum</li>
<li>int</li>
<li>float</li>
<li>string</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">driOptionValue</span> &#123;</span></span><br><span class="line">   <span class="type">unsigned</span> <span class="type">char</span> _bool; <span class="comment">/**&lt; \brief Boolean */</span></span><br><span class="line">   <span class="type">int</span> _int;      <span class="comment">/**&lt; \brief Integer or Enum */</span></span><br><span class="line">   <span class="type">float</span> _float;  <span class="comment">/**&lt; \brief Floating-point */</span></span><br><span class="line">   <span class="type">char</span> *_string;   <span class="comment">/**&lt; \brief String */</span></span><br><span class="line">&#125; driOptionValue;</span><br></pre></td></tr></table></figure>
<h1 id="setting-per-application"><a class="markdownIt-Anchor" href="#setting-per-application"></a> Setting Per-Application</h1>
<p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºå°† glxgears çš„çº¢è‰²é€šé“ç¦ç”¨ï¼Œè€Œ glmark2 çš„ç»¿è‰²é€šé“ç¦ç”¨çš„ <code>~/.drirc</code> é…ç½®, ä½ å¯ä»¥åŒæ—¶åœ¨åŒä¸€ä¸ªé©±åŠ¨ä¸‹è¿è¡Œè¿™ä¸¤ä¸ªåº”ç”¨ï¼Œå¯¹å®ƒä»¬è¿›è¡Œç‹¬ç«‹çš„é©±åŠ¨è®¾ç½®ã€‚</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">driconf</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">device</span> <span class="attr">screen</span>=<span class="string">&quot;0&quot;</span> <span class="attr">driver</span>=<span class="string">&quot;swrast&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">name</span>=<span class="string">&quot;glmark2&quot;</span> <span class="attr">executable</span>=<span class="string">&quot;glmark2&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;pp_nogreen&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">name</span>=<span class="string">&quot;glxgears&quot;</span> <span class="attr">executable</span>=<span class="string">&quot;glxgears&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;pp_nored&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">device</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Add more device-specific settings here --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">driconf</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/images/driconf/per-application-dri-conf.png" alt="per-application driconf" /></p>
<p>æ›´æœ‰æ„æ€çš„æ˜¯ <code>application</code> å…ƒç´ ä¸ä»…æä¾› <code>executable</code> è¿™ä¸€ç§æŒ‡å®šåº”ç”¨çš„æ–¹å¼ï¼Œå®ƒè¿˜æä¾›</p>
<ul>
<li><code>executable_regexp</code></li>
<li><code>sha1</code></li>
<li><code>application_name_match</code></li>
</ul>
<p>å¤šç§æ–¹å¼æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨ï¼Œç”šè‡³å¯ä»¥æŒ‡å®šåº”ç”¨çš„ç‰ˆæœ¬ <code>application_versions</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; attr[i]; i += <span class="number">2</span>) &#123;</span><br><span class="line">   <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(attr[i], <span class="string">&quot;name&quot;</span>)) <span class="comment">/* not needed here */</span>;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(attr[i], <span class="string">&quot;executable&quot;</span>)) exec = attr[i+<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(attr[i], <span class="string">&quot;executable_regexp&quot;</span>)) exec_regexp = attr[i+<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(attr[i], <span class="string">&quot;sha1&quot;</span>)) sha1 = attr[i+<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(attr[i], <span class="string">&quot;application_name_match&quot;</span>))</span><br><span class="line">      application_name_match = attr[i+<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(attr[i], <span class="string">&quot;application_versions&quot;</span>))</span><br><span class="line">      application_versions = attr[i+<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">else</span> XML_WARNING(<span class="string">&quot;unknown application attribute: %s.&quot;</span>, attr[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="mesa-driconf-implementation"><a class="markdownIt-Anchor" href="#mesa-driconf-implementation"></a> Mesa DriConf Implementation</h1>
<h2 id="configuration-override"><a class="markdownIt-Anchor" href="#configuration-override"></a> Configuration Override</h2>
<p><strong>drirc</strong> é…ç½®æ–‡ä»¶ä¸€èˆ¬åœ¨ 3 ä¸ªåœ°æ–¹</p>
<ul>
<li><code>$datadir</code>/drirc.d/* (e.g. <code>/usr/share/drirc.d/*</code> æˆ– <code>/usr/local/share/drirc.d/*</code>)</li>
<li><code>$sysconfdir</code>/drirc (e.g. <code>/etc/drirc</code>)</li>
<li><code>$HOME</code>/.drirc (e.g. <code>/home/luc/.drirc</code>)</li>
</ul>
<p>Mesa å®ç°çš„è¯»å–å’Œè§£æçš„é¡ºåºæ˜¯ä»ä¸Šåˆ°ä¸‹ï¼Œåè§£æçš„ä¼šè¦†ç›–å‰é¢çš„</p>
<h2 id="xml-config-helpers"><a class="markdownIt-Anchor" href="#xml-config-helpers"></a> XML Config Helpers</h2>
<p>Mesa ä¸­ (<code>util/xmlconfig.c</code>) æä¾›äº†è¯»å–å’Œè§£æ XML æ–‡ä»¶çš„ Helper å‡½æ•°ï¼Œå¹¶åœ¨ <code>util/driconf.h</code> ä¸­å®šä¹‰å¥½äº†å¸¸è§é…ç½®é€‰é¡¹ã€‚</p>
<ul>
<li><code>driParseOptionInfo</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void</span><br><span class="line">driParseOptionInfo(driOptionCache *info,</span><br><span class="line">                   const driOptionDescription *configOptions,</span><br><span class="line">                   unsigned numOptions);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>driParseConfigFiles</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void</span><br><span class="line">driParseConfigFiles(driOptionCache *cache, const driOptionCache *info,</span><br><span class="line">                    int screenNum, const char *driverName,</span><br><span class="line">                    const char *kernelDriverName,</span><br><span class="line">                    const char *deviceName,</span><br><span class="line">                    const char *applicationName, uint32_t applicationVersion,</span><br><span class="line">                    const char *engineName, uint32_t engineVersion)</span><br></pre></td></tr></table></figure>
<p>å®ƒä»¬ä¿©ä¸ªéƒ½å¿…é¡»æœ‰ä¸¤ä¸ª <code>driOptionCache</code> ä½œä¸ºå…¥å‚ï¼Œä¸€ä¸ªæ˜¯è°ƒç”¨è€…è¾“å…¥çš„ (const ä¿®é¥°çš„)ï¼Œé©±åŠ¨ç”¨å®ƒæ¥åˆå§‹åŒ–å¦ä¸€ä¸ª <code>driOptionCache</code>ã€‚è°ƒç”¨è€…è¾“å…¥çš„ <code>driOptionCache</code> æ˜¯ Gallium <strong>pipe-loader</strong> æŠŠä»åŸå§‹çš„ XML æ–‡ä»¶è§£æå‡ºæ¥çš„ Option çš„æè¿° <code>driOptionDescription</code> ä¿å­˜åœ¨ <code>struct drm_driver_descriptor</code> ç»“æ„ä½“çš„ <code>.driconf</code> æˆå‘˜ä¸­ã€‚</p>
<p>pipe-loader ç”šè‡³æä¾›äº†ä¸€ä¸ª C å¤´æ–‡ä»¶ <em>src/gallium/auxiliary/pipe-loader/driinfo_gallium.h</em>ï¼Œ é‡Œé¢åŒ…å«äº†æ‰€æœ‰ Gallium é©±åŠ¨éƒ½æ”¯æŒçš„ DRI é…ç½®é€‰é¡¹ï¼Œå°±æ˜¯è¯´å³ä½¿åœ¨ç³»ç»Ÿä¸­æ²¡æœ‰ä»»ä½•é¢å¤–çš„ drirc XML æ–‡ä»¶çš„æƒ…å†µä¸‹, é€šè¿‡ä¿®æ”¹ <em>driinfo_gallium.h</em> é‡æ–°ç¼–è¯‘é©±åŠ¨ï¼Œå°±èƒ½æ”¹å˜é©±åŠ¨çš„ä¸€äº›è¡Œä¸º (å½“ç„¶ï¼Œç³»ç»Ÿè·¯å¾„ä¸‹çš„ drirc å¦‚æœè®¾ç½®äº†ç›¸åŒçš„é€‰é¡¹ä¼šè¦†ç›– driinfo_gallium.h çš„è®¾ç½®, å› ä¸ºç³»ç»Ÿè·¯å¾„ä¸‹çš„é…ç½®è¿è¡Œæ—¶æ‰è§£æçš„)</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/gallium/auxiliary/pipe-loader/driinfo_gallium.h b/src/gallium/auxiliary/pipe-loader/driinfo_gallium.h</span></span><br><span class="line"><span class="comment">index 3b0ab726e8f..0e8184a6b95 100644</span></span><br><span class="line"><span class="comment">--- a/src/gallium/auxiliary/pipe-loader/driinfo_gallium.h</span></span><br><span class="line"><span class="comment">+++ b/src/gallium/auxiliary/pipe-loader/driinfo_gallium.h</span></span><br><span class="line"><span class="meta">@@ -9,7 +9,7 @@</span> DRI_CONF_SECTION_END</span><br><span class="line"> DRI_CONF_SECTION_QUALITY</span><br><span class="line">    DRI_CONF_PP_CELSHADE(0)</span><br><span class="line">    DRI_CONF_PP_NORED(0)</span><br><span class="line"><span class="deletion">-   DRI_CONF_PP_NOGREEN(0)</span></span><br><span class="line"><span class="addition">+   DRI_CONF_PP_NOGREEN(1)</span></span><br><span class="line">    DRI_CONF_PP_NOBLUE(0)</span><br><span class="line">    DRI_CONF_PP_JIMENEZMLAA(0, 0, 32)</span><br><span class="line">    DRI_CONF_PP_JIMENEZMLAA_COLOR(0, 0, 32)</span><br></pre></td></tr></table></figure>
<p><img src="/images/driconf/scene-shadow-no-green.png" alt="glmark2 -bshadow" /></p>
<h2 id="how-to-add-driconf-support-in-gallium-driver"><a class="markdownIt-Anchor" href="#how-to-add-driconf-support-in-gallium-driver"></a> How to add driconf support in Gallium driver</h2>
<p>ä¸€èˆ¬æ˜¯åœ¨ gallium xxx_device (æˆ– xxx_screen) ç»“æ„ä½“ä¸­æ·»åŠ ä¸€ä¸ªåŒ…å« <code>driOptionCache</code> ç»“æ„ä½“å’Œä¸€å¤§å †é…ç½®é€‰é¡¹å˜é‡çš„ç»“æ„ä½“ï¼Œåœ¨ <code>xxx_screen_create()</code> å‡½æ•°é‡Œè°ƒç”¨ <code>driParseConfigFiles()</code> æˆ– <code>driParseOptionInfo()</code> å‡½æ•°æŠŠ <code>/etc/drirc</code> æ–‡ä»¶é‡Œçš„é€‰é¡¹è§£æåˆ° xxx_device æˆ– xxx_screen ç»“æ„ä½“ä¸­</p>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://dri.freedesktop.org/wiki/ConfigurationOptions/">Common Configuration Options</a></li>
<li><a href="https://dri.freedesktop.org/wiki/ConfigurationInfrastructure/">https://dri.freedesktop.org/wiki/ConfigurationInfrastructure/</a></li>
<li><a href="https://dri.freedesktop.org/wiki/DriConf/">GUI å·¥å…· DriConf</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Mesa</tag>
      </tags>
  </entry>
  <entry>
    <title>DRI Legacy</title>
    <url>/gfx/dril/</url>
    <content><![CDATA[<h1 id="just-read-it"><a class="markdownIt-Anchor" href="#just-read-it"></a> Just read it</h1>
<p><a href="https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/28378">gallium/dril: Compatibility stub for the legacy DRI loader interface</a></p>
<span id="more"></span>
<h1 id="dri-extensions"><a class="markdownIt-Anchor" href="#dri-extensions"></a> DRI extensions</h1>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#define __DRI2_BLOB                        &quot;DRI2_Blob&quot;</span><br><span class="line">#define __DRI2_BUFFER_DAMAGE               &quot;DRI2_BufferDamage&quot;</span><br><span class="line">#define __DRI2_CONFIG_QUERY                &quot;DRI_CONFIG_QUERY&quot;</span><br><span class="line">#define __DRI2_FENCE                       &quot;DRI2_Fence&quot;</span><br><span class="line">#define __DRI2_FLUSH                       &quot;DRI2_Flush&quot;</span><br><span class="line">#define __DRI2_FLUSH_CONTROL               &quot;DRI_FlushControl&quot;</span><br><span class="line">#define __DRI2_INTEROP                     &quot;DRI2_Interop&quot;</span><br><span class="line">#define __DRI2_NO_ERROR                    &quot;DRI_NoError&quot;</span><br><span class="line">#define __DRI2_RENDERER_QUERY              &quot;DRI_RENDERER_QUERY&quot;</span><br><span class="line">#define __DRI2_ROBUSTNESS                  &quot;DRI_Robustness&quot;</span><br><span class="line">#define __DRI2_THROTTLE                    &quot;DRI2_Throttle&quot;</span><br><span class="line">#define __DRI_BACKGROUND_CALLABLE          &quot;DRI_BackgroundCallable&quot;</span><br><span class="line">#define __DRI_CONFIG_OPTIONS               &quot;DRI_ConfigOptions&quot;</span><br><span class="line">#define __DRI_COPY_SUB_BUFFER              &quot;DRI_CopySubBuffer&quot;</span><br><span class="line">#define __DRI_CORE                         &quot;DRI_Core&quot;</span><br><span class="line">#define __DRI_DRI2                         &quot;DRI_DRI2&quot;</span><br><span class="line">#define __DRI_DRI2_LOADER                  &quot;DRI_DRI2Loader&quot;</span><br><span class="line">#define __DRI_IMAGE                        &quot;DRI_IMAGE&quot;</span><br><span class="line">#define __DRI_IMAGE_DRIVER                 &quot;DRI_IMAGE_DRIVER&quot;</span><br><span class="line">#define __DRI_IMAGE_LOADER                 &quot;DRI_IMAGE_LOADER&quot;</span><br><span class="line">#define __DRI_IMAGE_LOOKUP                 &quot;DRI_IMAGE_LOOKUP&quot;</span><br><span class="line">#define __DRI_MEDIA_STREAM_COUNTER         &quot;DRI_MediaStreamCounter&quot;</span><br><span class="line">#define __DRI_MUTABLE_RENDER_BUFFER_DRIVER &quot;DRI_MutableRenderBufferDriver&quot;</span><br><span class="line">#define __DRI_MUTABLE_RENDER_BUFFER_LOADER &quot;DRI_MutableRenderBufferLoader&quot;</span><br><span class="line">#define __DRI_READ_DRAWABLE                &quot;DRI_ReadDrawable&quot;</span><br><span class="line">#define __DRI_SWAP_CONTROL                 &quot;DRI_SwapControl&quot;</span><br><span class="line">#define __DRI_SWRAST                       &quot;DRI_SWRast&quot;</span><br><span class="line">#define __DRI_SWRAST_LOADER                &quot;DRI_SWRastLoader&quot;</span><br><span class="line">#define __DRI_SYSTEM_TIME                  &quot;DRI_SystemTime&quot;</span><br><span class="line">#define __DRI_TEX_BUFFER                   &quot;DRI_TexBuffer&quot;</span><br><span class="line">#define __DRI_USE_INVALIDATE               &quot;DRI_UseInvalidate&quot;</span><br></pre></td></tr></table></figure>
<p>(extracted by <code>rg '^#define __DRI.* &quot;DRI.*&quot;' include/GL/internal/dri_interface.h | sort | awk '&#123;printf(&quot;%s %-34s %s\n&quot;, $1, $2, $3)&#125;'</code>)</p>
<p>è¿™äº›æ‰©å±•è¢«å®šä¹‰åœ¨ <code>dri_interface.h</code>, è¯¥æ–‡ä»¶æœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p>
<ul>
<li>å®ƒæ˜¯ mesa å†…éƒ¨çš„ libGL ä¸ libgallium_dri ä¹‹é—´çš„çº¦å®š</li>
<li>å®ƒæ˜¯ mesa ä¸å¤–éƒ¨ <a href="http://X.org">X.org</a> æœåŠ¡å™¨å®¶æ—çš„çº¦å®š</li>
</ul>
<h1 id="libgl_drivers_path"><a class="markdownIt-Anchor" href="#libgl_drivers_path"></a> <s>LIBGL_DRIVERS_PATH</s></h1>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">       14  armada-drm_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  exynos_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  gm12u320_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  hdlcd_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  hx8357d_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  ili9163_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  ili9225_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  ili9341_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  ili9486_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  imx-dcss_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  imx-drm_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  imx-lcdif_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  ingenic-drm_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  kirin_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  kms_swrast_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  komeda_dri.so -&gt; libdril_dri.so</span><br><span class="line">  1151904  libdril_dri.so</span><br><span class="line">124969400  libgallium.so</span><br><span class="line">       14  mali-dp_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  mcde_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  mediatek_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  meson_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  mi0283qt_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  mxsfb-drm_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  panel-mipi-dbi_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  panfrost_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  panthor_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  pl111_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  radeonsi_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  rcar-du_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  repaper_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  rockchip_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  rzg2l-du_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  ssd130x_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  st7586_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  st7735r_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  sti_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  stm_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  sun4i-drm_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  swrast_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  udl_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  vkms_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  zink_dri.so -&gt; libdril_dri.so</span><br><span class="line">       14  zynqmp-dpsub_dri.so -&gt; libdril_dri.so</span><br></pre></td></tr></table></figure>
<p>(generated by <code>ls -go --time-style=+ /home/luc/mesa-install/lib/x86_64-linux-gnu/dri | cut -c 14-</code>)</p>
<h1 id="gl-frontends"><a class="markdownIt-Anchor" href="#gl-frontends"></a> GL Frontends</h1>
<ul>
<li>GLX</li>
<li>EGL</li>
<li>GBM</li>
</ul>
<p>åœ¨æœ‰äº† DRIL ä¹‹åï¼Œè¿™äº› GL å‰ç«¯åº“å¯ä»¥ç›´æ¥é“¾æ¥ <code>libgallium.so</code></p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Mesa</tag>
      </tags>
  </entry>
  <entry>
    <title>Edge Function - A Little Math You Want to Know about CG</title>
    <url>/gfx/edge-func/</url>
    <content><![CDATA[<div class="tenor-gif-embed" data-postid="18866305" data-share-method="host" data-aspect-ratio="2.40601" data-width="100%"><a href="https://tenor.com/view/4points-gif-18866305">4points GIF</a>from <a href="https://tenor.com/search/4points-gifs">4points GIFs</a></div> <script type="text/javascript" async src="https://tenor.com/embed.js"></script>
<span id="more"></span>
<h1 id="edge-å‡½æ•°å®šä¹‰"><a class="markdownIt-Anchor" href="#edge-å‡½æ•°å®šä¹‰"></a> Edge å‡½æ•°å®šä¹‰</h1>
<span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>E</mi><mn>01</mn></msub><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mi>P</mi><mi mathvariant="normal">.</mi><mi>x</mi><mo>âˆ’</mo><msub><mi>V</mi><mn>0</mn></msub><mi mathvariant="normal">.</mi><mi>x</mi><mo stretchy="false">)</mo><mo>âˆ—</mo><mo stretchy="false">(</mo><msub><mi>V</mi><mn>1</mn></msub><mi mathvariant="normal">.</mi><mi>y</mi><mo>âˆ’</mo><msub><mi>V</mi><mn>0</mn></msub><mi mathvariant="normal">.</mi><mi>y</mi><mo stretchy="false">)</mo><mo>âˆ’</mo><mo stretchy="false">(</mo><mi>P</mi><mi mathvariant="normal">.</mi><mi>y</mi><mo>âˆ’</mo><msub><mi>V</mi><mn>0</mn></msub><mi mathvariant="normal">.</mi><mi>y</mi><mo stretchy="false">)</mo><mo>âˆ—</mo><mo stretchy="false">(</mo><msub><mi>V</mi><mn>1</mn></msub><mi mathvariant="normal">.</mi><mi>x</mi><mo>âˆ’</mo><msub><mi>V</mi><mn>0</mn></msub><mi mathvariant="normal">.</mi><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">E_{01}(P)=(P.x - V_0.x) * (V_1.y - V_0.y) - (P.y - V_0.y) * (V_1.x - V_0.x)</annotation></semantics></math></span>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mn>01</mn></msub><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">E_{01}(P) &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> å½“ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> åœ¨ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mrow><msub><mi>V</mi><mn>0</mn></msub><msub><mi>V</mi><mn>1</mn></msub></mrow><mo stretchy="true">â‡€</mo></mover></mrow><annotation encoding="application/x-tex">\overrightharpoon{V_0V_1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.35533em;vertical-align:-0.15em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.20533em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.6833299999999998em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width='400em' height='0.522em' viewBox='0 0 400000 522' preserveAspectRatio='xMaxYMin slice'><path d='M0 241v40h399993c4.7-4.7 7-9.3 7-14 0-9.3
-3.7-15.3-11-18-92.7-56.7-159-133.7-199-231-3.3-9.3-6-14.7-8-16-2-1.3-7-2-15-2
-10.7 0-16.7 2-18 6-2 2.7-1 9.7 3 21 15.3 42 36.7 81.8 64 119.5 27.3 37.7 58
 69.2 92 94.5zm0 0v40h399900v-40z'/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span> çš„<strong>å³è¾¹</strong></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mn>01</mn></msub><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">E_{01}(P) = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> å½“ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> åœ¨ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mrow><msub><mi>V</mi><mn>0</mn></msub><msub><mi>V</mi><mn>1</mn></msub></mrow><mo stretchy="true">â‡€</mo></mover></mrow><annotation encoding="application/x-tex">\overrightharpoon{V_0V_1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.35533em;vertical-align:-0.15em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.20533em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.6833299999999998em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width='400em' height='0.522em' viewBox='0 0 400000 522' preserveAspectRatio='xMaxYMin slice'><path d='M0 241v40h399993c4.7-4.7 7-9.3 7-14 0-9.3
-3.7-15.3-11-18-92.7-56.7-159-133.7-199-231-3.3-9.3-6-14.7-8-16-2-1.3-7-2-15-2
-10.7 0-16.7 2-18 6-2 2.7-1 9.7 3 21 15.3 42 36.7 81.8 64 119.5 27.3 37.7 58
 69.2 92 94.5zm0 0v40h399900v-40z'/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span> çš„<strong>è¾¹ä¸Š</strong></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mn>01</mn></msub><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">E_{01}(P) &lt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span> å½“ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> åœ¨ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mrow><msub><mi>V</mi><mn>0</mn></msub><msub><mi>V</mi><mn>1</mn></msub></mrow><mo stretchy="true">â‡€</mo></mover></mrow><annotation encoding="application/x-tex">\overrightharpoon{V_0V_1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.35533em;vertical-align:-0.15em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.20533em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.6833299999999998em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width='400em' height='0.522em' viewBox='0 0 400000 522' preserveAspectRatio='xMaxYMin slice'><path d='M0 241v40h399993c4.7-4.7 7-9.3 7-14 0-9.3
-3.7-15.3-11-18-92.7-56.7-159-133.7-199-231-3.3-9.3-6-14.7-8-16-2-1.3-7-2-15-2
-10.7 0-16.7 2-18 6-2 2.7-1 9.7 3 21 15.3 42 36.7 81.8 64 119.5 27.3 37.7 58
 69.2 92 94.5zm0 0v40h399900v-40z'/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span> çš„<strong>å·¦è¾¹</strong></li>
</ul>
<p>æ›´å¥½è®°çš„å½¢å¼: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">âˆ¥</mo><mover accent="true"><mrow><msub><mi>V</mi><mn>1</mn></msub><msub><mi>V</mi><mn>0</mn></msub></mrow><mo stretchy="true">â‡€</mo></mover><mo>Ã—</mo><mover accent="true"><mrow><mi>P</mi><msub><mi>V</mi><mn>0</mn></msub></mrow><mo stretchy="true">â‡€</mo></mover><mo stretchy="false">âˆ¥</mo></mrow><annotation encoding="application/x-tex">\lVert \overrightharpoon{V_1V_0} \times \overrightharpoon{PV_0} \rVert</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.45533em;vertical-align:-0.25em;"></span><span class="mopen">âˆ¥</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.20533em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.6833299999999998em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width='400em' height='0.522em' viewBox='0 0 400000 522' preserveAspectRatio='xMaxYMin slice'><path d='M0 241v40h399993c4.7-4.7 7-9.3 7-14 0-9.3
-3.7-15.3-11-18-92.7-56.7-159-133.7-199-231-3.3-9.3-6-14.7-8-16-2-1.3-7-2-15-2
-10.7 0-16.7 2-18 6-2 2.7-1 9.7 3 21 15.3 42 36.7 81.8 64 119.5 27.3 37.7 58
 69.2 92 94.5zm0 0v40h399900v-40z'/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.45533em;vertical-align:-0.25em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.20533em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span class="svg-align" style="top:-3.6833299999999998em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width='400em' height='0.522em' viewBox='0 0 400000 522' preserveAspectRatio='xMaxYMin slice'><path d='M0 241v40h399993c4.7-4.7 7-9.3 7-14 0-9.3
-3.7-15.3-11-18-92.7-56.7-159-133.7-199-231-3.3-9.3-6-14.7-8-16-2-1.3-7-2-15-2
-10.7 0-16.7 2-18 6-2 2.7-1 9.7 3 21 15.3 42 36.7 81.8 64 119.5 27.3 37.7 58
 69.2 92 94.5zm0 0v40h399900v-40z'/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span><span class="mclose">âˆ¥</span></span></span></span></p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<p><a href="https://www.cs.drexel.edu/~deb39/Classes/Papers/comp175-06-pineda.pdf">A Parallel Algorithm for Polygon Rasteriztion</a></p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>EGLImage &amp; Direct Texture</title>
    <url>/gfx/egl-image/</url>
    <content><![CDATA[<h1 id="overview"><a class="markdownIt-Anchor" href="#overview"></a> Overview</h1>
<p>EGLImageçš„å­˜åœ¨æ˜¯ä¸ºäº†æ›´æ–¹ä¾¿åœ°åœ¨EGL client APIä¹‹é—´å…±äº«2D Image Data. é‚£ä»€ä¹ˆæ˜¯EGL client APIå‘¢ï¼ŸOpenGL, OpenGL ES, OpenVGéƒ½æ˜¯EGL client API. EGLImageä¸ä¸‹é¢3ä¸ªEGL Extensionsæœ‰å…³:</p>
<ul>
<li>EGL_KHR_image</li>
<li>EGL_KHR_image_base</li>
<li>EGL_KHR_image_pixmap</li>
</ul>
<span id="more"></span>
<p>åä¸¤ä¸ªæ‰©å±•å…¶å®æ˜¯ä»ç¬¬ä¸€ä¸ªå¼€ç¦»å‡ºæ¥çš„ã€‚æ¶‰åŠEGLImageæ–°å¢çš„Tokenå’ŒAPIéƒ½æ˜¯åœ¨åä¸¤ä¸ªæ‰©å±•é‡Œå®šä¹‰çš„ã€‚</p>
<h1 id="egl_khr_image_base"><a class="markdownIt-Anchor" href="#egl_khr_image_base"></a> EGL_KHR_image_base</h1>
<p>å®ƒå®šä¹‰äº†ä¸€ä¸ªæ–°çš„Opaqueç±»å‹EGLImageKHR</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">void</span> * EGLImageKHR;</span><br></pre></td></tr></table></figure>
<p>ä¸¤è€…å®ƒå®šä¹‰äº†2ä¸ªæ–°API</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">EGLImageKHR <span class="title function_">eglCreateImageKHR</span><span class="params">(</span></span><br><span class="line"><span class="params">EGLDisplay dpy,</span></span><br><span class="line"><span class="params">EGLContext ctx,</span></span><br><span class="line"><span class="params">EGLenum target,</span></span><br><span class="line"><span class="params">EGLClientBuffer buffer,</span></span><br><span class="line"><span class="params"><span class="type">const</span> EGLint *attrib_list</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"></span><br><span class="line">EGLBoolean <span class="title function_">eglDestroyImageKHR</span><span class="params">(</span></span><br><span class="line"><span class="params">EGLDisplay dpy,</span></span><br><span class="line"><span class="params">EGLImageKHR image</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼ŒEGLClientBufferä¹Ÿæ˜¯Opaqueç±»å‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">void</span> * EGLClientBuffer;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>eglCreateImageKHR()</code> æ¥å—çš„ <strong>targets</strong>:</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">target</th>
<th style="text-align:left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">EGL_GL_TEXTURE_2D</td>
<td style="text-align:left">Used for GL 2D texture images</td>
</tr>
<tr>
<td style="text-align:left">EGL_GL_TEXTURE_CUBE_MAP_POSITIVE_X</td>
<td style="text-align:left">Used for the +X face of GL cubemap texture images</td>
</tr>
<tr>
<td style="text-align:left">EGL_GL_TEXTURE_CUBE_MAP_NEGATIVE_X</td>
<td style="text-align:left">Used for the -X face of GL cubemap texture images</td>
</tr>
<tr>
<td style="text-align:left">EGL_GL_TEXTURE_CUBE_MAP_POSITIVE_Y</td>
<td style="text-align:left">Used for the +Y face of GL cubemap texture images</td>
</tr>
<tr>
<td style="text-align:left">EGL_GL_TEXTURE_CUBE_MAP_NEGATIVE_Y</td>
<td style="text-align:left">Used for the -Y face of GL cubemap texture images</td>
</tr>
<tr>
<td style="text-align:left">EGL_GL_TEXTURE_CUBE_MAP_POSITIVE_Z</td>
<td style="text-align:left">Used for the +Z face of GL cubemap texture images</td>
</tr>
<tr>
<td style="text-align:left">EGL_GL_TEXTURE_CUBE_MAP_NEGATIVE_Z</td>
<td style="text-align:left">Used for the -Z face of GL cubemap texture images</td>
</tr>
<tr>
<td style="text-align:left">EGL_GL_TEXTURE_3D</td>
<td style="text-align:left">Used for GL 3D texture images</td>
</tr>
<tr>
<td style="text-align:left">EGL_GL_RENDERBUFFER</td>
<td style="text-align:left">Used for GL renderbuffer images</td>
</tr>
<tr>
<td style="text-align:left">EGL_NATIVE_PIXMAP_KHR</td>
<td style="text-align:left">Used for X11 Pixmap (added EGL_KHR_image_pixmap)</td>
</tr>
</tbody>
</table>
<ul>
<li><code>eglCreateImageKHR()</code> æ¥å—çš„ <strong>attributes</strong>:</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">attribute</th>
<th style="text-align:left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">EGL_WIDTH</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">EGL_HEIGHT</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">EGL_LINUX_DRM_FOURCC_EXT</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">EGL_DMA_BUF_PLANE0_FD_EXT</td>
<td style="text-align:left">0x3272</td>
</tr>
<tr>
<td style="text-align:left">EGL_DMA_BUF_PLANE0_OFFSET_EXT</td>
<td style="text-align:left">0x3273</td>
</tr>
<tr>
<td style="text-align:left">EGL_DMA_BUF_PLANE0_PITCH_EXT</td>
<td style="text-align:left">0x3274</td>
</tr>
<tr>
<td style="text-align:left">EGL_DMA_BUF_PLANE1_FD_EXT</td>
<td style="text-align:left">0x3275</td>
</tr>
<tr>
<td style="text-align:left">EGL_DMA_BUF_PLANE1_OFFSET_EXT</td>
<td style="text-align:left">0x3276</td>
</tr>
<tr>
<td style="text-align:left">EGL_DMA_BUF_PLANE1_PITCH_EXT</td>
<td style="text-align:left">0x3277</td>
</tr>
<tr>
<td style="text-align:left">EGL_DMA_BUF_PLANE2_FD_EXT</td>
<td style="text-align:left">0x3278</td>
</tr>
<tr>
<td style="text-align:left">EGL_DMA_BUF_PLANE2_OFFSET_EXT</td>
<td style="text-align:left">0x3279</td>
</tr>
<tr>
<td style="text-align:left">EGL_DMA_BUF_PLANE2_PITCH_EXT</td>
<td style="text-align:left">0x327A</td>
</tr>
</tbody>
</table>
<ul>
<li><code>eglDestroyImageKHR()</code></li>
</ul>
<h2 id="eglimagekhr-in-kylin-wlcom"><a class="markdownIt-Anchor" href="#eglimagekhr-in-kylin-wlcom"></a> EGLImageKHR in <a href="https://gitee.com/openkylin/kylin-wayland-compositor">kylin-wlcom</a></h2>
<pre><code class="highlight mermaid">sequenceDiagram
    autonumber

    participant app
    participant compositor
    participant libwlroots
    participant mesa
    participant kernel

    app -&gt;&gt; compositor : REQUEST:create_prime_buffer &lt;- fd
    compositor --&gt;&gt; compositor : drm_handle_create_prime_buffer(..., fd, ...)
    compositor -&gt;&gt; libwlroots  : wlr_buffer_init(..., &amp;buffer_impl, ...)
    compositor --&gt;&gt; compositor : API:buffer_get_dmabuf(struct wlr_buffer *, struct wlr_dmabuf_attributes *)
    compositor -&gt;&gt; libwlroots  : wlr_buffer_get_dmabuf(struct wlr_buffer *, struct wlr_dmabuf_attributes *)
    compositor --&gt;&gt; compositor : gl_texture_from_dmabuf_buffer()
    compositor --&gt;&gt; compositor : gl_texture_from_dmabuf()
    compositor --&gt;&gt; compositor : ky_egl_create_image_from_dmabuf() -&gt; EGLImageKHR
    rect rgb(191, 223, 255)
        compositor -&gt;&gt; mesa        : eglCreateImageKHR() -&gt; EGLImageKHR
        mesa --&gt;&gt; mesa : dri2_create_image()
        mesa --&gt;&gt; mesa : dri2_create_image_dma_buf()
        mesa --&gt;&gt; mesa : xxx_resource_from_handle()
        mesa --&gt;&gt; mesa : xxx_bo_import(..., fd)
        mesa -&gt;&gt; kernel: drmPrimeFDToHandle(..., fd) -&gt; gem_handle
    end</code></pre>
<h1 id="egl_khr_image_pixmap"><a class="markdownIt-Anchor" href="#egl_khr_image_pixmap"></a> EGL_KHR_image_pixmap</h1>
<h1 id="gl_oes_egl_image"><a class="markdownIt-Anchor" href="#gl_oes_egl_image"></a> <a href="https://docs.imgtec.com/reference-manuals/open-gl-es-extensions/html/topics/GL_OES_EGL/image.html">GL_OES_EGL_image</a></h1>
<p>é€šè¿‡ <strong>EGLImage</strong> å…è®¸åœ¨ä¸Šä¸‹æ–‡ä¹‹é—´ï¼ŒAPI ä¹‹é—´ (å¦‚ OpenGL ES ä¸ Vulkan) å…±äº«çº¹ç†æ•°æ®ã€‚ä½†éœ€è¦çº¹ç†çš„ format/type è¦è¢« OpenGL ES æ”¯æŒï¼Œä¸æ”¯æŒçš„é‚£äº›è¦èµ° <a href="https://docs.imgtec.com/reference-manuals/open-gl-es-extensions/html/topics/GL_OES_EGL/image-external.html">GL_OES_EGL_image_external</a>, å› ä¸º format/type ä¸æ˜¯ OpenGL ES åŸç”Ÿæ”¯æŒï¼Œæ‰€ä»¥è¿™ä¸ªæ‰©å±•ç›¸æ¯” GL_OES_EGL_image å¤šäº†å‡ ä¸ª<strong>é™åˆ¶</strong></p>
<ul>
<li>ä¸èƒ½åœ¨è¿™äº›çº¹ç†å¯¹è±¡ä¸Šè°ƒç”¨ <code>gl*Tex*Image*2D()</code> å’Œ <code>glGenerateMipmap()</code> å‡½æ•°æ”¹å˜åŸæœ¬çš„å­˜å‚¨å†…å®¹(åŸå› æ˜¯è¿™äº›å¯¼å…¥è¿›æ¥çš„ä¸è¢«æ”¯æŒçš„æ ¼å¼å¯èƒ½ä¾èµ–ç‰¹å®šçš„ç¡¬ä»¶ç‰¹æ€§ï¼Œæ‰€ä»¥ä¸å…è®¸å¯¼å…¥è€…ä¿®æ”¹å®ƒä»¬)</li>
<li>çº¹ç†ç›®å‰åªèƒ½ç»‘å®š <code>GL_TEXTURE_EXTERNAL_OES</code>, è€Œä¸æ˜¯ GL_TEXTURE_2Dï¼Œ GL_TEXTURE_3D ç­‰</li>
<li>çº¹ç†é‡‡æ ·æ—¶åªå…è®¸ä½¿ç”¨ <code>GL_CLAMP_TO_EDGE</code> è¿™ä¸€ä¸ª wrap mode</li>
<li>çº¹ç†é‡‡æ ·æ—¶ä¼šéšå¼åœ°å°†ä»»ä½•æ ¼å¼è½¬æ¢æˆçº¿æ€§ RGB</li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Mesa</tag>
        <tag>EGL</tag>
      </tags>
  </entry>
  <entry>
    <title>Generic Buffer Manager</title>
    <url>/gfx/gbm/</url>
    <content><![CDATA[<p><img src="/images/gbm/gbm.png" alt="gbm dri backend implemented in Mesa" /></p>
<span id="more"></span>
<p>GBM æ˜¯ Linux å›¾å½¢æ ˆä¸­çš„é‡è¦ç»„ä»¶ï¼Œå®ƒå®šä¹‰äº†ä¸€ç»„åˆ†é… GPU ç¼“å†²åŒº (Buffer Object) çš„<a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/gbm/main/gbm.h">æ¥å£</a>ã€‚Mesa ä¸­æä¾›ä¸€ä¸ªåŸºäº DRI çš„åç«¯<a href="https://gitlab.freedesktop.org/mesa/mesa/-/tree/main/src/gbm/backends/dri">å®ç°</a></p>
<h1 id="gralloc"><a class="markdownIt-Anchor" href="#gralloc"></a> <a href="https://android.googlesource.com/platform/hardware/libhardware/">Gralloc</a></h1>
<h1 id="minigbm"><a class="markdownIt-Anchor" href="#minigbm"></a> <a href="https://chromium.googlesource.com/chromiumos/platform/minigbm/">minigbm</a></h1>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Mesa</tag>
      </tags>
  </entry>
  <entry>
    <title>gfxstream - Graphics Streaming Kit</title>
    <url>/gfx/gfxstream/</url>
    <content><![CDATA[<h1 id="gfxstream"><a class="markdownIt-Anchor" href="#gfxstream"></a> <a href="https://android.googlesource.com/platform/hardware/google/gfxstream/">gfxstream</a></h1>
<span id="more"></span>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://source.android.com/docs/devices/cuttlefish/gpu?hl=zh-cn">Cuttlefish: GPU å›¾å½¢åŠ é€Ÿ</a></li>
<li><a href="https://github.com/google/android-cuttlefish">Virtual Device for Android host-side utilities</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>glamor</title>
    <url>/gfx/glamor/</url>
    <content><![CDATA[<h1 id="introduction"><a class="markdownIt-Anchor" href="#introduction"></a> Introduction</h1>
<p>glamoræ˜¯ä¸€ä¸ªå¼€æºçš„2DåŠ é€Ÿé©±åŠ¨ï¼Œå®ƒä½œä¸ºXorgçš„ä¸€ä¸ªæ¨¡å—è¢«å®ç°ã€‚ç›¸æ¯”ä¼ ç»Ÿçš„DDX 2DåŠ é€Ÿé©±åŠ¨ï¼Œglamorä¸»è¦æœ‰ä»¥ä¸‹2ä¸ªå¥½å¤„:</p>
<ul>
<li>ä½¿ç”¨éå¸¸é€šç”¨çš„EGL/OpenGL APIå»æ“ä½œGPUç¡¬ä»¶ï¼Œçœå»äº†æ‰‹åŠ¨ä¸ºæ¯ä¸ªä¸åŒçš„GPUç¼–å†™2DåŠ é€Ÿé©±åŠ¨çš„éº»çƒ¦</li>
<li>æœ‰äº†glamorï¼Œä¸å†éœ€è¦ä¼ ç»Ÿçš„2D DDXé©±åŠ¨</li>
</ul>
<span id="more"></span>
<p>Xorgçš„glamorå®ç°ä¾èµ–3ä¸ªç»„ä»¶:</p>
<ul>
<li>EGL/GLX   è´Ÿè´£åˆ›å»ºåˆå§‹åŒ–reneder context</li>
<li>GL/GLES   è´Ÿè´£ç»˜åˆ¶2Då›¾å½¢</li>
<li>GBM       è´Ÿè´£ç®¡ç†Buffer Objectï¼ˆVRAM)</li>
</ul>
<h1 id="what-role-do-they-play-in-xorg-drivers"><a class="markdownIt-Anchor" href="#what-role-do-they-play-in-xorg-drivers"></a> What role do they play in Xorg drivers?</h1>
<img src="/gfx/glamor/glamor_sequence.png" class="" title="glamor_sequence">
<h1 id="gbm-generic-buffer-management"><a class="markdownIt-Anchor" href="#gbm-generic-buffer-management"></a> GBM - Generic Buffer Management</h1>
<img src="/gfx/glamor/gbm.png" class="" title="gbm internal &amp; backend">
<h1 id="how-to-get-egldisplay-from-gbm_device"><a class="markdownIt-Anchor" href="#how-to-get-egldisplay-from-gbm_device"></a> How to get EGLDisplay from gbm_device?</h1>
<img src="/gfx/glamor/glamor_egl_init.png" class="" title="glamor_egl_init">
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>X11</tag>
      </tags>
  </entry>
  <entry>
    <title>glmark2 Benchmark</title>
    <url>/gfx/glmark2/</url>
    <content><![CDATA[<h1 id="something-you-should-know-about-glmark2"><a class="markdownIt-Anchor" href="#something-you-should-know-about-glmark2"></a> Something you should know about <a href="https://github.com/glmark2/glmark2">glmark2</a></h1>
<ol>
<li>glmark2 çš„å‘½ä»¤è¡Œå‚æ•°æ ¼å¼</li>
</ol>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">glmark2 -b desktop:nframes=1000000:show-fps=true -b build:duration=100</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<ol start="2">
<li>
<p>glmark2 æ¯ä¸ªåœºæ™¯ (Scene) é»˜è®¤çš„è¿è¡Œæ—¶é—´ (duration) æ˜¯ 10 ç§’</p>
</li>
<li>
<p>glmark2 æä¾›ä¸€ä¸ªå…¬å…±é€‰é¡¹ (Option) <strong>show-fps</strong>, å¯ä»¥æ˜¾ç¤º Head-up Display (HUD) å½¢å¼çš„ FPS</p>
</li>
</ol>
<p><img src="/images/glmark2-desktop-show-fps.png" alt="glmark2-desktop show-fps" /></p>
<ol start="4">
<li>glmark2 è®¡ç®— FPS çš„æ—¶é—´ç²¾åº¦ (resolution) æ˜¯ nanosecond. å®ƒä½¿ç”¨çš„æ˜¯ <code>struct timespec</code>, è€Œä¸æ˜¯ <code>struct timeval</code></li>
</ol>
<h1 id="desktop"><a class="markdownIt-Anchor" href="#desktop"></a> desktop</h1>
<p><strong>desktop</strong>è¿™ä¸ªåœºæ™¯åœ¨fragment shaderä¸­ä½¿ç”¨äº†<strong>convolution</strong>è®¡ç®—é«˜æ–¯æ¨¡ç³Šæ•ˆæœ, è¿™é‡Œæˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹æ‰€æœ‰17ä¸ªåœºæ™¯çš„fragment shader, å¹¶è®°å½•ä¸€ä¸‹åœ¨<strong>Mesa llvmpipe</strong>ä¸‹ä»¥åŠ<code>glmark2 -b desktop</code>ä¸åŒçš„é€‰é¡¹ä¸‹çš„æµ‹è¯•ç»“æœã€‚</p>
<h2 id="fragment-shaders"><a class="markdownIt-Anchor" href="#fragment-shaders"></a> Fragment Shaders</h2>
<h3 id="build"><a class="markdownIt-Anchor" href="#build"></a> build</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">varying vec4 Color;</span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    gl_FragColor = Color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="texture"><a class="markdownIt-Anchor" href="#texture"></a> texture</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">uniform sampler2D MaterialTexture0;</span><br><span class="line"></span><br><span class="line">varying vec4 Color;</span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 texel = texture2D(MaterialTexture0, TextureCoord);</span><br><span class="line">    gl_FragColor = texel * Color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="shading"><a class="markdownIt-Anchor" href="#shading"></a> shading</h3>
<figure class="highlight plaintext"><figcaption><span>shading=gouraud</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">varying vec4 Color;</span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    gl_FragColor = Color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>shading=blinn-phong-inf</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const vec3 LightSourceHalfVector = vec3(0.408248, 0.408248, 0.816497);</span><br><span class="line">const vec4 LightSourcePosition = vec4(20.000000, 20.000000, 10.000000, 1.000000);</span><br><span class="line">varying vec3 Normal;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    const vec4 LightSourceAmbient = vec4(0.1, 0.1, 0.1, 1.0);</span><br><span class="line">    const vec4 LightSourceDiffuse = vec4(0.8, 0.8, 0.8, 1.0);</span><br><span class="line">    const vec4 LightSourceSpecular = vec4(0.8, 0.8, 0.8, 1.0);</span><br><span class="line">    const vec4 MaterialAmbient = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    const vec4 MaterialDiffuse = vec4(0.0, 0.0, 1.0, 1.0);</span><br><span class="line">    const vec4 MaterialSpecular = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    const float MaterialShininess = 100.0;</span><br><span class="line"></span><br><span class="line">    vec3 N = normalize(Normal);</span><br><span class="line"></span><br><span class="line">    // In the lighting model we are using here (Blinn-Phong with light at</span><br><span class="line">    // infinity, viewer at infinity), the light position/direction and the</span><br><span class="line">    // half vector is constant for the all the fragments.</span><br><span class="line">    vec3 L = normalize(LightSourcePosition.xyz);</span><br><span class="line">    vec3 H = normalize(LightSourceHalfVector);</span><br><span class="line"></span><br><span class="line">    // Calculate the diffuse color according to Lambertian reflectance</span><br><span class="line">    vec4 diffuse = MaterialDiffuse * LightSourceDiffuse * max(dot(N, L), 0.0);</span><br><span class="line"></span><br><span class="line">    // Calculate the ambient color</span><br><span class="line">    vec4 ambient = MaterialAmbient * LightSourceAmbient;</span><br><span class="line"></span><br><span class="line">    // Calculate the specular color according to the Blinn-Phong model</span><br><span class="line">    vec4 specular = MaterialSpecular * LightSourceSpecular *</span><br><span class="line">                    pow(max(dot(N,H), 0.0), MaterialShininess);</span><br><span class="line"></span><br><span class="line">    // Calculate the final color</span><br><span class="line">    gl_FragColor = vec4((ambient + specular + diffuse).xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>shading=phong</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const vec4 MaterialDiffuse = vec4(0.000000, 0.000000, 1.000000, 1.000000);</span><br><span class="line">const vec4 LightColor0 = vec4(0.800000, 0.800000, 0.800000, 1.000000);</span><br><span class="line">const vec4 LightSourcePosition0 = vec4(0.000000, 1.000000, 0.000000, 1.000000);</span><br><span class="line">varying vec3 vertex_normal;</span><br><span class="line">varying vec4 vertex_position;</span><br><span class="line"></span><br><span class="line">vec4</span><br><span class="line">compute_color(vec4 light_position, vec4 diffuse_light_color)</span><br><span class="line">&#123;</span><br><span class="line">    const vec4 lightAmbient = vec4(0.1, 0.1, 0.1, 1.0);</span><br><span class="line">    const vec4 lightSpecular = vec4(0.8, 0.8, 0.8, 1.0);</span><br><span class="line">    const vec4 matAmbient = vec4(0.2, 0.2, 0.2, 1.0);</span><br><span class="line">    const vec4 matSpecular = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    const float matShininess = 100.0;</span><br><span class="line">    vec3 eye_direction = normalize(-vertex_position.xyz);</span><br><span class="line">    vec3 light_direction = normalize(light_position.xyz/light_position.w -</span><br><span class="line">                                     vertex_position.xyz/vertex_position.w);</span><br><span class="line">    vec3 normalized_normal = normalize(vertex_normal);</span><br><span class="line">    vec3 reflection = reflect(-light_direction, normalized_normal);</span><br><span class="line">    float specularTerm = pow(max(0.0, dot(reflection, eye_direction)), matShininess);</span><br><span class="line">    float diffuseTerm = max(0.0, dot(normalized_normal, light_direction));</span><br><span class="line">    vec4 specular = (lightSpecular * matSpecular);</span><br><span class="line">    vec4 ambient = (lightAmbient * matAmbient);</span><br><span class="line">    vec4 diffuse = (diffuse_light_color * MaterialDiffuse);</span><br><span class="line">    vec4 result = (specular * specularTerm) + ambient + (diffuse * diffuseTerm);</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);</span><br><span class="line">    gl_FragColor += compute_color(LightSourcePosition0, LightColor0);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>shading=cel</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">varying vec3 vertex_normal;</span><br><span class="line">varying vec4 vertex_position;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    const vec4 OutlineColor = vec4(0.0, 0.0, 0.0, 1.0);</span><br><span class="line">    const vec2 OutlineThickness = vec2(0.1, 0.4);</span><br><span class="line">    const vec4 BaseColor = vec4(0.0, 0.3, 0.0, 1.0);</span><br><span class="line">    const vec4 LightColor = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    const vec4 LightSourcePosition = vec4(4.0, 3.0, 1.0, 1.0);</span><br><span class="line">    const vec4 DiffuseColor = vec4(0.0, 0.6, 0.0, 1.0);</span><br><span class="line">    const vec4 SpecularColor = vec4(1.0, 1.0, 1.0, 0.7);</span><br><span class="line">    const float DiffuseThreshold = 0.1;</span><br><span class="line">    const float SpecularThreshold = 0.5;</span><br><span class="line">    const float Shininess = 10.0;</span><br><span class="line"></span><br><span class="line">    // Initialize the fragment color with an unlit value.</span><br><span class="line">    vec4 fragColor = BaseColor;</span><br><span class="line"></span><br><span class="line">    // Set up factors for computing diffuse illumination</span><br><span class="line">    vec3 vertex_light = LightSourcePosition.xyz - vertex_position.xyz;</span><br><span class="line">    vec3 N = normalize(vertex_normal);</span><br><span class="line">    vec3 L = normalize(vertex_light);</span><br><span class="line">    float NdotL = dot(N, L);</span><br><span class="line">    float maxNdotL = max(NdotL, 0.0);</span><br><span class="line">    float attenuation = length(LightSourcePosition) / length(vertex_light);</span><br><span class="line"></span><br><span class="line">    // See if we have a diffuse contribution...</span><br><span class="line">    // This will only be true if the interpolated normal and the light</span><br><span class="line">    // are pointing in the &quot;same&quot; direction, and the attenuation due to</span><br><span class="line">    // distance allows enough light for diffuse reflection.</span><br><span class="line">    if (attenuation * maxNdotL &gt;= DiffuseThreshold) &#123;</span><br><span class="line">        fragColor = LightColor * DiffuseColor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // See if this fragment is part of the silhouette</span><br><span class="line">    // If it is facing away from the viewer enough not to get any</span><br><span class="line">    // diffuse illumination contribution, then it is close enough</span><br><span class="line">    // to the silouhette to be painted with the outline color rather</span><br><span class="line">    // than the unlit color.</span><br><span class="line">    vec3 V = normalize(-vertex_position.xyz);</span><br><span class="line">    if (dot(V, N) &lt;</span><br><span class="line">        mix(OutlineThickness.x, OutlineThickness.y, maxNdotL)) &#123;</span><br><span class="line">        fragColor = LightColor * OutlineColor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // See if we have a specular contribution...</span><br><span class="line">    // If the interpolated normal direction and the light direction</span><br><span class="line">    // are facing the &quot;same&quot; direction, and the attenuated specular</span><br><span class="line">    // intensity is strong enough, then we have a contribution.</span><br><span class="line">    vec3 R = reflect(-L, N);</span><br><span class="line">    float specularIntensity = pow(max(0.0, dot(R, V)), Shininess);</span><br><span class="line">    if (NdotL &gt; 0.0 &amp;&amp; attenuation * specularIntensity &gt; SpecularThreshold) &#123;</span><br><span class="line">        fragColor = SpecularColor.a * LightColor * SpecularColor +</span><br><span class="line">            (1.0 - SpecularColor.a) * fragColor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Emit the final color</span><br><span class="line">    gl_FragColor = vec4(fragColor.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="bump"><a class="markdownIt-Anchor" href="#bump"></a> bump</h3>
<figure class="highlight plaintext"><figcaption><span>bump-render=high-poly</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const vec3 LightSourceHalfVector = vec3(0.408248, 0.408248, 0.816497);</span><br><span class="line">const vec4 LightSourcePosition = vec4(20.000000, 20.000000, 10.000000, 1.000000);</span><br><span class="line">varying vec3 Normal;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    const vec4 LightSourceAmbient = vec4(0.1, 0.1, 0.1, 1.0);</span><br><span class="line">    const vec4 LightSourceDiffuse = vec4(0.8, 0.8, 0.8, 1.0);</span><br><span class="line">    const vec4 LightSourceSpecular = vec4(0.8, 0.8, 0.8, 1.0);</span><br><span class="line">    const vec4 MaterialAmbient = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    const vec4 MaterialDiffuse = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    const vec4 MaterialSpecular = vec4(0.2, 0.2, 0.2, 1.0);</span><br><span class="line">    const float MaterialShininess = 100.0;</span><br><span class="line"></span><br><span class="line">    vec3 N = normalize(Normal);</span><br><span class="line"></span><br><span class="line">    // In the lighting model we are using here (Blinn-Phong with light at</span><br><span class="line">    // infinity, viewer at infinity), the light position/direction and the</span><br><span class="line">    // half vector is constant for the all the fragments.</span><br><span class="line">    vec3 L = normalize(LightSourcePosition.xyz);</span><br><span class="line">    vec3 H = normalize(LightSourceHalfVector);</span><br><span class="line"></span><br><span class="line">    // Calculate the diffuse color according to Lambertian reflectance</span><br><span class="line">    vec4 diffuse = MaterialDiffuse * LightSourceDiffuse * max(dot(N, L), 0.0);</span><br><span class="line"></span><br><span class="line">    // Calculate the ambient color</span><br><span class="line">    vec4 ambient = MaterialAmbient * LightSourceAmbient;</span><br><span class="line"></span><br><span class="line">    // Calculate the specular color according to the Blinn-Phong model</span><br><span class="line">    vec4 specular = MaterialSpecular * LightSourceSpecular *</span><br><span class="line">                    pow(max(dot(N,H), 0.0), MaterialShininess);</span><br><span class="line"></span><br><span class="line">    // Calculate the final color</span><br><span class="line">    gl_FragColor = ambient + specular + diffuse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>bump-render=normals</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const vec3 LightSourceHalfVector = vec3(0.408248, 0.408248, 0.816497);</span><br><span class="line">const vec4 LightSourcePosition = vec4(20.000000, 20.000000, 10.000000, 1.000000);</span><br><span class="line">uniform sampler2D NormalMap;</span><br><span class="line">uniform mat4 NormalMatrix;</span><br><span class="line"></span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    const vec4 LightSourceAmbient = vec4(0.1, 0.1, 0.1, 1.0);</span><br><span class="line">    const vec4 LightSourceDiffuse = vec4(0.8, 0.8, 0.8, 1.0);</span><br><span class="line">    const vec4 LightSourceSpecular = vec4(0.8, 0.8, 0.8, 1.0);</span><br><span class="line">    const vec4 MaterialAmbient = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    const vec4 MaterialDiffuse = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    const vec4 MaterialSpecular = vec4(0.2, 0.2, 0.2, 1.0);</span><br><span class="line">    const float MaterialShininess = 100.0;</span><br><span class="line"></span><br><span class="line">    // Get the raw normal XYZ data from the normal map</span><br><span class="line">    vec3 normal_raw = texture2D(NormalMap, TextureCoord).xyz;</span><br><span class="line">    // Map &quot;color&quot; range [0, 1.0] to normal range [-1.0, 1.0]</span><br><span class="line">    vec3 normal_scaled = normal_raw * 2.0 - 1.0;</span><br><span class="line"></span><br><span class="line">    // Convert the normal to eye coordinates. Note that the normal map</span><br><span class="line">    // we are using is using object coordinates (not tangent!) for the</span><br><span class="line">    // normals, so we can multiply by the NormalMatrix as usual.</span><br><span class="line">    vec3 N = normalize(vec3(NormalMatrix * vec4(normal_scaled, 1.0)));</span><br><span class="line"></span><br><span class="line">    // In the lighting model we are using here (Blinn-Phong with light at</span><br><span class="line">    // infinity, viewer at infinity), the light position/direction and the</span><br><span class="line">    // half vector is constant for the all the fragments.</span><br><span class="line">    vec3 L = normalize(LightSourcePosition.xyz);</span><br><span class="line">    vec3 H = normalize(LightSourceHalfVector);</span><br><span class="line"></span><br><span class="line">    // Calculate the diffuse color according to Lambertian reflectance</span><br><span class="line">    vec4 diffuse = MaterialDiffuse * LightSourceDiffuse * max(dot(N, L), 0.0);</span><br><span class="line"></span><br><span class="line">    // Calculate the ambient color</span><br><span class="line">    vec4 ambient = MaterialAmbient * LightSourceAmbient;</span><br><span class="line"></span><br><span class="line">    // Calculate the specular color according to the Blinn-Phong model</span><br><span class="line">    vec4 specular = MaterialSpecular * LightSourceSpecular *</span><br><span class="line">                    pow(max(dot(N,H), 0.0), MaterialShininess);</span><br><span class="line"></span><br><span class="line">    // Calculate the final color</span><br><span class="line">    gl_FragColor = ambient + specular + diffuse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>bump-render=height</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float TextureStepY = 0.000977;</span><br><span class="line">const float TextureStepX = 0.000977;</span><br><span class="line">const vec3 LightSourceHalfVector = vec3(0.408248, 0.408248, 0.816497);</span><br><span class="line">const vec4 LightSourcePosition = vec4(20.000000, 20.000000, 10.000000, 1.000000);</span><br><span class="line"></span><br><span class="line">uniform sampler2D HeightMap;</span><br><span class="line"></span><br><span class="line">#ifdef GL_FRAGMENT_PRECISION_HIGH</span><br><span class="line">varying highp vec2 TextureCoord;</span><br><span class="line">#else</span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">varying vec3 NormalEye;</span><br><span class="line">varying vec3 TangentEye;</span><br><span class="line">varying vec3 BitangentEye;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    const vec4 LightSourceAmbient = vec4(0.1, 0.1, 0.1, 1.0);</span><br><span class="line">    const vec4 LightSourceDiffuse = vec4(0.8, 0.8, 0.8, 1.0);</span><br><span class="line">    const vec4 LightSourceSpecular = vec4(0.8, 0.8, 0.8, 1.0);</span><br><span class="line">    const vec4 MaterialAmbient = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    const vec4 MaterialDiffuse = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    const vec4 MaterialSpecular = vec4(0.2, 0.2, 0.2, 1.0);</span><br><span class="line">    const float MaterialShininess = 100.0;</span><br><span class="line">    const float height_factor = 13.0;</span><br><span class="line"></span><br><span class="line">    // Get the data from the height map</span><br><span class="line">    float height0 = texture2D(HeightMap, TextureCoord).x;</span><br><span class="line">    float heightX = texture2D(HeightMap, TextureCoord + vec2(TextureStepX, 0.0)).x;</span><br><span class="line">    float heightY = texture2D(HeightMap, TextureCoord + vec2(0.0, TextureStepY)).x;</span><br><span class="line">    vec2 dh = vec2(heightX - height0, heightY - height0);</span><br><span class="line"></span><br><span class="line">    // Adjust the normal based on the height map data</span><br><span class="line">    vec3 N = NormalEye - height_factor * dh.x * TangentEye -</span><br><span class="line">                         height_factor * dh.y * BitangentEye;</span><br><span class="line">    N = normalize(N);</span><br><span class="line"></span><br><span class="line">    // In the lighting model we are using here (Blinn-Phong with light at</span><br><span class="line">    // infinity, viewer at infinity), the light position/direction and the</span><br><span class="line">    // half vector is constant for the all the fragments.</span><br><span class="line">    vec3 L = normalize(LightSourcePosition.xyz);</span><br><span class="line">    vec3 H = normalize(LightSourceHalfVector);</span><br><span class="line"></span><br><span class="line">    // Calculate the diffuse color according to Lambertian reflectance</span><br><span class="line">    vec4 diffuse = MaterialDiffuse * LightSourceDiffuse * max(dot(N, L), 0.0);</span><br><span class="line"></span><br><span class="line">    // Calculate the ambient color</span><br><span class="line">    vec4 ambient = MaterialAmbient * LightSourceAmbient;</span><br><span class="line"></span><br><span class="line">    // Calculate the specular color according to the Blinn-Phong model</span><br><span class="line">    vec4 specular = MaterialSpecular * LightSourceSpecular *</span><br><span class="line">                    pow(max(dot(N,H), 0.0), MaterialShininess);</span><br><span class="line"></span><br><span class="line">    // Calculate the final color</span><br><span class="line">    gl_FragColor = ambient + specular + diffuse;</span><br><span class="line"></span><br><span class="line">    //gl_FragColor = vec4(height_diff_raw.xy, 0.0, 1.0);</span><br><span class="line">    //gl_FragColor = vec4(height_diff_scaled.xy, 0.0, 1.0);</span><br><span class="line">    //gl_FragColor = vec4(Tangent, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="effect2d"><a class="markdownIt-Anchor" href="#effect2d"></a> effect2d</h3>
<figure class="highlight plaintext"><figcaption><span>kernel=0,1,0;1,-4,1;0,1,0;</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float Kernel0 = 0.000000;</span><br><span class="line">const float Kernel1 = 0.250000;</span><br><span class="line">const float Kernel2 = 0.000000;</span><br><span class="line">const float Kernel3 = 0.250000;</span><br><span class="line">const float Kernel4 = -1.000000;</span><br><span class="line">const float Kernel5 = 0.250000;</span><br><span class="line">const float Kernel6 = 0.000000;</span><br><span class="line">const float Kernel7 = 0.250000;</span><br><span class="line">const float Kernel8 = 0.000000;</span><br><span class="line">const float TextureStepY = 0.001667;</span><br><span class="line">const float TextureStepX = 0.001250;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line"></span><br><span class="line">    result = texture2D(Texture0, TextureCoord + vec2(-1.0 * TextureStepX, 1.0 * TextureStepY)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0 * TextureStepX, 1.0 * TextureStepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(1.0 * TextureStepX, 1.0 * TextureStepY)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-1.0 * TextureStepX, 0.0 * TextureStepY)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0 * TextureStepX, 0.0 * TextureStepY)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(1.0 * TextureStepX, 0.0 * TextureStepY)) * Kernel5 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-1.0 * TextureStepX, -1.0 * TextureStepY)) * Kernel6 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0 * TextureStepX, -1.0 * TextureStepY)) * Kernel7 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(1.0 * TextureStepX, -1.0 * TextureStepY)) * Kernel8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>kernel=1,1,1,1,1;1,1,1,1,1;1,1,1,1,1;</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float Kernel0 = 0.066667;</span><br><span class="line">const float Kernel1 = 0.066667;</span><br><span class="line">const float Kernel2 = 0.066667;</span><br><span class="line">const float Kernel3 = 0.066667;</span><br><span class="line">const float Kernel4 = 0.066667;</span><br><span class="line">const float Kernel5 = 0.066667;</span><br><span class="line">const float Kernel6 = 0.066667;</span><br><span class="line">const float Kernel7 = 0.066667;</span><br><span class="line">const float Kernel8 = 0.066667;</span><br><span class="line">const float Kernel9 = 0.066667;</span><br><span class="line">const float Kernel10 = 0.066667;</span><br><span class="line">const float Kernel11 = 0.066667;</span><br><span class="line">const float Kernel12 = 0.066667;</span><br><span class="line">const float Kernel13 = 0.066667;</span><br><span class="line">const float Kernel14 = 0.066667;</span><br><span class="line">const float TextureStepY = 0.001667;</span><br><span class="line">const float TextureStepX = 0.001250;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line"></span><br><span class="line">    result = texture2D(Texture0, TextureCoord + vec2(-2.0 * TextureStepX, 1.0 * TextureStepY)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-1.0 * TextureStepX, 1.0 * TextureStepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0 * TextureStepX, 1.0 * TextureStepY)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(1.0 * TextureStepX, 1.0 * TextureStepY)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(2.0 * TextureStepX, 1.0 * TextureStepY)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-2.0 * TextureStepX, 0.0 * TextureStepY)) * Kernel5 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-1.0 * TextureStepX, 0.0 * TextureStepY)) * Kernel6 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0 * TextureStepX, 0.0 * TextureStepY)) * Kernel7 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(1.0 * TextureStepX, 0.0 * TextureStepY)) * Kernel8 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(2.0 * TextureStepX, 0.0 * TextureStepY)) * Kernel9 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-2.0 * TextureStepX, -1.0 * TextureStepY)) * Kernel10 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-1.0 * TextureStepX, -1.0 * TextureStepY)) * Kernel11 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0 * TextureStepX, -1.0 * TextureStepY)) * Kernel12 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(1.0 * TextureStepX, -1.0 * TextureStepY)) * Kernel13 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(2.0 * TextureStepX, -1.0 * TextureStepY)) * Kernel14;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="pulsar"><a class="markdownIt-Anchor" href="#pulsar"></a> pulsar</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">varying vec4 Color;</span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    gl_FragColor = Color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="desktop-2"><a class="markdownIt-Anchor" href="#desktop-2"></a> desktop</h3>
<figure class="highlight plaintext"><figcaption><span>blur-radius=5:effect=blur:passes=1:separable=true:windows=4</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float TextureStepX = 0.001250;</span><br><span class="line">const float Kernel5 = 0.002659;</span><br><span class="line">const float Kernel4 = 0.013437;</span><br><span class="line">const float Kernel3 = 0.047370;</span><br><span class="line">const float Kernel2 = 0.116512;</span><br><span class="line">const float Kernel1 = 0.199935;</span><br><span class="line">const float Kernel0 = 0.239365;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line"></span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line"></span><br><span class="line">    result = </span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-5.0 * TextureStepX, 0.0)) * Kernel5 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-4.0 * TextureStepX, 0.0)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-3.0 * TextureStepX, 0.0)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-2.0 * TextureStepX, 0.0)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-1.0 * TextureStepX, 0.0)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0 * TextureStepX, 0.0)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(1.0 * TextureStepX, 0.0)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(2.0 * TextureStepX, 0.0)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(3.0 * TextureStepX, 0.0)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(4.0 * TextureStepX, 0.0)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(5.0 * TextureStepX, 0.0)) * Kernel5 +</span><br><span class="line">0.0 ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>blur-radius=5:effect=blur:passes=1:separable=true:windows=4</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float TextureStepY = 0.001667;</span><br><span class="line">const float Kernel5 = 0.002659;</span><br><span class="line">const float Kernel4 = 0.013437;</span><br><span class="line">const float Kernel3 = 0.047370;</span><br><span class="line">const float Kernel2 = 0.116512;</span><br><span class="line">const float Kernel1 = 0.199935;</span><br><span class="line">const float Kernel0 = 0.239365;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line"></span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line"></span><br><span class="line">    result = </span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -5.0 * TextureStepY)) * Kernel5 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -4.0 * TextureStepY)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -3.0 * TextureStepY)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -2.0 * TextureStepY)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -1.0 * TextureStepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 0.0 * TextureStepY)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 1.0 * TextureStepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 2.0 * TextureStepY)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 3.0 * TextureStepY)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 4.0 * TextureStepY)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 5.0 * TextureStepY)) * Kernel5 +</span><br><span class="line">0.0 ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>blur-radius=5:effect=blur:passes=1:separable=true:windows=4</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float TextureStepX = 0.001250;</span><br><span class="line">const float Kernel5 = 0.002659;</span><br><span class="line">const float Kernel4 = 0.013437;</span><br><span class="line">const float Kernel3 = 0.047370;</span><br><span class="line">const float Kernel2 = 0.116512;</span><br><span class="line">const float Kernel1 = 0.199935;</span><br><span class="line">const float Kernel0 = 0.239365;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line"></span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line"></span><br><span class="line">    result = </span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-5.0 * TextureStepX, 0.0)) * Kernel5 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-4.0 * TextureStepX, 0.0)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-3.0 * TextureStepX, 0.0)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-2.0 * TextureStepX, 0.0)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-1.0 * TextureStepX, 0.0)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0 * TextureStepX, 0.0)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(1.0 * TextureStepX, 0.0)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(2.0 * TextureStepX, 0.0)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(3.0 * TextureStepX, 0.0)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(4.0 * TextureStepX, 0.0)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(5.0 * TextureStepX, 0.0)) * Kernel5 +</span><br><span class="line">0.0 ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>blur-radius=5:effect=blur:passes=1:separable=true:windows=4</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float TextureStepY = 0.001667;</span><br><span class="line">const float Kernel5 = 0.002659;</span><br><span class="line">const float Kernel4 = 0.013437;</span><br><span class="line">const float Kernel3 = 0.047370;</span><br><span class="line">const float Kernel2 = 0.116512;</span><br><span class="line">const float Kernel1 = 0.199935;</span><br><span class="line">const float Kernel0 = 0.239365;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line"></span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line"></span><br><span class="line">    result = </span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -5.0 * TextureStepY)) * Kernel5 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -4.0 * TextureStepY)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -3.0 * TextureStepY)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -2.0 * TextureStepY)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -1.0 * TextureStepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 0.0 * TextureStepY)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 1.0 * TextureStepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 2.0 * TextureStepY)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 3.0 * TextureStepY)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 4.0 * TextureStepY)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 5.0 * TextureStepY)) * Kernel5 +</span><br><span class="line">0.0 ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>blur-radius=5:effect=blur:passes=1:separable=true:windows=4</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float TextureStepX = 0.001250;</span><br><span class="line">const float Kernel5 = 0.002659;</span><br><span class="line">const float Kernel4 = 0.013437;</span><br><span class="line">const float Kernel3 = 0.047370;</span><br><span class="line">const float Kernel2 = 0.116512;</span><br><span class="line">const float Kernel1 = 0.199935;</span><br><span class="line">const float Kernel0 = 0.239365;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line"></span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line"></span><br><span class="line">    result = </span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-5.0 * TextureStepX, 0.0)) * Kernel5 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-4.0 * TextureStepX, 0.0)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-3.0 * TextureStepX, 0.0)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-2.0 * TextureStepX, 0.0)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-1.0 * TextureStepX, 0.0)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0 * TextureStepX, 0.0)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(1.0 * TextureStepX, 0.0)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(2.0 * TextureStepX, 0.0)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(3.0 * TextureStepX, 0.0)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(4.0 * TextureStepX, 0.0)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(5.0 * TextureStepX, 0.0)) * Kernel5 +</span><br><span class="line">0.0 ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>blur-radius=5:effect=blur:passes=1:separable=true:windows=4</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float TextureStepY = 0.001667;</span><br><span class="line">const float Kernel5 = 0.002659;</span><br><span class="line">const float Kernel4 = 0.013437;</span><br><span class="line">const float Kernel3 = 0.047370;</span><br><span class="line">const float Kernel2 = 0.116512;</span><br><span class="line">const float Kernel1 = 0.199935;</span><br><span class="line">const float Kernel0 = 0.239365;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line"></span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line"></span><br><span class="line">    result = </span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -5.0 * TextureStepY)) * Kernel5 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -4.0 * TextureStepY)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -3.0 * TextureStepY)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -2.0 * TextureStepY)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -1.0 * TextureStepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 0.0 * TextureStepY)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 1.0 * TextureStepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 2.0 * TextureStepY)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 3.0 * TextureStepY)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 4.0 * TextureStepY)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 5.0 * TextureStepY)) * Kernel5 +</span><br><span class="line">0.0 ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>blur-radius=5:effect=blur:passes=1:separable=true:windows=4</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float TextureStepX = 0.001250;</span><br><span class="line">const float Kernel5 = 0.002659;</span><br><span class="line">const float Kernel4 = 0.013437;</span><br><span class="line">const float Kernel3 = 0.047370;</span><br><span class="line">const float Kernel2 = 0.116512;</span><br><span class="line">const float Kernel1 = 0.199935;</span><br><span class="line">const float Kernel0 = 0.239365;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line"></span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line"></span><br><span class="line">    result = </span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-5.0 * TextureStepX, 0.0)) * Kernel5 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-4.0 * TextureStepX, 0.0)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-3.0 * TextureStepX, 0.0)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-2.0 * TextureStepX, 0.0)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-1.0 * TextureStepX, 0.0)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0 * TextureStepX, 0.0)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(1.0 * TextureStepX, 0.0)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(2.0 * TextureStepX, 0.0)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(3.0 * TextureStepX, 0.0)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(4.0 * TextureStepX, 0.0)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(5.0 * TextureStepX, 0.0)) * Kernel5 +</span><br><span class="line">0.0 ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>blur-radius=5:effect=blur:passes=1:separable=true:windows=4</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float TextureStepY = 0.001667;</span><br><span class="line">const float Kernel5 = 0.002659;</span><br><span class="line">const float Kernel4 = 0.013437;</span><br><span class="line">const float Kernel3 = 0.047370;</span><br><span class="line">const float Kernel2 = 0.116512;</span><br><span class="line">const float Kernel1 = 0.199935;</span><br><span class="line">const float Kernel0 = 0.239365;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line"></span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line"></span><br><span class="line">    result = </span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -5.0 * TextureStepY)) * Kernel5 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -4.0 * TextureStepY)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -3.0 * TextureStepY)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -2.0 * TextureStepY)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -1.0 * TextureStepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 0.0 * TextureStepY)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 1.0 * TextureStepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 2.0 * TextureStepY)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 3.0 * TextureStepY)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 4.0 * TextureStepY)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 5.0 * TextureStepY)) * Kernel5 +</span><br><span class="line">0.0 ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><figcaption><span>effect=shadow:windows=4</span></figcaption><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">uniform sampler2D MaterialTexture0;</span><br><span class="line"></span><br><span class="line">varying vec2 TextureCoord;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 texel = texture2D(MaterialTexture0, TextureCoord);</span><br><span class="line">    gl_FragColor = texel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="buffer"><a class="markdownIt-Anchor" href="#buffer"></a> buffer</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">varying vec4 dist;</span><br><span class="line"></span><br><span class="line">const vec4 LINE_COLOR = vec4(1.0);</span><br><span class="line">const vec4 TRIANGLE_COLOR = vec4(0.0, 0.5, 0.8, 0.8);</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    // Get the minimum distance of this fragment from a triangle edge.</span><br><span class="line">    // We need to multiply with dist.w to undo the workaround we had</span><br><span class="line">    // to perform to get linear interpolation (instead of perspective correct).</span><br><span class="line">    float d = min(dist.x * dist.w, min(dist.y * dist.w, dist.z * dist.w));</span><br><span class="line"></span><br><span class="line">    // Get the intensity of the wireframe line</span><br><span class="line">    float I = exp2(-2.0 * d * d);</span><br><span class="line"></span><br><span class="line">    gl_FragColor = mix(TRIANGLE_COLOR, LINE_COLOR, I);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ideas"><a class="markdownIt-Anchor" href="#ideas"></a> ideas</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">varying vec4 color;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">    gl_FragColor = color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">uniform vec4 light0Position;</span><br><span class="line">varying vec3 vertex_normal;</span><br><span class="line">varying vec4 vertex_position;</span><br><span class="line">varying vec3 eye_direction;</span><br><span class="line"></span><br><span class="line">vec3 unitvec(vec4 v1, vec4 v2)</span><br><span class="line">&#123;</span><br><span class="line">    if (v1.w == 0.0 &amp;&amp; v2.w == 0.0)</span><br><span class="line">        return vec3(v2 - v1);</span><br><span class="line">    if (v1.w == 0.0)</span><br><span class="line">        return vec3(-v1);</span><br><span class="line">    if (v2.w == 0.0)</span><br><span class="line">        return vec3(v2);</span><br><span class="line">    return v2.xyz/v2.w - v1.xyz/v1.w;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">    vec4 lightAmbient = vec4(0.0, 0.0, 0.0, 1.0);</span><br><span class="line">    vec4 lightDiffuse = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    vec4 lightSpecular = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    vec4 matAmbient = vec4(0.1, 0.1, 0.1, 1.0);</span><br><span class="line">    vec4 matDiffuse = vec4(0.5, 0.4, 0.7, 1.0);</span><br><span class="line">    vec4 matSpecular = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    float matShininess = 30.0;</span><br><span class="line">    vec3 light_direction = normalize(unitvec(vertex_position, light0Position));</span><br><span class="line">    vec3 normalized_normal = normalize(vertex_normal);</span><br><span class="line">    vec3 reflection = reflect(-light_direction, normalized_normal);</span><br><span class="line">    float specularTerm = pow(max(0.0, dot(reflection, eye_direction)), matShininess);</span><br><span class="line">    float diffuseTerm = max(0.0, dot(normalized_normal, light_direction));</span><br><span class="line">    vec4 specular = (lightSpecular * matSpecular);</span><br><span class="line">    vec4 ambient = (lightAmbient * matAmbient);</span><br><span class="line">    vec4 diffuse = (lightDiffuse * matDiffuse);</span><br><span class="line">    gl_FragColor = (specular * specularTerm) + ambient + (diffuse * diffuseTerm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">uniform sampler2D tex;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">    vec2 curPos = gl_FragCoord.xy / 32.0;</span><br><span class="line">    vec4 color = texture2D(tex, curPos);</span><br><span class="line">    if (color.w &lt; 0.5)</span><br><span class="line">        discard;</span><br><span class="line">    gl_FragColor = color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">struct LightSourceParameters</span><br><span class="line">&#123;</span><br><span class="line">    vec4 ambient;</span><br><span class="line">    vec4 diffuse;</span><br><span class="line">    vec4 specular;</span><br><span class="line">    vec4 position;</span><br><span class="line">&#125;;</span><br><span class="line">LightSourceParameters lightSource[3];</span><br><span class="line">uniform vec4 light0Position;</span><br><span class="line">uniform vec4 light1Position;</span><br><span class="line">uniform vec4 light2Position;</span><br><span class="line">varying vec3 vertex_normal;</span><br><span class="line">varying vec4 vertex_position;</span><br><span class="line">varying vec3 eye_direction;</span><br><span class="line"></span><br><span class="line">vec3 unitvec(vec4 v1, vec4 v2)</span><br><span class="line">&#123;</span><br><span class="line">    if (v1.w == 0.0 &amp;&amp; v2.w == 0.0)</span><br><span class="line">        return vec3(v2 - v1);</span><br><span class="line">    if (v1.w == 0.0)</span><br><span class="line">        return vec3(-v1);</span><br><span class="line">    if (v2.w == 0.0)</span><br><span class="line">        return vec3(v2);</span><br><span class="line">    return v2.xyz/v2.w - v1.xyz/v1.w;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">    lightSource[0] = LightSourceParameters(</span><br><span class="line">        vec4(0.0, 0.0, 0.0, 1.0),</span><br><span class="line">        vec4(1.0, 1.0, 1.0, 1.0),</span><br><span class="line">        vec4(1.0, 1.0, 1.0, 1.0),</span><br><span class="line">        vec4(0.0, 1.0, 0.0, 0.0)</span><br><span class="line">    );</span><br><span class="line">    lightSource[1] = LightSourceParameters(</span><br><span class="line">        vec4(0.0, 0.0, 0.0, 1.0),</span><br><span class="line">        vec4(0.3, 0.3, 0.5, 1.0),</span><br><span class="line">        vec4(0.3, 0.3, 0.5, 1.0),</span><br><span class="line">        vec4(-1.0, 0.0, 0.0, 0.0)</span><br><span class="line">    );</span><br><span class="line">    lightSource[2] = LightSourceParameters(</span><br><span class="line">        vec4(0.2, 0.2, 0.2, 1.0),</span><br><span class="line">        vec4(0.2, 0.2, 0.2, 1.0),</span><br><span class="line">        vec4(0.2, 0.2, 0.2, 1.0),</span><br><span class="line">        vec4(0.0, -1.0, 0.0, 0.0)</span><br><span class="line">    );</span><br><span class="line">    vec4 matAmbient = vec4(0.0, 0.0, 0.0, 1.0);</span><br><span class="line">    vec4 matDiffuse = vec4(1.0, 0.2, 0.2, 1.0);</span><br><span class="line">    vec4 matSpecular = vec4(0.5, 0.5, 0.5, 1.0);</span><br><span class="line">    float matShininess = 20.0;</span><br><span class="line">    vec4 diffuseSum = vec4(0.0, 0.0, 0.0, 0.0);</span><br><span class="line">    vec4 specularSum = vec4(0.0, 0.0, 0.0, 0.0);</span><br><span class="line">    vec4 ambientSum = vec4(0.0, 0.0, 0.0, 0.0);</span><br><span class="line">    vec3 normalized_normal = normalize(vertex_normal);</span><br><span class="line">    lightSource[0].position = light0Position;</span><br><span class="line">    lightSource[1].position = light1Position;</span><br><span class="line">    lightSource[2].position = light2Position;</span><br><span class="line">    for (int light = 0; light &lt; 3; light++) &#123;</span><br><span class="line">        vec4 light_position = lightSource[light].position;</span><br><span class="line">        vec3 light_direction = normalize(unitvec(vertex_position, light_position));</span><br><span class="line">        vec3 reflection = reflect(-light_direction, normalized_normal);</span><br><span class="line">        specularSum += pow(max(0.0, dot(reflection, eye_direction)), matShininess) * lightSource[light].specular;</span><br><span class="line">        diffuseSum += max(0.0, dot(normalized_normal, light_direction)) * lightSource[light].diffuse;</span><br><span class="line">        ambientSum += lightSource[light].ambient;</span><br><span class="line">    &#125;</span><br><span class="line">    gl_FragColor = (matSpecular * specularSum) + (matAmbient * ambientSum) + (matDiffuse * diffuseSum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="terrain"><a class="markdownIt-Anchor" href="#terrain"></a> terrain</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">//</span><br><span class="line">// Description : Array and textureless GLSL 3D simplex noise function.</span><br><span class="line">//      Author : Ian McEwan, Ashima Arts.</span><br><span class="line">//  Maintainer : ijm</span><br><span class="line">//     Lastmod : 20110409 (stegu)</span><br><span class="line">//     License : Copyright (C) 2011 Ashima Arts. All rights reserved.</span><br><span class="line">//               Distributed under the MIT License. See LICENSE file.</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">#ifdef GL_ES</span><br><span class="line">#define MEDIUMP mediump</span><br><span class="line">#else</span><br><span class="line">#define MEDIUMP</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">uniform float time;</span><br><span class="line">uniform MEDIUMP vec2 uvScale;</span><br><span class="line">varying vec2 vUv;</span><br><span class="line"></span><br><span class="line">#ifdef GL_FRAGMENT_PRECISION_HIGH</span><br><span class="line">// x should be passed as highp since the intermediate multiplications can</span><br><span class="line">// overflow with mediump</span><br><span class="line">vec4 permute(highp vec4 x)</span><br><span class="line">#else</span><br><span class="line">vec4 permute(vec4 x)</span><br><span class="line">#endif</span><br><span class="line">&#123;</span><br><span class="line">    return mod(((x * 34.0) + 1.0) * x, 289.0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vec4 taylorInvSqrt(vec4 r)</span><br><span class="line">&#123;</span><br><span class="line">    return 1.79284291400159 - 0.85373472095314 * r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float snoise(vec3 v)</span><br><span class="line">&#123;</span><br><span class="line">    const vec2 C = vec2(1.0 / 6.0, 1.0 / 3.0);</span><br><span class="line">    const vec4 D = vec4(0.0, 0.5, 1.0, 2.0);</span><br><span class="line"></span><br><span class="line">    // First corner</span><br><span class="line">    vec3 i  = floor(v + dot(v, C.yyy));</span><br><span class="line">    vec3 x0 = v - i + dot(i, C.xxx);</span><br><span class="line"></span><br><span class="line">    // Other corners</span><br><span class="line">    vec3 g = step(x0.yzx, x0.xyz);</span><br><span class="line">    vec3 l = 1.0 - g;</span><br><span class="line">    vec3 i1 = min(g.xyz, l.zxy);</span><br><span class="line">    vec3 i2 = max(g.xyz, l.zxy);</span><br><span class="line"></span><br><span class="line">    vec3 x1 = x0 - i1 + 1.0 * C.xxx;</span><br><span class="line">    vec3 x2 = x0 - i2 + 2.0 * C.xxx;</span><br><span class="line">    vec3 x3 = x0 - 1. + 3.0 * C.xxx;</span><br><span class="line"></span><br><span class="line">    // Permutations</span><br><span class="line">    i = mod(i, 289.0);</span><br><span class="line">    vec4 p = permute(permute(permute(</span><br><span class="line">                    i.z + vec4(0.0, i1.z, i2.z, 1.0))</span><br><span class="line">                + i.y + vec4(0.0, i1.y, i2.y, 1.0))</span><br><span class="line">            + i.x + vec4(0.0, i1.x, i2.x, 1.0));</span><br><span class="line"></span><br><span class="line">    // Gradients</span><br><span class="line">    // (N*N points uniformly over a square, mapped onto an octahedron.)</span><br><span class="line"></span><br><span class="line">    float n_ = 1.0 / 7.0; // N=7</span><br><span class="line"></span><br><span class="line">    vec3 ns = n_ * D.wyz - D.xzx;</span><br><span class="line"></span><br><span class="line">    vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)</span><br><span class="line"></span><br><span class="line">    vec4 x_ = floor(j * ns.z);</span><br><span class="line">    vec4 y_ = floor(j - 7.0 * x_);    // mod(j,N)</span><br><span class="line"></span><br><span class="line">    vec4 x = x_ *ns.x + ns.yyyy;</span><br><span class="line">    vec4 y = y_ *ns.x + ns.yyyy;</span><br><span class="line">    vec4 h = 1.0 - abs(x) - abs(y);</span><br><span class="line"></span><br><span class="line">    vec4 b0 = vec4(x.xy, y.xy);</span><br><span class="line">    vec4 b1 = vec4(x.zw, y.zw);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    vec4 s0 = floor(b0) * 2.0 + 1.0;</span><br><span class="line">    vec4 s1 = floor(b1) * 2.0 + 1.0;</span><br><span class="line">    vec4 sh = -step(h, vec4(0.0));</span><br><span class="line"></span><br><span class="line">    vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy;</span><br><span class="line">    vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww;</span><br><span class="line"></span><br><span class="line">    vec3 p0 = vec3(a0.xy, h.x);</span><br><span class="line">    vec3 p1 = vec3(a0.zw, h.y);</span><br><span class="line">    vec3 p2 = vec3(a1.xy, h.z);</span><br><span class="line">    vec3 p3 = vec3(a1.zw, h.w);</span><br><span class="line"></span><br><span class="line">    // Normalise gradients</span><br><span class="line"></span><br><span class="line">    vec4 norm = taylorInvSqrt(vec4(dot(p0, p0), dot(p1, p1), dot(p2, p2), dot(p3, p3)));</span><br><span class="line">    p0 *= norm.x;</span><br><span class="line">    p1 *= norm.y;</span><br><span class="line">    p2 *= norm.z;</span><br><span class="line">    p3 *= norm.w;</span><br><span class="line"></span><br><span class="line">    // Mix final noise value</span><br><span class="line"></span><br><span class="line">    vec4 m = max(0.6 - vec4(dot(x0, x0), dot(x1, x1), dot(x2, x2), dot(x3, x3)), 0.0);</span><br><span class="line">    m = m * m;</span><br><span class="line">    return 42.0 * dot(m*m, vec4(dot(p0, x0), dot(p1, x1),</span><br><span class="line">                dot(p2, x2), dot(p3, x3)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float surface3(vec3 coord)</span><br><span class="line">&#123;</span><br><span class="line">    float n = 0.0;</span><br><span class="line"></span><br><span class="line">    n += 1.0 * abs(snoise(coord));</span><br><span class="line">    n += 0.5 * abs(snoise(coord * 2.0));</span><br><span class="line">    n += 0.25 * abs(snoise(coord * 4.0));</span><br><span class="line">    n += 0.125 * abs(snoise(coord * 8.0));</span><br><span class="line"></span><br><span class="line">    return n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec3 coord = vec3(vUv.x, uvScale.y - vUv.y, -time);</span><br><span class="line">    float n = surface3(coord);</span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(vec3(n, n, n), 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">uniform float height;</span><br><span class="line">uniform vec2 resolution;</span><br><span class="line">uniform sampler2D heightMap;</span><br><span class="line"></span><br><span class="line">varying vec2 vUv;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">    float val = texture2D( heightMap, vUv ).x;</span><br><span class="line"></span><br><span class="line">    float valU = texture2D( heightMap, vUv + vec2( 1.0 / resolution.x, 0.0 ) ).x;</span><br><span class="line">    float valV = texture2D( heightMap, vUv + vec2( 0.0, 1.0 / resolution.y ) ).x;</span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4( ( 0.5 * normalize( vec3( val - valU, val - valV, height  ) ) + 0.5 ), 1.0 );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">uniform sampler2D tDiffuse;</span><br><span class="line"></span><br><span class="line">varying vec2 vUv;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">    vec4 texel = texture2D( tDiffuse, vUv );</span><br><span class="line"></span><br><span class="line">    vec3 luma = vec3( 0.299, 0.587, 0.114 );</span><br><span class="line"></span><br><span class="line">    float v = dot( texel.xyz, luma );</span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4( v, v, v, texel.w );</span><br><span class="line">&#125;</span><br><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">uniform vec3 uAmbientColor;</span><br><span class="line">uniform vec3 uDiffuseColor;</span><br><span class="line">uniform vec3 uSpecularColor;</span><br><span class="line">uniform float uShininess;</span><br><span class="line">uniform float uOpacity;</span><br><span class="line">uniform sampler2D tDiffuse1;</span><br><span class="line">uniform sampler2D tDiffuse2;</span><br><span class="line">uniform sampler2D tDetail;</span><br><span class="line">uniform sampler2D tNormal;</span><br><span class="line">uniform sampler2D tSpecular;</span><br><span class="line">uniform sampler2D tDisplacement;</span><br><span class="line">uniform float uNormalScale;</span><br><span class="line">uniform vec2 uRepeatOverlay;</span><br><span class="line">uniform vec2 uOffset;</span><br><span class="line">varying vec3 vTangent;</span><br><span class="line">varying vec3 vBinormal;</span><br><span class="line">varying vec3 vNormal;</span><br><span class="line">varying vec2 vUv;</span><br><span class="line">uniform vec3 ambientLightColor;</span><br><span class="line">uniform mat4 viewMatrix;</span><br><span class="line"></span><br><span class="line">#define MAX_POINT_LIGHTS 1</span><br><span class="line">//#define USE_FOG</span><br><span class="line">//#define FOG_EXP2</span><br><span class="line"></span><br><span class="line">#if MAX_POINT_LIGHTS &gt; 0</span><br><span class="line">uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];</span><br><span class="line">uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];</span><br><span class="line">uniform float pointLightDistance[ MAX_POINT_LIGHTS ];</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">varying vec3 vViewPosition;</span><br><span class="line"></span><br><span class="line">// CHUNK: fog_pars_fragment</span><br><span class="line">#ifdef USE_FOG</span><br><span class="line">uniform vec3 fogColor;</span><br><span class="line">#ifdef FOG_EXP2</span><br><span class="line">uniform float fogDensity;</span><br><span class="line">#else</span><br><span class="line">uniform float fogNear;</span><br><span class="line">uniform float fogFar;</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">void main() &#123;</span><br><span class="line">    gl_FragColor = vec4( vec3( 1.0 ), uOpacity );</span><br><span class="line">    vec3 specularTex = vec3( 1.0 );</span><br><span class="line">    vec2 uvOverlay = uRepeatOverlay * vUv + uOffset;</span><br><span class="line">    vec3 normalTex = texture2D( tDetail, uvOverlay ).xyz * 2.0 - 1.0;</span><br><span class="line">    normalTex.xy *= uNormalScale;</span><br><span class="line">    normalTex = normalize( normalTex );</span><br><span class="line"></span><br><span class="line">    vec4 colDiffuse1 = texture2D( tDiffuse1, uvOverlay );</span><br><span class="line">    vec4 colDiffuse2 = texture2D( tDiffuse2, uvOverlay );</span><br><span class="line">    gl_FragColor = gl_FragColor * mix ( colDiffuse1, colDiffuse2, 1.0 - texture2D( tDisplacement, vUv) );</span><br><span class="line"></span><br><span class="line">    specularTex = texture2D( tSpecular, uvOverlay ).xyz;</span><br><span class="line"></span><br><span class="line">    mat3 tbn= mat3( vTangent, vBinormal, vNormal );</span><br><span class="line">    vec3 finalNormal = tbn * normalTex;</span><br><span class="line">    vec3 normal = normalize( finalNormal );</span><br><span class="line">    vec3 viewPosition = normalize( vViewPosition );</span><br><span class="line"></span><br><span class="line">    // point lights</span><br><span class="line">#if MAX_POINT_LIGHTS &gt; 0</span><br><span class="line">    vec3 pointDiffuse = vec3( 0.0 );</span><br><span class="line">    vec3 pointSpecular = vec3( 0.0 );</span><br><span class="line">    for ( int i = 0; i &lt; MAX_POINT_LIGHTS; i ++ ) &#123;</span><br><span class="line">        vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );</span><br><span class="line">#ifdef GL_FRAGMENT_PRECISION_HIGH</span><br><span class="line">        // should be highp for correct behaviour if mediump is implemented as fp16</span><br><span class="line">        highp vec3 lVector = lPosition.xyz + vViewPosition.xyz;</span><br><span class="line">#else</span><br><span class="line">        vec3 lVector = lPosition.xyz + vViewPosition.xyz;</span><br><span class="line">#endif</span><br><span class="line">        float lDistance = 1.0;</span><br><span class="line">        if ( pointLightDistance[ i ] &gt; 0.0 )</span><br><span class="line">            lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );</span><br><span class="line">        lVector = normalize( lVector );</span><br><span class="line">        vec3 pointHalfVector = normalize( lVector + viewPosition );</span><br><span class="line">        float pointDistance = lDistance;</span><br><span class="line">        float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );</span><br><span class="line">        float pointDiffuseWeight = max( dot( normal, lVector ), 0.0 );</span><br><span class="line">        float pointSpecularWeight = specularTex.r * pow( pointDotNormalHalf, uShininess );</span><br><span class="line">        pointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight;</span><br><span class="line">        pointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    // all lights contribution summation</span><br><span class="line">    vec3 totalDiffuse = vec3( 0.0 );</span><br><span class="line">    vec3 totalSpecular = vec3( 0.0 );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#if MAX_POINT_LIGHTS &gt; 0</span><br><span class="line">    totalDiffuse += pointDiffuse;</span><br><span class="line">    totalSpecular += pointSpecular;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor + totalSpecular );</span><br><span class="line"></span><br><span class="line">    //CHUNK: fog_fragment</span><br><span class="line">#ifdef USE_FOG</span><br><span class="line">    float depth = gl_FragCoord.z / gl_FragCoord.w;</span><br><span class="line">#ifdef FOG_EXP2</span><br><span class="line">    const float LOG2 = 1.442695;</span><br><span class="line">    float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );</span><br><span class="line">    fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );</span><br><span class="line">#else</span><br><span class="line">    float fogFactor = smoothstep( fogNear, fogFar, depth );</span><br><span class="line">#endif</span><br><span class="line">    gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float TextureStepX = 0.001250;</span><br><span class="line">const float TiltShift = 0.000000;</span><br><span class="line">const float Kernel2 = 0.187627;</span><br><span class="line">const float Kernel1 = 0.206068;</span><br><span class="line">const float Kernel0 = 0.212609;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line"></span><br><span class="line">varying vec2 vUv;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line">    vec2 TextureCoord = vUv;</span><br><span class="line"></span><br><span class="line">    float stepX = TextureStepX * abs(TiltShift - TextureCoord.y) / abs(1.0 - TiltShift);</span><br><span class="line">result = </span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-2.0 * stepX, 0.0)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-1.0 * stepX, 0.0)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0 * stepX, 0.0)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(1.0 * stepX, 0.0)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(2.0 * stepX, 0.0)) * Kernel2 +</span><br><span class="line">0.0 ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float TextureStepY = 0.003906;</span><br><span class="line">const float TiltShift = 0.000000;</span><br><span class="line">const float Kernel2 = 0.187627;</span><br><span class="line">const float Kernel1 = 0.206068;</span><br><span class="line">const float Kernel0 = 0.212609;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line"></span><br><span class="line">varying vec2 vUv;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line">    vec2 TextureCoord = vUv;</span><br><span class="line"></span><br><span class="line">    float stepY = TextureStepY * abs(TiltShift - TextureCoord.y) / abs(1.0 - TiltShift);</span><br><span class="line">result = </span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -2.0 * stepY)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -1.0 * stepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 0.0 * stepY)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 1.0 * stepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 2.0 * stepY)) * Kernel2 +</span><br><span class="line">0.0 ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">uniform float opacity;</span><br><span class="line">uniform sampler2D tDiffuse;</span><br><span class="line"></span><br><span class="line">varying vec2 vUv;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">    vec4 texel = texture2D(tDiffuse, vUv);</span><br><span class="line">    gl_FragColor = opacity * texel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float TextureStepX = 0.001250;</span><br><span class="line">const float TiltShift = 0.500000;</span><br><span class="line">const float Kernel4 = 0.054409;</span><br><span class="line">const float Kernel3 = 0.087939;</span><br><span class="line">const float Kernel2 = 0.123913;</span><br><span class="line">const float Kernel1 = 0.152223;</span><br><span class="line">const float Kernel0 = 0.163030;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line"></span><br><span class="line">varying vec2 vUv;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line">    vec2 TextureCoord = vUv;</span><br><span class="line"></span><br><span class="line">    float stepX = TextureStepX * abs(TiltShift - TextureCoord.y) / abs(1.0 - TiltShift);</span><br><span class="line">result = </span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-4.0 * stepX, 0.0)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-3.0 * stepX, 0.0)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-2.0 * stepX, 0.0)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(-1.0 * stepX, 0.0)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0 * stepX, 0.0)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(1.0 * stepX, 0.0)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(2.0 * stepX, 0.0)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(3.0 * stepX, 0.0)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(4.0 * stepX, 0.0)) * Kernel4 +</span><br><span class="line">0.0 ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float TextureStepY = 0.001667;</span><br><span class="line">const float TiltShift = 0.500000;</span><br><span class="line">const float Kernel4 = 0.054409;</span><br><span class="line">const float Kernel3 = 0.087939;</span><br><span class="line">const float Kernel2 = 0.123913;</span><br><span class="line">const float Kernel1 = 0.152223;</span><br><span class="line">const float Kernel0 = 0.163030;</span><br><span class="line">uniform sampler2D Texture0;</span><br><span class="line"></span><br><span class="line">varying vec2 vUv;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 result;</span><br><span class="line">    vec2 TextureCoord = vUv;</span><br><span class="line"></span><br><span class="line">    float stepY = TextureStepY * abs(TiltShift - TextureCoord.y) / abs(1.0 - TiltShift);</span><br><span class="line">result = </span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -4.0 * stepY)) * Kernel4 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -3.0 * stepY)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -2.0 * stepY)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, -1.0 * stepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 0.0 * stepY)) * Kernel0 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 1.0 * stepY)) * Kernel1 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 2.0 * stepY)) * Kernel2 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 3.0 * stepY)) * Kernel3 +</span><br><span class="line">texture2D(Texture0, TextureCoord + vec2(0.0, 4.0 * stepY)) * Kernel4 +</span><br><span class="line">0.0 ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(result.xyz, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="jellyfish"><a class="markdownIt-Anchor" href="#jellyfish"></a> jellyfish</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">#ifdef GL_ES</span><br><span class="line">precision highp float;</span><br><span class="line">#endif</span><br><span class="line"> </span><br><span class="line">uniform sampler2D uSampler;</span><br><span class="line">uniform sampler2D uSampler1;</span><br><span class="line">uniform float uCurrentTime;</span><br><span class="line"> </span><br><span class="line">varying vec2 vTextureCoord;</span><br><span class="line">varying vec4 vWorld;</span><br><span class="line">varying vec3 vDiffuse;</span><br><span class="line">varying vec3 vAmbient;</span><br><span class="line">varying vec3 vFresnel;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">    vec4 caustics = texture2D(uSampler1, vec2(vWorld.x / 24.0 + uCurrentTime / 20.0, (vWorld.z - vWorld.y)/48.0 + uCurrentTime / 40.0));</span><br><span class="line">    vec4 colorMap = texture2D(uSampler, vTextureCoord);</span><br><span class="line">    float transparency = colorMap.a + pow(vFresnel.r, 2.0) - 0.3;</span><br><span class="line">    gl_FragColor = vec4(((vAmbient + vDiffuse + caustics.rgb) * colorMap.rgb), transparency);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="loop"><a class="markdownIt-Anchor" href="#loop"></a> loop</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">varying vec4 dummy;</span><br><span class="line">uniform int FragmentLoops;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">#ifdef GL_FRAGMENT_PRECISION_HIGH</span><br><span class="line">    // should be declared highp since the multiplication can overflow in</span><br><span class="line">    // mediump, particularly if mediump is implemented as fp16</span><br><span class="line">    highp vec2 FragCoord = gl_FragCoord.xy;</span><br><span class="line">#else</span><br><span class="line">    vec2 FragCoord = gl_FragCoord.xy;</span><br><span class="line">#endif</span><br><span class="line">    float d = fract(FragCoord.x * FragCoord.y * 0.0001);</span><br><span class="line"></span><br><span class="line">    for (int i = 0; i &lt; FragmentLoops; i++)</span><br><span class="line">        d = fract(3.0 * d);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(d, d, d, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="refract"><a class="markdownIt-Anchor" href="#refract"></a> refract</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">const float RefractiveIndex = 1.200000;</span><br><span class="line">const vec4 LightSourcePosition = vec4(1.000000, 1.000000, 2.000000, 1.000000);</span><br><span class="line">const vec4 LightColor = vec4(0.400000, 0.400000, 0.400000, 1.000000);</span><br><span class="line">uniform sampler2D DistanceMap;</span><br><span class="line">uniform sampler2D NormalMap;</span><br><span class="line">uniform sampler2D ImageMap;</span><br><span class="line"></span><br><span class="line">varying vec3 vertex_normal;</span><br><span class="line">varying vec4 vertex_position;</span><br><span class="line">varying vec4 MapCoord;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">    const vec4 lightSpecular = vec4(0.8, 0.8, 0.8, 1.0);</span><br><span class="line">    const vec4 matSpecular = vec4(1.0, 1.0, 1.0, 1.0);</span><br><span class="line">    const float matShininess = 100.0;</span><br><span class="line">    const vec2 point_five = vec2(0.5);</span><br><span class="line">    // Need the normalized eye direction and surface normal vectors to</span><br><span class="line">    // compute the transmitted vector through the &quot;front&quot; surface of the object.</span><br><span class="line">    vec3 eye_direction = normalize(-vertex_position.xyz);</span><br><span class="line">    vec3 normalized_normal = normalize(vertex_normal);</span><br><span class="line">    vec3 front_refraction = refract(eye_direction, normalized_normal, RefractiveIndex);</span><br><span class="line">    // Find our best distance approximation through the object so we can</span><br><span class="line">    // project the transmitted vector to the back of the object to find</span><br><span class="line">    // the exit point.</span><br><span class="line">    vec3 mc_perspective = (MapCoord.xyz / MapCoord.w) + front_refraction;</span><br><span class="line">    vec2 dcoord = mc_perspective.st * point_five + point_five;</span><br><span class="line">    vec4 distance_value = texture2D(DistanceMap, dcoord);</span><br><span class="line">    vec3 back_position = vertex_position.xyz + front_refraction * distance_value.x;</span><br><span class="line">    // Use the exit point to index the map of back-side normals, and use the</span><br><span class="line">    // back-side position and normal to find the transmitted vector out of the</span><br><span class="line">    // object.</span><br><span class="line">    vec2 normcoord = back_position.st * point_five + point_five;</span><br><span class="line">    vec3 back_normal = texture2D(NormalMap, normcoord).xyz;</span><br><span class="line">    vec3 back_refraction = refract(back_position, back_normal, 1.0/RefractiveIndex);</span><br><span class="line">    // Use the transmitted vector from the exit point to determine where</span><br><span class="line">    // the vector would intersect the environment (in this case a background</span><br><span class="line">    // image.</span><br><span class="line">    vec2 imagecoord = back_refraction.st * point_five + point_five;</span><br><span class="line">    vec4 texel = texture2D(ImageMap, imagecoord);</span><br><span class="line">    // Add in specular reflection, and we have our fragment value.</span><br><span class="line">    vec3 light_direction = normalize(vertex_position.xyz/vertex_position.w -</span><br><span class="line">                                     LightSourcePosition.xyz/LightSourcePosition.w);</span><br><span class="line">    vec3 reflection = reflect(light_direction, normalized_normal);</span><br><span class="line">    float specularTerm = pow(max(0.0, dot(reflection, eye_direction)), matShininess);</span><br><span class="line">    vec4 specular = (lightSpecular * matSpecular);</span><br><span class="line">    gl_FragColor = (specular * specularTerm) + texel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="shadow"><a class="markdownIt-Anchor" href="#shadow"></a> shadow</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">uniform sampler2D ShadowMap;</span><br><span class="line"></span><br><span class="line">varying vec4 Color;</span><br><span class="line">varying vec4 ShadowCoord;</span><br><span class="line"></span><br><span class="line">void main()</span><br><span class="line">&#123;</span><br><span class="line">    vec4 sc_perspective = ShadowCoord / ShadowCoord.w;</span><br><span class="line">    sc_perspective.z += 0.1505;</span><br><span class="line">    vec4 shadow_value = texture2D(ShadowMap, sc_perspective.st);</span><br><span class="line">    float light_distance = shadow_value.x;</span><br><span class="line">    float shadow = 1.0;</span><br><span class="line">    if (ShadowCoord.w &gt; 0.0 &amp;&amp; light_distance &lt; sc_perspective.z) &#123;</span><br><span class="line">        shadow = 0.5;</span><br><span class="line">    &#125;</span><br><span class="line">    gl_FragColor = vec4(shadow * Color.rgb, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="function"><a class="markdownIt-Anchor" href="#function"></a> function</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">varying vec4 dummy;</span><br><span class="line"></span><br><span class="line">float process(float d)</span><br><span class="line">&#123;</span><br><span class="line">    d = fract(3.0 * d);</span><br><span class="line"></span><br><span class="line">    return d;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">#ifdef GL_FRAGMENT_PRECISION_HIGH</span><br><span class="line">    // should be declared highp since the multiplication can overflow in</span><br><span class="line">    // mediump, particularly if mediump is implemented as fp16</span><br><span class="line">    highp vec2 FragCoord = gl_FragCoord.xy;</span><br><span class="line">#else</span><br><span class="line">    vec2 FragCoord = gl_FragCoord.xy;</span><br><span class="line">#endif</span><br><span class="line">    float d = fract(FragCoord.x * FragCoord.y * 0.0001);</span><br><span class="line"></span><br><span class="line">    d = process(d);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(d, d, d, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="conditionals"><a class="markdownIt-Anchor" href="#conditionals"></a> conditionals</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#ifdef GL_ES</span><br><span class="line">precision mediump float;</span><br><span class="line">#endif</span><br><span class="line">varying vec4 dummy;</span><br><span class="line"></span><br><span class="line">void main(void)</span><br><span class="line">&#123;</span><br><span class="line">#ifdef GL_FRAGMENT_PRECISION_HIGH</span><br><span class="line">    // should be declared highp since the multiplication can overflow in</span><br><span class="line">    // mediump, particularly if mediump is implemented as fp16</span><br><span class="line">    highp vec2 FragCoord = gl_FragCoord.xy;</span><br><span class="line">#else</span><br><span class="line">    vec2 FragCoord = gl_FragCoord.xy;</span><br><span class="line">#endif</span><br><span class="line">    float d = fract(FragCoord.x * FragCoord.y * 0.0001);</span><br><span class="line"></span><br><span class="line">    if (d &gt;= 0.5)</span><br><span class="line">        d = fract(2.0 * d);</span><br><span class="line">    else</span><br><span class="line">        d = fract(3.0 * d);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    gl_FragColor = vec4(d, d, d, 1.0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢è¿™äº›åœºæ™¯çš„Fragment Shaderæ¥çœ‹ï¼Œ<strong>desktop</strong>å’Œ<strong>clear</strong>è¿™ä¸¤ä¸ªåœºæ™¯æ¯”è¾ƒç‰¹æ®Šï¼Œclearæ²¡æœ‰shader, è€Œ<strong>desktop</strong>æœ‰8ä¸ªfragment shadersï¼Œè€Œä¸”æ¯ä¸ªfragment shaderé‡Œéƒ½è°ƒç”¨äº†å¤šæ¬¡<code>texture2D</code>è¿™ä¸ªçº¹ç†æŸ¥è¯¢GLSLå†…ç½®å‡½æ•°ã€‚</p>
<ul>
<li>
<p>ä¸ºä»€ä¹ˆæœ‰8ä¸ªfragment shader?</p>
<p>SceneDesktopè¿™ä¸ªåœºæ™¯é™¤äº†ä¸»çª—å£å¤–ï¼Œé»˜è®¤è¿˜æœ‰4ä¸ªå°çª—å£ï¼Œè€Œè¿™4ä¸ªå°çª—å£æœ‰ä¸¤ç§ç‰¹æ•ˆ: <strong>blur</strong>, <strong>shadow</strong>. bluræ•ˆæœæ˜¯é€šè¿‡å·ç§¯å®ç°çš„æ¨¡ç³Šæ•ˆæœï¼Œè€Œä¸”å¯ä»¥æ°´å¹³å’Œå‚ç›´æ–¹å‘åˆ†å¼€æ¨¡ç³Šï¼Œç”±é€‰é¡¹<code>separable</code>æ§åˆ¶ï¼Œé»˜è®¤æ˜¯<code>true</code>(æ°´å¹³å’Œå‚ç›´å„ä¸€ä¸ªfragment shader).</p>
</li>
<li>
<p>ä¸ºä»€ä¹ˆæ¯ä¸ªfragment shaderé‡Œæœ‰é‚£ä¹ˆå¤š<code>texture2D</code>?</p>
</li>
</ul>
<h2 id="scenedesktop-test"><a class="markdownIt-Anchor" href="#scenedesktop-test"></a> SceneDesktop Test</h2>
<figure class="highlight plaintext"><figcaption><span>glmark2 --list | awk '/[Scene] desktop/, /[Scene] effect2d/ &#123; print &#125;'</span></figcaption><table><tr><td class="code"><pre><span class="line">[Scene] desktop</span><br><span class="line">  [Option] blur-radius</span><br><span class="line">    Description  : the blur effect radius (in pixels)</span><br><span class="line">    Default Value: 5</span><br><span class="line">  [Option] duration</span><br><span class="line">    Description  : The duration of each benchmark in seconds</span><br><span class="line">    Default Value: 10.0</span><br><span class="line">  [Option] effect</span><br><span class="line">    Description  : The effect to use</span><br><span class="line">    Default Value: blur</span><br><span class="line">    Acceptable Values: blur,shadow</span><br><span class="line">  [Option] fps-pos</span><br><span class="line">    Description  : The position on screen where to show FPS</span><br><span class="line">    Default Value: -1.0,-1.0</span><br><span class="line">  [Option] fps-size</span><br><span class="line">    Description  : The width of each glyph for the FPS</span><br><span class="line">    Default Value: 0.03</span><br><span class="line">  [Option] fragment-precision</span><br><span class="line">    Description  : The precision values for the fragment shader (&quot;int,float,sampler2d,samplercube&quot;)</span><br><span class="line">    Default Value: default,default,default,default</span><br><span class="line">  [Option] nframes</span><br><span class="line">    Description  : The number of frames to render</span><br><span class="line">    Default Value: </span><br><span class="line">  [Option] passes</span><br><span class="line">    Description  : the number of effect passes (effect dependent)</span><br><span class="line">    Default Value: 1</span><br><span class="line">  [Option] separable</span><br><span class="line">    Description  : use separable convolution for the blur effect</span><br><span class="line">    Default Value: true</span><br><span class="line">    Acceptable Values: false,true</span><br><span class="line">  [Option] shadow-size</span><br><span class="line">    Description  : the size of the shadow (in pixels)</span><br><span class="line">    Default Value: 20</span><br><span class="line">  [Option] show-fps</span><br><span class="line">    Description  : Show live FPS counter</span><br><span class="line">    Default Value: false</span><br><span class="line">    Acceptable Values: false,true</span><br><span class="line">  [Option] title</span><br><span class="line">    Description  : The scene title to show</span><br><span class="line">    Default Value: </span><br><span class="line">  [Option] title-pos</span><br><span class="line">    Description  : The position on screen where to show the title</span><br><span class="line">    Default Value: -0.7,-1.0</span><br><span class="line">  [Option] title-size</span><br><span class="line">    Description  : The width of each glyph in the title</span><br><span class="line">    Default Value: 0.03</span><br><span class="line">  [Option] vertex-precision</span><br><span class="line">    Description  : The precision values for the vertex shader (&quot;int,float,sampler2d,samplercube&quot;)</span><br><span class="line">    Default Value: default,default,default,default</span><br><span class="line">  [Option] window-size</span><br><span class="line">    Description  : the window size as a percentage of the minimum screen dimension [0.0 - 0.5]</span><br><span class="line">    Default Value: 0.35</span><br><span class="line">  [Option] windows</span><br><span class="line">    Description  : the number of windows</span><br><span class="line">    Default Value: 4</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenGL Shading Languages</title>
    <url>/gfx/glsl/</url>
    <content><![CDATA[<p>GLSL æ˜¯ä¸€ç§é«˜çº§ç€è‰²è¯­è¨€ï¼Œè¯­æ³•æ¥è¿‘ C è¯­è¨€ã€‚å®ƒç”± OpenGL ARB åˆ›å»ºï¼Œæ—¨åœ¨è®©å¼€å‘è€…èƒ½å¤Ÿæ›´ç›´æ¥åœ°æ§åˆ¶å›¾å½¢ç®¡çº¿ï¼Œè€Œæ— éœ€ä½¿ç”¨ ARB æ±‡ç¼–è¯­è¨€æˆ–ç‰¹å®šç¡¬ä»¶è¯­è¨€ã€‚</p>
<p>å®é™…ä¸Š GLSL åŒ…æ‹¬å¤§æ¦‚ 6 ç§ç€è‰²è¯­è¨€:</p>
<ul>
<li>é¡¶ç‚¹ç€è‰²è¯­è¨€ (.vert)</li>
<li>ç»†åˆ†æ§åˆ¶è¯­è¨€ (.tesc)</li>
<li>ç»†åˆ†è¯„ä¼°è¯­è¨€ (.tese)</li>
<li>å‡ ä½•ç€è‰²è¯­è¨€ (.geom)</li>
<li>ç‰‡æ®µç€è‰²è¯­è¨€ (.frag)</li>
<li>è®¡ç®—ç€è‰²è¯­è¨€ (.comp)</li>
</ul>
<span id="more"></span>
<h1 id="glslangvalidator"><a class="markdownIt-Anchor" href="#glslangvalidator"></a> <a href="https://github.com/KhronosGroup/glslang">glslangValidator</a></h1>
<p>glslangValidator æ˜¯ä¸€ä¸ª GLSL/ESSL çš„ç¼–è¯‘å‰ç«¯ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ª SPIR-V çš„ç”Ÿæˆå™¨ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/bin/glslangValidator \</span><br><span class="line">  -V /home/luc/gh/VulkanExamples/data/shaders/deferredmultisampling/debug.frag \</span><br><span class="line">  -o /home/luc/gh/VulkanExamples/data/shaders/deferredmultisampling/debug.frag.debug.spv</span><br></pre></td></tr></table></figure>
<h1 id="é¡¶ç‚¹ç€è‰²è¯­è¨€"><a class="markdownIt-Anchor" href="#é¡¶ç‚¹ç€è‰²è¯­è¨€"></a> é¡¶ç‚¹ç€è‰²è¯­è¨€</h1>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">layout (location = 0) out vec3 outUV;</span><br><span class="line"></span><br><span class="line">outUV = vec3((gl_VertexIndex &lt;&lt; 1) &amp; 2, gl_VertexIndex &amp; 2, 0.0);</span><br><span class="line">gl_Position = vec4(outUV.st * 2.0f - 1.0f, 0.0f, 1.0f);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>gl_VertexIndex</code> å’Œ <code>gl_Position</code> éƒ½æ˜¯é¡¶ç‚¹ç€è‰²è¯­è¨€å†…ç½®å˜é‡(æ— éœ€ç”¨æˆ·å£°æ˜)</li>
<li><code>out vec3 outUV</code> è¯´æ˜ <code>outUV</code> ä¼šä»æœ¬é˜¶æ®µè¾“å‡ºåˆ°ä¸‹ä¸€ä¸ªç€è‰²é˜¶æ®µ</li>
<li><code>layout (location = 0)</code> ä¸ºè¿™ä¸ªè¾“å‡ºå˜é‡æŒ‡å®šä¸€ä¸ªä½ç½®(æˆ–æ§½ä½), è¿™æ ·å³ä½¿åœ¨ä¸ä¸‹ä¸€é˜¶æ®µç€è‰²å™¨çš„è¾“å…¥å˜é‡åå­—ä¸åŒï¼Œä½†åªè¦å®ƒä¹Ÿå£°æ˜åŒæ ·çš„ location, é‚£ä¹ˆå˜é‡å°±å¯ä»¥å‡†ç¡®ä¼ å…¥ä¸‹ä¸€é˜¶æ®µçš„ç€è‰²å™¨</li>
</ul>
<p>è¿™æ®µç€è‰²å™¨ä»£ç å·§å¦™åœ°åˆ©ç”¨ <code>gl_VertexIndex</code> ç”Ÿæˆäº†é¡¶ç‚¹çš„ position å±æ€§ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">gl_VertexIndex</th>
<th style="text-align:left">outUV</th>
<th style="text-align:left">gl_Position</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">(0, 0, 0)</td>
<td style="text-align:left">(-1, -1, 0, 1)</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">(2, 0, 0)</td>
<td style="text-align:left">( 3, -1, 0, 1)</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">(0, 2, 0)</td>
<td style="text-align:left">(-1,  3, 0, 1)</td>
</tr>
<tr>
<td style="text-align:left">3</td>
<td style="text-align:left">(2, 2, 0)</td>
<td style="text-align:left">( 3,  3, 0, 1)</td>
</tr>
</tbody>
</table>
<h1 id="å‡½æ•°"><a class="markdownIt-Anchor" href="#å‡½æ•°"></a> å‡½æ•°</h1>
<h2 id="texelfetch"><a class="markdownIt-Anchor" href="#texelfetch"></a> texelFetch</h2>
<ul>
<li><code>vec4 texelFetch(sampler2D sampler, ivec2 P, int lod);</code></li>
</ul>
<p>ä¸æ™®é€šçš„ <code>texture</code> å‡½æ•°ä¸åŒï¼Œ<code>texelFetch</code> ä½¿ç”¨çš„æ˜¯æœªå½’ä¸€åŒ–çš„åæ ‡ç›´æ¥è®¿é—®çº¹ç†ä¸­çš„çº¹ç´ ï¼Œæœ‰ç‚¹ <code>gl_FragCoord</code> çš„æ„æ€</p>
<h2 id="texturesize"><a class="markdownIt-Anchor" href="#texturesize"></a> textureSize</h2>
<ul>
<li><code>ivec2 textureSize(sampler2D sampler, int lod);</code></li>
</ul>
<p>è·å–çº¹ç†çš„å°ºå¯¸ï¼Œå¸¸ç”¨æ¥å°†å½’ä¸€åŒ–çš„çº¹ç†åæ ‡è½¬æ¢ä¸ºåƒç´ åæ ‡</p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>GLSL</tag>
      </tags>
  </entry>
  <entry>
    <title>Android Graphics Overview</title>
    <url>/gfx/hal/</url>
    <content><![CDATA[<p><img src="/images/hal/android-graphics.png" alt="Android Graphics" /></p>
<span id="more"></span>
<h1 id="android-stack"><a class="markdownIt-Anchor" href="#android-stack"></a> <a href="https://source.android.com/docs/core/architecture?hl=zh-cn">Android Stack</a></h1>
<p><img src="/images/hal/android-stack.svg" alt="Android Stack" /></p>
<h1 id="android-graphics-stack"><a class="markdownIt-Anchor" href="#android-graphics-stack"></a> Android Graphics Stack</h1>
<pre><code class="highlight mermaid">block-beta
  columns 3
  block:group1:3
    %% columns auto (default)   
    A[&quot;WindowManager&quot;]
    B[&quot;SurfaceFlinger&quot;]
    C[&quot;...&quot;]
  end
  block:group2:3
    a[&quot;Gralloc&quot;]
    b[&quot;HWComposer&quot;]
    c[&quot;...&quot;]
  end
  block:group3:3
    a1[&quot;GPU&quot;]
    b1[&quot;DC&quot;]
    c1[&quot;...&quot;]
  end
  %% **è“
  style group1 fill:#55AEF7
  %% **æ©™
  style group2 fill:#F87529
  %% **ç»¿
  style group3 fill:#25A768</code></pre>
<h1 id="surfaceflinger-flÉªngÉ™ræŠ›æŠ•å™¨"><a class="markdownIt-Anchor" href="#surfaceflinger-flÉªngÉ™ræŠ›æŠ•å™¨"></a> SurfaceFlinger (<code>/f'lÉªngÉ™r/</code>:æŠ›æŠ•å™¨)</h1>
<h1 id="hal"><a class="markdownIt-Anchor" href="#hal"></a> <a href="https://android.googlesource.com/platform/hardware/libhardware/">HAL</a></h1>
<h2 id="gralloc"><a class="markdownIt-Anchor" href="#gralloc"></a> <a href="https://android.googlesource.com/platform/hardware/libhardware/+/refs/heads/main/modules/gralloc/">Gralloc</a></h2>
<h2 id="ç¡¬ä»¶åˆæˆå™¨"><a class="markdownIt-Anchor" href="#ç¡¬ä»¶åˆæˆå™¨"></a> ç¡¬ä»¶åˆæˆå™¨</h2>
<p><strong>ç¡¬ä»¶åˆæˆå™¨</strong>æ˜¯ Android ç³»ç»Ÿä¸­è´Ÿè´£å±å¹•æ˜¾ç¤ºçš„ç¡¬ä»¶æŠ½è±¡å±‚ (HAL) ç»„ä»¶ä¹‹ä¸€ã€‚å®ƒè´Ÿè´£å°†å›¾å½¢æ¸²æŸ“çš„å†…å®¹(æ¯”å¦‚åº”ç”¨ç¨‹åºç•Œé¢ï¼Œè§†é¢‘ç­‰)åˆæˆåˆ°å¸§ç¼“å†²é‡Œï¼Œä»¥ä¾¿é«˜æ•ˆåœ°åˆ©ç”¨ DPU ç¡¬ä»¶åŠ é€Ÿ <strong>overlay</strong> åˆæˆï¼Œå‡å°‘ GPU åˆæˆçš„è´Ÿæ‹…ï¼Œä»è€Œæ•´ä½“ä¸Šæä¾›æ›´æµç•…çš„å›¾å½¢æ¸²æŸ“æ˜¾ç¤ºã€‚</p>
<p>hwcomposer ç»„ä»¶é€šå¸¸æ˜¯ç”±å„ä¸ªè®¾å¤‡å‚å•†æ ¹æ®è‡ªå·±çš„ç¡¬ä»¶ç‰¹æ€§å®ç°çš„ï¼Œæœ‰å¼€æºçš„ï¼Œä¹Ÿæœ‰é—­æºçš„ã€‚åœ¨ AOSP ä¸­æœ‰ä¸€ä¸ªé€šç”¨çš„åŸºç¡€çš„ <strong>hwcomposer</strong> å®ç°ï¼Œä¸»è¦ç”¨äºé‚£äº›ä¸éœ€è¦ç‰¹åˆ«ç¡¬ä»¶åŠ é€Ÿæˆ–ä¼˜åŒ–çš„è®¾å¤‡ï¼Œç±»ä¼¼ xserver ä¸­çš„ <strong>modesetting</strong>.</p>
<pre><code class="highlight mermaid">mindmap
  root(HAL hwcomposer)
    libhardware/hwcomposer demo
    drm-hwcomposer
      Arm drm-hwcomposer
    Qualcomm hwcomposer
    Samsung hwcomposer
    Huawei hwcomposer</code></pre>
<h2 id="hwcomposer"><a class="markdownIt-Anchor" href="#hwcomposer"></a> <a href="https://android.googlesource.com/platform/hardware/libhardware/+/refs/heads/main/modules/hwcomposer/">HWComposer</a></h2>
<p>å°½é‡è®© GPU å°‘åšåˆæˆçš„å·¥ä½œï¼Œè®© DPU (Display Processor Unit) å¤šåšåˆæˆçš„å·¥ä½œï¼Œå› ä¸ºåˆæˆæ¶‰åŠçš„æ“ä½œä¸»è¦æœ‰</p>
<ul>
<li>æ ¼å¼è½¬æ¢</li>
<li>æ—‹è½¬ç¼©æ”¾</li>
<li>åƒç´ æ‹·è´</li>
</ul>
<p>å¦‚æœè¿™äº›éƒ½å ç”¨ GPU å»åšï¼Œå¤ªæµªè´¹ GPU äº†ã€‚</p>
<p><img src="/images/hal/composition-with-hwcomposer.png" alt="composition-with-hwcomposer" /></p>
<h3 id="drm-hwcomposer"><a class="markdownIt-Anchor" href="#drm-hwcomposer"></a> <a href="https://gitlab.freedesktop.org/drm-hwcomposer/drm-hwcomposer">drm-hwcomposer</a></h3>
<p>ä¸€ä¸ªåŸºäº KMS çš„ HWComposer å®ç°ã€‚</p>
<h3 id="arm-drm-hwcomposer"><a class="markdownIt-Anchor" href="#arm-drm-hwcomposer"></a> <a href="https://github.com/ARM-software/drm-hwcomposer">ARM drm-hwcomposer</a></h3>
<p>ç»™ Mali DP é‡èº«å®šåˆ¶çš„ drm-hwcomposer.</p>
<h1 id="android-sync-framework"><a class="markdownIt-Anchor" href="#android-sync-framework"></a> Android Sync Framework</h1>
<p>Android Sync Framework å®ç°çš„æ˜¯<strong>æ˜¾å¼åŒæ­¥ (Explicit Synchronization)</strong>, æ‰€è°“æ˜¾å¼åŒæ­¥ï¼ŒæŒ‡çš„æ˜¯ç”¨æˆ·æ€å¯è§ï¼Œä¸éšå¼åŒæ­¥ (Implicit Synchronization) ç›¸å¯¹ï¼Œéšå¼åŒæ­¥ç”¨æˆ·æ€åº”ç”¨ç¨‹åºæ˜¯ä¸æ„ŸçŸ¥çš„ã€‚è™½ç„¶éšå¼åŒæ­¥å®Œå…¨ç”±<strong>é©±åŠ¨å’Œå†…æ ¸æ§åˆ¶</strong>ï¼Œæ— éœ€åº”ç”¨ç¨‹åºå¹²é¢„(è¿™å¯¹åº”ç”¨å¼€å‘è€…æ¥è¯´å¯èƒ½æ›´ç®€å•äº›ï¼Œä½†æœ‰æ—¶ç®€å•çš„æ–¹æ¡ˆå¯èƒ½ä¸æ˜¯æœ€é«˜æ•ˆçš„)ï¼Œä½†<a href="https://www.collabora.com/news-and-blog/blog/2022/06/09/bridging-the-synchronization-gap-on-linux/">æ˜¾å¼åŒæ­¥æ¯”éšå¼åŒæ­¥æ›´èƒ½å‘æŒ¥ç¡¬ä»¶çš„å¹¶è¡Œæ€§</a>ï¼Œè¿™åº”è¯¥ä¹Ÿæ˜¯ Android å®ç°çš„æ˜¯æ˜¾å¼åŒæ­¥çš„ä¸»è¦åŸå› ã€‚</p>
<ul>
<li>sync_timeline
<ul>
<li>control ordering</li>
</ul>
</li>
<li>sync_pt (point)
<ul>
<li>represent a fence</li>
</ul>
</li>
<li>sync_fence (like sync file in Linux kernel)
<ul>
<li>for fd passing across userspace processes like <code>SurfaceFlinger</code> and 3D applications</li>
</ul>
</li>
</ul>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://blog.csdn.net/liuning1985622/article/details/138453346?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-4-138453346-blog-45080305.235%5Ev43%5Epc_blog_bottom_relevance_base6&amp;spm=1001.2101.3001.4242.3&amp;utm_relevant_index=6">Android Graphics</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/261169653">è‡ªä¸Šè€Œä¸‹è§£è¯» Android æ˜¾ç¤ºæµç¨‹</a></li>
<li><a href="https://source.android.com/docs/core/graphics/implement-hwc?hl=zh-cn">Android æ–‡æ¡£ï¼šå®ç°ç¡¬ä»¶æ··åˆæ¸²æŸ“å™¨ HAL</a></li>
<li><a href="https://community.nxp.com/t5/i-MX-Processors-Knowledge-Base/Android-Graphic-UI-with-GPU-Hardware-Acceleration/ta-p/1102023">Android Graphic UI with GPU Hardware Acceleration</a></li>
<li><a href="https://blog.csdn.net/stray2b/article/details/130291840">Android drm-hwcomposer</a></li>
<li><a href="https://android.googlesource.com/device/linaro/dragonboard/+/refs/heads/main/shared/graphics/drm_hwcomposer/device.mk">DragonBoards using drm_hwcomposer</a></li>
<li><a href="https://blog.csdn.net/MoLiYw/article/details/118829051">Fence</a></li>
<li><a href="https://blog.linuxplumbersconf.org/2014/ocw/system/presentations/2355/original/03%20-%20sync%20&amp;%20dma-fence.pdf">Android Sync</a></li>
<li><a href="https://www.collabora.com/news-and-blog/blog/2016/09/13/mainline-explicit-fencing-part-1/">Mainline Explicit Fencing</a></li>
<li><a href="https://zamundaaa.github.io/wayland/2024/04/05/explicit-sync.html">Explicit Sync</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>Image Format in OpenGL</title>
    <url>/gfx/image-format/</url>
    <content><![CDATA[<h1 id="color-format"><a class="markdownIt-Anchor" href="#color-format"></a> Color Format</h1>
<span id="more"></span>
<h1 id="depth-format"><a class="markdownIt-Anchor" href="#depth-format"></a> Depth Format</h1>
<h2 id="normalized-integer"><a class="markdownIt-Anchor" href="#normalized-integer"></a> Normalized Integer</h2>
<p>äº‹å®ä¸Šï¼Œè¿™é‡Œçš„Normalized Integeræ˜¯<code>Unsigned Normalized Integer</code>, æ„æ€æ˜¯å¯¹äºä¸€ä¸ªn-bitæ•°ï¼Œæ‰€æœ‰ä½æ˜¯0è¡¨ç¤º0.0f, æ‰€æœ‰ä½æ˜¯1è¡¨ç¤º1.0f, å°†æ‰€æœ‰æ•´æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºå¹³å‡æ˜ å°„åˆ°<code>[0, 1]</code>çš„æ·±åº¦å€¼åŒºé—´ã€‚ä¾‹å¦‚ï¼Œ2-bitçš„UNORM Integeræ•°æœ‰ä¸‹é¢çš„æ˜ å°„å…³ç³»:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Integer Bits</th>
<th style="text-align:left">Depth Values</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">00</td>
<td style="text-align:left">0.0f</td>
</tr>
<tr>
<td style="text-align:left">01</td>
<td style="text-align:left">1/3</td>
</tr>
<tr>
<td style="text-align:left">10</td>
<td style="text-align:left">2/3</td>
</tr>
<tr>
<td style="text-align:left">11</td>
<td style="text-align:left">1.0f</td>
</tr>
</tbody>
</table>
<ul>
<li><code>GL_DEPTH_COMPONENT16</code></li>
<li><code>GL_DEPTH_COMPONENT24</code></li>
<li><code>GL_DEPTH_COMPONENT32</code></li>
</ul>
<h2 id="floating-point"><a class="markdownIt-Anchor" href="#floating-point"></a> Floating-point</h2>
<ul>
<li><code>GL_DEPTH_COMPONENT32F</code></li>
</ul>
<h1 id="depth-stencil-format"><a class="markdownIt-Anchor" href="#depth-stencil-format"></a> Depth-Stencil Format</h1>
<h1 id="depth-depth-stencil-format-image-ä¸-shadow-samplers"><a class="markdownIt-Anchor" href="#depth-depth-stencil-format-image-ä¸-shadow-samplers"></a> Depth &amp; Depth-Stencil Format Image ä¸ Shadow Samplers</h1>
<p>Shadow Samplers</p>
<table>
<thead>
<tr>
<th style="text-align:left">GLSL sampler</th>
<th style="text-align:left">OpenGL texture target</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">sampler1DShadow</td>
<td style="text-align:left">GL_TEXTURE_1D</td>
</tr>
<tr>
<td style="text-align:left">sampler2DShadow</td>
<td style="text-align:left">GL_TEXTURE_2D</td>
</tr>
<tr>
<td style="text-align:left">samplerCubeShadow</td>
<td style="text-align:left">GL_TEXTURE_CUBE_MAP</td>
</tr>
<tr>
<td style="text-align:left">sampler2DRectShadow</td>
<td style="text-align:left">GL_TEXTURE_RECTANGLE</td>
</tr>
<tr>
<td style="text-align:left">sampler1DArrayShadow</td>
<td style="text-align:left">GL_TEXTURE_1D_ARRAY</td>
</tr>
<tr>
<td style="text-align:left">sampler2DArrayShadow</td>
<td style="text-align:left">GL_TEXTURE_2D_ARRAY</td>
</tr>
<tr>
<td style="text-align:left">samplerCubeArrayShadow</td>
<td style="text-align:left">GL_TEXTURE_CUBE_MAP_ARRAY</td>
</tr>
</tbody>
</table>
<p>å½“ä¸€ä¸ªçº¹ç†æ ¼å¼æ˜¯Depthæˆ–Depth-Stencilæ ¼å¼æ—¶ï¼Œå®ƒå°±ä¸èƒ½å†ä½¿ç”¨é€šå¸¸çš„é‡‡æ ·å™¨(Sampler), è€Œå¿…é¡»ä½¿ç”¨Shadow Sampler. è¿™ç§ç±»å‹çš„Sampler Texture Lookupå‡½æ•°è¢«é‡è½½æˆæ¯”é€šå¸¸çš„çº¹ç†åæ ‡å¤šä¸€ä¸ªcomponent. è€Œä¸”è¿”å›å€¼æ°¸è¿œæ˜¯ä¸€ä¸ªfloatæ ‡é‡å€¼, è€Œä¸”è¿™ä¸ªè¿”å›å€¼çš„èŒƒå›´æ°¸è¿œåœ¨[0, 1]ä¹‹é—´ï¼Œå½“çº¹ç†åæ ‡çš„æœ€åä¸€ä¸ªcomponent(æ¯”é€šå¸¸å¤šå‡ºçš„é‚£ä¸ª)ä¸é‡‡æ ·å€¼æ¯”è¾ƒé€šè¿‡æ—¶ï¼Œè¿”å›å€¼ä¸º1ï¼Œå¦‚æœæ¯”è¾ƒå¤±è´¥ï¼Œè¿”å›å€¼ä¸º0ï¼Œå½“æœ‰å¤šä¸ªé‡‡æ ·ç‚¹æ—¶ï¼Œåˆ†åˆ«è¿›è¡Œæ¯”è¾ƒï¼Œç»“æœä¸ºæ¯”è¾ƒé€šè¿‡å æ€»é‡‡æ ·ç‚¹ä¸ªæ•°çš„æ¯”ä¾‹ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ˜¯4ä¸ªé‡‡æ ·å€¼ï¼Œåªæœ‰ä¸€ä¸ªæ¯”è¾ƒé€šè¿‡ï¼Œåˆ™è¿”å›å€¼æ˜¯0.25.</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">float</span> <span class="title function_">texture</span><span class="params">(sampler1DShadow sampler, vec3 P[, <span class="type">float</span> bias])</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">texture</span><span class="params">(sampler2DShadow sampler, vec3 P[, <span class="type">float</span> bias])</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">texture</span><span class="params">(samplerCubeShadow sampler, vec4 P[, <span class="type">float</span> bias])</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">texture</span><span class="params">(sampler1DArrayShadow sampler, vec3 P[, <span class="type">float</span> bias])</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">texture</span><span class="params">(sampler2DArrayShadow sampler, vec4 P)</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">texture</span><span class="params">(sampler2DRectShadow sampler, vec3 P)</span></span><br><span class="line"><span class="type">float</span> <span class="title function_">texture</span><span class="params">(samplerCubeArrayShadow sampler, vec4 P, <span class="type">float</span> compare)</span></span><br></pre></td></tr></table></figure>
<p>è¯´æ˜ï¼š</p>
<ol>
<li>sampler1DShadowçš„çº¹ç†åæ ‡çš„ç¬¬2ä¸ªcomponentä¸ä½¿ç”¨, ç¬¬3ä¸ªcomponentä½œä¸ºreference value</li>
<li>samplerCubeArrayçš„Texture Lookupå‡½æ•°çš„çº¹ç†åæ ‡æœ¬èº«å°±æ˜¯ä¸€ä¸ª4ç»´çš„ï¼Œæ‰€ä»¥samplerCubeArrayShadowçš„é‡è½½æ–°åŠ äº†ä¸€ä¸ªå•ç‹¬çš„floatç±»å‹å‚æ•°<code>compare</code>ä½œä¸ºreference valueï¼Œé¿å…ä½¿ç”¨5ç»´å‘é‡ã€‚</li>
<li>æ‰€æœ‰çš„shadow samplerç±»å‹éƒ½åªæœ‰ä¸€ç§floatç±»å‹ï¼Œæ²¡æœ‰i(integer), u(unsigned integer)ç±»å‹ï¼Œå› ä¸ºshadow sampleræ€»æ˜¯è¿”å›å•ä¸ªçš„floatå€¼ã€‚</li>
</ol>
<p>å…·ä½“å¦‚ä½•æ¯”è¾ƒç”±Texture Parameter <code>GL_TEXTURE_COMPARE_FUNC</code>å†³å®šï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">Texture Comparison Function</th>
<th style="text-align:left">Result 1.0</th>
<th style="text-align:left">Result 0.0</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GL_LEQUAL</td>
<td style="text-align:left">r &lt;= Dt</td>
<td style="text-align:left">r &gt; Dt</td>
</tr>
<tr>
<td style="text-align:left">GL_GEQUAL</td>
<td style="text-align:left">r &gt;= Dt</td>
<td style="text-align:left">r &lt; Dt</td>
</tr>
<tr>
<td style="text-align:left">GL_LESS</td>
<td style="text-align:left">r &lt;  Dt</td>
<td style="text-align:left">r &gt;= Dt</td>
</tr>
<tr>
<td style="text-align:left">GL_GREATER</td>
<td style="text-align:left">r &gt;  Dt</td>
<td style="text-align:left">r &lt;= Dt</td>
</tr>
<tr>
<td style="text-align:left">GL_EQUAL</td>
<td style="text-align:left">r == Dt</td>
<td style="text-align:left">r != Dt</td>
</tr>
<tr>
<td style="text-align:left">GL_NOTEQUAL</td>
<td style="text-align:left">r != Dt</td>
<td style="text-align:left">r == Dt</td>
</tr>
<tr>
<td style="text-align:left">GL_ALWAYS</td>
<td style="text-align:left">Always</td>
<td style="text-align:left">Never</td>
</tr>
<tr>
<td style="text-align:left">GL_NEVER</td>
<td style="text-align:left">Never</td>
<td style="text-align:left">Always</td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>Knowledge from &quot;[RFC] Plane color pipeline KMS uAPI&quot;</title>
    <url>/gfx/kms/</url>
    <content><![CDATA[<h1 id="gamma-lut-property"><a class="markdownIt-Anchor" href="#gamma-lut-property"></a> Gamma LUT property</h1>
<p>Gamma LUT (Look-Up Table) is a property that is used to correct the color and brightness of an image or video. Gamma LUT is basically a table of values that is used to map input values to output values, for example, it may map low input values to higher output values to brighten the image.</p>
<p>Gamma LUT is used to adjust the gamma curve of an image or video, which means it can be used to correct the brightness and contrast of an image. This property is commonly used in image and video processing applications, such as photo editing software, video editing software, and color grading tools.</p>
<p>Gamma LUT can also be used to correct color shifts caused by different lighting conditions or camera settings. By adjusting the gamma curve of an image or video, it is possible to create a more natural and accurate representation of the original scene.</p>
<span id="more"></span>
<h1 id="csc-property"><a class="markdownIt-Anchor" href="#csc-property"></a> CSC property</h1>
<p>CSC is an acronym for <strong>Color Space Conversion</strong>, which is a property used in digital image and video processing. CSC is used to convert the color space of an image or video from one format to another.</p>
<p>Color spaces are a way to represent colors using numerical values. Different devices and software applications use different color spaces, which can cause issues when trying to display or process images or videos across different platforms. For example, an image captured by a camera may use one color space, while a monitor may use another color space.</p>
<p>CSC property can be used to convert the color space of an image or video from one format to another. This can be useful for ensuring that images or videos are displayed correctly on different devices or platforms. For example, a video may need to be converted from the color space used by a camera to the color space used by a television or monitor.</p>
<p>CSC can also be used for color correction, where the colors of an image or video are adjusted to make them more accurate or aesthetically pleasing. Overall, the CSC property is an important tool in digital image and video processing, allowing for the correct and accurate representation of colors across different platforms.</p>
<h1 id="scrgb"><a class="markdownIt-Anchor" href="#scrgb"></a> scRGB</h1>
<p>scRGB (standardized RGB) is a color space that defines an alternative method for representing colors in digital images or videos. It is a wide-gamut (å¹¿è‰²åŸŸ) color space that can represent a larger range of colors than the traditional sRGB color space used in most computer displays.</p>
<p>scRGB was developed by Microsoft and is defined by the International Electrotechnical Commission (IEC) standard IEC 61966-2-2. It is designed to be a device-independent color space, meaning that it can be used to represent colors accurately on a wide range of devices, including computer monitors, printers, and projectors.</p>
<p>The scRGB color space is based on a linear color system, which means that the difference between two colors is proportional to the difference in their numerical values. This makes it easier to perform accurate color calculations and color corrections in digital image and video processing.</p>
<p>scRGB is commonly used in professional video and film production, as well as in high-end graphics applications. It is also used as a reference color space for other color spaces, such as Adobe RGB and DCI-P3.</p>
<h2 id="whats-the-difference-between-srgb-and-scrgb"><a class="markdownIt-Anchor" href="#whats-the-difference-between-srgb-and-scrgb"></a> whatâ€™s the difference between sRGB and scRGB</h2>
<p>The main difference between scRGB and sRGB is the range of colors that they can represent. scRGB is a wide-gamut color space that can represent a larger range of colors than sRGB. sRGB is a standard color space that is commonly used in computer displays, but it has a smaller gamut than scRGB.</p>
<p>sRGB defines a color space that can represent approximately 16.8 million colors, while scRGB can represent over a billion colors. This means that scRGB can represent a wider range of colors than sRGB, including more vibrant and saturated colors. However, not all devices or applications can display or process scRGB colors correctly, so it is not always practical to use scRGB in all situations.</p>
<p>Another difference between scRGB and sRGB is their color encoding. scRGB uses a linear color encoding, which means that the difference between two colors is proportional to the difference in their numerical values. sRGB, on the other hand, uses a non-linear encoding, which means that the difference between two colors is not proportional to their numerical values. This makes it easier to display sRGB colors on typical computer monitors and other devices.</p>
<p>Overall, scRGB is a more advanced and flexible color space than sRGB, but it requires more processing power and is not as widely supported. sRGB, on the other hand, is a standard color space that is widely supported by most devices and applications.</p>
<h1 id="degamma"><a class="markdownIt-Anchor" href="#degamma"></a> Degamma</h1>
<p>Degamma is a process used in digital image and video processing to reverse the gamma correction that is applied to images or videos during encoding. Gamma correction is a non-linear operation that is used to compensate for the non-linear response of human vision to changes in brightness.</p>
<p>Degamma is the process of undoing this non-linear operation to restore the original linear image or video data. This is done to enable further processing or analysis of the image or video data in a linear color space.</p>
<p>During encoding, gamma correction is applied to the image or video data in order to make it easier to display on devices with non-linear displays, such as computer monitors, televisions, and projectors. However, this gamma correction can make it more difficult to perform accurate color grading or other image processing tasks.</p>
<p>Degamma is typically performed by applying an inverse gamma curve to the encoded image or video data. This inverse curve is used to undo the effects of the gamma correction and restore the original linear data. Once the data has been degammaed, it can be processed or analyzed in a linear color space, enabling more accurate color grading and other image processing operations.</p>
<h1 id="pq"><a class="markdownIt-Anchor" href="#pq"></a> PQ</h1>
<p>PQ stands for Perceptual Quantizer (æ„ŸçŸ¥é‡åŒ–), which is a type of electro-optical transfer function (ç”µå…‰è½¬æ¢å‡½æ•°) used in high dynamic range (HDR) displays. HDR displays are capable of displaying a wider range of brightness and color than standard dynamic range (SDR) displays, and the PQ transfer function is designed to enable this increased range.</p>
<p>The PQ transfer function is based on human perception of brightness, and it is designed to be more perceptually uniform than traditional gamma curves used in SDR displays. This means that the PQ curve better matches the way that humans perceive changes in brightness, making it easier to display HDR content that looks natural and realistic.</p>
<p>The PQ curve is defined by the International Electrotechnical Commission (IEC) standard IEC 2100-1, and it is used in several HDR standards, including Dolby Vision and HDR10+. The PQ curve maps a range of input values to a range of output values, allowing HDR displays to accurately represent a wide range of brightness and color.</p>
<p>Overall, the PQ transfer function enables HDR displays to deliver a more immersive and realistic viewing experience, with brighter highlights, deeper shadows, and more vibrant colors than SDR displays.</p>
<h1 id="android-hwc"><a class="markdownIt-Anchor" href="#android-hwc"></a> Android HWC</h1>
<p>HWC stands for Hardware Composer. It is a component of the Android operating system that manages the rendering of graphical elements on the screen. It is responsible for taking the output of the various graphical layers in the system, such as the user interface, apps, and games, and compositing them into a single image to be displayed on the screen. The HWC works in conjunction with the graphics hardware on the device to ensure efficient and seamless rendering of the graphical elements. It plays a crucial role in providing a smooth and responsive user experience on Android devices.</p>
<h2 id="why-does-hwc-represent-hardware-composer-rather-than-hardware-compositor"><a class="markdownIt-Anchor" href="#why-does-hwc-represent-hardware-composer-rather-than-hardware-compositor"></a> Why does HWC represent hardware composer rather than hardware compositor</h2>
<p>The term â€œcomposerâ€ is used in reference to HWC because it is responsible for composing, or combining, the various graphical layers into a single image that can be displayed on the screen. The term â€œcompositorâ€ could also be used to describe this function, but â€œcomposerâ€ is the term that has been traditionally used in the field of computer graphics to describe this type of operation. Additionally, the term â€œcomposerâ€ may be seen as more descriptive of the creative process of combining visual elements, while â€œcompositorâ€ may be seen as more technical in nature. Ultimately, the choice of terminology is a matter of convention and personal preference.</p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>DRM/KMS</tag>
      </tags>
  </entry>
  <entry>
    <title>Light Display Manager</title>
    <url>/gfx/lightdm/</url>
    <content><![CDATA[<p><a href="https://wiki.archlinux.org/title/LightDM">Light Display Manager</a> æ˜¯ä¸€ä¸ªè½»é‡çº§çš„è·¨æ¡Œé¢ç¯å¢ƒçš„ Display Manager, å¯ä»¥æ”¯æŒå¤šç§æ˜¾ç¤ºæŠ€æœ¯ï¼Œå¦‚ X11, Mir, Wayland.</p>
<h1 id="build"><a class="markdownIt-Anchor" href="#build"></a> Build</h1>
<h3 id="dependencies"><a class="markdownIt-Anchor" href="#dependencies"></a> Dependencies</h3>
<ul>
<li>
<p>å¼€å‘åŒ…ä¾èµ–</p>
<ul>
<li>libpam0g-dev</li>
<li>libgcrypt20-dev</li>
<li>libglib2.0-dev</li>
<li>libxklavier-dev</li>
</ul>
</li>
<li>
<p>æ„å»ºå·¥å…·ä¾èµ–</p>
<ul>
<li>intltool</li>
<li>yelp-tools</li>
<li>gtk-doc-tools</li>
</ul>
</li>
<li>
<p>å®‰è£…</p>
</li>
</ul>
<p>Lightdm å¯æ‰§è¡Œç¨‹åºè·¯å¾„ <code>/usr/sbin/lightdm</code>, æ—¥å¿—é»˜è®¤è·¯å¾„ <code>/var/log/lightdm/lightdm.log</code>. æ‰€ä»¥æ„å»ºæ—¶å¯ä»¥ä½¿ç”¨</p>
<ul>
<li><code>--prefix</code> æŒ‡å®šå®‰è£…è·¯å¾„ (é»˜è®¤ /usr/local)</li>
<li><code>--localstatedir</code> æŒ‡å®šæ—¥å¿—è·¯å¾„ (é»˜è®¤ $prefix/var/log/lightdm)</li>
<li><code>--sysconfdir</code> æŒ‡å®š <code>lightdm.conf</code> è·¯å¾„ ï¼ˆé»˜è®¤ $prefix/etc/lightdm)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./autogen.sh --prefix=/usr --localstatedir=/var --sysconfdir=/etc --disable-tests</span><br><span class="line">make -j $JOBS</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<h1 id="graphics-boot-up"><a class="markdownIt-Anchor" href="#graphics-boot-up"></a> Graphics Boot-up</h1>
<pre><code class="highlight mermaid">flowchart TD
    A[&quot;systemd&quot;]
    B[&quot;/usr/sbin/lightdm&quot;]
    C[&quot;`[Seat:*]
        # Dump core
        xserver-command=X -core`&quot;]
    D[&quot;`X
        Symbolic link to Xorg`&quot;]

    A -- lightdm.service --&gt; B -- /usr/share/lightdm/lightdm.conf.d/50-xserver-command.conf --&gt; C --&gt; D</code></pre>
<p>P.S. <code>lightdm --show-config</code> å¯ä»¥æ˜¾ç¤ºä¸ lightdm ç›¸å…³çš„é…ç½®</p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>X11</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¸²æŸ“å’Œé€æ˜¾</title>
    <url>/gfx/mesa-dri3/</url>
    <content><![CDATA[<p><img src="/images/mesa-dri3/backbuffer3.png" alt="render &amp; present" /></p>
<span id="more"></span>
<h1 id="æ¸²æŸ“"><a class="markdownIt-Anchor" href="#æ¸²æŸ“"></a> æ¸²æŸ“</h1>
<p>æ¸²æŸ“ç”±æ˜¾å¡(æˆ– SoC)ä¸Šçš„ GPU å®Œæˆï¼Œç®€å•æ¥è¯´å°±æ˜¯å¾€åç¼“å†² (Back Buffer) é‡Œå“å“å“å¹²<strong>åƒç´ </strong>ï¼Œä¸€èˆ¬è¦æ¯”åé¢çš„æ˜¾ç¤ºå¿«å¾—å¤š(æ‰€ä»¥æœ‰äº›åƒç´ ä¼šè¢«è¦†ç›–æ‰ï¼Œæˆ‘ä»¬çœ‹åˆ°çš„å°±æ˜¯æ’•è£‚ <strong>Tearing</strong>)</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> loader_dri3_buffer *</span><br><span class="line"><span class="title function_">dri3_alloc_render_buffer</span><span class="params">(<span class="keyword">struct</span> loader_dri3_drawable *draw,</span></span><br><span class="line"><span class="params">                         <span class="type">unsigned</span> <span class="type">int</span> fourcc,</span></span><br><span class="line"><span class="params">                         <span class="type">int</span> width, <span class="type">int</span> height, <span class="type">int</span> depth)</span>;</span><br></pre></td></tr></table></figure>
<p><code>dri3_alloc_render_buffer()</code> çš„ä»»åŠ¡æ˜¯åˆ›å»ºæ¸²æŸ“ buffer (åŒ…æ‹¬ front æˆ– back), å¹¶å‘ X11 å¯¼å‡ºå®ƒä»¬çš„ fdã€‚é©±åŠ¨å½“ç„¶ä¸æ˜¯ä¸€ä¸‹å­æŠŠ <code>buffers[]</code> æ•°ç»„å¡«æ»¡ï¼Œ å®ƒæ˜¯&quot;æŒ‰éœ€åˆ›å»º&quot;ï¼Œ <code>buffers[]</code> åƒæ˜¯æä¾›è¿™ä¹ˆå¤š buffer slot, å½“ slot åé¢æ˜¯ä¸€ä¸ªç©ºé—²çš„ buffer, é‚£å°±å°†å®ƒè¿”å›ï¼Œå¦åˆ™æ‰çœŸæ­£åˆ›å»ºã€‚</p>
<h2 id="drawable-å’Œ-buffer"><a class="markdownIt-Anchor" href="#drawable-å’Œ-buffer"></a> Drawable å’Œ Buffer</h2>
<p><code>struct loader_dri3_drawable</code> å’Œ <code>struct loader_dri3_buffer</code> è¿™ä¸¤ä¸ªç»“æ„ä½“ï¼Œä¸€ä¸ªä½œä¸º <code>dri3_alloc_render_buffer()</code> çš„ä¸»è¦å‚æ•°ï¼Œä¸€ä¸ªä½œä¸ºå®ƒçš„è¿”å›å€¼ç±»å‹ï¼Œå¯è°“æ˜¯äº†è§£ DRI3 æ‰©å±•ä¸‹çš„æ•°æ®æµçš„å…³é”®ã€‚</p>
<pre><code class="highlight mermaid">classDiagram
    direction RL
    m_loader_dri3_buffer o-- loader_dri3_buffer : LOADER_DRI3_NUM_BUFFERS
    class loader_dri3_drawable &#123;
        +xcb_connection_t * conn
        +xcb_screen_t * screen
        +__DRIdrawable *dri_drawable
        +xcb_drawable_t drawable
        +xcb_window_t window
        +int width
        +int height
        +int depth
        +uint8_t have_back
        +uint8_t have_fake_front
        +uint64_t send_sbc
        +uint64_t recv_sbc
        +uint64_t ust
        +uint64_t msc
        +uint64_t notify_ust
        +uint64_t notify_msc
        +int cur_back
        +int cur_num_back
        +int max_num_back
        +int cur_blit_source
        +uint32_t *stamp
    &#125;
    class m_loader_dri3_buffer &#123;
        +loader_dri3_buffer *buffers[5]
    &#125;
    class loader_dri3_buffer&#123;
        +__DRIimage * image
        +uint32_t pixmap
        +__DRIimage * linear_buffer
        +uint32_t fence
        +xshmfence * shm_fence
        +bool busy
        +bool own_pixmap
        +bool reallocate
        +uint32_t num_planes
        +uint32_t size
        +int strides[4]
        +int offsets[4]
        +uint64_t modifier
        +uint32_t cpp
        +uint32_t flags
        +uint32_t width
        +uint32_t height
        +uint64_t last_swap
    &#125;</code></pre>
<h2 id="åŒæ­¥"><a class="markdownIt-Anchor" href="#åŒæ­¥"></a> åŒæ­¥</h2>
<ul>
<li>å½“æˆ‘ä»¬è°ˆè®º X client å’Œ server ä¹‹é—´çš„ Buffer åŒæ­¥æ—¶æ˜¯åœ¨è¯´ä»€ä¹ˆï¼Ÿ</li>
</ul>
<p>åœ¨DRI3æ‰©å±•ä¸‹, render buffer (BOä½œä¸ºGPU çš„render target) æ˜¯ä¸€å¼€å§‹ç”±X client (ä¾‹å¦‚ä¸€ä¸ª 3D App)åˆ›å»ºçš„(å¯èƒ½ä¸æ­¢ä¸€ä¸ª), render buffer åˆ›å»ºå¥½åéšå³ä¼šé€šè¿‡ __DRIimageExtension çš„ <code>queryImage()</code> æŸ¥è¯¢åˆ°è¯¥buffer çš„ FD (drmPrimeHandleToFD, åé¢ä¼šå°†è¯¥ FD ä¼ é€ç»™ X server), è€Œåœ¨ X çš„ compositor, æ‹¿åˆ° GPU çš„æ¸²æŸ“ç»“æœå®é™…ä¸Šå°±æ˜¯é€šè¿‡è¯¥ FD (drmPrimeFDToHandle) å°† render buffer <code>gbm_bo_import()</code> åˆ° X server è¿›ç¨‹, å¹¶åˆ›å»ºX çš„ Pixmap (Pixmap çš„Backing BOå°±æ˜¯å½“åˆAppè¿›ç¨‹åˆ›å»ºçš„)åè¯»å–æ¸²æŸ“ç»“æœè¿›è¡Œåˆæˆã€‚</p>
<p>è¯¥è¿‡ç¨‹é€šè¿‡ X client å’Œ server è¿›ç¨‹é—´çš„ buffer å…±äº«å®ç°äº† render buffer çš„é›¶æ‹·è´ã€‚<br />
è€ŒåŒæ­¥é—®é¢˜ä¹Ÿåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­äº§ç”Ÿï¼Œå½“ render buffer è¢« server è¿›ç¨‹å¯¼å…¥åç”¨äºåˆæˆæ—¶ï¼Œæ¸²æŸ“ç»“æœä»€ä¹ˆæ—¶å€™è¢«è¯»å–å®Œæ¯•(render buffer IDLE çŠ¶æ€)ï¼Œéœ€è¦å‘ŠçŸ¥client è¿›ç¨‹(clientä¸èƒ½åœ¨ä¸Šä¸€å¸§æ•°æ®æœªè¯»å–å®Œæ¯•å‰åŒæ—¶å†æ¸²æŸ“åˆ°åŒä¸€ä¸ªrender buffer)ã€‚åŒæ ·client ä¹Ÿé¡»åœ¨ server è¯»å–å½“å‰å¸§ä¹‹å‰å‘ŠçŸ¥server æ¸²æŸ“æ˜¯å¦å·²ç»å®Œæˆã€‚</p>
<p>è¿™æ · X client å’Œ server ä¹‹é—´çš„buffer åŒæ­¥é—®é¢˜å°±äº§ç”Ÿäº†ã€‚</p>
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/lib/libxshmfence">xshmfence mapping to X SyncFence</a>
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/lib/libxshmfence/-/blob/master/src/xshmfence_alloc.c?ref_type=heads#L69"><code>xshmfence_alloc_shm()</code></a> é€šè¿‡<code>memfd_create()/shm_open()/open()</code> ä¹‹ä¸€ç³»ç»Ÿè°ƒç”¨è¿”å›ä¸€ä¸ªå…±äº«å†…å­˜æ–‡ä»¶æè¿°ç¬¦(fence_fd)</li>
<li><a href="https://gitlab.freedesktop.org/xorg/lib/libxshmfence/-/blob/master/src/xshmfence_alloc.c?ref_type=heads#L128"><code>xshmfence_map_shm(fence_fd)</code></a> é€šè¿‡ <code>mmap()</code> fence_fd è¿”å›ä¸€ä¸ªæŒ‡å‘ struct xshmfence çš„åœ°å€</li>
<li><a href="https://gist.github.com/lucmann/2a6e24338cdae55ac359af3d25ddf2da#file-dri3-c-L377"><code>xcb_dri3_fence_from_fd()</code></a> å°†è¿™ä¸ª xshmfence çš„ fence_fd å‘é€ç»™ X server, è®©å…¶çŸ¥é“è¿™ä¸ªxshmfence çš„å­˜åœ¨</li>
</ul>
</li>
</ul>
<p>ä»¥ä¸Š3æ­¥å®é™…ä¸Šæ˜¯åˆ©ç”¨4ä¸ªå­—èŠ‚(<code>sizeof(struct xshmfence)</code>)å¤§å°çš„å…±äº«å†…å­˜åœ¨X server å’Œ client è¿›ç¨‹é—´é€šè¿‡åŸå­æ“ä½œå’Œ futex ç³»ç»Ÿè°ƒç”¨è¾¾åˆ°ä¸¤ä¸ªè¿›ç¨‹å¯¹ render buffer çš„åŒæ­¥è®¿é—®ã€‚</p>
<p>(ä»¥ä¸Š4ä¸ªå­—èŠ‚å…±äº«å†…å­˜çš„ç»“è®ºæ˜¯åŸºäºfutexå’ŒåŸå­æ“ä½œå®ç°çš„ xshmfence çš„ç‰ˆæœ¬)</p>
<p>ç”±äºclient åˆ›å»ºçš„render buffer æ˜¯ä¸ X server å…±äº«çš„ï¼Œæ‰€ä»¥è¿™ä¸ª render buffer è¢«ä¸¤ä¸ªè¿›ç¨‹è¯»å†™æ—¶é¡»è¦åŒæ­¥ï¼ŒMesa3D ä¸­æ˜¯ä½¿ç”¨ xshmfence æ¥å®Œæˆè¿™ä¸ªéœ€æ±‚çš„ã€‚xshmfence é¡¾åæ€ä¹‰å®ƒæ˜¯åŸºäºå…±äº«å†…å­˜çš„ï¼Œé‡‡ç”¨å®ƒå®ç°è¿›ç¨‹é—´å¯¹ render buffer æ“ä½œçš„åŒæ­¥ï¼Œå¥½å¤„å°±æ˜¯åªéœ€è¦å°† xshmfence æ˜ å°„åˆ°ä¸€ä¸ª X server SyncFence, é€šè¿‡ä¸€ä¸ªç®€å•çš„å‡½æ•°è°ƒç”¨(<a href="https://gitlab.freedesktop.org/xorg/lib/libxshmfence/-/blob/master/src/xshmfence_futex.c?ref_type=heads#L60">xshmfence_await(struct xshmfence *f)</a>)å°±å¯å°†è°ƒç”¨è¿›ç¨‹(client process)é˜»å¡ç›´åˆ° X server å®Œæˆå¯¹ render bufferçš„æ“ä½œå†è¢«æ“ä½œç³»ç»Ÿå”¤é†’ï¼Œè€Œæ— éœ€é€šè¿‡æ¥æ”¶ç½‘ç»œäº‹ä»¶(socket event)æ¥ç¡®å®šX server æ˜¯å¦å·²ç»å®Œæˆå¯¹ render buffer çš„ä½¿ç”¨ã€‚</p>
<h2 id="å¯¼å…¥å¯¼å‡º"><a class="markdownIt-Anchor" href="#å¯¼å…¥å¯¼å‡º"></a> å¯¼å…¥/å¯¼å‡º</h2>
<p>render buffer çš„å¯¼å…¥/å¯¼å‡ºæ“ä½œæ˜¯Linux ä¸‹<a href="https://www.kernel.org/doc/html/latest/driver-api/dma-buf.html">Buffer å…±äº«å’ŒåŒæ­¥</a>çš„ä¸€ä¸ªæ ‡å‡†æµç¨‹ï¼Œä¸ä»…ä»…æ˜¯åœ¨ DRM å­ç³»ç»Ÿä½¿ç”¨ï¼Œåœ¨Linuxçš„å…¶å®ƒå­ç³»ç»Ÿä¹Ÿå¹¿æ³›ä½¿ç”¨ï¼Œå¦‚Video4Linux, Networkingã€‚è¿™é‡Œä»…ä»…å°† mesa ä¸­çš„å®ç°ä¸DMABUF æœºåˆ¶ä¸­çš„è§’è‰²å¯¹åº”ä¸€ä¸‹ï¼Œä½œä¸ºä¸€ä¸ªDMABUFçš„åº”ç”¨æ¡ˆä¾‹åˆ†æã€‚</p>
<ul>
<li>
<p>å¯¼å‡º(exporterÂ·mesa)</p>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/loader_dri3/loader_dri3_helper.c#L1602"><code>image-&gt;queryImage(image, __DRI_IMAGE_ATTRIB_FD, &amp;buffer_fds[i])</code></a>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/gallium/frontends/dri/dri2.c#L1476"><code>dri2_query_image(image, attrib, *value)</code></a>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/gallium/frontends/dri/dri2.c#L1350"><code>dri2_query_image_by_resource_handle(image, attrib, *value)</code></a>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/gallium/drivers/r600/r600_texture.c#L556"><code>pipe_screen-&gt;resource_get_handle(pscreen, NULL, image-&gt;texture, &amp;whandle, usage)</code></a>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/gallium/winsys/radeon/drm/radeon_drm_bo.c#L1331"><code>radeon_winsys_bo_get_handle(rws, buffer, *whandle)</code></a>
<ul>
<li>drmPrimeHandleToFD()</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>(ä»¥ä¸Šè°ƒåˆ°pipe_screenåä»¥AMD Radeoné©±åŠ¨ä¸ºä¾‹)</p>
</li>
<li>
<p>ä¼ é€(FD transferÂ·xcb)</p>
  <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">xcb_protocol_request_t</span> xcb_req = &#123;</span><br><span class="line">    .count = <span class="number">2</span>,</span><br><span class="line">    .ext = &amp;xcb_dri3_id,</span><br><span class="line">    .opcode = XCB_DRI3_PIXMAP_FROM_BUFFERS,</span><br><span class="line">    .isvoid = <span class="number">1</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://gist.github.com/lucmann/2a6e24338cdae55ac359af3d25ddf2da#file-dri3-c-L676"><code>xcb_dri3_pixmap_from_buffers()</code></a>
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/lib/libxcb/-/blob/master/src/xcb_out.c#L225"><code>xcb_send_request_with_fds()</code></a>
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/lib/libxcb/-/blob/master/src/xcb_out.c#L190"><code>send_fds(xcb_connection_t *, fds, num_fds)</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>å¯¼å…¥(importerÂ·xserver)</p>
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/xserver/-/blob/master/dri3/dri3_request.c#L490"><code>proc_dri3_pixmap_from_buffers(ClientPtr client)</code></a>
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/xserver/-/blob/master/dri3/dri3_screen.c#L63"><code>dri3_pixmap_from_fds()</code></a>
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/xserver/-/blob/master/glamor/glamor_egl.c#L612"><code>glamor_pixmap_from_fds()</code></a>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/gbm/main/gbm.c#L583"><code>gbm_bo_import(gbm_device *, GBM_BO_IMPORT_FD_MODIFIER, &amp;import_data, 0)</code> (libgbm.so)</a>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/gbm/backends/dri/gbm_dri.c#L801"><code>image-&gt;createImageFromDmaBufs()</code> (libgbm.so)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>(ä¸éš¾çœ‹å‡ºå¦‚æœé©±åŠ¨æ”¯æŒDRI3, åˆ™æœ‰ä»¥ä¸‹ä¾èµ–å…³ç³» <strong>Xserver-&gt;Glamor-&gt;GBM</strong>)</p>
</li>
<li>
<p>mesa dri3 render buffer (DMABUF) Sharing</p>
</li>
</ul>
<pre><code class="highlight mermaid">sequenceDiagram
    autonumber
    participant App
    participant Mesa
    participant X11

    App--&gt;&gt;Mesa: eglMakeCurrent()
    Mesa-&gt;&gt;Mesa: dri_st_framebuffer_validate()
    Mesa-&gt;&gt;Mesa: dri2_allocate_textures()
    Mesa-&gt;&gt;Mesa: loader_dri3_get_buffers()
    note left of Mesa: Return all necessary buffers and allocating as needed
    Mesa-&gt;&gt;Mesa: dri3_get_buffer()
    rect rgb(191, 223, 255)
    Mesa-&gt;&gt;Mesa: dri3_alloc_render_buffer()
    Mesa--&gt;&gt;X11: xcb_dri3_get_supported_modifiers()
    X11--&gt;&gt;Mesa: xcb_dri3_get_supported_modifiers_reply()
    Mesa-&gt;&gt;Mesa: loader_dri_create_image()
    Mesa-&gt;&gt;Mesa: dri2_create_image()
    Mesa-&gt;&gt;Mesa: xxx_resource_create()
    rect rgb(200, 150, 255)
    Mesa-&gt;&gt;Mesa: dri2_query_image_by_resource_handle(__DRIimage)
    Mesa-&gt;&gt;Mesa: xxx_resource_get_handle()
    Mesa-&gt;&gt;Mesa: xxx_bo_export()
    note right of Mesa: Mesa å¯¼å‡º FD
    opt xcb_dri3_pixmap_from_buffers(buffer_fds)
        Mesa--&gt;&gt;X11: xcb_send_requests_with_fds(buffer_fds)
    end
    end
    rect rgb(200, 150, 255)
    note left of X11: X11 å¯¼å…¥ Buffer
    X11-&gt;&gt;X11: proc_dri3_pixmap_from_buffers()
    X11-&gt;&gt;X11: dri3_pixmap_from_fds()
    X11-&gt;&gt;X11: glamor_pixmap_from_fds()
    alt GBM_BO_WITH_MODIFIERS
        X11-&gt;&gt;X11: gbm_bo_import(type=GBM_BO_IMPORT_FD_MODIFIER)
    else
        X11-&gt;&gt;X11: gbm_bo_import(type=GBM_BO_IMPORT_FD)
    end
    end
    end</code></pre>
<h2 id="æ‰€æœ‰æƒ…å†µéƒ½æ˜¯-mesa-dri-client-åˆ›å»ºå¯¼å‡º-renderbufferx11-å¯¼å…¥å—"><a class="markdownIt-Anchor" href="#æ‰€æœ‰æƒ…å†µéƒ½æ˜¯-mesa-dri-client-åˆ›å»ºå¯¼å‡º-renderbufferx11-å¯¼å…¥å—"></a> æ‰€æœ‰æƒ…å†µéƒ½æ˜¯ <strong>Mesa (DRI client) åˆ›å»ºå¯¼å‡º RenderBufferï¼ŒX11 å¯¼å…¥</strong>å—?</h2>
<ul>
<li><code>eglCreatePbufferSurface()</code></li>
</ul>
<p>å®é™…ä¸Š PBuffer æ˜¯ç¦»å±æ¸²æŸ“ä½¿ç”¨çš„ï¼Œå®ƒæ˜¯ç”± X11 åˆ›å»º buffer, X11 å¯¼å‡º FD, Mesa (åº”ç”¨è¿›ç¨‹) å¯¼å…¥ä½œä¸ºä¼ªå‰ç¼“å†² (fake front buffer) ä½¿ç”¨ã€‚</p>
<p>é€šå¸¸ <code>eglCreate***Surface()</code> éœ€è¦ App å…ˆè°ƒç”¨ <code>XCreateWindow()</code> è®© X11 åˆ›å»º Pixmap, ä½†æ˜¯ <code>eglCreatePbufferSurface()</code> ä¸ç”¨ï¼Œå®ƒç”± Mesa è°ƒç”¨ <code>xcb_create_pixmap()</code> è®© X11 åˆ›å»º Pixmap, ä¹‹å Mesa å†è°ƒç”¨ <code>xcb_dri3_buffers_from_pixmap()</code> è®© X11 å¯¼å‡º Pixmap(gbm_bo) å…³è”çš„ FD, ç”± Mesa å¯¼å…¥ã€‚</p>
<pre><code class="highlight mermaid">sequenceDiagram
    autonumber
    participant App
    participant Mesa
    participant X11

    App--&gt;&gt;Mesa: eglCreatePbufferSurface()
    rect rgb(191, 223, 255)
    Mesa-&gt;&gt;Mesa: dri3_create_surface(type=EGL_PBUFFER_BIT)
    Mesa--&gt;&gt;X11: xcb_generate_id()
    X11--&gt;&gt;Mesa: drawable ID (uint32_t)
    Mesa--&gt;&gt;X11: xcb_create_pixmap()
    App--&gt;&gt;Mesa: eglBindTexImage()
    Mesa-&gt;&gt;Mesa: dri_st_framebuffer_validate()
    Mesa-&gt;&gt;Mesa: dri2_allocate_textures()
    Mesa-&gt;&gt;Mesa: loader_dri3_get_buffers()
    Mesa-&gt;&gt;Mesa: dri3_get_pixmap_buffer()
    rect rgb(200, 150, 255)
    note left of X11: X11 å¯¼å‡º FD(è°ƒç”¨ gbm_bo_get_fd(gbm_bo*))
    Mesa--&gt;&gt;X11: xcb_dri3_buffers_from_pixmap()
    X11--&gt;&gt;Mesa: xcb_dri3_buffers_from_pixmap_reply()
    Mesa--&gt;&gt;X11: loader_dri3_create_image_from_buffers()
    X11--&gt;&gt;Mesa: xcb_dri3_buffers_from_pixmap_reply_fds()
    end
    rect rgb(200, 150, 255)
    note left of Mesa: Mesa å¯¼å…¥ Buffer
    Mesa-&gt;&gt;Mesa: dri2_from_dma_bufs2()
    Mesa-&gt;&gt;Mesa: dri2_create_image_from_fd()
    Mesa-&gt;&gt;Mesa: dri2_create_image_from_winsys()
    Mesa-&gt;&gt;Mesa: xxx_resource_from_handle()
    Mesa-&gt;&gt;Mesa: xxx_bo_import()
    end
    end</code></pre>
<ul>
<li>DRI2</li>
</ul>
<p>DRI3 ä¸ DRI2 çš„ä¸€ä¸ªä¸»è¦åŒºåˆ«å°±æ˜¯åœ¨ DRI3, RenderBuffer æ˜¯ç”± DRI client (Mesa) åˆ›å»ºåé€šè¿‡ bo_export() å¯¼å‡ºå…¶ DMA-BUF fdï¼Œç”± X server é€šè¿‡ <code>proc_dri3_pixmap_from_buffers()</code> å¯¼å…¥çš„ã€‚ è€Œä¸” DRI2 ä¸ä»…å¯¼å…¥å¯¼å‡ºæ–¹é¢æ˜¯åç€çš„ï¼Œè€Œä¸” DRI client å¯¼å…¥çš„æ˜¯ <a href="https://www.kernel.org/doc/html/v5.1/gpu/drm-mm.html#gem-objects-naming">GEM name</a>(ä¸æ˜¯ DMA-BUF fd), æ®è¯´ GEM name è¿™ç©æ„è™½ç„¶ä¹Ÿå¯ä»¥åœ¨è¿›ç¨‹é—´ä¼ é€’ï¼Œä½†ç›¸æ¯” DMA-BUF fd å¾ˆä¸å®‰å…¨ï¼Œæ‰€ä»¥æ–°é©±åŠ¨éƒ½ç”¨ DMA-BUF fd åœ¨è¿›ç¨‹é—´ä¼ é€’ Buffer, åªæœ‰æ—§é©±åŠ¨å¯èƒ½è¿˜æœ‰ GEM nameã€‚</p>
<p><em>å®ç°ä¸Šæ²¡å¤ªæ˜ç™½ GEM name ä¸ºä»€ä¹ˆä¸å®‰å…¨ï¼Œå¤§å®¶éƒ½æ˜¯ 32-bit æ•´æ•°ï¼ŒGEM name èƒ½è¢«çŒœï¼Œæ–‡ä»¶æè¿°ç¬¦ fd ä¹Ÿèƒ½è¢«çŒœå•Š</em></p>
<p>æ‰¾åˆ°è§£é‡Šäº†ï¼Œ<a href="https://www.kernel.org/doc/html/next/gpu/drm-mm.html#overview-and-lifetime-rules">PRIME Buffer Sharing - Overview and Lifetime Rules</a>, æ–‡ä»¶æè¿°ç¬¦ (file descriptor) å¿…é¡»é€šè¿‡ <strong>UNIX domain sockets</strong> åœ¨åº”ç”¨ä¹‹é—´ sendï¼Œä¸å¯èƒ½åƒå…¨å±€å”¯ä¸€çš„ GEM names ä¸€æ ·è¢«çŒœã€‚ <strong>send over UNIX domain sockets</strong> åº”è¯¥å°±æ˜¯ XCB åº“å®ç°çš„è¿™ä¸ªå‡½æ•° <code>xcb_send_requests_with_fds()</code>ã€‚</p>
<h2 id="dri3_find_back"><a class="markdownIt-Anchor" href="#dri3_find_back"></a> dri3_find_back</h2>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Find an idle back buffer. If there isn&#x27;t one, then</span></span><br><span class="line"><span class="comment"> * wait for a present IdleNotify event from the X server</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">dri3_find_back</span><span class="params">(<span class="keyword">struct</span> loader_dri3_drawable *draw,</span></span><br><span class="line"><span class="params">               <span class="type">bool</span> prefer_a_different)</span>;</span><br></pre></td></tr></table></figure>
<p><code>dri3_find_back()</code> çš„ä»»åŠ¡æ˜¯æŸ¥æ‰¾ <code>buffers[]</code> ä¸­ç©ºé—² buffer çš„ slot (array index), å¦‚æœå­˜åœ¨ï¼Œè¿”å›å…¶ index, å¦åˆ™ç­‰å¾… (<code>dri3_wait_for_event_locked()</code>)</p>
<p>å¦‚ä½•çŸ¥é“ buffer æ˜¯å¦ç©ºé—²å‘¢ï¼Ÿ <code>buffer-&gt;busy</code>, è¿™ä¸ªæ ‡å¿—åœ¨ SwapBuffers æ—¶ä¼šç½®ä¸º true, mesa æ”¶åˆ° IdleNotify äº‹ä»¶åç½®ä¸º false</p>
<pre><code class="highlight mermaid">sequenceDiagram
    autonumber
    participant Mesa
    participant X11

    Mesa-&gt;&gt;Mesa: dri3_find_back
    note right of Mesa: é€‰å–ä¸€ä¸ªåˆé€‚çš„ç©ºé—² slot id, buffers[id]æœ‰å¯èƒ½æ˜¯ç©º, è¿™æ—¶éœ€è¦åˆ›å»º buffer: dri3_alloc_render_buffer()
    rect rgb(200, 150, 255)
    note right of Mesa: mtx_lock()
    alt pefer_a_different==false
        Mesa--&gt;&gt;X11: dri3_flush_present_events()
        loop xcb_poll_for_special_event
            X11--&gt;&gt;Mesa: xcb_present_generic_event_t
        end
        Mesa-&gt;&gt;Mesa: dri3_handle_present_event()
    else perfer_a_different==true
        Mesa--&gt;&gt;X11: xcb_flush()
        loop dri3_wait_for_event_locked()
            X11--&gt;&gt;Mesa: xcb_present_generic_event_t
        end
        Mesa-&gt;&gt;Mesa: dri3_handle_present_event()
    end
    note right of Mesa: mtx_unlock()
    end</code></pre>
<h2 id="loader_dri3_swap_buffers_msc"><a class="markdownIt-Anchor" href="#loader_dri3_swap_buffers_msc"></a> loader_dri3_swap_buffers_msc</h2>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Make the current back buffer visible using the present extension</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int64_t</span></span><br><span class="line"><span class="title function_">loader_dri3_swap_buffers_msc</span><span class="params">(<span class="keyword">struct</span> loader_dri3_drawable *draw,</span></span><br><span class="line"><span class="params">                             <span class="type">int64_t</span> target_msc, <span class="type">int64_t</span> divisor, <span class="type">int64_t</span> remainder,</span></span><br><span class="line"><span class="params">                             <span class="type">unsigned</span> flush_flags,</span></span><br><span class="line"><span class="params">                             <span class="type">const</span> <span class="type">int</span> *rects, <span class="type">int</span> n_rects,</span></span><br><span class="line"><span class="params">                             <span class="type">bool</span> force_copy)</span>;</span><br></pre></td></tr></table></figure>
<pre><code class="highlight mermaid">flowchart TB
  subgraph Render [&quot;æ¸²æŸ“åˆ° back buffer&quot;]
    direction TB
    subgraph RenderBufferAlloc [&quot;Allocate/Pick a back buffer&quot;]
      direction TB
      a1[&quot;dri_make_current()&quot;]
      a2[&quot;st_api_make_current()&quot;]
      a3[&quot;st_framebuffer_validate()&quot;]
      a4[&quot;dri_st_framebuffer_validate()&quot;]
      a5[&quot;dri2_allocate_textures()&quot;]
      a6[&quot;dri_image_drawable_get_buffers()&quot;]
      a7[&quot;loader_dri3_get_buffers()&quot;]
      a8[[&quot;dri3_alloc_render_buffer()&quot;]]
    end
    b[&quot;glDraw*()&quot;]
  end
  A[&quot;eglSwapBuffers()&quot;]
  B[&quot;dri3_swap_buffers()&quot;]
  C[&quot;dri3_swap_buffers_with_damage()&quot;]
  D[&quot;glXSwapBuffers()&quot;]
  E[&quot;dri3_swap_buffers()&quot;]
  subgraph Swap [&quot;loader_dri3_swap_buffers_msc()&quot;]
    direction TB
    G[&quot;loader_dri3_vtable-&gt;flush_drawable()&quot;]
    H[&quot;dri3_find_back_alloc()&quot;]
    I[&quot;dri3_flush_present_events()&quot;]
    J[&quot;xcb_xfixes_create_region()&quot;]
    K[&quot;xcb_xfixes_set_region()&quot;]
    L[&quot;xcb_present_pixmap()&quot;]
    M[&quot;dri_invalidate_drawable()&quot;]
  end
  subgraph Note1 [&quot;è¿”å›è¦é€æ˜¾çš„ back buffer&quot;]
    dummy1[&quot;è¿™é‡Œé€šè¿‡ dri3_find_back()&lt;br&gt;ç¡®ä¿è¿™é‡Œè¿”å›çš„æ˜¯å½“å‰å·²ç»æ¸²æŸ“å¥½çš„(flushed) back buffer&quot;]
  end
  subgraph Note2 [&quot;é€‰å–æˆ–ç”³è¯· back buffer&quot;]
    dummy2[&quot;loader_dri3_drawable-&gt;buffers[]æœ‰5ä¸ª&lt;br&gt;loader_dri3_buffer çš„æ§½ä½&lt;br&gt;ç¬¬1å¸§æ¸²æŸ“æ—¶éœ€è¦è°ƒç”¨&lt;br&gt;dri3_alloc_render_buffer()&lt;br&gt;æ¥ç”³è¯·æ–°çš„back buffer&quot;]
  end

  a1 --&gt; a2 --&gt; a3 --&gt; a4 --&gt; a5 --&gt; a6 --&gt; a7 --&gt; a8 --&gt; b
  b --&gt; A
  b --&gt; D
  A --&gt; B
  B --&gt; C
  D --&gt; E
  C --&gt; G
  E ---&gt; G
  G --&gt; H --&gt; I --&gt; J --&gt; K --&gt; L --&gt; M
  Note1 -.-&gt; H
  Note2 -.-&gt; a8</code></pre>
<h2 id="dri2-throttle"><a class="markdownIt-Anchor" href="#dri2-throttle"></a> DRI2 Throttle</h2>
<p>è¿™ä¸ªæ‰©å±•åŸæ¥å¥½åƒæ˜¯æ§åˆ¶ DRI client èƒ½åŒæ—¶å¹¶å‘åœ°æ¸²æŸ“å¤šå°‘ä¸ª RenderBuffer (æˆ–è€…è¯´å¤šå°‘å¸§)çš„ï¼Œå› ä¸ºåŸæ¥ mesa é‡Œæœ‰ä¸€ä¸ª <code>PIPE_CAP_MAX_FRAMES_IN_FLIGHT</code>, å› ä¸ºè¿™ä¸ªå€¼åæ¥è¦ä¹ˆæ˜¯ 1ï¼Œ è¦ä¹ˆæ˜¯ 0ï¼Œå°±è¢«æ”¹æˆ <a href="https://docs.mesa3d.org/gallium/screen.html?highlight=pipe_cap_throttle"><code>PIPE_CAP_THROTTLE</code></a> äº†, é»˜è®¤æ˜¯ throttle çš„, æŒ‰ç›®å‰çš„å®ç°ï¼Œå¦‚æœèŠ‚æµäº†ï¼Œå°±æ˜¯è¯´å½“é©±åŠ¨æäº¤äº†ç¬¬ 2 å¸§çš„æ¸²æŸ“å‘½ä»¤åï¼Œè¦ç­‰ç¬¬ 1 å¸§æ¸²æŸ“å®Œæˆ (pipe_fence_handle æ˜¯ drm_syncobj çš„å°è£…)ï¼Œæ‰èƒ½ç»§ç»­å‡†å¤‡ç¬¬ 3 å¸§çš„æ¸²æŸ“å‘½ä»¤ã€‚</p>
<pre><code class="highlight mermaid">flowchart LR
    subgraph &quot;Frame 0&quot;
        F1[&quot;CPU Submit 1&quot;]
    end
    subgraph &quot;Frame 1&quot;
        F2[&quot;CPU Submit 2&quot;]
        R1[&quot;GPU Render Done 1 fa:fa-spinner&quot;]
    end
    subgraph &quot;Frame 2&quot;
        F3[&quot;CPU Submit 3&quot;]
        R2[&quot;GPU Render Done 2 fa:fa-spinner&quot;]
    end
    subgraph &quot;Frame 3&quot;
        F4[&quot;CPU Submit 4&quot;]
        R3[&quot;GPU Render Done 3 fa:fa-spinner&quot;]
    end

    F1 --&gt; F2
    F2 --Block until--&gt; R1 --&gt; F3
    F3 --Block until--&gt; R2 --&gt; F4
    F4 --Block until--&gt; R3</code></pre>
<p>Throttle çš„æ•ˆæœæ˜¯ CPU åœ¨æäº¤åä¸€å¸§çš„æ¸²æŸ“å‘½ä»¤åï¼Œè¦ç­‰(æ‰€è°“â€œç­‰â€å°±æ˜¯ä¸»çº¿ç¨‹è°ƒç”¨ <code>drmSyncobjWait()</code> é˜»å¡)å‰ä¸€å¸§æ¸²æŸ“å®Œæˆåæ‰å”¤é†’ç»§ç»­å‡†å¤‡ä¸‹ä¸€å¸§æ•°æ®ï¼Œæ•´ä¸ªè¿‡ç¨‹å®é™…ä¸Šæ˜¯èŠ‚æµ CPU, æ˜¯è®©ç”Ÿäº§è€…-æ¶ˆè´¹è€…ä¸­çš„<strong>ç”Ÿäº§è€…(CPU)</strong> æ…¢ä¸€ç‚¹ã€‚æ‰€ä»¥ DRI2 Throttle çš„æœ¬æ„å°±æ˜¯åœ¨ GPU æ¸²æŸ“ä»»åŠ¡æ¯”è¾ƒé‡(å»¶è¿Ÿå¤§)çš„æ—¶å€™ï¼ŒCPU è¿™è¾¹æ²¡å¿…è¦â€œç©å‘½â€å‡†å¤‡æ•°æ®ï¼Œå¦åˆ™åè€Œä¼šå¯¼è‡´æ¯”å¦‚è¿‡å¤šæ¶ˆè€—æ˜¾å­˜ç­‰å…¶å®ƒé—®é¢˜ã€‚</p>
<p>Mesa ä¸­å¯¹ Throttle çš„å®ç°å¾ˆæœ‰æŠ€å·§æ€§ã€‚å› ä¸ºè¿™é‡Œâ€œç­‰â€çš„æ˜¯ä¸Šä¸€å¸§æ•°æ®æäº¤ç»™å†…æ ¸åï¼Œdrm_gpu_scheduler ä¸ºè¿™ä¸ª job åˆ›å»ºçš„ä¸€ä¸ª <code>dma_fence</code>, åœ¨æäº¤æ—¶ï¼Œuserspace ä¼šç»™ kernel ä¸€ä¸ª syncobj (å½“ä¸€ä¸ª fence å®¹å™¨ç”¨ï¼Œæ„æ€æ˜¯ gpu scheduler åˆ›å»ºå¥½ fence å attach åˆ°è¿™ä¸ª syncobj, userspace å°±å¯ä»¥é€šè¿‡ <code>drmSyncobjWait()</code> é˜»å¡å¼åœ°ç­‰ syncobj åŒ…å«çš„ fence æ˜¯å¦è¢« signaled)ã€‚ å› ä¸º fence æ˜¯åœ¨æ¸²æŸ“å‘½ä»¤ push åˆ° drm_gpu_scheduler åå†…æ ¸æ‰åˆ›å»ºçš„, æ‰€ä»¥æäº¤æ—¶å¸¦ä¸‹å»çš„ syncobj ç”¨æ¥è£…å½“å‰äº§ç”Ÿçš„ fenceï¼Œå¦‚æœä½ éœ€è¦åœ¨ä¸‹ä¸€å¸§æ•°æ®æäº¤åç­‰ä¸Šä¸€å¸§çš„ fence, ä½ éœ€è¦åœ¨å½“å‰å¸§æäº¤åï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ syncobj æ¥å­˜å½“å‰å¸§çš„ fenceï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸‹ä¸€å¸§æäº¤åï¼Œ ç”¨è¿™ä¸ªæ–°çš„ syncobj æ¥ç­‰ä¸Šä¸€å¸§çš„ fence äº†ã€‚ <strong>ç›¸å½“äºåŒä¸€ä¸ª fence æ”¾åœ¨ä¸¤ä¸ªä¸åŒçš„å®¹å™¨é‡Œç”¨</strong>ã€‚</p>
<h1 id="é€æ˜¾"><a class="markdownIt-Anchor" href="#é€æ˜¾"></a> é€æ˜¾</h1>
<p>å¦‚æœå¹³å°çš„çª—å£ç³»ç»Ÿ(Winsys)æ˜¯X11, åˆ™é€æ˜¾ä¸»è¦æ˜¯é€šè¿‡ Present æ‰©å±•å®Œæˆçš„ã€‚Client (ä»£ç ä¸»è¦åœ¨ UMD) ä¸ X Server çš„äº¤äº’ä¸»è¦é€šè¿‡ <a href="https://gitlab.freedesktop.org/xorg/xserver/-/blob/master/present/present_priv.h#L226">present_event</a> å®Œæˆçš„ï¼Œ <code>present_event</code> ä¸»è¦æœ‰ä»¥ä¸‹ 3 ä¸ª:</p>
<ul>
<li>XCB_PRESENT_EVENT_CONFIGURE_NOTIFY</li>
<li>XCB_PRESENT_EVENT_COMPLETE_NOTIFY
<ul>
<li>è¿™ä¸ªäº‹ä»¶ä¼ è¾¾çš„ä¸»è¦ä¿¡æ¯æ˜¯ <strong>X Server æ˜¯ä»¥å“ªç§æ¨¡å¼ä¸Šå±åˆšæ‰é€æ˜¾çš„ Back Buffer çš„</strong>(æ³¨æ„æ˜¯<strong>è¿‡å»å®Œæˆæ—¶</strong>), ä¸»è¦æœ‰ 4 ç§æ¨¡å¼
<ul>
<li>XCB_PRESENT_COMPLETE_MODE_COPY
<ul>
<li>å‡ ä¹æ‰€æœ‰çš„ 3D åº”ç”¨(é™¤äº†åƒ KWin è¿™æ ·çš„ compositor)åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹é€æ˜¾çš„ Back Buffer éƒ½æ˜¯ä»¥è¿™ç§æ¨¡å¼ä¸Šå±çš„ã€‚å› ä¸ºä¸€èˆ¬çš„åº”ç”¨ä¸æ˜¯å…¨å±ï¼Œä¸å¯èƒ½ç›´æ¥<strong>FLIP (æ”¹ä¸€ä¸‹ DC Framebuffer base register)</strong></li>
</ul>
</li>
<li>XCB_PRESENT_COMPLETE_MODE_FLIP
<ul>
<li>åƒ KWin åˆæˆå™¨åˆæˆçš„<strong>å…¨å±</strong> screen image ä¸Šå±ä¸€èˆ¬æ˜¯è¿™ç§æ¨¡å¼ï¼Œè¿™ç§æ–¹å¼æ˜¾ç„¶è¦æ¯” COPY å¿«å¾ˆå¤š</li>
</ul>
</li>
<li>XCB_PRESENT_COMPLETE_MODE_SKIP
<ul>
<li>å¦‚æœ PresentCompleteNotify ä¼ å›çš„æ˜¯è¿™ä¸ªæ¨¡å¼ï¼Œä¸å¥½æ„æ€ï¼ŒX Server å¹¶æ²¡æœ‰æŠŠåˆšæ‰é€æ˜¾çš„ Back Buffer ä¸Šå±ï¼Œè¿™æ„å‘³ç€<strong>ä¸¢å¸§</strong></li>
</ul>
</li>
<li>XCB_PRESENT_COMPLETE_MODE_SUBOPTIMAL_COPY
<ul>
<li>å¦‚æœ PresentCompleteNotify ä¼ å›çš„æ˜¯è¿™ä¸ªæ¨¡å¼ï¼Œè¡¨æ˜å¦‚æœä¸‹æ¬¡ç”¨ä¸åŒçš„ <strong>format/modifier</strong> é‡æ–°ç”³è¯·ä¸€ä¸ª Back bufferï¼ŒX Server å¾ˆå¯èƒ½å°±å¯ä»¥ä»¥ <strong>FLIP</strong> æ¨¡å¼ä¸Šå± Back buffer</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>XCB_PRESENT_EVENT_IDLE_NOTIFY</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">present_event</span> &#123;</span></span><br><span class="line">    present_event_ptr next;</span><br><span class="line">    ClientPtr client;</span><br><span class="line">    WindowPtr window;</span><br><span class="line">    XID id;</span><br><span class="line">    <span class="type">int</span> mask;</span><br><span class="line">&#125; present_event_rec;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>æ³¨å†Œäº‹ä»¶</p>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/loader_dri3/loader_dri3_helper.c#L1709"><code>dri3_setup_present_event(struct loader_dri3_drawable *draw)</code></a>
<ul>
<li><a href="https://gist.github.com/lucmann/2a6e24338cdae55ac359af3d25ddf2da#file-present-c-L398"><code>xcb_present_select_input()</code></a>: å‘Šè¯‰Xserverï¼Œclient æ­£åœ¨ç›‘å¬å“ªäº›äº‹ä»¶ã€‚(æ³¨å†Œæ—¶å®é™…ä¸Šæ˜¯ä½¿ç”¨å¯¹åº”äº‹ä»¶çš„ MASK æ³¨å†Œçš„ï¼Œå› ä¸ºåœ¨å‘ Xserver å‘é€çš„æ³¨å†Œæ¶ˆæ¯ä¸­ï¼Œæ³¨å†Œçš„æ‰€æœ‰æ¶ˆæ¯çš„MASK ORing åœ¨ä¸€ä¸ª uint32_t <a href="https://gist.github.com/lucmann/2a6e24338cdae55ac359af3d25ddf2da#file-present-c-L416"><code>event_mask</code></a>å‘é€è¿‡å»çš„)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>æ¥æ”¶äº‹ä»¶</p>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/loader_dri3/loader_dri3_helper.c#L1699"><code>dri3_setup_present_event(struct loader_dri3_drawable *draw)</code></a>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/loader_dri3/loader_dri3_helper.c#L1779"><code>xcb_register_for_special_xge()</code></a>: åˆ›å»ºä¸€ä¸ªæ¥æ”¶Present XGE äº‹ä»¶çš„é˜Ÿåˆ—ï¼Œå®è´¨ä¸Šæ˜¯åˆå§‹åŒ–äº†ä¸€ä¸ª pthread_cond_tã€‚ï¼ˆè¿™é‡Œ special å°±specialåœ¨å®ƒæ˜¯ä¸€ä¸ªå¸¦äº†æ¡ä»¶å˜é‡çš„ generic events çš„é˜Ÿåˆ—)  <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xcb_special_event</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">xcb_special_event</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">uint8_t</span>     extension;</span><br><span class="line">    <span class="type">uint32_t</span>    eid;</span><br><span class="line">    <span class="type">uint32_t</span>    *stamp;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_list</span> *<span class="title">events</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_list</span> **<span class="title">events_tail</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_cond_t</span> special_event_cond;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>(XGEæŒ‡ <a href="https://www.x.org/wiki/Development/Documentation/XGE/">X Generic Event extension</a>)</p>
</li>
<li>
<p>å¤„ç†äº‹ä»¶</p>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/loader_dri3/loader_dri3_helper.c#L987"><code>dri3_flush_present_events(struct loader_dri3_drawable *draw)</code></a>
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/lib/libxcb/-/blob/master/src/xcb_in.c#L787"><code>xcb_poll_for_special_event()</code></a></li>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/loader_dri3/loader_dri3_helper.c#L483"><code>dri3_handle_present_event(draw, ge)</code></a>: å¤„ç†ä¸€ä¸ª X generic event</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç­‰å¾…äº‹ä»¶ (é˜»å¡å¼)</p>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/loader_dri3/loader_dri3_helper.c#L611"><code>loader_dri3_wait_for_msc()</code></a>: (é˜»å¡)ç­‰å¾…X Server ç®¡ç†çš„ MSC å¤§äºç­‰äºå½“å‰åº”ç”¨çš„ MSC (target_msc)
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/loader_dri3/loader_dri3_helper.c#L572"><code>dri3_wait_for_event_locked(draw, &amp;full_sequence)</code></a>
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/lib/libxcb/-/blob/master/src/xcb_in.c#L806"><code>xcb_wait_for_special_event(draw-&gt;conn, draw-&gt;special_event)</code></a></li>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/loader_dri3/loader_dri3_helper.c#L483"><code>dri3_handle_present_event(draw, ge)</code></a>: å¤„ç†ä¸€ä¸ª X generic event</li>
</ul>
</li>
</ul>
</li>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/loader_dri3/loader_dri3_helper.c#L649"><code>loader_dri3_wait_for_sbc()</code></a>: (é˜»å¡)ç­‰å¾…SBC å¤§äºç­‰äºå½“å‰åº”ç”¨çš„ SBC (target_sbc)
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/loader_dri3/loader_dri3_helper.c#L572"><code>dri3_wait_for_event_locked(draw, NULL)</code></a>
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/lib/libxcb/-/blob/master/src/xcb_in.c#L806"><code>xcb_wait_for_special_event(draw-&gt;conn, draw-&gt;special_event)</code></a></li>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/loader_dri3/loader_dri3_helper.c#L483"><code>dri3_handle_present_event(draw, ge)</code></a>: å¤„ç†ä¸€ä¸ª X generic event</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ä»¥ä¸Šæ— è®ºæ˜¯ <code>loader_dri3_wait_for_msc()</code> è¿˜æ˜¯ <code>loader_dri3_wait_for_sbc()</code>, å½“æ‰€ç­‰å¾…çš„æ¡ä»¶æ»¡è¶³åï¼Œéƒ½ä¼šæ›´æ–°(<code>dri3_handle_present_event()</code>)å½“å‰client çš„çŠ¶æ€(UST, MSC, SBC), æ•´ä¸ªè¿‡ç¨‹æ˜¯ä¸€ç§åŒæ­¥ï¼Œä¹Ÿæ˜¯ä¸€ç§åå•†ã€‚</p>
<h2 id="vertical-refresh-vs-swap-interval"><a class="markdownIt-Anchor" href="#vertical-refresh-vs-swap-interval"></a> Vertical Refresh vs Swap Interval</h2>
<p>è¿™ä¸¤ä¸ªæ¦‚å¿µåœ¨<strong>æ¸²æŸ“</strong>å’Œ<strong>é€æ˜¾</strong>è¿™æ•´ä¸ªè¿‡ç¨‹é‡Œå¾ˆé‡è¦ã€‚å®ƒä»¬ä¿©æ˜¯ä¸¤ä¸ªå±‚æ¬¡çš„ä¸œè¥¿ï¼Œç®€å•è¯´ï¼Œå‰è€…æ˜¯ç¡¬ä»¶å±‚é¢çš„ï¼Œåè€…æ˜¯è½¯ä»¶å±‚é¢çš„ã€‚</p>
<p>Vertical Refresh (åˆå« Vertical Refresh Rate, Vsync Rate), æŒ‡æ˜¾ç¤ºå™¨ä¸€ç§’é’Ÿèƒ½åˆ·æ–°å¤šå°‘æ¬¡ç”»é¢ã€‚ç»™å®šä¸€æ¬¾æ˜¾ç¤ºå™¨ï¼Œå®ƒæ”¯æŒçš„ Vertical Refresh Rate å°±é‚£ä¹ˆå‡ ç§ï¼Œæ¯”å¦‚è®¾ç½®æˆ 60 Hz, è¡¨ç¤ºæ¯ <strong>16.67ms</strong> åˆ·æ–°ä¸€æ¬¡ã€‚</p>
<p>Swap Interval æ˜¯å›¾å½¢ API (EGL/GLX) æä¾›çš„ä¸€ä¸ªåŠŸèƒ½ (<a href="https://registry.khronos.org/OpenGL/extensions/SGI/GLX_SGI_swap_control.txt">GLX_SGI_swap_control</a>, <a href="https://registry.khronos.org/OpenGL/extensions/EXT/EXT_swap_control.txt">GLX_EXT_swap_control</a>, <a href="https://registry.khronos.org/OpenGL/extensions/MESA/GLX_MESA_swap_control.txt">GLX_MESA_swap_control</a>)ï¼Œå°±æ˜¯å…è®¸åº”ç”¨ç¨‹åºæ¸²æŸ“æ—¶è‡ªå·±é€‰æ‹©<strong>è·Ÿä¸è·Ÿæ˜¾ç¤ºå™¨è¿™ä¸ªåˆ·æ–°èŠ‚å¥</strong>ï¼Œé€šå¸¸ Swap Interval æ˜¯ä¸€ä¸ªæ•´æ•°å€¼</p>
<table>
<thead>
<tr>
<th style="text-align:left">Swap Interval</th>
<th style="text-align:left">æè¿°</th>
<th style="text-align:left">æœ€å¤§ FPS</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">ä¸è·Ÿ Vsync, å°½å¯èƒ½æäº¤ï¼Œä½†å¯èƒ½æ’•è£‚</td>
<td style="text-align:left">å–å†³äº GPU æ€§èƒ½</td>
</tr>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:left">æ¯ Vsync æäº¤ä¸€æ¬¡</td>
<td style="text-align:left">ç­‰äº vsync rate</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:left">æ¯ä¸¤æ¬¡ Vsync æäº¤ä¸€æ¬¡</td>
<td style="text-align:left">vsync rate çš„ä¸€åŠ</td>
</tr>
</tbody>
</table>
<p>NOTE: EGL æ˜¯é€šè¿‡ <code>eglSwapInterval()</code> è®¾ç½® Swap Interval çš„ï¼Œ Vulkan ä¸ç›´æ¥è®¾ç½® interval å€¼ï¼Œè€Œæ˜¯é€šè¿‡ <code>VkPresentModeKHR</code></p>
<h1 id="drm-modifiers"><a class="markdownIt-Anchor" href="#drm-modifiers"></a> DRM Modifiers</h1>
<p>å‘ X server æŸ¥è¯¢å¹¶è·å–æ˜¾ç¤º/æ¸²æŸ“è®¾å¤‡æ‰€æ”¯æŒçš„ modifiers æ˜¯æ‰§è¡Œ <a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/gallium/include/mesa_interface.h#L1570"><code>__DRIimageExtension::createImage()</code></a> çš„ä¸€ä¸ªå‡†å¤‡å·¥ä½œã€‚ä½† <code>createImage()</code> å…è®¸modifiers ä¸ºç©ºï¼Œæ­¤æƒ…å†µä¸‹è®©é©±åŠ¨æ¥é€‰ä¸€ä¸ªåˆé€‚çš„çº¹ç†å›¾åƒå†…å­˜å¸ƒå±€ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__DRIimage *</span><br><span class="line">(*createImage)(__DRIscreen *screen,</span><br><span class="line">               <span class="type">int</span> width, <span class="type">int</span> height, <span class="type">int</span> format,</span><br><span class="line">               <span class="type">const</span> <span class="type">uint64_t</span> *modifiers, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> modifier_count,</span><br><span class="line">               <span class="type">unsigned</span> <span class="type">int</span> use,</span><br><span class="line">               <span class="type">void</span> *loaderPrivate);</span><br></pre></td></tr></table></figure>
<p>ä¸ X server äº¤äº’çš„è¿‡ç¨‹åŒ…æ‹¬ 3 æ­¥:</p>
<ul>
<li><a href="https://gist.github.com/lucmann/2a6e24338cdae55ac359af3d25ddf2da#file-dri3-c-L496"><code>xcb_dri3_get_supported_modifiers(draw-&gt;conn, draw-&gt;window, depth, buffer-&gt;cpp*8)</code></a>: è¿”å›ä¸€ä¸ª cookie</li>
<li><a href="https://gist.github.com/lucmann/2a6e24338cdae55ac359af3d25ddf2da#file-dri3-c-L604"><code>xcb_dri3_get_supported_modifiers_reply(draw-&gt;conn, mod_cookie, &amp;error)</code></a>: è¿”å›ä¸€ä¸ª reply åŒ…å«å®é™…çš„modifierså†…å®¹
<ul>
<li><code>xcb_dri3_get_supported_modifiers_reply_t</code></li>
</ul>
  <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">xcb_dri3_get_supported_modifiers_reply_t</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> response_type;</span><br><span class="line">    <span class="type">uint8_t</span> pad0;</span><br><span class="line">    <span class="type">uint16_t</span> sequence;</span><br><span class="line">    <span class="type">uint32_t</span> length;</span><br><span class="line">    <span class="type">uint32_t</span> num_window_modifiers;</span><br><span class="line">    <span class="type">uint32_t</span> num_screen_modifiers;</span><br><span class="line">    <span class="type">uint8_t</span> pad1[<span class="number">16</span>];</span><br><span class="line">&#125; <span class="type">xcb_dri3_get_supported_modifiers_reply_t</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/xserver/-/blob/master/dri3/dri3_request.c#L394"><code>proc_dri3_get_supported_modifiers(ClientPtr client)</code></a>
<ul>
<li>
<p><a href="https://gitlab.freedesktop.org/xorg/xserver/-/blob/master/dri3/dri3_screen.c#L236"><code>dri3_get_supported_modifiers()</code></a>: é€šè¿‡ <code>drm_format_for_depth(depth, bpp)</code> è·å¾—ä¸€ä¸ª <code>DRM_FORMAT_*</code>, å®é™…ä¸Š<a href="https://gitlab.freedesktop.org/xorg/xserver/-/blob/master/dri3/dri3.c#L117"><code>drm_format_for_depth()</code></a> è¿”å›çš„ <code>format</code> ä¹Ÿåªä¼šæ˜¯ä»¥ä¸‹4ç§ä¹‹ä¸€:</p>
  <figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DRM_FORMAT_RGB565       <span class="comment">// bpp = 16</span></span><br><span class="line">DRM_FORMAT_XRGB8888     <span class="comment">// bpp = 24</span></span><br><span class="line">DRM_FORMAT_XRGB2101010  <span class="comment">// bpp = 30</span></span><br><span class="line">DRM_FORMAT_ARGB8888     <span class="comment">// bpp = 32</span></span><br></pre></td></tr></table></figure>
<p>æ— è®ºæ˜¯è·å– screen_modifiers è¿˜æ˜¯ window_modifiers, å®é™…ä¸Šéƒ½ä¾æ® format è·å–ç›¸åº”çš„ modifiers.</p>
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/xserver/-/blob/master/glamor/glamor.c#L1003"><code>glamor_get_drawable_modifiers(DrawablePtr draw, uint32_t format, uint32_t *num_modifiers, uint64_t **modifiers)</code></a>: å›è°ƒç”±å…·ä½“çš„DDX(å¦‚modesetting)æä¾›çš„ <code>get_drawable_modifiers()</code> å‡½æ•°
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/xserver/-/blob/master/hw/xfree86/drivers/modesetting/drmmode_display.c#L230"><code>get_drawable_modifiers(DrawablePtr draw, uint32_t format, uint32_t *num_modifiers, uint64_t **modifiers)</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="https://gist.github.com/lucmann/2a6e24338cdae55ac359af3d25ddf2da#file-dri3-c-L558"><code>xcb_dri3_get_supported_modifiers_window_modifiers(mod_reply)</code></a>
<ul>
<li><a href="https://gist.github.com/lucmann/2a6e24338cdae55ac359af3d25ddf2da#file-dri3-c-L580"><code>xcb_dri3_get_supported_modifiers_screen_modifiers(mod_reply)</code></a>: å¦‚æœè·å–window_modifiers å¤±è´¥åˆ™fallback åˆ°screen_modifiers</li>
</ul>
</li>
</ul>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li>MSC: Graphics Media Stream Counter, å®é™…ä¸Šå°±æ˜¯CRTC çš„Vblankä¸­æ–­æ¬¡æ•° <a href="https://registry.khronos.org/OpenGL/extensions/OML/GLX_OML_sync_control.txt">(GLX_OML_sync_control)</a></li>
<li>SBC: Swap Buffer Counter, å°±æ˜¯Swapbuffer çš„æ¬¡æ•° <a href="https://registry.khronos.org/OpenGL/extensions/EXT/EXT_swap_control.txt">(GLX_EXT_swap_control)</a></li>
<li><a href="https://www.kernel.org/doc/html/v5.1/gpu/drm-mm.html#gem-objects-naming">GEM Objects Naming</a></li>
<li><a href="https://lists.freedesktop.org/archives/mesa-dev/2011-October/013221.html">Implement a throttle dri extension v2</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Mesa</tag>
      </tags>
  </entry>
  <entry>
    <title>Mesa Gallium é©±åŠ¨æ¡†æ¶</title>
    <url>/gfx/mesa-gallium/</url>
    <content><![CDATA[<h1 id="gallium-framework"><a class="markdownIt-Anchor" href="#gallium-framework"></a> Gallium Framework</h1>
<p>å¼•ç”¨<a href="https://docs.mesa3d.org/gallium/intro.html#what-is-gallium"> Mesa3D å®˜æ–¹æ–‡æ¡£</a>çš„è¯ï¼ŒGallium æœ¬è´¨ä¸Šæ˜¯ä¸€ç§åº”ç”¨ç¨‹åºæ¥å£ï¼Œç”¨äºç¼–å†™ä¸è®¾å¤‡åŸºæœ¬æ— å…³çš„å›¾å½¢é©±åŠ¨ç¨‹åºã€‚å®ƒæä¾›äº†å¤šä¸ªå¯¹è±¡ï¼Œä»¥ç®€å•æ˜äº†çš„æ–¹å¼å°è£…äº†å›¾å½¢ç¡¬ä»¶çš„æ ¸å¿ƒæœåŠ¡ã€‚æ®è¯´ï¼ŒGallium çš„è®¾è®¡æ˜¯å€Ÿé‰´äº† DirectXã€‚</p>
<span id="more"></span>
<p>å®ƒæä¾›çš„æ¯”è¾ƒæ ¸å¿ƒçš„å¯¹è±¡ï¼Œæˆ‘è§‰å¾—æœ‰</p>
<ul>
<li><code>pipe_screen</code></li>
<li><code>pipe_context</code></li>
<li><code>pipe_resource</code></li>
<li><code>pipe_surface</code></li>
<li><code>pipe_framebuffer_state</code></li>
</ul>
<p>ä¸€å¼€å§‹çœ‹ Gallium æ—¶ï¼Œç–‘é—®ä¸ºä»€ä¹ˆæ²¡æœ‰ <em>pipe_device</em>, å…¶å®å¾ˆç®€å•ï¼ŒGallium è¿™ä¸€å¥— API ä¹‹æ‰€ä»¥å¯ä»¥ç”¨æ¥ç¼–å†™<strong>ä¸è®¾å¤‡åŸºæœ¬æ— å…³</strong>çš„å›¾å½¢é©±åŠ¨ç¨‹åºï¼Œå¯èƒ½å°±æ˜¯å› ä¸ºå®ƒæ²¡æœ‰æŠ½è±¡ device è¿™ä¸ªæ•°æ®ç»“æ„ã€‚</p>
<p>Gallium ç¡®å®æ˜¯ä¸€ç»„ API, å› ä¸º <code>pipe_screen</code> é‡Œæ˜¯ä¸€å¤§å †å‡½æ•°, <code>pipe_context</code> é‡Œä¹Ÿæ˜¯ä¸€å¤§å †å‡½æ•°ã€‚è™½ç„¶ Gallium æ²¡æœ‰å®šä¹‰ pipe_device, ä½†å‡ ä¹ä¸ç¡¬ä»¶è®¾å¤‡ç›¸å…³çš„ä¸€åˆ‡éƒ½åŒ…å«åœ¨äº† <code>pipe_screen</code>,  ä¸€ä¸ª <code>pipe_screen</code> åŒæ—¶å¯ä»¥è¿½è¸ªå¤šä¸ª <code>pipe_context</code>, æ¯ä¸ª <code>pipe_context</code> é‡Œéƒ½æœ‰ä¸€ä¸ªæŒ‡å‘å®ƒæ‰€åœ¨çš„ <code>pipe_screen</code> çš„æŒ‡é’ˆ (handle)ã€‚</p>
<p>å½“ä¸€ä¸ª Gallium é©±åŠ¨åˆå§‹åŒ–æ—¶ï¼Œç¬¬ä¸€ä¸ªè°ƒç”¨çš„å‡½æ•°å°±æ˜¯ <code>driCreateNewScreen3()</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is the first entrypoint in the driver called by the DRI driver loader</span></span><br><span class="line"><span class="comment"> * after dlopen()ing it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * It&#x27;s used to create global state for the driver across contexts on the same</span></span><br><span class="line"><span class="comment"> * Display.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">__DRIscreen *</span><br><span class="line"><span class="title function_">driCreateNewScreen3</span><span class="params">(<span class="type">int</span> scrn, <span class="type">int</span> fd,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> __DRIextension **loader_extensions,</span></span><br><span class="line"><span class="params">                    <span class="keyword">enum</span> dri_screen_type type,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> __DRIconfig ***driver_configs, <span class="type">bool</span> driver_name_is_inferred,</span></span><br><span class="line"><span class="params">                    <span class="type">bool</span> has_multibuffer, <span class="type">void</span> *data)</span></span><br></pre></td></tr></table></figure>
<pre><code class="highlight mermaid">flowchart TD
    A[&quot;__glXInitialize()&quot;]
    B[&quot;AllocAndFetchScreenConfigs()&quot;]
    C[&quot;dri3_create_screen()&quot;]
    D[&quot;`**driCreateNewScreen3()**`&quot;]
    E[&quot;dri2_init_screen()&quot;]
    F[&quot;pipe_loader_create_screen()&quot;]
    G[&quot;pipe_loader_create_screen_vk()&quot;]
    H[&quot;pipe_loader_drm_create_screen()&quot;]
    I[&quot;pipe_xxx_create_screen()&quot;]
    J[&quot;`**xxx_create_screen()**`&quot;]

    A --&gt; B --&gt; C --&gt; D --&gt; E --&gt; F --&gt; G --&gt; H --&gt; I --&gt; J</code></pre>
<h1 id="state-tracker"><a class="markdownIt-Anchor" href="#state-tracker"></a> State Tracker</h1>
<pre><code class="highlight mermaid">flowchart TD
    A[&quot;vbo_exec_FlushVertices_internal()&quot;]
    B[&quot;vbo_exec_vtx_flush()&quot;]
    C[&quot;vbo_exec_copy_vertices()&quot;]
    D[&quot;st_prepare_draw()&quot;]
    E[&quot;st_validate_st()&quot;]
    F[&quot;st_update_framebuffer_state()&quot;]
    G[&quot;st_manager_validate_framebuffers()&quot;]
    H[&quot;st_framebuffer_validate()&quot;]

    A --&gt; B --&gt; C --&gt; D --&gt; E -- ST_NEW_FB_STATE --&gt; F --&gt; G --&gt; H</code></pre>
<p><code>st_validate_st()</code> å¯èƒ½ä¼šæ›´æ–°å¾ˆå¤šçŠ¶æ€ï¼Œåƒ <code>ST_NEW_FB_STATE</code> å¦‚æœ dirty, é‚£ä¹ˆå°±ä¼šè°ƒç”¨ <code>st_update_framebuffer_state()</code> å‡½æ•°ã€‚</p>
<ul>
<li><code>grep -Po 'ST_STATE\(ST_.*?\)' src/mesa/state_tracker/st_atom_list.h | awk -F&quot;[(,)]&quot; '&#123;printf &quot;| %-26s | %-32s |\n&quot;, $2, $3&#125;'</code></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">STATE</th>
<th style="text-align:left">HOOK</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ST_NEW_DSA</td>
<td style="text-align:left">st_update_depth_stencil_alpha</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_CLIP_STATE</td>
<td style="text-align:left">st_update_clip</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_FS_STATE</td>
<td style="text-align:left">st_update_fp</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_GS_STATE</td>
<td style="text-align:left">st_update_gp</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TES_STATE</td>
<td style="text-align:left">st_update_tep</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TCS_STATE</td>
<td style="text-align:left">st_update_tcp</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_VS_STATE</td>
<td style="text-align:left">st_update_vp</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_POLY_STIPPLE</td>
<td style="text-align:left">st_update_polygon_stipple</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_WINDOW_RECTANGLES</td>
<td style="text-align:left">st_update_window_rectangles</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_BLEND_COLOR</td>
<td style="text-align:left">st_update_blend_color</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_VS_SAMPLER_VIEWS</td>
<td style="text-align:left">st_update_vertex_textures</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_FS_SAMPLER_VIEWS</td>
<td style="text-align:left">st_update_fragment_textures</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_GS_SAMPLER_VIEWS</td>
<td style="text-align:left">st_update_geometry_textures</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TCS_SAMPLER_VIEWS</td>
<td style="text-align:left">st_update_tessctrl_textures</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TES_SAMPLER_VIEWS</td>
<td style="text-align:left">st_update_tesseval_textures</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_VS_SAMPLERS</td>
<td style="text-align:left">st_update_vertex_samplers</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TCS_SAMPLERS</td>
<td style="text-align:left">st_update_tessctrl_samplers</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TES_SAMPLERS</td>
<td style="text-align:left">st_update_tesseval_samplers</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_GS_SAMPLERS</td>
<td style="text-align:left">st_update_geometry_samplers</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_FS_SAMPLERS</td>
<td style="text-align:left">st_update_fragment_samplers</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_VS_IMAGES</td>
<td style="text-align:left">st_bind_vs_images</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TCS_IMAGES</td>
<td style="text-align:left">st_bind_tcs_images</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TES_IMAGES</td>
<td style="text-align:left">st_bind_tes_images</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_GS_IMAGES</td>
<td style="text-align:left">st_bind_gs_images</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_FS_IMAGES</td>
<td style="text-align:left">st_bind_fs_images</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_FB_STATE</td>
<td style="text-align:left">st_update_framebuffer_state</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_BLEND</td>
<td style="text-align:left">st_update_blend</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_RASTERIZER</td>
<td style="text-align:left">st_update_rasterizer</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_SAMPLE_STATE</td>
<td style="text-align:left">st_update_sample_state</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_SAMPLE_SHADING</td>
<td style="text-align:left">st_update_sample_shading</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_SCISSOR</td>
<td style="text-align:left">st_update_scissor</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_VIEWPORT</td>
<td style="text-align:left">st_update_viewport</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_VS_CONSTANTS</td>
<td style="text-align:left">st_update_vs_constants</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TCS_CONSTANTS</td>
<td style="text-align:left">st_update_tcs_constants</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TES_CONSTANTS</td>
<td style="text-align:left">st_update_tes_constants</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_GS_CONSTANTS</td>
<td style="text-align:left">st_update_gs_constants</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_FS_CONSTANTS</td>
<td style="text-align:left">st_update_fs_constants</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_VS_UBOS</td>
<td style="text-align:left">st_bind_vs_ubos</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TCS_UBOS</td>
<td style="text-align:left">st_bind_tcs_ubos</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TES_UBOS</td>
<td style="text-align:left">st_bind_tes_ubos</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_FS_UBOS</td>
<td style="text-align:left">st_bind_fs_ubos</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_GS_UBOS</td>
<td style="text-align:left">st_bind_gs_ubos</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_VS_ATOMICS</td>
<td style="text-align:left">st_bind_vs_atomics</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TCS_ATOMICS</td>
<td style="text-align:left">st_bind_tcs_atomics</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TES_ATOMICS</td>
<td style="text-align:left">st_bind_tes_atomics</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_FS_ATOMICS</td>
<td style="text-align:left">st_bind_fs_atomics</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_GS_ATOMICS</td>
<td style="text-align:left">st_bind_gs_atomics</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_VS_SSBOS</td>
<td style="text-align:left">st_bind_vs_ssbos</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TCS_SSBOS</td>
<td style="text-align:left">st_bind_tcs_ssbos</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TES_SSBOS</td>
<td style="text-align:left">st_bind_tes_ssbos</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_FS_SSBOS</td>
<td style="text-align:left">st_bind_fs_ssbos</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_GS_SSBOS</td>
<td style="text-align:left">st_bind_gs_ssbos</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_PIXEL_TRANSFER</td>
<td style="text-align:left">st_update_pixel_transfer</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_TESS_STATE</td>
<td style="text-align:left">st_update_tess</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_HW_ATOMICS</td>
<td style="text-align:left">st_bind_hw_atomic_buffers</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_VERTEX_ARRAYS</td>
<td style="text-align:left">st_update_array</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_CS_STATE</td>
<td style="text-align:left">st_update_cp</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_CS_SAMPLER_VIEWS</td>
<td style="text-align:left">st_update_compute_textures</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_CS_SAMPLERS</td>
<td style="text-align:left">st_update_compute_samplers</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_CS_CONSTANTS</td>
<td style="text-align:left">st_update_cs_constants</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_CS_UBOS</td>
<td style="text-align:left">st_bind_cs_ubos</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_CS_ATOMICS</td>
<td style="text-align:left">st_bind_cs_atomics</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_CS_SSBOS</td>
<td style="text-align:left">st_bind_cs_ssbos</td>
</tr>
<tr>
<td style="text-align:left">ST_NEW_CS_IMAGES</td>
<td style="text-align:left">st_bind_cs_images</td>
</tr>
</tbody>
</table>
<h1 id="gallium-api"><a class="markdownIt-Anchor" href="#gallium-api"></a> Gallium API</h1>
<h2 id="resource_copy_region"><a class="markdownIt-Anchor" href="#resource_copy_region"></a> resource_copy_region</h2>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copy a block of pixels from one resource to another.</span></span><br><span class="line"><span class="comment"> * The resource must be of the same format.</span></span><br><span class="line"><span class="comment"> * Resources with nr_samples &gt; 1 are not allowed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> (*resource_copy_region)(<span class="keyword">struct</span> pipe_context *pipe,</span><br><span class="line">                             <span class="keyword">struct</span> pipe_resource *dst,</span><br><span class="line">                             <span class="type">unsigned</span> dst_level,</span><br><span class="line">                             <span class="type">unsigned</span> dstx, <span class="type">unsigned</span> dsty, <span class="type">unsigned</span> dstz,</span><br><span class="line">                             <span class="keyword">struct</span> pipe_resource *src,</span><br><span class="line">                             <span class="type">unsigned</span> src_level,</span><br><span class="line">                             <span class="type">const</span> <span class="keyword">struct</span> pipe_box *src_box);</span><br></pre></td></tr></table></figure>
<p>resource_copy_region åªèƒ½åœ¨ buffer ä¸ buffer ä¹‹é—´æˆ– texture ä¸ texture ä¹‹é—´ memcpy, è€Œä¸”æºä¸ç›®æ ‡çš„ format å¿…é¡»ç›¸åŒã€‚ä¹‹æ‰€ä»¥ä¸èƒ½åš buffers ä¸ textures ä¹‹é—´çš„ memcpy, è‡³å°‘æ˜¯å› ä¸ºç¼ºå°‘ stride å‚æ•°ã€‚ä¸€äº›ç¡¬ä»¶(å¦‚ nvidia) å¯ä»¥é€šè¿‡ä¸“é—¨çš„ copy engine å®Œæˆè¿™äº›æ‹·è´ï¼Œä½†å¯¹äºå…¶å®ƒç¡¬ä»¶å¯èƒ½éœ€è¦ä¸€ä¸ª compute shader å»åšè¿™äº›æ‹·è´ã€‚å¦ä¸€æ–¹é¢ï¼Œé‚£äº›ä¸“é—¨çš„ copy engine é€šå¸¸æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œæ‰€ä»¥åªåœ¨é‚£äº›å¸¦å®½éå¸¸æœ‰é™çš„ PCIe ä¼ è¾“åœºæ™¯ä¸‹æ‰æœ‰ç”¨ã€‚å¦‚æœæƒ³åˆ©ç”¨å…¨éƒ¨çš„<br />
VRAM å¸¦å®½(ç”šè‡³ infinity cache bandwidth), ä½ å¾ˆå¯èƒ½å¿…é¡»ä½¿ç”¨ compute shaders.</p>
<h1 id="gallium-hud"><a class="markdownIt-Anchor" href="#gallium-hud"></a> Gallium HUD</h1>
<p>HUD (Head-up Display) æ˜¯ Gallium ä¸€ä¸ªç”¨äºè§‚æµ‹å›¾å½¢åº”ç”¨çš„ fps, cpu åˆ©ç”¨ç‡ç­‰æ€§èƒ½æ•°æ®çš„å†…ç½®åŠŸèƒ½ï¼Œå®ƒæœ‰ç‚¹åƒç²¾ç®€ç‰ˆçš„ <a href="https://github.com/flightlessmango/MangoHud">MangoHud</a>, ä½†å®ƒçš„æ–¹ä¾¿åœ¨äºé›†æˆåœ¨é©±åŠ¨å†…éƒ¨ï¼Œä¸ç®¡æ˜¯æ™®é€šçš„ Gallium é©±åŠ¨ï¼Œè¿˜æ˜¯ Zinkï¼Œå®ƒéƒ½å¯ä»¥ä½¿ç”¨ã€‚å®ƒçš„ mannual å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ <code>GALLIUM_HUD=help</code> çœ‹åˆ°</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Syntax: GALLIUM_HUD=name1[+name2][...][:value1][,nameI...][;nameJ...]</span><br><span class="line"></span><br><span class="line">  Names are identifiers of data sources which will be drawn as graphs</span><br><span class="line">  in panes. Multiple graphs can be drawn in the same pane.</span><br><span class="line">  There can be multiple panes placed in rows and columns.</span><br><span class="line"></span><br><span class="line">  &#x27;+&#x27; separates names which will share a pane.</span><br><span class="line">  &#x27;:[value]&#x27; specifies the initial maximum value of the Y axis</span><br><span class="line">             for the given pane.</span><br><span class="line">  &#x27;,&#x27; creates a new pane below the last one.</span><br><span class="line">  &#x27;;&#x27; creates a new pane at the top of the next column.</span><br><span class="line">  &#x27;=&#x27; followed by a string, changes the name of the last data source</span><br><span class="line">      to that string</span><br><span class="line"></span><br><span class="line">  Example: GALLIUM_HUD=&quot;cpu,fps;primitives-generated&quot;</span><br><span class="line"></span><br><span class="line">  Additionally, by prepending &#x27;.[identifier][value]&#x27; modifiers to</span><br><span class="line">  a name, it is possible to explicitly set the location and size</span><br><span class="line">  of a pane, along with limiting overall maximum value of the</span><br><span class="line">  Y axis and activating dynamic readjustment of the Y axis.</span><br><span class="line">  Several modifiers may be applied to the same pane simultaneously.</span><br><span class="line"></span><br><span class="line">  &#x27;x[value]&#x27; sets the location of the pane on the x axis relative</span><br><span class="line">             to the upper-left corner of the viewport, in pixels.</span><br><span class="line">  &#x27;y[value]&#x27; sets the location of the pane on the y axis relative</span><br><span class="line">             to the upper-left corner of the viewport, in pixels.</span><br><span class="line">  &#x27;w[value]&#x27; sets width of the graph pixels.</span><br><span class="line">  &#x27;h[value]&#x27; sets height of the graph in pixels.</span><br><span class="line">  &#x27;c[value]&#x27; sets the ceiling of the value of the Y axis.</span><br><span class="line">             If the graph needs to draw values higher than</span><br><span class="line">             the ceiling allows, the value is clamped.</span><br><span class="line">  &#x27;d&#x27; activates dynamic Y axis readjustment to set the value of</span><br><span class="line">      the Y axis to match the highest value still visible in the graph.</span><br><span class="line">  &#x27;r&#x27; resets the color counter (the next color will be green)</span><br><span class="line">  &#x27;s&#x27; sort items below graphs in descending order</span><br><span class="line"></span><br><span class="line">  If &#x27;c&#x27; and &#x27;d&#x27; modifiers are used simultaneously, both are in effect:</span><br><span class="line">  the Y axis does not go above the restriction imposed by &#x27;c&#x27; while</span><br><span class="line">  still adjusting the value of the Y axis down when appropriate.</span><br><span class="line"></span><br><span class="line">  You can change behavior of the whole HUD by adding these options at</span><br><span class="line">  the beginning of the environment variable:</span><br><span class="line">  &#x27;simple,&#x27; disables all the fancy stuff and only draws text.</span><br><span class="line"></span><br><span class="line">  Example: GALLIUM_HUD=&quot;.w256.h64.x1600.y520.d.c1000fps+cpu,.datom-count&quot;</span><br><span class="line"></span><br><span class="line">  Available names:</span><br><span class="line">    stdout (prints the counters value to stdout)</span><br><span class="line">    csv (prints the counter values to stdout as CSV, use + to separate names)</span><br><span class="line">    fps</span><br><span class="line">    frametime</span><br><span class="line">    cpu</span><br><span class="line">    cpu0</span><br><span class="line">    cpu1</span><br><span class="line">    cpu2</span><br><span class="line">    cpu3</span><br><span class="line">    cpu4</span><br><span class="line">    cpu5</span><br><span class="line">    cpu6</span><br><span class="line">    cpu7</span><br><span class="line">    cpu8</span><br><span class="line">    cpu9</span><br><span class="line">    cpu10</span><br><span class="line">    cpu11</span><br><span class="line">    samples-passed</span><br><span class="line">    primitives-generated</span><br><span class="line">    render-passes</span><br></pre></td></tr></table></figure>
<p><img src="/images/mesa-gallium/sb7-asteroids.png" alt=" çš„æ•ˆæœ" /></p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Mesa</tag>
      </tags>
  </entry>
  <entry>
    <title>Mesa GLX å®ç°</title>
    <url>/gfx/mesa-glx/</url>
    <content><![CDATA[<h1 id="glx"><a class="markdownIt-Anchor" href="#glx"></a> GLX</h1>
<p>GLX æ˜¯ Mesa ä¸­å®ç°çš„ä¸‰å¤§æ”¯æŒå¹³å°(EGL, GLX, GBM)ä¹‹ä¸€, åŸæ¥ GLX åœ¨ Mesa ä¸­æœ‰ <em>xlib</em>, <em>gallium-xlib</em> å’Œ <em>dri</em> ä¸‰ç§å®ç°ï¼Œè‡ªä» <a href="https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/10153">Delete Mesa Classic</a> åå°±åªå‰©ä¸‹ <em>xlib</em>ï¼Œ<em>dri</em> ä¸¤ç§å®ç°ï¼Œå…¶ä¸­ <em>dri</em> ä½¿ç”¨å¾—æ¯”è¾ƒå¤šä¸€äº›ã€‚</p>
<span id="more"></span>
<pre><code class="highlight mermaid">flowchart TD
    A[xlib or gallium-xlib]
    A --&gt; x11
    A --&gt; xext
    A --&gt; xcb
    B[dri]
    B --&gt; x11
    B --&gt; xext
    B --&gt; xfixes
    B --&gt; xcb-glx
    B --&gt; xcb-shm</code></pre>
<p>å¦‚æœæ˜¯xlib, å®ƒçš„æºç ä½äº</p>
<ul>
<li>mesa/drivers/x11</li>
</ul>
<p>å¦‚æœæ˜¯gallium-xlib, å®ƒçš„æºç ä½äº</p>
<ul>
<li>gallium/winsys/sw/xlib</li>
<li>gallium/frontends/glx/xlib</li>
<li>gallium/targets/libgl-xlib</li>
</ul>
<h1 id="xlib"><a class="markdownIt-Anchor" href="#xlib"></a> xlib</h1>
<h1 id="dri"><a class="markdownIt-Anchor" href="#dri"></a> dri</h1>
<h2 id="glxmakecurrent"><a class="markdownIt-Anchor" href="#glxmakecurrent"></a> glXMakeCurrent()</h2>
<pre><code class="highlight mermaid">sequenceDiagram
    autonumber
    participant GLX
    participant Gallium

    GLX     -&gt;&gt; GLX     : MakeContextCurrent()
    GLX     -&gt;&gt; Gallium : driUnbindContext()
    Gallium -&gt;&gt; Gallium : st_api_make_current()
    Gallium -&gt;&gt; Gallium : st_glFlush()
    opt not the first time MakeCurrent()
        GLX     -&gt;&gt; Gallium : driBindContext()
        Gallium -&gt;&gt; Gallium : st_api_make_current()
        Gallium -&gt;&gt; Gallium : st_glFlush()
        GLX     -&gt;&gt; Gallium : driDestroyContext()
        Gallium -&gt;&gt; Gallium : st_glFlush()
        Gallium -&gt;&gt; Gallium : st_context_destroy()
    end</code></pre>
<h2 id="glxswapbuffers"><a class="markdownIt-Anchor" href="#glxswapbuffers"></a> glXSwapBuffers()</h2>
<pre><code class="highlight mermaid">flowchart TD
    A[&quot;glXSwapBuffers()&quot;]
    B[&quot;driswSwapBuffers()&quot;]
    C[&quot;drisw_swap_buffers_with_damage()&quot;]
    D[&quot;drisw_copy_to_front()&quot;]
    E[&quot;drisw_present_texture()&quot;]
    F[&quot;llvmpipe_flush_frontbuffer()&quot;]
    G[&quot;dri_sw_displaytarget_display()&quot;]
    H[&quot;drisw_put_image_shm()&quot;]
    I[&quot;drisw_put_image()&quot;]

    B2[&quot;dri3_swap_buffers()&quot;]
    C2[&quot;loader_dri3_swap_buffer_msc()&quot;]
    D2[&quot;glx_dri3_flush_drawable()&quot;]
    E2[&quot;dri3_flush_present_events()&quot;]
    F2[&quot;xcb_present_pixmap()&quot;]
    G2[&quot;xcb_flush()&quot;]
    H2[&quot;dri2_invalidate_drawable()&quot;]

    A --&gt; B --&gt; C --&gt; D --&gt; E --&gt; F --&gt; G --is_shm--&gt; H
    G --&gt; I
    A --&gt; B2 --&gt; C2 --&gt; D2 --&gt; E2 --&gt; F2 --&gt; G2 --&gt; H2</code></pre>
<h1 id="glvndvendor-neutral-gl-dispatch-library"><a class="markdownIt-Anchor" href="#glvndvendor-neutral-gl-dispatch-library"></a> GLVND(Vendor Neutral GL dispatch library)</h1>
<table>
<thead>
<tr>
<th style="text-align:left">Source Directory</th>
<th style="text-align:left">Shared libraray</th>
<th style="text-align:left">APT Package</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GLDispatch</td>
<td style="text-align:left">libGLdispatch.so.0.0.0</td>
<td style="text-align:left">libglvnd0_1.3.2-1~kylin0.20.04.2_arm64</td>
</tr>
<tr>
<td style="text-align:left">GLX</td>
<td style="text-align:left">libGLX.so.0.0.0</td>
<td style="text-align:left">libglx0_1.3.2-1~kylin0.20.04.2_arm64</td>
</tr>
<tr>
<td style="text-align:left">EGL</td>
<td style="text-align:left">libEGL.so.1.1.0</td>
<td style="text-align:left">libegl1_1.3.2-1~kylin0.20.04.2_arm64</td>
</tr>
<tr>
<td style="text-align:left">OpenGL</td>
<td style="text-align:left">libOpenGL.so.0.0.0</td>
<td style="text-align:left">libopengl0_1.3.2-1~kylin0.20.04.2_arm64</td>
</tr>
<tr>
<td style="text-align:left">GLESv1</td>
<td style="text-align:left">libGLESv1_CM.so.1.2.0</td>
<td style="text-align:left">libgles1_1.3.2-1~kylin0.20.04.2_arm64</td>
</tr>
<tr>
<td style="text-align:left">GLESv2</td>
<td style="text-align:left">libGLESv2.so.2.1.0</td>
<td style="text-align:left">libgles2_1.3.2-1~kylin0.20.04.2_arm64</td>
</tr>
<tr>
<td style="text-align:left">GL</td>
<td style="text-align:left">libGL.so.1.7.0</td>
<td style="text-align:left">libgl1_1.3.2-1~kylin0.20.04.2_arm64</td>
</tr>
</tbody>
</table>
<p>ä¸Šé¢è¿™äº›åŒ…å’ŒåŠ¨æ€åº“æ–‡ä»¶éƒ½æ¥è‡ªåŒä¸€ä¸ªæºç åº“ <a href="https://gitlab.freedesktop.org/glvnd/libglvnd">glvnd/libglvnd</a>, ä½†å®ƒä»¬å¹¶ä¸æ˜¯çœŸæ­£çš„ OpenGL å®ç° (é©±åŠ¨)ï¼Œ å®ƒä»¬åªæ˜¯ä¸€ä¸ª <strong>Dispatch Layer</strong>, åˆ©ç”¨ <a href="https://docs.oracle.com/cd/E19683-01/817-3677/6mj8mbtbr/index.html#chapter4-31738">Dynamic Tag <code>DT_FILTER</code></a> å®ç°å¤šä¸ª Vendor çš„ OpenGL é©±åŠ¨èƒ½åœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸Šå…±å­˜ã€‚ libglvnd å‘ç”¨æˆ·æä¾›ç¯å¢ƒå˜é‡</p>
<p><code>__GLX_VENDOR_LIBRARY_NAME</code></p>
<p>æˆ–</p>
<ul>
<li><code>__EGL_VENDOR_LIBRARY_FILENAMES</code></li>
<li><code>__EGL_VENDOR_LIBRARY_DIRS</code></li>
</ul>
<p>æ¥æŒ‡å®šè¿è¡Œæ—¶åˆ°åº•æ˜¯å“ªä¸ª vendor çš„é©±åŠ¨è¢«è°ƒç”¨ã€‚</p>
<h1 id="mesa-çš„åŒ…ä¸åº“"><a class="markdownIt-Anchor" href="#mesa-çš„åŒ…ä¸åº“"></a> Mesa çš„åŒ…ä¸åº“</h1>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find /usr -path /usr/share -prune -o -name <span class="string">&#x27;libGL*&#x27;</span> -<span class="built_in">type</span> f -<span class="built_in">exec</span> dpkg -S &#123;&#125; \;</span><br></pre></td></tr></table></figure>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">libglew2.2:amd64: /usr/lib/x86_64-linux-gnu/libGLEW.so.2.2.0</span><br><span class="line">libglvnd0:amd64: /usr/lib/x86_64-linux-gnu/libGLdispatch.so.0.0.0</span><br><span class="line">libglew-dev:amd64: /usr/lib/x86_64-linux-gnu/libGLEW.a</span><br><span class="line">arise-linux-graphics-driver-dri:amd64: /usr/lib/x86_64-linux-gnu/libGLX_arise.so.0.0.0</span><br><span class="line">libglx-mesa0:amd64: /usr/lib/x86_64-linux-gnu/libGLX_mesa.so.0.0.0</span><br><span class="line">libglx0:amd64: /usr/lib/x86_64-linux-gnu/libGLX.so.0.0.0</span><br><span class="line">libgles2:amd64: /usr/lib/x86_64-linux-gnu/libGLESv2.so.2.1.0</span><br><span class="line">libgles1:amd64: /usr/lib/x86_64-linux-gnu/libGLESv1_CM.so.1.2.0</span><br><span class="line">libgl1:amd64: /usr/lib/x86_64-linux-gnu/libGL.so.1.7.0</span><br><span class="line">libglu1-mesa:amd64: /usr/lib/x86_64-linux-gnu/libGLU.so.1.3.1</span><br><span class="line">libglu1-mesa-dev:amd64: /usr/lib/x86_64-linux-gnu/libGLU.a</span><br></pre></td></tr></table></figure>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://docs.oracle.com/cd/E19683-01/817-3677/chapter6-42444/index.html">Dynamic Linking/Dynamic Section</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Mesa</tag>
      </tags>
  </entry>
  <entry>
    <title>Mesa å¯¹ LLVM çš„ä¾èµ–</title>
    <url>/gfx/mesa-llvm/</url>
    <content><![CDATA[<h1 id="llvm-å’Œ-mesa-ç®€ä»‹"><a class="markdownIt-Anchor" href="#llvm-å’Œ-mesa-ç®€ä»‹"></a> LLVM å’Œ Mesa ç®€ä»‹</h1>
<h2 id="llvm-low-level-virtual-machine"><a class="markdownIt-Anchor" href="#llvm-low-level-virtual-machine"></a> LLVM (Low-Level Virtual Machine)</h2>
<span id="more"></span>
<h2 id="mesa"><a class="markdownIt-Anchor" href="#mesa"></a> Mesa</h2>
<p>Mesa æ˜¯ GPU é©±åŠ¨çš„ UMD éƒ¨åˆ†ï¼ˆå¼€æºï¼Œéµå¾ª MIT å¼€æºåè®®). å®ƒæ”¯æŒçš„ API æœ‰ OpenGL, OpenCL, Vulkan, VAAPI, VDPAU ç­‰</p>
<h1 id="mesa-ä¸­çš„é©±åŠ¨å¯¹-llvm-çš„ä¾èµ–"><a class="markdownIt-Anchor" href="#mesa-ä¸­çš„é©±åŠ¨å¯¹-llvm-çš„ä¾èµ–"></a> Mesa ä¸­çš„é©±åŠ¨å¯¹ LLVM çš„ä¾èµ–</h1>
<table>
<thead>
<tr>
<th style="text-align:left">Mesa driver</th>
<th style="text-align:center">dependent LLVM version</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>vulkan-drivers=amd</code></td>
<td style="text-align:center">15.0.0+</td>
</tr>
<tr>
<td style="text-align:left"><code>gallium-drivers=radeonsi</code></td>
<td style="text-align:center">15.0.0+</td>
</tr>
<tr>
<td style="text-align:left"><code>intel-clc=enabled</code></td>
<td style="text-align:center">13.0.0+</td>
</tr>
<tr>
<td style="text-align:left"><code>gallium-opencl=icd</code></td>
<td style="text-align:center">11.0.0+</td>
</tr>
<tr>
<td style="text-align:left"><code>microsoft-clc=enabled</code></td>
<td style="text-align:center">10.0.0+</td>
</tr>
<tr>
<td style="text-align:left"><code>gallium-drivers=swrast</code> and <code>llvm=enabled</code></td>
<td style="text-align:center">5.0.0+</td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Mesa</tag>
      </tags>
  </entry>
  <entry>
    <title>Notes for Mesa</title>
    <url>/gfx/mesa/</url>
    <content><![CDATA[<h1 id="overview"><a class="markdownIt-Anchor" href="#overview"></a> Overview</h1>
<p>Mesa åŒ…å«äº†å„ç§ GPU/CPU çš„ OpenGL, OpenCL, Vulkan å®ç°(Usermode Driver), ä¹ŸåŒ…æ‹¬ GLX, EGL, GBM ç­‰åè®®çš„å®ç°ã€‚</p>
<ul>
<li>Vulkan é©±åŠ¨</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">codename</th>
<th style="text-align:left">directories</th>
<th style="text-align:left">platforms</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">anv</td>
<td style="text-align:left">src/intel/vulkan, src/intel/vulkan_hasvk</td>
<td style="text-align:left">Alder Lake-P</td>
</tr>
<tr>
<td style="text-align:left">asahi</td>
<td style="text-align:left">src/asahi/vulkan</td>
<td style="text-align:left">Apple M1, M2</td>
</tr>
<tr>
<td style="text-align:left">lpv</td>
<td style="text-align:left">src/gallium/drivers/llvmpipe</td>
<td style="text-align:left">CPU</td>
</tr>
<tr>
<td style="text-align:left">panvk</td>
<td style="text-align:left">src/panfrost/vulkan</td>
<td style="text-align:left">RK3399</td>
</tr>
<tr>
<td style="text-align:left">v3dv</td>
<td style="text-align:left">src/broadcom/vulkan</td>
<td style="text-align:left">Raspberry Pi</td>
</tr>
</tbody>
</table>
<h1 id="build"><a class="markdownIt-Anchor" href="#build"></a> Build</h1>
<h2 id="build-dependencies-since-mesa-2500"><a class="markdownIt-Anchor" href="#build-dependencies-since-mesa-2500"></a> Build Dependencies (since mesa-25.0.0)</h2>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">dep</th>
<th style="text-align:left">apt-get</th>
<th style="text-align:left">version required</th>
<th style="text-align:left">yet another install</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">/usr/bin/glslangValidator</td>
<td style="text-align:left">glslang-tools</td>
<td style="text-align:left"></td>
<td style="text-align:left"><a href="https://github.com/KhronosGroup/glslang">https://github.com/KhronosGroup/glslang</a></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">/usr/bin/rustc</td>
<td style="text-align:left">rustc</td>
<td style="text-align:left">1.78.0 or newer</td>
<td style="text-align:left">`curl --proto â€˜=httpsâ€™ --tlsv1.2 -sSf <a href="https://sh.rustup.rs">https://sh.rustup.rs</a></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">bindgen (rust package)</td>
<td style="text-align:left">cargo</td>
<td style="text-align:left">0.65 or newer</td>
<td style="text-align:left"><code>cargo install bindgen-cli</code></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">libclc-dev</td>
<td style="text-align:left">libclc-17-dev</td>
<td style="text-align:left"></td>
<td style="text-align:left">not required if -Dmesa-clc=auto</td>
</tr>
<tr>
<td style="text-align:left">+</td>
<td style="text-align:left">libdrm</td>
<td style="text-align:left">libdrm-dev</td>
<td style="text-align:left">2.4.121(120 ok2.0)</td>
<td style="text-align:left"><a href="https://gitlab.freedesktop.org/mesa/drm">https://gitlab.freedesktop.org/mesa/drm</a></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">llvm</td>
<td style="text-align:left">llvm-17-dev</td>
<td style="text-align:left">(17.0.6 ok2.0)</td>
<td style="text-align:left"><a href="https://github.com/llvm/llvm-project">https://github.com/llvm/llvm-project</a></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">libLLVMSPIRVLib.so.17</td>
<td style="text-align:left">llvm-spirv-17</td>
<td style="text-align:left">(17.0.0 ok2.0)</td>
<td style="text-align:left"><a href="https://github.com/KhronosGroup/SPIRV-LLVM-Translator">https://github.com/KhronosGroup/SPIRV-LLVM-Translator</a></td>
</tr>
<tr>
<td style="text-align:left">+</td>
<td style="text-align:left">LLVMSPIRVLib.h</td>
<td style="text-align:left">llvmspirvlib-17-dev</td>
<td style="text-align:left">(absent ok2.0)</td>
<td style="text-align:left"><a href="https://github.com/KhronosGroup/SPIRV-LLVM-Translator">https://github.com/KhronosGroup/SPIRV-LLVM-Translator</a></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">clang-cpp</td>
<td style="text-align:left">libclang-cpp17-dev</td>
<td style="text-align:left">(17.0.6 ok2.0)</td>
<td style="text-align:left">not required if -Dmesa-clc=auto</td>
</tr>
<tr>
<td style="text-align:left">*</td>
<td style="text-align:left">clang-dev</td>
<td style="text-align:left">libclang-17-dev</td>
<td style="text-align:left"></td>
<td style="text-align:left"><a href="https://gitlab.freedesktop.org/mesa/mesa/-/issues/10485">Debian package issue</a></td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">xshmfence</td>
<td style="text-align:left">libxshmfence-dev</td>
<td style="text-align:left">(1.3    ok2.0)</td>
<td style="text-align:left">required if -Dplatforms=x11</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">xxf86vm</td>
<td style="text-align:left">libxxf86vm-dev</td>
<td style="text-align:left">(1.1.4  ok2.0)</td>
<td style="text-align:left">required since -Dglx-direct=true by default</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">xrandr</td>
<td style="text-align:left">libxrandr-dev</td>
<td style="text-align:left">(1.5.2  ok2.0)</td>
<td style="text-align:left">required since -Dxlib-lease=true</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">cbindgen (rust package)</td>
<td style="text-align:left">cargo</td>
<td style="text-align:left">0.28.0</td>
<td style="text-align:left"><code>cargo install cbindgen</code>; required if -Dgallium-drivers=nouveau</td>
</tr>
</tbody>
</table>
<p>NOTE:</p>
<ul>
<li>
<p>(*) è¡¨ç¤ºæœ¬æ¥ä¸éœ€è¦çš„ä¾èµ–</p>
</li>
<li>
<p>(+) åœ¨ OpenKylin 2.0 çš„æºé‡Œæ²¡æœ‰ï¼Œéœ€è¦æºç æ„å»º</p>
</li>
<li>
<p>Ubuntu 22.04</p>
</li>
</ul>
<p><strong>ä¹¦åˆ°ç”¨æ—¶æ–¹æ¨å°‘ï¼ŒåŒ…è¦è£…æ—¶ä¸å¥½æ‰¾</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install -y cmake ninja-build bison flex g++ git pkg-config python3-setuptools python3-lz4 \</span><br><span class="line">    python3-jinja2 libssl-dev libelf-dev libboost-dev libglm-dev libtinyobjloader-dev libstb-dev \</span><br><span class="line">    libpng-dev wayland-protocols libwayland-dev libdecor-0-dev freeglut3-dev libglfw3-dev libexpat1-dev libglvnd-dev \</span><br><span class="line">    libx11-dev libxext-dev libxshmfence-dev libxrandr-dev libxxf86vm-dev libxfixes-dev libx11-xcb-dev \</span><br><span class="line">    libxcb1-dev libxcb-randr0-dev libxcb-glx0-dev libxcb-shm0-dev libxcb-dri3-dev libxcb-dri2-0-dev libxcb-present-dev \</span><br><span class="line">    libselinux1-dev libvulkan-dev vulkan-tools mesa-utils</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">meson build -Dprefix=/usr/local -Dlibdir=lib/x86_64-linux-gnu -Dplatforms=x11 -Dgallium-drivers=nouveau</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-Dprefix=/usr/local</code> é¿å…è¦†ç›–ç³»ç»ŸåŸæ¥çš„ <code>libGL*</code></li>
<li><code>-Dlibdir=lib/x86_64-linux-gnu</code> è®¾ç½®åº“çš„å®‰è£…è·¯å¾„ä¸º <code>/etc/ld.so.conf.d/x86_64-linux-gnu.conf</code> ä¸­æœç´¢<strong>ç¬¬ä¸€é¡ºä½</strong>çš„è·¯å¾„</li>
<li>å…¶ä»–é»˜è®¤å°±å¥½ï¼Œ å‡ºç°çš„ä¾èµ–åœ¨ OpenKylin 2.0 ä¸Š apt-get åŸºæœ¬éƒ½èƒ½è§£å†³</li>
</ul>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">Build targets in project: 437</span><br><span class="line">WARNING: Project specifies a minimum meson_version &#x27;&gt;= 1.1.0&#x27; but uses features which were added in newer versions:</span><br><span class="line"> * 1.3.0: &#123;&#x27;rust.proc_macro&#x27;, &#x27;rust_abi arg in static_library&#x27;&#125;</span><br><span class="line"></span><br><span class="line">mesa 25.0.0-devel</span><br><span class="line"></span><br><span class="line">  Directories</span><br><span class="line">    prefix                       : /usr/local</span><br><span class="line">    libdir                       : lib/x86_64-linux-gnu</span><br><span class="line">    includedir                   : include</span><br><span class="line"></span><br><span class="line">  Common C and C++ arguments</span><br><span class="line">    c_cpp_args                   : -mtls-dialect=gnu2</span><br><span class="line"></span><br><span class="line">  OpenGL</span><br><span class="line">    OpenGL                       : YES</span><br><span class="line">    ES1                          : YES</span><br><span class="line">    ES2                          : YES</span><br><span class="line">    Shared glapi                 : YES</span><br><span class="line">    GLVND                        : YES</span><br><span class="line"></span><br><span class="line">  DRI</span><br><span class="line">    Platform                     : drm</span><br><span class="line">    Driver dir                   : /usr/local/lib/x86_64-linux-gnu/dri</span><br><span class="line"></span><br><span class="line">  GLX</span><br><span class="line">    Enabled                      : YES</span><br><span class="line">    Provider                     : dri</span><br><span class="line"></span><br><span class="line">  EGL</span><br><span class="line">    Enabled                      : YES</span><br><span class="line">    Drivers                      : builtin:egl_dri2 builtin:egl_dri3</span><br><span class="line">    Platforms                    : x11 surfaceless drm xcb</span><br><span class="line"></span><br><span class="line">  GBM</span><br><span class="line">    Enabled                      : YES</span><br><span class="line">    Backends path                : /usr/local/lib/x86_64-linux-gnu/gbm</span><br><span class="line"></span><br><span class="line">  Vulkan</span><br><span class="line">    Drivers                      : amd intel intel_hasvk nouveau swrast</span><br><span class="line">    Platforms                    : x11 surfaceless drm xcb</span><br><span class="line">    ICD dir                      : share/vulkan/icd.d</span><br><span class="line">    Intel Ray tracing            : YES</span><br><span class="line"></span><br><span class="line">  Video</span><br><span class="line">    Codecs                       : av1dec av1enc vp9dec</span><br><span class="line">    APIs                         : vulkan xa</span><br><span class="line"></span><br><span class="line">  LLVM</span><br><span class="line">    Enabled                      : YES</span><br><span class="line">    Version                      : 17.0.6</span><br><span class="line"></span><br><span class="line">  Gallium</span><br><span class="line">    Enabled                      : YES</span><br><span class="line">    Drivers                      : nouveau</span><br><span class="line">    Platforms                    : x11 surfaceless drm xcb</span><br><span class="line">    Frontends                    : mesa xa</span><br><span class="line">    Off-screen rendering (OSMesa): NO</span><br><span class="line">    HUD lm-sensors               : NO</span><br><span class="line"></span><br><span class="line">  Perfetto</span><br><span class="line">    Enabled                      : NO</span><br><span class="line"></span><br><span class="line">  Teflon (TensorFlow Lite delegate)</span><br><span class="line">    Enabled                      : NO</span><br><span class="line"></span><br><span class="line">  Subprojects</span><br><span class="line">    paste                        : YES</span><br><span class="line">    proc-macro2                  : YES (from syn =&gt; quote)</span><br><span class="line">    quote                        : YES (from syn)</span><br><span class="line">    syn                          : YES</span><br><span class="line">    unicode-ident                : YES (from syn)</span><br><span class="line"></span><br><span class="line">  User defined options</span><br><span class="line">    libdir                       : lib/x86_64-linux-gnu</span><br><span class="line">    prefix                       : /usr/local</span><br><span class="line">    gallium-drivers              : nouveau</span><br><span class="line">    platforms                    : x11</span><br><span class="line"></span><br><span class="line">Found ninja-1.11.1 at /usr/bin/ninja</span><br><span class="line">WARNING: Running the setup command as `meson [options]` instead of `meson setup [options]` is ambiguous and deprecated.</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p>After compilation and installed as follow:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /usr/local/lib/x86_64-linux-gnu</span><br><span class="line">total 159360</span><br><span class="line">lrwxrwxrwx 1 root root        10 Feb  7 17:13 libGL.so -&gt; libGL.so.1</span><br><span class="line">lrwxrwxrwx 1 root root        14 Feb  7 17:13 libGL.so.1 -&gt; libGL.so.1.5.0</span><br><span class="line">-rwxr-xr-x 1 root root 111044912 Feb  7 17:13 libGL.so.1.5.0</span><br><span class="line">lrwxrwxrwx 1 root root        14 Feb  7 17:13 libOSMesa.so -&gt; libOSMesa.so.8</span><br><span class="line">lrwxrwxrwx 1 root root        18 Feb  7 17:13 libOSMesa.so.8 -&gt; libOSMesa.so.8.0.0</span><br><span class="line">-rwxr-xr-x 1 root root  51541176 Feb  7 17:13 libOSMesa.so.8.0.0</span><br><span class="line">lrwxrwxrwx 1 root root        13 Feb  7 17:13 libglapi.so -&gt; libglapi.so.0</span><br><span class="line">lrwxrwxrwx 1 root root        17 Feb  7 17:13 libglapi.so.0 -&gt; libglapi.so.0.0.0</span><br><span class="line">-rwxr-xr-x 1 root root    337264 Feb  7 17:07 libglapi.so.0.0.0</span><br><span class="line">drwxr-xr-x 1 root root       512 Feb  7 17:13 pkgconfig</span><br></pre></td></tr></table></figure>
<p>NOTE:</p>
<ul>
<li>Mesa is installed in <code>/usr/local/lib/$(uname -p)-linux-gnu</code> by default. So you have to <code>ldconfig</code> so that your linker can find them.</li>
<li>libsoftpipe.a will be built but not installed.</li>
<li>meson build system will enable compilerâ€™s <code>-g</code> flag by default unless you are building on the release branch.</li>
<li>if you have remodified the <strong>meson_options.txt</strong> and built once and now are about to reconfigure and rebuild, you need to run:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">meson setup --wipe build</span><br></pre></td></tr></table></figure>
<h1 id="ä¸-mesa-ç›¸å…³çš„ä¸€äº›å¸¸ç”¨è½¯ä»¶åŒ…"><a class="markdownIt-Anchor" href="#ä¸-mesa-ç›¸å…³çš„ä¸€äº›å¸¸ç”¨è½¯ä»¶åŒ…"></a> ä¸ mesa ç›¸å…³çš„ä¸€äº›å¸¸ç”¨è½¯ä»¶åŒ…</h1>
<h2 id="mesa-utils"><a class="markdownIt-Anchor" href="#mesa-utils"></a> mesa-utils</h2>
<p>åŒ…å«ä»¥ä¸‹ glx demo æˆ– test program</p>
<ul>
<li>glxdemo</li>
<li>glxgears</li>
<li>glxheads</li>
<li>glxinfo</li>
</ul>
<h2 id="mesa-utils-extra"><a class="markdownIt-Anchor" href="#mesa-utils-extra"></a> mesa-utils-extra</h2>
<p>åŒ…å«ä»¥ä¸‹ egl demo æˆ– test program</p>
<ul>
<li>eglinfo</li>
<li>es2_info</li>
<li>es2gears_wayland</li>
<li>es2gears_x11</li>
<li>es2tri</li>
</ul>
<h1 id="off-screen-demos"><a class="markdownIt-Anchor" href="#off-screen-demos"></a> Off-screen Demos</h1>
<p>Now that mesa have been built and installed we can give a try to run an OGL application. Similarly without window system supportd on the WSL, <a href="https://mesa3d.org/osmesa.html">off-screen rendering</a> is my choice. We can clone the mesa <a href="https://gitlab.freedesktop.org/mesa/demos">demos</a> which includes a lot of demos besides off-screen demos.</p>
<h2 id="requisite"><a class="markdownIt-Anchor" href="#requisite"></a> Requisite</h2>
<p>We need some more libraries besides libOSMesa and libGL before you can get these off-screen demos worked. They are:</p>
<ul>
<li><a href="https://gitlab.freedesktop.org/mesa/glu">GLU</a></li>
<li>libm</li>
</ul>
<p>To build these demos:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gcc osdemo.c -o osdemo -g -I/home/luc/github/demos/src/util -lGL -lGLU -lOSMesa -lm</span><br></pre></td></tr></table></figure>
<p>The executable osdemo saves the rendered pixels as the portable pixmap format. You need to covert it to image format e.g. jpg. You may do this with <code>pnmtojpeg output.ppm &gt; output.jpg</code>.</p>
<div align=center><img src="/gfx/mesa/osdemo.jpg" class="" title="osdemo"></div>
<h2 id="osmesa-call-graphs"><a class="markdownIt-Anchor" href="#osmesa-call-graphs"></a> OSMesa Call Graphs</h2>
<p>Mesa supports many features from software pipelines to hardware drivers. For example <a href="https://www.freedesktop.org/wiki/Software/gallium/">Gallium</a>, it features with several software or hardware implementations which include the two software pipelines, softpipe and <a href="https://www.mesa3d.org/llvmpipe.html">llvmpipe</a>. With the different pipes enabled will the calls walk in the different paths.</p>
<h2 id="three-different-build-configuration-reference-to-meson_optionstxt"><a class="markdownIt-Anchor" href="#three-different-build-configuration-reference-to-meson_optionstxt"></a> Three Different Build Configuration (reference to <strong>meson_options.txt</strong>)</h2>
<table>
<thead>
<tr>
<th>Option</th>
<th><em>platform</em></th>
<th><em>glx</em></th>
<th><em>dri-drivers</em></th>
<th><em>gallium-drivers</em></th>
<th><em>llvm</em></th>
<th><em>osmesa</em></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>llvmpipe</strong></td>
<td>x11</td>
<td>gallium-xlib</td>
<td></td>
<td>swrast</td>
<td>true</td>
<td>gallium</td>
</tr>
<tr>
<td><strong>softpipe</strong></td>
<td>x11</td>
<td>gallium-xlib</td>
<td></td>
<td>swrast</td>
<td>false</td>
<td>gallium</td>
</tr>
<tr>
<td><strong>tnl</strong></td>
<td>x11</td>
<td>gallium-xlib</td>
<td></td>
<td>swrast</td>
<td>true</td>
<td>classic</td>
</tr>
</tbody>
</table>
<h2 id="three-different-call-paths"><a class="markdownIt-Anchor" href="#three-different-call-paths"></a> Three Different Call Paths</h2>
<h3 id="context"><a class="markdownIt-Anchor" href="#context"></a> Context</h3>
<div align=center><img src="/gfx/mesa/OSMesaCreateContextExt.png" class="" title="context initialization"></div>
<p>NOTE: As for softpipe and llvmpipe <code>gl_api</code> and <code>gl_context</code> are created respectively while both of them are created in one path for the classic osmesa.</p>
<h3 id="draw"><a class="markdownIt-Anchor" href="#draw"></a> Draw</h3>
<div align=center><img src="/gfx/mesa/PopMatrix.png" class="" title="draw command"></div>
<h1 id="gallium-based-glx-demos"><a class="markdownIt-Anchor" href="#gallium-based-glx-demos"></a> Gallium-Based GLX Demos</h1>
<p>If you want to know the full graphic stack of an OpenGL demo, you can not get rid of the window system. That is why I will try some GLX demos. Evidently GLX demos must depend on X11. You can cope with this problem by installing <a href="https://sourceforge.net/projects/vcxsrv/">vcXsrv</a> on the Windows 10 which hosts your WSL.</p>
<div align=center><img src="/gfx/mesa/glxgears.png" class="" title="glx demo"></div>
<p>This time I still choose the gallium-xlib with softpipe. The following call graph shows the path that GLX context is created.</p>
<div align=center><img src="/gfx/mesa/glXCreateContext.png" class="" title="glx context creation"></div>
<p>As we know, Mesa is quite modularized and flexible. How does it take the path that <code>softpipe_create_context</code> rather than other pipe contexts? The <a href="https://gitlab.freedesktop.org/mesa/mesa/blob/master/src/gallium/include/state_tracker/st_api.h">st_manager</a> is a key structure.</p>
<p><code>struct pipe_screen</code> has a callback function that will be set to <code>softpipe_create_context</code>. The following calls will create <code>struct pipe_screen</code> that will be set to the <code>st_manager</code>.</p>
<div align=center><img src="/gfx/mesa/glXChooseVisual.png" class="" title="pipe_screen creation"></div>
<p>To bind the intended gallium driver backend to Mesa there must be something done before <code>glXChooseVisual</code> is called. Itâ€™s started by the library <code>init()</code> and prepare the global variables.</p>
<p><a href="https://gitlab.freedesktop.org/mesa/mesa/blob/master/src/gallium/state_trackers/glx/xlib/xm_public.h">xm_public.h</a></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* This is the driver interface required by the glx/xlib state tracker. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">xm_driver</span> &#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">pipe_screen</span> *(*<span class="title">create_pipe_screen</span>)( <span class="title">Display</span> *<span class="title">display</span> );</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">st_api</span> *(*<span class="title">create_st_api</span>)( <span class="title">void</span> );</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">xmesa_set_driver</span><span class="params">( <span class="type">const</span> <span class="keyword">struct</span> xm_driver *driver )</span>;</span><br></pre></td></tr></table></figure>
<h1 id="dri-based-glx-demos"><a class="markdownIt-Anchor" href="#dri-based-glx-demos"></a> DRI-Based GLX Demos</h1>
<h2 id="loading"><a class="markdownIt-Anchor" href="#loading"></a> Loading</h2>
<ul>
<li><code>__glXInitialize</code></li>
<li><code>driOpenDriver</code></li>
</ul>
<p>This process of loading drivers works similarly with that of gallium-based glx. Compilation macros and environment variables make a difference. There are several approaches to load the specific drivers:</p>
<ul>
<li><code>dri3_create_display</code></li>
<li><code>dri2CreateDisplay</code></li>
<li><code>driCreateDisplay</code></li>
<li><code>driswCreateDisplay</code></li>
<li><code>applegl_create_display</code></li>
<li><code>driwindowsCreateDisplay</code></li>
</ul>
<p>Letâ€™s look into <code>driCreateDisplay</code>. Once it manages to attach to <code>driCreateScreen</code> which searches and matches the appropriate gallium driver the function <code>driOpenDriver</code> will open the <strong>found</strong> driver by its name like â€œi965â€, â€œradeonâ€, â€œnouveauâ€, etc. These drivers are supposed to be installed at <strong><code>LIBGL_DRIVERS_PATH</code></strong> or <code>LIBGL_DRIVERS_DIR</code>(deprecated) and named as <code>*_dri.so</code> by default.</p>
<p>Like Gallium-based GLXâ€™s <code>_init</code> routine with GCC <strong><code>constructor</code></strong> attribute, DRI-based GLX also defines a routine <code>megadriver_stub_init</code> with <code>constructor</code> attribute which allows to load the specific driver in a way of <strong><code>__DRIextension</code></strong>.</p>
<div align=center><img src="/gfx/mesa/gdb.svg" class="" title="osdemo"></div>
<h2 id="contexts"><a class="markdownIt-Anchor" href="#contexts"></a> Contexts</h2>
<p>There are a variety of <strong>contexts</strong> in Mesa. They are designed as a framework of layers.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__________________</span><br><span class="line">|                |</span><br><span class="line">|   gl_contex    | --------------&gt; standard &amp; general</span><br><span class="line">|________________|</span><br><span class="line"></span><br><span class="line">__________________</span><br><span class="line">|                |</span><br><span class="line">|   st_contex    | --------------&gt; adapter</span><br><span class="line">|________________|</span><br><span class="line"></span><br><span class="line">__________________</span><br><span class="line">|                |</span><br><span class="line">|  draw_contex   | --------------&gt; driver-specific</span><br><span class="line">|________________|</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="gl_context"><a class="markdownIt-Anchor" href="#gl_context"></a> gl_context</h3>
<blockquote><p>This is the central context data structure for Mesa. Almost all OpenGL state is contained in this structure. Think of this as a base class from which device drivers will derive sub classes.</p>
</blockquote>
<p>Apart from OpenGL state it contains several other contexts</p>
<ul>
<li><code>swrast_context</code></li>
<li><code>swsetup_context</code></li>
<li><code>swtnl_context</code></li>
<li><code>vbo_context</code></li>
<li><code>st_context</code></li>
</ul>
<h3 id="st_context"><a class="markdownIt-Anchor" href="#st_context"></a> st_context</h3>
<h3 id="draw_context"><a class="markdownIt-Anchor" href="#draw_context"></a> draw_context</h3>
<h3 id="vbo_context"><a class="markdownIt-Anchor" href="#vbo_context"></a> vbo_context</h3>
<p>VBO is short for vertex buffer object. This context derives two kinds of vbo contexts, <code>vbo_exec_context</code> and <code>vbo_save_context</code> which <code>vbo_exec_context</code> is generic for core and compatible ogl and the other is specific for compatible ogl.</p>
<h4 id="vbo_exec_vtx_init"><a class="markdownIt-Anchor" href="#vbo_exec_vtx_init"></a> vbo_exec_vtx_init</h4>
<ul>
<li>Allocate a <code>gl_buffer_object</code> which just is referenced.</li>
<li>Initialize vbo attributes including size, type and active size.</li>
</ul>
<h4 id="vbo-vs-vao"><a class="markdownIt-Anchor" href="#vbo-vs-vao"></a> vbo vs. vao</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gl_buffer_object</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   GLint RefCount;</span><br><span class="line">   GLuint Name;</span><br><span class="line">   GLchar *Label;       </span><br><span class="line">   GLenum16 Usage;      </span><br><span class="line">   GLbitfield StorageFlags; </span><br><span class="line">   GLsizeiptrARB Size;  </span><br><span class="line">   GLubyte *Data;       </span><br><span class="line">   GLboolean DeletePending;   </span><br><span class="line">   GLboolean Written;   </span><br><span class="line">   GLboolean Purgeable; </span><br><span class="line">   GLboolean Immutable; </span><br><span class="line">   gl_buffer_usage UsageHistory; </span><br><span class="line">   GLuint NumSubDataCalls;</span><br><span class="line">   GLuint NumMapBufferWriteCalls;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">gl_buffer_mapping</span> <span class="title">Mappings</span>[<span class="title">MAP_COUNT</span>];</span></span><br><span class="line">   <span class="type">simple_mtx_t</span> MinMaxCacheMutex;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">hash_table</span> *<span class="title">MinMaxCache</span>;</span></span><br><span class="line">   <span class="type">unsigned</span> MinMaxCacheHitIndices;</span><br><span class="line">   <span class="type">unsigned</span> MinMaxCacheMissIndices;</span><br><span class="line">   <span class="type">bool</span> MinMaxCacheDirty;</span><br><span class="line">   <span class="type">bool</span> HandleAllocated; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gl_vertex_array_object</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   GLuint Name;</span><br><span class="line">   GLint RefCount;</span><br><span class="line">   GLchar *Label;       </span><br><span class="line">   GLboolean EverBound;</span><br><span class="line">   <span class="type">bool</span> SharedAndImmutable;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">gl_array_attributes</span> <span class="title">VertexAttrib</span>[<span class="title">VERT_ATTRIB_MAX</span>];</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">gl_vertex_buffer_binding</span> <span class="title">BufferBinding</span>[<span class="title">VERT_ATTRIB_MAX</span>];</span></span><br><span class="line">   GLbitfield VertexAttribBufferMask;</span><br><span class="line">   GLbitfield Enabled;</span><br><span class="line">   GLbitfield _EffEnabledVBO;</span><br><span class="line">   gl_attribute_map_mode _AttributeMapMode;</span><br><span class="line">   GLbitfield NewArrays;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">gl_buffer_object</span> *<span class="title">IndexBufferObj</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="dispatchers"><a class="markdownIt-Anchor" href="#dispatchers"></a> Dispatchers</h2>
<ul>
<li><em><code>Exec</code></em>: The current dispatch table for non-displaylist-saving execution, either BeginEnd or OutsideBeginEnd</li>
<li><em><code>OutsideBeginEnd</code></em>: The normal dispatch table for non-displaylist-saving, non-begin/end</li>
<li><em><code>Save</code></em>: The dispatch table used between glNewList() and glEndList()</li>
<li><em><code>BeginEnd</code></em>: The dispatch table used between glBegin() and glEnd() (outside of a display list). Only valid functions between those two are set, which is mostly just the set in a GLvertexformat struct.</li>
<li><em><code>ContextLost</code></em>: Dispatch table for when a graphics reset has happened.</li>
<li><em><code>MarshalExec</code></em>: Dispatch table used to marshal API calls from the client program to a separate server thread. NULL if API calls are not being marshalled to another thread.</li>
<li><em><code>CurrentClientDispatch</code></em>: Dispatch table currently in use for fielding API calls from the client program. If API calls are being marshalled to another thread, this refers to <em><code>MarshalExec</code></em>. Otherwise it refers to <em><code>CurrentServerDispatch</code></em>.</li>
<li><em><code>CurrentServerDispatch</code></em>: Dispatch table currently in use for performing API calls. It refers to <em><code>Save</code></em> or <em><code>Exec</code></em>.</li>
</ul>
<h2 id="modules"><a class="markdownIt-Anchor" href="#modules"></a> Modules</h2>
<ul>
<li>draw module</li>
<li>CSO module</li>
<li>translate module</li>
<li>VBO module</li>
<li>TNL module(Transform &amp; Light)</li>
</ul>
<h2 id="draw_xxx_stage"><a class="markdownIt-Anchor" href="#draw_xxx_stage"></a> draw_xxx_stage</h2>
<ul>
<li><strong><code>extern struct draw_stage *draw_unfilled_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_twoside_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_offset_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_clip_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_flatshade_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_cull_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_stipple_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_wide_line_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_wide_point_stage( struct draw_context *context );</code></strong></li>
<li><strong><code>extern struct draw_stage *draw_validate_stage( struct draw_context *context );</code></strong></li>
</ul>
<h2 id="auxiliary"><a class="markdownIt-Anchor" href="#auxiliary"></a> Auxiliary</h2>
<ul>
<li>
<p>cso_cache<br />
The CSO cache is used to accelerate preparation of state by saving driver-specific state structure for later use.</p>
</li>
<li>
<p>draw<br />
Draw is a software TCL pipeline for hardware that lacks vertex shaders or other essential parts of pre-rasterization vertex preparation.</p>
</li>
<li>
<p>driver_ddebug</p>
</li>
<li>
<p>driver_noop</p>
</li>
<li>
<p>driver_rbug</p>
</li>
<li>
<p>driver_trace</p>
</li>
<li>
<p>gallivm</p>
</li>
<li>
<p>hud</p>
</li>
<li>
<p>indices<br />
Indices provides tools for translating or generating element indices for use with element-based rendering.</p>
</li>
<li>
<p>nir</p>
</li>
<li>
<p>os</p>
<ul>
<li>memory allocation</li>
<li>simple message logging</li>
<li>obtaining run-time configuration option</li>
<li>threading primitives<br />
The OS module contains the abstraction for basic operating system services above. This is the bare minimum required to port Gallium to a new platform. It already provides the implementations of these abstractions for the most common platforms. When targeting an embedded platform no implementation will be provided - these must be provided separately.</li>
</ul>
</li>
<li>
<p>pipe-loader</p>
</li>
<li>
<p>pipebuffer</p>
</li>
<li>
<p>postprocess</p>
</li>
<li>
<p>rbug</p>
</li>
<li>
<p>renderonly</p>
</li>
<li>
<p>rtasm</p>
</li>
<li>
<p>target-helpers</p>
</li>
<li>
<p>tgsi</p>
</li>
<li>
<p>translate</p>
</li>
<li>
<p>util</p>
</li>
<li>
<p>vl</p>
</li>
</ul>
<h1 id="qa"><a class="markdownIt-Anchor" href="#qa"></a> Q&amp;A</h1>
<ul>
<li>When xlib creates pipe screen, <em>only</em> software rasterizers or pipesâ€™screen are created. And llvmpipe, softpipe, virgl, swr, unexceptionally, are software rasterizers or virtual GPU. <a href="https://www.collabora.com/news-and-blog/blog/2018/10/31/introducing-zink-opengl-implementation-vulkan/">Zink</a> is, in brief, a translator from OpenGL to Vulkan and implemented as Gallium driver. So why only software pipes?</li>
</ul>
<p>The answer is <strong><code>sw_winsys</code></strong>. All of target helpersâ€™s parameter is a <code>sw_winsys</code>. Check mesa source directory: <a href="https://gitlab.freedesktop.org/mesa/mesa/tree/master/src/gallium/winsys">mesa/src/gallium/winsys</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">amdgpu</span><br><span class="line">etnaviv</span><br><span class="line">freedreno</span><br><span class="line">i915</span><br><span class="line">iris</span><br><span class="line">kmsro</span><br><span class="line">lima</span><br><span class="line">nouveau</span><br><span class="line">panfrost</span><br><span class="line">radeon</span><br><span class="line">svga</span><br><span class="line">sw</span><br><span class="line">tegra</span><br><span class="line">v3d</span><br><span class="line">vc4</span><br><span class="line">virgl</span><br></pre></td></tr></table></figure>
<p>To put it simply, specific driver corresponds to specific winsys. The <code>sw</code> is for software rasterizers. If you expect to create pipe screen for some driver else, you need to add another target helper with its winsys as parameter like:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">static inline struct pipe_screen *</span><br><span class="line">i915_screen_create_named(struct i915_drm_winsys *winsys, const char *driver)</span><br></pre></td></tr></table></figure>
<p>That means you have to declare a bunch of new interfaces from the top. So youâ€™d better wrap the function to create specific driverâ€™s winsys so that it can take a sw_winsys as its parameter like:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#if defined(GALLIUM_VIRGL)</span><br><span class="line">   if (screen == NULL &amp;&amp; strcmp(driver, &quot;virpipe&quot;) == 0) &#123;</span><br><span class="line">      struct virgl_winsys *vws;</span><br><span class="line">      vws = virgl_vtest_winsys_wrap(winsys);</span><br><span class="line">      screen = virgl_create_screen(vws, NULL);</span><br><span class="line">   &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><a href="http://libGL.so">libGL.so</a> is not built until glx option is enabled in <strong>meson_options.txt</strong>.</li>
</ul>
<p>Only with essential build-time dependencies for X11 installed and glx option configured is <a href="http://libGL.so">libGL.so</a> built.</p>
<ul>
<li>What role do DRM, DRI and Gallium play in Mesa?</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_libdrm_checks = [</span><br><span class="line">  [&#x27;intel&#x27;, with_dri_i915 or with_gallium_i915],</span><br><span class="line">  [&#x27;amdgpu&#x27;, with_amd_vk or with_gallium_radeonsi],</span><br><span class="line">  [&#x27;radeon&#x27;, (with_gallium_radeonsi or with_dri_r100 or with_dri_r200 or</span><br><span class="line">              with_gallium_r300 or with_gallium_r600)],</span><br><span class="line">  [&#x27;nouveau&#x27;, (with_gallium_nouveau or with_dri_nouveau)],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>DRI and Gallium seem to be respectively different underlying implementation in Mesa. Moreover in term of swrast and i915, you have to choose either of both as you can read the following code snippet in meson.build. In fact DRI is more complicated and staler but Gallium is more smaller and simpler.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if with_dri_swrast and (with_gallium_softpipe or with_gallium_swr)</span><br><span class="line">  error(&#x27;Only one swrast provider can be built&#x27;)</span><br><span class="line">endif</span><br><span class="line">if with_dri_i915 and with_gallium_i915</span><br><span class="line">  error(&#x27;Only one i915 provider can be built&#x27;)</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>What problems are encountered when you build mesa on the WSL?</p>
</li>
<li>
<p>dri based GLX requires shared-glapi</p>
</li>
<li>
<p>Gallium-xlib based GLX requires softpipe or llvmpipe</p>
<ul>
<li>means that <code>gallium-xlib</code> is supposed to only support software rasterizers(llvmpipe, softpipe) and virtual GPU(virgl, swr).</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">option(</span><br><span class="line">  &#x27;glx&#x27;,</span><br><span class="line">  type : &#x27;combo&#x27;,</span><br><span class="line">  value : &#x27;xlib&#x27;,</span><br><span class="line">  choices : [&#x27;auto&#x27;, &#x27;disabled&#x27;, &#x27;dri&#x27;, &#x27;xlib&#x27;, &#x27;gallium-xlib&#x27;],</span><br><span class="line">  description : &#x27;Build support for GLX platform&#x27;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>In Mesa, glx is implemented in three ways:</p>
<table>
<thead>
<tr>
<th>*-based</th>
<th>backend</th>
<th>window system</th>
</tr>
</thead>
<tbody>
<tr>
<td>dri-based</td>
<td>non-sw-pipes</td>
<td>*_drm_winsys</td>
</tr>
<tr>
<td>xlib</td>
<td>tnl</td>
<td>sw_winsys</td>
</tr>
<tr>
<td>gallium-based</td>
<td>softpipe/llvmpipe</td>
<td>sw_winsys</td>
</tr>
</tbody>
</table>
<ul>
<li>OSMesa gallium requires gallium softpipe or llvmpipe
<ul>
<li>means if <code>osmesa</code> is configured as <code>gallium</code>, <code>gallium-drivers</code> must include <code>swrast</code> but the <code>classic</code> osmesa uses the fixed-functioned TNL by default.</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">option(</span><br><span class="line">  &#x27;osmesa&#x27;,</span><br><span class="line">  type : &#x27;combo&#x27;,</span><br><span class="line">  value : &#x27;gallium&#x27;,</span><br><span class="line">  choices : [&#x27;none&#x27;, &#x27;classic&#x27;, &#x27;gallium&#x27;],</span><br><span class="line">  description : &#x27;Build OSmesa.&#x27;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>Cannot build GLX support without X11 platform support and at least one OpenGL API</p>
<ul>
<li>GLX, As the name suggests, is dedicated to X11 winsys.</li>
</ul>
</li>
<li>
<p>When <code>__glXInitialize</code> creates the <code>Display</code>, <strong>only</strong> <code>driswCreateDisplay</code> returns successfully. Both of <code>dri2CreateDisplay</code> and <code>driCreateDisplay</code> failed.</p>
</li>
<li>
<p>env: WSL on Windows 10 and with vcXsrv installed on the host as X server</p>
</li>
</ul>
<p>The cause of failure is that vcXsrv has no extensions with DRI or DRI2. This lack of X server extension fails <code>DRI2QueryExtension</code> and <code>XF86DRIQueryExtension</code> so that the loading of gallium driver is not invoked.</p>
<h1 id="debug"><a class="markdownIt-Anchor" href="#debug"></a> Debug</h1>
<h2 id="ç¯å¢ƒå˜é‡"><a class="markdownIt-Anchor" href="#ç¯å¢ƒå˜é‡"></a> ç¯å¢ƒå˜é‡</h2>
<ul>
<li>MESA_VERBOSE=comma-separated-list
<ul>
<li>MESA_VERBOSE=api</li>
</ul>
</li>
<li>MESA_GLSL=comma-separated-list
<ul>
<li><code>MESA_GLSL=log</code> æŠŠæ‰€æœ‰ GLSL shader ä¿å­˜åˆ°æ–‡ä»¶é‡Œï¼Œ shader_X.vert æˆ– shader_X.frag</li>
</ul>
</li>
</ul>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://docs.mesa3d.org/shading.html#environment-variables">mdoc: Shading Languages Environment Variables</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Mesa</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenGL Extensionså’ŒVersion</title>
    <url>/gfx/ogl-extension/</url>
    <content><![CDATA[<h1 id="talk-about"><a class="markdownIt-Anchor" href="#talk-about"></a> Talk About</h1>
<ul>
<li>OpenGL Extensionsæœ‰å“ªäº›åˆ†ç±»ï¼Ÿ</li>
<li>Conformant OpenGL implementationæ˜¯ä»€ä¹ˆ?</li>
<li>OpenGL Extensionså’ŒOpenGL Versionsæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</li>
<li>OpenGL Extensionså’Œconformant OpenGL implementationæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</li>
</ul>
<span id="more"></span>
<h2 id="opengl-extensions-category"><a class="markdownIt-Anchor" href="#opengl-extensions-category"></a> OpenGL Extensions Category</h2>
<p>ä¸¥æ ¼æ¥è¯´ï¼ŒOpenGL Extensionså¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼Œä½†ä¹Ÿå¯ä»¥åˆ†ä¸ºä¸¤ç±»ã€‚</p>
<h3 id="å¦‚æœæŒ‰ç…§khronosçš„extensions-name-conventionå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»"><a class="markdownIt-Anchor" href="#å¦‚æœæŒ‰ç…§khronosçš„extensions-name-conventionå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»"></a> å¦‚æœæŒ‰ç…§Khronosçš„<a href="https://www.khronos.org/registry/OpenGL/docs/rules.html#spec_naming">Extensions Name Convention</a>å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ç±»ï¼š</h3>
<ul>
<li>vendor-specific (â€œNVâ€, â€œATIâ€, etc)</li>
<li>multivendor (EXT)</li>
<li>Khronos-approved (â€œARBâ€, â€œOESâ€, â€œOMLâ€)</li>
</ul>
<p>å…·ä½“è¯´ï¼Œ Khronosçš„Extensionå‘½åè§„åˆ™æ˜¯<code>api_category_name</code>, å¯¹äº<strong>OpenGL</strong> APIæ¥è¯´<code>api</code>å°±æ˜¯<code>GL</code>, <code>category</code>å°±æ˜¯ä¸Šé¢çš„ä¸‰ç±»ï¼Œå¯¹äºç¬¬ä¸‰ç±»<strong>Khronos-approved</strong> Extensions, <code>category</code>è¿˜ä¼šç»†åˆ†</p>
<ul>
<li>&quot;ARB&quot;æˆ–&quot;KHR&quot;ä¸“é—¨æŒ‡<strong>OpenGL</strong> Extensions</li>
<li>&quot;OES&quot;ä¸“é—¨æŒ‡<strong>OpenGL ES</strong> Extensions</li>
<li>&quot;OML&quot;ä¸“é—¨æŒ‡<strong>OpenML</strong> Extensions</li>
</ul>
<h3 id="å¦‚æœæŒ‰ç…§khronosçš„opengl-registry-extension-specificationså¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»"><a class="markdownIt-Anchor" href="#å¦‚æœæŒ‰ç…§khronosçš„opengl-registry-extension-specificationså¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»"></a> å¦‚æœæŒ‰ç…§Khronosçš„<a href="https://www.khronos.org/registry/OpenGL/index_gl.php">OpenGL Registry Extension Specifications</a>å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»:</h3>
<ul>
<li><a href="https://www.khronos.org/registry/OpenGL/index_gl.php#arbextspecs">OpenGL ARB Extensions Specifications</a></li>
<li><a href="https://www.khronos.org/registry/OpenGL/index_gl.php#arbextspecs">OpenGL Vendor and EXT Extension Specifications</a></li>
</ul>
<h3 id="khronos-approved-extensions"><a class="markdownIt-Anchor" href="#khronos-approved-extensions"></a> Khronos-approved Extensions</h3>
<p>è¿™é‡Œé‡ç‚¹ç†ä¸€ä¸‹<strong>Khronos-approved</strong> Extensions(æˆ–è€…**â€œGL_ARB_<em>&quot;<strong>å’Œ</strong>&quot;GL_KHR_</em>â€**), å› ä¸ºKhronos-approved Extensionsä¸ä¸‹é¢ä¸¤ä¸ªé—®é¢˜å¯†åˆ‡ç›¸å…³ï¼š</p>
<ul>
<li>OpenGL Extensionså’ŒOpenGL Versionsæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</li>
<li>OpenGL Extensionså’Œconformant OpenGL implementationæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</li>
</ul>
<p>å…ˆçœ‹ä¸€ä¸‹<a href="https://www.khronos.org/registry/OpenGL/specs/gl/glspec46.core.pdf">OpenGL 4.6 Core Profile Specification</a></p>
<h4 id="k3-arb-and-khronos-extensions"><a class="markdownIt-Anchor" href="#k3-arb-and-khronos-extensions"></a> K.3 ARB and Khronos Extensions</h4>
<blockquote><p>OpenGL extensions that have been approved by the Khronos OpenGL Architectural Review Board Working Group(ARB), or jointly approved by the ARB and the Khronos OpenGL ES Working Group(KHR), are summarized in this section. ARB and KHR extensions are NOT required to be supported by a CONFORMANT OpenGL implementation, but are expected to be widely available; they define functionality that is likely to move into the REQUIRED feature set in a future revision of the specification.</p>
</blockquote>
<p>æ‰€æœ‰è¢«ARBæ‰¹å‡†çš„ï¼Œæˆ–è€…è¢«ARBå’ŒKHRè”åˆæ‰¹å‡†çš„OpenGL Extensionsè¢«ç½—åˆ—åœ¨æœ¬ç« èŠ‚ã€‚è¿™äº›Extensionsä¸æ˜¯ä¸€ä¸ª<strong>Conformant</strong> OpenGLå®ç°æ‰€å¿…é¡»æ”¯æŒçš„ï¼Œä½†å®ƒä»¬åº”è¯¥è¢«å¤§å¤šæ•°OpenGLå®ç°éƒ½æ”¯æŒï¼›å®ƒä»¬æ‰€å®šä¹‰çš„åŠŸèƒ½å¾ˆæœ‰å¯èƒ½åœ¨æœªæ¥çš„OpenGL Specificationé‡ŒåŠ åˆ°<strong>å¿…é¡»æ”¯æŒçš„ç‰¹æ€§é›†</strong>ä¸­ã€‚</p>
<h4 id="k31-naming-conventions"><a class="markdownIt-Anchor" href="#k31-naming-conventions"></a> K.3.1 Naming Conventions</h4>
<p>ä¸ºäº†åŒºåˆ†<strong>ARB</strong>å’Œ<strong>KHR</strong> extensionså’Œcore OpenGL extensions(required core features), ä»¥åŠvendor-specific extensions, æœ‰ä»¥ä¸‹extensionå‘½åè§„èŒƒï¼š</p>
<ul>
<li>æ¯ä¸ªKhronos-approved extensionéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åå­—å­—ç¬¦ä¸²&quot;GL_ARB_name&quot;æˆ–&quot;GL_KHR_name&quot;, å¦‚æœæŸä¸ªOpenGLå®ç°æ”¯æŒæŸä¸ªextension,é‚£ä¹ˆè¿™ä¸ªextensionçš„åå­—å­—ç¬¦ä¸²å°±è¦å‡ºç°åœ¨è°ƒç”¨<code>glGetStringi(EXTENSIONS);</code>çš„è¿”å›å€¼é‡Œã€‚</li>
<li>æ‰€æœ‰åœ¨è¿™ä¸ªextensioné‡Œå®šä¹‰çš„å‡½æ•°ï¼Œå‡½æ•°åéƒ½ä»¥<code>FunctionARB</code>æˆ–<code>FunctionKHR</code>å‘½åã€‚</li>
<li>æ‰€æœ‰åœ¨è¿™ä¸ªextensioné‡Œå®šä¹‰çš„æšä¸¾ï¼Œæšä¸¾åéƒ½ä»¥<code>NAME_ARB</code>æˆ–<code>NAME_KHR</code>å‘½åã€‚</li>
</ul>
<h4 id="k32-promoting-extensions-to-core-features"><a class="markdownIt-Anchor" href="#k32-promoting-extensions-to-core-features"></a> K.3.2 Promoting Extensions to Core Features</h4>
<p>Khronos-approved, multivendor, ä»¥åŠvendor-specific extensionséƒ½å¯ä»¥è¢«_æ™‹å‡_(<em>promoted</em>)åŠ å…¥åˆ°OpenGLæ ¸å¿ƒç‰¹æ€§é›†(required core features). ä¸€æ—¦è¢«åŠ å…¥ï¼Œç›¸åº”çš„extension specificationå°†è¢«åˆå…¥åˆ°core specification. åœ¨è¿™ä¸ªextensioné‡Œå®šä¹‰çš„å‡½æ•°å’Œæšä¸¾ä¹Ÿå°†_åˆ é™¤_å®ƒä»¬çš„<strong>ARB</strong>, <strong>KHR</strong>, <strong>EXT</strong>, æˆ–è€…<strong>vendoråç¼€</strong>ã€‚è€Œä¸”æ”¯æŒè¿™äº›è¢«_æ™‹å‡_çš„extensionçš„OpenGLå®ç°åº”è¯¥ç»§ç»­æ”¯æŒå¸¦åç¼€çš„å‡½æ•°åå’Œæšä¸¾åã€‚</p>
<h2 id="what-is-the-relationship-between-opengl-extensions-and-opengl-versions"><a class="markdownIt-Anchor" href="#what-is-the-relationship-between-opengl-extensions-and-opengl-versions"></a> What Is The Relationship Between OpenGL Extensions And OpenGL Versions?</h2>
<p>ä¸‹é¢è¿™å¼ å›¾å±•ç¤ºå„ç§OpenGL extensionsé›†åˆçš„å…³ç³»ã€‚åªæœ‰é‚£äº›<strong>Required Core Features(Extensions)<strong>æ‰ä¼šè¢«çº³å…¥åˆ°å„ä¸ª</strong>OpenGL Core Profile Specification</strong>ï¼Œ ä¹Ÿå³OpenGL versionsæ˜¯é€šè¿‡ä¸æ–­åŠ å…¥æ–°çš„Required Core Featuresæ¥å‡çº§çš„ã€‚</p>
<div align=center><img src="/gfx/ogl-extension/extensions.png" class="" title="venn diagram of extensions"></div>
<h1 id="opengl-es-and-glsl-es-version"><a class="markdownIt-Anchor" href="#opengl-es-and-glsl-es-version"></a> OpenGL (ES) and GLSL (ES) Version</h1>
<h2 id="khronoså‘å¸ƒopenglesåŠglslesçš„æ—¶é—´"><a class="markdownIt-Anchor" href="#khronoså‘å¸ƒopenglesåŠglslesçš„æ—¶é—´"></a> Khronoså‘å¸ƒOpenGL(ES)åŠGLSL(ES)çš„æ—¶é—´</h2>
<table>
<thead>
<tr>
<th style="text-align:left">Standard</th>
<th style="text-align:center">Birth</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">OpenGL</td>
<td style="text-align:center">1992</td>
</tr>
<tr>
<td style="text-align:left">OpenGL ES</td>
<td style="text-align:center">2003</td>
</tr>
<tr>
<td style="text-align:left">GLSL</td>
<td style="text-align:center">2004</td>
</tr>
<tr>
<td style="text-align:left">GLSL ES</td>
<td style="text-align:center">2007</td>
</tr>
</tbody>
</table>
<h2 id="opengl-version"><a class="markdownIt-Anchor" href="#opengl-version"></a> OpenGL Version</h2>
<table>
<thead>
<tr>
<th style="text-align:center">GL Version</th>
<th style="text-align:center">Release</th>
<th style="text-align:center">GLSL Version</th>
<th style="text-align:left">Preprocessor</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1.0</td>
<td style="text-align:center">1992</td>
<td style="text-align:center"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">1.1</td>
<td style="text-align:center">1997</td>
<td style="text-align:center"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">1.2</td>
<td style="text-align:center">1998</td>
<td style="text-align:center"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">1.3</td>
<td style="text-align:center">2001</td>
<td style="text-align:center"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">1.4</td>
<td style="text-align:center">2002</td>
<td style="text-align:center"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">1.5</td>
<td style="text-align:center">2003</td>
<td style="text-align:center"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">2.0</td>
<td style="text-align:center">2004</td>
<td style="text-align:center">1.10</td>
<td style="text-align:left">#version 110</td>
</tr>
<tr>
<td style="text-align:center">2.1</td>
<td style="text-align:center">2006</td>
<td style="text-align:center">1.20</td>
<td style="text-align:left">#version 120</td>
</tr>
<tr>
<td style="text-align:center">3.0</td>
<td style="text-align:center">2008</td>
<td style="text-align:center">1.30</td>
<td style="text-align:left">#version 130</td>
</tr>
<tr>
<td style="text-align:center">3.1</td>
<td style="text-align:center">2009</td>
<td style="text-align:center">1.40</td>
<td style="text-align:left">#version 140</td>
</tr>
<tr>
<td style="text-align:center">3.2</td>
<td style="text-align:center">2009</td>
<td style="text-align:center">1.50</td>
<td style="text-align:left">#version 150</td>
</tr>
<tr>
<td style="text-align:center">3.3</td>
<td style="text-align:center">2010</td>
<td style="text-align:center">3.30</td>
<td style="text-align:left">#version 330</td>
</tr>
<tr>
<td style="text-align:center">4.0</td>
<td style="text-align:center">2010</td>
<td style="text-align:center">4.00</td>
<td style="text-align:left">#version 400</td>
</tr>
<tr>
<td style="text-align:center">4.1</td>
<td style="text-align:center">2010</td>
<td style="text-align:center">4.10</td>
<td style="text-align:left">#version 410</td>
</tr>
<tr>
<td style="text-align:center">4.2</td>
<td style="text-align:center">2011</td>
<td style="text-align:center">4.20</td>
<td style="text-align:left">#version 420</td>
</tr>
<tr>
<td style="text-align:center">4.3</td>
<td style="text-align:center">2012</td>
<td style="text-align:center">4.30</td>
<td style="text-align:left">#version 430</td>
</tr>
<tr>
<td style="text-align:center">4.4</td>
<td style="text-align:center">2013</td>
<td style="text-align:center">4.40</td>
<td style="text-align:left">#version 440</td>
</tr>
<tr>
<td style="text-align:center">4.5</td>
<td style="text-align:center">2014</td>
<td style="text-align:center">4.50</td>
<td style="text-align:left">#version 450</td>
</tr>
<tr>
<td style="text-align:center">4.6</td>
<td style="text-align:center">2017</td>
<td style="text-align:center">4.60</td>
<td style="text-align:left">#version 460</td>
</tr>
</tbody>
</table>
<h2 id="opengl-shading-language-es-version"><a class="markdownIt-Anchor" href="#opengl-shading-language-es-version"></a> OpenGL (Shading Language) ES Version</h2>
<table>
<thead>
<tr>
<th style="text-align:center">OpenGL ES</th>
<th style="text-align:center">Release</th>
<th style="text-align:center">GLSL ES (ESSL)</th>
<th style="text-align:left">Directive</th>
<th style="text-align:center">GLSL based</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1.0</td>
<td style="text-align:center">2003</td>
<td style="text-align:center">N/A</td>
<td style="text-align:left">N/A</td>
<td style="text-align:center">N/A</td>
</tr>
<tr>
<td style="text-align:center">1.1</td>
<td style="text-align:center">2004</td>
<td style="text-align:center">N/A</td>
<td style="text-align:left">N/A</td>
<td style="text-align:center">N/A</td>
</tr>
<tr>
<td style="text-align:center">2.0</td>
<td style="text-align:center">2007</td>
<td style="text-align:center">1.00</td>
<td style="text-align:left"><code>#version 100</code></td>
<td style="text-align:center">1.20</td>
</tr>
<tr>
<td style="text-align:center">3.0</td>
<td style="text-align:center">2012</td>
<td style="text-align:center">3.00</td>
<td style="text-align:left"><code>#version 300 es</code></td>
<td style="text-align:center">3.30</td>
</tr>
<tr>
<td style="text-align:center">3.1</td>
<td style="text-align:center">2014</td>
<td style="text-align:center">3.10</td>
<td style="text-align:left"><code>#version 310 es</code></td>
<td style="text-align:center">3.30</td>
</tr>
<tr>
<td style="text-align:center">3.2</td>
<td style="text-align:center">2015</td>
<td style="text-align:center">3.20</td>
<td style="text-align:left"><code>#version 320 es</code></td>
<td style="text-align:center">3.30</td>
</tr>
</tbody>
</table>
<h1 id="pipe_cap_-vs-extensions-in-mesa"><a class="markdownIt-Anchor" href="#pipe_cap_-vs-extensions-in-mesa"></a> <code>PIPE_CAP_*</code> vs Extensions in Mesa</h1>
<p><img src="/images/extension2version.png" alt="determination of gl version" /></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Use pipe_screen::get_param() to query PIPE_CAP_ values to determine</span></span><br><span class="line"><span class="comment"> * which GL extensions are supported.</span></span><br><span class="line"><span class="comment"> * Quite a few extensions are always supported because they are standard</span></span><br><span class="line"><span class="comment"> * features or can be built on top of other gallium features.</span></span><br><span class="line"><span class="comment"> * Some fine tuning may still be needed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">st_init_extensions</span><span class="params">(<span class="keyword">struct</span> pipe_screen *screen,</span></span><br><span class="line"><span class="params">                        <span class="keyword">struct</span> gl_constants *consts,</span></span><br><span class="line"><span class="params">                        <span class="keyword">struct</span> gl_extensions *extensions,</span></span><br><span class="line"><span class="params">                        <span class="keyword">struct</span> st_config_options *options,</span></span><br><span class="line"><span class="params">                        gl_api api)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Examine enabled GL extensions to determine GL version.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> GLuint</span><br><span class="line"><span class="title function_">compute_version</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> gl_extensions *extensions,</span></span><br><span class="line"><span class="params">                <span class="type">const</span> <span class="keyword">struct</span> gl_constants *consts, gl_api api)</span></span><br></pre></td></tr></table></figure>
<h1 id="faq"><a class="markdownIt-Anchor" href="#faq"></a> FAQ</h1>
<ol>
<li>ä¸ºä»€ä¹ˆGLSL ES 1.00åé¢æ˜¯3.00ç‰ˆæœ¬ï¼Ÿ</li>
</ol>
<p>åœ¨GLSL ES 3.00 Specé‡Œæœ‰è¿™æ ·ä¸€æ®µè¯´æ˜ï¼š</p>
<blockquote><p>This version of the language is based on version 3.30 of the desktop GLSL. However it includes a number of features that are in version 4.20 but not 3.30. The previous version of GLSL ES was version 1.00 so this version could be called version 2.00.</p>
<p>RESOLUTION: Follow the desktop GLSL convention so that the language version matches the API version. Hence this version will be called 3.00</p>
</blockquote>
<p>GLSL ES 3.10 &amp; 3.20é‡ŒåŒæ ·æœ‰è¿™æ®µè¯´æ˜ï¼Œæ‰€ä»¥ï¼Œ3.00ä¸»è¦æ˜¯ä¸ºäº†å¯¹åº”OpenGL ES APIçš„ç‰ˆæœ¬å·ï¼Œ3.10, 3.20åŒæ ·æ˜¯ã€‚</p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenGL Pipeline</title>
    <url>/gfx/ogl-pipeline/</url>
    <content><![CDATA[<h1 id="opengl-pipeline"><a class="markdownIt-Anchor" href="#opengl-pipeline"></a> OpenGL Pipeline</h1>
<p><img src="/images/../ogl-pipeline/ogl-pipeline.png" alt="" /></p>
<h1 id="opengl-pipeline-stage-flowchart"><a class="markdownIt-Anchor" href="#opengl-pipeline-stage-flowchart"></a> OpenGL Pipeline Stage Flowchart</h1>
<p><img src="/images/../ogl-pipeline/RenderingPipeline.png" alt="" /></p>
<p>è¯´æ˜:</p>
<ol>
<li>è“è‰²æ¡†è¡¨ç¤ºæ˜¯Programmable Shader Stages</li>
<li>è™šçº¿æ¡†è¡¨ç¤ºæ˜¯Optional Shader Stages</li>
</ol>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenGL Objects</title>
    <url>/gfx/opengl-objects/</url>
    <content><![CDATA[<h1 id="objects"><a class="markdownIt-Anchor" href="#objects"></a> Objects</h1>
<span id="more"></span>
<table>
<thead>
<tr>
<th style="text-align:left">Object</th>
<th style="text-align:left">Shareability</th>
<th style="text-align:left">Containability</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Buffer</td>
<td style="text-align:left">shared</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td style="text-align:left">Shader</td>
<td style="text-align:left">shared</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td style="text-align:left">Program</td>
<td style="text-align:left">shared</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td style="text-align:left">Program Pipeline</td>
<td style="text-align:left">non-shared</td>
<td style="text-align:left">Program Objects</td>
</tr>
<tr>
<td style="text-align:left">Texture</td>
<td style="text-align:left">shared</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td style="text-align:left">Sampler</td>
<td style="text-align:left">shared</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td style="text-align:left">Renderbuffer</td>
<td style="text-align:left">shared</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td style="text-align:left">Framebuffer</td>
<td style="text-align:left">non-shared</td>
<td style="text-align:left">Renderbuffer and/or Texture</td>
</tr>
<tr>
<td style="text-align:left">Vertex Array</td>
<td style="text-align:left">non-shared</td>
<td style="text-align:left">Buffer Objects</td>
</tr>
<tr>
<td style="text-align:left">Transform Feedback</td>
<td style="text-align:left">non-shared</td>
<td style="text-align:left">Buffer Objects</td>
</tr>
<tr>
<td style="text-align:left">Query</td>
<td style="text-align:left">non-shared</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td style="text-align:left">Sync</td>
<td style="text-align:left">shared</td>
<td style="text-align:left">No</td>
</tr>
</tbody>
</table>
<p>NOTE:</p>
<ul>
<li>å¯¹äºä¸€ç±»Objectsæ˜¯å¦å¯ä»¥å…±äº«æ˜¯æŒ‡æ˜¯å¦å¯ä»¥åœ¨å¤šä¸ª<strong>OpenGL contexts</strong>ä¹‹é—´å…±äº«</li>
</ul>
<h1 id="buffer-object"><a class="markdownIt-Anchor" href="#buffer-object"></a> Buffer Object</h1>
<h2 id="indexed-buffer-target"><a class="markdownIt-Anchor" href="#indexed-buffer-target"></a> Indexed Buffer Target</h2>
<table>
<thead>
<tr>
<th style="text-align:left">Target</th>
<th style="text-align:left">Limit</th>
<th>Version</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GL_ATOMIC_COUNTER_BUFFER</td>
<td style="text-align:left">GL_MAX_ATOMIC_COUNTER_BUFFER_BINDINGS</td>
<td>4.2</td>
</tr>
<tr>
<td style="text-align:left">GL_TRANSFORM_FEEDBACK_BUFFER</td>
<td style="text-align:left">GL_MAX_TRANSFORM_FEEDBACK_BUFFERS</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">GL_UNIFORM_BUFFER</td>
<td style="text-align:left">GL_MAX_UNIFORM_BUFFER_BINDINGS</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">GL_SHADER_STORAGE_BUFFER</td>
<td style="text-align:left">GL_MAX_SHADER_STORAGE_BUFFER_BINDINGS</td>
<td>4.3</td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>Piglit</title>
    <url>/gfx/piglit/</url>
    <content><![CDATA[<pre><code class="highlight mermaid">flowchart TB
  subgraph p [Main Thread]
    subgraph p0 [&quot;piglit_drm_create_dma_buf()&quot;]
      p.a[&quot;drv-&gt;create(w, h, fourcc, src_data, drm_buf)&quot;]
      p.b[&quot;drv-&gt;export(drm_buf)&quot;]
      subgraph p1 [&quot;create_and_destroy_texture()&quot;]
        p.c[&quot;egl_image_for_dma_buf_fd&lt;br&gt;(buf, fd, fourcc, img)&quot;]
        p.d[&quot;texture_for_egl_image(img, texture)&quot;]
        p.e[&quot;eglDestroyImageKHR(display, img)&quot;]
        p.f[&quot;glDeleteTextures(1, &amp;texture)&quot;]
        p.g[&quot;glFinish()&quot;]
      end
    end
  end
  subgraph t1 [Thread 1]
    subgraph lo11 [Loop 1]
      t1.a[&quot;eglCreateContext()&quot;]
      t1.b[&quot;eglMakeCurrent()&quot;]
      subgraph lo111 [&quot;create_and_destroy_texture()&quot;]
        t1.c[&quot;egl_image_for_dma_buf_fd&lt;br&gt;(buf, fd, fourcc, img)&quot;]
        t1.d[&quot;texture_for_egl_image(img, texture)&quot;]
        t1.e[&quot;eglDestroyImageKHR(display, img)&quot;]
        t1.f[&quot;glDeleteTextures(1, &amp;texture)&quot;]
        t1.g[&quot;glFinish()&quot;]
      end
    end
  end

  subgraph t2 [Thread 2]
    subgraph lo21 [Loop 1]
      t2.a[&quot;eglCreateContext()&quot;]
      t2.b[&quot;eglMakeCurrent()&quot;]
      subgraph lo211 [&quot;create_and_destroy_texture()&quot;]
        t2.c[&quot;egl_image_for_dma_buf_fd&lt;br&gt;(buf, fd, fourcc, img)&quot;]
        t2.d[&quot;texture_for_egl_image(img, texture)&quot;]
        t2.e[&quot;eglDestroyImageKHR(display, img)&quot;]
        t2.f[&quot;glDeleteTextures(1, &amp;texture)&quot;]
        t2.g[&quot;glFinish()&quot;]
      end
    end
  end

  p.a --&gt; p.b --&gt; p.c --&gt; p.d --&gt; p.e --&gt; p.f --&gt; p.g

  t1.a --&gt; t1.b --&gt; t1.c --&gt; t1.d --&gt; t1.e --&gt; t1.f --&gt; t1.g
  t2.a --&gt; t2.b --&gt; t2.c --&gt; t2.d --&gt; t2.e --&gt; t2.f --&gt; t2.g

  p --&gt; t1
  p --&gt; t2

  lo11 -- 100000 times --&gt; lo11
  lo21 -- 100000 times --&gt; lo21

  click p.a https://gitlab.freedesktop.org/mesa/piglit/-/blob/main/tests/util/piglit-framework-gl/piglit_drm_dma_buf.c#L519&quot;
  click p.b https://gitlab.freedesktop.org/mesa/piglit/-/blob/main/tests/util/piglit-framework-gl/piglit_drm_dma_buf.c#L519&quot;</code></pre>
<span id="more"></span>
<p><a href="https://gitlab.freedesktop.org/mesa/piglit">Piglit</a> æ˜¯ä¸º OpenGL, Vulkan, OpenCL å®ç°è®¾è®¡çš„è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶ã€‚Piglit çš„ç›®æ ‡æ˜¯æé«˜ OpenGL, Vulkan å’Œ OpenCL å¼€æºé©±åŠ¨çš„è´¨é‡ï¼Œå¹¶ä¸ºå¼€å‘è€…æä¾›ä¸€ä¸ªç®€å•çš„å›å½’æµ‹è¯•é€”å¾„ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬é€šè¿‡ Piglit é‡Œçš„å‡ ä¸ªæœ‰æ„æ€çš„æµ‹è¯•ç”¨ä¾‹ï¼Œåè¿‡æ¥äº†è§£ Mesa å®ç°çš„ä¸€äº›åº•å±‚æœºåˆ¶ï¼Œæ¯”å¦‚ DMABUF, EGLImageKHR ç­‰ç­‰ã€‚</p>
<h1 id="ext_image_dma_buf_importrefcount-multithread"><a class="markdownIt-Anchor" href="#ext_image_dma_buf_importrefcount-multithread"></a> <a href="https://gitlab.freedesktop.org/mesa/piglit/-/blob/main/tests/spec/ext_image_dma_buf_import/refcount-multithread.c">ext_image_dma_buf_import/refcount-multithread</a></h1>
<p>æµ‹è¯•å¤šçº¿ç¨‹ä¸‹ï¼Œé©±åŠ¨æ˜¯å¦æ­£ç¡®å¤„ç† dma-buf çš„å¯¼å…¥/å¯¼å‡ºï¼Œ</p>
<ul>
<li>export <code>drmPrimeHandleToFD()</code></li>
<li>import <code>drmPrimeFDToHandle()</code></li>
</ul>
<p>FD æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œ bo handles åœ¨å†…æ ¸æ€å’Œç”¨æˆ·æ€å„è‡ªç»´æŠ¤æœ‰ä¸€ä»½ï¼Œåˆ†åˆ«æ˜¯ <strong>GEM bo handles</strong> å’Œ <strong>Userspace bo handles</strong>, åœ¨ mesa çš„å®ç°é‡Œï¼Œè¿™ä¸¤ä¸ªé›†åˆæ˜¯ 1:1 æ˜ å°„å…³ç³», å½“ä¸€ä¸ª gem bo handle è¢«å¯¼å…¥, å¦‚æœå¯¹åº”çš„ userspace bo handle(å®é™…ä¸Šå°±æ˜¯ drmPrimeFDToHandle() è¿”å›çš„æ•´æ•°)å·²ç»å­˜åœ¨ï¼Œmesa é©±åŠ¨ä»…ä»…æ˜¯å°†è¿™ä¸ª userspace bo handle çš„å¼•ç”¨è®¡æ•°åŠ  1. è¿™å°±æœ‰å¯èƒ½å¯¼è‡´ bo_destroy å‡½æ•°å’Œ bo_import() å‡½æ•°å‘ç”Ÿç«äº‰ (race), ä»è€Œå¯¼è‡´ UAF, è¿™ä¸ª Piglit ç”¨ä¾‹å°±æ˜¯ä¸“é—¨æµ‹è¯•è¿™ç§åœºæ™¯çš„ã€‚</p>
<h2 id="faq"><a class="markdownIt-Anchor" href="#faq"></a> FAQ</h2>
<h3 id="q-ä¸¤ä¸ªçº¿ç¨‹å…ˆåå¯¹åŒä¸€ä¸ª-fd-è°ƒç”¨-drmprimefdtohandleè¿”å›ç»™å„è‡ªçº¿ç¨‹çš„-handle-æ˜¯åŒä¸€ä¸ªå€¼å—"><a class="markdownIt-Anchor" href="#q-ä¸¤ä¸ªçº¿ç¨‹å…ˆåå¯¹åŒä¸€ä¸ª-fd-è°ƒç”¨-drmprimefdtohandleè¿”å›ç»™å„è‡ªçº¿ç¨‹çš„-handle-æ˜¯åŒä¸€ä¸ªå€¼å—"></a> Q: ä¸¤ä¸ªçº¿ç¨‹å…ˆåå¯¹åŒä¸€ä¸ª FD è°ƒç”¨ <code>drmPrimeFDToHandle()</code>ï¼Œè¿”å›ç»™å„è‡ªçº¿ç¨‹çš„ handle ï¼Œæ˜¯åŒä¸€ä¸ªå€¼å—ï¼Ÿ</h3>
<p>A: å› ä¸ºæ˜¯åŒä¸€ä¸ª FD, æ‰€ä»¥å®ƒåº•å±‚çš„æˆ–è€…è¯´å†…æ ¸çš„ drm_gem_object ä¹Ÿæ˜¯åŒä¸€ä¸ªï¼Œè¿”å›çš„ handle æ˜¯åŒä¸€ä¸ªå€¼ï¼Œè¿™ä¹Ÿæ­£æ˜¯ ext_image_dma_buf_import/refcount-multithread è¿™ä¸ªç”¨ä¾‹è¦æ„å»ºçš„åœºæ™¯ã€‚</p>
<h3 id="q-drmprimefdtohandledrmprimehandletofd-ä¼šå½±å“-drm_gem_object-çš„å¼•ç”¨è®¡æ•°å—"><a class="markdownIt-Anchor" href="#q-drmprimefdtohandledrmprimehandletofd-ä¼šå½±å“-drm_gem_object-çš„å¼•ç”¨è®¡æ•°å—"></a> Q: <code>drmPrimeFDToHandle()</code>/<code>drmPrimeHandleToFD()</code> ä¼šå½±å“ drm_gem_object çš„å¼•ç”¨è®¡æ•°å—ï¼Ÿ</h3>
<p>A: ä¸ä¼š</p>
<h1 id="waffle"><a class="markdownIt-Anchor" href="#waffle"></a> <a href="https://gitlab.freedesktop.org/mesa/waffle">Waffle</a></h1>
<p><a href="https://gitlab.freedesktop.org/mesa/waffle">Waffle /wa:fl/ åŠ¨å¬è€Œæ— æ„ä¹‰çš„è¯</a> æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°é€‰æ‹©ä¸€ä¸ª OpenGL API.piglit ç”¨å®ƒæ¥åˆ›å»º EGLContext, æœ€ç»ˆä¼šåˆ›å»º Galliumm pipe_context. æ­¤å¤– apitrace, Dante (open source DOOM 3) ä¹Ÿä½¿ç”¨ waffle</p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenGL Program Object</title>
    <url>/gfx/program-object/</url>
    <content><![CDATA[<h1 id="shader-object"><a class="markdownIt-Anchor" href="#shader-object"></a> Shader Object</h1>
<p>åˆ›å»ºå’Œä½¿ç”¨<strong>Shader Object</strong>çš„API:</p>
<ul>
<li><code>GLuint glCreateShader(GLenum shaderType);</code></li>
<li><code>void glShaderSource(GLuint shader, GLsizei count, const GLchar **string, const GLint *length);</code></li>
<li><code>void glCompileShader(GLunit shader);</code></li>
</ul>
<span id="more"></span>
<h1 id="shader-stage"><a class="markdownIt-Anchor" href="#shader-stage"></a> Shader Stage</h1>
<p>OpenGLé‡Œæ²¡æœ‰ä¸“é—¨çš„Shader Stage Objectå»å°è£…Stageç›¸å…³çš„çŠ¶æ€ã€‚ä½†æ˜¯äº‹å®ä¸Šï¼Œä¸€ä¸ªæˆ–å¤šä¸ªç‰¹å®šç±»å‹çš„Shader Object(s)ç»„æˆä¸€ä¸ªç‰¹å®šçš„Shader Stage, å¤šä¸ª<strong>Shader Stages</strong>é“¾æ¥æˆä¸€ä¸ªProgram Object. åªä¸è¿‡å¤§å¤šæƒ…å†µä¸‹ï¼Œä¸€ä¸ªShader Stageåªæ¥è‡ªäºä¸€ä¸ªShader Objectï¼Œä½†æ˜¯å¤šä¸ªåŒä¸€ç±»å‹çš„Shader Objectsç»„æˆä¸€ä¸ªProgram Objectçš„ä¸€ä¸ªShader Stageæ˜¯å®Œå…¨ç¬¦åˆOpenGLè§„èŒƒçš„ã€‚</p>
<img src="/gfx/program-object/shader-stage.png" class="">
<h1 id="program-object"><a class="markdownIt-Anchor" href="#program-object"></a> Program Object</h1>
<p>åˆ›å»ºå’Œä½¿ç”¨<strong>Program Object</strong>çš„API:</p>
<ul>
<li><code>GLuint glCreateProgram();</code></li>
<li><code>void glAttachShader(GLuint program, GLuint shader);</code></li>
</ul>
<img src="/gfx/program-object/program-object.png" class="">
<h1 id="program-pipeline-object"><a class="markdownIt-Anchor" href="#program-pipeline-object"></a> Program Pipeline Object</h1>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>AMD GPU Vulkan Drivers for Linux</title>
    <url>/gfx/radv/</url>
    <content><![CDATA[<p>AMD åœ¨ Linux ä¸‹ç»´æŠ¤ç€ä¸¤å¥—å¼€æº Vulkan é©±åŠ¨:</p>
<ul>
<li><a href="https://github.com/GPUOpen-Drivers/AMDVLK">AMDVLK</a>
<ul>
<li>ä»é—­æº Windows Vulkan é©±åŠ¨é€‚é…è€Œæ¥ï¼Œä¸»è¦ä¸åŒåœ¨ shader ç¼–è¯‘åç«¯, AMDVLK ä½¿ç”¨åŸºäº LLVM çš„ LLPC</li>
</ul>
</li>
<li><a href="https://docs.mesa3d.org/drivers/radv.html">RADV</a>
<ul>
<li>åŒ…å«åœ¨ Mesa å†…ï¼Œæœ‰ä¸¤å¥—ç¼–è¯‘åç«¯: åŸºäº LLVM çš„åç«¯å’ŒåŸºäº NIR çš„ <a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/amd/compiler/README.md">ACO</a> (<strong>A</strong>MD <strong>CO</strong>mpiler)ï¼Œä½†é»˜è®¤çš„æ˜¯ ACO</li>
</ul>
</li>
</ul>
<span id="more"></span>
<h1 id="amdvlk"><a class="markdownIt-Anchor" href="#amdvlk"></a> AMDVLK</h1>
<p>AMDVLK çš„ README æœ‰ä¸€å¼ <a href="https://github.com/GPUOpen-Drivers/AMDVLK?tab=readme-ov-file#amd-open-source-driver-for-vulkan">æ¶æ„å›¾</a>, éå¸¸æ¸…æ™°åœ°å±•ç¤ºäº†æ•´ä¸ªé©±åŠ¨åŒ…å«çš„ç»„ä»¶å’Œå±‚æ¬¡ç»“æ„ã€‚</p>
<p><img src="/images/radv/topLevelArch.png" alt="topLevelArch" /></p>
<p>AMDVLK é©±åŠ¨ç”± 5 ä¸ªä»£ç ä»“åº“æ„å»º:</p>
<ul>
<li><a href="https://github.com/GPUOpen-Drivers/llvm-project">LLVM</a></li>
<li><a href="https://github.com/GPUOpen-Drivers/xgl">XGL</a> Vulkan API Translator</li>
<li><a href="https://github.com/GPUOpen-Drivers/llpc">LLPC</a> LLVM-based Pipeline Compiler</li>
<li><a href="https://github.com/GPUOpen-Drivers/gpurt">GPURT</a> GPU Ray Tracing Library</li>
<li><a href="https://github.com/GPUOpen-Drivers/pal">PAL</a> Platform Abstraction Library</li>
</ul>
<p>å…¶ä¸­ XGL, LLPC, GPURT éƒ½ä¸ <strong>PAL</strong> æœ‰å…³è”ã€‚</p>
<h1 id="radv-radeon-vulkan"><a class="markdownIt-Anchor" href="#radv-radeon-vulkan"></a> RADV (Radeon Vulkan)</h1>
<p>RADV å’Œå…¶å®ƒ Mesa çš„ GPU UMD ä¸€æ ·éƒ½æ˜¯ä½¿ç”¨ libdrm åº“ä¸ KMD æ‰“äº¤é“ï¼Œä½†åæ¥ä¸ºäº†<a href="https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/32067">GPU è™šæ‹ŸåŒ–(amdgpu-virto) æ”¯æŒ Native Context</a> å°†å¤§éƒ¨åˆ† libdrm_amdgpu åº“çš„å‡½æ•°æ¢æˆäº† <strong>ac_drm_</strong> å¼€å¤´çš„å‡½æ•°, åæ¥ä¸ºäº†<a href="https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/21658">GPU è™šæ‹ŸåŒ–(amdgpu-virto) æ”¯æŒ Native Context</a> ä¹Ÿå¯¹ ac_drm å‡½æ•°æ¥å£è¿›è¡Œäº†çš„ä¿®æ”¹ã€‚ ç»è¿‡è¿™ä¸¤æ¬¡ä¿®æ”¹ï¼ŒRADV ä½¿ç”¨çš„ libdrm_amdgpu å‡½æ•°åŸºæœ¬åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li>ç›´æ¥è°ƒç”¨å‹</li>
<li>&quot;inline&quot;å‹</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">Function</th>
<th style="text-align:left">IOCTL CMD</th>
<th style="text-align:left">Read/Write</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ac_drm_bo_set_metadata</td>
<td style="text-align:left">GEM_METADATA</td>
<td style="text-align:left">RW</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_bo_query_info</td>
<td style="text-align:left">GEM_METADATA, GEM_OP</td>
<td style="text-align:left">RW</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_bo_wait_for_idle</td>
<td style="text-align:left">GEM_WAIT_IDLE</td>
<td style="text-align:left">RW</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_bo_va_op_raw</td>
<td style="text-align:left">GEM_VA</td>
<td style="text-align:left">RW</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_cs_query_reset_state2</td>
<td style="text-align:left">CTX</td>
<td style="text-align:left">RW</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_cs_query_fence_status</td>
<td style="text-align:left">DRM_IOCTL_AMDGPU_WAIT_CS</td>
<td style="text-align:left">N/A</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_cs_submit_raw2</td>
<td style="text-align:left">CS</td>
<td style="text-align:left">RW</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_query_hw_ip_count</td>
<td style="text-align:left">INFO</td>
<td style="text-align:left">W</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_query_hw_ip_info</td>
<td style="text-align:left">INFO</td>
<td style="text-align:left">W</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_query_firmware_version</td>
<td style="text-align:left">INFO</td>
<td style="text-align:left">W</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_query_uq_fw_area_info</td>
<td style="text-align:left">INFO</td>
<td style="text-align:left">W</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_read_mm_registers</td>
<td style="text-align:left">INFO</td>
<td style="text-align:left">W</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_query_info</td>
<td style="text-align:left">INFO</td>
<td style="text-align:left">W</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_query_sensor_info</td>
<td style="text-align:left">INFO</td>
<td style="text-align:left">W</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_query_video_caps_info</td>
<td style="text-align:left">INFO</td>
<td style="text-align:left">W</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_query_gpuvm_fault_info</td>
<td style="text-align:left">INFO</td>
<td style="text-align:left">W</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_vm_reserve_vmid</td>
<td style="text-align:left">VM</td>
<td style="text-align:left">RW</td>
</tr>
<tr>
<td style="text-align:left">ac_drm_vm_unreserve_vmid</td>
<td style="text-align:left">VM</td>
<td style="text-align:left">RW</td>
</tr>
</tbody>
</table>
<p>å…³äº libdrm_amdgpu é‡Œçš„å‡½æ•°ï¼Œå…¶å®è¿˜æœ‰ä¸€ç±»ï¼Œå°±æ˜¯ AMDVLK ç”¨åˆ°çš„ï¼Œè€Œ RADV æ²¡æœ‰ç”¨çš„:</p>
<ul>
<li>amdgpu_bo_list_create</li>
<li>amdgpu_bo_list_create_raw</li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Vulkan</tag>
      </tags>
  </entry>
  <entry>
    <title>ReadPixels in Mesa</title>
    <url>/gfx/readpixel/</url>
    <content><![CDATA[<h1 id="glreadpixels"><a class="markdownIt-Anchor" href="#glreadpixels"></a> glReadPixels</h1>
<p>glReadPixels æ˜¯å°†å½“å‰ç»‘å®šçš„ FBO é‡Œçš„å†…å®¹ä»æ˜¾å­˜(renderbuffer, é€šå¸¸æ˜¯ read renderbuffer) è¯»åˆ° <code>*data</code> æŒ‡å‘çš„å†…å­˜ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void glReadPixels(GLint x, GLint y,</span><br><span class="line">                  GLsizei width, GLsizei height,</span><br><span class="line">                  GLenum format, GLenum type, void *data);</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p>åœ¨è¿™æ¬¡ä»æ˜¾å­˜åˆ°ä¸»å­˜çš„æ•°æ®ä¼ è¾“ä¸­å¯èƒ½æº(renderbuffer) æ•°æ®æ ¼å¼æœ‰å¯èƒ½ä¸è¯·æ±‚çš„(glReadPixelså‚æ•° format, type æŒ‡å®šçš„)æ ¼å¼ä¸ç›¸åŒï¼Œéœ€è¦æ•°æ®åœ¨è¢«å›è¯»åˆ° <code>*data</code> å‰åšä¸€æ¬¡æ ¼å¼æˆ–å­—èŠ‚åºè½¬æ¢ã€‚ä¸ºäº†èƒ½å¤ŸåŠ é€Ÿè¿™ä¸ªè½¬æ¢è¿‡ç¨‹ï¼Œå°±äº§ç”Ÿäº†åŸºäº Blit çš„ glReadPixels çš„å®ç°ã€‚ è¿˜æœ‰ä¸ä¹‹å¯¹åº”çš„æ‰€è°“ slow path (å…¶å®å°±æ˜¯è®© CPU åšè¿™æ¬¡æ ¼å¼è½¬æ¢)</p>
<h1 id="why-prefer-to-blit-based-readpixels"><a class="markdownIt-Anchor" href="#why-prefer-to-blit-based-readpixels"></a> Why prefer to blit-based ReadPixelsï¼Ÿ</h1>
<p>åŸå› æœ‰ä¸¤æ–¹é¢ï¼š</p>
<ul>
<li>æ ¼å¼è½¬æ¢ (required than preferred)</li>
<li>memcpy çš„æ•ˆç‡ (row by row or one-shot)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if (tex_xfer-&gt;stride == bytesPerRow &amp;&amp; destStride == bytesPerRow) &#123;</span><br><span class="line">   memcpy(dest, map, bytesPerRow * height);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">   GLuint row;</span><br><span class="line"></span><br><span class="line">   for (row = 0; row &lt; (unsigned) height; row++) &#123;</span><br><span class="line">      memcpy(dest, map, bytesPerRow);</span><br><span class="line">      map += tex_xfer-&gt;stride;</span><br><span class="line">      dest += destStride;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬ 2 ä¸ªé—®é¢˜éœ€è¦ç†è§£ä¸€å¼ å›¾ç‰‡æˆ–ä¸€å—åƒç´ å®ƒåœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼</p>
<p><img src="/images/readpixel/image-in-memory.png" alt="The usual layout of pixels of an image in memory" /><br />
<img src="/images/readpixel/image-in-address.png" alt="How to compute the address of a pixel" /></p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
        <tag>Mesa</tag>
      </tags>
  </entry>
  <entry>
    <title>Replacing NIR with SPIR-V?</title>
    <url>/gfx/replace-nir-with-spirv/</url>
    <content><![CDATA[<p><a href="https://www.mail-archive.com/mesa-dev@lists.freedesktop.org/msg224164.html">â€œReplacing NIR with SPIR_V?â€</a> æ˜¯mesa-dev maillist ä¸Š2022-01-20çš„ä¸€å°é‚®ä»¶ä¸»é¢˜. ä»é‚®ä»¶è®¨è®ºä¸­æˆ‘äº†è§£åˆ°äº†è®¸å¤šçŸ¥è¯†ï¼Œåœ¨æ­¤è®°å½•ä¸€ä¸‹ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">åè¯</th>
<th style="text-align:left">å…¨ç§°</th>
<th style="text-align:left">è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">IR</td>
<td style="text-align:left">Intermediate Representation</td>
<td style="text-align:left">ç¼–è¯‘å™¨ä¸­ä½¿ç”¨çš„ä¸­é—´è¡¨ç¤ºï¼Œä¸€èˆ¬æ˜¯ç¼–è¯‘å™¨ä¼˜åŒ– Pass å’Œåç«¯çš„è¾“å…¥</td>
</tr>
<tr>
<td style="text-align:left">NIR</td>
<td style="text-align:left">New IR</td>
<td style="text-align:left">Mesa ä¸­ä¸“é—¨ä¸º Graphics shader è®¾è®¡çš„ä¸€ç§ IR, å®ƒå¯ä»¥ä½œä¸ºç‰¹å®šåç«¯çš„è¾“å…¥ï¼Œå¦‚ LLVM AMDGPU åç«¯</td>
</tr>
<tr>
<td style="text-align:left">SPIR</td>
<td style="text-align:left">Standard Portable IR</td>
<td style="text-align:left">ä¸€ç§ç”¨äºå¹¶è¡Œè®¡ç®—å’Œå›¾å½¢çš„ä¸­é—´è¯­è¨€ï¼ˆinterchage language), ç”± Khronos Group åœ¨ 2012 å¹´å¼•å…¥</td>
</tr>
<tr>
<td style="text-align:left">SPIR-V</td>
<td style="text-align:left">SPIR-Vulkan</td>
<td style="text-align:left">ç”± Khronos Group åœ¨ 2015 å¹´å¼•å…¥ï¼Œç”¨æ¥æ›¿ä»£åŸæ¥çš„ SPIR</td>
</tr>
<tr>
<td style="text-align:left">RISC</td>
<td style="text-align:left">Reduced Instruction Set Computer</td>
<td style="text-align:left">ç²¾ç®€æŒ‡ä»¤é›†ï¼Œ ä¸ CISC ç›¸å¯¹</td>
</tr>
<tr>
<td style="text-align:left">RISC-V</td>
<td style="text-align:left">RISC five</td>
<td style="text-align:left">ç”±åŠ å· Berkeley å¤§å­¦å¼€å‘çš„ä¸€ç§å¼€æ”¾ä¸”æ¨¡å—åŒ–çš„ RISC æŒ‡ä»¤é›†æ¶æ„</td>
</tr>
<tr>
<td style="text-align:left">SIMD</td>
<td style="text-align:left">Single Instruction Multiple Data</td>
<td style="text-align:left">è´¹æ—åˆ†ç±»æ³•ï¼ˆFlynnâ€™s Taxonomy) ä¸­çš„ä¸€ç§ï¼Œå…¶å®ƒçš„è¿˜æœ‰ SISD, MIMD, MISD</td>
</tr>
<tr>
<td style="text-align:left">SIMT</td>
<td style="text-align:left">Single Instruction Multi-Threads</td>
<td style="text-align:left">SIMD çš„ä¸€ç§å­ç±»å‹</td>
</tr>
</tbody>
</table>
<ul>
<li><a href="https://www.youtube.com/watch?v=kM0lsWjqOaw">Lightning Talk: Functional Gap between RISC-V V and SPIR-V: a Study Case on the Graphics Domain</a></li>
<li><a href="https://www.rastergrid.com/blog/gpu-tech/2022/02/simd-in-the-gpu-world/">SIMD in the GPU world</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Compiler</tag>
      </tags>
  </entry>
  <entry>
    <title>Render To Texture</title>
    <url>/gfx/rtt/</url>
    <content><![CDATA[<p>Render-To-Texture æ˜¯ä¸€ç§ååˆ†å¸¸è§å’Œç®€å•çš„æ¸²æŸ“æŠ€æœ¯ï¼Œå®ƒå°†çº¹ç†å¯¹è±¡å’Œ FBO ç»‘å®šï¼ŒæŠŠåœºæ™¯æ¸²æŸ“åˆ°çº¹ç†ä¸­ï¼Œä»¥ä¾¿ä¹‹åå¯ä»¥åå¤ä½¿ç”¨ã€‚RTT è¢«å¹¿æ³›åº”ç”¨åœ¨ in-game cameras(virtual camera systems), post-processing å’Œå„ç§ç‰¹æ•ˆä¸­ã€‚æœ¬æ–‡ä¸»è¦æ¯”è¾ƒ RTT æŠ€æœ¯åœ¨ä¸¤ç§ä¸åŒçš„æ¸²æŸ“æ¶æ„ä¸‹çš„ä¸åŒå’Œä¸€äº›æ€è€ƒã€‚</p>
<p><img src="/images/rtt/rtt-on-tbr.png" alt="rtt-on-tbr" /></p>
<span id="more"></span>
<h1 id="imr-vs-tbr"><a class="markdownIt-Anchor" href="#imr-vs-tbr"></a> IMR vs TBR</h1>
<p>IMR (Immediate Mode Rendering) å’Œ TBR (Tile-Based Rendering) æ˜¯ä¸¤ç§ä¸åŒçš„æ¸²æŸ“æ¶æ„ï¼Œå‰è€…å¸¸è§äºæ¡Œé¢ GPU (NVIDIA, AMD), åè€…å¸¸è§äºç§»åŠ¨ GPU (Imagination, Mali)ã€‚</p>
<h2 id="imr"><a class="markdownIt-Anchor" href="#imr"></a> IMR</h2>
<ul>
<li>ä¸€æ•´å—ä¸€æ•´å—æ¸²æŸ“ï¼Œéœ€è¦å¤§é‡è®¿å­˜ï¼Œæ‰€ä»¥å¿…é¡»æœ‰<strong>æ¯”è¾ƒå¤§çš„ L1, L2 Cache</strong> æ¥é™ä½è®¿å­˜å»¶æ—¶</li>
<li>éœ€è¦å¤§é‡å¸¦å®½ï¼Œæ‰€ä»¥<strong>åŠŸè€—é«˜</strong></li>
<li>æ¸²æŸ“ç®¡çº¿æ‰§è¡Œ<strong>æµç•…</strong>ï¼Œ ä»é¡¶ç‚¹åˆ°ç‰‡æ®µ<strong>ä¸€å£æ°”å¼„å®Œ</strong></li>
</ul>
<pre><code class="highlight mermaid">block-beta
    columns 1
    block:pipeline
        A[&quot;Vertex&lt;br&gt;Processing&quot;] space B[&quot;Clip&lt;br&gt;Cull&quot;] space D[&quot;Raster&quot;] space E[&quot;Early-Z&lt;br&gt;Test&quot;] space F[&quot;Texture&lt;br&gt;Fragment&quot;] space G[&quot;Alpha&lt;br&gt;Test&quot;] space L[&quot;Late-Z&lt;br&gt;Test&quot;] space H[&quot;Alpha&lt;br&gt;Blend&quot;]
        A --&gt; B
        B --&gt; D
        D --&gt; E
        E --&gt; F
        F --&gt; G
        G --&gt; L
        L --&gt; H
    end
    space
    block:vram
        VD[&quot;Geometry&lt;br&gt;Data&quot;] space:7 TD[&quot;Texture&lt;data&gt;Data&quot;] space:3 ZB[&quot;Depth&lt;br&gt;Buffer&quot;] space FB[&quot;FrameBuffer&quot;]
    end
    VD --&gt; A
    TD --&gt; F
    L --&gt; ZB
    ZB --&gt; L
    H --&gt; FB
    FB --&gt; H</code></pre>
<h2 id="tbr"><a class="markdownIt-Anchor" href="#tbr"></a> TBR</h2>
<ul>
<li>ä¸€å°å—ä¸€å°å—<strong>æ¸²æŸ“</strong>, å¯¹äºæ¯ä¸€å°å—æ¥è¯´ï¼Œæ‰€éœ€è¦çš„è®¿å­˜çš„å¸¦å®½å°±ç›¸å¯¹è¾ƒå°ï¼Œå¯ä»¥åœ¨ç‰‡ä¸Šåšä¸€<strong>å°å—é«˜é€Ÿç¼“å­˜</strong></li>
<li>éœ€è¦çš„å¸¦å®½å°ï¼Œæ‰€ä»¥<strong>åŠŸè€—ä½</strong></li>
</ul>
<pre><code class="highlight mermaid">block-beta
    columns 1
    block:pipeline
        A[&quot;Vertex&lt;br&gt;Processing&quot;] space B[&quot;Clip&lt;br&gt;Cull&quot;] space C[&quot;Tiling&quot;] space D[&quot;Raster&quot;] space E[&quot;Early-Z&lt;br&gt;Test&quot;] space F[&quot;Texture&lt;br&gt;Fragment&quot;] space G[&quot;Late-Z&lt;br&gt;Test&quot;] space H[&quot;Alpha&lt;br&gt;Blend&quot;]
        A --&gt; B
        B --&gt; C
        D --&gt; E
        E --&gt; F
        F --&gt; G
        G --&gt; H
    end
    block:onchip
        space:12 ZC[&quot;On-Chip&lt;br&gt;Depth Buffer&quot;] space CC[&quot;On-Chip&lt;br&gt;Color Buffer&quot;]
    end
    space
    block:vram
        VD[&quot;Geometry&lt;br&gt;Data&quot;] space:4 PL[&quot;Primitive List&lt;br&gt;Vertex Data&quot;] space:4 TD[&quot;Texture&lt;data&gt;Data&quot;] space:3 FB[&quot;FrameBuffer&quot;]
    end
    VD --&gt; A
    C --&gt; PL
    PL --&gt; D
    TD --&gt; F
    G --&gt; ZC
    ZC --&gt; G
    H --&gt; CC
    CC --&gt; H
    CC --&gt; FB
    FB --&gt; CC

    style onchip   fill:#00bc00,stroke:#ff0000,stroke-dasharray:5 5</code></pre>
<p>ç”±ä¸Šé¢çš„ä¸¤å¼ å›¾å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ TBR æ¶æ„ä¸‹ï¼ŒGPU äº§ç”Ÿçš„æ¯ä¸ªåƒç´ å¹¶ä¸æ˜¯ç›´æ¥å†™å…¥æ˜¾å­˜çš„ï¼Œè€Œæ˜¯æš‚å­˜åœ¨<strong>ç‰‡ä¸Šçš„ Color Buffer</strong> ä¸­ï¼Œå¯¹äº RTT æ¥è¯´ï¼Œå¦‚æœæ¸²æŸ“å¾—åˆ°çš„çº¹ç†ä½œä¸ºåé¢ç»˜åˆ¶å‘½ä»¤çš„æºçº¹ç†ï¼Œé‚£ä¹ˆå¦‚æœæ²¡æœ‰æ˜¾å¼åœ°å°†è¿˜å­˜åœ¨äºç‰‡ä¸Šçš„ Color Buffer åˆ·æ–°å…¥æ˜¾å­˜ä¸­ï¼Œé‚£ä¹ˆå½“å‰çš„ç»˜åˆ¶ä¸­ï¼Œçº¹ç†é‡‡æ ·è·å–çš„çº¹ç´ å°±æ˜¯æ—§æ•°æ®ã€‚</p>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://www.opengl-tutorial.org/intermediate-tutorials/tutorial-14-render-to-texture/">Tutorial 14: Render To Texture</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/654389634">GPU å¸§ç¼“å†²å†…å­˜ï¼šäº†è§£ç“¦ç‰‡æ¸²æŸ“ TBR(tile-based rendering)</a></li>
<li><a href="https://developer.samsung.com/galaxy-gamedev/resources/articles/gpu-framebuffer.html">GPU Framebuffer Memory: Understanding Tiling</a></li>
<li><a href="https://docs.qualcomm.com/bundle/publicresource/topics/80-78185-2/gpu.html">Qualcomm Adreno GPU</a></li>
<li><a href="https://developer.arm.com/documentation/102693/1-6/Useful-resources?lang=en">ARM Mali GPU</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>Vulkan</title>
    <url>/gfx/vk/</url>
    <content><![CDATA[<p>Vulkan æ˜¯ä¸€ä¸ªä½å¼€é”€ã€è·¨å¹³å°çš„äºŒç»´å’Œä¸‰ç»´å›¾å½¢ä¸è®¡ç®—çš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œç”± Khronos åœ¨2015å¹´åœ¨ GDC ä¸Šé¦–æ¬¡å‘å¸ƒã€‚å®ƒæ—¨åœ¨æä¾›é«˜æ•ˆèƒ½å’Œæ›´å‡è¡¡çš„ CPU å’Œ GPU å ç”¨ï¼Œç±»ä¼¼äº Direct3D 12 å’Œ AMD Mantleã€‚</p>
<p>åœ¨è¿™é‡Œä¸»è¦æ”¶é›†ä¸€äº›ä¸ Vulkan å¼ºç›¸å…³çš„ä¸€äº›é¡¹ç›®ï¼Œä¾¿äº Vulkan çš„å­¦ä¹ å’Œä½¿ç”¨ã€‚</p>
<span id="more"></span>
<h1 id="vulkan-sdk"><a class="markdownIt-Anchor" href="#vulkan-sdk"></a> <a href="https://vulkan.lunarg.com/">vulkan-sdk</a></h1>
<p>Vulkan SDK ä¸ºå¼€å‘è€…æä¾›äº†å¼€å‘å’Œè°ƒè¯• Vulkan åº”ç”¨ç¨‹åºçš„å…³é”®å·¥å…·ï¼Œä¸»è¦åŒ…æ‹¬:</p>
<ul>
<li>Vulkan-Headers</li>
<li>Vulkan-Tools</li>
<li>SPIRV-Tools</li>
<li>glslang</li>
<li>VulkanMemoryAllocator (vma)</li>
<li>Vulkan-Utilities-Library (vul)</li>
</ul>
<p>è¿™äº›åŸºæœ¬éƒ½æ˜¯ C++ ç¼–å†™çš„å·¥å…·æˆ–åº“ã€‚</p>
<p>LunarG å®˜æ–¹çš„ vulkan-sdk åŒæ—¶ä¼šæä¾› Binary å’Œä¸€ä¸ª vulkansdk è„šæœ¬ï¼Œä»¥åŠä¸€ä¸ªç¯å¢ƒå˜é‡é…ç½®è„šæœ¬ã€‚é€šå¸¸è§£å‹ (<code>tar -xvJf</code>) ååªéœ€è¦</p>
<p><code>source setup-env.sh</code></p>
<p>SDK ä¸­åŒ…å«çš„æ‰€æœ‰åº“ï¼Œåº”ç”¨ç¨‹åºåŠ cmake æ–‡ä»¶éƒ½ä¼šåœ¨å½“å‰ç»ˆç«¯ç”Ÿæ•ˆã€‚å¦å¤–ï¼Œvulkansdk å…è®¸ç”¨æˆ·æ–¹ä¾¿åœ°æœ‰é€‰æ‹©åœ°å®‰è£… SDK åŒ…å«çš„å·¥å…·ï¼Œä¾‹å¦‚å•ç‹¬ä¸‹è½½å®‰è£… Vulkan-Headers:</p>
<p><code>./vulkansdk --skip-deps vulkan-headers</code></p>
<p>(æ³¨æ„ vulkansdk é»˜è®¤éƒ½ä¼šå°†æŒ‡å®šå®‰è£…çš„é¡¹ç›®å®‰è£…åœ¨å½“å‰è·¯å¾„ä¸‹çš„ <code>$(arch)</code> ç›®å½•ä¸‹ï¼Œè¿™ä¸ªå®‰è£…è·¯å¾„åœ¨ç¼–è¯‘ Vulkan-Tools æ—¶éœ€è¦è¢«è®¾ç½®åˆ° Vulkan-Tools çš„ cmake å˜é‡ <code>-DVULKAN_HEADERS_INSTALL_DIR=/home/luc/gh/1.3.290.0/x86_64</code> åŸå› æ˜¯ Vulkan-Tools éœ€è¦ç”¨åˆ°è¿™ä¸ªè·¯å¾„ä¸‹çš„ Python æ¨¡å—)</p>
<h2 id="vulkan-headers"><a class="markdownIt-Anchor" href="#vulkan-headers"></a> <a href="https://github.com/KhronosGroup/Vulkan-Headers">Vulkan-Headers</a></h2>
<p>Vulkan-Headers ä¸»è¦åŒ…å« Vulkan API çš„å¤´æ–‡ä»¶å’Œä¸€äº›ç”¨äº(æ ¹æ® Khronos XML æ–‡ä»¶)è‡ªåŠ¨ç”Ÿæˆå¤´æ–‡ä»¶çš„Python è„šæœ¬ã€‚Vulkan-Headers çš„ç‰ˆæœ¬å˜æ›´å’Œ vulkan-sdk æ˜¯åŒæ­¥çš„ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰ Vulkan çš„ç›¸å…³çš„å·¥å…·æˆ–åº“éƒ½ä¾èµ–å®ƒã€‚</p>
<p>ä¾‹å¦‚ Vulkan-Tools ä¸­çš„ vulkaninfo, å½“éœ€è¦æ„å»ºå®ƒæ—¶ï¼Œå°±éœ€è¦æŒ‡å®š <code>-DVULKAN_HEADERS_INSTALL_DIR</code>, è€Œä¸”å¿…é¡»å°† Vulkan-Tools ä»“åº“çš„ tag æ£€å‡ºåˆ°å’Œ Vulkan-Headers ä»“åº“çš„ä¸€æ ·æ‰èƒ½ç¼–è¯‘æˆåŠŸã€‚</p>
<h1 id="vulkan-hpp"><a class="markdownIt-Anchor" href="#vulkan-hpp"></a> <a href="https://github.com/KhronosGroup/Vulkan-Hpp">Vulkan-Hpp</a></h1>
<p>Vulkan-Hpp æ—¨åœ¨ä¸º Vulkan C API æä¾›å¤´æ–‡ä»¶(header only)å½¢å¼çš„ C++ ç»‘å®š, ä»¥æ­¤æ¥ç®€åŒ– Vulkan åº”ç”¨çš„å¼€å‘è¿‡ç¨‹åŒæ—¶ä¸å¼•å…¥é¢å¤–çš„ CPU è¿è¡Œæ—¶å¼€é”€ã€‚ Vulkan-Hpp ä¾èµ– Vulkan-Headers, è€Œä¸”å®ƒä¿©åŒæ—¶æ˜¯ vulkan-sdk çš„ä¸€éƒ¨åˆ†, å®ƒä»¬ä¸‰è€…çš„ç‰ˆæœ¬å·åº”è¯¥éƒ½è¦ä¸€è‡´ (å®šä¹‰åœ¨ <code>$&#123;CMAKE_INSTALL_PREFIX&#125;/include/vulkan/vulkan_core.h</code> çš„ <code>VK_HEADER_VERSION</code>)ã€‚ å®é™…ä¸Šï¼Œ Vulkan-Hpp é‡ŒåŒ…å«ä¸€ä¸ª <code>VulkanHppGenerator</code> ç¨‹åºï¼Œå®ƒä¼šè‡ªåŠ¨é‡æ–°ç”Ÿæˆ vulkan çš„ä¸€äº›å¤´æ–‡ä»¶ã€‚</p>
<pre><code class="highlight mermaid">flowchart LR
    A[&quot;Vulkan Registry XML&quot;]
    B[&quot;Vulkan .h/.hpp headers&quot;]
    C[&quot;Vulkan .hpp headers&quot;]
    A--&gt;|Vulkan-Headers .py|B
    B--&gt;|VulkanHppGenerator|C</code></pre>
<h2 id="vulkan-tools"><a class="markdownIt-Anchor" href="#vulkan-tools"></a> <a href="https://github.com/KhronosGroup/Vulkan-Tools">Vulkan-Tools</a></h2>
<ul>
<li><code>vulkaninfo --summary</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">VULKANINFO</span><br><span class="line">==========</span><br><span class="line"></span><br><span class="line">Vulkan Instance Version: 1.3.261</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Instance Extensions: count = 17</span><br><span class="line">-------------------------------</span><br><span class="line">VK_EXT_debug_report                    : extension revision 10</span><br><span class="line">VK_EXT_debug_utils                     : extension revision 2</span><br><span class="line">VK_EXT_headless_surface                : extension revision 1</span><br><span class="line">VK_EXT_surface_maintenance1            : extension revision 1</span><br><span class="line">VK_EXT_swapchain_colorspace            : extension revision 5</span><br><span class="line">VK_KHR_device_group_creation           : extension revision 1</span><br><span class="line">VK_KHR_external_fence_capabilities     : extension revision 1</span><br><span class="line">VK_KHR_external_memory_capabilities    : extension revision 1</span><br><span class="line">VK_KHR_external_semaphore_capabilities : extension revision 1</span><br><span class="line">VK_KHR_get_physical_device_properties2 : extension revision 2</span><br><span class="line">VK_KHR_get_surface_capabilities2       : extension revision 1</span><br><span class="line">VK_KHR_portability_enumeration         : extension revision 1</span><br><span class="line">VK_KHR_surface                         : extension revision 25</span><br><span class="line">VK_KHR_surface_protected_capabilities  : extension revision 1</span><br><span class="line">VK_KHR_xcb_surface                     : extension revision 6</span><br><span class="line">VK_KHR_xlib_surface                    : extension revision 6</span><br><span class="line">VK_LUNARG_direct_driver_loading        : extension revision 1</span><br><span class="line"></span><br><span class="line">Instance Layers: count = 13</span><br><span class="line">---------------------------</span><br><span class="line">VK_LAYER_FROG_gamescope_wsi       Gamescope WSI (XWayland Bypass) Layer (x86_64) 1.3.221  version 1</span><br><span class="line">VK_LAYER_INTEL_nullhw             INTEL NULL HW                                  1.1.73   version 1</span><br><span class="line">VK_LAYER_KHRONOS_profiles         Khronos Profiles layer                         1.3.280  version 1</span><br><span class="line">VK_LAYER_KHRONOS_shader_object    Khronos Shader object layer                    1.3.280  version 1</span><br><span class="line">VK_LAYER_KHRONOS_synchronization2 Khronos Synchronization2 layer                 1.3.280  version 1</span><br><span class="line">VK_LAYER_KHRONOS_validation       Khronos Validation Layer                       1.3.280  version 1</span><br><span class="line">VK_LAYER_LUNARG_api_dump          LunarG API dump layer                          1.3.280  version 2</span><br><span class="line">VK_LAYER_LUNARG_gfxreconstruct    GFXReconstruct Capture Layer Version 1.0.3     1.3.280  version 4194307</span><br><span class="line">VK_LAYER_LUNARG_monitor           Execution Monitoring Layer                     1.3.280  version 1</span><br><span class="line">VK_LAYER_LUNARG_screenshot        LunarG image capture layer                     1.3.280  version 1</span><br><span class="line">VK_LAYER_MANGOHUD_overlay_x86_64  Vulkan Hud Overlay                             1.3.0    version 1</span><br><span class="line">VK_LAYER_MESA_device_select       Linux device selection layer                   1.3.211  version 1</span><br><span class="line">VK_LAYER_MESA_overlay             Mesa Overlay layer                             1.3.211  version 1</span><br><span class="line"></span><br><span class="line">Devices:</span><br><span class="line">========</span><br><span class="line">GPU0:</span><br><span class="line">        apiVersion         = 1.3.255</span><br><span class="line">        driverVersion      = 0.0.1</span><br><span class="line">        vendorID           = 0x10005</span><br><span class="line">        deviceID           = 0x0000</span><br><span class="line">        deviceType         = PHYSICAL_DEVICE_TYPE_CPU</span><br><span class="line">        deviceName         = llvmpipe (LLVM 15.0.7, 256 bits)</span><br><span class="line">        driverID           = DRIVER_ID_MESA_LLVMPIPE</span><br><span class="line">        driverName         = llvmpipe</span><br><span class="line">        driverInfo         = Mesa 23.2.1-1ubuntu3.1~22.04.2 (LLVM 15.0.7)</span><br><span class="line">        conformanceVersion = 1.3.1.1</span><br><span class="line">        deviceUUID         = 6d657361-3233-2e32-2e31-2d3175627500</span><br><span class="line">        driverUUID         = 6c6c766d-7069-7065-5555-494400000000</span><br><span class="line">GPU1:</span><br><span class="line">        apiVersion         = 1.3.292</span><br><span class="line">        driverVersion      = 0.0.1</span><br><span class="line">        vendorID           = 0x10005</span><br><span class="line">        deviceID           = 0x0000</span><br><span class="line">        deviceType         = PHYSICAL_DEVICE_TYPE_CPU</span><br><span class="line">        deviceName         = llvmpipe (LLVM 16.0.0, 256 bits)</span><br><span class="line">        driverID           = DRIVER_ID_MESA_LLVMPIPE</span><br><span class="line">        driverName         = llvmpipe</span><br><span class="line">        driverInfo         = Mesa 24.3.0-devel (git-d58f7a24d1) (LLVM 16.0.0)</span><br><span class="line">        conformanceVersion = 1.3.1.1</span><br><span class="line">        deviceUUID         = 6d657361-3234-2e33-2e30-2d6465766500</span><br><span class="line">        driverUUID         = 6c6c766d-7069-7065-5555-494400000000</span><br></pre></td></tr></table></figure>
<ul>
<li>vkcube/vkcubepp
<ul>
<li><code>vkcube --gpu_number 1 --width 800 --height 600</code><br />
<img src="/images/vk/vkcube.gif" alt="vkcube" /></li>
</ul>
</li>
</ul>
<h2 id="spirv-tools"><a class="markdownIt-Anchor" href="#spirv-tools"></a> <a href="https://github.com/KhronosGroup/SPIRV-Tools">SPIRV-Tools</a></h2>
<p>SPIRV-Tools ä¸»è¦æ”¶é›†äº†ä¸ shader ç›¸å…³çš„ä¸€æ•´å¥—å·¥å…·é“¾ï¼ŒåŒ…æ‹¬ç¼–è¯‘ï¼Œé“¾æ¥ï¼Œä¼˜åŒ–ï¼Œåæ±‡ç¼–ç­‰ç­‰ã€‚å®ƒä¾èµ– <a href="https://github.com/KhronosGroup/SPIRV-Headers">SPIRV-Headers</a></p>
<p>SPIRV-Tools åŒ…å«çš„æ¯”è¾ƒå¸¸ç”¨çš„å·¥å…·:</p>
<ul>
<li>spirv-dis</li>
<li>spirv-opt</li>
</ul>
<h1 id="vulkan-samples"><a class="markdownIt-Anchor" href="#vulkan-samples"></a> <a href="https://github.com/KhronosGroup/Vulkan-Samples">Vulkan-Samples</a></h1>
<p><code>./build/app/bin/Debug/x86_64/vulkan_samples sample surface_rotation</code><br />
<img src="/images/vk/surface_rotation.png" alt="surface_rotation" /></p>
<h1 id="vulkanexamples"><a class="markdownIt-Anchor" href="#vulkanexamples"></a> <a href="https://github.com/jherico/VulkanExamples">VulkanExamples</a></h1>
<p>VulkanExamples æ˜¯å°†å¤§éƒ¨åˆ† <a href="https://github.com/SaschaWillems/Vulkan">Sascha Willems çš„ Vulkan examples</a> ç§»æ¤åˆ° Vulkan-Hpp, ä½†å½“æˆ‘è¯•ç€åœ¨ Ubuntu 20.04.3 ä¸Šç¼–è¯‘å¹¶åœ¨ LAVApipe æ˜¯è¿è¡Œæ—¶ï¼Œå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå¤§å¤šæ•° Demo ä¼š assert:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gears: ../src/vulkan/runtime/vk_render_pass.c:2347: vk_common_CmdBeginRenderPass2: Assertion `image_view-&gt;format == pass_att-&gt;format&#x27; failed.</span><br></pre></td></tr></table></figure>
<p>åŸå› æ˜¯ VulkanExamples çš„ <code>ExampleBase::colorformat</code> é»˜è®¤æ˜¯ <code>vk::Format::eB8G8R8A8Unorm</code>, è€Œé©±åŠ¨ä¾§ wsi ä»çª—å£ç³»ç»Ÿ(Ubuntu 20.04.3æ˜¯ X11) è·å–çš„ visual æ ¼å¼ä¼šåœ¨ä¸‹é¢çš„ format æ•°æ®é‡Œé¡ºåºåŒ¹é…:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">static const VkFormat formats[] = &#123;</span><br><span class="line">   VK_FORMAT_R5G6B5_UNORM_PACK16,</span><br><span class="line">   VK_FORMAT_B8G8R8A8_SRGB,</span><br><span class="line">   VK_FORMAT_B8G8R8A8_UNORM,</span><br><span class="line">   VK_FORMAT_A2R10G10B10_UNORM_PACK32,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è€Œ VulkanExamples base åªä¼šä» <code>physicalDevice.getSurfaceFormatsKHR()</code> è¿”å›çš„åˆ—è¡¨é‡Œå–ç¬¬ä¸€ä¸ªæ ¼å¼ï¼Œè€Œå®ƒå–å›çš„æ˜¯ <code>vk::Format::eB8G8R8A8Srgb</code>, æ‰€ä»¥æ‰ä¼šå¯¼è‡´é©±åŠ¨ <code>vk_common_CmdBeginRenderPass2()</code> çš„æ–­è¨€å¤±è´¥ã€‚mesa çš„ wsi common å±‚ä¹‹æ‰€ä»¥ä¼šå°† <code>VK_FORMAT_B8G8R8A8_SRGB</code> æ”¾åˆ° <code>VK_FORMAT_B8G8R8A8_UNORM</code> å‰é¢ï¼Œåº”è¯¥æ˜¯è€ƒè™‘åˆ°åœ¨åº”ç”¨ç¨‹åºä¸­å¯èƒ½ sRGB é¢œè‰²ç©ºé—´ä½¿ç”¨æ›´ä¸ºå¹¿æ³›å§(doge)ã€‚</p>
<p>è€Œä¸” <a href="https://github.com/KhronosGroup/Vulkan-Samples">KhronosGroup/Vulkan-Samples</a> è‡ªä» <a href="https://github.com/KhronosGroup/Vulkan-Samples/commit/38d628b032a88cf032e88877c1b75aa470333c32">38d628b032a8</a> å°±å·²ç»é¦–é€‰ <code>vk::Format::eR8G8B8A8Srgb</code> ä½œä¸º swapchain image çš„æ ¼å¼äº†ã€‚</p>
<p>å°† <code>ExampleBase::colorformat</code> æ”¹ä¸º sRGB åçš„å¯¹æ¯”æ•ˆæœ(å“ªä¸ªæ˜¯ sRGB å‘¢?)<br />
<img src="/images/vk/gears-srgb.gif" alt="gears-srgb" /><br />
<img src="/images/vk/gears-rgb.gif" alt="gears-rgb" /></p>
<h1 id="vulkan-icd"><a class="markdownIt-Anchor" href="#vulkan-icd"></a> Vulkan ICD</h1>
<p>Vulkan ICD (Installable Client Driver) å¯å®‰è£…å®¢æˆ·ç«¯é©±åŠ¨ç¨‹åºæ˜¯ Vulkan ç”Ÿæˆç³»ç»Ÿä¸­çš„å…³é”®ç»„ä»¶ã€‚å®ƒåœ¨ Vulkan åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿä¸Šå®‰è£…çš„å„ç§ Vulkan é©±åŠ¨ç¨‹åºä¹‹é—´å……å½“æ¡¥æ¢ã€‚æ¯ä¸ª Vulkan é©±åŠ¨ç¨‹åºæœ‰å¸¦æœ‰ä¸€ä¸ª ICD JSON æ–‡ä»¶ï¼Œå®ƒé‡Œé¢æè¿°äº†é©±åŠ¨åŠ¨æ€åº“æ–‡ä»¶çš„è·¯å¾„ï¼Œä»¥ä¾¿ Vulkan-Loader å¯ä»¥æšä¸¾ç³»ç»Ÿå®‰è£…çš„æ¯ä¸ª Vulkan é©±åŠ¨ã€‚ICD Json æ–‡ä»¶çš„è·¯å¾„å’Œå‘½åéƒ½æ˜¯è§„èŒƒçš„:</p>
<ul>
<li>å‘½åè§„èŒƒ
<ul>
<li><code>driver_name</code>_icd.<code>$arch</code>.json</li>
</ul>
</li>
<li>è·¯å¾„è§„èŒƒ
<ul>
<li><code>$&#123;CMAKE_INSTALL_PREFIX&#125;</code>/<code>$&#123;CMAKE_INSTALL_DATADIR&#125;</code>/vulkan/icd.d/</li>
</ul>
</li>
</ul>
<p>Vulkan ICD å¯ä»¥ç±»æ¯” OpenGL ä¸–ç•Œçš„ <a href="https://gitlab.freedesktop.org/glvnd/libglvnd">GLVND (GL Vendor-Neutral Dispatch library)</a>, GLVND çš„ç›®çš„åŒæ ·æ˜¯åœ¨åŒä¸€ç³»ç»Ÿä¸Šå…è®¸å¤šä¸ª OpenGL é©±åŠ¨åº“å…±å­˜ï¼Œå¹¶åœ¨è¿è¡Œæ—¶å†³å®šå°†æ¯ä¸ª API è°ƒç”¨åˆ†æ´¾ç»™å“ªä¸ªä¾›åº”å•†çš„é©±åŠ¨ã€‚åªä¸è¿‡ GLVND çš„ GLX æ²¡æœ‰ä½¿ç”¨ JSON æ–‡ä»¶ï¼Œè€Œæ˜¯ä¾é ç¯å¢ƒå˜é‡:</p>
<p>export __GLX_VENDOR_LIBRARY_NAME=<code>driver_name</code></p>
<p><code>driver_name</code> å°±æ˜¯ OpenGL é©±åŠ¨åº“æ–‡ä»¶ libGLX_<code>driver_name</code>.so çš„ä¸€éƒ¨åˆ†, è¿™ç§æ–¹å¼æ›´ä¾èµ–äºåŠ¨æ€é“¾æ¥åº“ <em><a href="http://dl.so">dl.so</a></em></p>
<p>è€Œ GLVND çš„ EGL å®ç°åŸºæœ¬ä¸Šä¸ Vulkan ICD æ˜¯ä¸€æ ·çš„(å¯èƒ½Vulkan ICD å°±æ˜¯æ¥æºäº GLVND EGL ICD)ã€‚GLVND EGL ICD çš„ JSON æ–‡ä»¶å‘½åè§„èŒƒå’Œå®‰è£…è·¯å¾„è§„èŒƒ:</p>
<ul>
<li>å‘½åè§„èŒƒ
<ul>
<li>10_<code>myvendor</code>.<code>$arch</code>.json</li>
</ul>
</li>
<li>è·¯å¾„è§„èŒƒ
<ul>
<li><code>$&#123;CMAKE_INSTALL_PREFIX&#125;</code>/<code>$&#123;CMAKE_INSTALL_DATADIR&#125;</code>/glvnd/egl_vendor.d/</li>
</ul>
</li>
</ul>
<h1 id="vulkan-wsi"><a class="markdownIt-Anchor" href="#vulkan-wsi"></a> Vulkan WSI</h1>
<p>Vulkan WSI (Window System Integration) æ˜¯Vulkan API çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œç”¨äºå°†æ¸²æŸ“ç»“æœæ˜¾ç¤ºåœ¨ä¸åŒå¹³å°çš„çª—å£ç³»ç»Ÿä¸Šã€‚WSI é€šè¿‡ä¸€ç³»åˆ—å¯é€‰çš„ Vulkan æ‰©å±•æ¥å®ç°ï¼Œè¿™äº›æ‰©å±•æŠ½è±¡äº†æ¯ä¸ªå¹³å°çš„çª—å£æœºåˆ¶ï¼Œä½¿å¾— Vulkan API å¯ä»¥åœ¨å„ç§å¹³å°ä¸Šä½¿ç”¨ã€‚</p>
<ul>
<li>VK_KHR_surface (object/handle <code>VkSurfaceKHR</code>)
<ul>
<li>VK_KHR_win32_surface</li>
<li>VK_KHR_android_surface</li>
<li>VK_KHR_wayland_surface</li>
<li>VK_KHR_xcb_surface, VK_KHR_xlib_surface</li>
<li>VK_MVK_macos_surface</li>
<li>VK_MVK_ios_surface</li>
</ul>
</li>
<li>VK_KHR_swapchain (object/handle <code>VkSwapchainKHR</code>)</li>
</ul>
<p><em>æ³¨æ„: <code>VkSurfaceKHR</code> å’Œ <code>VkSwapchainKHR</code> æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘ç»“æ„ä½“çš„æŒ‡é’ˆç±»å‹ï¼Œå³ <code>struct VkSurfaceKHR_T *</code> (è¯¦è§ <a href="https://github.com/KhronosGroup/Vulkan-Headers/blob/main/include/vulkan/vulkan_core.h#L57">vulkan_core.h</a>)</em></p>
<ul>
<li>Vulkan SDK è‡ªå¸¦çš„ vulkaninfo åœ¨ Ubuntu 20.04/22.04 (llvmpipe Vulkan é©±åŠ¨)æ®µé”™è¯¯
<ul>
<li>Vulkan SDK è‡ªå¸¦çš„ vulkaninfo åœ¨ç¼–è¯‘æ—¶åº”è¯¥æ²¡æœ‰å…³é—­ <code>-DBUILD_WSI_WAYLAND_SUPPORT</code></li>
<li>Ubuntu 20.04/22.04 çš„ Mesa å®ç°ä¸­ <code>vkIcdWsiPlatform</code> ä¸æ”¯æŒ wayland å¹³å°
<ul>
<li>mesa ä¸­çš„ <code>struct wsi_device</code> å®šä¹‰äº†ä¸€ä¸ª <code>struct wsi_interface *</code> çš„ä¸€ä¸ªæ•°ç»„ <code>wsi[VK_ICD_WSI_PLATFORM_MAX]</code>, åœ¨ Ubuntu 20.04/22.04 ä¸Šè¯¥è¡¨ <code>VK_ICD_WSI_PLATFORM_WAYLAND</code> å¯¹åº”çš„ wsi_interface æ˜¯ç©ºçš„  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">            (gdb) p wsi_device-&gt;wsi</span><br><span class="line">            $2 = &#123;0x0, 0x0, 0x0, 0x555555744e00, 0x555555744e00, 0x0, 0x0, 0x0, 0x555555702560, 0x555555753330&#125;</span><br><span class="line">            (gdb) ptype surface-&gt;platform</span><br><span class="line">type = enum &#123;VK_ICD_WSI_PLATFORM_MIR, VK_ICD_WSI_PLATFORM_WAYLAND, VK_ICD_WSI_PLATFORM_WIN32, VK_ICD_WSI_PLATFORM_XCB, VK_ICD_WSI_PLATFORM_XLIB, VK_ICD_WSI_PLATFORM_ANDROID, VK_ICD_WSI_PLATFORM_MACOS, VK_ICD_WSI_PLATFORM_IOS, VK_ICD_WSI_PLATFORM_DISPLAY, VK_ICD_WSI_PLATFORM_HEADLESS, VK_ICD_WSI_PLATFORM_METAL, VK_ICD_WSI_PLATFORM_DIRECTFB, VK_ICD_WSI_PLATFORM_VI, VK_ICD_WSI_PLATFORM_GGP, VK_ICD_WSI_PLATFORM_SCREEN, VK_ICD_WSI_PLATFORM_FUCHSIA&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="lavapipe"><a class="markdownIt-Anchor" href="#lavapipe"></a> <a href="https://gitlab.freedesktop.org/mesa/mesa/-/tree/main/src/gallium/frontends/lavapipe">LAVApipe</a></h1>
<p>Vulkan çš„è½¯å®ç°ï¼Œä¸ä¾èµ–ä»»ä½• GPU, ä½†å®ƒå’Œ llvmpipe ä¸€æ ·ï¼Œä¾èµ– LLVMã€‚æ„å»ºå®ƒä¾èµ–:</p>
<ul>
<li>LLVM</li>
<li><a href="https://github.com/KhronosGroup/SPIRV-LLVM-Translator">SPIRV-LLVM-Translator</a>
<ul>
<li>(SPIRV-LLVM-Translator çš„ç‰ˆæœ¬ä¼¼ä¹ä¸ LLVM çš„ç‰ˆæœ¬æœ‰ä¸¥æ ¼çš„è€¦åˆï¼Œäº²æµ‹å¦‚æœ <code>BASE_LLVM_VERSION=20.0.0</code>, å®é™…å®‰è£…çš„ LLVM æ˜¯ 16.0.0 ç¼–è¯‘å¤±è´¥)</li>
</ul>
</li>
</ul>
<h1 id="zink"><a class="markdownIt-Anchor" href="#zink"></a> <a href="https://docs.mesa3d.org/drivers/zink.html">Zink</a></h1>
<p>Zink ä¸æ˜¯æŸä¸ªå…·ä½“ GPU çš„é©±åŠ¨ï¼Œè€Œæ˜¯ä¸€ä¸ªå°†OpenGL API è°ƒç”¨ç¿»è¯‘æˆ Vulkan API, ä»¥åœ¨åªæœ‰Vulkan é©±åŠ¨çš„å¹³å°ä¸Šæä¾›å®Œæ•´OpenGLæ”¯æŒã€‚ä¾‹å¦‚ï¼ŒåŒæ—¶ç¼–è¯‘å®‰è£… Mesa çš„ Zink (-Dgallium-drivers=zink)å’Œ LAVApipe (-Dvulkan-drivers=swrast) é©±åŠ¨ï¼Œä½ å°±ä¸ä»…å¯ä»¥è·‘ vkcube ä¹Ÿå¯ä»¥è·‘ glxgearsã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User defined options</span><br><span class="line">  buildtype                    : debug</span><br><span class="line">  prefix                       : /usr</span><br><span class="line">  cpp_rtti                     : false</span><br><span class="line">  gallium-drivers              : zink</span><br><span class="line">  glx                          : dri</span><br><span class="line">  llvm                         : enabled</span><br><span class="line">  platforms                    : x11</span><br><span class="line">  vulkan-drivers               : swrast</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯åœ¨è½¯æ¸²æŸ“ä¸Šè·‘éœ€è¦æä¾›ä¸€äº›ç¯å¢ƒå˜é‡ <code>MESA_LOADER_DRIVER_OVERRIDE=zink LIBGL_KOPPER_DRI2=true LIBGL_ALWAYS_SOFTWARE=true ZINK_DEBUG=nir glxgears</code></p>
<ul>
<li><code>LIBGL_KOPPER_DRI2=true</code> æ˜¯å› ä¸ºæˆ‘çš„ç¯å¢ƒä¸Šæ²¡æœ‰ DRI3, Zink åœ¨æ²¡æœ‰ DRI3 æ”¯æŒ, ä¸”ç”¨æˆ·æ²¡æœ‰è¦æ±‚ä½¿ç”¨ DRI2 çš„æƒ…å†µä¸‹æ˜¯ä¸è¢«ä½¿èƒ½çš„ã€‚</li>
<li><code>LIBGL_ALWAYS_SOFTWARE=true</code> æ˜¯å› ä¸º zink çš„å®ç°è¦æ±‚ <a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/gallium/drivers/zink/zink_screen.c#L1763"><code>/* allow software rendering only if forced by the user */</code></a></li>
<li><code>ZINK_DEBUG=nir</code> ä¸ºäº†èƒ½ç›´è§‚åœ°çœ‹åˆ°é©±åŠ¨ä½¿ç”¨çš„æ˜¯ Zink è€Œé LLVMpipe çš„OpenGLå®ç°ï¼Œç‰¹æ„åŠ äº† Zink è°ƒè¯•ç¯å¢ƒå˜é‡ï¼Œå°† shader çš„ NIR æ‰“å°å‡ºæ¥
<ul>
<li>glxgears on Zink<br />
<img src="/images/vk/glxgears-on-zink.gif" alt="glxgears on Zink" /></li>
<li>glmark2 on Zink<br />
<img src="/images/vk/glmark2-on-zink.gif" alt="glmark2 on Zink" /></li>
</ul>
</li>
</ul>
<h1 id="appendix-apt-install-2304-lunar-lobster"><a class="markdownIt-Anchor" href="#appendix-apt-install-2304-lunar-lobster"></a> Appendix: apt install (23.04 Lunar Lobster)</h1>
<p><strong>ä¹¦åˆ°ç”¨æ—¶æ–¹æ¨å°‘ï¼ŒåŒ…åˆ°è£…æ—¶ä¸å¥½æ‰¾</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install -y cmake ninja-build bison flex g++ git pkg-config python3-setuptools python3-lz4 \</span><br><span class="line">    python3-jinja2 libssl-dev libelf-dev libboost-dev libglm-dev libtinyobjloader-dev libstb-dev \</span><br><span class="line">    libpng-dev wayland-protocols libwayland-dev libdecor-0-dev freeglut3-dev libexpat1-dev libglvnd-dev \</span><br><span class="line">    libx11-dev libxext-dev libxshmfence-dev libxrandr-dev libxxf86vm-dev libxfixes-dev libx11-xcb-dev \</span><br><span class="line">    libxcb1-dev libxcb-randr0-dev libxcb-glx0-dev libxcb-shm0-dev libxcb-dri3-dev libxcb-dri2-0-dev libxcb-present-dev \</span><br><span class="line">    libselinux1-dev libvulkan-dev vulkan-tools mesa-utils</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Vulkan</tag>
      </tags>
  </entry>
  <entry>
    <title>Vulkan Application</title>
    <url>/gfx/vkapp/</url>
    <content><![CDATA[<p>Vulkan æ˜¯ä¸€ä¸ªä½å¼€é”€ã€è·¨å¹³å°çš„äºŒç»´å’Œä¸‰ç»´å›¾å½¢ä¸è®¡ç®—çš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œç”± Khronos åœ¨2015å¹´åœ¨ GDC ä¸Šé¦–æ¬¡å‘å¸ƒã€‚å®ƒæ—¨åœ¨æä¾›é«˜æ•ˆèƒ½å’Œæ›´å‡è¡¡çš„ CPU å’Œ GPU å ç”¨ï¼Œç±»ä¼¼äº Direct3D 12 å’Œ AMD Mantleã€‚</p>
<p>æœ¬æ–‡ä¸»è¦è®°å½•ä¸€ä¸‹åœ¨ llvmpipe è½¯æ¸²æŸ“ Vulkan é©±åŠ¨ä¸‹ï¼Œ ä¸€ä¸ª vulkan åº”ç”¨ç¨‹åº (<a href="https://github.com/lucmann/VulkanExamples/tree/build-for-linux/examples/deferredmultisampling">demo</a>) çš„æ‰§è¡Œè¿‡ç¨‹ã€‚</p>
<span id="more"></span>
<h1 id="environment-variables"><a class="markdownIt-Anchor" href="#environment-variables"></a> Environment Variables</h1>
<h2 id="vk_icd_filenames"><a class="markdownIt-Anchor" href="#vk_icd_filenames"></a> VK_ICD_FILENAMES</h2>
<p>Vulkan é©±åŠ¨çš„æ¢æµ‹å’ŒåŠ è½½æ˜¯é€šè¿‡ ICD (Installable Client Driver) æœºåˆ¶å®ç°çš„ã€‚å½“ç¯å¢ƒä¸ŠåŒæ—¶å­˜åœ¨å¤šä¸ª Vulkan é©±åŠ¨æ—¶ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡ <code>VK_ICD_FILENAMES</code> æ¥é€‰æ‹©æŒ‡å®šçš„ vulkan é©±åŠ¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;VK_ICD_FILENAMES&quot;,</span><br><span class="line">    &quot;value&quot;: &quot;/home/luc/mesa-install/share/vulkan/icd.d/lvp_icd.x86_64.json&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="vk_loader_debugall"><a class="markdownIt-Anchor" href="#vk_loader_debugall"></a> VK_LOADER_DEBUG=all</h2>
<h2 id="mesa_vk_wsi_present_mode"><a class="markdownIt-Anchor" href="#mesa_vk_wsi_present_mode"></a> MESA_VK_WSI_PRESENT_MODE</h2>
<p>ç›¸å½“äº GL çš„ <code>vblank_mode</code>, ç”¨æ¥æ§åˆ¶ FPS æ˜¯å¦ä¸ VSync åŒæ­¥</p>
<p>Vulkan ç¨‹åºçš„é€æ˜¾ç”± WSI (Window System Interface) å±‚å®ç°ï¼Œæ”¯æŒä»¥ä¸‹æ¨¡å¼</p>
<ul>
<li>fifo</li>
<li>relaxed</li>
<li>mailbox</li>
<li>immediate</li>
</ul>
<p>æ³¨æ„ï¼šå¯¹äº lavapipe (è½¯æ¸²æŸ“çš„ Vulkan å®ç°)ï¼Œå®ƒåªæ”¯æŒ immediate æ¨¡å¼</p>
<h1 id="call-stack"><a class="markdownIt-Anchor" href="#call-stack"></a> Call Stack</h1>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">libvulkan_lvp.so!llvmpipe_create_screen(struct sw_winsys * winsys) (\home\luc\gh\forked\src\gallium\drivers\llvmpipe\lp_screen.c:1149)</span><br><span class="line">libvulkan_lvp.so!sw_screen_create_named(struct sw_winsys * winsys, const struct pipe_screen_config * config, const char * driver) (\home\luc\gh\forked\src\gallium\auxiliary\target-helpers\sw_helper.h:43)</span><br><span class="line">libvulkan_lvp.so!sw_screen_create_vk(struct sw_winsys * winsys, const struct pipe_screen_config * config, _Bool sw_vk) (\home\luc\gh\forked\src\gallium\auxiliary\target-helpers\sw_helper.h:90)</span><br><span class="line">libvulkan_lvp.so!pipe_loader_sw_create_screen(struct pipe_loader_device * dev, const struct pipe_screen_config * config, _Bool sw_vk) (\home\luc\gh\forked\src\gallium\auxiliary\pipe-loader\pipe_loader_sw.c:427)</span><br><span class="line">libvulkan_lvp.so!pipe_loader_create_screen_vk(struct pipe_loader_device * dev, _Bool sw_vk, _Bool driver_name_is_inferred) (\home\luc\gh\forked\src\gallium\auxiliary\pipe-loader\pipe_loader.c:181)</span><br><span class="line">libvulkan_lvp.so!lvp_physical_device_init(struct lvp_physical_device * device, struct lvp_instance * instance, struct pipe_loader_device * pld) (\home\luc\gh\forked\src\gallium\frontends\lavapipe\lvp_device.c:1240)</span><br><span class="line">libvulkan_lvp.so!lvp_enumerate_physical_devices(struct vk_instance * vk_instance) (\home\luc\gh\forked\src\gallium\frontends\lavapipe\lvp_device.c:1416)</span><br><span class="line">libvulkan_lvp.so!enumerate_physical_devices_locked(struct vk_instance * instance) (\home\luc\gh\forked\src\vulkan\runtime\vk_instance.c:434)</span><br><span class="line">libvulkan_lvp.so!enumerate_physical_devices(struct vk_instance * instance) (\home\luc\gh\forked\src\vulkan\runtime\vk_instance.c:459)</span><br><span class="line">libvulkan_lvp.so!vk_common_EnumeratePhysicalDevices(VkInstance _instance, uint32_t * pPhysicalDeviceCount, VkPhysicalDevice * pPhysicalDevices) (\home\luc\gh\forked\src\vulkan\runtime\vk_instance.c:475)</span><br><span class="line">libvulkan.so.1![Unknown/Just-In-Time compiled code] (Unknown Source:0)</span><br><span class="line">libvulkan.so.1!vkEnumeratePhysicalDevices (Unknown Source:0)</span><br><span class="line">vk::DispatchLoaderStatic::vkEnumeratePhysicalDevices(const vk::DispatchLoaderStatic * const this, VkInstance instance, uint32_t * pPhysicalDeviceCount, VkPhysicalDevice * pPhysicalDevices) (\usr\local\include\vulkan\vulkan.hpp:1047)</span><br><span class="line">vk::Instance::enumeratePhysicalDevices&lt;std::allocator&lt;vk::PhysicalDevice&gt;, vk::DispatchLoaderStatic&gt;(const vk::DispatchLoaderStatic &amp; d, const vk::Instance * const this) (\usr\local\include\vulkan\vulkan_funcs.hpp:120)</span><br><span class="line">vks::Context::pickDevice(vks::Context * const this, const vk::SurfaceKHR &amp; surface) (\home\luc\gh\VulkanExamples\base\vks\context.hpp:426)</span><br><span class="line">vks::Context::createDevice(vks::Context * const this, const vk::SurfaceKHR &amp; surface) (\home\luc\gh\VulkanExamples\base\vks\context.hpp:233)</span><br><span class="line">vkx::ExampleBase::initVulkan(vkx::ExampleBase * const this) (\home\luc\gh\VulkanExamples\base\vulkanExampleBase.cpp:123)</span><br><span class="line">vkx::ExampleBase::run(vkx::ExampleBase * const this) (\home\luc\gh\VulkanExamples\base\vulkanExampleBase.cpp:75)</span><br><span class="line">main(const int argc, const char ** argv) (\home\luc\gh\VulkanExamples\examples\deferredmultisampling\deferredmultisampling.cpp:684)</span><br></pre></td></tr></table></figure>
<h1 id="debug-options"><a class="markdownIt-Anchor" href="#debug-options"></a> Debug Options</h1>
<p>å°±åƒå…¶å®ƒ Gallium é©±åŠ¨ä¸€æ ·ï¼Œllvmpipe ä¹Ÿæä¾›äº†å¾ˆå¤šè°ƒè¯•å’Œæ€§èƒ½æµ‹è¯•çš„é€‰é¡¹, è¿™æ­¤é€‰é¡¹é€šè¿‡ç¯å¢ƒå˜é‡ <code>LP_DEBUG</code> å’Œ <code>LP_PERF</code> æ¥è®¾ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">debug_parse_flags_option: help for LP_DEBUG:</span><br><span class="line">|        pipe [0x0000000000000001]</span><br><span class="line">|        tgsi [0x0000000000000002]</span><br><span class="line">|         tex [0x0000000000000004]</span><br><span class="line">|       setup [0x0000000000000010]</span><br><span class="line">|        rast [0x0000000000000020]</span><br><span class="line">|       query [0x0000000000000040]</span><br><span class="line">|      screen [0x0000000000000080]</span><br><span class="line">|    counters [0x0000000000000800]</span><br><span class="line">|       scene [0x0000000000001000]</span><br><span class="line">|       fence [0x0000000000002000]</span><br><span class="line">| no_fastpath [0x0000000000080000]</span><br><span class="line">|      linear [0x0000000000100000]</span><br><span class="line">|     linear2 [0x0000000000200000]</span><br><span class="line">|         mem [0x0000000000004000]</span><br><span class="line">|          fs [0x0000000000008000]</span><br><span class="line">|          cs [0x0000000000010000]</span><br><span class="line">| accurate_a0 [0x0000000000800000]</span><br><span class="line">|        mesh [0x0000000001000000]</span><br><span class="line">debug_parse_flags_option: help for LP_PERF:</span><br><span class="line">|         texmem [0x0000000000000001]</span><br><span class="line">|      no_mipmap [0x0000000000000004]</span><br><span class="line">|      no_linear [0x0000000000000008]</span><br><span class="line">|  no_mip_linear [0x0000000000000002]</span><br><span class="line">|         no_tex [0x0000000000000010]</span><br><span class="line">|       no_blend [0x0000000000000020]</span><br><span class="line">|       no_depth [0x0000000000000040]</span><br><span class="line">|   no_alphatest [0x0000000000000080]</span><br><span class="line">| no_rast_linear [0x0000000000000100]</span><br><span class="line">|       no_shade [0x0000000000000200]</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Vulkan</tag>
      </tags>
  </entry>
  <entry>
    <title>VkSemaphore</title>
    <url>/gfx/vksem/</url>
    <content><![CDATA[<pre><code class="highlight mermaid">---
title: VkSemaphore interface
---
classDiagram
    VkSemaphore ()-- vk_semaphore
    vk_object_base &lt;|-- vk_semaphore
    vk_semaphore &lt;|.. vk_sync
    vk_sync -- vk_sync_type
    link vk_semaphore &quot;https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/vulkan/runtime/vk_semaphore.h&quot; &quot;vk_semaphore&quot;
    link vk_sync &quot;https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/vulkan/runtime/vk_sync.h&quot; &quot;vk_sync&quot;
    link vk_sync_type &quot;https://gitlab.freedesktop.org/mesa/mesa/-/blob/main/src/vulkan/runtime/vk_sync.h&quot; &quot;vk_sync_type&quot;
    class vk_object_base&#123;
        VK_LOADER_DATA _loader_data
        VkObjectType type
        bool client_visible
        vk_device *device
        vk_instance *instance
        util_sparse_array private_data
        char *object_name
    &#125;
    class vk_semaphore&#123;
        VkSemaphoreType type
        vk_sync *temporary
        vk_sync permanent
    &#125;
    class vk_sync&#123;
        vk_sync_type *type
        vk_sync_flags flags
    &#125;
    class vk_sync_type&#123;
        size_t size
        vk_sync_features features
        init() VkResult
        finish() void
        signal() VkResult
        get_value() VkResult
        reset() VkResult
        move() VkResult
        wait() VkResult
        wait_many() VkResult
        import_opaque_fd() VkResult
        export_opaque_fd() VkResult
        import_sync_file() VkResult
        export_sync_file() VkResult
        import_win32_handle() VkResult
        export_win32_handle() VkResult
        set_win32_export_params() VkResult
    &#125;
    &lt;&lt;interface&gt;&gt; vk_sync_type</code></pre>
<span id="more"></span>
<p>å¦‚æœæŠŠåŸºäº Vulkan çš„æ¸²æŸ“çœ‹æˆä¸€ä¸ªå›¾ï¼Œé‚£ä¹ˆ <code>VkCommandBuffer</code> æ˜¯èŠ‚ç‚¹ (node)ï¼Œ<code>VkSemaphore</code> æ˜¯è¾¹ (edge)</p>
<pre><code class="highlight mermaid">flowchart LR
    subgraph &quot;Process 1&quot;
        c1((VkCommandBuffer 1))
    end
    subgraph &quot;Process 2&quot;
        c2((VkCommandBuffer 2))
        c3((VkCommandBuffer 3))
    end
    subgraph &quot;Process 3&quot;
        c4((VkCommandBuffer 4))
        c5((VkCommandBuffer 5))
    end

    c1 --VkSemaphore 1--&gt; c2
    c2 --VkSemaphore 2--&gt; c4
    c3 --VkSemaphore 3--&gt; c5
    c1 --VkSemaphore 4--&gt; c5</code></pre>
<h1 id="implicit-sync-å¥½å¥½çš„ä¸ºä»€ä¹ˆåœ¨-vulkan-é‡Œè¦æ-explicit-sync"><a class="markdownIt-Anchor" href="#implicit-sync-å¥½å¥½çš„ä¸ºä»€ä¹ˆåœ¨-vulkan-é‡Œè¦æ-explicit-sync"></a> Implicit Sync å¥½å¥½çš„ï¼Œä¸ºä»€ä¹ˆåœ¨ Vulkan é‡Œè¦æ Explicit Sync?</h1>
<p>Implicit Sync ç”±å†…æ ¸è´Ÿè´£ï¼Œåº”ç”¨(ç”šè‡³ UMD) ä¸ç”¨æ“å¿ƒï¼Œç¡®å®ä¹Ÿèƒ½å·¥ä½œï¼Œä½†æ˜¯ implicit sync å­˜åœ¨<strong>è¿‡åº¦åŒæ­¥ (over-synchronization)</strong> çš„é—®é¢˜ï¼Œå¿…ç„¶å¯¼è‡´ä¸èƒ½æœ€å¤§é™åº¦åœ°å‘æŒ¥å‡º CPU å’Œ GPU çš„å¹¶è¡Œèƒ½åŠ›ã€‚</p>
<p>ä¸ºä»€ä¹ˆ implicit sync ä¼šæœ‰è¿‡åº¦åŒæ­¥çš„é—®é¢˜? implicit sync è¯´ç™½äº†ï¼Œæ˜¯ç”±å†…æ ¸åœ¨ä¸çŸ¥é“åº”ç”¨ç¡®åˆ‡åŒæ­¥è¦æ±‚(è°ç­‰ä»€ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™å®Œæˆ)çš„æƒ…å†µä¸‹<strong>ä¸€è‚¡è„‘å„¿</strong>åœ°ç»™ä½ è¿›è¡Œ<strong>ä¸åˆ†é’çº¢çš‚ç™½</strong>åœ°é˜»å¡å¼åŒæ­¥ï¼Œæ˜¯èƒ½æ­£å¸¸å·¥ä½œï¼Œä½†ä¸å¤Ÿç²¾ç»†ï¼Œå¥½å¤šåœ°æ–¹å¯èƒ½æ˜¯ç™½ç­‰äº†ã€‚</p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://www.collabora.com/news-and-blog/blog/2022/06/09/bridging-the-synchronization-gap-on-linux">Brigding the synchronization gap on Linux</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>Vulkan</tag>
      </tags>
  </entry>
  <entry>
    <title>Wayland</title>
    <url>/gfx/wayland/</url>
    <content><![CDATA[<h1 id="wayland-architecture"><a class="markdownIt-Anchor" href="#wayland-architecture"></a> Wayland Architecture</h1>
<p>ä¸ºäº†ç†è§£waylandçš„æ¶æ„å’Œå®ƒä¸Xçš„åŒºåˆ«ï¼Œæœ€å¥½æ˜¯çœ‹çœ‹ä»ä¸€ä¸ªè¾“å…¥äº‹ä»¶åˆ°è¿™ä¸ªè¾“å…¥äº‹ä»¶çš„ç»“æœå‘ˆç°åˆ°å±å¹•ä¸Šè¿™ä¸ªè¿‡ç¨‹éƒ½å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>
<span id="more"></span>
<img src="/gfx/wayland/x-architecture.png" class="" title="X Architecture">
<ol>
<li>
<p>kernelè·å–åˆ°ä¸€ä¸ªè¾“å…¥äº‹ä»¶ï¼Œé€šè¿‡<code>evdev</code>è¾“å…¥è®¾å¤‡é©±åŠ¨å‘é€ç»™X Server.è¿™é‡Œkernelåšäº†å¾ˆå¤šå·¥ä½œï¼ŒåŒ…æ‹¬é©±åŠ¨è¾“å…¥è®¾å¤‡ï¼Œè½¬æ¢å„ç§ä¸åŒçš„è®¾å¤‡äº‹ä»¶åè®®ä¸ºæ ‡å‡†çš„Linux <code>evdev</code>è¾“å…¥äº‹ä»¶ã€‚</p>
</li>
<li>
<p>X Serverå†³å®šè¿™ä¸ªäº‹ä»¶å½±å“å“ªä¸ªçª—å£ï¼Œå¹¶å‘é€è¿™ä¸ªäº‹ä»¶ç»™è¯¥çª—å£æ‰€å±çš„é‚£äº›å®¢æˆ·ç«¯ï¼Œä½†é—®é¢˜æ˜¯ï¼ŒX Serverå¹¶ä¸èƒ½çœŸæ­£ç¡®å®šæ˜¯å“ªä¸ªçª—å£ï¼Œå› ä¸ºåœ¨å±å¹•åæ ‡é‡Œçš„çª—å£ä½ç½®æ˜¯ç”±compositoræ§åˆ¶çš„ï¼Œçª—å£ä½ç½®å¯ä»¥è¢«å¾ˆå¤šæ“ä½œæ”¹å˜ï¼Œç¼©å°ï¼Œæ—‹è½¬ï¼Œæ™ƒåŠ¨ç­‰ç­‰ï¼Œè€ŒX Serverå¹¶ä¸çŸ¥æ™“è¿™äº›æ“ä½œã€‚</p>
</li>
<li>
<p>å®¢æˆ·ç«¯æ”¶åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œç„¶åå†³å®šåšä»€ä¹ˆã€‚é€šå¸¸å¯¹äº‹ä»¶çš„å“åº”æ˜¯UIçš„æ”¹å˜ï¼Œä¹Ÿè®¸æ˜¯ä¸€ä¸ªå¤šé€‰æ¡†è¢«æ‰“å‹¾ï¼Œä¹Ÿè®¸æ˜¯é¼ æ ‡è½åˆ°ä¸€ä¸ªæŒ‰é’®ä¸Šï¼ŒæŒ‰é’®é«˜äº®ã€‚å› æ­¤å®¢æˆ·ç«¯åˆå‘X Serverå‘å›ä¸€ä¸ªæ¸²æŸ“è¯·æ±‚ã€‚</p>
</li>
<li>
<p>å½“X Serveræ”¶åˆ°æ¸²æŸ“è¯·æ±‚åï¼Œåˆè½¬å‘ç»™é©±åŠ¨ï¼Œç”±é©±åŠ¨æ§åˆ¶å›¾å½¢ç¡¬ä»¶å®Œæˆæ¸²æŸ“ï¼Œè¿™é‡Œçš„é©±åŠ¨å¯èƒ½æ˜¯åƒAMDæ˜¾å¡çš„é©±åŠ¨ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªåƒMesaè¿™æ ·çš„OpenGLè½¯ä»¶å®ç°ã€‚X Serverè´Ÿè´£è®¡ç®—æ¸²æŸ“åŒºåŸŸçš„è¾¹ç•Œï¼Œä»¥ä¸€ä¸ª<code>damage event</code>å‘é€ç»“æœç»™compositor.</p>
</li>
<li>
<p><code>damage event</code>å‘Šè¯‰compositor, çª—å£çš„å†…å®¹å·²ç»æ”¹å˜ï¼Œå¦‚æœè¿™ä¸ªçª—å£æ˜¯å¯è§çš„ï¼Œé‚£ä¹ˆéœ€è¦é‡æ–°åˆæˆå±å¹•çš„è¿™ä¸€éƒ¨åˆ†ã€‚compositoråŸºäºå®ƒçš„åœºæ™¯å›¾å’ŒX Windowçš„å†…å®¹è´Ÿè´£æ¸²æŸ“æ•´ä¸ªå±å¹•ï¼Œä½†æ˜¯å®ƒè¿˜å¾—é€šè¿‡X Serverå»å®Œæˆæ¸²æŸ“ï¼Œå› ä¸ºåªæœ‰X Serveræ‰èƒ½å’Œé©±åŠ¨æ‰“äº¤é“ã€‚</p>
</li>
<li>
<p>X Serveræ”¶åˆ°compositorçš„æ¸²æŸ“è¯·æ±‚åï¼Œæˆ–è€…æ‹·è´compositor back bufferåˆ°front buffer,æˆ–è€…åšä¸€æ¬¡pageflip. é€šå¸¸æƒ…å†µä¸‹ï¼ŒX Serverå¿…é¡»åšè¿™ä¸€æ­¥ï¼Œå› ä¸ºå®ƒéœ€è¦è®¡ç®—çª—å£é‡å ï¼Œè¿™å¯èƒ½éœ€è¦è£å‰ªæ“ä½œï¼Œå¹¶ä¸”å†³å®šå®ƒæ˜¯å¦å¯ä»¥pageflip. ä½†æ˜¯ï¼Œå¯¹äºæ€»æ˜¯æ‰§è¡Œå…¨å±æ“ä½œçš„compositoræ¥è¯´ï¼Œè¿™åˆæ˜¯ä¸€æ¬¡ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p>
</li>
</ol>
<p>ä¸Šé¢çš„X Serverçš„å·¥ä½œæµç¨‹æœ‰ä¸€äº›é—®é¢˜ã€‚é¦–å…ˆ, X Serveræ²¡æœ‰ç›¸å…³çš„ä¿¡æ¯å»å†³å®šåˆ°åº•å“ªä¸ªçª—å£åº”è¯¥æ¥æ”¶è¿™ä¸ªè¾“å…¥äº‹ä»¶ï¼Œå®ƒä¹Ÿä¸èƒ½å°†å±å¹•åæ ‡è½¬æ¢æˆçª—å£å†…éƒ¨åæ ‡ï¼Œç”šè‡³X ServeræŠŠæœ€åçš„å±å¹•æ¸²æŸ“å·¥ä½œçš„èŒè´£éƒ½äº¤ç»™äº†åˆæˆç®¡ç†å™¨ï¼ŒX Serverä»ç„¶æ§åˆ¶ç€front bufferå’Œmodesetting. X Serverè¿‡å»å¤§å¤šæ•°å¤æ‚çš„å·¥ä½œç°åœ¨è¦ä¹ˆæ˜¯åœ¨kernelä¸­å¯ä»¥å®Œæˆ(<code>KMS</code>, <code>evdev</code>), è¦ä¹ˆå¯ä»¥åœ¨ä¸€äº›è‡ªåŒ…å«çš„åº“é‡Œå®Œæˆ(<code>mesa</code>, <code>fontconfig</code>, <code>freetype</code>, <code>cairo</code>, <code>Qt</code>, ç­‰ç­‰). æ€»çš„æ¥è¯´ï¼ŒX Serverç°åœ¨å·²ç»æˆäº†åœ¨åº”ç”¨ç¨‹åºå’Œcompositorä¹‹é—´ï¼Œcompositorå’Œç¡¬ä»¶ä¹‹é—´å¼•å…¥é¢å¤–æ­¥éª¤çš„ä¸­é—´äººäº†ã€‚</p>
<p>åœ¨waylandé‡Œï¼Œcompositorå°±æ˜¯<strong>Display Server</strong>. æˆ‘ä»¬æŠŠ<code>KMS</code>å’Œ<code>evdev</code>çš„æ§åˆ¶æƒç§»äº¤ç»™compositor. Waylandåè®®è®©compositorç›´æ¥å‘é€è¾“å…¥äº‹ä»¶ç»™å®¢æˆ·ç«¯ï¼Œè®©å®¢æˆ·ç«¯ç›´æ¥å‘é€<code>damage event</code>ç»™compositor.</p>
<img src="/gfx/wayland/wayland-architecture.png" class="" title="Wayland Architecture">
<ol>
<li>
<p>kernelå‘é€è¾“å…¥äº‹ä»¶ç»™compositor, è¿™ä¸€æ­¥ä¸X Serverç±»ä¼¼ï¼Œè¿™æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥å¤ç”¨å†…æ ¸ä¸­æ‰€æœ‰çš„è¾“å…¥è®¾å¤‡é©±åŠ¨ã€‚</p>
</li>
<li>
<p>compositoræµè§ˆå®ƒçš„åœºæ™¯å›¾æ¥å†³å®šè¾“å…¥äº‹ä»¶åº”è¯¥å‘ç»™å“ªä¸ªçª—å£ã€‚åœºæ™¯å›¾å¯¹åº”å±å¹•ä¸Šçš„æ˜¾ç¤ºï¼ŒcompositorçŸ¥æ™“å®ƒå·²ç»åº”ç”¨åˆ°åœºæ™¯å›¾ä¸­å„ä¸ªå…ƒç´ çš„åæ ‡å˜æ¢ï¼Œå› æ­¤compositorå¯ä»¥æ­£ç¡®é€‰æ‹©å“ªä¸ªçª—å£æ¥æ”¶è¾“å…¥äº‹ä»¶ï¼Œä¹Ÿå¯ä»¥å°†å±å¹•åæ ‡è½¬æ¢ä¸ºçª—å£å†…éƒ¨åæ ‡é€šè¿‡é€†å˜æ¢ã€‚æ‰€èƒ½åº”ç”¨åˆ°æŸä¸ªçª—å£çš„å˜æ¢ç±»å‹å®Œå…¨å–å†³äºcompositorçš„å®ç°ï¼Œåªè¦å®ƒå¯ä»¥è®¡ç®—å‡ºå¯¹åº”è¾“å…¥äº‹ä»¶çš„é€†å˜æ¢ã€‚</p>
</li>
<li>
<p>å’ŒX Serverçš„åœºæ™¯ç±»ä¼¼ï¼Œå½“å®¢æˆ·ç«¯æ”¶åˆ°è¾“å…¥äº‹ä»¶åï¼Œå®ƒç›¸åº”åœ°æ›´æ–°UI. ä½†åœ¨waylandä¸‹ï¼Œå®¢æˆ·ç«¯ä¸å†å‘é€æ¸²æŸ“è¯·æ±‚ç»™è°ï¼Œæ¸²æŸ“ä»»åŠ¡ç”±å®¢æˆ·ç«¯è‡ªå·±å®Œæˆï¼Œå®¢æˆ·ç«¯åªéœ€è¦å‘é€æ¶ˆæ¯å‘Šè¯‰compositorå“ªå—åŒºåŸŸå·²ç»æ›´æ–°äº†ã€‚</p>
</li>
<li>
<p>compositoræ”¶é›†æ¥è‡ªå®ƒçš„å®¢æˆ·ç«¯çš„<code>damage event</code>, ç„¶åé‡æ–°åˆæˆæ•´ä¸ªå±å¹•ã€‚compositorèƒ½ç›´æ¥å‘é€<code>ioctl</code>è¯·æ±‚ç»™KMSæ‰§è¡Œä¸€æ¬¡pageflip.</p>
</li>
</ol>
<p><a href="https://wayland.freedesktop.org/architecture.html">[é˜…è¯»åŸæ–‡]</a></p>
<h2 id="waylandxml"><a class="markdownIt-Anchor" href="#waylandxml"></a> <a href="https://gitlab.freedesktop.org/wayland/wayland">wayland.xml</a></h2>
<h2 id="wayland-scanner"><a class="markdownIt-Anchor" href="#wayland-scanner"></a> <a href="https://gitlab.freedesktop.org/wayland/wayland">wayland-scanner</a></h2>
<pre><code class="highlight mermaid">flowchart LR
  A[wayland.xml]
  B[C headers &amp; glue code]
  A == wayland-scanner ==&gt; B

  click A &quot;https://gitlab.freedesktop.org/wayland/wayland/-/blob/main/protocol/wayland.xml?ref_type=heads&quot; _blank
  click B &quot;https://searchfox.org/mozilla-central/source/widget/gtk/wayland/linux-dmabuf-unstable-v1-client-protocol.h#476&quot;</code></pre>
<h2 id="libwayland-clientservercursoregl"><a class="markdownIt-Anchor" href="#libwayland-clientservercursoregl"></a> <a href="https://gitlab.freedesktop.org/wayland/wayland">libwayland-{client,server,cursor,egl}</a></h2>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://wayland-book.com/">Wayland Book</a></li>
<li><a href="https://wayland.app/protocols/hyprland-ctm-control-v1">Wayland Protocol Explorer</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>X11</tag>
      </tags>
  </entry>
  <entry>
    <title>x11perf</title>
    <url>/gfx/x11perf/</url>
    <content><![CDATA[<h1 id="x11perf"><a class="markdownIt-Anchor" href="#x11perf"></a> <a href="https://gitlab.freedesktop.org/xorg/test/x11perf">x11perf</a></h1>
<p><a href="https://gitlab.freedesktop.org/xorg/test/x11perf">x11perf</a> æ˜¯ä¸€ä¸ª X11 Server çš„æ€§èƒ½æµ‹è¯•ç¨‹åº</p>
<p><img src="/images/x11perf/x11perf-f24itext.png" alt="x11perf -range -ftext,-crgbftext" /></p>
<span id="more"></span>
<h1 id="xlib"><a class="markdownIt-Anchor" href="#xlib"></a> <a href="https://gitlab.freedesktop.org/xorg/lib/libx11">Xlib</a></h1>
<p><a href="https://gitlab.freedesktop.org/xorg/lib/libx11">Xlib</a> æ˜¯ X11 æ ¸å¿ƒå®¢æˆ·ç«¯åº“ï¼Œå®¢æˆ·ç«¯ç¨‹åºåŸºæœ¬ä¸Šéƒ½æ˜¯è°ƒç”¨å®ƒæä¾›çš„ API æ¥ç»˜åˆ¶å›¾å½¢çš„ã€‚ è€Œ Xlib çš„å‡½æ•°åŸºæœ¬ä¸Šéƒ½æ˜¯ç»™ xserver å‘è¯·æ±‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">File</th>
<th style="text-align:left">Request</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">src/ImText16.c:86:9:</td>
<td style="text-align:left">GetReq (ImageText16, req);</td>
</tr>
<tr>
<td style="text-align:left">src/Text16.c:50:5:</td>
<td style="text-align:left">GetReq (PolyText16, req);</td>
</tr>
<tr>
<td style="text-align:left">src/DrSegs.c:47:2:</td>
<td style="text-align:left">GetReq (PolySegment, req);</td>
</tr>
<tr>
<td style="text-align:left">src/LiHosts.c:85:5:</td>
<td style="text-align:left">GetReq (ListHosts, req);</td>
</tr>
<tr>
<td style="text-align:left">src/PolyTxt.c:49:5:</td>
<td style="text-align:left">GetReq (PolyText8, req);</td>
</tr>
<tr>
<td style="text-align:left">src/SetPntMap.c:43:5:</td>
<td style="text-align:left">GetReq (SetPointerMapping, req);</td>
</tr>
<tr>
<td style="text-align:left">src/SetPntMap.c:66:5:</td>
<td style="text-align:left">GetReq (ChangeKeyboardMapping, req);</td>
</tr>
<tr>
<td style="text-align:left">src/GetProp.c:60:5:</td>
<td style="text-align:left">GetReq (GetProperty, req);</td>
</tr>
<tr>
<td style="text-align:left">src/DrLines.c:45:5:</td>
<td style="text-align:left">GetReq (PolyLine, req);</td>
</tr>
<tr>
<td style="text-align:left">src/xcms/cmsLkCol.c:151:5:</td>
<td style="text-align:left">GetReq (LookupColor, req);</td>
</tr>
<tr>
<td style="text-align:left">src/RotProp.c:44:5:</td>
<td style="text-align:left">GetReq (RotateProperties, req);</td>
</tr>
<tr>
<td style="text-align:left">src/ImText.c:85:9:</td>
<td style="text-align:left">GetReq (ImageText8, req);</td>
</tr>
<tr>
<td style="text-align:left">src/OpenDis.c:532:6:</td>
<td style="text-align:left">GetReq (GetProperty, req);</td>
</tr>
<tr>
<td style="text-align:left">src/SetFPath.c:48:2:</td>
<td style="text-align:left">GetReq (SetFontPath, req);</td>
</tr>
<tr>
<td style="text-align:left">src/ParseCol.c:120:6:</td>
<td style="text-align:left">GetReq (LookupColor, req);</td>
</tr>
<tr>
<td style="text-align:left">src/ChProp.c:47:5:</td>
<td style="text-align:left">GetReq (ChangeProperty, req);</td>
</tr>
<tr>
<td style="text-align:left">src/Text.c:50:5:</td>
<td style="text-align:left">GetReq (PolyText8, req);</td>
</tr>
<tr>
<td style="text-align:left">src/PolyTxt16.c:49:5:</td>
<td style="text-align:left">GetReq (PolyText16, req);</td>
</tr>
<tr>
<td style="text-align:left">src/LookupCol.c:83:2:</td>
<td style="text-align:left">GetReq (LookupColor, req);</td>
</tr>
<tr>
<td style="text-align:left">src/GetImage.c:64:2:</td>
<td style="text-align:left">GetReq (GetImage, req);</td>
</tr>
<tr>
<td style="text-align:left">src/SetCRects.c:46:5:</td>
<td style="text-align:left">GetReq (SetClipRectangles, req);</td>
</tr>
</tbody>
</table>
<p><em>P.S.: formatting command</em></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rg &#x27;GetReq (.*, req)&#x27; --vimgrep -tc | awk -F&quot;[ \t]+&quot; &#x27;&#123;printf &quot;| %30-s | &quot;, $1; $1=&quot;&quot;; printf &quot;%40-s |\n&quot;, $0&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="xserver"><a class="markdownIt-Anchor" href="#xserver"></a> <a href="https://gitlab.freedesktop.org/xorg/xserver">Xserver</a></h1>
<p>Xserver çš„å·¥ä½œæ–¹å¼æ˜¯ä¸€ä¸ªå…¸å‹çš„ CS æ¶æ„ï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°è¿™äº›è¯·æ±‚æ—¶ï¼Œåœ¨ä¸€ä¸ª <code>while</code> å¾ªç¯é‡Œåˆ†å‘å’Œå¤„ç†è¿™äº›è¯·æ±‚ï¼Œæˆ–è€…ç¡çœ (Block è‡ªå·±)ã€‚Xserver è¿™ä¸ªåˆ†å‘å¤„ç†é€»è¾‘å®ç°åœ¨ <a href="https://gitlab.freedesktop.org/xorg/xserver/-/blob/master/dix/dispatch.c#L483">dix/dispatch.c:Dispatch()</a> å‡½æ•°é‡Œã€‚Xserver ç”šè‡³æäº†ä¸€ä¸ª <strong><a href="https://gitlab.freedesktop.org/xorg/xserver/-/blob/master/dix/dispatch.c#L338"><code>SmartScheduleClient()</code></a></strong> çš„ robin ç®—æ³•æ¥æ›´é«˜æ•ˆåœ°æœåŠ¡å®¢æˆ·ç«¯ã€‚</p>
<h1 id="ftext"><a class="markdownIt-Anchor" href="#ftext"></a> ftext</h1>
<pre><code class="highlight mermaid">flowchart TD
    subgraph one [InitText]
        A[&quot;XChangeGC()&quot;]
    end
    subgraph two [DoText]
        B[&quot;XDrawString()&quot;]
    end
    subgraph three [ClearTextWin]
        C[&quot;XClearWindow()&quot;]
    end
    subgraph four [EndText]
        D[&quot;XFreeFont()&quot;]
    end

    one --&gt; two --&gt; three --&gt; four</code></pre>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>X11</tag>
      </tags>
  </entry>
  <entry>
    <title>X C Bindings</title>
    <url>/gfx/xcb/</url>
    <content><![CDATA[<p>XCB æ˜¯åº”ç”¨ä¸ X æœåŠ¡å™¨äº¤äº’ä½¿ç”¨çš„ C ç»‘å®šå‡½æ•°é›†ï¼Œå®ƒé‡Œé¢çš„ä¸€äº› C å‡½æ•°æ˜¯é€šè¿‡ python3-xcbgen å·¥å…·ç”Ÿæˆçš„ï¼Œä¸ç»è¿‡ç¼–è¯‘åœ¨å®ƒçš„<a href="https://gitlab.freedesktop.org/xorg/lib/libxcb">æºç åº“</a>æ˜¯æ‰¾ä¸åˆ°çš„ã€‚è€Œä¸” XCB å¤è€åˆ°ä»ç„¶ä½¿ç”¨ autotools é‚£å¥—æ„å»ºç³»ç»Ÿï¼Œæƒ³è¦çœ‹åˆ°æŸäº›å‡½æ•°çš„â€œçœŸå®¹â€ï¼Œä½ è¿˜å¾—â€œåƒå‘¼ä¸‡å”¤â€ã€‚</p>
<span id="more"></span>
<h1 id="build"><a class="markdownIt-Anchor" href="#build"></a> Build</h1>
<ul>
<li>
<p>å®‰è£…å·¥å…·</p>
<ul>
<li><code>sudo apt install python3-xcbgen autoconf automake libtool xutils-dev xcb-proto</code></li>
<li><strong>xutils-dev</strong> é‡ŒåŒ…å« xorg-macros</li>
<li><strong>libxcb</strong> çš„ç‰ˆæœ¬ä¸ *<strong>xcb-proto</strong> è½¯ä»¶åŒ…çš„ç‰ˆæœ¬æœ‰ä¾èµ–å…³ç³»ï¼Œå¦‚æœä½ å®‰è£…çš„ xcb-proto ç‰ˆæœ¬æ˜¯ 1.14-2, é‚£ä¹ˆæœ€å¥½å°† libxcb çš„ tag ä¹Ÿæ£€å‡ºåˆ° libxcb-1.14</li>
</ul>
</li>
<li>
<p>æ„å»º</p>
<ul>
<li><code>./autogen.sh</code></li>
<li><code>make</code></li>
</ul>
</li>
<li>
<p>åƒå‘¼ä¸‡å”¤å§‹å‡ºæ¥</p>
<ul>
<li>åœ¨æ„å»ºå®Œä¹‹åï¼Œä¸ºäº†ä¿å­˜â€œæˆæœâ€ï¼Œéœ€è¦ä½¿ç”¨ä¸€ç‚¹ git å°æŠ€å·§, åœ¨ <code>src/.gitignore</code> æœ€ååŠ ä¸Š
<ul>
<li><code>!*.c</code></li>
</ul>
</li>
<li>ç°åœ¨å¯ä»¥å¥½å¥½çœ‹çœ‹ <code>xcb_dri3_pixmap_from_buffers()</code> çš„å®ç°äº†
<ul>
<li><a href="https://gitlab.freedesktop.org/lucmann/libxcb/-/tree/v1.14-where-you-will-find-xcb_dri3_pixmap_from_buffers">https://gitlab.freedesktop.org/lucmann/libxcb/-/tree/v1.14-where-you-will-find-xcb_dri3_pixmap_from_buffers</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="bindings"><a class="markdownIt-Anchor" href="#bindings"></a> Bindings</h1>
<h2 id="xcb_create_pixmap"><a class="markdownIt-Anchor" href="#xcb_create_pixmap"></a> xcb_create_pixmap</h2>
<pre><code class="highlight mermaid">sequenceDiagram
    autonumber
    participant Mesa
    participant X11

    Mesa--&gt;&gt;X11: xcb_generate_id()
    X11--&gt;&gt;Mesa: uint32_t pid (pixmap id)
    Mesa--&gt;&gt;X11: xcb_create_pixmap()
    X11-&gt;&gt;X11: ProcCreatePixmap()
    note left of X11: CreatePixmapProcPtr æ¥å£ï¼Œæœ‰å„ç§å®ç°&lt;br/&gt;glamor, dri2, xwayland, xnest&lt;br/&gt;å½“åˆçš„ pixmap id ä¼š&lt;br/&gt;è®°å½•åœ¨åˆ›å»ºå¥½çš„ Pixmap çš„ drawable-&gt;id
    X11-&gt;&gt;X11: glamor_create_pixmap(usage=0)
    X11-&gt;&gt;X11: glamor_create_fbo()
    rect rgb(191, 223, 255)
    X11-&gt;&gt;X11: _glamor_create_tex()
    X11--&gt;&gt;Mesa: glGenTextures()
    end
    Mesa--&gt;&gt;X11: xcb_dri3_buffers_from_pixmap(pid)</code></pre>
<h2 id="xcb_dri3_buffers_from_pixmap"><a class="markdownIt-Anchor" href="#xcb_dri3_buffers_from_pixmap"></a> xcb_dri3_buffers_from_pixmap</h2>
<pre><code class="highlight mermaid">sequenceDiagram
    autonumber
    participant Mesa
    participant X11

    Mesa--&gt;&gt;X11: xcb_dri3_buffers_from_pixmap(pid)
    rect rgb(191, 223, 255)
    X11-&gt;&gt;X11: proc_dri3_buffers_from_pixmap()
    X11-&gt;&gt;X11: dixLookupResourceByType(pid)
    note left of X11: é€šè¿‡ pid æ‰¾åˆ°å½“åˆçš„ PixmapPtr
    X11-&gt;&gt;X11: dri3_fds_from_pixmap(PixmapPtr)
    rect rgb(200, 150, 255)
    note left of X11: X11 å¯¼å‡º FD
    X11-&gt;&gt;X11: glamor_egl_fds_from_pixmap()
    X11-&gt;&gt;X11: glamor_make_pixmap_exportable()
    X11-&gt;&gt;X11: glamor_gbm_bo_from_pixmap_internal()
    note left of X11: é€šè¿‡ PixmapPtr è·å– gbm_bo
    X11--&gt;&gt;Mesa: gbm_bo_get_fd()
    Mesa--&gt;&gt;X11: xcb_dri3_buffers_from_pixmap_reply()
    Mesa--&gt;&gt;X11: xcb_dri3_buffers_from_pixmap_reply_fds()
    note right of Mesa: æ‹¿åˆ°å¯¼å‡ºçš„ FD éœ€è¦ä¸¤æ­¥&lt;br/&gt; reply_fds() æ‰æ˜¯çœŸæ­£æ‹¿åˆ° FD
    end
    rect rgb(200, 150, 255)
    note right of Mesa: Mesa å¯¼å…¥ FD
    Mesa-&gt;&gt;Mesa: dri2_from_dma_bufs2()
    Mesa-&gt;&gt;Mesa: dri2_create_image_from_fd()
    Mesa-&gt;&gt;Mesa: dri2_create_image_from_winsys(winsys_handle)
    loop Every FD
        Mesa-&gt;&gt;Mesa: xxx_resource_from_handle()
        Mesa-&gt;&gt;Mesa: xxx_bo_import()
        note right of Mesa: resource_from_handle() è¿”å›çš„&lt;br/&gt;pipe_resource ç»™ __DRIimage.texture
    end
    end
    end</code></pre>
<h2 id="glamor_make_pixmap_exportable"><a class="markdownIt-Anchor" href="#glamor_make_pixmap_exportable"></a> glamor_make_pixmap_exportable</h2>
<p>å‡½æ•°åŠŸèƒ½:</p>
<ul>
<li>100 åˆ›å»ºä¸€ä¸ªæ–°çš„ Pixmap <code>exported</code> ç”¨æ¥ export</li>
<li>200 åŒæ—¶åˆ›å»ºä¸€ä¸ª gbm_bo, å°† <code>exported</code> çš„ header è®¾ç½®æˆåˆšåˆ›å»ºçš„ gbm_bo</li>
<li>300 å°†åŸæ¥çš„ Pixmap çš„å†…å®¹ <code>CopyArea()</code> åˆ° <code>exported</code></li>
<li>400 <code>glamor_egl_exchange_buffers(pixmap, exported)</code>, å°† <code>exported</code> é‡Œçš„ tex/gbm_bo/EGLImage æ¢åˆ°åŸæ¥çš„ Pixmap ç»“æ„ä½“ä¸­</li>
<li>500 é”€æ¯ <code>exported</code> Pixmap</li>
</ul>
<p>æ­¥éª¤ 300 æš—è— bug, å› ä¸º <code>CopyArea()</code> ä¼šè°ƒç”¨ <code>glamor_copy_fbo_fbo_draw()</code> å°†åŸ Pixmap ä½œä¸ºçº¹ç†é‡‡æ ·åˆ°æ–°çš„ Pixmap <code>exported</code>, ä¹Ÿå°±æ˜¯ä¼šè°ƒå…¥ <code>_mesa_DrawArrays()</code>, è¿›è€Œå¯¼è‡´è¿™ä¸ªå³å°†è¢«å¯¼å‡ºçš„ BO, è¢«é‡æ–°è®¾ç½®æˆ drawcall çš„ render target bufferã€‚ ä½†æ˜¯ <code>glamor_copy_fbo_fbo_draw()</code> åœ¨è°ƒç”¨ <code>_mesa_DrawArrays()</code> è¿›è¡Œ&quot;æ‹·è´&quot;åï¼Œå¹¶<strong>ä¸ä¼š <code>glFlush()</code></strong>, åªèƒ½ç­‰åˆ° X11 å®šæ—¶è§¦å‘ <code>Screen-&gt;BlockHandler()</code> æ—¶ <code>glFlush()</code>ã€‚</p>
<p>å¦å¤–ä¸€ä¸ªè¿›ç¨‹å¯¼å…¥ BO åï¼ŒåŒæ ·ä¼šè®¾ç½®å®ƒä¸º render target buffer, è¿™å°±é€ æˆ X11 è¿›ç¨‹å’Œ App è¿›ç¨‹ä¸ºåŒä¸€ä¸ª render target buffer éƒ½åˆ›å»ºäº† CommandBuffer, è€Œæäº¤ç»™ GPU çš„å…ˆåé¡ºåºå´å˜å¾—ä¸ç¡®å®šäº†(æœ‰å¯èƒ½ X11 åæäº¤ï¼Œå–å†³äº <code>BlockHandler()</code> è§¦å‘ç‚¹)ã€‚</p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>X11</tag>
      </tags>
  </entry>
  <entry>
    <title>Xephyr</title>
    <url>/gfx/xephyr/</url>
    <content><![CDATA[<p><a href="https://gitlab.freedesktop.org/xorg/xserver/-/blob/master/hw/kdrive/ephyr/README?ref_type=heads">Xephyr /'zefÉ™/</a> æ˜¯ä¸€ä¸ªåµŒå¥—çš„ X Server, ä½œä¸º X åº”ç”¨ç¨‹åºè¿è¡Œã€‚</p>
<figure class="highlight shell"><figcaption><span>Start Xephyr</span></figcaption><table><tr><td class="code"><pre><span class="line">Xephyr :1 -glamor -screen 1024x768 -ac -retro</span><br></pre></td></tr></table></figure>
<p><img src="/images/xephyr/xephyr-ok2.0.png" alt="Xephyr :1 -screen 1024x768 -glamor -ac -retro" /></p>
<span id="more"></span>
<p>Xephyr æ¯” Xnest æ›´å¼ºå¤§ï¼Œ å› ä¸º Xnest åªæ˜¯ Host X Server çš„ä¸€ä¸ªä»£ç†ï¼Œè€Œ Xephyr æ˜¯ä¸€ä¸ªçœŸæ­£çš„ X Server, å®ƒä½¿ç”¨ Host X Server çš„ä¸€ä¸ªçª—å£ä½œä¸ºå®ƒçš„ â€œframebufferâ€ã€‚Xephyr å¯¹è°ƒè¯•ä¸ X Server äº¤äº’çš„åº”ç”¨ç¨‹åºéå¸¸æœ‰ç”¨ã€‚</p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Xephyr">ç»´åŸºç™¾ç§‘ - Xephyr</a></li>
<li><a href="https://wiki.archlinuxcn.org/wiki/Xephyr">Archlinux Wiki - Xephyr</a></li>
<li><a href="https://blog.csdn.net/weixin_56291477/article/details/131856800">Xephyr ä»‹ç»ä¸ä½¿ç”¨</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>X11</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux accel å­ç³»ç»Ÿ</title>
    <url>/lnx/accel/</url>
    <content><![CDATA[<p>Linux è®¡ç®—åŠ é€Ÿå™¨å­ç³»ç»Ÿæ—¨åœ¨ä»¥é€šç”¨çš„æ–¹å¼å‘ç”¨æˆ·ç©ºé—´å¼€æ”¾è®¡ç®—åŠ é€Ÿå™¨çš„æ¥å£ã€‚è¿™äº›è®¡ç®—åŠ é€Ÿå™¨å¯ä»¥æ˜¯ç‹¬ç«‹çš„ ASIC, ä¹Ÿå¯ä»¥æ˜¯ SoC/GPU å†…çš„ IP å—ã€‚é€šå¸¸è®¡ç®—åŠ é€Ÿå™¨åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ç±»å‹:</p>
<ul>
<li>è¾¹ç¼˜ AI - åœ¨è¾¹ç¼˜è®¾å¤‡ä¸Šè¿›è¡Œæ¨ç†è®¡ç®—</li>
<li>æ¨ç†æ•°æ®ä¸­å¿ƒ - å¤§å‹æœåŠ¡å™¨ä¸­çš„å•ç”¨æˆ·/å¤šç”¨æˆ·è®¾å¤‡</li>
<li>è®­ç»ƒæ•°æ®ä¸­å¿ƒ - ç±»ä¼¼äºæ¨ç†æ•°æ®ä¸­å¿ƒå¡ï¼Œä½†é€šå¸¸å…·æœ‰æ›´å¼ºçš„è®¡ç®—èƒ½åŠ›å’Œæ›´é«˜çš„å­˜å‚¨å¸¦å®½</li>
</ul>
<span id="more"></span>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if DRM</span><br><span class="line"></span><br><span class="line">menuconfig DRM_ACCEL</span><br><span class="line">	bool &quot;Compute Acceleration Framework&quot;</span><br><span class="line">	help</span><br><span class="line">	  Framework for device drivers of compute acceleration devices, such</span><br><span class="line">	  as, but not limited to, Machine-Learning and Deep-Learning</span><br><span class="line">	  acceleration devices.</span><br><span class="line">	  If you say Y here, you need to select the module that&#x27;s right for</span><br><span class="line">	  your acceleration device from the list below.</span><br><span class="line">	  This framework is integrated with the DRM subsystem as compute</span><br><span class="line">	  accelerators and GPUs share a lot in common and can use almost the</span><br><span class="line">	  same infrastructure code.</span><br><span class="line">	  Having said that, acceleration devices will have a different</span><br><span class="line">	  major number than GPUs, and will be exposed to user-space using</span><br><span class="line">	  different device files, called accel/accel* (in /dev, sysfs</span><br><span class="line">	  and debugfs).</span><br><span class="line"></span><br><span class="line">source &quot;drivers/accel/habanalabs/Kconfig&quot;</span><br><span class="line">source &quot;drivers/accel/ivpu/Kconfig&quot;</span><br><span class="line">source &quot;drivers/accel/qaic/Kconfig&quot;</span><br><span class="line"></span><br><span class="line">endif</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ accel å­ç³»ç»Ÿè¢«åˆå…¥ä¸»çº¿æ—¶çš„ commit message</p>
<blockquote>
<p>drivers/accel: define kconfig and register a new major</p>
<p>Add a new Kconfig for the accel subsystem. The Kconfig currently<br />
contains only the basic CONFIG_DRM_ACCEL option that will be used to<br />
decide whether to compile the accel registration code. Therefore, the<br />
kconfig option is defined as bool.</p>
<p>The accel code will be compiled as part of drm.ko and will be called<br />
directly from the DRM core code. The reason we compile it as part of<br />
drm.ko and not as a separate module is because of cyclic dependency<br />
between drm.ko and the separate module (if it would have existed).<br />
This is due to the fact that DRM core code calls accel functions and<br />
vice-versa.</p>
<p>The accelerator devices will be exposed to the user space with a new,<br />
dedicated major number - 261.</p>
<p>The accel init function registers the new major number as a char device<br />
and create corresponding sysfs and debugfs root entries, similar to<br />
what is done in DRM init function.</p>
<p>I added a new header called drm_accel.h to include/drm/, that will hold<br />
the prototypes of the drm_accel.c functions. In case CONFIG_DRM_ACCEL<br />
is set to â€˜Nâ€™, that header will contain empty inline implementations of<br />
those functions, to allow DRM core code to compile successfully<br />
without dependency on CONFIG_DRM_ACCEL.</p>
<p>I Updated the MAINTAINERS file accordingly with the newly added folder<br />
and I have taken the liberty to appropriate the dri-devel mailing list<br />
and the dri-devel IRC channel for the accel subsystem.</p>
</blockquote>
<p>ç›®å‰ accel ä¸‹å·²ç»æœ‰ 3 ä¸ª AI åŠ é€ŸèŠ¯ç‰‡çš„é©±åŠ¨:</p>
<ul>
<li><strong>habanalabs.ko</strong> - Intel æ——ä¸‹çš„å“ˆç“¦é‚£ (Habana) AI å¤„ç†å™¨ (AIP)</li>
<li><strong>intel_vpu.ko</strong> - Intel Neural Proccessing Unit (NPU) (ä¹‹å‰å« VPU Versatile Proccessing Unit)</li>
<li><strong>qaic.ko</strong> - Qualcomm Cloud AI åŠ é€Ÿå™¨</li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>AMDGPU é©±åŠ¨(KMD + UMD)ä¸­çš„ä¸€äº›ç¼©å†™è¯è§£é‡Š</title>
    <url>/lnx/amdgpu-glossary/</url>
    <content><![CDATA[<p><img src="/images/amdgpu-glossary/amd-arch.jpg" alt="AMDGPU Microarchitecture Roadmap" /></p>
<span id="more"></span>
<h1 id="glossary"><a class="markdownIt-Anchor" href="#glossary"></a> Glossary</h1>
<h2 id="gpu-hardware"><a class="markdownIt-Anchor" href="#gpu-hardware"></a> <a href="https://docs.kernel.org/gpu/amdgpu/driver-core.html#gpu-hardware-structure">GPU Hardware</a></h2>
<p>è¿™é‡Œçš„ hardware block, IP (Intellectual Property) block, controller, processor, engine åŸºæœ¬ä¸Šéƒ½æ˜¯æŒ‡ä¸€ä¸ªå…·æœ‰ç›¸å¯¹ç‹¬ç«‹åŠŸèƒ½çš„<strong>ç¡¬ä»¶å¤„ç†å•å…ƒ</strong>ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">Abbr.</th>
<th style="text-align:left">Stands for</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GMC</td>
<td style="text-align:left">Graphics Memory Controller</td>
<td style="text-align:left">ç®¡ç† GPU ä¸Šä¸åŒ IP å¦‚ä½•è·å–å†…å­˜ (VRAM) çš„æ§åˆ¶å™¨ï¼Œå®ƒä¹Ÿæä¾›æ¯è¿›ç¨‹ GPU è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ”¯æŒ(å¬èµ·æ¥æœ‰ç‚¹åƒ MMU)</td>
</tr>
<tr>
<td style="text-align:left">IH</td>
<td style="text-align:left">Interrupt Handler</td>
<td style="text-align:left">GPU ä¸Šçš„ä¸­æ–­æ§åˆ¶å™¨</td>
</tr>
<tr>
<td style="text-align:left">PSP</td>
<td style="text-align:left">Platform Security Processor</td>
<td style="text-align:left">å¤„ç† SoC ä¸Šçš„å®‰å…¨ç­–ç•¥ï¼Œæ‰§è¡Œ trusted app, ä¸ºå…¶å®ƒ IP éªŒè¯å’ŒåŠ è½½å›ºä»¶ç¨‹åº</td>
</tr>
<tr>
<td style="text-align:left">SMU</td>
<td style="text-align:left">System Management Unit</td>
<td style="text-align:left">SoC çš„ç”µæºç®¡ç†å¾®æ§åˆ¶å™¨ï¼Œé©±åŠ¨é€šè¿‡è¿™ä¸ªæ¨¡å—æ¥æ§åˆ¶èŠ¯ç‰‡çš„æ—¶é’Ÿï¼Œç”µå‹åŸŸï¼Œç”µæºè½¨ç­‰</td>
</tr>
<tr>
<td style="text-align:left">DCN</td>
<td style="text-align:left">Display Controller Next</td>
<td style="text-align:left">æ˜¾ç¤ºæ§åˆ¶å™¨</td>
</tr>
<tr>
<td style="text-align:left">SDMA</td>
<td style="text-align:left">System DMA</td>
<td style="text-align:left">å¤šåŠŸèƒ½ DMA engine, KMD åˆ©ç”¨å®ƒå®Œæˆåˆ†é¡µï¼ŒGPU é¡µè¡¨æ›´æ–°ï¼Œè€Œä¸”å®ƒé€šè¿‡ UMD æš´éœ²ç»™ç”¨æˆ·æ€ä½¿ç”¨</td>
</tr>
<tr>
<td style="text-align:left">GC</td>
<td style="text-align:left">Graphics and Compute</td>
<td style="text-align:left">GFX/Compute engine, è¿™æ˜¯ GPU ä¸Šæœ€å¤§çš„ IP, å®ƒåŒ…å« 3D pipeline å’Œ shader cores</td>
</tr>
<tr>
<td style="text-align:left">VCN</td>
<td style="text-align:left">Video Codec Next</td>
<td style="text-align:left">Multi-media engineï¼Œå®ƒå¤„ç†è§†é¢‘å’Œå›¾åƒçš„ç¼–è§£ç ï¼Œé€šè¿‡ UMD æš´éœ²ç»™ç”¨æˆ·æ€ä½¿ç”¨</td>
</tr>
<tr>
<td style="text-align:left">CP</td>
<td style="text-align:left">Command Processor</td>
<td style="text-align:left">åŒ…å« GFX/Compute engine çš„å‰ç«¯ï¼Œä¸€æ‰¹å¾®æ§åˆ¶å™¨ï¼ŒåŒ…æ‹¬ PFP,ME,CE,MECï¼Œå®ƒä»¬ä¸Šé¢è¿è¡Œå›ºä»¶ä»£ç ï¼Œä¸ºé©±åŠ¨æä¾›ä¸ GFX/Compute engine è¿›è¡Œäº¤äº’çš„æ¥å£</td>
</tr>
<tr>
<td style="text-align:left">CE</td>
<td style="text-align:left">Constant Engine</td>
<td style="text-align:left">GFX CP é‡Œçš„ä¸€ä¸ªå°å¤„ç†å™¨ï¼Œä¸»è¦ç”¨æ¥æ›´æ–° buffer descriptor ä»¥ä¾¿å¼‚æ­¥åœ°å°† PFP/ME ä½¿ç”¨çš„ buffer åŠ è½½è¿› cache</td>
</tr>
<tr>
<td style="text-align:left">PFP</td>
<td style="text-align:left">Pre-Fetch Parser</td>
<td style="text-align:left">GFX CP é‡Œçš„ä¸€ä¸ªå°å¤„ç†å™¨ï¼Œéœ€è¦ç»™å®ƒåŠ è½½ ÂµCode å»æ‰§è¡Œ, ä»åå­—èƒ½çœ‹å‡ºæ¥å®ƒæ˜¯é¢„å– packets çš„</td>
</tr>
<tr>
<td style="text-align:left">ME</td>
<td style="text-align:left">MicroEngine</td>
<td style="text-align:left">GFX CP é‡Œçš„ä¸€ä¸ªå°å¤„ç†å™¨ï¼Œå®ƒå’Œ PFP ç»„æˆä¸€ä¸ª Drawing Engineï¼Œå¯ä»¥å’Œ CE å¼‚æ­¥æ‰§è¡Œ</td>
</tr>
<tr>
<td style="text-align:left">MEC</td>
<td style="text-align:left">MicroEngine Compute</td>
<td style="text-align:left">å¾®æ§åˆ¶å™¨ç”¨æ¥æ§åˆ¶ GFX/Compute engine ä¸Šçš„ compute queues, Compute Engine ä¸€èˆ¬æœ‰ 2 ä¸ª MEC, è€Œä¸”æ¯ä¸ª MEC æ”¯æŒ 32 ä¸ª HW ring(queue)</td>
</tr>
<tr>
<td style="text-align:left">MES</td>
<td style="text-align:left">MicroEngine Scheduler</td>
<td style="text-align:left">ä¸€ä¸ªæ–°çš„å¾®æ§åˆ¶å™¨ç”¨æ¥æ§åˆ¶ queues, ä¼°è®¡æ—¢å¯ä»¥æ§åˆ¶ compute queues, ä¹Ÿå¯ä»¥æ§åˆ¶ gfx queues, è€Œä¸”å®ƒä¸Šé¢è¿è¡Œçš„å›ºä»¶å¯èƒ½å–ä»£ç°æœ‰çš„å†…æ ¸ gpu scheduler, è€Œå˜æˆ firmware-based scheduling ğŸ˜ƒ çŒœ</td>
</tr>
<tr>
<td style="text-align:left">RLC</td>
<td style="text-align:left">RunList Controller</td>
<td style="text-align:left">åˆä¸€ä¸ª GFX/Compute engine é‡Œçš„å¾®æ§åˆ¶å™¨ï¼Œç”¨æ¥å¤„ç† GFX/Compute engine å†…éƒ¨çš„ç”µæºç®¡ç†ï¼Œè‡³äºåå­—æ˜¯å†å²é—ç•™ï¼Œä¸å®ƒçš„åŠŸèƒ½æ²¡æœ‰æ¯›å…³ç³»</td>
</tr>
</tbody>
</table>
<h2 id="driver"><a class="markdownIt-Anchor" href="#driver"></a> <a href="https://docs.kernel.org/gpu/amdgpu/driver-core.html#driver-structure">Driver</a></h2>
<table>
<thead>
<tr>
<th style="text-align:left">Abbr.</th>
<th style="text-align:left">Stands for</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">KIQ</td>
<td style="text-align:left">Kernel Interface Queue</td>
<td style="text-align:left">KMD çš„ä¸€ä¸ªæ§åˆ¶é˜Ÿåˆ—ï¼Œç”¨æ¥ç®¡ç† GFX/Compute engine ä¸Šçš„å…¶å®ƒé˜Ÿåˆ—</td>
</tr>
<tr>
<td style="text-align:left">IB</td>
<td style="text-align:left">Indirect Buffer</td>
<td style="text-align:left">æŸä¸ªç‰¹å®š engine çš„ command buffer, é€šå¸¸ä¸æ˜¯ç›´æ¥å°†å‘½ä»¤å†™å…¥ç¡¬ä»¶ queue é‡Œï¼Œè€Œæ˜¯å…ˆå°†å‘½ä»¤å†™å…¥ä¸€å—å†…å­˜ï¼Œç„¶åå†å°†å†…å­˜çš„åœ°å€å†™å…¥ç¡¬ä»¶ queue</td>
</tr>
<tr>
<td style="text-align:left">HQD</td>
<td style="text-align:left">Hardware Queue Descriptor</td>
<td style="text-align:left">kernel queues æˆ– user queues å°†â€œæ˜ å°„â€åˆ°ä¸€ä¸ª HQD, ä¸€ä¸ª HQD å¯èƒ½å°±æ˜¯ä¸€ä¸ª MMIO åœ°å€å¯„å­˜å™¨ã€‚kernel queues å’Œ user queues æ˜ å°„çš„åŒºåˆ«æ˜¯ï¼Œ kernel queues æ€»æ˜¯<strong>é™æ€åœ°</strong>æ˜ å°„åˆ°<strong>ä¸€ä¸ª HQD</strong>, è€Œ user queues ç”± MES <strong>åŠ¨æ€åœ°</strong> æ˜ å°„åˆ°å‰©ä½™çš„æ‰€æœ‰å…¶å®ƒ HQDs</td>
</tr>
<tr>
<td style="text-align:left">MQD</td>
<td style="text-align:left">Memory Queue Descriptor</td>
<td style="text-align:left">å®šä¹‰ queue çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬ GPU virtual address, doorbell ç­‰ï¼Œé©±åŠ¨ä¸ºæ¯ä¸ªå®ƒåˆ›å»ºçš„ queue è®¾ç½®ä¸€ä¸ª MQDï¼Œ MQD è¢«äº¤ç»™ MES firmware å»æ˜ å°„</td>
</tr>
<tr>
<td style="text-align:left">KFD</td>
<td style="text-align:left">Kernel Fusion Driver</td>
<td style="text-align:left">AMD APU èŠ¯ç‰‡çš„å†…æ ¸é©±åŠ¨ï¼Œ ä¸»è¦ç”¨äº HSA æ¶æ„çš„èŠ¯ç‰‡</td>
</tr>
<tr>
<td style="text-align:left">KGD</td>
<td style="text-align:left">Kernel Graphics Driver</td>
<td style="text-align:left">AMD GPU èŠ¯ç‰‡çš„å†…æ ¸é©±åŠ¨ï¼Œ ä¸»è¦ç”¨äºç‹¬ç«‹æ˜¾å¡å’Œ OEM ä¸Šçš„ GPU èŠ¯ç‰‡</td>
</tr>
<tr>
<td style="text-align:left">RAS</td>
<td style="text-align:left">Reliability, Availability, Serviceability</td>
<td style="text-align:left">AMDGPU é©±åŠ¨çš„ä¸€ä¸ªåŠŸèƒ½ç‰¹æ€§ï¼Œå¸®åŠ©é”™è¯¯æ£€æµ‹ä¸ŠæŠ¥ï¼Œé”™è¯¯å¤„ç†å’Œè°ƒè¯•</td>
</tr>
</tbody>
</table>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://docs.kernel.org/gpu/amdgpu/driver-core.html">Kernel Doc</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>DRM/KMS</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello, Arch Linux</title>
    <url>/lnx/arch/</url>
    <content><![CDATA[<p><img src="/images/arch/gdm-screenshot.png" alt="" /></p>
<span id="more"></span>
<h1 id="å®‰è£…-arch-linux"><a class="markdownIt-Anchor" href="#å®‰è£…-arch-linux"></a> å®‰è£… Arch Linux</h1>
<p>å®‰è£… Arch Linux å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li>CLIï¼šç³»ç»Ÿå¯ä»¥ä» console ç™»å½•</li>
<li>GUIï¼šå®‰è£…å›¾å½¢æ¡Œé¢ç¯å¢ƒï¼Œå¯ä»¥ä» login greeter ç™»å½•
<ul>
<li>è¿™é‡Œå°±ä½“ç°å‡º Arch Linux çš„ç‰¹ç‚¹ï¼Œä½ å¯ä»¥è‡ªç”±å®‰è£…å–œæ¬¢çš„æ¡Œé¢ç¯å¢ƒ: KDE Plasma, GNOME</li>
<li>æ¡Œé¢ç¯å¢ƒå®‰è£…åï¼Œè¿˜æœ‰å°±æ˜¯å„ç§å›¾å½¢åº”ç”¨ï¼ŒåŒ…æ‹¬ google-chrome, fcitx5-configtool, vscode ç­‰ç­‰ï¼Œæœ‰äº›æ²¡æœ‰åœ¨ pacman çš„æºé‡Œï¼Œéœ€è¦ä½¿ç”¨ yay (Yet Another Yogurt, Yogurt æ˜¯æ—©æœŸçš„ AUR åŠ©æ‰‹) å®‰è£…</li>
<li>pacman çš„æºå¯ä»¥è‡ªå·±é…æˆå›½å†…æºï¼Œä½† yay çš„å¥½å¤šä¸‹è½½åœ°å€éƒ½XXäº†ï¼Œæ‰€ä»¥è¿™ä¸ªé˜¶æ®µå¯èƒ½éœ€è¦æ¢¯å­ï¼Œå¦åˆ™å¾ˆéš¾è¿›è¡Œä¸‹å»</li>
</ul>
</li>
</ul>
<h2 id="cli-boot"><a class="markdownIt-Anchor" href="#cli-boot"></a> CLI boot</h2>
<h3 id="åŸºäº-uefigpt-çš„ç¡¬ç›˜åˆ†åŒº"><a class="markdownIt-Anchor" href="#åŸºäº-uefigpt-çš„ç¡¬ç›˜åˆ†åŒº"></a> åŸºäº UEFI/GPT çš„ç¡¬ç›˜åˆ†åŒº</h3>
<ul>
<li>boot åˆ†åŒº (EFI System Partition, ESP) å¿…é¡»æ˜¯ <strong>FAT32</strong> æ–‡ä»¶ç³»ç»Ÿ</li>
<li>boot åˆ†åŒºé™¤äº†æ”¾ bootloader (GRUB) çš„é…ç½®æ–‡ä»¶å¤–ï¼Œè¿˜ä¼šæ”¾ vmlinuz, initrd è¿™äº›ï¼Œæœ€å¥½å¼„åˆ° 5G ~ 10G, ä»¥å®¹çº³å¤šä¸ªå†…æ ¸ç‰ˆæœ¬çš„ elf å’Œ initrd</li>
</ul>
<h3 id="iwctl"><a class="markdownIt-Anchor" href="#iwctl"></a> iwctl</h3>
<h3 id="pacman"><a class="markdownIt-Anchor" href="#pacman"></a> pacman</h3>
<h3 id="arch-chroot"><a class="markdownIt-Anchor" href="#arch-chroot"></a> arch-chroot</h3>
<h2 id="gui-boot"><a class="markdownIt-Anchor" href="#gui-boot"></a> GUI boot</h2>
<h3 id="gnome-desktop-environment"><a class="markdownIt-Anchor" href="#gnome-desktop-environment"></a> GNOME Desktop Environment</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pacman -S gnome gnome-extra</span><br></pre></td></tr></table></figure>
<h3 id="yay"><a class="markdownIt-Anchor" href="#yay"></a> yay</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://aur.archlinux.org/yay-git.git</span><br><span class="line">pacman -S --needed base-devel</span><br><span class="line"><span class="built_in">cd</span> yay-git</span><br><span class="line">makepkg -si</span><br></pre></td></tr></table></figure>
<p><code>yay</code> ä¸»è¦æ˜¯ç”¨æ¥å®‰è£…é‚£äº›æ‰˜ç®¡åœ¨ <a href="https://aur.archlinux.org/packages/visual-studio-code-bin">AUR</a> (Archlinux User Repository) çš„è½¯ä»¶åŒ…çš„ï¼Œä½œä¸º <code>pacman</code> çš„è¡¥å……ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yay -S visual-studio-code-bin oh-my-zsh-git autojump</span><br></pre></td></tr></table></figure>
<h3 id="ä¸­æ–‡å­—ä½“åŠè¾“å…¥æ³•"><a class="markdownIt-Anchor" href="#ä¸­æ–‡å­—ä½“åŠè¾“å…¥æ³•"></a> ä¸­æ–‡å­—ä½“åŠè¾“å…¥æ³•</h3>
<figure class="highlight bash"><figcaption><span>å®‰è£… fcitx5</span></figcaption><table><tr><td class="code"><pre><span class="line">pacman -S noto-fonts noto-fonts-cjk fcitx5 fcitx5-gtk fcitx5-chinese-addons fcitx5-configtool</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><figcaption><span>å®‰è£… sogou</span></figcaption><table><tr><td class="code"><pre><span class="line">yay -S fcitx5-sogou</span><br></pre></td></tr></table></figure>
<p>å®‰è£…åå¯åŠ¨ fcitx5-configtoolï¼Œæ·»åŠ æœç‹—è¾“å…¥æ³•å³å¯</p>
<figure class="highlight bash"><figcaption><span>All-In-One</span></figcaption><table><tr><td class="code"><pre><span class="line">pacman -S \</span><br><span class="line">aarch64-linux-gnu-gcc \</span><br><span class="line">autojump \</span><br><span class="line">bc \</span><br><span class="line">cscope \</span><br><span class="line">dnsmasq \</span><br><span class="line">gnome \</span><br><span class="line">gnome-extra \</span><br><span class="line">fcitx5 \</span><br><span class="line">fcitx5-gtk \</span><br><span class="line">fcitx5-chinese-addons \</span><br><span class="line">fcitx5-configtool \</span><br><span class="line">fd \</span><br><span class="line">fzf \</span><br><span class="line">htop \</span><br><span class="line">net-tools \</span><br><span class="line">noto-fonts \</span><br><span class="line">noto-fonts-cjk \</span><br><span class="line">otf-firamono-nerd \</span><br><span class="line">qemu-system-aarch64 \</span><br><span class="line">rsync \</span><br><span class="line">tig \</span><br><span class="line">virt-manager</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><figcaption><span>All-in-One</span></figcaption><table><tr><td class="code"><pre><span class="line">yay -S \</span><br><span class="line">android-sdk-platform-tools \</span><br><span class="line">android-tools</span><br></pre></td></tr></table></figure>
<h1 id="ç¼–è¯‘å†…æ ¸"><a class="markdownIt-Anchor" href="#ç¼–è¯‘å†…æ ¸"></a> ç¼–è¯‘å†…æ ¸</h1>
<p>è¦åˆ¶ä½œä¸€ä¸ªå¯å¯åŠ¨çš„å†…æ ¸ï¼Œæ¶‰åŠåˆ° 3 ä¸ªæ­¥éª¤</p>
<ul>
<li>ç¼–è¯‘å†…æ ¸ï¼Œç”Ÿæˆå†…æ ¸ ELF å¯æ‰§è¡Œæ–‡ä»¶ vmlinuz (å‹ç¼©æ ¼å¼)ï¼Œå®‰è£…å†…æ ¸æ¨¡å—</li>
<li>ç”Ÿæˆåˆå§‹å†…å­˜æ–‡ä»¶ç³»ç»Ÿ initramfs</li>
<li>æ›´æ–°å¼•å¯¼åŠ è½½ç¨‹åº bootloader çš„é…ç½®ï¼Œå³ <code>/boot/grub/grub.cfg</code></li>
</ul>
<p>æ€»çš„æ¥è¯´ï¼Œåœ¨ Arch Linux ä¸Šåˆ¶ä½œä¸€ä¸ªå¯å¯åŠ¨çš„æ–°å†…æ ¸ï¼Œè®©ç³»ç»Ÿèƒ½å¤Ÿç”¨æ–°å†…æ ¸æ­£å¸¸å·¥ä½œï¼Œæ˜¯ç›¸å¯¹æ¯”è¾ƒç®€å•çš„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘æ”¾å¼ƒ openKylinï¼Œè½¬å‘ Arch Linux çš„ä¸»è¦åŸå› ï¼Œåœ¨ openKylin ä¸Šï¼Œå…‰æ˜¯æ‰¾åˆ°ç›®å‰æ­£åœ¨è¿è¡Œçš„å†…æ ¸æºç éƒ½è´¹åŠå¤©åŠ²å„¿ï¼ŒåŒ…æ‹¬å†…æ ¸æºç åº“ï¼Œæ•´ä¸ªå‘è¡Œç‰ˆçš„è½¯ä»¶åŒ…æºç ä»“åº“ï¼Œè½¯ä»¶ç‰ˆæœ¬ç®¡ç†éƒ½æœ‰ç‚¹æ··ä¹±ã€‚</p>
<h2 id="é…ç½®å†…æ ¸"><a class="markdownIt-Anchor" href="#é…ç½®å†…æ ¸"></a> é…ç½®å†…æ ¸</h2>
<h3 id="config_module_compress_all"><a class="markdownIt-Anchor" href="#config_module_compress_all"></a> CONFIG_MODULE_COMPRESS_ALL</h3>
<p>æ§åˆ¶ <code>make modules_install</code> æ—¶æ˜¯å¦å‹ç¼© <code>.ko</code> æ–‡ä»¶ï¼Œå®ƒä¾èµ– <code>CONFIG_MODULE_COMPRESS</code>ã€‚</p>
<h2 id="å†…æ ¸å¯æ‰§è¡Œæ–‡ä»¶"><a class="markdownIt-Anchor" href="#å†…æ ¸å¯æ‰§è¡Œæ–‡ä»¶"></a> å†…æ ¸å¯æ‰§è¡Œæ–‡ä»¶</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make</span><br><span class="line"><span class="built_in">sudo</span> make modules_install</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br></pre></td></tr></table></figure>
<ul>
<li>å†…æ ¸é…ç½® .config å¯ä»¥é€šè¿‡ <code>zcat /proc/config.gz &gt; .config</code> å¾—åˆ°ä¸€ä¸ªåŸºç¡€é…ç½®ï¼Œç„¶å <code>make menuconfig</code> åœ¨æ­¤åŸºç¡€ä¸Šä¿®æ”¹ä¿å­˜ã€‚</li>
<li>vmlinuz çš„å®‰è£…è„šæœ¬æœ‰ä¸€ä¸ªæœç´¢é¡ºåº <code>scripts/install.sh -&gt; (1) ~/bin/installkernel; (2) /sbin/installkernel; (3) arch/x86/boot/install.sh</code>, è€Œä¸”é»˜è®¤çš„å®‰è£…åæ€»æ˜¯ <code>vmlinuz</code>, ä¸ºäº†æ›´å¥½åœ°åŒºåˆ†å¤šä¸ª <code>vmlinuz</code>, æœ€å¥½å°† <code>kernel version</code> åŠ åˆ° <code>vmlinuz</code> åé¢ã€‚å¦‚æœä½¿ç”¨ç¬¬ä¸€æœç´¢é¡ºåºï¼Œåœ¨ <code>sudo make install</code> æ—¶ï¼Œéœ€è¦</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo --preserve-env=HOME make install</span><br></pre></td></tr></table></figure>
<h2 id="åˆ¶ä½œåˆå§‹å†…å­˜æ–‡ä»¶ç³»ç»Ÿ"><a class="markdownIt-Anchor" href="#åˆ¶ä½œåˆå§‹å†…å­˜æ–‡ä»¶ç³»ç»Ÿ"></a> åˆ¶ä½œåˆå§‹å†…å­˜æ–‡ä»¶ç³»ç»Ÿ</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> mkinitcpio --generate /boot/initramfs-6.16.1-arch1.img --kernel 6.16.1-arch1</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>--kernel</code> å‚æ•°æ¥è‡ª <code>make kernelrelease</code>, å®ƒä¹Ÿæ˜¯ <code>sudo make modules_install</code> ååœ¨ <code>/lib/modules</code> ä¸‹åˆ›å»ºçš„ç›®å½•å. åŒæ—¶æ–°å†…æ ¸å®‰è£…é‡å¯åæœ‰ <strong><code>make kernelrelease â‰¡ uname -r</code></strong>ã€‚æ‰€ä»¥æœ€å¥½æ˜¯åœ¨å†…æ ¸æºç ç›®å½•ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> mkinitcpio --generate /boot/initramfs-`make kernelrelease`.img --kernel `make kernelrelease`</span><br></pre></td></tr></table></figure>
<h2 id="æ›´æ–°-bootloader-é…ç½®"><a class="markdownIt-Anchor" href="#æ›´æ–°-bootloader-é…ç½®"></a> æ›´æ–° bootloader é…ç½®</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸€æ­¥åœ¨ä¸¤ç§æƒ…å†µä¸‹éœ€è¦æ‰§è¡Œï¼š</p>
<ul>
<li>ä¿®æ”¹äº† bootloader ç¨‹åºçš„é…ç½®ï¼Œå¦‚ä¿®æ”¹äº† <code>/etc/default/grub</code></li>
<li>å½“ <code>/boot</code> ç›®å½•æ–°å¢äº† <code>vmlinuz</code> å’Œ <code>initramfs.img</code>ï¼Œ å¦‚æœåªæ˜¯é‡æ–°ç¼–è¯‘äº†å†…æ ¸ï¼Œè€Œå®‰è£…çš„ vmlinuz å’Œ initramfs.img è¿˜æ˜¯<strong>åŸæ¥çš„åå­—</strong>, å°±æ— éœ€æ‰§è¡Œè¿™ä¸€æ­¥</li>
</ul>
<h1 id="æˆªå±-greeter"><a class="markdownIt-Anchor" href="#æˆªå±-greeter"></a> æˆªå± Greeter</h1>
<p>æˆªå±ç³»ç»Ÿç™»å½•ç•Œé¢(Login Greeter) å¹¶ä¸é‚£ä¹ˆå®¹æ˜“ï¼Œå› ä¸ºå®ƒå’Œç”¨æˆ·ç™»å½•ä¹‹åçš„ Display Manager ä¼šè¯é€šå¸¸æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ Session, å®ƒä»¬å„è‡ªç”±ä¸€ä¸ªç‹¬ç«‹çš„ Xorg è¿›ç¨‹æ¸²æŸ“(å¦‚æœå½“å‰ä¼šè¯ç±»å‹ <code>XDG_SESSION_TYPE</code> æ˜¯ <em>wayland</em>, è¿™ä¸¤ä¸ª X æœåŠ¡åˆ™å˜æˆ <code>Xwayland</code>), è€Œä¸”é€šè¿‡åœ¨ GDM ç¯å¢ƒä¸‹çš„è§‚å¯Ÿï¼Œè´Ÿè´£æ¸²æŸ“ Greeter çš„è¿›ç¨‹(Xorg æˆ– Xwayland)æ˜¯åå¤åˆ›å»ºå’Œé”€æ¯çš„ï¼Œå½“ä½ åˆ‡æ¢åˆ°ç™»å½•ç•Œé¢æ—¶ï¼Œå®ƒä»¬æ‰è¢« <code>gdm-x-session</code>(æˆ– <code>gdm-wayland-session</code>) æ‹‰èµ·(åˆ›å»º)ï¼Œä¸€æ—¦ç™»å½•åè¿›å…¥æ¡Œé¢ï¼Œè¿™ä¸ªè¿›ç¨‹åˆä¼šè¢«å¾ˆå¿«é”€æ¯ã€‚</p>
<p><img src="/images/arch/gdm-wayland-session.png" alt="" /></p>
<p>å¦‚æœä¸äº†è§£è¿™ä¸€ç‚¹ï¼Œåœ¨ä½ å°è¯•<a href="https://ao2.it/en/blog/2016/10/01/capturing-screenshot-gdm-login-screen">æˆªå± GDM login screen</a> æ—¶ï¼Œå°±ä¼šå¾ˆä¸é¡ºåˆ©ã€‚ä¸è¿‡ä¸‹é¢çš„æˆªå±æ–¹æ³•åªåœ¨ x11 ä¼šè¯ä¸‹æœ‰æ•ˆ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sleep</span> 6</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> -u gdm DISPLAY=:0 XAUTHORITY=/run/user/120/gdm/Xauthority import -display :0 -win root /tmp/gdm-screenshot.png</span><br></pre></td></tr></table></figure>
<h2 id="gnome-display-manager"><a class="markdownIt-Anchor" href="#gnome-display-manager"></a> GNOME Display Manager</h2>
<h2 id="observer-effect"><a class="markdownIt-Anchor" href="#observer-effect"></a> <a href="https://en.wikipedia.org/wiki/Observer_effect_(physics)">Observer Effect</a>-style <code>/usr/lib/gdm-x-session</code></h2>
<p><img src="/images/arch/gdm-x-session-oneshot.png" alt="" /></p>
<h1 id="é€‰-gpu"><a class="markdownIt-Anchor" href="#é€‰-gpu"></a> é€‰ GPU</h1>
<p>å½“ Linux ç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨å¤šä¸ª GPU æ—¶ï¼Œæœ‰å¤šç§æ–¹æ³•å¯ä»¥æŒ‡å®šä½¿ç”¨å“ªä¸€ä¸ªã€‚</p>
<h2 id="kernel-boot-parameter"><a class="markdownIt-Anchor" href="#kernel-boot-parameter"></a> kernel boot parameter</h2>
<p>é€šè¿‡å†…æ ¸å¯åŠ¨å‚æ•°ï¼Œå¦‚ <code>modprobe.blacklist=i915</code>ï¼Œå°†ç›¸åº” GPU çš„å†…æ ¸é©±åŠ¨å±è”½ï¼Œä½†æœ‰æ—¶å¯èƒ½æœ‰å‰¯ä½œç”¨ï¼Œä¾‹å¦‚æˆ‘çš„ Dell Vostro 5390ï¼Œå¦‚æœå°† <code>i915</code> é©±åŠ¨å±è”½æ‰ï¼ŒAudio Subsystem ä¼šå‡ºé—®é¢˜</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">00:1c.0 PCI bridge [0604]: Intel Corporation Cannon Point-LP PCI Express Root Port #5 [8086:9dbc] (rev f0)</span><br><span class="line">00:1d.0 PCI bridge [0604]: Intel Corporation Cannon Point-LP PCI Express Root Port #13 [8086:9db4] (rev f0)</span><br><span class="line">00:1f.3 Audio device [0403]: Intel Corporation Cannon Point-LP High Definition Audio Controller [8086:9dc8] (rev 30)</span><br></pre></td></tr></table></figure>
<p>ç”±äºVostro ä½¿ç”¨çš„ Audio interface å°±æ˜¯ Intel HDA, æ‰€ä»¥å½“ <code>i915</code> è¢«å±è”½åï¼Œç”±äºæŸç§åŸå› ï¼ŒIntel HDA è®¾å¤‡æ²¡æœ‰åˆå§‹åŒ–æˆåŠŸï¼Œè€Œå®ƒåˆæ²¡æœ‰è¿æ¥å…¶å®ƒç‹¬æ˜¾çš„éŸ³é¢‘æ¥å£(å¦‚ Nvidia HDA)ï¼Œå¯¼è‡´ç³»ç»Ÿçš„å£°éŸ³ä¸èƒ½æ­£å¸¸å·¥ä½œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pci 0000:00:1f.3: deferred probe pending: snd_hda_intel: couldn&#x27;t bind with audio component</span><br><span class="line">nouveau 0000:01:00.0: Enabling HDA controller</span><br></pre></td></tr></table></figure>
<p>åŸºæœ¬ä¸Šåªæœ‰å†…æ ¸å¯åŠ¨æ—¥å¿—é‡Œæœ‰ä¸‹é¢ä¸€è¡Œï¼Œintel audio æ‰èƒ½æ­£å¸¸å·¥ä½œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">snd_hda_intel 0000:00:1f.3: bound 0000:00:02.0 (ops intel_audio_component_bind_ops [i915])</span><br></pre></td></tr></table></figure>
<p>æ›´ä¿é™©çš„å¯åŠ¨å‚æ•°æ˜¯ <code>i915.modeset=0</code>ï¼Œå³ä¸ç¦ç”¨æ•´ä¸ª i915 é©±åŠ¨ï¼Œåªç¦ç”¨ graphics åŠŸèƒ½ã€‚ä½† <a href="https://bbs.archlinux.org/viewtopic.php?id=292453">snd_hda_intel å’Œ i915 å¥½åƒæœ‰äº›è€¦åˆé—®é¢˜</a>ï¼Œå¿…é¡»å†ä½¿ç”¨ <code>snd_hda_core.gpu_bind=0</code> æ‰èƒ½åªç¦ç”¨ Intel graphics, ä¸å½±å“ Intel audio</p>
<h1 id="æ›´æ¢-boot-partition"><a class="markdownIt-Anchor" href="#æ›´æ¢-boot-partition"></a> æ›´æ¢ boot partition</h1>
<p>éœ€è¦ä½¿ç”¨ USB å¯åŠ¨ç›˜å’Œ <strong>parted</strong> å‘½ä»¤ï¼Œ <strong>parted</strong> çš„åªèƒ½æ”¹å˜åŸæœ‰åˆ†åŒºçš„ end (åˆ†åŒºçš„ start,end), å¦‚æœä½ çš„å½“å‰åˆ†åŒºæ˜¯è¿™æ ·çš„</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Number  Start   End     Size    File system  Name  Flags</span><br><span class="line"> 1      17.4kB  1074MB  1074MB  fat32              boot, esp</span><br><span class="line"> 2      1074MB  1000GB  999GB   ext4</span><br></pre></td></tr></table></figure>
<p>æ˜¯æ— æ³•ç›´æ¥æ‰©å¤§ boot åˆ†åŒºçš„ï¼Œå¯è¡Œçš„æ–¹æ¡ˆæ˜¯å…ˆç¼©å° root åˆ†åŒºï¼Œç„¶åç”¨é‡Šæ”¾çš„ç©ºé—´é‡æ–°åˆ›å»º boot çš„åˆ†åŒºï¼Œå†å°†åŸ boot åˆ†åŒºçš„å†…å®¹æ•´ä¸ª copy åˆ°æ–°çš„ boot åˆ†åŒº</p>
<ol>
<li><code>resize2fs /dev/nvme0n1p2 990G</code></li>
<li><code>(parted) resizepart 2 991GiB</code></li>
<li><code>resizepart /dev/nvme0n1 2 1931503615 (in 512-bytes sectors)</code></li>
<li><code>(parted) mkpart &quot;EFI system partition&quot; ext4 991GiB 100%</code></li>
</ol>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/596227524">Arch Linux è¯¦ç»†å®‰è£…æ•™ç¨‹</a></li>
<li><a href="https://aur.archlinux.org/">Arch Linux User Repository</a></li>
<li><a href="https://help.gnome.org/admin/gdm/stable/">GNOME Display Manager Reference Manual</a></li>
<li><a href="https://ao2.it/en/blog/2016/10/01/capturing-screenshot-gdm-login-screen">Capturing a screenshot of GDM login screen</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>distro</tag>
      </tags>
  </entry>
  <entry>
    <title>Cache ä¸€è‡´æ€§</title>
    <url>/lnx/cache/</url>
    <content><![CDATA[<h1 id="cache"><a class="markdownIt-Anchor" href="#cache"></a> Cache</h1>
<p>éŸ³åŒ cash, ä¸ç®¡æ˜¯åœ¨ç¡¬ä»¶è¿˜æ˜¯è½¯ä»¶éƒ½æ˜¯å½±å“æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å› ç´ ä¹‹ä¸€ã€‚Cache æ— è®ºæ˜¯ CPU cache è¿˜æ˜¯ GPU cache ä¸€èˆ¬éƒ½åˆ†çº§ï¼Œ L1ï¼ŒL2, åœ¨ Multi-processor CPU/GPU æ¶æ„ä¸­ï¼Œ L1 ä¸€èˆ¬æ˜¯åˆ†å¼€çš„ï¼Œæ¯ä¸ª Processor æœ‰ä¸€ä¸ªè‡ªå·±çš„ L1 Cache, è€Œ L2 Cache æ˜¯å…¨å±€çš„ï¼Œæ‰€æœ‰ processors å…±äº«çš„ã€‚</p>
<span id="more"></span>
<p>ä¸ç®¡ Cache æœ‰å¤šå°‘çº§ï¼Œåæ­£æ˜¯ä¸ºäº†é™ä½ processor è®¿é—® memory çš„æ—¶å»¶çš„ã€‚ä½†æ˜¯å¦ä¸€æ–¹é¢ï¼Œå½“æ•°æ®ç¼“å­˜åˆ° Cache ä¸­åï¼Œå°±å¿…ç„¶å¼•å‡ºä¸€è‡´æ€§é—®é¢˜ï¼Œè¿™é‡Œçš„ä¸€è‡´æ€§åº”è¯¥æœ‰ä¸¤ä¸ªæ–¹é¢</p>
<ul>
<li>å„ä¸ª processor çœ‹åˆ°çš„ cache é‡Œçš„å†…å®¹ä¸€è‡´</li>
<li>cache ä¸ memory é‡Œçš„å†…å®¹ä¸€è‡´</li>
</ul>
<p>æ³¨ï¼šâ€œå†…å®¹ä¸€è‡´â€çš„å¦ä¸€ç§è¯´æ³•æ˜¯â€œæ•°æ®æ˜¯ä¸æ˜¯æœ€æ–°çš„â€ï¼Œ</p>
<h1 id="wc-vs-gre"><a class="markdownIt-Anchor" href="#wc-vs-gre"></a> WC vs GRE</h1>
<p>Write-Combining æ˜¯ X86-64 å¹³å°ä¸Šä¸€ç§ç‰¹æ®Šçš„å†…å­˜ç±»å‹ (Memory Type), å®ƒè¢«å¹¿æ³›åº”ç”¨åœ¨ X86-64 å¹³å°çš„ I/O å’Œå…¶å®ƒå„ç§å¤–è®¾çš„äº¤äº’ä¸­ã€‚å®ƒçš„ä¸»è¦å«ä¹‰æ˜¯<strong>å°†å¤šä¸ª stores (å†™å†…å­˜) æ”¶é›†åˆ° burst transactionsä¸­</strong>ï¼Œæ‰€ä»¥å®ƒä¸»è¦æ˜¯ä¸ºäº†ä¼˜åŒ– CPU è®¿å­˜(å†™)çš„æ•ˆç‡ã€‚</p>
<p>åŒæ ·çš„æƒ³æ³•å’ŒæŠ€æœ¯åœ¨ä¸åŒçš„å¹³å°ä¸‹ï¼Œåªæ˜¯å«æ³•ä¸åŒã€‚Arm å¹³å°è‡ªç„¶ä¹Ÿæœ‰ç±»ä¼¼çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œå³ GRE (Gathering, Reordering, Early write acknowledgement), Arm æ¶æ„å®šä¹‰äº†ä¸¤ç§<strong>ä¸ä½¿ç”¨ Cache (Non-Cacheable</strong>) çš„å†…å­˜ç±»å‹</p>
<ul>
<li>Normal Non-Cacheable (Normal NC)</li>
<li>Device memory with GRE attributes (Device-GRE)</li>
</ul>
<p>è¿™ä¸¤ç§å†…å­˜ç±»å‹çš„å…±åŒç‚¹æ˜¯ï¼š</p>
<ul>
<li>ä¸ä½¿ç”¨ Cache</li>
<li>æ”¯æŒ GRE (ç›¸å½“äºæ”¯æŒ Write-Combining)</li>
</ul>
<p>ä¸‹è¡¨å°† X86-64, Arm Normal NC, Arm Device-GRE åšäº†ä¸€ä¸ªå¯¹æ¯”</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">X86-64</th>
<th style="text-align:left">Arm Normal NC</th>
<th style="text-align:left">Arm Device-GRE</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Relaxed Order</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">Yes</td>
</tr>
<tr>
<td style="text-align:left">Gathering</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">Yes</td>
</tr>
<tr>
<td style="text-align:left">Read Speculation</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td style="text-align:left">Unaligned Access</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td style="text-align:left">Gathering Size</td>
<td style="text-align:left">64 Bytes</td>
<td style="text-align:left">micro-arch</td>
<td style="text-align:left">micro-arch</td>
</tr>
</tbody>
</table>
<p>æ³¨ï¼šmicro-arch çš„æ„æ€æ˜¯å…·ä½“å¤§å°å–å†³äºå…·ä½“å¾®æ¶æ„è®¾è®¡</p>
<p>ä»ä¸Šè¡¨å¯ä»¥çœ‹å‡ºï¼ŒArm çš„ Normal NC ç­‰åŒäº X86-64 çš„ WC, è€Œ Arm ä¸Šçš„ä¸¤ç§é cache çš„å†…å­˜çš„ä¸»è¦åŒºåˆ«åœ¨è¯»é¢„æµ‹å’Œéå¯¹é½è®¿é—®ï¼Œå®é™…ä¸Šï¼Œä¸ªäººç†è§£ Arm Device-GRE ä¹‹æ‰€ä»¥ä¼šå­˜åœ¨åªæ˜¯å› ä¸º&quot;è¯»é¢„æµ‹&quot; å’Œ â€œéå¯¹é½è®¿é—®â€ è¿™ä¸¤ç§ç‰¹æ€§åœ¨ Arm æ¶æ„ä¸‹æœ¬æ¥å°±<strong>ä¸å¸¸ç”¨</strong>, å•å°±ä¼˜åŒ– CPU å†™å†…å­˜æ¥è¯´ï¼Œå®ƒä¿©å¹¶ä¸æ˜¯ä»€ä¹ˆå½±å“å› ç´ ã€‚</p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>Hardware</tag>
      </tags>
  </entry>
  <entry>
    <title>Boot-up Graphics in Linux</title>
    <url>/lnx/default-vga/</url>
    <content><![CDATA[<p>Boot-up Graphics æŒ‡åœ¨ Linux ç³»ç»Ÿå¯åŠ¨æ—¶æ¶‰åŠåˆ°ä¸€äº›å’Œå›¾å½¢æ˜¾ç¤ºç›¸å…³çš„é—®é¢˜ã€‚</p>
<span id="more"></span>
<p>å½“ä¸»æ¿ä¸ŠåŒæ—¶æœ‰å¤šå¼ PCIæ˜¾å¡æ—¶, å“ªä¸€ä¸ªä¼šåšä¸º<strong>é»˜è®¤</strong>æ˜¾ç¤ºè¾“å‡ºå‘¢ï¼Ÿ</p>
<p>ä¸€ä¸ªæœ€ç®€å•çš„åœºæ™¯ï¼Œä¸»æ¿ä¸Šæœ‰ä¸€ä¸ª Intel çš„é›†æ˜¾ï¼Œè¿˜æœ‰ä¸€ä¸ª AMD çš„ç‹¬æ˜¾ï¼Œè¿™ä¸¤ä¸ª GPU å„è‡ªé€šè¿‡ HDMI æ¥å£è¿æ¥åˆ°åŒä¸€ä¸ªæ˜¾ç¤ºå™¨ä¸Šï¼Œé‚£ä¹ˆåœ¨Linux ç³»ç»Ÿå¯åŠ¨æ—¶ï¼ˆæœªè¿›å…¥æ¡Œé¢ç¯å¢ƒï¼‰ï¼Œæ˜¯å“ªä¸ª GPU åœ¨æ˜¾ç¤ºå‘¢ï¼Ÿ</p>
<h1 id="linux-vgaarbiter"><a class="markdownIt-Anchor" href="#linux-vgaarbiter"></a> <a href="https://www.kernel.org/doc/html/v4.10/gpu/vgaarbiter.html">Linux VGAArbiter</a></h1>
<p>Linux kernel vgaarbiter çš„åˆ›å»º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">commit deb2d2ecd43dfc51efe71eed7128fda514da96c6</span><br><span class="line">Author: Benjamin Herrenschmidt &lt;benh@kernel.crashing.org&gt;</span><br><span class="line">Date:   Tue Aug 11 15:52:06 2009 +1000</span><br><span class="line"></span><br><span class="line">    PCI/GPU: implement VGA arbitration on Linux</span><br><span class="line"></span><br><span class="line">    Background:</span><br><span class="line">    Graphic devices are accessed through ranges in I/O or memory space. While most</span><br><span class="line">    modern devices allow relocation of such ranges, some &quot;Legacy&quot; VGA devices</span><br><span class="line">    implemented on PCI will typically have the same &quot;hard-decoded&quot; addresses as</span><br><span class="line">    they did on ISA. For more details see &quot;PCI Bus Binding to IEEE Std 1275-1994</span><br><span class="line">    Standard for Boot (Initialization Configuration) Firmware Revision 2.1&quot;</span><br><span class="line">    Section 7, Legacy Devices.</span><br><span class="line"></span><br><span class="line">    The Resource Access Control (RAC) module inside the X server currently does</span><br><span class="line">    the task of arbitration when more than one legacy device co-exists on the same</span><br><span class="line">    machine. But the problem happens when these devices are trying to be accessed</span><br><span class="line">    by different userspace clients (e.g. two server in parallel). Their address</span><br><span class="line">    assignments conflict. Therefore an arbitration scheme _outside_ of the X</span><br><span class="line">    server is needed to control the sharing of these resources. This document</span><br><span class="line">    introduces the operation of the VGA arbiter implemented for Linux kernel.</span><br><span class="line"></span><br><span class="line">    Signed-off-by: Benjamin Herrenschmidt &lt;benh@kernel.crashing.org&gt;</span><br><span class="line">    Signed-off-by: Tiago Vignatti &lt;tiago.vignatti@nokia.com&gt;</span><br><span class="line">    Signed-off-by: Dave Airlie &lt;airlied@redhat.com&gt;</span><br><span class="line">    Signed-off-by: Jesse Barnes &lt;jbarnes@virtuousgeek.org&gt;</span><br><span class="line"></span><br><span class="line"> drivers/gpu/Makefile     |    2 +-</span><br><span class="line"> drivers/gpu/vga/Kconfig  |   10 +</span><br><span class="line"> drivers/gpu/vga/Makefile |    1 +</span><br><span class="line"> drivers/gpu/vga/vgaarb.c | 1206 ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line"> drivers/pci/pci.c        |   44 ++++</span><br><span class="line"> drivers/video/Kconfig    |    2 +</span><br><span class="line"> include/linux/pci.h      |    2 +</span><br><span class="line"> include/linux/vgaarb.h   |  195 +++++++++++++++++</span><br><span class="line"> 8 files changed, 1461 insertions(+), 1 deletion(-)</span><br></pre></td></tr></table></figure>
<h1 id="x-serverçš„è¾“å‡ºè®¾å¤‡æ£€æµ‹å’Œé©±åŠ¨åŠ è½½"><a class="markdownIt-Anchor" href="#x-serverçš„è¾“å‡ºè®¾å¤‡æ£€æµ‹å’Œé©±åŠ¨åŠ è½½"></a> X Serverçš„è¾“å‡ºè®¾å¤‡æ£€æµ‹å’Œé©±åŠ¨åŠ è½½</h1>
<h2 id="a-namexf86_platform_deviceaxorgæŠ½è±¡çš„è¾“å‡ºè®¾å¤‡"><a class="markdownIt-Anchor" href="#a-namexf86_platform_deviceaxorgæŠ½è±¡çš„è¾“å‡ºè®¾å¤‡"></a> <a name="xf86_platform_device"></a>XorgæŠ½è±¡çš„è¾“å‡ºè®¾å¤‡</h2>
<p>Linuxä¸‹çš„æ˜¾ç¤ºè¾“å‡ºè®¾å¤‡ä¸€èˆ¬è¦ä¹ˆæ˜¯ä¸€ä¸ª<code>pci_device</code>ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ª<code>xf86_platform_device</code><br />
Xorgå®šä¹‰äº†ä¸€ä¸ªå…¨å±€æ•°ç»„<code>xf86_platform_devices</code>, è¿™ä¸ªæ•°ç»„çš„å…ƒç´ ç±»å‹æ˜¯<code>xf86_platform_device</code>, å­˜å‚¨æ˜¯åŠ¨æ€ç”³è¯·çš„ï¼ŒXorgæ¢æµ‹åˆ°ä¸€ä¸ªPCIæ˜¾å¡æ—¶ï¼Œå°±ç”³è¯·ä¸€ä¸ªå­˜å‚¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">struct xf86_platform_device *xf86_platform_devices;</span><br><span class="line"></span><br><span class="line">struct xf86_platform_device &#123;</span><br><span class="line">		struct OdevAttributes *attribs;</span><br><span class="line">		struct pci_device *pdev;</span><br><span class="line">		int flags;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct OdevAttributes &#123;</span><br><span class="line">		char *path;</span><br><span class="line">		char *syspath;</span><br><span class="line">		char *busid;</span><br><span class="line">		int fd;</span><br><span class="line">		int major;</span><br><span class="line">		int minor;</span><br><span class="line">		char *driver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>OdevAttributes</code>å®šä¹‰äº†ä¸€ä¸ªPCIè¾“å‡ºè®¾å¤‡çš„å±æ€§ã€‚</p>
<ul>
<li>
<p>path</p>
<p>kernel device node, <code>/dev/dri/card0</code></p>
</li>
<li>
<p>syspath</p>
<p>system device path, <code>/sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/drm/card1</code></p>
</li>
<li>
<p>busid</p>
<p>DRI é£æ ¼çš„Bus IDï¼Œ å¦‚ â€œpci:0000:04:00.0â€</p>
</li>
<li>
<p>fd</p>
<p>æ–‡ä»¶æè¿°ç¬¦ï¼Œ<code>open(/dev/dri/card0)</code>è¿”å›å€¼</p>
</li>
<li>
<p>major</p>
<p>ä¸»è®¾å¤‡å·</p>
</li>
<li>
<p>minor</p>
<p>æ¬¡è®¾å¤‡å·</p>
</li>
<li>
<p>driver</p>
<p>kernel driver name, å¦‚ â€œamdgpuâ€</p>
</li>
</ul>
<h1 id="pci-busid"><a class="markdownIt-Anchor" href="#pci-busid"></a> PCI BusID</h1>
<h2 id="dri-style"><a class="markdownIt-Anchor" href="#dri-style"></a> DRI-style</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pci:0000:04:00.0</span><br></pre></td></tr></table></figure>
<ul>
<li><code>0000</code> PCI domain</li>
<li><code>  04</code> PCI bus</li>
<li><code>  00</code> PCI device</li>
<li><code>   0</code> PCI function</li>
</ul>
<h2 id="xorg-æ—¥å¿—"><a class="markdownIt-Anchor" href="#xorg-æ—¥å¿—"></a> Xorg æ—¥å¿—</h2>
<ul>
<li>æ¥è‡ª xorg-server-1.18.4 ç‰ˆæœ¬çš„ Xorg æ—¥å¿—</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[     8.456] (--) PCI: (0:5:0:0) 1002:677b:174b:3000 rev 0, Mem @ 0x1040000000/268435456, 0x58600000/131072, I/O @ 0x00002000/256, BIOS @ 0x????????/131072</span><br></pre></td></tr></table></figure>
<ul>
<li>æ¥è‡ª xorg-server-1.20.0 ç‰ˆæœ¬çš„ Xorg æ—¥å¿—</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[    40.891] (--) PCI: (10@0:0:0) 1a03:2000:1a03:2000 rev 65, Mem @ 0x60000000/16777216, 0x61000000/131072, I/O @ 0x00002000/128, BIOS @ 0x????????/65536</span><br></pre></td></tr></table></figure>
<p>å˜æ›´å‘ç”Ÿäº 2017-06-19:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">commit e905b19a53f96013c4417bec993a1dea5a3b0a5f</span><br><span class="line">Author: Michel DÃ¤nzer &lt;michel.daenzer@amd.com&gt;</span><br><span class="line">Date:   Mon Jun 19 19:05:29 2017 +0900</span><br><span class="line"></span><br><span class="line">    xfree86: Print BusID stanza compatible bus IDs for found devices</span><br><span class="line"></span><br><span class="line">    The PCI domain has to be specified like this:</span><br><span class="line"></span><br><span class="line">     &quot;PCI:&lt;bus&gt;@&lt;domain&gt;:&lt;device&gt;:&lt;function&gt;&quot;</span><br><span class="line"></span><br><span class="line">    Example before:</span><br><span class="line"></span><br><span class="line">     (--) PCI:*(0:0:1:0) 1002:130f:1043:85cb [...]</span><br><span class="line">     (--) PCI: (0:1:0:0) 1002:6939:1458:229d [...]</span><br><span class="line"></span><br><span class="line">    after:</span><br><span class="line"></span><br><span class="line">     (--) PCI:*(0@0:1:0) 1002:130f:1043:85cb [...]</span><br><span class="line">     (--) PCI: (1@0:0:0) 1002:6939:1458:229d [...]</span><br><span class="line"></span><br><span class="line">    Reviewed-by: Alex Deucher &lt;alexander.deucher@amd.com&gt;</span><br><span class="line">    Signed-off-by: Michel DÃ¤nzer &lt;michel.daenzer@amd.com&gt;</span><br></pre></td></tr></table></figure>
<h2 id="xorg-é…ç½®æ–‡ä»¶-device-section"><a class="markdownIt-Anchor" href="#xorg-é…ç½®æ–‡ä»¶-device-section"></a> Xorg é…ç½®æ–‡ä»¶ â€œDeviceâ€ Section</h2>
<p>ä¸Šé¢ä¸¤ç§æ ¼å¼éƒ½å¯ä»¥ä½œä¸º<code>Device</code>æ®µé‡Œ<code>BusID</code>çš„æ ¼å¼ï¼ŒX11è§„å®šçš„<code>BusID</code>çš„æ ¼å¼æ˜¯</p>
<p>â€œbus<font color="green">[@domain]</font>:device<font color="green">[:func]</font>â€</p>
<p>Xserverä¾èµ–ä¸‹é¢çš„ç”¨æˆ·ç©ºé—´åº“æ¥å¡«å†™è¯¥ç»“æ„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿä½“ç°äº†Xserveræ£€æµ‹æ˜¾å¡åŠåŠ è½½é©±åŠ¨çš„è¿‡ç¨‹</p>
<ul>
<li><a href="https://gitlab.freedesktop.org/xorg/lib/libpciaccess">libpciaccess</a></li>
<li><a href="https://github.com/systemd/systemd/tree/main/src/libudev">libudev</a></li>
<li><a href="https://gitlab.freedesktop.org/mesa/drm">libdrm</a></li>
</ul>
<ol>
<li>é€šè¿‡<code>libpciaccess</code>çš„æ¥å£å‘ç°ç³»ç»ŸPCIè®¾å¤‡ï¼Œè·å–<code>syspath</code>, <code>path</code></li>
<li>é€šè¿‡<code>open</code>ç³»ç»Ÿè°ƒç”¨æ‰“å¼€ä¾¦æµ‹åˆ°çš„<code>drm_device</code>ï¼Œ<code>fd</code>æœ‰äº†</li>
<li>é€šè¿‡<code>libdrm</code>æ¥å£è·å–<code>major</code>, <code>minor</code>å’Œ<code>driver</code></li>
</ol>
<h2 id="å¦‚ä½•å¿«é€Ÿç¡®å®š-pci-busid-ä¸-dev-è®¾å¤‡èŠ‚ç‚¹çš„å¯¹åº”å…³ç³»"><a class="markdownIt-Anchor" href="#å¦‚ä½•å¿«é€Ÿç¡®å®š-pci-busid-ä¸-dev-è®¾å¤‡èŠ‚ç‚¹çš„å¯¹åº”å…³ç³»"></a> å¦‚ä½•å¿«é€Ÿç¡®å®š PCI BusID ä¸ <code>/dev</code> è®¾å¤‡èŠ‚ç‚¹çš„å¯¹åº”å…³ç³»</h2>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ls -l /dev/dri/by-path</span><br></pre></td></tr></table></figure>
<h1 id="device-detect-routines"><a class="markdownIt-Anchor" href="#device-detect-routines"></a> Device Detect Routines</h1>
<p>Xserveræä¾›äº†ä¸¤ç§è®¾å¤‡æ£€æµ‹æ–¹æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void xf86PlatformDeviceProbe(struct OdevAttributes *attribs);</span><br><span class="line">void xf86PciProbe(void);</span><br></pre></td></tr></table></figure>
<p>é»˜è®¤æ˜¯ä½¿ç”¨<code>xf86PlatformDeviceProbe</code>ï¼Œ å½“è¿™ä¸ªå‡½æ•°å®Œæˆ<code>xf86_add_platform_device</code>åï¼Œé™¤äº†<code>attribs</code>, <code>xf86_platform_device</code>çš„å…¶å®ƒæˆå‘˜è¿˜æ²¡æœ‰è¢«å¡«å†™ï¼Œå‰©ä¸‹çš„ä»»åŠ¡äº¤ç”±<code>libudev</code>, <code>libpciaccess</code>å’Œ<code>libdrm</code>çš„æ¥å£å®Œæˆã€‚</p>
<h2 id="libudev"><a class="markdownIt-Anchor" href="#libudev"></a> libudev</h2>
<ul>
<li>udev_enumerate_add_match_subsys</li>
<li>udev_enumerate_add_match_sysname</li>
</ul>
<h2 id="libpciaccess"><a class="markdownIt-Anchor" href="#libpciaccess"></a> libpciaccess</h2>
<ul>
<li>pci_device_probe</li>
<li>pci_device_is_boot_vga</li>
</ul>
<h2 id="libdrm"><a class="markdownIt-Anchor" href="#libdrm"></a> libdrm</h2>
<ul>
<li>drmSetInterfaceVersion</li>
<li>drmGetBusid</li>
<li>drmGetVersion</li>
</ul>
<h1 id="primary-bus"><a class="markdownIt-Anchor" href="#primary-bus"></a> Primary Bus</h1>
<p>åœ¨å¤šå¡çš„æƒ…å†µä¸‹ï¼ŒXserverå¯åŠ¨åé»˜è®¤ä½¿ç”¨å“ªä¸ªæ˜¾å¡æ˜¾ç¤ºï¼Ÿ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">typedef struct _bus &#123;</span><br><span class="line">	BusType type;</span><br><span class="line">	union &#123;</span><br><span class="line">		struct pci_device *pci;</span><br><span class="line">		SbusBusId sbus;</span><br><span class="line">		struct xf86_platform_device *plat;</span><br><span class="line">	&#125; id;</span><br><span class="line">&#125; BusRec, *BusPtr;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Xserverå®šä¹‰äº†ä¸€ä¸ªå…¨å±€çš„<code>BusRec</code>ç±»å‹å˜é‡<code>primaryBus</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BusRec primaryBus = &#123; BUS_NONE, &#123;0&#125; &#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ª<code>primaryBus</code>å°†æ˜¯Xserverå¯åŠ¨åé»˜è®¤ä½¿ç”¨çš„æ˜¾å¡è®¾å¤‡çš„å”¯ä¸€å€™é€‰è€…ã€‚</p>
<h1 id="who-is-the-lucky-boy"><a class="markdownIt-Anchor" href="#who-is-the-lucky-boy"></a> Who Is The Lucky Boy?</h1>
<p>Xserveræœ‰ä¸¤ä¸ªè§„åˆ™å»ç¡®å®š<a href="#primary-bus">primaryBus</a>:</p>
<ul>
<li><a href="#libudev">config_udev_odev_probe</a></li>
<li><a href="#libpciaccess">pci_device_is_boot_vga</a></li>
</ul>
<h2 id="how-config_udev_odev_probe-works"><a class="markdownIt-Anchor" href="#how-config_udev_odev_probe-works"></a> How <code>config_udev_odev_probe</code> Works?</h2>
<p><code>config_udev_odev_probe</code>å”¯ä¸€çš„å‚æ•°æ˜¯ä¸€ä¸ªcallbackå‡½æ•°<code>xf86PlatformDeviceProbe</code>, <code>config_udev_odev_probe</code>è¦åšçš„å°±æ˜¯è°ƒç”¨<a href="#libudev">libudev</a>çš„æ¥å£æšä¸¾å‡º<code>/dev</code>æ–‡ä»¶ç³»ç»Ÿé‡Œæ³¨å†Œçš„<code>drm</code>è®¾å¤‡ï¼Œå°†å®ƒçš„<code>path</code>å¡«åˆ°<a href="#xf86_platform_device">xf86_platform_device.attribs-&gt;path</a>ã€‚æ‰€ä»¥è¿™ä¸€æ­¥å†³å®šäº†<a href="#xf86_platform_devices">xf86_platform_devices</a>æ•°ç»„ä¸­platform deviceçš„é¡ºåºï¼ŒæŒ‰ç…§æ­¤é¡ºåºæœ€åé‚£ä¸ª<code>pci_device_is_boot_vga</code>è¿”å›<code>True</code>çš„æ˜¾ç¤ºè®¾å¤‡å°†ä¸º<code>primaryBus</code>, ä½†è¿™æ˜¯åœ¨æ²¡æœ‰é…ç½®<code>PrimaryGPU</code>é€‰é¡¹æ—¶çš„è¡Œä¸ºã€‚ä¸‹é¢çš„ä»£ç æ¥è‡ª<code>libudev</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_public_ int sd_device_enumerator_add_match_sysname(sd_device_enumerator *enumerator, const char *sysname) &#123;</span><br><span class="line">        int r;</span><br><span class="line"></span><br><span class="line">        assert_return(enumerator, -EINVAL);</span><br><span class="line">        assert_return(sysname, -EINVAL);</span><br><span class="line"></span><br><span class="line">        r = set_put_strdup(&amp;enumerator-&gt;match_sysname, sysname);</span><br><span class="line">        if (r &lt;= 0)</span><br><span class="line">                return r;</span><br><span class="line"></span><br><span class="line">        enumerator-&gt;scan_uptodate = false;</span><br><span class="line"></span><br><span class="line">        return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå‚æ•°<code>sysname</code>æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼<code>card[0-9]*</code></p>
<h2 id="how-pci_device_is_boot_vga-works"><a class="markdownIt-Anchor" href="#how-pci_device_is_boot_vga-works"></a> How <code>pci_device_is_boot_vga</code> Works?</h2>
<p><code>pci_device_is_boot_vga</code>æ˜¯ä¸€ä¸ªè™šæ¥å£ï¼Œåœ¨Linuxä¸‹çš„å®ç°æ˜¯<code>pci_device_linux_sysfs_boot_vga</code>, ä¸‹é¢çš„ä»£ç æ¥è‡ª<code>libpciaccess</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">static int pci_device_linux_sysfs_boot_vga(struct pci_device *dev)</span><br><span class="line">&#123;</span><br><span class="line">    char name[256];</span><br><span class="line">    char reply[3];</span><br><span class="line">    int fd, bytes_read;</span><br><span class="line">    int ret = 0;</span><br><span class="line"></span><br><span class="line">    snprintf( name, 255, &quot;%s/%04x:%02x:%02x.%1u/boot_vga&quot;,</span><br><span class="line">	      SYS_BUS_PCI,</span><br><span class="line">	      dev-&gt;domain,</span><br><span class="line">	      dev-&gt;bus,</span><br><span class="line">	      dev-&gt;dev,</span><br><span class="line">	      dev-&gt;func );</span><br><span class="line"></span><br><span class="line">    fd = open( name, O_RDONLY | O_CLOEXEC);</span><br><span class="line">    if (fd == -1)</span><br><span class="line">       return 0;</span><br><span class="line"></span><br><span class="line">    bytes_read = read(fd, reply, 1);</span><br><span class="line">    if (bytes_read != 1)</span><br><span class="line">	goto out;</span><br><span class="line">    if (reply[0] == &#x27;1&#x27;)</span><br><span class="line">	ret = 1;</span><br><span class="line">out:</span><br><span class="line">    close(fd);</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ<code>SYS_BUS_PCI</code>è¢«å®šä¹‰ä¸º<code>/sys/bus/pci/devices</code>, <code>pci_device_is_boot_vga</code>çš„è¿”å›å€¼å–å†³äºæ˜¾ç¤ºè®¾å¤‡çš„<strong>kernel driver</strong>å¦‚ä½•å®ç°<code>sysfs</code>æ–‡ä»¶ç³»ç»Ÿä¸­çš„<code>/sys/bus/pci/devices/0000:05:00.0/boot_vga</code>èŠ‚ç‚¹ã€‚</p>
<p>ä»¥ä¸Šä¸¤ç‚¹è§„åˆ™è¯´æ˜ï¼Œåœ¨å¤šå¡ç³»ç»Ÿä¸­ï¼Œä¸ä½¿ç”¨<code>PrimaryGPU</code>çš„æƒ…å†µä¸‹ï¼Œå½“ä¸”ä»…å½“ç›®æ ‡å¡çš„<code>drm</code>è®¾å¤‡èŠ‚ç‚¹å·æœ€å¤§ï¼Œè€Œä¸”<code>/sys/bus/pci/devices/XXXX:XX:XX.X/boot_vga</code>è¢«å®ç°ä¸ºreadå®ƒè¿”å›ASCIIå­—ç¬¦<code>'1'</code>. è¿™æ ·ç›®æ ‡å¡æ‰èƒ½åšä¸º<code>primaryBus</code>è®¾å¤‡é»˜è®¤æ˜¾ç¤ºè¾“å‡ºã€‚</p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://patchwork.freedesktop.org/patch/539963/?series=118518&amp;rev=1">pci/vgaarb: make vga_is_firmware_default() arch independent</a></li>
<li><a href="https://lore.kernel.org/dri-devel/20230906132904.4e49e269.alex.williamson@redhat.com/T/#t">discussion on ML</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>X11</tag>
      </tags>
  </entry>
  <entry>
    <title>Display Pipeline in Linux</title>
    <url>/lnx/display-pipeline/</url>
    <content><![CDATA[<p>åœ¨ Linux GPU è½¯ä»¶æ ˆè¿™å—ï¼Œå¤§ä½“åŒ…å« 3 ä¸ª Pipelines</p>
<ul>
<li>Graphics Pipeline</li>
<li>Display Pipeline</li>
<li>Compute Pipeline</li>
</ul>
<span id="more"></span>
<p>Graphics Pipeline å’Œ Compute Pipeline åŸºæœ¬ä¸Šéƒ½æ˜¯å›´ç»• GPU è¿™ä¸ª IP è¿›è¡Œçš„ï¼ŒVulkan API çš„è®¾è®¡ä¹Ÿå¯ä»¥çœ‹å‡ºè¿™ä¸€ç‚¹ã€‚ è€Œ Display Pipeline ï¼ˆè¿™é‡ŒæŒ‡æ˜¾ç¤ºï¼‰ä¸»è¦å›´ç»• DC (Display Controller) è¿™ä¸ª IP è¿›è¡Œã€‚</p>
<p>æœ¬æ–‡æ‰€æ¶‰åŠçš„çŸ¥è¯†æœ¬èº«å¹¶æ²¡æœ‰ä»€ä¹ˆæ–°çš„ä¸œè¥¿ï¼Œä½†å¯¹æˆ‘æ¥è¯´æ˜¯æ–°çš„ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« ä¹Ÿæ˜¯ä½œä¸ºä¸€ä¸ªå­¦ä¹ ç¬”è®°æ¥æ•´ç†å’Œè®°å½•è‡ªå·±å¯¹ Display Pipeline çš„ç†è§£ã€‚</p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ol>
<li><a href="https://ppaalanen.blogspot.com/2014/06/from-pre-history-to-beyond-global.html">From pre-history to beyond the global thermonuclear war</a></li>
<li><a href="https://lists.freedesktop.org/archives/dri-devel/2014-March/055222.html">RFCv2 00/10 Universal plane support</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/gpu/amdgpu/display/mpo-overview.html?highlight=mpo">Multiplane Overlay (MPO)</a></li>
</ol>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>DRM/KMS</tag>
      </tags>
  </entry>
  <entry>
    <title>Buffer Sharing and Synchronization</title>
    <url>/lnx/dma-buf/</url>
    <content><![CDATA[<h1 id="dma-buf"><a class="markdownIt-Anchor" href="#dma-buf"></a> DMA-BUF</h1>
<pre><code class="highlight mermaid">flowchart BT
	App@&#123; img: &quot;/images/dma-buf/window-content.png&quot;, label: &quot;vram for rendering&quot;, pos: &quot;d&quot;, w: 60, h: 60, constraint: &quot;on&quot; &#125;
	Window@&#123; img: &quot;/images/dma-buf/window-frame.png&quot;, label: &quot;vram for window frame&quot;, pos: &quot;d&quot;, w: 60, h: 60, constraint: &quot;on&quot; &#125;

	subgraph app [glxgears]
		BO_10
	end
	subgraph x11 [Xorg]
		BO_20
		BO_11
	end
	subgraph compositor [kwin_x11]
		BO_21
	end

	App ~~~ BO_10 --Exporter--&gt; App
	App --Importer--&gt; BO_11

	Window ~~~ BO_20 --Exporter--&gt; Window
	Window --Importer--&gt; BO_21</code></pre>
<span id="more"></span>
<p>DMA-BUF æ˜¯ Linux å†…æ ¸é©±åŠ¨ä¸­åœ¨ä¸Šä¸‹æ–‡é—´ï¼Œè¿›ç¨‹é—´ï¼Œè®¾å¤‡é—´ï¼Œå­ç³»ç»Ÿé—´å…±äº« buffer çš„ä¸€ç§æœºåˆ¶ã€‚ å¤§æ¦‚åœ¨<a href="https://lwn.net/Articles/473668/">å†…æ ¸ 3.2 ç‰ˆæœ¬å°±å®ç°äº†</a>ã€‚ æŒ‰æœ€åˆçš„è®¾è®¡æ–‡æ¡£æè¿°çš„ï¼Œè¯¥æ¡†æ¶å¤§è‡´æ˜¯è¿™æ ·çš„:</p>
<ul>
<li>å¯¼å‡ºè€…åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„ buffer object, å¹¶å°†ä¸€ä¸ª struct file(anon file) å’Œ allocator å®šä¹‰çš„ä¸€ç»„æ“ä½œ(map/unmap/cache-sync ç­‰ç­‰) (<code>struct dma_buf_ops</code>) ä¸ä¹‹å…³è”</li>
<li>ä¸åŒçš„è®¾å¤‡è°ƒç”¨ <code>dma_buf_attach()</code> å°†è‡ªå·±åŠ åˆ° buffer object çš„ attachments åˆ—è¡¨ï¼Œ å› ä¸ºä¸€ä¸ª buffer object å¯ä»¥ä¾›å¤šä¸ªè®¾å¤‡(importers)ä½¿ç”¨</li>
<li>è¿™ä¸ªå¯¼å‡ºçš„ buffer object åœ¨å„ç§å®ä½“é—´é€šè¿‡å…±äº«æ–‡ä»¶æè¿°ç¬¦ fd æ¥å…±äº«</li>
<li>æ”¶åˆ° fd çš„å¯¼å…¥è€…å°†é‡æ–°è·å–åˆ° buffer object, ä½¿ç”¨å¯¼å‡ºæ—¶å…³è”çš„ <code>dma_buf_attach_ops</code> å»è®¿é—®è¿™ä¸ª buffer</li>
<li>å¯¼å‡ºè€…å’Œå¯¼å…¥è€…ä½¿ç”¨ <code>map_dma_buf()</code> å’Œ <code>unmap_dma_buf()</code> æ¥å…±äº« buffer object çš„ scatterlist</li>
</ul>
<p><code>struct dma_buf</code> æ˜¯ä¸€ç§<strong>èƒ¶æ°´ç»“æ„</strong>ï¼Œ å®ƒå°†ä¸€ä¸ª <strong>anonymous file</strong> å’Œä¸€ä¸ª <strong>drm_gem_object</strong> ä»¥åŠå¯¼å‡ºè€…éœ€è¦å®ç°çš„ä¸€ç»„å¯¹è¿™ä¸ª buffer çš„ä¸€ç»„æ“ä½œ <strong>dma_buf_ops</strong> ç­‰ç­‰<strong>ç²˜åˆåœ¨ä¸€èµ·</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dma_buf</span> &#123;</span></span><br><span class="line">  <span class="type">size_t</span> size; <span class="comment">// buffer size,  ä¸å˜</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span> <span class="comment">// anonymous file struct</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">attachments</span>;</span> <span class="comment">// æ‰€æœ‰å¯¼å…¥è€…çš„ä¸€ä¸ªé“¾è¡¨</span></span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dma_buf_ops</span> *<span class="title">ops</span>;</span> <span class="comment">// ç”±å¯¼å‡ºè€…è´Ÿè´£å®ç°ï¼Œå¦‚ map/unmap</span></span><br><span class="line">  <span class="type">unsigned</span> vmapping_counterï¼› <span class="comment">// vmaps çš„å¼•ç”¨è®¡æ•°</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">iosys_map</span> <span class="title">vmap_ptr</span>;</span> <span class="comment">// å½“ vmapping_counter å¤§äº 0 æ—¶ï¼ŒæŒ‡å‘å½“å‰çš„ vmap</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *exp_name;  <span class="comment">// å¯¼å‡ºè€…å­—ç¬¦ä¸²ï¼Œdebugging</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *name; <span class="comment">// accounting &amp; debugging</span></span><br><span class="line">  <span class="type">spinlock_t</span> name_lockï¼› <span class="comment">// äº’æ–¥è®¿é—® name çš„é”</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span>  <span class="comment">// å¯¼å‡ºè€… module</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list_node</span>;</span> <span class="comment">// accounting &amp; debugging</span></span><br><span class="line">  <span class="type">void</span> *priv; <span class="comment">// æŒ‡å‘ drm_gem_object</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dma_resv</span> *<span class="title">resv</span>;</span></span><br><span class="line">  <span class="type">wait_queue_head_t</span> poll; <span class="comment">// å…è®¸ç”¨æˆ·ç©ºé—´ poll()</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dma_buf_poll_cb_t</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dma_fence_cb</span> <span class="title">cb</span>;</span></span><br><span class="line">	<span class="type">wait_queue_head_t</span> *poll;</span><br><span class="line"></span><br><span class="line">	<span class="type">__poll_t</span> active;</span><br><span class="line">  &#125; cb_in, cb_out;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dma_buf_sysfs_entry</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dma_buf</span> *<span class="title">dmabuf</span>;</span></span><br><span class="line">  &#125; *sysfs_entry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ glxgears(<code>PRIME_HANDLE_TO_FD</code>) å’Œ Xorg(<code>PRIME_FD_TO_HANDLE</code>) ä¹‹é—´çš„å…±äº«è¿‡ç¨‹ä¸ºä¾‹, ä¸»è¦æœ‰ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š</p>
<ul>
<li>è¦ç»™ DMA-BUF å¥—ä¸€å±‚åŒ¿åæ–‡ä»¶(Anonymous File), è¿™æ ·æ‰å¯ä»¥å®‰å…¨åœ°åœ¨è¿›ç¨‹é—´å…±äº«</li>
<li>å¯¼å…¥åï¼Œå¯¼å…¥è¿›ç¨‹æ–°å»ºçš„ GPU <strong>è™šæ‹Ÿæ˜¾å­˜åœ°å€åˆ°ç‰©ç†æ˜¾å­˜åœ°å€</strong>çš„æ˜ å°„è¦èƒ½å¤Ÿæ˜ å°„åˆ°<strong>ä¸å¯¼å‡ºä¾§ç›¸åŒçš„ GPU ç‰©ç†æ˜¾å­˜åœ°å€</strong> (GPU VA å€’æ— æ‰€è°“)</li>
</ul>
<p>å†…æ ¸åœ¨ drm_file ä¸‹æäº†ä¸€ä¸ª dmabuf å’Œ handle çš„çº¢é»‘æ ‘ä½œä¸º <strong>DMA-BUF ç¼“å­˜</strong>ï¼Œ è¿™æ ·åœ¨åŒä¸€è®¾å¤‡æ–‡ä»¶ä¸­çš„å¯¼å‡ºå¯¼å…¥æˆ–åŒä¸€ä¸ª drm_gem_object è¢«åŒä¸€ä¸ªè®¾å¤‡å¤šæ¬¡å¯¼å…¥çš„æƒ…å†µå°±ä¼šé«˜æ•ˆä¸€äº›ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct drm_prime_file_private - per-file tracking for PRIME</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This just contains the internal &amp;struct dma_buf and handle caches for each</span></span><br><span class="line"><span class="comment"> * &amp;struct drm_file used by the PRIME core code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">drm_prime_file_private</span> &#123;</span></span><br><span class="line"><span class="comment">/* private: */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">dmabufs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">handles</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ª <strong>import/export caches</strong> æœ‰å‡ ä¸ªå¿…è¦çš„ä½œç”¨ï¼š</p>
<ul>
<li>ä¿è¯å¯¹äºä»»æ„ä¸€ä¸ª drm_gem_object æ€»æ˜¯æœ‰<strong>ä¸€ä¸ªå”¯ä¸€çš„ç”¨æˆ·æ€ handle</strong> (è§ <a href="https://lucmann.github.io/gfx/piglit/">Piglit: ext_image_dma_buf_import-refcount-multithread</a>)</li>
<li>å¯ä»¥å…è®¸ UMD å»<strong>æ£€æµ‹é‡å¤çš„å¯¼å…¥</strong></li>
</ul>
<p><code>struct file</code>, <code>struct drm_file</code>, <code>struct drm_prime_file_private</code> ä¸‰è€…çš„å…³ç³»æ˜¯</p>
<pre><code class="highlight mermaid">erDiagram
	file ||--|| drm_file : contains
	file &#123;
		atomic_long_t	f_count
		spinlock_t		f_lock
		fmode_t			f_mode
		file_operations	*f_op
		address_space	*f_mapping
		void			*private_data
	&#125;
	drm_file ||--|| drm_prime_file_private : contains
	drm_file &#123;
		TYPES					others
		drm_prime_file_private	prime
	&#125;
	drm_prime_file_private &#123;
		mutex lock
		rb_root dmabufs
		rb_root handles
	&#125;</code></pre>
<h2 id="å¯¼å…¥å¯¼å‡ºçš„å®ç°"><a class="markdownIt-Anchor" href="#å¯¼å…¥å¯¼å‡ºçš„å®ç°"></a> å¯¼å…¥/å¯¼å‡ºçš„å®ç°</h2>
<pre><code class="highlight mermaid">flowchart LR
  subgraph export [&quot;Export&quot;]
    direction TB
    1a[&quot;drmPrimeHandleToFD()&quot;]
	1b[&quot;DRM_IOCTL_PRIME_HANDLE_TO_FD&quot;]
	1c[&quot;drm_prime_handle_to_fd_ioctl()&quot;]
	1d[&quot;drm_gem_prime_handle_to_fd()&quot;]
	1e[&quot;drm_gem_prime_handle_to_dmabuf()&quot;]
	1f[&quot;export_and_register_object()&quot;]
  end
  subgraph import [&quot;Import&quot;]
    direction TB
    2a[&quot;drmPrimeFDToHandle()&quot;]
	2b[&quot;DRM_IOCTL_PRIME_FD_TO_HANDLE&quot;]
	2c[&quot;drm_prime_fd_to_handle_ioctl()&quot;]
	2d[&quot;drm_gem_prime_fd_to_handle()&quot;]
	2e[&quot;drm_prime_lookup_buf_handle()&quot;]
	2f[&quot;drm_gem_prime_import()&quot;]
  end

  1a --&gt; 1b --&gt; 1c --&gt; 1d --&gt; 1e --&gt; 1f
  2a --&gt; 2b --&gt; 2c --&gt; 2d --&gt; 2e --&gt; 2f

  export --&gt; import</code></pre>
<p><code>struct file</code>ï¼Œ <code>struct dma_buf</code> çš„å…³ç³»</p>
<ul>
<li>å¯¼å‡ºè€… <code>DRM_IOCTL_PRIME_HANDLE_TO_FD</code></li>
</ul>
<p>å…ˆæ‹¿è¿™ä¸ª gem_handle å»çº¢é»‘æ ‘é‡Œæ‰¾ dma_buf (<strong><code>drm_prime_lookup_buf_by_handle()</code></strong>), å¦‚æœæœ‰å°±è¿”å›è¿™ä¸ª dma_bufï¼Œå¦‚æœæ²¡æœ‰å°±è°ƒç”¨ <code>export_and_register_object()</code> ç»™å¯¹åº”çš„ drm_gem_object æ–°ç”³è¯·ä¸€ä¸ª <code>struct dma_buf</code>ï¼Œå†ç”±å†…æ ¸æŠŠè¿™ä¸ª gem_handle å’Œ dma_buf éƒ½ç¼“å­˜åˆ°çº¢é»‘æ ‘ä¸­ (<strong><code>drm_prime_add_buf_handle()</code></strong>)ï¼Œ æœ€å <code>fd_install(fd, dmabuf-&gt;file);</code> æŠŠ fd è¿”å›ç”¨æˆ·æ€çš„å¯¼å‡ºè€…ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * dma_buf_export - Creates a new dma_buf, and associates an anon file</span></span><br><span class="line"><span class="comment"> * with this buffer, so it can be exported.</span></span><br><span class="line"><span class="comment"> * Also connect the allocator specific data and ops to the buffer.</span></span><br><span class="line"><span class="comment"> * Additionally, provide a name string for exporter; useful in debugging.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @exp_info:	[in]	holds all the export related information provided</span></span><br><span class="line"><span class="comment"> *			by the exporter. see &amp;struct dma_buf_export_info</span></span><br><span class="line"><span class="comment"> *			for further details.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns, on success, a newly created struct dma_buf object, which wraps the</span></span><br><span class="line"><span class="comment"> * supplied private data and operations for struct dma_buf_ops. On either</span></span><br><span class="line"><span class="comment"> * missing ops, or error in allocating struct dma_buf, will return negative</span></span><br><span class="line"><span class="comment"> * error.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For most cases the easiest way to create @exp_info is through the</span></span><br><span class="line"><span class="comment"> * %DEFINE_DMA_BUF_EXPORT_INFO macro.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> dma_buf *<span class="title function_">dma_buf_export</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> dma_buf_export_info *exp_info)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dma_buf</span> *<span class="title">dmabuf</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dma_resv</span> *<span class="title">resv</span> =</span> exp_info-&gt;resv;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="type">size_t</span> alloc_size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> dma_buf);</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON(!exp_info-&gt;priv || !exp_info-&gt;ops</span><br><span class="line">		    || !exp_info-&gt;ops-&gt;map_dma_buf</span><br><span class="line">		    || !exp_info-&gt;ops-&gt;unmap_dma_buf</span><br><span class="line">		    || !exp_info-&gt;ops-&gt;release))</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON(exp_info-&gt;ops-&gt;cache_sgt_mapping &amp;&amp;</span><br><span class="line">		    (exp_info-&gt;ops-&gt;pin || exp_info-&gt;ops-&gt;unpin)))</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON(!exp_info-&gt;ops-&gt;pin != !exp_info-&gt;ops-&gt;unpin))</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!try_module_get(exp_info-&gt;owner))</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOENT);</span><br><span class="line"></span><br><span class="line">	file = dma_buf_getfile(exp_info-&gt;size, exp_info-&gt;flags);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(file)) &#123;</span><br><span class="line">		ret = PTR_ERR(file);</span><br><span class="line">		<span class="keyword">goto</span> err_module;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!exp_info-&gt;resv)</span><br><span class="line">		alloc_size += <span class="keyword">sizeof</span>(<span class="keyword">struct</span> dma_resv);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="comment">/* prevent &amp;dma_buf[1] == dma_buf-&gt;resv */</span></span><br><span class="line">		alloc_size += <span class="number">1</span>;</span><br><span class="line">	dmabuf = kzalloc(alloc_size, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!dmabuf) &#123;</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> err_file;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dmabuf-&gt;priv = exp_info-&gt;priv;</span><br><span class="line">	dmabuf-&gt;ops = exp_info-&gt;ops;</span><br><span class="line">	dmabuf-&gt;size = exp_info-&gt;size;</span><br><span class="line">	dmabuf-&gt;exp_name = exp_info-&gt;exp_name;</span><br><span class="line">	dmabuf-&gt;owner = exp_info-&gt;owner;</span><br><span class="line">	spin_lock_init(&amp;dmabuf-&gt;name_lock);</span><br><span class="line">	init_waitqueue_head(&amp;dmabuf-&gt;poll);</span><br><span class="line">	dmabuf-&gt;cb_in.poll = dmabuf-&gt;cb_out.poll = &amp;dmabuf-&gt;poll;</span><br><span class="line">	dmabuf-&gt;cb_in.active = dmabuf-&gt;cb_out.active = <span class="number">0</span>;</span><br><span class="line">	INIT_LIST_HEAD(&amp;dmabuf-&gt;attachments);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!resv) &#123;</span><br><span class="line">		dmabuf-&gt;resv = (<span class="keyword">struct</span> dma_resv *)&amp;dmabuf[<span class="number">1</span>];</span><br><span class="line">		dma_resv_init(dmabuf-&gt;resv);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		dmabuf-&gt;resv = resv;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = dma_buf_stats_setup(dmabuf, file);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">goto</span> err_dmabuf;</span><br><span class="line"></span><br><span class="line">	file-&gt;private_data = dmabuf;</span><br><span class="line">	file-&gt;f_path.dentry-&gt;d_fsdata = dmabuf;</span><br><span class="line">	dmabuf-&gt;file = file;</span><br><span class="line"></span><br><span class="line">	__dma_buf_debugfs_list_add(dmabuf);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dmabuf;</span><br><span class="line"></span><br><span class="line">err_dmabuf:</span><br><span class="line">	<span class="keyword">if</span> (!resv)</span><br><span class="line">		dma_resv_fini(dmabuf-&gt;resv);</span><br><span class="line">	kfree(dmabuf);</span><br><span class="line">err_file:</span><br><span class="line">	fput(file);</span><br><span class="line">err_module:</span><br><span class="line">	module_put(exp_info-&gt;owner);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯¼å…¥è€… <code>DRM_IOCTL_PRIME_FD_TO_HANDLE</code></li>
</ul>
<p>å¯¼å…¥è€…æ¥æ”¶åˆ°åº•å±‚é€è¿‡ UNIX domain socket ä¼ æ¥çš„ prime_fd å (å¦‚ Xorg é€šè¿‡ <code>proc_dri3_pixmap_from_buffers()</code> æ¥æ”¶)ï¼Œé€šè¿‡ <code>DRM_IOCTL_PRIME_FD_TO_HANDLE</code> IOCTL é™·å…¥å†…æ ¸æ€ï¼Œå†…æ ¸é€šè¿‡ <code>dma_buf_get(prime_fd)</code> ç›´æ¥æ‰¾åˆ°å¯¹åº”çš„ DMA-BUF, ç„¶åå…ˆå» DMA-BUF ç¼“å­˜ä¸­æ‰¾ (<code>drm_prime_lookup_buf_handle()</code>)ï¼Œå¦‚æœå‘½ä¸­å°±ç›´æ¥å°† handle è¿”å›ç»™å¯¼å…¥è€…ï¼Œ å¦‚æœä¸å‘½ä¸­ï¼Œå°±è°ƒç”¨ <code>drm_gem_prime_import_dev()</code> æ¥å®Œæˆ DMA-BUF Sharing ä¸­æœ€æœ€å…³é”®çš„æ“ä½œï¼š<strong>å½“ Buffer å¯¼å…¥å¦å¤–ä¸€ä¸ªè¿›ç¨‹åï¼Œè¿™ä¸ª Buffer çš„ GPU Mappings (GPU pagetables) æ€ä¹ˆå¤åˆ¶è¿‡æ¥</strong>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * drm_gem_prime_import_dev - core implementation of the import callback</span></span><br><span class="line"><span class="comment"> * @dev: drm_device to import into</span></span><br><span class="line"><span class="comment"> * @dma_buf: dma-buf object to import</span></span><br><span class="line"><span class="comment"> * @attach_dev: struct device to dma_buf attach</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This is the core of drm_gem_prime_import(). It&#x27;s designed to be called by</span></span><br><span class="line"><span class="comment"> * drivers who want to use a different device structure than &amp;drm_device.dev for</span></span><br><span class="line"><span class="comment"> * attaching via dma_buf. This function calls</span></span><br><span class="line"><span class="comment"> * &amp;drm_driver.gem_prime_import_sg_table internally.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Drivers must arrange to call drm_prime_gem_destroy() from their</span></span><br><span class="line"><span class="comment"> * &amp;drm_gem_object_funcs.free hook when using this function.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> drm_gem_object *<span class="title function_">drm_gem_prime_import_dev</span><span class="params">(<span class="keyword">struct</span> drm_device *dev,</span></span><br><span class="line"><span class="params">					    <span class="keyword">struct</span> dma_buf *dma_buf,</span></span><br><span class="line"><span class="params">					    <span class="keyword">struct</span> device *attach_dev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dma_buf_attachment</span> *<span class="title">attach</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sg_table</span> *<span class="title">sgt</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">drm_gem_object</span> *<span class="title">obj</span>;</span></span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dma_buf-&gt;ops == &amp;drm_gem_prime_dmabuf_ops) &#123;</span><br><span class="line">		obj = dma_buf-&gt;priv;</span><br><span class="line">		<span class="keyword">if</span> (obj-&gt;dev == dev) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Importing dmabuf exported from our own gem increases</span></span><br><span class="line"><span class="comment">			 * refcount on gem itself instead of f_count of dmabuf.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			drm_gem_object_get(obj);</span><br><span class="line">			<span class="keyword">return</span> obj;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!dev-&gt;driver-&gt;gem_prime_import_sg_table)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">	attach = dma_buf_attach(dma_buf, attach_dev);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(attach))</span><br><span class="line">		<span class="keyword">return</span> ERR_CAST(attach);</span><br><span class="line"></span><br><span class="line">	get_dma_buf(dma_buf);</span><br><span class="line"></span><br><span class="line">	sgt = dma_buf_map_attachment_unlocked(attach, DMA_BIDIRECTIONAL);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(sgt)) &#123;</span><br><span class="line">		ret = PTR_ERR(sgt);</span><br><span class="line">		<span class="keyword">goto</span> fail_detach;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	obj = dev-&gt;driver-&gt;gem_prime_import_sg_table(dev, attach, sgt);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(obj)) &#123;</span><br><span class="line">		ret = PTR_ERR(obj);</span><br><span class="line">		<span class="keyword">goto</span> fail_unmap;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	obj-&gt;import_attach = attach;</span><br><span class="line">	obj-&gt;resv = dma_buf-&gt;resv;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">fail_unmap:</span><br><span class="line">	dma_buf_unmap_attachment_unlocked(attach, sgt, DMA_BIDIRECTIONAL);</span><br><span class="line">fail_detach:</span><br><span class="line">	dma_buf_detach(dma_buf, attach);</span><br><span class="line">	dma_buf_put(dma_buf);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="dynamic-dma-buf-mapping-å’Œ-cached-sg-table"><a class="markdownIt-Anchor" href="#dynamic-dma-buf-mapping-å’Œ-cached-sg-table"></a> Dynamic DMA-BUF Mapping å’Œ Cached Sg Table</h2>
<p>sg_table æ˜¯æè¿°<strong>ä¸è¿ç»­çš„ç‰©ç†å†…å­˜å—</strong>(è¿™ä¸ªå†…å­˜å—æ˜¯ä»¥ç‰©ç†é¡µä¸ºå•ä½çš„)çš„è¡¨ç»“æ„ï¼Œå°±æ˜¯ scatterlist çš„æ•°ç»„ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">scatterlist</span> &#123;</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> 	page_link;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> 	offset;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> 	length;</span><br><span class="line">		<span class="type">dma_addr_t</span>		dma_address;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>page_link</code> ä¿å­˜çš„æ˜¯ <code>struct page *</code>, å³ç‰©ç†é¡µçš„ç»“æ„ä½“æŒ‡é’ˆå†åŠ æœ€ä½ä¸¤ä½çš„ä¸¤ä¸ªæ ‡è¯†ä½</li>
<li><code>dma_address</code> åœ¨æœ‰ IOMMU çš„ç³»ç»Ÿä¸­æ˜¯ä¸€ä¸ª I/O è™šæ‹Ÿåœ°å€(ä¸‹å›¾ä¸­çš„ Z)ï¼Œåœ¨æ²¡æœ‰ IOMMU çš„ç³»ç»Ÿä¸­å°±æ˜¯è®¾å¤‡åœ°å€ç©ºé—´(æˆ– DMA åœ°å€ç©ºé—´)çš„ç‰©ç†åœ°å€(ä¸‹å›¾ä¸­çš„ Y)</li>
</ul>
<p><img src="/images/dma-buf/cpuva-cpupa-dma-addr.gif" alt="æœ¬å›¾æ¥è‡ªèœ—çªç§‘æŠ€" /></p>
<ul>
<li><code>dma_direct_map_sg()</code></li>
</ul>
<p><code>dma_direct_map_sg()</code> æ˜¯ç”±ä¸€ä¸ª scatterlist å¯¹åº”çš„ç‰©ç†é¡µå¾—åˆ°å¯¹åº”çš„ <code>dma_address</code>, å°±æ˜¯ä¸Šå›¾ä¸­ <strong>Y åˆ° Z çš„æ˜ å°„</strong></p>
<pre><code class="highlight mermaid">flowchart LR
	A[&quot;struct scatterlist *&quot;]
	B[&quot;struct page *&quot;]
	C[&quot;phys_addr_t phys&quot;]
	D[&quot;sg-&gt;dma_address&quot;]

	A -- sg_page() --&gt; B -- page_to_phys() --&gt; C -- phys_to_dma() --&gt; D</code></pre>
<h2 id="dma_fence"><a class="markdownIt-Anchor" href="#dma_fence"></a> dma_fence</h2>
<p><code>struct dma_fence</code> æ˜¯ä¸€ä¸ªç±»ä¼¼ <code>struct completion</code> çš„ç»“æ„ä½“ï¼Œç”¨æ¥è·Ÿè¸ª GPU ä»»åŠ¡ï¼Œå½“ä¸€ä¸ª GPU ä»»åŠ¡ç»“æŸæ—¶ï¼Œå¯¹åº”çš„ dma_fence è¢« signaled.</p>
<p><code>dma_fence_default_wait</code> æ˜¯ dma-fence é»˜è®¤çš„ wait æ“ä½œã€‚è¯¥å‡½æ•°ä¼šè®©å½“å‰è¿›ç¨‹(task) è¿›å…¥ç¡çœ çŠ¶æ€ (å¯ä¸­æ–­ç¡çœ æˆ–ä¸å¯ä¸­æ–­ç¡çœ ï¼Œå–å†³äºè°ƒç”¨è€…ä¼ å…¥çš„å‚æ•° <code>intr</code>ï¼‰, ç›´åˆ° dma-fence è¢« signaled æˆ–è€…è®¾ç½®çš„è¶…æ—¶æ—¶é—´åˆ°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">cb.base.func = dma_fence_default_wait_cb;</span><br><span class="line">cb.task = current;</span><br><span class="line">list_add(&amp;cb.base.node, &amp;fence-&gt;cb_list);</span><br></pre></td></tr></table></figure>
<h2 id="dma_resv"><a class="markdownIt-Anchor" href="#dma_resv"></a> dma_resv</h2>
<p><code>dma_resv</code> (reservation object) æ˜¯ä¸€ç»„ dma_fence + ä¸€ä¸ªé”ï¼Œå½“è°ƒç”¨è€…é€šè¿‡ <code>dma_resv_add_fence()</code> å‘ dma_resv é‡ŒåŠ å…¥æ–°çš„ dma_fence æ—¶éœ€è¦æŒæœ‰è¿™ä¸ªé”ã€‚</p>
<ul>
<li>æè¿°å¯¹ <code>dma_resv</code> ä¸åŒçš„ä½¿ç”¨åœºæ™¯</li>
<li>åœ¨è°ƒç”¨ <code>dma_resv_get_fences()</code> æ—¶ï¼Œå†³å®šå“ªäº› fences è¢«è¿”å›</li>
</ul>
<pre><code class="highlight mermaid">flowchart TD
    subgraph gem [drm_gem_object]
        D[dma_buf]
        subgraph _resv [&quot;struct dma_resv _resv&quot;]
            _F@&#123; shape: docs, label: &quot;dma_fence&quot;&#125;
        end
        RP[&quot;struct dma_resv *resv&quot;]
    end
    B@&#123; shape: lin-cyl, label: &quot;dma_buf&quot;&#125;
    subgraph resv [dma_resv]
        F@&#123; shape: docs, label: &quot;dma_fence&quot;&#125;
    end
    D --&gt; B --&gt; resv
    RP --except for imported GEM objects--&gt; _resv</code></pre>
<ul>
<li>ä¸ºä»€ä¹ˆåŒä¸€ä¸ª <code>dma_buf</code> ä¼šæœ‰é‚£ä¹ˆå¤š <code>dma_fence</code> ä¸ä¹‹å…³è”å‘¢ï¼Ÿ</li>
</ul>
<p>å› ä¸ºåŒä¸€ä¸ª Buffer ä¼šæœ‰å¤šä¸ª<strong>ä½¿ç”¨è€…</strong>ï¼Œ æœ‰çš„è¯»ï¼Œæœ‰çš„å†™ï¼Œæœ‰çš„ç­‰ï¼Œè¿™ä¸ª Buffer çš„æ‰€æœ‰ä½¿ç”¨è€…çš„æ¯ä¸ªæ“ä½œï¼Œç†è®ºä¸Šéƒ½æœ‰ä¸€ä¸ª <code>dma_fence</code>, è¿™äº› <code>dma_fence</code> åœ¨è¿™æ•´ä¸ªæœºåˆ¶ä¸‹â€œæœ‰æ¡ä¸ç´Šâ€åœ°è¢« signaled, æ‰èƒ½ä¿è¯æ‰€æœ‰è®¿é—®éƒ½æ˜¯æŒ‰é¢„æœŸçš„é¡ºåºå‘ç”Ÿï¼Œè¿™å°±æ˜¯åŒæ­¥(æ¯ä¸ªä½¿ç”¨è€…éƒ½å¯èƒ½æ˜¯å¹¶å‘çš„è¿›ç¨‹)ã€‚</p>
<h1 id="synchronization"><a class="markdownIt-Anchor" href="#synchronization"></a> Synchronization</h1>
<p>éšå¼è¿˜æ˜¯æ˜¾å¼åŒæ­¥çš„ä¸»è¦åŒºåˆ«åœ¨äºåŒæ­¥æ˜¯å¦ç”±åº”ç”¨ (Applications) ç›´æ¥æ§åˆ¶ï¼ŒVulkan ä»¥å‰çš„å›¾å½¢ APIï¼ŒåŒæ­¥æ˜¯ç”±å†…æ ¸é©±åŠ¨æˆ–ç”¨æˆ·é©±åŠ¨å®Œæˆçš„ï¼Œåº”ç”¨å®Œå…¨ä¸å‚ä¸ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ â€œImplicit Synchronizationâ€, Vulkan ä¸­ï¼ŒåŒæ­¥å®Œå…¨æ˜¯ç”±åº”ç”¨æ§åˆ¶çš„ï¼Œå“ªä¸ªæ¸²æŸ“ä»»åŠ¡ç­‰å“ªä¸ªæ¸²æŸ“ä»»åŠ¡ï¼ŒCPU ä»€ä¹ˆæ—¶å€™ç­‰ GPU, éƒ½æ˜¯ç”±åº”ç”¨ç›´æ¥æ§åˆ¶ï¼Œä»è¿™ä¸€ç‚¹ä¹Ÿè¯´æ˜ Vulkan åº”ç”¨æ˜¯æ¯”è¾ƒéš¾å†™çš„ï¼Œä½† Vulkan é©±åŠ¨(å°¤å…¶ç”¨æˆ·é©±åŠ¨) ç›¸å¯¹ç®€å•ä¸€äº›ã€‚ä½†æ˜¯é—®é¢˜æ˜¯ï¼Œä¸æ˜¯æ‰€æœ‰çš„å›¾å½¢åº”ç”¨éƒ½æ˜¯ Vulkan å†™çš„ (Xorg, Wayland compositor éƒ½ä¸æ˜¯ Vulkan å†™çš„ï¼Œè€Œå¥½å¤š Wayland client å¯èƒ½æ˜¯ Vulkan å†™çš„)ï¼Œæ‰€ä»¥ç›®å‰è¿˜éœ€è¦ä¸€äº›å…¶å®ƒæ–¹æ¡ˆè§£å†³è¿™ç§éšå¼åŒæ­¥å’Œæ˜¾å¼åŒæ­¥å…±å­˜çš„åœºæ™¯ã€‚<a href="https://zamundaaa.github.io/wayland/2024/04/05/explicit-sync.html">Explicit sync</a> è¿™ç¯‡åšæ–‡å…³äºè¿™ä¸¤è€…çš„æ¦‚å¿µè®²å¾—å¾ˆæ¸…æ¥šï¼Œè¿™é‡Œä¸»è¦æ˜¯ä»å®ç°çš„è§’åº¦ï¼Œåšä¸€ä¸‹è‡ªå·±å­¦ä¹ ç†è§£<strong>éšå¼åŒæ­¥å’Œæ˜¾å¼åŒæ­¥</strong>çš„è®°å½•ã€‚</p>
<h2 id="implicit-synchronization"><a class="markdownIt-Anchor" href="#implicit-synchronization"></a> Implicit Synchronization</h2>
<p>æ‰€è°“<strong>éšå¼åŒæ­¥</strong>ï¼Œå°±æ˜¯é©±åŠ¨ (KMD) ä¼šåœ¨æ¯ä¸ª dmabuf ä»¥åŠ buffer object ä¸Šé™„åŠ ä¸€ä¸ª <code>dma_fence</code>, ä»¥ç¡®ä¿æ¸²æŸ“å‘½ä»¤çš„<strong>æœ‰åº</strong>æ‰§è¡Œï¼Œä»¥åŠ buffer æ˜¯å¦å·²ç»å‡†å¤‡å°±ç»ªåæ‰å¯è®©<strong>æ¶ˆè´¹è€…</strong>è¿›è¡Œè¯»å–ï¼Œæ‰€æœ‰è¿™äº›å·¥ä½œåŸºæœ¬ä¸Šåœ¨å†…æ ¸å®Œæˆï¼Œå®Œå…¨ä¸éœ€è¦åº”ç”¨ç¨‹åºçš„å¹²é¢„ã€‚è¿™ç§æ–¹æ¡ˆè™½ç„¶ç®€å•ï¼ˆå¯¹äºåº”ç”¨å¼€å‘è€…ï¼‰æ¥è¯´ï¼Œä½†ä¼šæœ‰<strong>è¿‡åº¦åŒæ­¥ (Over-Synchronization)</strong> çš„é—®é¢˜ã€‚</p>
<h2 id="explicit-synchronization"><a class="markdownIt-Anchor" href="#explicit-synchronization"></a> Explicit Synchronization</h2>
<ul>
<li>sync_file</li>
</ul>
<p><code>CONFIG_SYNC_FILE</code> æ˜¯å†…æ ¸ 3.10 å¼•å…¥çš„ä¸€ä¸ªå¯é…ç½®çš„ (configurable) é…ç½®é€‰é¡¹ï¼Œ å®ƒæ§åˆ¶çš„æ˜¯ Linux å†…æ ¸ Explicit Synchronization Framework çš„ç¼–è¯‘ã€‚Sync File Framework å¢åŠ äº†ç”±ç”¨æˆ·ç©ºé—´æ§åˆ¶çš„æ˜¾å¼åŒæ­¥, å®ƒæä¾›äº†é€šè¿‡ç”¨æˆ·ç©ºé—´ç»„ä»¶ (Wayland, Vulkan ç­‰)åœ¨é©±åŠ¨ä¹‹é—´ä»¥ Sync File æ–‡ä»¶æè¿°ç¬¦å½¢å¼çš„ <code>struct dma_fence</code> å‘ç”¨æˆ·ç©ºé—´çš„æ”¶å‘èƒ½åŠ›ã€‚Sync File çš„ä¸»è¦ä½¿ç”¨è€…æ˜¯ GPU å’Œ V4L é©±åŠ¨, å®ƒä»¬é€šå¸¸ä¼šå°†ä¸€ä¸ª <code>dma_fence</code> å…³è”åˆ°ä¸€ä¸ª dmabuf, è¿™æ˜¯<strong>éšå¼åŒæ­¥</strong>çš„åšæ³•,  è€Œç°åœ¨é©±åŠ¨ä¼šå°†ä¸ dmabuf ç›¸å…³çš„è¿™ä¸ª <code>dma_fence</code> ä»¥ <strong>Sync File FD</strong>ä¼ é€åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p>
<p><em>NOTE: sync file æœ€åˆæ˜¯å…ˆåœ¨ Android kernel å†…å®ç°çš„</em></p>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°† <a href="https://elixir.bootlin.com/linux/v6.13.5/source/include/drm/drm_syncobj.h#L39"><code>struct drm_syncobj</code></a> å’Œ <a href="https://elixir.bootlin.com/linux/v6.13.5/source/include/drm/drm_gem.h#L273"><code>struct drm_gem_object</code></a> åšä¸ªå¯¹æ¯”, ä½•å…¶ç›¸ä¼¼ï¼</p>
<ul>
<li>drm_syncobj</li>
</ul>
<pre><code class="highlight mermaid">flowchart LR
  A[file descriptor]
  B[dma_fence]

  A -- SYNCOBJ_FD_TO_HANDLE&lt;br&gt;drmSyncobjFDToHandle() --&gt; B
  A &lt;-- drm_syncobj --&gt; B
  B -- SYNCOBJ_HANDLE_TO_FD&lt;br&gt;drmSyncobjHandleToFD() --&gt; A</code></pre>
<ul>
<li>drm_gem_object</li>
</ul>
<pre><code class="highlight mermaid">flowchart LR
  A[file descriptor]
  B[dma_buf]

  A -- PRIME_FD_TO_HANDLE&lt;br&gt;drmPrimeFDToHandle() --&gt; B
  A &lt;-- drm_gem_object --&gt; B
  B -- PRIME_HANDLE_TO_FD&lt;br&gt;drmPrimeHandleToFD() --&gt; A</code></pre>
<ul>
<li>drmSyncobjCreate()</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">drmSyncobjCreate</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> flags, <span class="type">uint32_t</span> *handle)</span>;</span><br></pre></td></tr></table></figure>
<p>drm_syncobj åœ¨ç”¨æˆ·ç©ºé—´åªæ˜¯ä¸€ä¸ª 32 ä½æ•´æ•° (handle), åˆ›å»ºå®ƒçš„ç”¨æˆ·æ€æ¥å£æ¥å—ä¸¤ä¸ªå…¥å‚ï¼Œä¸€ä¸ªå‡ºå‚:</p>
<ul>
<li>fd: drm è®¾å¤‡èŠ‚ç‚¹æ‰“å¼€åçš„æ–‡ä»¶æè¿°ç¬¦</li>
<li>flags: è¦ä¹ˆ 0ï¼Œ è¦ä¹ˆ <code>DRM_SYNCOBJ_CREATE_SIGNALED</code></li>
<li>handle: ç”±å†…æ ¸è¿”å›çš„ä»£è¡¨æ–°åˆ›å»ºçš„ drm_syncobj çš„ ID å­˜æ”¾åœ¨ handle è¿™ä¸ªåœ°å€</li>
</ul>
<p>å†çœ‹çœ‹åˆ›å»º syncobj çš„å†…æ ¸æ€æ¥å£ï¼Œå®ƒé‡Œé¢æœ‰ä¸¤æ­¥:</p>
<ul>
<li>drm_syncobj_create()</li>
</ul>
<p>ä»…ä»…æ˜¯ç”³è¯· <code>struct drm_syncobj</code> çš„å†…å­˜, åˆå§‹åŒ–å®ƒçš„æ•°æ®æˆå‘˜, è€Œä¸”æœ€å…³é”®çš„æˆå‘˜ <code>dma_fence</code> è¿˜æ˜¯ç©ºçš„ï¼Œå½“ç”¨æˆ·ä¼ å…¥ <code>DRM_SYNCOBJ_CREATE_SIGNALED</code> æ ‡å¿—æ—¶ï¼Œ<code>drm_syncobj_create()</code> ä¼šè‡ªå·±åˆ›å»ºä¸€ä¸ª <strong>stub fence</strong> èµ‹ç»™è¿™ä¸ª syncobj, å¦‚æœåˆ›å»ºæ—¶æ ‡å¿—æ˜¯ 0ï¼Œ åˆ™ç”±ç”¨æˆ·åé¢ç»‘å®šç›¸å…³çš„ <code>dma_fence</code> (å½“ç„¶è¿˜æ˜¯é€šè¿‡ syncobj çš„å½¢å¼ï¼Œå› ä¸º <code>dma_fence</code> å¯¹ç”¨æˆ·æ€ä¸å¯è§ï¼Œ ä¸€èˆ¬æ˜¯ç”¨ <code>drmSyncobjExportSyncFile()</code>, <code>drmSyncobjCreate()</code>, <code>drmSyncobjImportSyncFile()</code> æ¥å®Œæˆçš„ã€‚)</p>
<ul>
<li>drm_syncobj_get_handle()</li>
</ul>
<p>è¿”å›çš„è¿™ä¸ª 32 ä½æ•´æ•°ä»£è¡¨çš„å°±æ˜¯ drm_syncobj, ä½†å®ƒä»ç„¶ä¸æ˜¯æ–‡ä»¶æè¿°ç¬¦ fd, æœ€ç»ˆè¦è®© drm_syncobj èƒ½æœ‰ä¸€ä¸ªçœŸæ­£çš„æ–‡ä»¶æè¿°ç¬¦è¿˜éœ€è¦ä¸¤ä¸ª IOCTL:</p>
<ul>
<li><code>DRM_IOCTL_SYNCOBJ_HANDLE_TO_FD</code></li>
<li><code>DRM_IOCTL_SYNCOBJ_FD_TO_HANDLE</code></li>
</ul>
<p>æ„Ÿè§‰ä¸ºäº†è®©ç”¨æˆ·ç©ºé—´èƒ½å¤Ÿç›´æ¥æ“ä½œ <code>dma_fence</code> è¿™ä¸ªå†…æ ¸çš„åŒæ­¥åŸè¯­ï¼Œè´¹äº†â€œå¥½å¤§åŠ²â€ï¼Œè¿™èƒŒååº”è¯¥æœ‰ç³»ç»Ÿè®¾è®¡å±‚é¢çš„è€ƒè™‘ï¼Œåé¢æœ‰æ—¶é—´å†ç¢ç£¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * drm_syncobj_get_handle - get a handle from a syncobj</span></span><br><span class="line"><span class="comment"> * @file_private: drm file private pointer</span></span><br><span class="line"><span class="comment"> * @syncobj: Sync object to export</span></span><br><span class="line"><span class="comment"> * @handle: out parameter with the new handle</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Exports a sync object created with drm_syncobj_create() as a handle on</span></span><br><span class="line"><span class="comment"> * @file_private to userspace.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns 0 on success or a negative error value on failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">drm_syncobj_get_handle</span><span class="params">(<span class="keyword">struct</span> drm_file *file_private,</span></span><br><span class="line"><span class="params">			   <span class="keyword">struct</span> drm_syncobj *syncobj, u32 *handle)</span></span><br></pre></td></tr></table></figure>
<h2 id="fd-to-handle-convert"><a class="markdownIt-Anchor" href="#fd-to-handle-convert"></a> FD to Handle Convert</h2>
<ul>
<li><code>int drmSyncobjFDToHandle(int fd, int obj_fd, uint32_t *handle);</code></li>
<li><code>int drmSyncobjHandleToFD(int fd, uint32_t handle, int *obj_fd);</code></li>
</ul>
<h2 id="sync-file-transfer"><a class="markdownIt-Anchor" href="#sync-file-transfer"></a> Sync File Transfer</h2>
<ul>
<li><code>int drmSyncobjImportSyncFile(int fd, uint32_t handle, int sync_file_fd);</code></li>
<li><code>int drmSyncobjExportSyncFile(int fd, uint32_t handle, int *sync_file_fd);</code></li>
</ul>
<p><code>drmSyncobjFDToHandle()</code> å’Œ <code>drmSyncobjImportSyncFile()</code> çš„åŒºåˆ«ä»…ä»…æ˜¯åè€…è®¾ç½®äº† <code>DRM_SYNCOBJ_FD_TO_HANDLE_FLAGS_IMPORT_SYNC_FILE</code> è¿™ä¸ª flagsã€‚<code>drmSyncobjHandleToFD()</code> å’Œ <code>drmSyncobjExportSyncFile()</code> ä¹Ÿæ˜¯ç±»ä¼¼ã€‚</p>
<p><code>drmSyncobjExportSyncFile()</code> é€šè¿‡ ioctl å°†ç”¨æˆ·ç»™å®šçš„ syncobj ID è½¬æ¢æˆä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¿”å›ç»™ç”¨æˆ·ã€‚è€Œ SyncobjExport/ImportSyncFile è¿™å¯¹æ“ä½œå’Œ SyncobjFDToHandle/HandleToFD è¿™å¯¹æ“ä½œçš„åŒºåˆ«æ˜¯åè€…æ˜¯ç»™<strong>åŒä¸€ä¸ª drm_syncobj</strong> æä¾›<strong>ä¸¤ä¸ªä¸åŒçš„ ID</strong> è€Œå·²ã€‚</p>
<p>è€Œå‰è€…é€šè¿‡å’Œ <code>drmSyncobjCreate()</code> é…åˆï¼Œä¼šäº§ç”Ÿå¦å¤–ä¸€ä¸ª<strong>æ–°çš„ drm_syncobj</strong></p>
<h1 id="questions"><a class="markdownIt-Anchor" href="#questions"></a> Questions</h1>
<ul>
<li>syncobj çš„ handle å¯ä»¥æ˜¯ 0 å—ï¼Ÿ</li>
</ul>
<p><strong>ä¸ä¼šæ˜¯ 0</strong></p>
<p><code>drm_syncobj_get_handle()</code> å’Œ <code>drm_gem_handle_create_tail()</code> ä¸€æ ·ï¼Œæ˜¯é€šè¿‡ <code>idr_alloc()</code> ç”³è¯·çš„ä¸€ä¸ªç»™å®šèŒƒå›´å†…çš„ 32 ä½æ•´æ•°ï¼Œ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ret = idr_alloc(&amp;file_private-&gt;syncobj_idr, syncobj, <span class="number">1</span>, <span class="number">0</span>, GFP_NOWAIT);</span><br></pre></td></tr></table></figure>
<p>å®ƒç”³è¯·èŒƒå›´åœ¨æœ€å°å€¼æ˜¯ 1 (åŒ…å«)å’Œæœ€å¤§å€¼æ˜¯ 0 (ä¸åŒ…å«ï¼Œå®é™…ä¸Šæœ€å¤§å€¼æ˜¯ 0xffffffff) ä¹‹é—´çš„ä¸€ä¸ªæ•´æ•°ã€‚</p>
<p>è¿™é‡Œä¸»è¦æ ¹æ®<a href="https://patchwork.kernel.org/project/kvm/patch/20250107142719.179636-2-yilun.xu@linux.intel.com/">å†…æ ¸é‚®ä»¶åˆ—è¡¨é‡Œçš„ä¸€ä¸ªè®¨è®º</a>æ¥æ›´å¥½çš„ç†è§£ dma-buf çš„è®¾è®¡æ€è·¯å’Œä½¿ç”¨åŸåˆ™ã€‚</p>
<ul>
<li>
<p>å¯¹äº dma-buf æ¥è¯´ï¼Œ ä»€ä¹ˆæ˜¯ <strong>static attach</strong> ï¼Ÿ ä»€ä¹ˆæ˜¯ <strong>dynamic attach</strong> ?</p>
<ul>
<li>static attach åº”è¯¥æ˜¯æŒ‡ dma-buf å¯¹åº”çš„ page ä¸ä¼šåœ¨å†…å­˜ä¸­ç§»åŠ¨ (move), è€Œ dynamic attach ç›¸å<strong>æœ‰å¯èƒ½ç§»åŠ¨</strong></li>
</ul>
</li>
<li>
<p>ç”¨æˆ·ä¸ºä»€ä¹ˆä¸ç›´æ¥å°† dma-buf çš„ PFN (ç‰©ç†é¡µå¸§å·) å…±äº«ç»™ importer, è®© importer è‡ªå·±å»åˆ›å»º mappings ï¼Ÿ</p>
<ul>
<li>dma-buf è®¾è®¡çš„å°±æ˜¯ä¸æŠŠ <code>struct page</code> æˆ– pfn æš´éœ²ç»™ importer, æœ¬è´¨ä¸Š, dma-buf åªä¼ é€ dma_addrã€‚æ‰€ä»¥ mappings æ€»æ˜¯ç”± exporter åˆ›å»ºï¼Œè€Œä¸æ˜¯ç”± importerã€‚</li>
<li>exported buffer æœªå¿…ä¸€å®šæ˜¯å†…å­˜ (æœ‰ <code>struct page</code>), ä¹Ÿå¯èƒ½æ˜¯ MMIO</li>
</ul>
</li>
<li>
<p>ä½†ä¸ºä»€ä¹ˆä¸€å®šè¦è®© exporter å» map å‘¢ï¼Ÿ</p>
</li>
<li>
<p>Exporter mapping å­˜åœ¨é—®é¢˜çš„åœºæ™¯:</p>
<ul>
<li>Private address space</li>
<li>Multi-path PCI</li>
<li>Importing devices need to do things like turn on ATS on their DMA</li>
<li>TPH bits needs to be programmed into importer device</li>
<li>iommufd and KVM</li>
</ul>
</li>
<li>
<p>ä¸ºä»€ä¹ˆæŠŠ dma-buf çš„ backing storage ä¿¡æ¯æš´éœ²ç»™ importer æ˜¯ä¸€ä¸ªåä¸»æ„ï¼Ÿ</p>
</li>
<li>
<p>exporter ä¼šè·å– importer çš„ <code>struct device</code></p>
</li>
<li>
<p>multipath æ€»æ˜¯éœ€è¦åœ¨ importer ä¾§æœ‰é¢å¤–çš„å…ƒä¿¡æ¯å»å‘Šè¯‰ device é€‰æ‹©å“ªä¸ª path</p>
</li>
</ul>
<p>ğŸ˜¦ è¿™5ä¸ªåœºæ™¯ç›®å‰ä¸€ä¸ªéƒ½ä¸çŸ¥é“æ˜¯å¹²ä»€ä¹ˆçš„ ğŸ˜¦</p>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://docs.kernel.org/driver-api/dma-buf.html">kdoc: Buffer Sharing and Synchronization</a></li>
<li><a href="https://docs.kernel.org/driver-api/sync_file.html">Sync File API Guide</a></li>
<li><a href="https://lwn.net/Articles/454389/">Sharing buffers between devices</a></li>
<li><a href="https://blog.csdn.net/hexiaolong2009/article/details/105961192">PRIME</a></li>
<li><a href="https://blog.csdn.net/hexiaolong2009/category_10838100.html">ä½•å°é¾™çš„ DMA-BUF ç³»åˆ—æ–‡ç« </a></li>
<li><a href="http://www.wowotech.net/memory_management/DMA-Mapping-api.html">Dynamic DMA Mapping Guide</a></li>
<li><a href="http://www.wowotech.net/memory_management/scatterlist.html">Linux kernel scatterlist API ä»‹ç»</a></li>
<li><a href="https://kernelnote.com/deep-dive-iommu-hardware-driver.html">æ·±å…¥ç†è§£ iommu ç³»åˆ—ä¸€ï¼šiommu ç¡¬ä»¶æ¶æ„å’Œé©±åŠ¨åˆå§‹åŒ–</a></li>
<li><a href="https://zamundaaa.github.io/wayland/2024/04/05/explicit-sync.html">Explicit sync</a></li>
<li><a href="https://www.collabora.com/news-and-blog/blog/2022/06/09/bridging-the-synchronization-gap-on-linux/">Bridging the synchronization gap on Linux</a></li>
<li><a href="https://royhunter.github.io/2016/03/13/kvm-mmu-virtualization/">KVM ä¹‹å†…å­˜è™šæ‹ŸåŒ–</a></li>
<li><a href="https://lwn.net/Articles/997563/">Dancing the DMA two-step</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>DRM Device</title>
    <url>/lnx/drm-device/</url>
    <content><![CDATA[<h1 id="drm-introduction"><a class="markdownIt-Anchor" href="#drm-introduction"></a> DRM Introduction</h1>
<p><a href="https://en.wikipedia.org/wiki/Direct_Rendering_Manager">Direct Rendering Manager</a>æ˜¯Linux kernelä¸­è´Ÿè´£ä¸GPUæ¥å£çš„å­ç³»ç»Ÿï¼Œä½†å®ƒä¸ä»…ä»…ç”¨åœ¨Linux, å®ƒä¹Ÿä¼šç”¨åœ¨åƒ<a href="https://zh.wikipedia.org/zh-cn/OpenBSD">OpenBSD</a>çš„å…¶å®ƒä¸€äº›ç±»UNIXç³»ç»Ÿã€‚</p>
<span id="more"></span>
<h1 id="drm-device-nodes"><a class="markdownIt-Anchor" href="#drm-device-nodes"></a> DRM Device Nodes</h1>
<p>DRM Device node æœ‰ 3 ç§</p>
<ul>
<li>primary (cardn), å¦‚ <code>/dev/dri/card0</code></li>
<li>renderDn, å¦‚ <code>/dev/dri/renderD128</code></li>
<li>controlDn, å¦‚ <code>/dev/dri/controlD0</code></li>
</ul>
<p>åœ¨å„ç§ UMD å’Œ Compositor çš„å®ç°ä¸­ä½¿ç”¨æ¯”è¾ƒå¤šçš„æ˜¯ cardn å’Œ renderDn èŠ‚ç‚¹ï¼Œ ä¸¤è€…çš„ä¸»è¦åŒºåˆ«åœ¨äºæ–‡ä»¶æƒé™ï¼Œè®¿é—® cardn éœ€è¦ root æƒé™ï¼Œcardn æ˜¯ Linux DRM å†å²é—ç•™äº§ç‰©ï¼Œåœ¨ç°ä»£å›¾å½¢åº”ç”¨ä¸­ï¼Œ ä¸€èˆ¬æ¨èä½¿ç”¨ renderDn èŠ‚ç‚¹ã€‚ æ¯”å¦‚ Xorg ä½¿ç”¨çš„å°±æ˜¯ cardn èŠ‚ç‚¹ã€‚</p>
<p>å…³äº primary èŠ‚ç‚¹ï¼Œéœ€è¦äº†è§£:</p>
<ul>
<li>æ— è®ºå®ƒæ˜¯ä½ç«¯çš„æ˜¾ç¤ºå¡ï¼Œè¿˜æ˜¯ SoCï¼Œæˆ–åƒ Intel/AMD/NVIDIA é‚£äº›æ¡Œé¢ GPU, åªè¦æ³¨å†Œä¸€ä¸ª DRM è®¾å¤‡å°±éƒ½ä¼šé»˜è®¤æœ‰ primary èŠ‚ç‚¹ <code>/dev/dri/card123</code></li>
<li>primary èŠ‚ç‚¹å’Œ render èŠ‚ç‚¹çš„ä¸»è¦åŒºåˆ«åœ¨<strong>æƒé™</strong>ï¼Œ æ“ä½œ (open, ioctl) primary èŠ‚ç‚¹éœ€è¦ root æƒé™ï¼Œ è€Œ render èŠ‚ç‚¹ä¸éœ€è¦</li>
<li>primary èŠ‚ç‚¹å’Œ render èŠ‚ç‚¹åº•å±‚å¯ä»¥æ˜¯åŒä¸€ä¸ªç‰©ç†è®¾å¤‡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸åŒçš„ç‰©ç†è®¾å¤‡ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ªä½¿ç”¨ Mali GPU IP å’Œ MTK display controller IP çš„ MTK SoC ä¸Šï¼Œ MTK è®¾å¤‡åªæœ‰æ˜¾ç¤ºèƒ½åŠ› (<code>/dev/dri/card0</code>), è€Œ Mali è®¾å¤‡åªæœ‰æ¸²æŸ“èƒ½åŠ›ï¼Œä½†å®ƒåŒæ—¶ä¼šæœ‰ primary èŠ‚ç‚¹ (<code>/dev/dri/card1</code>) å’Œ render èŠ‚ç‚¹ (<code>/dev/dri/renderD128</code>).</li>
<li>render èŠ‚ç‚¹æ˜¯ä¸“é—¨ç”¨æ¥æ‰§è¡Œéå…¨å±€çš„æ¸²æŸ“å‘½ä»¤çš„ï¼ˆé‚£äº›å…¨å±€çš„ modeset å‘½ä»¤æ˜¯é€šè¿‡ primary èŠ‚ç‚¹æ‰§è¡Œçš„)ï¼Œå¦‚æœä¸€ä¸ªé©±åŠ¨ä¸æ”¯æŒ render èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå®ƒåªèƒ½é€šè¿‡ primary èŠ‚ç‚¹å’Œ <code>drmAuth</code> åŠŸèƒ½ä¸€èµ·å®Œæˆæ¸²æŸ“ä»»åŠ¡ã€‚</li>
</ul>
<h2 id="major-number"><a class="markdownIt-Anchor" href="#major-number"></a> Major Number</h2>
<p>DRMè®¾å¤‡çš„ä¸»è®¾å¤‡å·åœ¨ä¸åŒçš„ç³»ç»Ÿä¸Šä¸åŒã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">OS</th>
<th style="text-align:left">Major Number</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">DragonFlyBSD</td>
<td style="text-align:left">145</td>
</tr>
<tr>
<td style="text-align:left">NetBSD</td>
<td style="text-align:left">34</td>
</tr>
<tr>
<td style="text-align:left">OpenBSD</td>
<td style="text-align:left">88/87</td>
</tr>
<tr>
<td style="text-align:left">Linux</td>
<td style="text-align:left">226</td>
</tr>
</tbody>
</table>
<h2 id="minor-number"><a class="markdownIt-Anchor" href="#minor-number"></a> Minor Number</h2>
<p>æ¯ç§ç±»å‹çš„DRMè®¾å¤‡éƒ½æœ‰ä¸€ä¸ª<strong>Base Minor</strong>, æ¯ç§ç±»å‹å…è®¸çš„å­è®¾å¤‡å·ä¸ªæ•°æ˜¯<code>64</code> ä¸ª. æ‰€ä»¥ï¼ŒLinuxä¸‹æœ€å¤§çš„DRM Render Nodeè®¾å¤‡æ–‡ä»¶åæ˜¯<code>/dev/dri/renderD191</code>.</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">r = idr_alloc(&amp;drm_minors_idr,</span><br><span class="line">	<span class="literal">NULL</span>,</span><br><span class="line">	<span class="number">64</span> * type,</span><br><span class="line">	<span class="number">64</span> * (type + <span class="number">1</span>),</span><br><span class="line">	GFP_NOWAIT);</span><br></pre></td></tr></table></figure>
<img src="/lnx/drm-device/drm-minor.png" class="">
<h2 id="name-convention"><a class="markdownIt-Anchor" href="#name-convention"></a> Name Convention</h2>
<p>DRMè®¾å¤‡åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶åè§„åˆ™åœ¨ä¸åŒçš„ç³»ç»Ÿä¸Šä¸åŒã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left">OpenBSD</th>
<th style="text-align:left">Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">DIR_NAME</td>
<td style="text-align:left"><code>/dev</code></td>
<td style="text-align:left"><code>/dev/dri</code></td>
</tr>
<tr>
<td style="text-align:left">PRIMARY_MINOR_NAME</td>
<td style="text-align:left"><code>drm</code></td>
<td style="text-align:left"><code>card</code></td>
</tr>
<tr>
<td style="text-align:left">CONTROL_MINOR_NAME</td>
<td style="text-align:left"><code>drmC</code></td>
<td style="text-align:left"><code>controlD</code></td>
</tr>
<tr>
<td style="text-align:left">RENDER_MINOR_NAME</td>
<td style="text-align:left"><code>drmR</code></td>
<td style="text-align:left"><code>renderD</code></td>
</tr>
</tbody>
</table>
<ol>
<li><a href="https://cgit.freedesktop.org/~airlied/linux/commit/?h=drm-next&amp;id=1793126fcebd7c18834f95d43b55e387a8803aa8">drm: implement experimental render nodes</a></li>
</ol>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>DRM/KMS</tag>
      </tags>
  </entry>
  <entry>
    <title>Direct Rendering Management</title>
    <url>/lnx/drm-driver/</url>
    <content><![CDATA[<h1 id="drm-driver-features"><a class="markdownIt-Anchor" href="#drm-driver-features"></a> DRM driver features</h1>
<h2 id="æ–°drmé©±åŠ¨çš„ç‰¹æ€§"><a class="markdownIt-Anchor" href="#æ–°drmé©±åŠ¨çš„ç‰¹æ€§"></a> æ–°DRMé©±åŠ¨çš„ç‰¹æ€§</h2>
<ul>
<li>DRIVER_GEM</li>
</ul>
<p>ä½¿ç”¨<strong>GEM</strong>å†…å­˜ç®¡ç†å™¨ï¼Œæ‰€æœ‰æ–°çš„é©±åŠ¨éƒ½åº”è¯¥æ”¯æŒã€‚</p>
<ul>
<li>DRIVER_MODESET</li>
</ul>
<p>æ”¯æŒ<strong>Kernel Modesetting Interfaces</strong></p>
<ul>
<li>DRIVER_RENDER</li>
</ul>
<p>æ”¯æŒä¸“é—¨çš„æ¸²æŸ“èŠ‚ç‚¹ï¼Œ å³**/dev/dri/renderD**</p>
<ul>
<li>DRIVER_ATOMIC</li>
</ul>
<p>æ”¯æŒæ‰€æœ‰çš„<strong>Atomic Modesetting</strong>ç”¨æˆ·ç©ºé—´API</p>
<ul>
<li>DRIVER_SYNCOBJ</li>
</ul>
<p>æ”¯æŒ<strong>drm_syncobj</strong>, ç”¨äºæ¸²æŸ“å‘½ä»¤æäº¤çš„æ˜¾å¼åŒæ­¥ã€‚</p>
<ul>
<li>DRIVER_SYNCOBJ_TIMELINE</li>
</ul>
<p>æ”¯æŒ<strong>drm_syncobj</strong>çš„<strong>timeline</strong>ç‰¹æ€§</p>
<h2 id="æ—§drmé©±åŠ¨çš„ç‰¹æ€§"><a class="markdownIt-Anchor" href="#æ—§drmé©±åŠ¨çš„ç‰¹æ€§"></a> æ—§DRMé©±åŠ¨çš„ç‰¹æ€§</h2>
<ul>
<li>DRIVER_USE_AGP</li>
<li>DRIVER_LEGACY</li>
<li>DRIVER_PCI_DMA</li>
<li>DRIVER_SG</li>
<li>DRIVER_HAVE_DMA</li>
<li>DRIVER_HAVE_IRQ</li>
<li>DRIVER_KMS_LEGACY_CONTEXT</li>
</ul>
<h1 id="å†…æ ¸-drm-å­ç³»ç»Ÿæ˜¯å¦‚ä½•ç»´æŠ¤çš„"><a class="markdownIt-Anchor" href="#å†…æ ¸-drm-å­ç³»ç»Ÿæ˜¯å¦‚ä½•ç»´æŠ¤çš„"></a> å†…æ ¸ DRM å­ç³»ç»Ÿæ˜¯å¦‚ä½•ç»´æŠ¤çš„</h1>
<p>å†…æ ¸ DRM å­ç³»ç»Ÿçš„ä»£ç ä»“åº“æ‰˜ç®¡åœ¨cgitä¸Šï¼Œ<a href="https://cgit.freedesktop.org/drm/drm">Upstream DRM Subsystem Repository</a>, è¿™ä¸ªä»“åº“æœ€ä¸»è¦çš„ä¸¤ä¸ªåˆ†æ”¯</p>
<ul>
<li>
<p>drm-next</p>
<p>è¿™ä¸ªåˆ†æ”¯çš„è¡¥ä¸åŒ…æ‹¬ DRM æ ¸å¿ƒå’Œæ‰€æœ‰ GPU é©±åŠ¨çš„æ–°ç‰¹æ€§</p>
</li>
<li>
<p>drm-fixes</p>
</li>
</ul>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://docs.kernel.org/gpu/index.html">GPU Driver Developerâ€™s Guide</a></li>
<li><a href="https://drm.pages.freedesktop.org/maintainer-tools/repositories.html">DRM Maintainer Tools</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>DRM/KMS</tag>
      </tags>
  </entry>
  <entry>
    <title>DRM format modifier</title>
    <url>/lnx/drm-mod/</url>
    <content><![CDATA[<h1 id="fourcc"><a class="markdownIt-Anchor" href="#fourcc"></a> FourCC</h1>
<p>FourCC format codeæ˜¯Linuxå†…æ ¸DRMå­ç³»ç»Ÿç”¨æ¥æè¿°framebufferåƒç´ æ ¼å¼ã€‚å®ƒä»¬è¢«å®šä¹‰åœ¨å†…æ ¸æºç <a href="https://github.com/torvalds/linux/blob/master/include/uapi/drm/drm_fourcc.h#L156">include/uapi/drm/drm_fourcc.h</a>. åŸºæœ¬ä¸ŠFourCC format codeè¶³ä»¥æè¿°framebufferä¸­åƒç´ çš„å†…å®¹äº†ï¼Œä½†æ˜¯éšç€GPUçš„æ›´æ–°ï¼ŒåŸæ¥çº¿æ€§æ’åˆ—çš„buffersï¼Œä¸ºäº†è·å–æ›´å¥½çš„æ€§èƒ½ï¼Œå¯èƒ½ä¼šé‡‡å–vendor specificçš„å¸ƒå±€æ–¹å¼ã€‚å¦å¤–ï¼Œè¿™äº›bufferä¹Ÿå¯èƒ½ä¿å­˜çš„æ˜¯å„ç§ä¸åŒçš„å‹ç¼©æ•°æ®ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒåŸæ¥çš„FourCC format codeå°±æ— æ³•æºå¸¦æ–°çš„buffer<br />
layoutæˆ–compression formatçš„ä¿¡æ¯ï¼ŒDRM format modifierå°±æ˜¯ç”¨æ¥è§£å†³è¿™äº›é—®é¢˜çš„ã€‚</p>
<span id="more"></span>
<h1 id="modifier"><a class="markdownIt-Anchor" href="#modifier"></a> Modifier</h1>
<h1 id="examples"><a class="markdownIt-Anchor" href="#examples"></a> Examples</h1>
<h2 id="drm_format_mod_arm_16x16_block_u_interleaved"><a class="markdownIt-Anchor" href="#drm_format_mod_arm_16x16_block_u_interleaved"></a> <a href="https://elixir.bootlin.com/mesa/latest/source/include/drm-uapi/drm_fourcc.h#L1332">DRM_FORMAT_MOD_ARM_16X16_BLOCK_U_INTERLEAVED</a></h2>
<h3 id="how-u-interleaved-improves-performance"><a class="markdownIt-Anchor" href="#how-u-interleaved-improves-performance"></a> How U-interleaved improves performance?</h3>
<p><img src="/images/drm-mod/u-interleaved.drawio.svg" alt="U-interleaved memory layout" /></p>
<p>è¿™ç§äº¤é”™ (interleave) æ–¹å¼ç±»ä¼¼ <a href="https://en.wikipedia.org/wiki/Z-order_curve">Morton order(Z-order)</a>, Morton order æ˜¯ä¸€ç§å°†<strong>å¤šç»´æ•°æ®æ˜ å°„åˆ°ä¸€ç»´</strong>çš„å‡½æ•°, åŒæ—¶<strong>ä¿ç•™æ•°æ®ç‚¹çš„ä½ç½®ç‰¹å¾</strong>ï¼Œ ä¹Ÿå°±æ˜¯è¯´åœ¨<strong>å¤šç»´æ—¶ç¦»å¾—è¿‘çš„æ•°æ®ç‚¹åœ¨ä¸€ç»´æ—¶ä¹Ÿç¦»å¾—è¿‘</strong>ã€‚</p>
<p><img src="/images/drm-mod/Z-curve45.svg.png" alt="four iterations of Z-order curve" /></p>
<h3 id="what-is-the-block-size"><a class="markdownIt-Anchor" href="#what-is-the-block-size"></a> What is the block size?</h3>
<p>å¯¹äº U-interleaved å¸ƒå±€çš„çº¹ç†, æœ‰ä¸¤ç§å¯èƒ½çš„ block size:</p>
<ul>
<li>4x4 (å‹ç¼©æ ¼å¼)</li>
<li>16x16 (éå‹ç¼©æ ¼å¼)</li>
</ul>
<h3 id="what-is-the-row-stride"><a class="markdownIt-Anchor" href="#what-is-the-row-stride"></a> What is the row stride?</h3>
<p>row stride é€šå¸¸æŒ‡çº¹ç†å›¾ç‰‡ä¸­ç›¸é‚»ä¸¤è¡Œä¹‹é—´çš„å­—èŠ‚æ•°ã€‚å¯¹äº Linear å¸ƒå±€çš„çº¹ç†, block size æ˜¯ 1x1, å®ƒçš„ row stride å³ä¸º</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>o</mi><mi>w</mi><mi>S</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>d</mi><mi>e</mi><mo>=</mo><mi>B</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mi>P</mi><mi>e</mi><mi>r</mi><mi>P</mi><mi>i</mi><mi>x</mi><mi>e</mi><mi>l</mi><mo>âˆ—</mo><mi>W</mi><mi>i</mi><mi>d</mi><mi>t</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">RowStride = BytesPerPixel * Width 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">i</span><span class="mord mathnormal">x</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span></span></span></span></span></p>
<p>è¿™ä¹Ÿæ˜¯æ‰€è°“çš„é€»è¾‘ row stride, è€Œå¯¹äº U-interleaved å¸ƒå±€çš„çº¹ç†ï¼Œç”±äºå®ƒåœ¨å†…å­˜ä¸­æ˜¯æŒ‰å—å­˜å‚¨çš„ï¼ˆå—ä¸å—ä¹‹é—´æ˜¯çº¿æ€§çš„ï¼‰ï¼Œæ‰€ä»¥ U-interleaved å¸ƒå±€çš„çº¹ç†çš„ row stride å·²ç»ä¸æ˜¯é€šå¸¸æ„ä¹‰çš„â€œè¡Œâ€äº†ï¼Œè€Œæ˜¯ç”±<strong>å—</strong>ç»„æˆçš„<strong>è¡Œ</strong>ã€‚æ‰€ä»¥ U-interleaved å¸ƒå±€çš„çº¹ç†çš„ row stride ä¸º</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>o</mi><mi>w</mi><mi>S</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>d</mi><mi>e</mi><mo>=</mo><mi>B</mi><mi>y</mi><mi>t</mi><mi>e</mi><mi>s</mi><mi>P</mi><mi>e</mi><mi>r</mi><mi>B</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo>âˆ—</mo><mi>n</mi><mi>B</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mi>s</mi><mi>X</mi></mrow><annotation encoding="application/x-tex">RowStride = BytesPerBlock * nBlocksX 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span></p>
<h4 id="éå‹ç¼©æ ¼å¼çš„-u-interleaved-å¸ƒå±€çš„-row-stride"><a class="markdownIt-Anchor" href="#éå‹ç¼©æ ¼å¼çš„-u-interleaved-å¸ƒå±€çš„-row-stride"></a> éå‹ç¼©æ ¼å¼çš„ U-interleaved å¸ƒå±€çš„ row stride</h4>
<p><img src="/images/drm-mod/u-interleaved-row-stride-non-compress.drawio.svg" alt="U-interleaved row stride in regular format" /></p>
<h4 id="å‹ç¼©æ ¼å¼çš„-u-interleaved-å¸ƒå±€çš„-row-stride"><a class="markdownIt-Anchor" href="#å‹ç¼©æ ¼å¼çš„-u-interleaved-å¸ƒå±€çš„-row-stride"></a> å‹ç¼©æ ¼å¼çš„ U-interleaved å¸ƒå±€çš„ row stride</h4>
<p>ä»¥ <a href="https://sv-journal.org/2014-1/06/en/index.php?lang=en#5">BC1 å‹ç¼©æ ¼å¼</a>ä¸ºä¾‹, BC1 æ˜¯ S3TC å®¶æ—çš„ä¸€å‘˜(æ‰€æœ‰çš„ S3TC å®¶æ—éƒ½ä½¿ç”¨ 4x4 çš„å—å¤§å°)ï¼Œè€Œ DRM_FORMAT_MOD_ARM_16X16_BLOCK_U_INTERLEAVED æ˜¯ 16x16 å¤§å°çš„ï¼Œæ‰€ä»¥ä¸€ä¸ª U-interleaved å—ä¸­åŒ…å« 4x4 ä¸ª BC1 å‹ç¼©å—ã€‚</p>
<p><img src="/images/drm-mod/u-interleaved-row-stride-compress.drawio.svg" alt="U-interleaved row stride in BC1 compression format" /></p>
<h1 id="modifier-negotiation"><a class="markdownIt-Anchor" href="#modifier-negotiation"></a> Modifier Negotiation</h1>
<h2 id="on-x11"><a class="markdownIt-Anchor" href="#on-x11"></a> On X11</h2>
<p>åœ¨ DRI3 æ‰©å±•é‡Œï¼Œ å› ä¸º render buffer æ˜¯ç”±é©±åŠ¨(åº”ç”¨)åˆ›å»ºåå¯¼å‡ºç»™ X11 çš„ï¼Œ æ‰€ä»¥åœ¨é©±åŠ¨åˆ›å»º buffer å‰ï¼Œéœ€è¦å‘ X11 æŸ¥è¯¢ç°åœ¨æ”¯æŒå“ªäº› modifiers, é©±åŠ¨æ ¹æ®æŸ¥è¯¢åˆ°çš„æ”¯æŒçš„ modifiers å†å»åˆ›å»º buffer (BO, ä¹Ÿå³ resource)ã€‚</p>
<pre><code class="highlight mermaid">sequenceDiagram
  participant Mesa
  participant X11
  participant Glamor
  participant DDX
  participant Kernel

  Mesa -&gt;&gt; X11: xcb_dri3_get_supported_modifiers()
  Mesa -&gt;&gt; X11: xcb_dri3_get_supported_modifiers_reply()
  Kernel -&gt;&gt; DDX: drmModeGetPropertyBlob()
  DDX -&gt;&gt; Glamor: get_modifiers_set()
  Glamor -&gt;&gt; X11: glamor_get_drawable_modifiers()
  alt num_window_modifiers
    X11 -&gt;&gt; Mesa: xcb_dri3_get_supported_modifiers_window_modifiers()
  else num_screen_modifiers
    X11 -&gt;&gt; Mesa: xcb_dri3_get_supported_modifiers_screen_modifiers()
  end</code></pre>
<p><strong>modifiers</strong> é›†æ˜¯æå‰å­˜å‚¨åœ¨ä¸€ä¸ª DDX å†…éƒ¨çš„æ•°æ®ç»“æ„ä¸­çš„ï¼Œä¾‹å¦‚ xserver çš„ <strong>modesetting</strong>ï¼Œæ˜¯ä¿å­˜åœ¨ <code>drmmode_format_rec</code> ç»“æ„ä½“ä¸­çš„(å½“ç„¶å®ƒæ˜¯ä¸€ç»„)</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> format;</span><br><span class="line">    <span class="type">uint32_t</span> num_modifiers;</span><br><span class="line">    <span class="type">uint64_t</span> *modifiers;</span><br><span class="line">&#125; drmmode_format_rec, *drmmode_format_ptr;</span><br></pre></td></tr></table></figure>
<h2 id="on-xwayland"><a class="markdownIt-Anchor" href="#on-xwayland"></a> On XWayland</h2>
<h1 id="tool-drm_info"><a class="markdownIt-Anchor" href="#tool-drm_info"></a> Tool - <a href="https://gitlab.freedesktop.org/emersion/drm_info">drm_info</a></h1>
<p><strong>drm_info</strong> å¯ä»¥åˆ—ä¸¾å‡ºæ‰€æœ‰ KMS æ”¯æŒçš„ scanout modifiers (<a href="https://pastebin.com/dwhfdVDf">https://pastebin.com/dwhfdVDf</a>)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â”œâ”€â”€â”€Plane 1</span><br><span class="line">â”‚   â”œâ”€â”€â”€Object ID: 44</span><br><span class="line">â”‚   â”œâ”€â”€â”€CRTCs: &#123;0&#125;</span><br><span class="line">â”‚   â”œâ”€â”€â”€Legacy info</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€â”€FB ID: 0</span><br><span class="line">â”‚   â”‚   â””â”€â”€â”€Formats:</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€â”€YUYV (0x56595559)</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€â”€UYVY (0x59565955)</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€â”€XRGB8888 (0x34325258)</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€â”€XRGB1555 (0x35315258)</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€â”€XBGR2101010 (0x30334258)</span><br><span class="line">â”‚   â”‚       â”œâ”€â”€â”€XRGB2101010 (0x30335258)</span><br><span class="line">â”‚   â”‚       â””â”€â”€â”€XBGR16161616F (0x48344258)</span><br><span class="line">â”‚   â””â”€â”€â”€Properties</span><br><span class="line">â”‚       â”œâ”€â”€â”€&quot;type&quot; (immutable): enum &#123;Overlay, Primary, Cursor&#125; = Overlay</span><br><span class="line">â”‚       â”œâ”€â”€â”€&quot;IN_FORMATS&quot; (immutable): blob = 45</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€â”€NVIDIA_BLOCK_LINEAR_2D(h=0, k=254, g=0, s=1, c=0) (0x03000000004fe010)</span><br><span class="line">â”‚       â”‚   â”‚   â”œâ”€â”€â”€YUYV (0x56595559)</span><br><span class="line">â”‚       â”‚   â”‚   â”œâ”€â”€â”€UYVY (0x59565955)</span><br><span class="line">â”‚       â”‚   â”‚   â”œâ”€â”€â”€XRGB8888 (0x34325258)</span><br><span class="line">â”‚       â”‚   â”‚   â”œâ”€â”€â”€XRGB1555 (0x35315258)</span><br><span class="line">â”‚       â”‚   â”‚   â”œâ”€â”€â”€XBGR2101010 (0x30334258)</span><br><span class="line">â”‚       â”‚   â”‚   â”œâ”€â”€â”€XRGB2101010 (0x30335258)</span><br><span class="line">â”‚       â”‚   â”‚   â””â”€â”€â”€XBGR16161616F (0x48344258)</span><br><span class="line">â”‚       â”‚   â”œâ”€â”€â”€NVIDIA_BLOCK_LINEAR_2D(h=1, k=254, g=0, s=1, c=0) (0x03000000004fe011)</span><br></pre></td></tr></table></figure>
<h1 id="reference"><a class="markdownIt-Anchor" href="#reference"></a> Reference</h1>
<ul>
<li><a href="https://www.collabora.com/news-and-blog/news-and-events/implementing-drm-format-modifiers-in-nvk.html">Implementing DRM format modifiers in NVK</a></li>
<li><a href="https://wayland.app/protocols/linux-dmabuf-v1">Linux DMA-BUF</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>DRM/KMS</tag>
      </tags>
  </entry>
  <entry>
    <title>GPU Firmware</title>
    <url>/lnx/fw/</url>
    <content><![CDATA[<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UVD feature version: 0, firmware version: 0x40000d00</span><br><span class="line">MC feature version: 0, firmware version: 0x00a777d0</span><br><span class="line">ME feature version: 29, firmware version: 0x00000091</span><br><span class="line">PFP feature version: 29, firmware version: 0x00000054</span><br><span class="line">CE feature version: 29, firmware version: 0x0000003d</span><br><span class="line">RLC feature version: 1, firmware version: 0x00000001</span><br><span class="line">SMC feature version: 0, program: 16, firmware version: 0x10020000 (2.0.0)</span><br><span class="line">VBIOS version: 113-xxx-xxx</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p>ç°ä»£ GPU/NPU èŠ¯ç‰‡é‡Œä¸€èˆ¬éƒ½ä¼šæ­è½½å¤šä¸ªå¾®å¤„ç†å™¨(æˆ–å¾®æ§åˆ¶å™¨)ï¼Œ åƒ Intel <a href="https://docs.kernel.org/gpu/i915.html#guc">GuC</a> (uC æŒ‡ ÂµC, micro controller), AMD <a href="https://docs.kernel.org/gpu/amdgpu/driver-core.html#graphics-and-compute-microcontrollers">MEC</a>(MicroEngine Compute), NVIDIA <a href="https://download.nvidia.com/XFree86/Linux-x86_64/510.39.01/README/gsp.html">GSP</a> (GPU System Processor)ã€‚è·‘åœ¨è¿™äº›å¾®æ§åˆ¶å™¨ä¸Šçš„ä»£ç ä¸€èˆ¬ä»¥<strong>å›ºä»¶(Firmware)</strong> çš„å½¢å¼å­˜åœ¨ï¼Œå³ä½¿æ˜¯åœ¨ Linux å†…æ ¸é‡Œä¹Ÿæ˜¯äºŒè¿›åˆ¶æ ¼å¼ï¼Œæºä»£ç ä¸€èˆ¬æ˜¯ä¸å…¬å¼€çš„ï¼ŒLinux ç¤¾åŒºæœ‰ä¸€ä¸ªä¸“é—¨çš„ git tree <a href="https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git/tree/"><em>linux-firmware</em></a> æ¥ç»´æŠ¤å„ç§ç¡¬ä»¶çš„å›ºä»¶äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œè¿™äº› bin æ–‡ä»¶åœ¨ Linux ç³»ç»Ÿä¸­ä¼šå­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿï¼Œ è·¯å¾„ä¸€èˆ¬æ˜¯ <code>/lib/firmware/</code>ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ª 5.4.18-85-generic çš„ Linux å‘è¡Œç‰ˆç³»ç»Ÿä¸­ï¼Œ amdgpu å’Œ radeon çš„ gpu ip å›ºä»¶ bin æ–‡ä»¶å°±åˆ†åˆ«æœ‰ <strong>469</strong>, <strong>247</strong> ä¸ª</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="built_in">dir</span> <span class="keyword">in</span> amdgpu radeon; <span class="keyword">do</span> <span class="built_in">ls</span> /lib/firmware/<span class="variable">$dir</span> | <span class="built_in">wc</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>è€Œä¸” KMD ä¹Ÿæä¾› sys æ–‡ä»¶ç³»ç»Ÿæ¥å£å…è®¸ç”¨æˆ·æŸ¥çœ‹å›ºä»¶ä¿¡æ¯ (éœ€è¦ root æƒé™)ï¼Œ ä¾‹å¦‚ï¼Œåœ¨ AMD R7340 æ˜¾å¡æœºå™¨ä¸Šè¾“å‡ºæœ¬æ–‡å¼€å¤´çš„å›ºä»¶ä¿¡æ¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> /sys/kernel/debug/dri/0/amdgpu_firmware_info | grep -v <span class="string">&#x27;firmware version: 0x00000000&#x27;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>firmware</tag>
      </tags>
  </entry>
  <entry>
    <title>drm_gpu_scheduler</title>
    <url>/lnx/gpu-sched/</url>
    <content><![CDATA[<pre><code class="highlight mermaid">flowchart TD
  subgraph GPU
    slot-0[HW Run Queue]
    slot-1[HW Run Queue]
    slot-2[HW Run Queue]
  end

  sched0[drm_gpu_scheduler]
  sched1[drm_gpu_scheduler]
  sched2[drm_gpu_scheduler]

  runq00[drm_sched_rq&lt;br&gt;KERNEL]
  runq01[drm_sched_rq&lt;br&gt;HIGH]
  runq02[drm_sched_rq&lt;br&gt;NORMAL]
  runq03[drm_sched_rq&lt;br&gt;LOW]

  runq10[drm_sched_rq&lt;br&gt;KERNEL]
  runq11[drm_sched_rq&lt;br&gt;HIGH]

  runq20[drm_sched_rq&lt;br&gt;KERNEL]
  runq21[drm_sched_rq&lt;br&gt;HIGH]
  runq22[drm_sched_rq&lt;br&gt;NORMAL]

  entity00@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;
  entity01@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;
  entity02@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;
  entity03@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;

  entity10@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;
  entity11@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;
  entity12@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;


  entity20@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;
  entity21@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;
  entity22@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;

  entity00 --&gt; entity01 --&gt; entity02 --&gt; entity03 --&gt; runq00
  entity10 --&gt; entity11 --&gt; entity12 --&gt; runq10
  entity20 --&gt; entity21 --&gt; entity22 --&gt; runq02

  runq00 --&gt; sched0
  runq01 --&gt; sched0
  runq02 --&gt; sched0
  runq03 --&gt; sched0

  runq10 --&gt; sched1
  runq11 --&gt; sched1

  runq20 --&gt; sched2
  runq21 --&gt; sched2
  runq22 --&gt; sched2

  sched0 --&gt; slot-0
  sched1 --&gt; slot-1
  sched2 --&gt; slot-2</code></pre>
<span id="more"></span>
<p>Notes:</p>
<ul>
<li>æ¯ä¸ª hw run queue (hw ring) å¯¹åº”ä¸€ä¸ª <a href="https://elixir.bootlin.com/linux/v6.13.4/source/drivers/gpu/drm/panfrost/panfrost_job.c#L36">drm_gpu_scheduler</a></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">DRIVER</th>
<th style="text-align:left">MAX_HW_RINGS</th>
<th style="text-align:left">VALUE</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">amdgpu</td>
<td style="text-align:left">AMDGPU_MAX_RINGS</td>
<td style="text-align:left">124</td>
</tr>
<tr>
<td style="text-align:left">etnaviv</td>
<td style="text-align:left">ETNA_MAX_PIPES</td>
<td style="text-align:left">4</td>
</tr>
<tr>
<td style="text-align:left">powervr</td>
<td style="text-align:left"></td>
<td style="text-align:left">4</td>
</tr>
<tr>
<td style="text-align:left">panfrost</td>
<td style="text-align:left">NUM_JOB_SLOTS</td>
<td style="text-align:left">3</td>
</tr>
<tr>
<td style="text-align:left">v3d</td>
<td style="text-align:left">V3D_MAX_QUEUES</td>
<td style="text-align:left">6</td>
</tr>
</tbody>
</table>
<ul>
<li>æ¯ä¸ª scheduler å¯¹åº”å¤šä¸ªä¸åŒä¼˜å…ˆçº§(<code>enum drm_sched_priority</code>)çš„ scheduler run queue (sw run queue)</li>
</ul>
<p>ä½†ä¼¼ä¹å¯¹äºæœªæ¥çš„ç¡¬ä»¶ï¼Œå°¤å…¶é‚£äº›é€šè¿‡ FW/HW è°ƒåº¦ job çš„ GPU, æ›´å¸Œæœ›çš„æ‹“æ‰‘ç»“æ„æ˜¯ <a href="https://patchwork.freedesktop.org/patch/567300/">scheduler : run queue : entity æ˜¯ 1:1:1</a>. è¿™æ ·çš„ <code>drm_gpu_scheduler</code> å·²ç»é€€åŒ–æˆä¸€ä¸ª <strong>dependency tracker/resolver</strong>, æ²¡æœ‰äº†å®è´¨çš„<s>è°ƒåº¦</s>çš„ä½œç”¨ã€‚</p>
<pre><code class="highlight mermaid">flowchart TD
  subgraph GPU
    GuC[FW/HW scheduler]
    slot-0[HW Run Queue]
    slot-1[HW Run Queue]
    slot-2[HW Run Queue]
  end

  sched0[drm_gpu_scheduler]
  sched1[drm_gpu_scheduler]
  sched2[drm_gpu_scheduler]

  runq00[drm_sched_rq&lt;br&gt;KERNEL]
  runq10[drm_sched_rq&lt;br&gt;KERNEL]
  runq20[drm_sched_rq&lt;br&gt;KERNEL]

  entity00@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;
  entity10@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;
  entity20@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;

  entity00 --&gt; runq00 --&gt; sched0 --&gt; GuC --&gt; slot-0
  entity10 --&gt; runq10 --&gt; sched1 --&gt; GuC --&gt; slot-1
  entity20 --&gt; runq20 --&gt; sched2 --&gt; GuC --&gt; slot-2</code></pre>
<ul>
<li>æ¯ä¸ª scheduler run queue æ˜¯ä¸€ä¸ªå°†è¢«è°ƒåº¦çš„ entity é˜Ÿåˆ—</li>
<li><code>drm_sched_entity.sched_list</code>, ä¸€ä¸ª entity ä¸Šçš„ jobs å¯ä»¥è¢«è°ƒåº¦åˆ°è¿™ä¸ª <strong>sched_list</strong> ä¸Šçš„ä»»æ„ä¸€ä¸ª scheduler ä¸Š, å®ç°è¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡ <a href="https://elixir.bootlin.com/linux/v6.13.5/source/drivers/gpu/drm/scheduler/sched_entity.c#L539"><code>drm_sched_entity_select_rq()</code></a> å®Œæˆçš„ã€‚</li>
</ul>
<pre><code class="highlight mermaid">flowchart TD
  subgraph GPU
    slot-0[HW Run Queue]
    slot-1[HW Run Queue]
    slot-2[HW Run Queue]
  end

  sched0[drm_gpu_scheduler]
  sched1[drm_gpu_scheduler]
  sched2[drm_gpu_scheduler]

  runq00[drm_sched_rq&lt;br&gt;KERNEL]
  runq10[drm_sched_rq&lt;br&gt;KERNEL]
  runq20[drm_sched_rq&lt;br&gt;KERNEL]

  entity00@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;
  entity10@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;
  entity20@&#123;shape: docs, label: &quot;drm_sched_entity&lt;br&gt;job chain&quot;&#125;

  entity00 --&gt; runq00 --&gt; sched0 --&gt; slot-0
  entity00 -.-&gt; runq10
  entity10 --&gt; runq10 --&gt; sched1 --&gt; slot-1
  entity10 -.-&gt; runq00
  entity20 --&gt; runq20 --&gt; sched2 --&gt; slot-2</code></pre>
<ul>
<li>æ¯ä¸ª entity ç”±åŒ…å«è‹¥å¹²ä¸ª gpu job çš„é“¾è¡¨ç»„æˆ</li>
</ul>
<h1 id="æ•°æ®ç»“æ„"><a class="markdownIt-Anchor" href="#æ•°æ®ç»“æ„"></a> æ•°æ®ç»“æ„</h1>
<p>Linux DRM å­ç³»ç»Ÿçš„ <code>drm_gpu_scheduler</code> è´Ÿè´£æäº¤å’Œè°ƒåº¦ GPU jobï¼Œä»¥ä¸€ä¸ªå•ç‹¬çš„å†…æ ¸æ¨¡å—(<code>gpu-sched</code>) çš„å½¢å¼å­˜åœ¨ã€‚</p>
<h2 id="drm_gpu_scheduler"><a class="markdownIt-Anchor" href="#drm_gpu_scheduler"></a> <code>drm_gpu_scheduler</code></h2>
<p>è°ƒåº¦å™¨å®ä¾‹ (instance)ï¼Œè¿è¡Œæ—¶å®é™…ä¸Šæ˜¯ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ (kthread), è¿™ä¸ªçº¿ç¨‹å¯åŠ¨æ˜¯åœ¨ <code>drm_sched_init()</code>ã€‚</p>
<p>å®é™…ä¸Šï¼Œè‡ªä»å†…æ ¸ v6.8-rc1 <a href="https://lore.kernel.org/all/20231031032439.1558703-3-matthew.brost@intel.com/">a6149f039369 (â€œdrm/sched: Convert drm scheduler to use a work queue rather than kthreadâ€)</a> <code>drm_gpu_scheduler</code> çš„å®ç°å·²ç»ä» kthread å˜æˆ work queue äº†ã€‚ è¿™ä¸ªä¿®æ”¹ä¸ Intel Gen9+ å¼•å…¥çš„ microcontrollers (Î¼C) ä¹‹ä¸€ <a href="https://igor-blue.github.io/2021/02/10/graphics-part1.html#the-guc">GuC</a> æœ‰å…³ã€‚</p>
<h2 id="drm_sched_backend_ops"><a class="markdownIt-Anchor" href="#drm_sched_backend_ops"></a> <code>drm_sched_backend_ops</code></h2>
<p>è¿™ä¸ªç»“æ„ä½“å®šä¹‰ä¸€ç»„å›è°ƒå‡½æ•°ï¼Œä¸€èˆ¬éœ€è¦é©±åŠ¨å®ç°ï¼Œ å¹¶åœ¨ <code>drm_sched_init()</code> æ—¶ä¼ å…¥ã€‚</p>
<ul>
<li>struct dma_fence *(*prepare_job)(struct drm_sched_job *job, struct drm_sched_entity *ent);</li>
</ul>
<ul>
<li><code>struct dma_fence *(*run_job)(struct drm_sched_job *job);</code></li>
</ul>
<ul>
<li>enum drm_gpu_sched_stat (*timedout_job)(struct drm_sched_job *job);</li>
</ul>
<ul>
<li><code>void (*free_job)(struct drm_sched_job *job);</code></li>
</ul>
<ul>
<li>void (*cancel_job)(struct drm_sched_job *job);</li>
</ul>
<p><strong>NOTE:</strong></p>
<ul>
<li>run_job() å’Œ free_job() é©±åŠ¨å¿…é¡»å®ç°</li>
<li>è¿™ä¸¤ä¸ªå‡½æ•°æ˜¯ç”± kworker å¼‚æ­¥æ‰§è¡Œçš„, ä¹Ÿå°±æ˜¯åœ¨ä¸¤ä¸ª CPU æ ¸å¿ƒä¸ŠåŒæ—¶æ‰§è¡Œï¼Œå°±æœ‰å‘ç”Ÿ<strong>æ­»é”</strong>çš„å¯èƒ½ã€‚</li>
</ul>
<h2 id="drm_sched_rq"><a class="markdownIt-Anchor" href="#drm_sched_rq"></a> <code>drm_sched_rq</code></h2>
<p>è‹¥å¹²ä¸ª <code>drm_sched_entity</code> (list) çš„å°è£…ã€‚ä¸€ä¸ª scheduler å®ä¾‹æœ€å¤šå¯ä»¥æœ‰ <code>DRM_SCHED_PRIORITY_COUNT</code> ä¸ª <code>drm_sched_rq</code>ã€‚è°ƒåº¦å™¨è°ƒåº¦çš„å…¶å®å°±æ˜¯ä¸€ä¸ªä¸ª entityã€‚ è¿™ä¹ˆå¤šä¸ª entity æŒ‰ä»€ä¹ˆé¡ºåºæäº¤ç»™ GPU ç”±å…·ä½“çš„ <strong>è°ƒåº¦ç­–ç•¥ (Scheduling Policy)</strong> å†³å®šï¼Œè€Œ<strong>è°ƒåº¦ä¼˜å…ˆçº§ (Scheduling Priority)</strong> ç”± <code>drm_sched_rq</code> å®ç°ï¼Œæœ‰å¤šå°‘ä¸ªä¼˜å…ˆçº§ï¼Œä¸€ä¸ª <code>drm_gpu_scheduler</code> é‡Œå°±æœ‰å¤šå°‘ä¸ª <code>drm_sched_rq</code>ï¼Œæ¯ä¸ªä¼˜å…ˆçº§å¯¹åº”ä¸€ä¸ª <code>drm_sched_rq</code>ã€‚</p>
<h2 id="drm_sched_entity"><a class="markdownIt-Anchor" href="#drm_sched_entity"></a> <code>drm_sched_entity</code></h2>
<p>è‹¥å¹²ä¸ª <code>drm_sched_job</code> (list) çš„å°è£…</p>
<h2 id="drm_sched_job"><a class="markdownIt-Anchor" href="#drm_sched_job"></a> <code>drm_sched_job</code></h2>
<p>è¢« entity è¿è¡Œçš„ä¸€ä¸ª job, ä¸€ä¸ª job æ€»æ˜¯å±äºæŸä¸€ä¸ª entity</p>
<h2 id="drm_sched_fence"><a class="markdownIt-Anchor" href="#drm_sched_fence"></a> <a href="https://elixir.bootlin.com/linux/v6.13.5/source/include/drm/gpu_scheduler.h#L267"><code>drm_sched_fence</code></a></h2>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">drm_sched_fence</span> &#123;</span></span><br><span class="line">  <span class="comment">// job ä¸€æ—¦è¢«è°ƒåº¦äº†ï¼Œå°± signal è¿™ä¸ª fence</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dma_fence</span> <span class="title">scheduled</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// job è¢«ç¡¬ä»¶å®Œæˆäº†ï¼Œ å°± signal è¿™ä¸ª fence</span></span><br><span class="line">  <span class="comment">// å½“ä¸€ä¸ª job å®Œæˆæ—¶ï¼Œç¡¬ä»¶ä¸€èˆ¬ä¼šä¸ŠæŠ¥ä¸€ä¸ªä¸­æ–­ interrupt</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dma_fence</span> <span class="title">finished</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="type">ktime_t</span> deadline;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”±é©±åŠ¨æä¾›çš„ run_job() å›è°ƒå‡½æ•°è¿”å›çš„ fence,</span></span><br><span class="line">  <span class="comment">// ç¡¬ä»¶ä¸Š finished/done ä¸­æ–­åï¼Œä¼šå…ˆ signal è¿™ä¸ª fence</span></span><br><span class="line">  <span class="comment">// scheduler signal @scheduled fence æ—¶ï¼Œä¼šå°† sched-&gt;ops-&gt;run_job() çš„</span></span><br><span class="line">  <span class="comment">// è¿”å›å€¼èµ‹ç»™ parent</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dma_fence</span> *<span class="title">parent</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">drm_gpu_scheduler</span> *<span class="title">sched</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="type">spinlock_t</span> lock;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="type">void</span> *owner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="gpu-scheduler-ä¸­çš„å…³é”®ç»„ä»¶"><a class="markdownIt-Anchor" href="#gpu-scheduler-ä¸­çš„å…³é”®ç»„ä»¶"></a> GPU Scheduler ä¸­çš„å…³é”®ç»„ä»¶</h1>
<ul>
<li>Entity</li>
<li>Workqueue</li>
</ul>
<h2 id="drm_sched-åˆå§‹åŒ–"><a class="markdownIt-Anchor" href="#drm_sched-åˆå§‹åŒ–"></a> drm_sched åˆå§‹åŒ–</h2>
<ul>
<li>v6.8</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">drm_sched_init</span><span class="params">(</span></span><br><span class="line"><span class="params">  <span class="keyword">struct</span> drm_gpu_scheduler *sched,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">  <span class="comment">// éœ€è¦ç”±é©±åŠ¨å®ç°çš„ä¸€ç»„å›è°ƒå‡½æ•°, æœ‰</span></span></span><br><span class="line"><span class="params">  <span class="comment">// prepare_job(), run_job(), timedout_job(), free_job()</span></span></span><br><span class="line"><span class="params">  <span class="type">const</span> <span class="keyword">struct</span> drm_sched_backend_ops *ops,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">  <span class="comment">// ä¸€ä¸ª workqueue(6.8 ä¹‹å‰æ˜¯ kthread) ç”¨æ¥å‘ hw run queue æäº¤ job</span></span></span><br><span class="line"><span class="params">  <span class="comment">// å¦‚æœé©±åŠ¨æ²¡æœ‰æä¾›ï¼Œé»˜è®¤æ˜¯ä¸€ä¸ª ordered workqueue</span></span></span><br><span class="line"><span class="params">  <span class="keyword">struct</span> workqueue_struct *submit_wq, </span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">  <span class="comment">// è¿™ä¸ª sched ä¸‹çš„ drm_sched_rq çš„ä¸ªæ•°ï¼Œæœ€å¤š 4 ä¸ªï¼Œåˆ†åˆ«å¯¹åº”</span></span></span><br><span class="line"><span class="params">  <span class="comment">// LOW, NORMAL, HIGH, KERNEL 4 ä¸ªä¼˜å…ˆçº§</span></span></span><br><span class="line"><span class="params">  u32 num_rqs,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">  <span class="comment">// ç”¨æ¥ job flow control, sched æœ€å¤šèƒ½æäº¤å¤šå°‘ä¸ª job(chain) ç»™ hw,</span></span></span><br><span class="line"><span class="params">  <span class="comment">// é˜²æ­¢ ring buffer overflow</span></span></span><br><span class="line"><span class="params">  <span class="comment">// è¿™é‡Œçš„æ¯ä¸ªjob çš„æ¦‚å¿µå› ä¸åŒ GPU è€Œå¼‚</span></span></span><br><span class="line"><span class="params">  u32 credit_limit,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">  <span class="comment">// å…è®¸ä¸€ä¸ª job åœ¨è¢«ä¸¢å¼ƒå‰ hang å¤šå°‘æ¬¡</span></span></span><br><span class="line"><span class="params">  <span class="type">unsigned</span> <span class="type">int</span> hang_limit,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">  <span class="comment">// job è¶…æ—¶æ—¶é•¿ (jiffies)</span></span></span><br><span class="line"><span class="params">  <span class="type">long</span> timeout,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">  <span class="comment">// å¦å¤–ä¸€ä¸ª workqueue ç”¨æ¥æ‰§è¡Œè¶…æ—¶ä¹‹åçš„é€»è¾‘ã€‚é©±åŠ¨å¯ä»¥ä¸æŒ‡å®šï¼Œ</span></span></span><br><span class="line"><span class="params">  <span class="comment">// é»˜è®¤æ˜¯ system_wq (è®©è¿™ä¸ª workqueue æ‰§è¡Œçš„ä»»åŠ¡ä¸è¦å¤ªé•¿)</span></span></span><br><span class="line"><span class="params">  <span class="keyword">struct</span> workqueue_struct *timeout_wq,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">  <span class="type">atomic_t</span> *score, <span class="comment">// ä¸å…¶å®ƒ sched å…±äº«çš„åŸå­æ•´å‹çš„ score</span></span></span><br><span class="line"><span class="params">  <span class="type">const</span> <span class="type">char</span> *name, <span class="comment">// ç”¨æ¥è°ƒè¯•</span></span></span><br><span class="line"><span class="params">  <span class="keyword">struct</span> device *dev <span class="comment">// æ‰€å± struct device</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">drm_sched_entity_init</span><span class="params">(</span></span><br><span class="line"><span class="params">  <span class="keyword">struct</span> drm_sched_entity *entity,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">  <span class="comment">// ä¸€ä¸ª priority å¯¹åº”ä¸€ä¸ª run queue</span></span></span><br><span class="line"><span class="params">  <span class="keyword">enum</span> drm_sched_priority priority,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">  <span class="comment">// è¿™ä¸ª entity ä¸Šçš„ jobs å¯ä»¥åœ¨è¿™ç»„ schedulers ä¸­çš„ä»»æ„ä¸€ä¸ª scheduler ä¸Šè°ƒåº¦</span></span></span><br><span class="line"><span class="params">  <span class="keyword">struct</span> drm_gpu_scheduler **sched_list,</span></span><br><span class="line"><span class="params">  <span class="type">unsigned</span> <span class="type">int</span> num_sched_list,</span></span><br><span class="line"><span class="params">  <span class="type">atomic_t</span> *guilty</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"></span><br><span class="line">- v5<span class="number">.4</span></span><br><span class="line"></span><br><span class="line">```c</span><br><span class="line"><span class="type">int</span> <span class="title function_">drm_sched_init</span><span class="params">(</span></span><br><span class="line"><span class="params">  <span class="keyword">struct</span> drm_gpu_scheduler *sched,</span></span><br><span class="line"><span class="params">  <span class="comment">// éœ€è¦ç”±é©±åŠ¨å®ç°çš„ä¸€ç»„å›è°ƒå‡½æ•°ï¼Œæœ‰</span></span></span><br><span class="line"><span class="params">  <span class="comment">// dependency(), run_job(), timedout_job(), free_job()</span></span></span><br><span class="line"><span class="params">  <span class="type">const</span> <span class="keyword">struct</span> drm_sched_backend_ops *ops,</span></span><br><span class="line"><span class="params">  <span class="type">unsigned</span> hw_submission, <span class="comment">// å…è®¸æœ‰å¤šå°‘ä¸ª hw æäº¤åŒæ—¶å­˜åœ¨</span></span></span><br><span class="line"><span class="params">  <span class="type">unsigned</span> hang_limit, <span class="comment">// å…è®¸ä¸€ä¸ª job åœ¨è¢«ä¸¢å¼ƒå‰ hang å¤šå°‘æ¬¡</span></span></span><br><span class="line"><span class="params">  <span class="type">long</span> timeout, <span class="comment">// job è¶…æ—¶æ—¶é•¿ (jiffies)</span></span></span><br><span class="line"><span class="params">  <span class="type">const</span> <span class="type">char</span> *name <span class="comment">// ç”¨æ¥è°ƒè¯•</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>
<p>Note:</p>
<ul>
<li>5.4 æ²¡æœ‰è®©é©±åŠ¨æä¾›ä¸€ä¸ª timeout_wq, è€Œæ˜¯å›ºå®šä½¿ç”¨ delayable workqueue å»æ‰§è¡Œ <a href="https://elixir.bootlin.com/linux/v5.19.17/source/drivers/gpu/drm/scheduler/sched_main.c#L1016">drm_sched_job_timedout()</a></li>
<li>å‚æ•°ä¸­çš„ <code>timeout</code> æ˜¯ä»¥ jiffies è®¡ç®—çš„ï¼Œå¦‚æœè®¾ç½®æˆ <code>MAX_SCHEDULE_TIMEOUT</code>ï¼Œ è¡¨ç¤ºç”±é©±åŠ¨è‡ªå·±å¤„ç†è¶…æ—¶</li>
</ul>
<h2 id="entity-gpu-job-çš„å®¹å™¨"><a class="markdownIt-Anchor" href="#entity-gpu-job-çš„å®¹å™¨"></a> Entity - GPU job çš„å®¹å™¨</h2>
<pre><code class="highlight mermaid">sequenceDiagram
  participant Driver
  participant Scheduler
  participant Kworker

  Driver -&gt;&gt; Scheduler : drm_sched_job_init()
  Driver -&gt;&gt; Scheduler : drm_sched_job_arm(job)
  note right of Scheduler : ç»™å®šä¸€ä¸ªä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆ runqueue ä¹Ÿå°±ç¡®å®šäº†&lt;br&gt;é‚£ä¹ˆ sched å®ä¾‹ä¹Ÿå°±ç¡®å®šäº†,&lt;br&gt;é‚£ä¹ˆåœ¨å“ªä¸ªç¡¬ä»¶ slot ä¸Šæ‰§è¡Œä¹Ÿå°±ç¡®å®šäº†
  Scheduler -&gt;&gt; Scheduler : drm_sched_entity_select_rq(entity)
  note right of Driver : ä¸€æ—¦æŠŠ job push åˆ° entity queue,&lt;br&gt;è¿™ä¸ª job å°±å¯èƒ½åœ¨ä»»ä½•æ—¶é—´ç‚¹å®Œæˆè¢«é‡Šæ”¾ï¼Œ&lt;br&gt;æ‰€ä»¥åœ¨è¿™ä¸ªæ—¶é—´ç‚¹åï¼Œ&lt;br&gt;é©±åŠ¨å°±ä¸èƒ½å†è¯»å†™ job çš„ä»»ä½•å­—æ®µ
  Driver -&gt;&gt; Scheduler : drm_sched_entity_push_job(job)
  Scheduler -&gt;&gt; Scheduler : drm_sched_rq_add_entity(rq, entity)
  opt DRM_SCHED_POLICY_FIFO
    Scheduler -&gt;&gt; Scheduler : drm_sched_rq_update_fifo_locked(entity, rq, submit_timestamp)
  end
  note right of Scheduler : å”¤é†’ sched kworker çº¿ç¨‹&lt;br&gt;queue_work(submit_wq, &amp;work_run_job)
  Scheduler -&gt;&gt; Kworker : drm_sched_wakup()
  rect rgb(200, 150, 255)
    note left of Kworker : drm_sched_run_job_work()
    Kworker -&gt;&gt; Kworker : drm_sched_select_entity(sched)
    Kworker -&gt;&gt; Kworker : drm_sched_entity_pop_job(entity)
    Kworker -&gt;&gt; Kworker : sched-&gt;ops-&gt;run_job()
    Kworker -&gt;&gt; Kworker : complete_all(entity-&gt;idle)
    Kworker -&gt;&gt; Kworker : drm_sched_fence_scheduled(s_fence, fence)
    Kworker -&gt;&gt; Kworker : drm_sched_job_done(job, result)
    Kworker -&gt;&gt; Kworker : wake_up(&amp;sched-&gt;job_scheduled)
    note right of Kworker : å†æ¬¡å”¤é†’ sched kwoker çº¿ç¨‹&lt;br&gt;queue_work(submit_wq, &amp;work_run_job)
    Kworker -&gt;&gt; Kworker : drm_sched_run_job_queue()
  end</code></pre>
<h2 id="workqueue-ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ"><a class="markdownIt-Anchor" href="#workqueue-ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ"></a> Workqueue - ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ</h2>
<p>ä¸€ä¸ª <code>drm_gpu_scheduler</code> é‡ŒåŒ…æ‹¬ä¸¤ä¸ª workqueues (<a href="https://elixir.bootlin.com/linux/v6.17-rc5/source/kernel/workqueue.c#L335"><code>struct workqueue_struct</code></a>):</p>
<ul>
<li><code>timeout_wq</code></li>
<li><code>submit_wq</code></li>
</ul>
<h1 id="scheduler-å¦‚ä½•å·¥ä½œ"><a class="markdownIt-Anchor" href="#scheduler-å¦‚ä½•å·¥ä½œ"></a> Scheduler å¦‚ä½•å·¥ä½œ</h1>
<p>Job æäº¤ä¸€èˆ¬ç”±ç”¨æˆ·é©±åŠ¨é€šè¿‡ <strong>IOCTL_SUBMIT</strong> å‘½ä»¤è§¦å‘ï¼Œå°† job ä¸‹å‘ç»™ hw, æ‰€è°“ä¸‹å‘å°±æ˜¯å°† 64 ä½çš„ job(chain) çš„èµ·å§‹åœ°å€å†™å…¥ MMIO å¯„å­˜å™¨æˆ– ringbuffer, ç„¶åå†è§¦å‘ doorbell, hw å°±å¼€å§‹æ‰§è¡Œ</p>
<pre><code class="highlight mermaid">sequenceDiagram
  participant UMD
  participant KMD
  participant Kworker

  KMD -&gt;&gt; KMD : drm_sched_init()
  note right of KMD : åˆ›å»ºä¸€ä¸ª work item
  KMD -&gt;&gt; KMD : INIT_WORK(&amp;sched-&gt;work_run_job,&lt;br&gt;drm_sched_run_job_work)
  UMD -&gt;&gt; KMD : ioctl(SUBMIT)
  KMD -&gt;&gt; KMD : drm_sched_job_init()
  KMD -&gt;&gt; KMD : drm_sched_job_arm()
  KMD -&gt;&gt; KMD : drm_sched_entity_push_job()
  KMD -&gt;&gt; KMD : drm_sched_waitup()
  rect rgb(205, 228, 152)
    note left of Kworker : drm_sched_run_job_work&lt;br&gt;å³submit_wq ä¸Šçš„ work item&lt;br&gt;æ¯æ¬¡ queue_work() å…¥é˜Ÿï¼Œ&lt;br&gt;æ‰§è¡Œçº¿ç¨‹ kworker éƒ½ä¼šå¼‚æ­¥æ‰§è¡Œè¿™ä¸ªå‡½æ•°
    note right of Kworker : æ ¹æ®ä¼˜å…ˆçº§å’Œè°ƒåº¦ç­–ç•¥é€‰å®ä½“
    Kworker -&gt;&gt; Kworker : drm_sched_select_entity()
    note right of Kworker : å¼¹å‡ºä¸€ä¸ª job
    Kworker -&gt;&gt; Kworker : drm_sched_entity_pop_job()
    note right of Kworker : æ‰§è¡Œé©±åŠ¨çš„å›è°ƒå‡½æ•°
    Kworker -&gt;&gt; Kworker : sched-&gt;ops-&gt;run_job()
    note right of Kworker : å”¤é†’ drm_sched_entity_flush() æ—¶,&lt;br&gt;è¢«ç¡çœ çš„é‚£äº›è¿›ç¨‹&lt;br&gt;è¢«å”¤é†’çš„è¿›ç¨‹é‡æ–°æ£€æµ‹&lt;br&gt;drm_sched_entity_is_idle()&lt;br&gt;å¦‚æœä¸idleå°±ç»§ç»­ç¡
    Kworker -&gt;&gt; Kworker : wake_up(wait_queue_head_t)
    note right of Kworker : å…¥é˜Ÿ
    Kworker -&gt;&gt; Kworker : drm_sched_run_job_queue()
    note left of Kworker : writel(jc, dev-&gt;iomem + reg)&lt;br&gt;Go!
  end</code></pre>
<p>Note:</p>
<ul>
<li><code>drm_sched_free_job_work()</code> å’Œ <code>drm_sched_run_job_work()</code> æ˜¯åˆ†å¼€çš„ä¸¤ä¸ª work item, ä½†å®ƒä¿©éƒ½ä¼šè¢«æ‰”åˆ°åŒä¸€ä¸ª workqueue ä¸Š <code>submit_wq</code> (workqueue çš„å®ç°å¾ˆæœ‰æ„æ€ï¼Œå¼‚æ­¥æ‰§è¡Œçš„å•ä½æ˜¯å‡½æ•° (<code>work_struct</code>)ï¼Œè€Œè¿™äº›å‡½æ•°ä¼šè¢«åŠ å…¥ä¸€ä¸ªå†…æ ¸å·¥ä½œé˜Ÿåˆ— (<code>workqueue_struct</code>) é‡Œ<strong>å¼‚æ­¥æ‰§è¡Œ</strong> (ç”± kworker å†…æ ¸çº¿ç¨‹æ‰§è¡Œ)ï¼Œåªè¦é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåå°çº¿ç¨‹ä»¬å°±æŠŠå®ƒä»¬æ‹¿å‡ºæ¥<strong>å¹¶å‘åœ°</strong>æ‰§è¡Œ (CMWQ). åå°çº¿ç¨‹æ˜¯ä¸€ä¸ªç”±å†…æ ¸è‡ªåŠ¨ç®¡ç†çš„çº¿ç¨‹æ± ï¼Œå”¤é†’å’Œç¡çœ ä¸éœ€è¦ä½¿ç”¨è€…å¹²é¢„ï¼Œä½¿ç”¨è€…(æ¯”æ–¹ GPU Scheduler)åªéœ€è¦è°ƒç”¨ <code>queue_work(&amp;workqueue_struct, &amp;work_struct)</code> å°† work åŠ åˆ°ç›¸åº”çš„ workqueue å°±è¡Œäº†</li>
<li>å†…æ ¸ workqueue API æä¾›ä¸¤ä¸ª work å…¥é˜Ÿå‡½æ•° (enqueue):<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">queue_work</span><span class="params">(<span class="keyword">struct</span> workqueue_struct *wq, <span class="keyword">struct</span> work_struct *work)</span>;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">schedule_work</span><span class="params">(<span class="keyword">struct</span> work_struct *work)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>å‰è€…æ˜¯å°† workitem æ”¾åˆ°ç”¨æˆ·è‡ªå®šä¹‰çš„ workqueue; åè€…æ˜¯å°† workitem æ”¾å…¥ä¸€ä¸ªå…¨å±€ workqueue <code>system_wq</code>ã€‚</li>
<li><code>system_wq</code> ç­‰å…¨å±€ workqueue çš„æ‰§è¡Œçº¿ç¨‹ kworker çš„å‘½åä¸€èˆ¬æ˜¯ <code>kworker/CPU#:POOL#[FLAG]-events</code><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root          64      64       2  0 Sep02 ?        00:00:00 [kworker/7:0H-events_highpri]</span><br><span class="line">root        3264    3264       2  0 Sep04 ?        00:00:06 [kworker/2:0-events]</span><br></pre></td></tr></table></figure>
</li>
<li>å› ä¸º GPU scheduler çš„ <code>submit_wq</code> æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ workqueue, æ‰€ä»¥å®ƒè°ƒç”¨çš„æ˜¯ <code>queue_work()</code>ï¼Œè€Œå®é™…ä¸Šæœ‰å¾ˆå¤šé©±åŠ¨ä¼šå°†ä¸€äº› workitems ç›´æ¥æ”¾å…¥å…¨å±€ workqueue <code>system_wq</code></li>
</ul>
</li>
<li><code>drm_sched_&#123;run,free&#125;_job_work()</code> åœ¨å“ªä¸ª <strong>kworker</strong> ä¸Šè¿è¡Œå¯ä»¥<a href="https://www.kernel.org/doc/html/v4.14/core-api/workqueue.html#debugging">é€šè¿‡ debugfs æ¥æŸ¥çœ‹</a>
<ul>
<li><code>echo workqueue:workqueue_queue_work &gt; /sys/kernel/debug/tracing/set_event</code></li>
<li><code>cat /sys/kernel/debug/tracing/trace_pipe &gt; out.txt</code></li>
</ul>
</li>
<li>å¦‚æœç”¨æˆ·åœ¨åˆå§‹åŒ– <code>drm_gpu_scheduler</code> æ—¶æ²¡æœ‰ä¼ å…¥è‡ªå·±åˆ›å»ºçš„ WQ, é‚£ä¹ˆå†…æ ¸ä¼šé»˜è®¤åˆ›å»ºä¸€ä¸ª <strong>ordered workqueue</strong> å¹¶å°†å…¶èµ‹ç»™ <code>drm_gpu_scheduler::submit_wq</code>, ordered workqueue ä¿è¯äº†å…ˆå…¥é˜Ÿçš„å‡½æ•°ä¸€å®šå…ˆæ‰§è¡Œ, é€šå¸¸ <code>drm_sched_run_job_work()</code> ä¼šå…ˆå…¥é˜Ÿ, è€Œ <code>drm_sched_free_job_work()</code> åå…¥é˜Ÿï¼Œè¿™ä¹Ÿæ­£å¥½ç¬¦åˆæ­£å¸¸çš„æ‰§è¡Œé€»è¾‘ã€‚</li>
</ul>
<h1 id="å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#å‚è€ƒèµ„æ–™"></a> å‚è€ƒèµ„æ–™</h1>
<ul>
<li><a href="https://patchwork.freedesktop.org/patch/567839/">drm/scheduler: improve GPU scheduler documentation v2</a></li>
<li><a href="https://www.cnblogs.com/yaongtime/p/14305463.html">linux DRM GPU scheduler ç¬”è®°</a></li>
<li><a href="https://patchwork.freedesktop.org/patch/297644/">drm/panfrost: Add initial panfrost driver</a></li>
<li><a href="https://pastebin.com/MssJk6Ky">drivers/gpu ä¸‹çš„ <code>drm_sched_backend_ops</code></a></li>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/blob/f8d2b42ae65c2f16f36a43e0ae39d288431e4263/src/imagination/csbgen/rogue_kmd_stream.xml">PowerVR Rogue Command Stream format</a></li>
<li><a href="https://www.cnblogs.com/jimbo17/p/8885814.html">Linux kernel workqueue æœºåˆ¶åˆ†æ</a></li>
<li><a href="https://cloud.tencent.com/developer/article/2441413">å¼‚æ­¥å¤„ç†çš„å¼ºåŠ›åŠ©æ‰‹ï¼šLinux Workqueue æœºåˆ¶è¯¦è§£</a></li>
<li><a href="http://www.wowotech.net/irq_subsystem/workqueue.html">Concurrency Managed Workqueueä¹‹ï¼ˆä¸€ï¼‰ï¼šworkqueueçš„åŸºæœ¬æ¦‚å¿µ</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>DRM/KMS</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸­æ–­ä¸Šä¸‹æ–‡èƒ½ç¡çœ å—?</title>
    <url>/lnx/irq/</url>
    <content><![CDATA[<h1 id="æ²¡æœ‰-task_struct-çš„-isr"><a class="markdownIt-Anchor" href="#æ²¡æœ‰-task_struct-çš„-isr"></a> æ²¡æœ‰ task_struct çš„ ISR</h1>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œä¸­æ–­ä¸Šä¸‹æ–‡ä¸èƒ½ç¡çœ ï¼Œä½†æ˜¯è¿™å¥è¯ç»†è¯´èµ·æ¥ï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šå€¼å¾—æ·±ç©¶çš„åœ°æ–¹ã€‚æ‰€è°“ä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œå°±æ˜¯ä¸­æ–­è§¦å‘åï¼Œæ‰§è¡Œä¸­æ–­æœåŠ¡ä¾‹ç¨‹ (Interrupt Service Routine/Interrupt Handler) çš„èµ„æºï¼Œè¿™äº›èµ„æºæœ‰å“ªäº›å‘¢ï¼Ÿå°‘å¾—å¯æ€œï¼Œé™¤äº†æ‰§è¡Œ ISR ä»£ç çš„ CPU æ ¸å¿ƒå¤–ï¼Œä¸­æ–­ä¸Šä¸‹æ–‡ç”šè‡³éƒ½æ²¡æœ‰<strong>è‡ªå·±çš„æ ˆ</strong>æ¥ä¿å­˜ä¸´æ—¶å˜é‡ï¼Œæ‰€æœ‰çš„èµ„æºéƒ½æ˜¯æŠ¢å ä¸­æ–­è§¦å‘æ—¶é‚£ä¸ªè¿›ç¨‹çš„ï¼Œæ˜¾ç„¶ä¸èƒ½è®©è¿™ç§â€œ<strong>æŠ¢å </strong>â€æŒç»­å¤ªä¹…ï¼Œæ‰€ä»¥ Linux å°† ISR åˆ†æˆäº† <strong>top half</strong> å’Œ <strong>bottom half</strong> ä¸¤éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯<strong>ç¡¬ä»¶ä¸­æ–­ä¸Šä¸‹æ–‡</strong>å’Œ<strong>è½¯ä»¶ä¸­æ–­ä¸Šä¸‹æ–‡</strong>ï¼Œ æ‰€ä»¥ä¸¥æ ¼æ¥è¯´æ˜¯ï¼Œåœ¨ Linux å†…æ ¸ä¸­ï¼Œ<strong>ç¡¬ä»¶ä¸­æ–­ä¸Šä¸‹æ–‡ä¸èƒ½ç¡çœ </strong>ã€‚</p>
<span id="more"></span>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="http://www.wowotech.net/irq_subsystem/workqueue.html">Concurrency Managed Workqueueä¹‹ï¼ˆä¸€ï¼‰ï¼šworkqueueçš„åŸºæœ¬æ¦‚å¿µ</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux Kernel Debugging</title>
    <url>/lnx/kernel-debug/</url>
    <content><![CDATA[<table>
<thead>
<tr>
<th style="text-align:left">Distro</th>
<th style="text-align:left">Ubuntu</th>
<th style="text-align:left">Arch Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">source</td>
<td style="text-align:left"><a href="git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/jammy">git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/jammy</a></td>
<td style="text-align:left"><a href="git@github.com:archlinux/linux.git">git@github.com:archlinux/linux.git</a></td>
</tr>
<tr>
<td style="text-align:left">initrd</td>
<td style="text-align:left"><code>sudo mkinitramfs -o /boot/initrd.img-KERNELVERSION KERNELVERSION</code></td>
<td style="text-align:left"><code>sudo mkinitcpio --generate /boot/initramfs-KERNELVERSION.img --kernel KERNELVERSION</code></td>
</tr>
<tr>
<td style="text-align:left">grub</td>
<td style="text-align:left"><code>sudo update-grub</code></td>
<td style="text-align:left"><code>sudo grub-mkconfig -o /boot/grub/grub.cfg</code></td>
</tr>
</tbody>
</table>
<ul>
<li><code>KERNELVERSION</code> æ˜¯ <code>make kernelrelease</code> çš„è¾“å‡ºï¼ŒåŒæ—¶ä¹Ÿæ˜¯ <code>sudo make modules_install</code> æ—¶åœ¨ <code>/lib/modules</code> åˆ›å»ºçš„ç›®å½•å</li>
</ul>
<span id="more"></span>
<h1 id="ç¼–è¯‘å†…æ ¸"><a class="markdownIt-Anchor" href="#ç¼–è¯‘å†…æ ¸"></a> ç¼–è¯‘å†…æ ¸</h1>
<ul>
<li>é…ç½®å†…æ ¸æœ€ç®€å•çš„æ–¹æ³•æ˜¯ <code>make olddefconfig</code></li>
<li>å†…æ ¸é…ç½®ä¿å­˜åœ¨ .config</li>
<li>å†…æ ¸æºç æ ‘é‡ŒåŒ…å«å‘½ä»¤è¡Œä¿®æ”¹ .config çš„è„šæœ¬ scripts/config</li>
<li>å†…æ ¸æ„å»ºä¾èµ– flex, bison è¯æ³•åˆ†æç¨‹åº</li>
</ul>
<h2 id="ubuntu"><a class="markdownIt-Anchor" href="#ubuntu"></a> Ubuntu</h2>
<ul>
<li>Environment</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">configuration</th>
<th style="text-align:left">version</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">distro</td>
<td style="text-align:left">Ubuntu 22.04 Jammy Jellyfish</td>
</tr>
<tr>
<td style="text-align:left">gcc</td>
<td style="text-align:left">11.2.0</td>
</tr>
<tr>
<td style="text-align:left">original kernel</td>
<td style="text-align:left">5.15.0-43-generic</td>
</tr>
<tr>
<td style="text-align:left">building kernel</td>
<td style="text-align:left">v6.0</td>
</tr>
</tbody>
</table>
<ul>
<li>Compilation Errors</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">Errors</th>
<th style="text-align:left">Need to do</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">gelf.h: No such file or directory</td>
<td style="text-align:left">apt install libelf-dev</td>
</tr>
<tr>
<td style="text-align:left">&lt;openssl/opensslv.h&gt;: No such file or directory</td>
<td style="text-align:left">apt install libssl-dev</td>
</tr>
<tr>
<td style="text-align:left">No rule to make target â€˜debian/canonical-certs.pemâ€™</td>
<td style="text-align:left">./scripts/config --set-str SYSTEM_TRUSTED_KEYS â€œâ€</td>
</tr>
<tr>
<td style="text-align:left">No rule to make target â€˜debian/canonical-revoked-certs.pemâ€™</td>
<td style="text-align:left">./scripts/config --set-str SYSTEM_REVOCATION_KEYS â€œâ€</td>
</tr>
</tbody>
</table>
<h2 id="windows-subsytem-for-linux"><a class="markdownIt-Anchor" href="#windows-subsytem-for-linux"></a> Windows Subsytem for Linux</h2>
<ul>
<li>.config</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">make KCONFIG_CONFIG=Microsoft/config-wsl</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>Compilation Errors<br />
<a href="https://blog.csdn.net/qq_36393978/article/details/124274364">è¿™æ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„ä¾èµ–é—®é¢˜</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  LD      vmlinux.o</span><br><span class="line">  MODPOST vmlinux.symvers</span><br><span class="line">  MODINFO modules.builtin.modinfo</span><br><span class="line">  GEN     modules.builtin</span><br><span class="line">BTF: .tmp_vmlinux.btf: pahole (pahole) is not available</span><br><span class="line">Failed to generate BTF for vmlinux</span><br><span class="line">Try to disable CONFIG_DEBUG_INFO_BTF</span><br><span class="line">make: *** [Makefile:1218: vmlinux] Error 1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="å®‰è£…å†…æ ¸"><a class="markdownIt-Anchor" href="#å®‰è£…å†…æ ¸"></a> å®‰è£…å†…æ ¸</h1>
<p>å®‰è£…å†…æ ¸åŒ…æ‹¬ 4 éƒ¨åˆ†ï¼š</p>
<ul>
<li>å®‰è£… vmlinuz, ä¹Ÿå°±æ˜¯å‹ç¼©æ ¼å¼çš„å†…æ ¸ ELF é•œåƒ <code>make install</code>
<ul>
<li><code>make install</code> æœ€ç»ˆè¦ä¹ˆè°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„å®‰è£…è„šæœ¬ï¼Œè¦ä¹ˆè°ƒç”¨å†…æ ¸æºç æ ‘é‡Œçš„ <code>install.sh</code> è„šæœ¬<br />
<img src="/images/kernel-build/install.png" alt="" /></li>
</ul>
</li>
<li>å®‰è£… modules, <code>make modules_install</code></li>
<li>åˆ¶ä½œ initramdisk (æˆ–è€…å« initramfs) åˆå§‹åŒ–å†…å­˜ç›˜ï¼Œå®ƒé‡Œé¢ä¼šåŒ…å«å¿…è¦çš„ modules</li>
<li>æ›´æ–° grub, ä»¥ä¾¿å¯åŠ¨æ—¶å¯ä»¥é€‰æ‹©æ–°å†…æ ¸</li>
</ul>
<h2 id="ubuntu-2"><a class="markdownIt-Anchor" href="#ubuntu-2"></a> Ubuntu</h2>
<h2 id="windows-subsystem-for-linux"><a class="markdownIt-Anchor" href="#windows-subsystem-for-linux"></a> Windows Subsystem for Linux</h2>
<ul>
<li>
<p><code>mv arch/x86/boot/bzImage /mnt/c/Users/luc/</code></p>
</li>
<li>
<p><a href="https://falco.org/blog/falco-wsl2-custom-kernel/">ç¼–è¾‘ /mnt/c/Users/luc/.wslconfig</a>, æ·»åŠ ä¸‹é¢ä¸¤è¡Œ</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[wsl2]</span><br><span class="line">kernel=C:\\Users\\luc\\bzImage</span><br></pre></td></tr></table></figure>
<blockquote>
<p>NOTE: å¦‚æœ<a href="https://devblogs.microsoft.com/commandline/automatically-configuring-wsl/">ä»¥ä¸Šä¸¤è¡Œæ·»åŠ è¿› /etc/wsl.conf æ–‡ä»¶ï¼Œä¸ä¼šæœ‰ä»»ä½•ä½œç”¨</a>, å› ä¸º <code>/etc/wsl.conf</code> ä¸æ”¯æŒ <code>wsl2</code> Section</p>
</blockquote>
<ul>
<li>é…ç½®å®Œæˆåï¼Œé‡å¯ WSL Ubuntu 20.04, æ–°ç¼–è¯‘çš„å†…æ ¸å°†ç”Ÿæ•ˆã€‚ä¸è¦ç”¨ <code>wsl --terminate</code>.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wsl --shutdown Ubuntu-20.04</span><br></pre></td></tr></table></figure>
<h1 id="ç¼–è¯‘å·¥å…·"><a class="markdownIt-Anchor" href="#ç¼–è¯‘å·¥å…·"></a> ç¼–è¯‘å·¥å…·</h1>
<p>å†…æ ¸æºç æ ‘ä¸­ <code>tools</code> ç›®å½•ä¸‹åŒ…å«äº†ç›¸å½“æœ‰ç”¨çš„å·¥å…·ï¼Œåƒ perf, objtool ç­‰ç­‰ï¼Œå¯ä»¥é€šè¿‡ <code>make tools/help</code> æŸ¥çœ‹å®Œæ•´å·¥å…·åˆ—è¡¨ã€‚ä»¥æ„å»ºå®‰è£… perf ä¸ºä¾‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">make tools/perf</span><br><span class="line"><span class="built_in">sudo</span> make -C tools/perf install prefix=/usr</span><br></pre></td></tr></table></figure>
<p>å¯¹äºä¿®æ”¹å®‰è£…è·¯å¾„, <code>prefix</code> å’Œ <code>DESTDIR</code> å˜é‡éƒ½å¯ä»¥ï¼Œä½† PREFIX ä¸è¡Œã€‚</p>
<h1 id="è°ƒè¯•å†…æ ¸"><a class="markdownIt-Anchor" href="#è°ƒè¯•å†…æ ¸"></a> è°ƒè¯•å†…æ ¸</h1>
<h2 id="ä¸è°ƒè¯•ç›¸å…³çš„å†…æ ¸é…ç½®"><a class="markdownIt-Anchor" href="#ä¸è°ƒè¯•ç›¸å…³çš„å†…æ ¸é…ç½®"></a> ä¸è°ƒè¯•ç›¸å…³çš„å†…æ ¸é…ç½®</h2>
<h3 id="config_debug_fs"><a class="markdownIt-Anchor" href="#config_debug_fs"></a> CONFIG_DEBUG_FS</h3>
<h4 id="å¦‚ä½•åœ¨-wsl2-ä¸Šå¯ç”¨-debugfs"><a class="markdownIt-Anchor" href="#å¦‚ä½•åœ¨-wsl2-ä¸Šå¯ç”¨-debugfs"></a> å¦‚ä½•åœ¨ WSL2 ä¸Šå¯ç”¨ debugfs</h4>
<p>ç¡®è®¤ä¸‹å†…æ ¸æ˜¯å¦å¼€å¯äº† debugfs</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">zcat /proc/config.gz | grep CONFIG_DEBUG_FS</span><br></pre></td></tr></table></figure>
<p>è¦æƒ³ä½¿ç”¨ debugfsï¼Œé¦–å…ˆè¦æŒ‚è½½å®ƒåˆ° <code>/sys/kernel/debug</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mount -t debugfs none /sys/kernel/debug/</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæƒ³è®©æŒ‚è½½åœ¨ç³»ç»Ÿé‡å¯åè‡ªåŠ¨æŒ‚è½½ï¼Œåœ¨ <code>/etc/fstab</code> åŠ ä¸‹é¢ä¸€è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">debugfs     /sys/kernel/debug       debugfs defaults        0 0</span><br></pre></td></tr></table></figure>
<p>åœ¨æ·»åŠ åï¼Œæ‰§è¡Œ <code>mount -a</code> å‘½ä»¤å°†çœ‹åˆ° <code>/sys/kernel/debug</code> æ–‡ä»¶ç³»ç»Ÿçš„å†…å®¹, <code>/sys/kernel/debug</code> ç›®å½•çš„æƒé™æ˜¯ 700, åªæœ‰ root ç”¨æˆ·æ‰èƒ½è¿›å…¥ï¼Œsudo ä¹Ÿä¸è¡Œ</p>
<h3 id="config_tracing"><a class="markdownIt-Anchor" href="#config_tracing"></a> CONFIG_TRACING</h3>
<p>CONFIG_TRACING æ˜¯å†…æ ¸ 2.6.27 (2008-10-09)* å¼•å…¥çš„ä¸€ä¸ª<strong>ä¸å¯é…ç½®çš„(not configurable)</strong> å†…æ ¸é€‰é¡¹ï¼Œæ‰€è°“<strong>ä¸å¯é…ç½®</strong>çš„æ„æ€æ˜¯è¿™ä¸ª CONFIG <strong>ä¸èƒ½ç›´æ¥</strong>ç”±ç”¨æˆ·æ‰“å¼€æˆ–å…³é—­ï¼Œå®ƒçš„å¼€å¯ä¸å¦åªèƒ½ç”±å…¶å®ƒä¾èµ–å®ƒçš„é€‰é¡¹çš„çŠ¶æ€å†³å®šã€‚</p>
<p>å®ƒå¯¹åº”çš„ <strong>tracefs</strong> ä¹Ÿéœ€è¦æŒ‚è½½</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mount -t tracefs none /sys/kernel/tracing</span><br></pre></td></tr></table></figure>
<p>åƒ <strong>ftrace</strong>, <strong>trace-cmd</strong> éƒ½éœ€è¦æŒ‚è½½è¿™ä¸ªç›®å½•ã€‚</p>
<h4 id="tracers"><a class="markdownIt-Anchor" href="#tracers"></a> tracers</h4>
<p>è¦ä½¿ç”¨ <strong>ftrace</strong>, ä¸å…‰è¦æŒ‚è½½ tracefs, å†…æ ¸ç›¸åº”çš„è¿½è¸ªå™¨ (tracer) ä¹Ÿè¦ç¼–è¯‘è¿›å†…æ ¸ï¼Œå¯ç”¨çš„å†…æ ¸è¿½è¸ªå™¨å¯ä»¥é€šè¿‡ <code>cat /sys/kernel/tracing/available_tracers</code> æŸ¥çœ‹ã€‚</p>
<ul>
<li>CONFIG_FUNCTION_TRACER</li>
<li>CONFIG_FUNCTION_GRAPH_TRACER</li>
<li>CONFIG_HWLAT_TRACER</li>
<li>CONFIG_IRQSOFF_TRACER</li>
<li>CONFIG_OSNOISE_TRACER</li>
<li>CONFIG_PREEMPT_TRACER</li>
<li>CONFIG_SCHED_TRACER</li>
<li>CONFIG_STACK_TRACER</li>
<li>CONFIG_CONTEXT_SWITCH_TRACER</li>
<li>CONFIG_NOP_TRACER</li>
</ul>
<h4 id="ftrace"><a class="markdownIt-Anchor" href="#ftrace"></a> ftrace</h4>
<p>ftrace å¸¸ç”¨çš„æœ‰ä¸¤ç§ï¼š<strong>åŸºäº function çš„</strong>å’Œ<strong>åŸºäº event çš„</strong></p>
<ul>
<li>åŸºäº function
<ul>
<li><code>cat available_tracers</code> æŸ¥çœ‹æœ‰å“ªäº› tracers</li>
<li><code>echo function_graph &gt; current_tracer</code> ä» <code>available_tracers</code> ä¸­é€‰æ‹©ä¸€ä¸ª tracer</li>
<li><code>echo xxxxx &gt; set_graph_function</code> ä» <code>available_filter_functions</code> ä¸­é€‰æ‹©å‡ ä¸ª functions</li>
<li><code>echo 1 &gt; tracing_on</code> å¯åŠ¨ trace</li>
<li><code>cat trace</code> æˆ– <code>cat trace_pipe</code> æŸ¥çœ‹ç»“æœ</li>
</ul>
</li>
<li>åŸºäº event
<ul>
<li><code>cat available_events</code> æŸ¥çœ‹æœ‰å“ªäº› events</li>
<li><code>echo amdgpu:amdgpu_sched_run_job &gt; set_event</code> æ·»åŠ  event
<ul>
<li><code>echo amdgpu:amdgpu_device_wreg &gt;&gt; set_event</code> ç»§ç»­è¿½åŠ  event</li>
</ul>
</li>
<li><code>echo 1 &gt; tracing_on</code> å¯åŠ¨ trace</li>
<li><code>cat trace</code> æˆ– <code>cat trace_pipe</code> æŸ¥çœ‹ç»“æœ</li>
</ul>
</li>
</ul>
<p>ä»¥ä¸Šæ“ä½œå‡éœ€è¦ <strong>root æƒé™</strong>ï¼Œ åœ¨ç›®å½• <strong><code>/sys/kernel/debug/tracing</code></strong> ä¸‹æ‰§è¡Œ</p>
<h4 id="trace-cmd"><a class="markdownIt-Anchor" href="#trace-cmd"></a> trace-cmd</h4>
<p><strong>trace-cmd</strong> å®é™…ä¸Šæ˜¯ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ <strong>ftrace</strong>, æ¯”æ–¹ä¸‹é¢çš„ trace-cmd å‘½ä»¤ä¸ç›´æ¥ <code>cat /sys/kernel/tracing/available_events</code> æ˜¯ç­‰ä»·çš„</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">trace-cmd list -e</span><br></pre></td></tr></table></figure>
<h3 id="config_ikconfig_proc"><a class="markdownIt-Anchor" href="#config_ikconfig_proc"></a> CONFIG_IKCONFIG_PROC</h3>
<p>è¿™ä¸ªé…ç½®å†³å®š <code>/proc/config.gz</code> æ˜¯å¦å­˜åœ¨ã€‚Ubuntu ä¼¼ä¹é»˜è®¤å…³é—­æ­¤é…ç½®ï¼Œè€Œæ˜¯å°†å†…æ ¸ config ä¿å­˜åœ¨ <code>/boot/config-$(uname -r)</code></p>
<h3 id="config_dynamic_debug"><a class="markdownIt-Anchor" href="#config_dynamic_debug"></a> CONFIG_DYNAMIC_DEBUG</h3>
<p>æ‰“å¼€ <strong>Dynamic Debug</strong> æœ‰å¥½å‡ ç§ï¼Œä½†å‰æéƒ½æ˜¯ <code>CONFIG_DYNAMIC_DEBUG=y</code></p>
<h4 id="æ–¹æ³•ä¸€è¿è¡Œæ—¶æ‰“å¼€"><a class="markdownIt-Anchor" href="#æ–¹æ³•ä¸€è¿è¡Œæ—¶æ‰“å¼€"></a> æ–¹æ³•ä¸€ï¼šè¿è¡Œæ—¶æ‰“å¼€</h4>
<p>Dynamic Debug å°±é€šè¿‡ <code>/sys/kernel/debug/dynamic_debug/control</code> æ–‡ä»¶æ‰“å¼€æˆ–å…³é—­ç‰¹å®šæ–‡ä»¶çš„æŸè¡Œæˆ–å‡½æ•°é‡Œçš„æ‰“å°ï¼Œä½†å®ƒåªå¯¹ä½¿ç”¨</p>
<ul>
<li><code>pr_debug()</code></li>
<li><code>dev_dbg()</code></li>
<li><code>print_hex_dump_debug()</code></li>
<li><code>print_hex_dump_bytes()</code></li>
</ul>
<p>è¿™ 4 ä¸ªå‡½æ•°çš„æ‰“å°æ¥æœ‰ç”¨ã€‚</p>
<h4 id="æ–¹æ³•äºŒå†…æ ¸å¯åŠ¨å‚æ•°"><a class="markdownIt-Anchor" href="#æ–¹æ³•äºŒå†…æ ¸å¯åŠ¨å‚æ•°"></a> æ–¹æ³•äºŒï¼šå†…æ ¸å¯åŠ¨å‚æ•°</h4>
<ul>
<li>æŒ‰ <code>file</code> æ‰“å¼€ dynamic debug</li>
</ul>
<p><span style="background-color: yellow; padding: 4px;">dyndbg=&quot;file arch/x86/pci/* +p&quot;</span></p>
<p>è¿™ä¸ªå¯åŠ¨å‚æ•°ä¼šæ‰“å¼€ <code>arch/x86/pci</code> ç›®å½•ä¸‹æ‰€æœ‰ dynamic debug æ‰“å°ï¼Œå¦‚æœé€šè¿‡ä¿®æ”¹ <code>/etc/default/grub</code> é‡Œçš„ <code>GRUB_CMDLINE_LINUX</code>, éœ€è¦å¯¹åŒå¼•å·è¿›è¡Œè½¬ä¹‰</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX=&quot;dyndbg=\&quot;file arch/x86/pci/* +p\&quot;&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>æŒ‰ <code>module</code> æ‰“å¼€ dynamic debug</li>
</ul>
<p><span style="background-color: yellow; padding: 4px;">dyndbg=&quot;module i915 +p&quot;</span></p>
<p>å¦‚æœè¦åŒæ—¶å°† <code>arch/x86/pci/</code> ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å’Œå†…æ ¸æ¨¡å— <code>i915</code> çš„ dynamic debug éƒ½æ‰“å¼€</p>
<p><span style="background-color: yellow; padding: 4px;">dyndbg=&quot;file arch/x86/pci/* +p;module i915 +p&quot;</span></p>
<h4 id="æ–¹æ³•ä¸‰etcmodprobedxxxconf"><a class="markdownIt-Anchor" href="#æ–¹æ³•ä¸‰etcmodprobedxxxconf"></a> æ–¹æ³•ä¸‰ï¼š/etc/modprobe.d/xxx.conf</h4>
<p>ç”±äº <code>dyndbg=</code> å†…æ ¸å‚æ•°ä¸€èˆ¬åœ¨å†…æ ¸æ¨¡å—åŠ è½½å‰å°±è§£æäº†ï¼Œæ‰€ä»¥å¯¹äºæŒ‰æ¨¡å—æ‰“å¼€ dynamic debug æ¥è¯´ï¼Œåœ¨ <code>/etc/modprobe.d/i915-debug.conf</code> æ–‡ä»¶ä¸­è®¾ç½®æ›´ä¿é™©</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">options i915 dyndbg=+p</span><br></pre></td></tr></table></figure>
<h3 id="config_drm_use_dynamic_debug"><a class="markdownIt-Anchor" href="#config_drm_use_dynamic_debug"></a> <code>CONFIG_DRM_USE_DYNAMIC_DEBUG</code></h3>
<p>è¿™æ˜¯å†…æ ¸ 6.1 (2022-12-11) æ‰å¼•å…¥çš„ä¸“é—¨æ§åˆ¶ <code>drm_dbg()</code> æ˜¯å¦ç”¨ <strong>Dynamic Debug</strong> æ¥å®ç°çš„å¯é…ç½®é€‰é¡¹ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_DRM_USE_DYNAMIC_DEBUG)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drm_dev_dbg(dev, cat, fmt, ...)				\</span></span><br><span class="line"><span class="meta">	__drm_dev_dbg(NULL, dev, cat, fmt, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> drm_dev_dbg(dev, cat, fmt, ...)				\</span></span><br><span class="line"><span class="meta">	_dynamic_func_call_cls(cat, fmt, __drm_dev_dbg,		\</span></span><br><span class="line"><span class="meta">			       dev, cat, fmt, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h3 id="config_debug_atomic_sleep"><a class="markdownIt-Anchor" href="#config_debug_atomic_sleep"></a> <code>CONFIG_DEBUG_ATOMIC_SLEEP</code></h3>
<p><a href="https://www.kernel.org/doc/html/latest/driver-api/dma-buf.html?highlight=dma_fence_wait_timeout#c.dma_fence_wait_timeout"><code>dma_fence_wait_timeout()</code></a> ä¼šç¡çœ è°ƒç”¨è¿›ç¨‹ç›´åˆ° fence è¢« signaled æˆ–è€…æŒ‡å®šå®šæ—¶å™¨è¶…æ—¶ã€‚è¯¥å‡½æ•°ä¸­ä¼šè°ƒç”¨ <code>might_sleep()</code> æ¥æ ‡è¯† (annotation) è°ƒç”¨è¿›ç¨‹å¯èƒ½è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œå¹¶æ‰“å°æºæ–‡ä»¶åå’Œè¡Œå·ï¼Œå¸®åŠ©è°ƒè¯•ã€‚ ä½†åªæœ‰å†…æ ¸é…ç½®äº† <code>CONFIG_DEBUG_ATOMIC_SLEEP</code> æ‰æœ‰æ•ˆï¼Œå¦åˆ™ <code>__might_sleep()</code> æ˜¯ä¸€ä¸ªç©ºå‡½æ•°ã€‚</p>
<h2 id="kernlog"><a class="markdownIt-Anchor" href="#kernlog"></a> kern.log</h2>
<p><code>/var/log/kern.log</code> çš„ä¸€ä¸ªä¸»è¦é—®é¢˜æ˜¯æ¯è¡Œå‰é¢çš„ <code>%HOSTNAME%</code> å¤ªé•¿åˆæ²¡ä»€ä¹ˆç”¨ï¼Œ<code>%timegenerated%</code> å’Œå†…æ ¸åŸå§‹æ‰“å° <code>%msg%</code> é‡Œçš„æ—¶é—´æˆ³å®é™…ä¸Šæœ‰ä¸€ä¸ªå°±å¯ä»¥äº†ã€‚æŸ¥äº†ä¸€ä¸‹é…ç½®æ–¹æ³•ï¼Œå®é™…ä¸Šå°±æ˜¯è¦åœ¨ <code>/etc/rsyslog.conf</code> é‡Œå®šä¹‰ä¸€ä¸ª <code>$template</code>, å¹¶æŒ‡å®šä¸ºé»˜è®¤çš„æ¨¡æ¿</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$template SimpleFormat,&quot;%timegenerated:::date-rfc3339% %msg:::drop-last-lf%\n&quot;</span><br><span class="line">$ActionFileDefaultTemplate SimpleFormat</span><br></pre></td></tr></table></figure>
<p>æˆ–åœ¨ <code>/etc/rsyslog.d/50-default.conf</code> é‡Œçš„ <code>kern.*</code> è§„åˆ™ä¸­åŠ ä¸Šè¿™ä¸ª template</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kern.* -/var/log/kern.log;SimpleFormat</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œä¸è¦ç›´æ¥åœ¨ <code>/etc/rsyslog.conf</code> é‡Œç›´æ¥åŠ ä¸Šé¢è¿™æ¡è§„åˆ™ï¼Œè¦åŠ åœ¨ <code>/etc/rsyslog.d/50-default.conf</code>ï¼Œ å¦åˆ™ä¼šè¾“å‡ºä¸¤éã€‚</p>
<p>æœ€åï¼Œå°±æ˜¯è¦é‡å¯ rsyslog æœåŠ¡ç”Ÿæ•ˆã€‚</p>
<p>å†…æ ¸çš„ log å®é™…ä¸Šéƒ½æ˜¯å†™å…¥ä¸€ä¸ª ring buffer é‡Œçš„ï¼Œæš´éœ²ç»™ç”¨æˆ·çš„æ¥å£æ˜¯ <code>/proc/kmsg</code> å’Œ <code>/dev/kmsg</code>, rsyslog æœåŠ¡ä¹Ÿæ˜¯é€šè¿‡è¿™äº›æ¥å£ï¼Œé‡æ–°å¤„ç† log åå†™å…¥ <code>/var/log/kern.log</code> çš„ã€‚ä¸‹é¢çš„æ“ä½œå¯ä»¥è®© <code>dmesg</code> å¤šä¸€æ¡ log</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo &quot;&lt;3&gt;HELLO&quot; &gt; /dev/kmsg</span><br></pre></td></tr></table></figure>
<h2 id="sysctl-å’Œå†…æ ¸å‚æ•°"><a class="markdownIt-Anchor" href="#sysctl-å’Œå†…æ ¸å‚æ•°"></a> <code>sysctl</code> å’Œå†…æ ¸å‚æ•°</h2>
<p>è¿è¡Œæ—¶å†…æ ¸å‚æ•°å¤§å¤šåœ¨ <code>/proc/sys/</code> ç›®å½•ä¸‹ï¼ŒäºŒè¿›åˆ¶ç¨‹åº <code>/usr/sbin/sysctl</code> å¯ç”¨æ¥æŸ¥çœ‹ï¼Œä¿®æ”¹è¿™äº›å†…æ ¸å‚æ•°ã€‚</p>
<ul>
<li>æŸ¥çœ‹æŸä¸ªå†…æ ¸å‚æ•°çš„å€¼
<ul>
<li><code>sysctl kernel.perf_event_paranoid</code></li>
</ul>
</li>
<li>åˆ—å‡ºæ‰€æœ‰å†…æ ¸å‚æ•°çš„å€¼ (æœ‰äº›éœ€è¦ root æƒé™)
<ul>
<li><code>sysctl -a</code></li>
</ul>
</li>
<li>ä¿®æ”¹æŸä¸ªå†…æ ¸å‚æ•°çš„å€¼
<ul>
<li><code>sysctl kernel.perf_event_paranoid=-1</code></li>
</ul>
</li>
</ul>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://wiki.ubuntu.com/Kernel/SourceCode">https://wiki.ubuntu.com/Kernel/SourceCode</a></li>
<li><a href="https://wiki.archlinux.org/title/Installation_guide">https://wiki.archlinux.org/title/Installation_guide</a></li>
<li><a href="https://access.redhat.com/solutions/5914171">https://access.redhat.com/solutions/5914171</a></li>
<li><a href="https://www.kernel.org/doc/html/v4.14/admin-guide/dynamic-debug-howto.html">Dynamic Debug Howto</a></li>
<li><a href="https://www.rsyslog.com/how-to-bind-a-template/">How to bind a template in rsyslog.conf</a></li>
<li><a href="https://www.rsyslog.com/doc/configuration/properties.html#message-properties">Rsyslog properties</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>Nouveau</title>
    <url>/lnx/nouveau/</url>
    <content><![CDATA[<p><img src="/images/nouveau/nvidia-gpu-generation.dot.png" alt="" /></p>
<span id="more"></span>
<p><img src="/images/nouveau/benchmarks-on-gp108.png" alt="" /></p>
<h1 id="reference"><a class="markdownIt-Anchor" href="#reference"></a> Reference</h1>
<ul>
<li><a href="https://insujang.github.io/2017-04-27/gpu-architecture-overview/">GPU Architecture Overview</a></li>
<li><a href="https://blog.csdn.net/Linux_Everything/article/details/127780944">LWN: NVIDIA GPU å’Œ Nouveau</a></li>
<li><a href="https://en.wikipedia.org/wiki/List_of_Nvidia_graphics_processing_units">List of Nvidia GPUs</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>Atomic Mode Setting è®¾è®¡æ¦‚è¦ ç¬¬ä¸€éƒ¨åˆ† ï¼ˆè¯‘ï¼‰</title>
    <url>/lnx/kms/</url>
    <content><![CDATA[<p>æœ¬æ–‡ç¿»è¯‘ Daniel Vetter äº 2015 å¹´ 8 æœˆ 5 æ—¥å‘è¡¨åœ¨ <a href="http://LWN.net">LWN.net</a> çš„æ–‡ç«  â€œAtomic mode setting design overview, part 1â€. æ–‡ç« ä¸»è¦é˜è¿°äº†ä¸ºä»€ä¹ˆè¦å¼•å…¥ä¸€ä¸ªå…¨æ–°çš„ Kernel Display Driver æ¥å£ä»¥åŠæ–°è€å®ç°çš„ä¸€äº›ç»†èŠ‚ã€‚</p>
<span id="more"></span>
<p>è¿‡å»å‡ å¹´[1], ä¸¤å¤§è¶‹åŠ¿äº§ç”Ÿäº†å¯¹ä¸€ä¸ªå…¨æ–°çš„ Kernel Display Driver æ¥å£çš„éœ€è¦ã€‚ä¸€æ–¹é¢ï¼Œäººä»¬ä¸å†æ¬£èµéƒ¨åˆ†é‡ç»˜å’Œçª—å£æ’•è£‚å½“ä»–ä»¬çš„å›¾å½¢ç•Œé¢æœ‰ä»»ä½•å˜åŒ–çš„æ—¶å€™ã€‚åƒ Wayland è¿™æ ·çš„æ–°çš„åˆæˆå™¨(compositor) å®£ç§° â€œevery frame is perfectâ€. å¦ä¸€æ–¹é¢ï¼Œå‡ºç°äº†å¾ˆå¤šç”µæ± ä¾›ç”µçš„æ‰‹æœºå’Œå¹³æ¿, è¿™äº›è®¾å¤‡è™½ç„¶æœ‰å¤æ‚ç»šä¸½çš„å›¾å½¢ç•Œé¢ï¼Œä½†ä¹Ÿæœ‰ä¸¥é‡çš„åŠŸè€—é™åˆ¶ã€‚è¿™å¯¼è‡´äº†ä¸€ç³»åˆ—ç‰¹æ®Šç”¨é€”çš„æ˜¾ç¤ºç¡¬ä»¶çš„çˆ†å‘ï¼Œä»¥å¸®åŠ©ç›¸å¯¹è€—ç”µé‡è¾ƒé«˜ä½†æ›´é€šç”¨çš„GPUåœ¨åˆæˆå±å¹•å†…å®¹æ—¶å‘æŒ¥ä½œç”¨ã€‚å°†è¿™äº›è¶‹åŠ¿ç»“åˆèµ·æ¥ï¼Œéœ€è¦ä»¥ä¸€ç§å…¨æˆ–æ— (all-or-nothing)çš„åŸå­æ–¹å¼æ›´æ–°å¤§é‡æ˜¾ç¤ºç¡¬ä»¶çŠ¶æ€ï¼Œä»¥ç¡®ä¿æ¯ä¸€å¸§éƒ½æ˜¯å®Œç¾çš„ï¼Œå¹¶å°½å¯èƒ½åœ°ä½¿ç”¨åŠŸè€—ä¼˜åŒ–çš„ç¡¬ä»¶ã€‚</p>
<p>ç»è¿‡å‡ å¹´çš„å¼€å‘åï¼ŒDRM å­ç³»ç»Ÿçš„ atomic display é©±åŠ¨ ioctl() ç»ˆäºåœ¨é»„é‡‘æ—¶é—´(prime time)å‡†å¤‡å¥½äº†ã€‚</p>
<p><a href="https://lwn.net/Articles/653071/">é˜…è¯»åŸæ–‡</a></p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>DRM/KMS</tag>
      </tags>
  </entry>
  <entry>
    <title>æ­»é”æ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼Ÿ</title>
    <url>/lnx/mpin/</url>
    <content><![CDATA[<h1 id="èƒŒæ™¯ä»‹ç»"><a class="markdownIt-Anchor" href="#èƒŒæ™¯ä»‹ç»"></a> èƒŒæ™¯ä»‹ç»</h1>
<p>ä¹‹å‰ä¸€ç›´æœ‰ä¸€ä¸ªç–‘é—®ï¼š<a href="https://www.kernel.org/doc/html/latest/driver-api/dma-buf.html#dma-fence-cross-driver-contract">ä¸ºä»€ä¹ˆåœ¨ drm_gpu_sheduler çš„ run_job è·¯å¾„é‡Œå¸¦ GFP_KERNEL æ ‡å¿—çš„å†…å­˜ç”³è¯·å¯ä»¥é€ æˆæ­»é”?</a>, ç›´åˆ°äº†è§£å†…æ ¸å†…å­˜ <strong>Pin</strong> å’Œ <strong>Shrink</strong> çš„æœºåˆ¶åï¼Œå¥½åƒæ˜¯æ˜ç™½äº†æ­»é”çš„è¿‡ç¨‹ã€‚</p>
<span id="more"></span>
<h1 id="å†…å­˜-pin"><a class="markdownIt-Anchor" href="#å†…å­˜-pin"></a> å†…å­˜ Pin</h1>
<p>Linux æ˜¯åŸºäºé¡µ (page) æ¥ç®¡ç†å†…å­˜çš„ï¼Œç‰©ç†å†…å­˜é¡µå’Œè™šæ‹Ÿå†…å­˜é¡µä¸€èˆ¬æœ‰ç›¸åŒçš„å¤§å°ï¼Œæ¯”è¾ƒå¸¸è§çš„æ˜¯ 4KB é¡µå¤§å°ã€‚</p>
<p><img src="/images/mpin/L2PageTables.png" alt="Paging mechanism" /></p>
<h1 id="å†…å­˜-reclaim"><a class="markdownIt-Anchor" href="#å†…å­˜-reclaim"></a> å†…å­˜ Reclaim</h1>
<p>å†…å­˜é¡µå›æ”¶æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>direct reclaim (åŒæ­¥)</li>
</ul>
<p>direct reclaim æ˜¯æŒ‡åœ¨å†…å­˜åˆ†é…æ—¶ï¼Œå¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œç›´æ¥è§¦å‘å†…å­˜å›æ”¶ï¼Œè¿™æ—¶å†…å­˜ç”³è¯·è°ƒç”¨æ˜¯ä¼šè¢«<strong>é˜»å¡çš„</strong>ã€‚</p>
<ul>
<li>background reclaim (å¼‚æ­¥)</li>
</ul>
<p>background reclaim æ˜¯æŒ‡ kswapd çº¿ç¨‹è¢«å”¤é†’å¼‚æ­¥åœ°æ‰«æ Zone å›æ”¶å†…å­˜ã€‚</p>
<h1 id="å†…å­˜-shrink"><a class="markdownIt-Anchor" href="#å†…å­˜-shrink"></a> å†…å­˜ Shrink</h1>
<p>ä¸ºäº†èƒ½å¤ŸåŠ¨æ€çš„å›æ”¶å†…å­˜ï¼Œå†…æ ¸æä¾›äº†ä¸€å¥— â€œshrinkerâ€ æ¥å£ï¼Œé€šè¿‡è¯¥æœºåˆ¶ï¼Œå†…å­˜ç®¡ç†å­ç³»ç»Ÿ (mm) å¯ä»¥é€šè¿‡<strong>å›è°ƒ</strong>çš„æ–¹å¼å›æ”¶éƒ¨åˆ†å†…å­˜é¡µï¼Œä»¥å‡å°ç³»ç»Ÿå†…å­˜å‹åŠ›ã€‚</p>
<p>æ ¹æ®æ–‡ç«  <a href="https://blog.csdn.net/weixin_49382066/article/details/130704158">Linuxå†…æ ¸é¡µå›æ”¶</a> ä¸­çš„æè¿°ï¼Œæ— è®ºæ˜¯ direct reclaim è¿˜æ˜¯ kswapd, æœ€ç»ˆéƒ½ä¼šè°ƒåˆ° <code>shrink_node()</code>ï¼Œ è€Œ <code>shrink_node()</code> åˆæ˜¯å¦‚ä½•è°ƒåˆ°ç”±å…¶å®ƒæ–‡ä»¶ç³»ç»Ÿæˆ–é©±åŠ¨æ³¨å†Œçš„ shrinker çš„é’©å­å‡½æ•°çš„å‘¢ï¼Ÿ</p>
<pre><code class="highlight mermaid">flowchart TD
    A[&quot;shrink_node()&quot;]
    B[&quot;lru_gen_shrink_node()&quot;]
    C[&quot;shrink_many()&quot;]
    D[&quot;shrink_one()&quot;]
    E[&quot;shrink_slab()&quot;]
    F[&quot;do_shrink_slab()&quot;]
    G[&quot;`shrinker-&gt;count_objects()
    shrinker-&gt;scan_objects()`&quot;]

    A --&gt; B --&gt; C --&gt; D
    B -- mem_cgroup_disabled() --&gt; D
    D --&gt; E --&gt; F --&gt; G</code></pre>
<h1 id="gfp_kernel"><a class="markdownIt-Anchor" href="#gfp_kernel"></a> GFP_KERNEL</h1>
<p>å¸¦æœ‰ <code>GFP_KERNEL</code> æ ‡å¿—çš„å†…å­˜ç”³è¯·æ—¢å¯ä»¥è§¦å‘ direct reclaim, ä¹Ÿå¯ä»¥è§¦å‘ background reclaimã€‚å¦‚æœ direct reclaim è¢«è§¦å‘ï¼Œå›è°ƒæ³¨å†Œçš„ shrinker å›è°ƒå‡½æ•°ï¼Œè€Œè¿™ä¸ªå›è°ƒå‡½æ•°å¯ä»¥å®ç°ä»»ä½•é€»è¾‘(å–å†³äºå®ç°è¿™ä¸ª shrinker çš„æ–‡ä»¶ç³»ç»Ÿæˆ–é©±åŠ¨)ï¼Œå¦‚æœè¿™ä¸ªé€»è¾‘æ°å¥½æ˜¯åœ¨<strong>ç­‰å¾…æŸä¸ª GPU job çš„ dma_fence è¢« signaled</strong>, è€Œä½ åˆæ­£å¥½æ˜¯åœ¨ kick off è¿™ä¸ª GPU job æ—¶è§¦å‘çš„ direct reclaim, è¿™æ ·æ˜¯ä¸æ˜¯å°±æ­»é”äº†ï¼Ÿ</p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://weedge.github.io/perf-book-cn/zh/chapters/3-CPU-Microarchitecture/3-7_Virtual_memory_cn.html">Performance Analysis And Tuning On Modern CPUs</a></li>
<li><a href="https://lwn.net/Articles/600502/">Locking and pinning</a></li>
<li><a href="https://tinylab.org/lwn-550463/">Smarter Shrinker</a></li>
<li><a href="https://www.kernel.org/doc/html/next/core-api/memory-allocation.html#gfp-flags-and-reclaim-behavior">GFP flags and reclaim behavior</a></li>
<li><a href="https://blog.csdn.net/weixin_49382066/article/details/130704158">Linuxå†…æ ¸é¡µå›æ”¶</a></li>
<li><a href="https://github.com/freelancer-leon/notes/blob/master/kernel/graphic/Linux-Graphic.md">freelancer-leonâ€™s notes</a></li>
<li><a href="https://en.wikipedia.org/wiki/Direct_Rendering_Manager#Graphics_Execution_Manager">GEM wikipedia</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>DRM/KMS</tag>
      </tags>
  </entry>
  <entry>
    <title>openKylin 2.0</title>
    <url>/lnx/ok/</url>
    <content><![CDATA[<h1 id="openkylin-20"><a class="markdownIt-Anchor" href="#openkylin-20"></a> <a href="https://www.openkylin.top/">OpenKylin 2.0</a></h1>
<p><img src="/images/ok/ok2.0.png" alt="ok2.0" /></p>
<span id="more"></span>
<h1 id="realtek-rtl8188gu-80211n-wlan-adapter"><a class="markdownIt-Anchor" href="#realtek-rtl8188gu-80211n-wlan-adapter"></a> Realtek RTL8188GU 802.11n WLAN Adapter</h1>
<p>ç³»ç»Ÿå®‰è½¬å¥½åç¬¬ä¸€ä»¶äº‹å°±æ˜¯è” WiFi, ä¸ºæ­¤è´­ä¹°äº†ç‘æ˜±çš„ä¸€æ¬¾æ— çº¿ç½‘å¡ã€‚ä½†æ˜¯è¿™æ¬¾æ— çº¿ç½‘å¡åœ¨ Linux ä¸Šæ²¡æœ‰å¾—åˆ°ç‘æ˜±å®˜æ–¹çš„æ”¯æŒ(æ²¡é©±åŠ¨)ï¼Œ æ‰€ä»¥åœ¨ Github ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ª<a href="https://github.com/fastoe/RTL8811CU">é©±åŠ¨ä»“åº“</a>ï¼Œ(ç”±äºå†…æ ¸ç‰ˆæœ¬çš„é—®é¢˜ï¼Œç¨åŠ æ”¹åŠ¨å) ç¼–è¯‘æˆåŠŸï¼Œå±…ç„¶å¯ä»¥ç”¨</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="comment">diff --git a/os_dep/linux/usb_intf.c b/os_dep/linux/usb_intf.c</span></span><br><span class="line"><span class="comment">index b8eea5b..1d5d52d 100644</span></span><br><span class="line"><span class="comment">--- a/os_dep/linux/usb_intf.c</span></span><br><span class="line"><span class="comment">+++ b/os_dep/linux/usb_intf.c</span></span><br><span class="line"><span class="meta">@@ -281,11 +281,7 @@</span> struct rtw_usb_drv usb_drv = &#123;</span><br><span class="line"> 	.usbdrv.supports_autosuspend = 1,</span><br><span class="line"> #endif</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-#if (LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2, 6, 19))</span></span><br><span class="line"><span class="deletion">-	.usbdrv.drvwrap.driver.shutdown = rtw_dev_shutdown,</span></span><br><span class="line"><span class="deletion">-#else</span></span><br><span class="line"> 	.usbdrv.driver.shutdown = rtw_dev_shutdown,</span><br><span class="line"><span class="deletion">-#endif</span></span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> static inline int RT_usb_endpoint_dir_in(const struct usb_endpoint_descriptor *epd)</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯é©±åŠ¨å®‰è£…åï¼Œè¿˜æ˜¯æ— æ³•è¿æ¥ Wifi, çœ‹åˆ°è®¾å¤‡ä¿¡æ¯åé¢æœ‰ <strong>Driver CDROM Mode</strong>, å°±æƒ³ç”¨ <a href="https://www.draisberghof.de/usb_modeswitch/">usb_modeswitch</a> æ”¹ä¸€ä¸‹ USB Mode è¯•è¯•</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</span><br><span class="line">Bus 001 Device 002: ID 046d:c534 Logitech, Inc. Unifying Receiver</span><br><span class="line">Bus 001 Device 008: ID 0bda:1a2b Realtek Semiconductor Corp. RTL8188GU 802.11n WLAN Adapter (Driver CDROM Mode)</span><br><span class="line">Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub</span><br></pre></td></tr></table></figure>
<p><code>sudo ./usb_modeswitch -KW -v 0bda -p 1a2b</code> å</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</span><br><span class="line">Bus 001 Device 002: ID 046d:c534 Logitech, Inc. Unifying Receiver</span><br><span class="line">Bus 001 Device 009: ID 0bda:c811 Realtek Semiconductor Corp. 802.11ac NIC</span><br><span class="line">Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub</span><br></pre></td></tr></table></figure>
<p>ä»å†…æ ¸æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ‰§è¡Œ <code>usb_modeswitch</code> å‘½ä»¤æ—¶ï¼Œå†…æ ¸é‡æ–°è¿æ¥äº†è¯¥æ— çº¿ç½‘å¡, ä¹‹åæ— çº¿ç½‘å¡å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼Œ Nice!</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">usb 1-5: USB disconnect, device number 8</span><br><span class="line">usb 1-5: new high-speed USB device number 9 using xhci_hcd</span><br><span class="line">usb 1-5: New USB device found, idVendor=0bda, idProduct=c811, bcdDevice= 2.00</span><br><span class="line">usb 1-5: New USB device strings: Mfr=1, Product=2, SerialNumber=3</span><br><span class="line">usb 1-5: Product: 802.11ac NIC</span><br><span class="line">usb 1-5: Manufacturer: Realtek</span><br><span class="line">usb 1-5: SerialNumber: 123456</span><br></pre></td></tr></table></figure>
<h1 id="openssh"><a class="markdownIt-Anchor" href="#openssh"></a> OpenSSH</h1>
<p>å®‰è£… <strong>openssh-server</strong> å <code>sudo systemctl start sshd</code> å¯åŠ¨å¤±è´¥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Unpacking openssh-server (1:8.2p1-ok3) ...</span><br><span class="line">Setting up openssh-sftp-server (1:8.2p1-ok3) ...</span><br><span class="line">Setting up openssh-server (1:8.2p1-ok3) ...</span><br><span class="line">WARNING: tempfile is deprecated; consider using mktemp instead.</span><br><span class="line">rescue-ssh.target is a disabled or a static unit, not starting it.</span><br><span class="line">Job for ssh.service failed because the control process exited with error code.</span><br><span class="line">See &quot;systemctl status ssh.service&quot; and &quot;journalctl -xeu ssh.service&quot; for details.</span><br><span class="line">invoke-rc.d: initscript ssh, action &quot;start&quot; failed.</span><br><span class="line">â— ssh.service - OpenBSD Secure Shell server</span><br><span class="line">     Loaded: loaded (/usr/lib/systemd/system/ssh.service; enabled; preset: enabled)</span><br><span class="line">     Active: activating (auto-restart) (Result: exit-code) since Sun 2025-06-22 13:51:52 CST; 8ms ago</span><br><span class="line">       Docs: man:sshd(8)</span><br><span class="line">             man:sshd_config(5)</span><br><span class="line">    Process: 8103 ExecStartPre=/usr/sbin/sshd -t (code=exited, status=255/EXCEPTION)</span><br><span class="line">        CPU: 5ms</span><br><span class="line">dpkg: error processing package openssh-server (--configure):</span><br><span class="line"> installed openssh-server package post-installation script subprocess returned error exit status 1</span><br><span class="line">Processing triggers for man-db (2.9.1-ok3) ...</span><br><span class="line">Errors were encountered while processing:</span><br><span class="line"> openssh-server</span><br><span class="line">E: Sub-process /usr/bin/dpkg returned an error code (1)</span><br><span class="line">âœ  ~ /usr/sbin/sshd -t</span><br><span class="line">OpenSSL version mismatch. Built against 30000080, you have 30200010</span><br><span class="line">âœ  ~ openssl --version</span><br><span class="line">OpenSSL 3.2.1 30 Jan 2024 (Library: OpenSSL 3.2.1 30 Jan 2024)</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæŠ¥é”™å¥½åƒæ˜¯è¯´ <code>openssh-server/sshd</code> ç¼–è¯‘æ—¶é“¾æ¥çš„ OpenSSL ç‰ˆæœ¬æ˜¯ <strong>3.0.8</strong>, è€Œç°åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸Šçš„ OpenSSL ç‰ˆæœ¬æ˜¯ <strong>3.2.1</strong>ã€‚ç„¶åæŸ¥äº†ä¸€ä¸‹ OpenSSL çš„åŒ…æƒ…å†µ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  Secure Sockets Layer toolkit - shared libraries</span><br><span class="line"></span><br><span class="line">libssl1.1/yangtze,now 1.1.1f-ok3 amd64 [installed,automatic]</span><br><span class="line">  Secure Sockets Layer toolkit - shared libraries</span><br><span class="line"></span><br><span class="line">libssl3/yangtze 3.0.8-ok4.1 amd64 [residual-config]</span><br><span class="line">  Secure Sockets Layer toolkit - shared libraries</span><br><span class="line"></span><br><span class="line">libssl3t64/now 3.2.1-ok5 amd64 [installed,local]</span><br><span class="line">  Secure Sockets Layer toolkit - shared libraries</span><br></pre></td></tr></table></figure>
<p>OpenSSL æŒ‰ç…§å®˜æ–¹æ–‡æ¡£ï¼Œè½»æ¾å¯ä»¥ç¼–è¯‘å®‰è£…ï¼Œä½†åˆ‡è®°<strong>ä¸è¦è¦†ç›–ç³»ç»ŸåŸæ¥çš„ OpenSSL, å¦åˆ™æ¡Œé¢å¯èƒ½è¿›ä¸å»</strong>ã€‚OpenSSL å®‰è£…å¥½åå¯ä»¥</p>
<ul>
<li>å°†å®‰è£…ç›®å½• <code>/usr/local/ssl/lib64</code> å†™å…¥ <code>/etc/ld.so.conf.d/x86_64-linux-gnu.conf</code>ã€‚</li>
<li>å°† bin ç›®å½• <code>/usr/local/ssl/bin</code> åŠ å…¥ <strong>PATH</strong></li>
<li>åœ¨ç¼–è¯‘ OpenSSH ä¹‹å‰ <code>export PKG_CONFIG_PATH=/usr/local/ssl/lib64/pkgconfig</code></li>
</ul>
<p>OK 2.0 æºé‡Œçš„ openssh-server ç‰ˆæœ¬æ˜¯ 8.2p1ï¼Œ å®é™…ä¸Šç¼–è¯‘æ—¶å‘ç°è¿™ä¸ªç‰ˆæœ¬å’Œ OpenSSL 3.2.1 æ˜¯<strong>ä¸å…¼å®¹</strong>çš„ï¼Œ æ‰€ä»¥éšä¾¿æŠŠ openssh-server çš„ç‰ˆæœ¬å‡äº†å‡ï¼Œ é€‰æ‹©äº† <strong>V_9_2_P1</strong> è¿™ä¸ªç‰ˆæœ¬ï¼Œå¯ä»¥ç¼–è¯‘æˆåŠŸ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./configure --prefix=/usr --without-zlib-version-check --with-ssl-dir=/usr/local/ssl</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨è¿è¡Œ <code>/usr/sbin/sshd</code> ä¸ä¼šå†æŠ¥ <strong>OpenSSL version mismatch</strong> çš„é”™è¯¯äº†ã€‚Nice</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">âœ  openssh-portable git:(9.2p1) âœ— /usr/sbin/sshd</span><br><span class="line">sshd: no hostkeys available -- exiting.</span><br><span class="line">âœ  openssh-portable git:(9.2p1) âœ— openssl version</span><br><span class="line">OpenSSL 3.2.1 30 Jan 2024 (Library: OpenSSL 3.2.1 30 Jan 2024)</span><br></pre></td></tr></table></figure>
<h1 id="install-trace-cmd"><a class="markdownIt-Anchor" href="#install-trace-cmd"></a> Install trace-cmd</h1>
<p>è¿˜ç®—é¡ºåˆ©ï¼Œå¤§éƒ¨åˆ†ä¾èµ–åŒ…ä»ç³»ç»Ÿ apt æºé‡Œéƒ½èƒ½å®‰è£…ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›é—®é¢˜</p>
<ul>
<li><code>/usr/lib64/pkgconfig</code> æ²¡æœ‰åœ¨ <code>pkg-config</code> é»˜è®¤çš„ search paths é‡Œ
<ul>
<li><code>export PKG_CONFIG_PTH=/usr/lib64/pkgconfig</code> å¯è§£å†³æ„å»ºé—®é¢˜</li>
</ul>
</li>
<li><code>/usr/lib64</code> æ²¡æœ‰åœ¨ <code>ld.so</code> çš„é»˜è®¤çš„ search paths é‡Œ
<ul>
<li><code>/etc/ld.so.conf.d/x86_64-linux-gnu.conf</code> é‡Œå¢åŠ  <code>/usr/lib64</code> å¯è§£å†³è¿è¡Œæ—¶æ‰¾ä¸åˆ° shared library çš„é—®é¢˜</li>
</ul>
</li>
<li>å› ä¸º xmlto çš„ä¾èµ–é—®é¢˜æ— æ³•å®‰è£…ï¼Œå¹¸å¥½å®ƒåªæ˜¯ç”¨æ¥æ„å»º Documentation, é€šè¿‡ <code>-Ddoc=false</code> ä¸æ„å»ºå°±å¯ä»¥ç»§ç»­ä¸‹å»</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">Dependency</th>
<th style="text-align:center">Apt Install</th>
<th style="text-align:left">Problem</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">meson</td>
<td style="text-align:center">âˆš</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">cmake</td>
<td style="text-align:center">âˆš</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">asciidoc</td>
<td style="text-align:center">âˆš</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">xmlto</td>
<td style="text-align:center">âˆ…</td>
<td style="text-align:left">docbook unmet</td>
</tr>
<tr>
<td style="text-align:left">flex</td>
<td style="text-align:center">âˆš</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">bison</td>
<td style="text-align:center">âˆš</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">libaudit-dev</td>
<td style="text-align:center">âˆš</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h1 id="install-apitrace"><a class="markdownIt-Anchor" href="#install-apitrace"></a> Install apitrace</h1>
<p>apitrace ä¸å¸¦ GUI çš„è¯å¯ä»¥éå¸¸é¡ºåˆ©çš„å®‰è£…ï¼Œå¸¦ GUI çš„è¯å› ä¸ºä¾èµ– Qt5/6, ç¨å¾®éº»çƒ¦ä¸€ç‚¹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if (ENABLE_GUI)</span><br><span class="line">    if (NOT (ENABLE_GUI STREQUAL &quot;AUTO&quot;))</span><br><span class="line">        set (REQUIRE_GUI REQUIRED)</span><br><span class="line">    endif ()</span><br><span class="line">    if (POLICY CMP0020)</span><br><span class="line">        cmake_policy (SET CMP0020 NEW)</span><br><span class="line">    endif()</span><br><span class="line">    if (ENABLE_QT6)</span><br><span class="line">        find_package (Qt6 COMPONENTS Widgets Network $&#123;REQUIRE_GUI&#125;)</span><br><span class="line">    else ()</span><br><span class="line">        find_package (Qt5 5.15 COMPONENTS Widgets Network $&#123;REQUIRE_GUI&#125;)</span><br><span class="line">    endif ()</span><br><span class="line">endif ()</span><br></pre></td></tr></table></figure>
<h2 id="install-qt"><a class="markdownIt-Anchor" href="#install-qt"></a> Install Qt</h2>
<p>ä¸€å¼€å§‹é€šè¿‡ <a href="https://www.qt.io/download-qt-installer-oss">qt-online-installer-linux-x64-4.8.1.run</a> å®‰è£… Qt 6.8, å®‰è£…å cmake <code>find_package</code> è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå°±åªèƒ½æºç å®‰è£… <a href="https://download.qt.io/archive/qt/5.15/">qt 5.15.16</a></p>
<ul>
<li><code>mkdir -p /opt/Qt5.15</code></li>
<li><code>mkdir -p ~/qt-build</code></li>
<li><code>cd ~/qt-build</code></li>
<li><code>~/qt-everywhere-src-5.15.16/configure -prefix /opt/Qt5.15</code></li>
<li><code>make -j $(nproc)</code></li>
<li><code>sudo make install</code></li>
</ul>
<p>Qt 5.15.16 å®‰è£…å®Œæˆåå°±å¯ä»¥ç»§ç»­å®‰è£… qapitrace äº†</p>
<ul>
<li><code>cd ~/apitrace</code></li>
<li><code>cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_MODULE_PATH=/opt/Qt5.15/lib/pkgconfig</code></li>
<li><code>sudo cmake --install build</code></li>
</ul>
<p>å¯æƒœå®‰è£…åè¿è¡Œ <code>qapitrace glxgears.trace</code> æŠ¥æ®µé”™è¯¯ï¼Œéš¾é“æ˜¯ Qt çš„ç‰ˆæœ¬å¤ªé«˜äº†?</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UKUIStylePlugin.........</span><br><span class="line">QObject::connect: No such slot UKUIStylePlugin::tableModeChanged(bool)</span><br><span class="line">BlurHelper00000.............</span><br><span class="line">m_cfgPath... &quot;/usr/share/qt5-ukui-platformtheme/themeconfig/default.json&quot;</span><br><span class="line">æ®µé”™è¯¯</span><br></pre></td></tr></table></figure>
<p>å°† <code>/opt/Qt5.15/lib</code> æ·»åŠ åˆ° ld.so.conf ååˆæŠ¥å‡ºä¸‹é¢çš„é”™è¯¯, æç¤º Qt ç¼ºå°‘ <strong>wayland, xcb platform plugin</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">qt.qpa.plugin: Could not find the Qt platform plugin &quot;wayland&quot; in &quot;&quot;</span><br><span class="line">qt.qpa.plugin: Could not find the Qt platform plugin &quot;xcb&quot; in &quot;&quot;</span><br><span class="line">This application failed to start because no Qt platform plugin could be initialized. Reinstalling the application may fix this problem.</span><br><span class="line"></span><br><span class="line">Available platform plugins are: eglfs, linuxfb, minimal, minimalegl, offscreen, vnc, webgl.</span><br><span class="line"></span><br><span class="line">å·²æ”¾å¼ƒ</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥æ£€æŸ¥ç¼–è¯‘é…ç½®ï¼Œå‘ç° <strong>QPA backends</strong> ä¸­çš„ EGLFS è™½ç„¶æ‰“å¼€äº†ï¼Œä½† EGLFS details é‡Œæ‰€æœ‰çš„åç«¯ä¸€ä¸ªä¹Ÿæ²¡æœ‰æ‰“å¼€ï¼Œ é˜…è¯» <a href="https://doc.qt.io/qt-6/embedded-linux.html#eglfs">EGLFS çš„æ–‡æ¡£</a> åäº†è§£åˆ° EGLFS ä¼¼ä¹æ˜¯è¿è¡Œåœ¨ EGL å’Œ OpenGL ES 2.0 ä¹‹ä¸Šï¼Œ ä½† <strong>Qt Gui</strong> é‡Œçš„ OpenGL ES 2.0/3.0/3.1/3.2 éƒ½æ²¡æœ‰å¼€å¯ï¼Œ è¿˜æœ‰ <strong>XCB Xlib</strong> ä¹Ÿæ²¡æœ‰å¼€å¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Qt Gui:</span><br><span class="line">  Accessibility .......................... yes</span><br><span class="line">  FreeType ............................... yes</span><br><span class="line">    Using system FreeType ................ yes</span><br><span class="line">  HarfBuzz ............................... yes</span><br><span class="line">    Using system HarfBuzz ................ no</span><br><span class="line">  Fontconfig ............................. yes</span><br><span class="line">  Image formats:</span><br><span class="line">    GIF .................................. yes</span><br><span class="line">    ICO .................................. yes</span><br><span class="line">    JPEG ................................. yes</span><br><span class="line">      Using system libjpeg ............... yes</span><br><span class="line">    PNG .................................. yes</span><br><span class="line">      Using system libpng ................ yes</span><br><span class="line">  Text formats:</span><br><span class="line">    HtmlParser ........................... yes</span><br><span class="line">    CssParser ............................ yes</span><br><span class="line">    OdfWriter ............................ yes</span><br><span class="line">    MarkdownReader ....................... yes</span><br><span class="line">      Using system libmd4c ............... no</span><br><span class="line">    MarkdownWriter ....................... yes</span><br><span class="line">  EGL .................................... yes</span><br><span class="line">  OpenVG ................................. no</span><br><span class="line">  OpenGL:</span><br><span class="line">    Desktop OpenGL ....................... yes</span><br><span class="line">    OpenGL ES 2.0 ........................ no</span><br><span class="line">    OpenGL ES 3.0 ........................ no</span><br><span class="line">    OpenGL ES 3.1 ........................ no</span><br><span class="line">    OpenGL ES 3.2 ........................ no</span><br><span class="line">  Vulkan ................................. no</span><br><span class="line">  Session Management ..................... yes</span><br><span class="line">Features used by QPA backends:</span><br><span class="line">  evdev .................................. yes</span><br><span class="line">  libinput ............................... no</span><br><span class="line">  INTEGRITY HID .......................... no</span><br><span class="line">  mtdev .................................. no</span><br><span class="line">  tslib .................................. no</span><br><span class="line">  xkbcommon .............................. no</span><br><span class="line">  X11 specific:</span><br><span class="line">    XLib ................................. yes</span><br><span class="line">    XCB Xlib ............................. no</span><br><span class="line">    EGL on X11 ........................... no</span><br><span class="line">    xkbcommon-x11 ........................ no</span><br><span class="line">QPA backends:</span><br><span class="line">  DirectFB ............................... no</span><br><span class="line">  EGLFS .................................. yes</span><br><span class="line">  EGLFS details:</span><br><span class="line">    EGLFS OpenWFD ........................ no</span><br><span class="line">    EGLFS i.Mx6 .......................... no</span><br><span class="line">    EGLFS i.Mx6 Wayland .................. no</span><br><span class="line">    EGLFS RCAR ........................... no</span><br><span class="line">    EGLFS EGLDevice ...................... no</span><br><span class="line">    EGLFS GBM ............................ no</span><br><span class="line">    EGLFS VSP2 ........................... no</span><br><span class="line">    EGLFS Mali ........................... no</span><br><span class="line">    EGLFS Raspberry Pi ................... no</span><br><span class="line">    EGLFS X11 ............................ no</span><br><span class="line">  LinuxFB ................................ yes</span><br><span class="line">  VNC .................................... yes</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥ç»§ç»­é˜…è¯» <a href="https://doc.qt.io/qt-6/linux-requirements.html">Qt for X11 requirements</a> æ–‡æ¡£, å®‰è£…æ–‡æ¡£ä¸­æ‰€æœ‰åˆ—å‡ºçš„ä¾èµ–è½¯ä»¶åŒ…åï¼Œ é‡æ–°ç¼–è¯‘ Qt 5.15.16, è¿™æ¬¡ qapitrace è¿è¡Œæ­£å¸¸ï¼Œè€Œä¸”ä¹‹å‰æŠ¥å‡ºçš„ç¼ºå°‘ <strong>Qt Platform plugin â€œxcbâ€ in â€œâ€</strong> ä¹Ÿæ¶ˆå¤±äº†</p>
<p><img src="/images/ok/apitrace.png" alt="qapitrace" /></p>
<h2 id="pal"><a class="markdownIt-Anchor" href="#pal"></a> PAL</h2>
<p>Qt Platform Abstraction (QPA) æ˜¯ Qt ä¸­ä¸»è¦çš„<strong>å¹³å°æŠ½è±¡å±‚ (Platform Abstraction Layer)</strong>, PAL è¿™ä¸ªæ¦‚å¿µåœ¨ <a href="https://github.com/GPUOpen-Drivers/pal">AMD GPU é©±åŠ¨</a>ä¸­ä¹Ÿæœ‰ï¼Œ åœ¨ Android é‡Œä¹Ÿæœ‰ç±»ä¼¼çš„ HAL (Hardware Abstraction Layer) çš„æ¦‚å¿µï¼Œåœ¨ç³»ç»Ÿè½¯ä»¶è®¾è®¡ä¸­ï¼Œ PAL çš„ä½œç”¨å¯è°“æ˜¯&quot;æ‰¿ä¸Šå¯ä¸‹&quot;ï¼Œ è®¾è®¡ä¸€ä¸ª<strong>æ¥å£ç¨³å®šï¼Œæ˜“äºæ‰©å±•</strong>çš„ PAL API æ˜¯æ•´ä¸ªç”¨æˆ·æ€ç³»ç»Ÿè½¯ä»¶å®ç°æ•ˆç‡çš„å…³é”®ã€‚é€šè¿‡è¿™æ¬¡å®‰è£… Qt, åˆå¤šäº†ä¸€ä¸ªå­¦ä¹ çš„ä¾‹å­ã€‚</p>
<h1 id="openkylinlinux-66-next"><a class="markdownIt-Anchor" href="#openkylinlinux-66-next"></a> <a href="https://gitee.com/openkylin/linux/tree/linux-6.6-next">openKylin:linux-6.6-next</a></h1>
<p>ä¸»è¦å…³æ³¨äº†ä¸€ä¸‹å›½äº§ GPU/DRM é©±åŠ¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./omapdrm</span><br><span class="line">./nouveau</span><br><span class="line">./mxsfb</span><br><span class="line">./mwv207 # æ™¯å˜‰å¾® 0x0731</span><br><span class="line">./msm</span><br><span class="line">./mgag200</span><br><span class="line">./meson</span><br><span class="line">./mediatek</span><br><span class="line">./mcde</span><br><span class="line">./loongson # é¾™èŠ¯ 0x0014</span><br><span class="line">./logicvc</span><br><span class="line">./lima</span><br><span class="line">./lib</span><br><span class="line">./kmb</span><br><span class="line">./ingenic</span><br><span class="line">./imx</span><br><span class="line">./i915</span><br><span class="line">./i2c</span><br><span class="line">./hyperv</span><br><span class="line">./hisilicon</span><br><span class="line">./gud</span><br><span class="line">./gma500</span><br><span class="line">./fsl-dcu</span><br><span class="line">./exynos</span><br><span class="line">./etnaviv</span><br><span class="line">./display</span><br><span class="line">./ci</span><br><span class="line">./bridge</span><br><span class="line">./atmel-hlcdc</span><br><span class="line">./ast</span><br><span class="line">./aspeed</span><br><span class="line">./armada</span><br><span class="line">./arm</span><br><span class="line">./arise  # æ ¼å…°è² 0x6766</span><br><span class="line">./amd</span><br><span class="line">.</span><br><span class="line">âœ  drm git:(linux-6.6-next)</span><br></pre></td></tr></table></figure>
<h1 id="redeclipse"><a class="markdownIt-Anchor" href="#redeclipse"></a> <a href="https://github.com/redeclipse/base">RedEclipse</a></h1>
<p><img src="/images/ok/nv137-redeclipse.png" alt="RedEclipse on NV137" /></p>
<h1 id="kylin-wayland-compositor"><a class="markdownIt-Anchor" href="#kylin-wayland-compositor"></a> <a href="https://gitee.com/openkylin/kylin-wayland-compositor">kylin-wayland-compositor</a></h1>
<p>kylin-wayland-compositor çš„äºŒè¿›åˆ¶ç¨‹åºæ˜¯ <code>kylin-wlcom</code>, å®ƒçš„å¯åŠ¨é…ç½®åœ¨</p>
<figure class="highlight txt"><figcaption><span>/usr/share/wayland-sessions/kylin-wlcom.desktop</span></figcaption><table><tr><td class="code"><pre><span class="line">[Desktop Entry]</span><br><span class="line">Name=Kylin Wlcom</span><br><span class="line">Comment=The Kylin Wayland Compositor</span><br><span class="line">Exec=kylin-wlcom -s ukui-session</span><br><span class="line">Type=Application</span><br></pre></td></tr></table></figure>
<p><code>/usr/bin/ukui-session</code> è¿™ä¸ªäºŒè¿›åˆ¶ç¨‹åºä¼šæ‹‰èµ·å¾ˆå¤šåº”ç”¨ç¨‹åº</p>
<figure class="highlight bash"><figcaption><span>pstree -p -t 3768</span></figcaption><table><tr><td class="code"><pre><span class="line">ukui-session(3768)-+-KylinTreasureBo(4259)-+-&#123;KylinTreasureBo&#125;(4279)</span><br><span class="line">                   |                       `-&#123;QDBusConnection&#125;(5164)</span><br><span class="line">                   |-NotifySend(4790)-+-&#123;QDBusConnection&#125;(4955)</span><br><span class="line">                   |                  |-&#123;QThread&#125;(5270)</span><br><span class="line">                   |                  |-&#123;WaylandEventThr&#125;(5190)</span><br><span class="line">                   |                  |-&#123;WaylandEventThr&#125;(5191)</span><br><span class="line">                   |                  |-&#123;dconf worker&#125;(5187)</span><br><span class="line">                   |                  |-&#123;gdbus&#125;(5194)</span><br><span class="line">                   |                  |-&#123;gmain&#125;(5186)</span><br><span class="line">                   |                  `-&#123;pool-spawner&#125;(5176)</span><br><span class="line">                   |-conf2-session-s(3976)</span><br><span class="line">                   |-fcitx5(4137)-+-&#123;fcitx5&#125;(4214)</span><br><span class="line">                   |              |-&#123;fcitx5&#125;(4223)</span><br><span class="line">                   |              |-&#123;fcitx5&#125;(4939)</span><br><span class="line">                   |              |-&#123;fcitx5&#125;(5105)</span><br><span class="line">                   |              `-&#123;fcitx5&#125;(5106)</span><br><span class="line">                   |-ksc-virus-dialo(4180)-+-&#123;CAuthDialogThre&#125;(5750)</span><br><span class="line">                   |                       |-&#123;QDBusConnection&#125;(4219)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4269)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4270)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4268)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4274)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4267)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(4266)</span><br><span class="line">                   |-kylin-activatio(4782)-+-&#123;QDBusConnection&#125;(10066)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(10065)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(10067)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(10064)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(10063)</span><br><span class="line">                   |-kylin-calendar(4131)-+-&#123;QDBusConnection&#125;(4184)</span><br><span class="line">                   |                      |-&#123;WaylandEventThr&#125;(4296)</span><br><span class="line">                   |                      |-&#123;WaylandEventThr&#125;(4297)</span><br><span class="line">                   |                      |-&#123;gdbus&#125;(4305)</span><br><span class="line">                   |                      |-&#123;gmain&#125;(4293)</span><br><span class="line">                   |                      `-&#123;pool-spawner&#125;(4292)</span><br><span class="line">                   |-kylin-device-da(4233)-+-&#123;QDBusConnection&#125;(5060)</span><br><span class="line">                   |                       |-&#123;QThread&#125;(4987)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5324)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5325)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4985)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4344)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4341)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(4340)</span><br><span class="line">                   |-kylin-nm(4237)-+-&#123;QDBusConnection&#125;(4638)</span><br><span class="line">                   |                |-&#123;QThread&#125;(4584)</span><br><span class="line">                   |                |-&#123;QThread&#125;(5167)</span><br><span class="line">                   |                |-&#123;WaylandEventThr&#125;(5012)</span><br><span class="line">                   |                |-&#123;WaylandEventThr&#125;(5013)</span><br><span class="line">                   |                |-&#123;dconf worker&#125;(4583)</span><br><span class="line">                   |                |-&#123;gdbus&#125;(4622)</span><br><span class="line">                   |                |-&#123;gmain&#125;(4582)</span><br><span class="line">                   |                `-&#123;pool-spawner&#125;(4581)</span><br><span class="line">                   |-kylin-os-manage(4371)---&#123;QDBusConnection&#125;(4442)</span><br><span class="line">                   |-kylin-printer-a(4242)-+-&#123;DeviceMonitorBa&#125;(5236)</span><br><span class="line">                   |                       |-&#123;LaunchPrinter&#125;(5235)</span><br><span class="line">                   |                       |-&#123;PopWindowManage&#125;(5237)</span><br><span class="line">                   |                       |-&#123;QDBusConnection&#125;(4496)</span><br><span class="line">                   |                       |-&#123;QThread&#125;(5230)</span><br><span class="line">                   |                       |-&#123;QThread&#125;(5231)</span><br><span class="line">                   |                       |-&#123;QThread&#125;(5250)</span><br><span class="line">                   |                       |-&#123;QThread&#125;(5701)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4881)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4882)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4875)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4895)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4873)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(4867)</span><br><span class="line">                   |-kylin-updatefin(4282)</span><br><span class="line">                   |-kylin-virtual-k(4308)-+-&#123;QDBusConnection&#125;(4543)</span><br><span class="line">                   |                       |-&#123;QXcbEventQueue&#125;(4462)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4542)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4545)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4541)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(4540)</span><br><span class="line">                   |-kylin-vpn(4313)-+-&#123;QDBusConnection&#125;(4710)</span><br><span class="line">                   |                 |-&#123;QThread&#125;(4664)</span><br><span class="line">                   |                 |-&#123;QThread&#125;(5142)</span><br><span class="line">                   |                 |-&#123;WaylandEventThr&#125;(5024)</span><br><span class="line">                   |                 |-&#123;WaylandEventThr&#125;(5025)</span><br><span class="line">                   |                 |-&#123;dconf worker&#125;(4663)</span><br><span class="line">                   |                 |-&#123;gdbus&#125;(4701)</span><br><span class="line">                   |                 |-&#123;gmain&#125;(4662)</span><br><span class="line">                   |                 `-&#123;pool-spawner&#125;(4661)</span><br><span class="line">                   |-kylin-weather-c(4316)-+-&#123;QDBusConnection&#125;(4463)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4651)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4652)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4650)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4660)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4649)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(4648)</span><br><span class="line">                   |-mm-notify(4329)</span><br><span class="line">                   |-peony-qt-deskto(4014)-+-&#123;QDBusConnection&#125;(4141)</span><br><span class="line">                   |                       |-&#123;QThread&#125;(4126)</span><br><span class="line">                   |                       |-&#123;QThread&#125;(5152)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4339)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4347)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4124)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4136)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4123)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(4122)</span><br><span class="line">                   |-polkit-ukui-aut(4338)-+-&#123;QDBusConnection&#125;(5389)</span><br><span class="line">                   |                       |-&#123;QThread&#125;(5377)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5519)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5520)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(5375)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(5387)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(5374)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(5373)</span><br><span class="line">                   |-sdk-date(4326)---&#123;sdk-date&#125;(4368)</span><br><span class="line">                   |-sdk-powermanage(4322)-+-&#123;dconf worker&#125;(4422)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4441)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4421)</span><br><span class="line">                   |                       |-&#123;pool-spawner&#125;(4420)</span><br><span class="line">                   |                       `-&#123;sdk-powermanage&#125;(4389)</span><br><span class="line">                   |-secRiskBox(4362)-+-&#123;QDBusConnection&#125;(4508)</span><br><span class="line">                   |                  |-&#123;WaylandEventThr&#125;(4815)</span><br><span class="line">                   |                  |-&#123;WaylandEventThr&#125;(4816)</span><br><span class="line">                   |                  |-&#123;dconf worker&#125;(4814)</span><br><span class="line">                   |                  |-&#123;gdbus&#125;(4824)</span><br><span class="line">                   |                  |-&#123;gmain&#125;(4813)</span><br><span class="line">                   |                  `-&#123;pool-spawner&#125;(4812)</span><br><span class="line">                   |-sound-theme-pla(4390)-+-&#123;QDBusConnection&#125;(4440)</span><br><span class="line">                   |                       |-&#123;QThread&#125;(4439)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4438)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4461)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4437)</span><br><span class="line">                   |                       |-&#123;pool-spawner&#125;(4436)</span><br><span class="line">                   |                       `-&#123;threaded-ml&#125;(10096)</span><br><span class="line">                   |-sync-config-ses(4132)-+-&#123;dconf worker&#125;(4149)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4153)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4148)</span><br><span class="line">                   |                       |-&#123;pool-spawner&#125;(4147)</span><br><span class="line">                   |                       `-&#123;sync-config-ses&#125;(4158)</span><br><span class="line">                   |-ukui-appwidget-(3985)-+-&#123;QDBusConnection&#125;(3998)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4027)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4028)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4026)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4030)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4025)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(4024)</span><br><span class="line">                   |-ukui-bluetooth(4464)-+-&#123;QDBusConnection&#125;(5251)</span><br><span class="line">                   |                      |-&#123;QThread&#125;(5184)</span><br><span class="line">                   |                      |-&#123;WaylandEventThr&#125;(5337)</span><br><span class="line">                   |                      |-&#123;WaylandEventThr&#125;(5338)</span><br><span class="line">                   |                      |-&#123;dconf worker&#125;(5170)</span><br><span class="line">                   |                      |-&#123;gdbus&#125;(5173)</span><br><span class="line">                   |                      |-&#123;gmain&#125;(5169)</span><br><span class="line">                   |                      `-&#123;pool-spawner&#125;(5168)</span><br><span class="line">                   |-ukui-menu(17330)-+-&#123;BatchProcess&#125;(17365)</span><br><span class="line">                   |                  |-&#123;BatchProcess&#125;(17366)</span><br><span class="line">                   |                  |-&#123;BatchProcess&#125;(17368)</span><br><span class="line">                   |                  |-&#123;BatchProcess&#125;(17369)</span><br><span class="line">                   |                  |-&#123;QDBusConnection&#125;(17331)</span><br><span class="line">                   |                  |-&#123;QQmlThread&#125;(17341)</span><br><span class="line">                   |                  |-&#123;QSGRenderThread&#125;(17371)</span><br><span class="line">                   |                  |-&#123;QThread&#125;(17342)</span><br><span class="line">                   |                  |-&#123;QThread&#125;(271464)</span><br><span class="line">                   |                  |-&#123;WaylandEventThr&#125;(17335)</span><br><span class="line">                   |                  |-&#123;WaylandEventThr&#125;(17337)</span><br><span class="line">                   |                  |-&#123;dconf worker&#125;(17334)</span><br><span class="line">                   |                  |-&#123;gdbus&#125;(17336)</span><br><span class="line">                   |                  |-&#123;gmain&#125;(17333)</span><br><span class="line">                   |                  |-&#123;pool-spawner&#125;(17332)</span><br><span class="line">                   |                  |-&#123;ukui-menu&#125;(17367)</span><br><span class="line">                   |                  `-&#123;ukui-menu&#125;(17370)</span><br><span class="line">                   |-ukui-panel(271872)-+-&#123;BatchProcess&#125;(271903)</span><br><span class="line">                   |                    |-&#123;BatchProcess&#125;(271904)</span><br><span class="line">                   |                    |-&#123;BatchProcess&#125;(271906)</span><br><span class="line">                   |                    |-&#123;BatchProcess&#125;(271907)</span><br><span class="line">                   |                    |-&#123;QDBusConnection&#125;(271873)</span><br><span class="line">                   |                    |-&#123;QQmlThread&#125;(271882)</span><br><span class="line">                   |                    |-&#123;QSGRenderThread&#125;(271909)</span><br><span class="line">                   |                    |-&#123;WaylandEventThr&#125;(271877)</span><br><span class="line">                   |                    |-&#123;WaylandEventThr&#125;(271878)</span><br><span class="line">                   |                    |-&#123;dconf worker&#125;(271876)</span><br><span class="line">                   |                    |-&#123;gdbus&#125;(271879)</span><br><span class="line">                   |                    |-&#123;gmain&#125;(271875)</span><br><span class="line">                   |                    |-&#123;pool-spawner&#125;(271874)</span><br><span class="line">                   |                    |-&#123;ukui-panel&#125;(271905)</span><br><span class="line">                   |                    `-&#123;ukui-panel&#125;(271908)</span><br><span class="line">                   |-ukui-powermanag(4520)-+-&#123;QDBusConnection&#125;(4872)</span><br><span class="line">                   |                       |-&#123;QThread&#125;(4721)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5053)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5054)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4720)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4743)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4719)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(4718)</span><br><span class="line">                   |-ukui-screensave(3992)-+-ukui-screensave(14606)-+-&#123;QDBusConnection&#125;(14617)</span><br><span class="line">                   |                       |                        |-&#123;QThread&#125;(14614)</span><br><span class="line">                   |                       |                        |-&#123;QThread&#125;(14635)</span><br><span class="line">                   |                       |                        |-&#123;WaylandEventThr&#125;(14621)</span><br><span class="line">                   |                       |                        |-&#123;WaylandEventThr&#125;(14622)</span><br><span class="line">                   |                       |                        |-&#123;dconf worker&#125;(14612)</span><br><span class="line">                   |                       |                        |-&#123;gdbus&#125;(14613)</span><br><span class="line">                   |                       |                        |-&#123;gmain&#125;(14611)</span><br><span class="line">                   |                       |                        `-&#123;pool-spawner&#125;(14610)</span><br><span class="line">                   |                       |-&#123;QDBusConnection&#125;(4019)</span><br><span class="line">                   |                       |-&#123;QThread&#125;(4018)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4017)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4016)</span><br><span class="line">                   |                       |-&#123;pool-spawner&#125;(4015)</span><br><span class="line">                   |                       `-&#123;ukui-screensave&#125;(5094)</span><br><span class="line">                   |-ukui-search(4573)-+-&#123;QDBusConnection&#125;(5395)</span><br><span class="line">                   |                   |-&#123;WaylandEventThr&#125;(5450)</span><br><span class="line">                   |                   |-&#123;WaylandEventThr&#125;(5451)</span><br><span class="line">                   |                   |-&#123;dconf worker&#125;(5449)</span><br><span class="line">                   |                   |-&#123;gdbus&#125;(5454)</span><br><span class="line">                   |                   |-&#123;gmain&#125;(5448)</span><br><span class="line">                   |                   `-&#123;pool-spawner&#125;(5447)</span><br><span class="line">                   |-ukui-search-app(4539)-+-&#123;QDBusConnection&#125;(4838)</span><br><span class="line">                   |                       |-&#123;UkuiSearch::Pen&#125;(5380)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5082)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5083)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(5079)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(5086)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(5068)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(5066)</span><br><span class="line">                   |-ukui-search-ser(4549)-+-&#123;QDBusConnection&#125;(5317)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5393)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5394)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(5391)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(5396)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(5390)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(5388)</span><br><span class="line">                   |-ukui-search-ser(4562)-+-&#123;QDBusConnection&#125;(5331)</span><br><span class="line">                   |                       |-&#123;UkuiSearch::Pen&#125;(5626)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5594)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5595)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(5593)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(5597)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(5592)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(5590)</span><br><span class="line">                   |-ukui-settings-d(3993)-+-&#123;QDBusConnection&#125;(4023)</span><br><span class="line">                   |                       |-&#123;QNetworkAccessM&#125;(5951)</span><br><span class="line">                   |                       |-&#123;QThread&#125;(5421)</span><br><span class="line">                   |                       |-&#123;Qt bearer threa&#125;(5860)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4072)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4073)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4071)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4606)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4074)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4070)</span><br><span class="line">                   |                       |-&#123;pool-spawner&#125;(4069)</span><br><span class="line">                   |                       `-&#123;threaded-ml&#125;(4351)</span><br><span class="line">                   |-ukui-sidebar(4586)-+-&#123;BatchProcess&#125;(6392)</span><br><span class="line">                   |                    |-&#123;BatchProcess&#125;(6393)</span><br><span class="line">                   |                    |-&#123;BatchProcess&#125;(6395)</span><br><span class="line">                   |                    |-&#123;BatchProcess&#125;(6396)</span><br><span class="line">                   |                    |-&#123;BatchProcess&#125;(6417)</span><br><span class="line">                   |                    |-&#123;BatchProcess&#125;(6419)</span><br><span class="line">                   |                    |-&#123;BatchProcess&#125;(6421)</span><br><span class="line">                   |                    |-&#123;BatchProcess&#125;(6422)</span><br><span class="line">                   |                    |-&#123;QDBusConnection&#125;(5047)</span><br><span class="line">                   |                    |-&#123;QQmlThread&#125;(5983)</span><br><span class="line">                   |                    |-&#123;QSGRenderThread&#125;(6398)</span><br><span class="line">                   |                    |-&#123;QSGRenderThread&#125;(6425)</span><br><span class="line">                   |                    |-&#123;QThread&#125;(6034)</span><br><span class="line">                   |                    |-&#123;WaylandEventThr&#125;(5610)</span><br><span class="line">                   |                    |-&#123;WaylandEventThr&#125;(5611)</span><br><span class="line">                   |                    |-&#123;dconf worker&#125;(5609)</span><br><span class="line">                   |                    |-&#123;gdbus&#125;(5619)</span><br><span class="line">                   |                    |-&#123;gmain&#125;(5608)</span><br><span class="line">                   |                    |-&#123;pool-spawner&#125;(5607)</span><br><span class="line">                   |                    |-&#123;ukui-sidebar&#125;(6394)</span><br><span class="line">                   |                    |-&#123;ukui-sidebar&#125;(6397)</span><br><span class="line">                   |                    |-&#123;ukui-sidebar&#125;(6420)</span><br><span class="line">                   |                    `-&#123;ukui-sidebar&#125;(6423)</span><br><span class="line">                   |-ukui-sni-watche(3997)---&#123;QDBusConnection&#125;(3999)</span><br><span class="line">                   |-ukui-volume-con(4609)-+-&#123;QDBusConnection&#125;(5137)</span><br><span class="line">                   |                       |-&#123;QThread&#125;(5065)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5329)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(5330)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(5064)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(5067)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(5063)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(5062)</span><br><span class="line">                   |-ukui-window-swi(4635)---ukui-window-swi(4796)-+-&#123;QDBusConnection&#125;(5030)</span><br><span class="line">                   |                                               |-&#123;WaylandEventThr&#125;(5221)</span><br><span class="line">                   |                                               |-&#123;WaylandEventThr&#125;(5222)</span><br><span class="line">                   |                                               |-&#123;dconf worker&#125;(5217)</span><br><span class="line">                   |                                               |-&#123;gdbus&#125;(5225)</span><br><span class="line">                   |                                               |-&#123;gmain&#125;(5216)</span><br><span class="line">                   |                                               `-&#123;pool-spawner&#125;(5215)</span><br><span class="line">                   |-ukuismserver(3914)-+-&#123;QDBusConnection&#125;(3945)</span><br><span class="line">                   |                    |-&#123;WaylandEventThr&#125;(3968)</span><br><span class="line">                   |                    |-&#123;WaylandEventThr&#125;(3970)</span><br><span class="line">                   |                    |-&#123;dconf worker&#125;(3962)</span><br><span class="line">                   |                    |-&#123;gdbus&#125;(3963)</span><br><span class="line">                   |                    |-&#123;gmain&#125;(3961)</span><br><span class="line">                   |                    `-&#123;pool-spawner&#125;(3960)</span><br><span class="line">                   |-user-guide-daem(4304)-+-&#123;QDBusConnection&#125;(4470)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4731)</span><br><span class="line">                   |                       |-&#123;WaylandEventThr&#125;(4732)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4730)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4757)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4729)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(4728)</span><br><span class="line">                   |-user_cmd(4659)</span><br><span class="line">                   |-xembed-sni-prox(4004)-+-&#123;QDBusConnection&#125;(4231)</span><br><span class="line">                   |                       |-&#123;QXcbEventQueue&#125;(4174)</span><br><span class="line">                   |                       |-&#123;dconf worker&#125;(4229)</span><br><span class="line">                   |                       |-&#123;gdbus&#125;(4232)</span><br><span class="line">                   |                       |-&#123;gmain&#125;(4228)</span><br><span class="line">                   |                       `-&#123;pool-spawner&#125;(4227)</span><br><span class="line">                   |-&#123;QDBusConnection&#125;(3791)</span><br><span class="line">                   |-&#123;WaylandEventThr&#125;(3806)</span><br><span class="line">                   |-&#123;WaylandEventThr&#125;(3807)</span><br><span class="line">                   |-&#123;dconf worker&#125;(3812)</span><br><span class="line">                   |-&#123;gdbus&#125;(3814)</span><br><span class="line">                   |-&#123;gmain&#125;(3811)</span><br><span class="line">                   `-&#123;pool-spawner&#125;(3810)</span><br></pre></td></tr></table></figure>
<h1 id="hyprland"><a class="markdownIt-Anchor" href="#hyprland"></a> <a href="https://hypr.land/">Hyprland</a></h1>
<h2 id="dependencies"><a class="markdownIt-Anchor" href="#dependencies"></a> Dependencies</h2>
<table>
<thead>
<tr>
<th style="text-align:left">dep</th>
<th style="text-align:left">apt-get</th>
<th style="text-align:left">version required</th>
<th style="text-align:left">yet another install</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">wayland-protocols</td>
<td style="text-align:left">wayland-protocols</td>
<td style="text-align:left">1.38-ok1</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">libseat</td>
<td style="text-align:left">libseat-dev</td>
<td style="text-align:left">0.8.0-ok2</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">libinput</td>
<td style="text-align:left">libinput-dev</td>
<td style="text-align:left">1.26.0(1.25.0-ok1.2)</td>
<td style="text-align:left"><a href="https://gitlab.freedesktop.org/libinput/libinput">https://gitlab.freedesktop.org/libinput/libinput</a></td>
</tr>
<tr>
<td style="text-align:left">wayland</td>
<td style="text-align:left">libwayland-dev</td>
<td style="text-align:left">1.23.0-1ok3</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">libdisplay-info</td>
<td style="text-align:left">libdisplay-info-dev</td>
<td style="text-align:left">0.1.1-ok1</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">aquamarine</td>
<td style="text-align:left"></td>
<td style="text-align:left">&gt;=0.4.5</td>
<td style="text-align:left"><a href="https://github.com/hyprwm/aquamarine">https://github.com/hyprwm/aquamarine</a></td>
</tr>
<tr>
<td style="text-align:left">hyprwayland-scanner</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left"><a href="https://github.com/hyprwm/hyprwayland-scanner">https://github.com/hyprwm/hyprwayland-scanner</a></td>
</tr>
<tr>
<td style="text-align:left">pugixml</td>
<td style="text-align:left">libpugixml-dev</td>
<td style="text-align:left">1.14-ok1</td>
<td style="text-align:left">required by hyprwayland-scanner</td>
</tr>
<tr>
<td style="text-align:left">hyprutils</td>
<td style="text-align:left"></td>
<td style="text-align:left">&gt;=0.2.3</td>
<td style="text-align:left"><a href="https://github.com/hyprwm/hyprutils">https://github.com/hyprwm/hyprutils</a></td>
</tr>
</tbody>
</table>
<pre><code class="highlight mermaid">mindmap
  root(hyprland)
    aquamarine=0.4.5
      libseat=0.8.0
      libinput10 1.26.0&lt;br&gt;1.25.0-ok1
        libudev&lt;br&gt;255.2
          systemd
            libcap-dev
            gperf
        libmtdev1 1.1.6&lt;br&gt;1.1.5
        libevdev 1.13.1&lt;br&gt;1.12.1
      hyprwayland-scanner=0.4.0
      hyprutils=0.2.3
      wayland-protocols
      wayland-client
      libdisplay-info
        pugixml
      libdrm
      gbm
      pixman-1
      hwdata</code></pre>
<p>åœ¨ openKylin 2.0 ä¸ŠæŠ˜è…¾(ç¼–è¯‘) Hyprland é‡åˆ°çš„ä¸¤ä¸ªé—®é¢˜æ˜¯ï¼š</p>
<ul>
<li>openKylin çš„ APT æºé‡Œ development files åŒ…å’Œ library åŒ…æœ‰å¾ˆå¤šç‰ˆæœ¬ä¸åŒ¹é…çš„ï¼Œå¯¼è‡´ <a href="https://gitee.com/openkylin/release-management/issues/IBLF9O"><strong>apt-get install libxxx-dev</strong></a> å¤±è´¥</li>
<li>hyprland å¯¹ C++ ç‰ˆæœ¬çš„è¦æ±‚å¤ªé«˜äº† (<strong>c++26</strong>), è¿™å¯¼è‡´å¾ˆå¤šé—®é¢˜ï¼Œ ä¸ä»…éœ€è¦å‡çº§ç¼–è¯‘å™¨ (llvm 19.1.7), ç”šè‡³è¿ meson éƒ½æœ‰åˆšåˆšä¸ä¹…æ‰ä¿®å¤çš„è·Ÿ c++26 æœ‰å…³çš„ <a href="https://github.com/mesonbuild/meson/pull/14139">Bug</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  aquamarine git:(0.7.1) âœ— CC=clang CXX=clang++ cmake -B build -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_INSTALL_LIBDIR=lib/x86_64-linux-gnu -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS=<span class="string">&quot;-stdlib=libc++&quot;</span></span><br><span class="line">-- Checking <span class="keyword">for</span> modules <span class="string">&#x27;libseat&gt;=0.8.0;libinput&gt;=1.26.0;wayland-client;wayland-protocols;hyprutils&gt;=0.2.3;pixman-1;libdrm;gbm;libudev;libdisplay-info;hwdata&#x27;</span></span><br><span class="line">--   Package <span class="string">&#x27;libseat&#x27;</span>, required by <span class="string">&#x27;virtual:world&#x27;</span>, not found</span><br><span class="line">--   Package <span class="string">&#x27;libinput&#x27;</span>, required by <span class="string">&#x27;virtual:world&#x27;</span>, not found</span><br><span class="line">--   Package <span class="string">&#x27;wayland-client&#x27;</span>, required by <span class="string">&#x27;virtual:world&#x27;</span>, not found</span><br><span class="line">--   Package <span class="string">&#x27;wayland-protocols&#x27;</span>, required by <span class="string">&#x27;virtual:world&#x27;</span>, not found</span><br><span class="line">--   Package <span class="string">&#x27;libdrm&#x27;</span>, required by <span class="string">&#x27;virtual:world&#x27;</span>, not found</span><br><span class="line">--   Package <span class="string">&#x27;gbm&#x27;</span>, required by <span class="string">&#x27;virtual:world&#x27;</span>, not found</span><br><span class="line">--   Package <span class="string">&#x27;libdisplay-info&#x27;</span>, required by <span class="string">&#x27;virtual:world&#x27;</span>, not found</span><br></pre></td></tr></table></figure>
<h1 id="kernel-linux-660-150ok9"><a class="markdownIt-Anchor" href="#kernel-linux-660-150ok9"></a> Kernel (linux-6.6.0-15.0ok9)</h1>
<p><a href="https://build.openkylin.top/openkylin/+source/linux/6.6.0-15.0ok9">ä¸‹è½½</a> ä»¥ä¸‹æºç åŒ…</p>
<ul>
<li><a href="https://build.openkylin.top/openkylin/+archive/primary/+sourcefiles/linux/6.6.0-15.0ok9/linux_6.6.0.orig.tar.gz">linux_6.6.0.orig.tar.gz</a></li>
<li><a href="https://build.openkylin.top/openkylin/+archive/primary/+sourcefiles/linux/6.6.0-15.0ok9/linux_6.6.0-15.0ok9.debian.tar.xz">linux_6.6.0-15.0ok9.debian.tar.xz</a></li>
<li><a href="https://build.openkylin.top/openkylin/+archive/primary/+sourcefiles/linux/6.6.0-15.0ok9/linux_6.6.0-15.0ok9.dsc">linux_6.6.0-15.0ok9.dsc</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dpkg-source -x linux_6.6.0-15.0ok9.dsc</span><br><span class="line"><span class="built_in">cd</span> linux-6.6.0</span><br><span class="line">fakeroot debian/rules binary</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  LD      .tmp_vmlinux.btf</span><br><span class="line">  BTF     .btf.vmlinux.bin.o</span><br><span class="line">Reached the limit of per-CPU variables: 4096</span><br><span class="line">Reached the limit of per-CPU variables: 4096</span><br><span class="line">Reached the limit of per-CPU variables: 4096</span><br><span class="line">Reached the limit of per-CPU variables: 4096</span><br><span class="line">Reached the limit of per-CPU variables: 4096</span><br><span class="line">Reached the limit of per-CPU variables: 4096</span><br><span class="line">Reached the limit of per-CPU variables: 4096</span><br><span class="line">Reached the limit of per-CPU variables: 4096</span><br><span class="line">Reached the limit of per-CPU variables: 4096</span><br><span class="line">Reached the limit of per-CPU variables: 4096</span><br><span class="line">Reached the limit of per-CPU variables: 4096</span><br><span class="line">Reached the limit of per-CPU variables: 4096</span><br><span class="line">Reached the limit of per-CPU variables: 4096</span><br><span class="line">  LD      .tmp_vmlinux.kallsyms1</span><br><span class="line">  NM      .tmp_vmlinux.kallsyms1.syms</span><br><span class="line">  KSYMS   .tmp_vmlinux.kallsyms1.S</span><br><span class="line">  AS      .tmp_vmlinux.kallsyms1.o</span><br><span class="line">  LD      .tmp_vmlinux.kallsyms2</span><br><span class="line">  NM      .tmp_vmlinux.kallsyms2.syms</span><br><span class="line">  KSYMS   .tmp_vmlinux.kallsyms2.S</span><br><span class="line">  AS      .tmp_vmlinux.kallsyms2.o</span><br><span class="line">  LD      vmlinux</span><br><span class="line">  BTFIDS  vmlinux</span><br><span class="line">libbpf: failed to find &#x27;.BTF&#x27; ELF section in vmlinux</span><br><span class="line">FAILED: load BTF from vmlinux: No data available</span><br><span class="line">make[4]: *** [/home/luc/linux-6.6.0/scripts/Makefile.vmlinux:37: vmlinux] Error 255</span><br><span class="line">make[4]: *** Deleting file &#x27;vmlinux&#x27;</span><br><span class="line">make[3]: *** [/home/luc/linux-6.6.0/Makefile:1178: vmlinux] Error 2</span><br><span class="line">make[2]: *** [/home/luc/linux-6.6.0/Makefile:236: __sub-make] Error 2</span><br><span class="line">make[2]: Leaving directory &#x27;/home/luc/linux-6.6.0/debian/build/build-generic&#x27;</span><br><span class="line">make[1]: *** [Makefile:236: __sub-make] Error 2</span><br><span class="line">make[1]: Leaving directory &#x27;/home/luc/linux-6.6.0&#x27;</span><br><span class="line">make: *** [debian/rules.d/2-binary-arch.mk:46: /home/luc/linux-6.6.0/debian/stamps/stamp-build-generic] Error 2</span><br></pre></td></tr></table></figure>
<p>æŠ¥é”™çš„åŸå› æ˜¯ <a href="https://lore.kernel.org/lkml/20240228032142.396719-1-jhubbard@nvidia.com/T/"><code>.config</code> æ–‡ä»¶é‡Œæ‰“å¼€çš„æ¨¡å—å¤ªå¤šäº†</a>(å› ä¸ºæ˜¯è¯•éªŒæ€§ç¼–è¯‘, æ²¡æœ‰ <code>zcat /proc/config.gz &gt; .config</code>)</p>
<h1 id="resources"><a class="markdownIt-Anchor" href="#resources"></a> Resources</h1>
<ul>
<li><a href="https://archive.kylinos.cn/kylin/KYLIN-ALL/">KylinOS çš„è½¯ä»¶åŒ… OpenKylin åŸºæœ¬éƒ½èƒ½ç”¨</a></li>
<li><a href="https://trace-cmd.org/">trace-cmd</a></li>
<li><a href="https://doc.qt.io/qt-6/embedded-linux.html#embedded-eglfs">Platform plugins for Embedded Linux devices - EGLFS</a></li>
<li><a href="https://doc.qt.io/qt-6/linux-requirements.html">Qt for X11 Requirements</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>distro</tag>
      </tags>
  </entry>
  <entry>
    <title>Submitting My First Linux Kernel Patch</title>
    <url>/lnx/patch-submit/</url>
    <content><![CDATA[<p>Linux å†…æ ¸çš„ patch æ˜¯ä»¥çº¯æ–‡æœ¬çš„é‚®ä»¶å½¢å¼è¿›è¡Œæäº¤å’Œä»£ç èµ°æŸ¥çš„ï¼Œè€Œä¸” patch æ˜¯å…ˆåˆ°å†…æ ¸å­ç³»ç»Ÿ maintainer ç»´æŠ¤çš„ git tree, å†åˆ° <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/">Linus Torvalds çš„ main tree</a>ã€‚æœ¬æ–‡ä¸»è¦æ˜¯ä»¥ä¸€ä¸ª patch æäº¤çš„å®ä¾‹æ¥è®°å½•ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ä¸­çš„ä¸€äº›å…·ä½“æ“ä½œè¦ç‚¹ï¼Œè‡³äº kernel patch æäº¤çš„è§„èŒƒå’Œæ“ä½œç»†èŠ‚<a href="https://www.kernel.org/doc/html/latest/process/submitting-patches.html">å†…æ ¸æ–‡æ¡£</a> å’Œå„ç§åšå®¢æ–‡ç« æœ‰å¾ˆå¤šï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<span id="more"></span>
<h1 id="ç”¨åˆ°çš„å¹³å°è½¯ä»¶å·¥å…·"><a class="markdownIt-Anchor" href="#ç”¨åˆ°çš„å¹³å°è½¯ä»¶å·¥å…·"></a> ç”¨åˆ°çš„å¹³å°ï¼Œè½¯ä»¶ï¼Œå·¥å…·</h1>
<ul>
<li>Windows Subsystem for Linux, Ubuntu 20.04 LTS (Focal Fossa)</li>
<li>é‚®ä»¶å®¢æˆ·ç«¯ mutt 1.13.2 (<code>apt install mutt</code>)</li>
<li>git 2.25.1</li>
<li>kernel git tree (mainly DRM) <a href="https://gitlab.freedesktop.org/drm">https://gitlab.freedesktop.org/drm</a></li>
</ul>
<h1 id="è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#è¿‡ç¨‹"></a> è¿‡ç¨‹</h1>
<h2 id="å‡†å¤‡-patch"><a class="markdownIt-Anchor" href="#å‡†å¤‡-patch"></a> å‡†å¤‡ patch</h2>
<ul>
<li>å½“ä½ çš„ commit å·²ç»åœ¨æºç æ ‘ä¸Šæäº¤å¥½åï¼Œåªéœ€ä½¿ç”¨ <code>git format-patch</code> å‘½ä»¤å³å¯è½»æ¾ç”Ÿæˆä¸€ä¸ªå†…æ ¸ patch (å‡è®¾ patch é‡ŒåªåŒ…å«ä¸€ä¸ª commit)</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git format-patch HEAD^ -o /tmp/   # å°†ç”Ÿæˆçš„ patch æ–‡ä»¶ä¿å­˜åœ¨ /tmp ç›®å½•</span><br></pre></td></tr></table></figure>
<ul>
<li>å½“ä½ çš„ patch è¢«å¼€å‘è€… review åï¼Œå¦‚æœéœ€è¦ä¿®æ”¹ï¼Œä¿®æ”¹åå¯é€šè¿‡å¢åŠ  <code>-v N</code> é€‰é¡¹ç”Ÿæˆä¸‹ä¸€ä¸ªç‰ˆæœ¬çš„ patch</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git format-patch HEAD^ -v 2 -o /tmp/</span><br></pre></td></tr></table></figure>
<h2 id="æ£€æŸ¥-patch"><a class="markdownIt-Anchor" href="#æ£€æŸ¥-patch"></a> æ£€æŸ¥ patch</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./scripts/checkpatch.pl /path/to/patch</span><br></pre></td></tr></table></figure>
<p><code>checkpatch.pl</code> å·¥å…·æ‰§è¡Œå„ç§ codestyle, patch æ ¼å¼, ç¤¾åŒºæäº¤è¡¥ä¸è§„èŒƒçš„æ£€æŸ¥ï¼Œå®ƒå’Œæµ‹è¯•ä¸€æ ·ï¼Œéƒ½æ˜¯æäº¤è¡¥ä¸å‰ä¸å¯ç¼ºå°‘çš„æ­¥éª¤</p>
<h2 id="æäº¤-patch"><a class="markdownIt-Anchor" href="#æäº¤-patch"></a> æäº¤ patch</h2>
<p>ä¸ªäººè§‰å¾—æäº¤è¡¥ä¸æ¯”è¾ƒç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ <code>git send-email</code>, å› ä¸ºå†…æ ¸è¡¥ä¸æˆ–è¡¥ä¸é›†éƒ½æ˜¯ä»¥çº¯æ–‡æœ¬(plain text)ç”µå­é‚®ä»¶å½¢å¼æäº¤çš„, æ‰€ä»¥æäº¤å‰éœ€è¦</p>
<ul>
<li>é…ç½®å¥½ä½ çš„ SMTP (Simple Mail Transfer Protocol)é‚®ä»¶å‘é€æœåŠ¡å™¨</li>
<li>ç¡®å®šå¥½æ”¶ä»¶äººå’ŒæŠ„é€äºº(Carbon Copy)
<ul>
<li>æ”¶ä»¶äººä¸€èˆ¬æ˜¯ subsystem maintainer æˆ–é‚®ä»¶åˆ—è¡¨ï¼Œå¦‚ <a href="mailto:dri-devel@lists.freedesktop.org">dri-devel@lists.freedesktop.org</a></li>
<li>æŠ„é€äººä¸€èˆ¬ä½¿ç”¨è„šæœ¬ <code>./scripts/get_maintainer.pl /path/to/patch</code> æ¥è‡ªåŠ¨è·å–
<ul>
<li><code>./scripts/get_maintainer.pl</code> ä¸åŠ ä»»ä½•é€‰é¡¹æ—¶è¾“å‡ºæ ¼å¼æ˜¯è¿™æ ·å­çš„(å…·ä½“å†…å®¹éšè¡¥ä¸è€Œå®š)  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Maarten Lankhorst &lt;maarten.lankhorst@linux.intel.com&gt; (maintainer:DRM DRIVERS AND MISC GPU PATCHES)</span><br><span class="line">Maxime Ripard &lt;mripard@kernel.org&gt; (maintainer:DRM DRIVERS AND MISC GPU PATCHES)</span><br><span class="line">Thomas Zimmermann &lt;tzimmermann@suse.de&gt; (maintainer:DRM DRIVERS AND MISC GPU PATCHES)</span><br><span class="line">David Airlie &lt;airlied@gmail.com&gt; (maintainer:DRM DRIVERS)</span><br><span class="line">Simona Vetter &lt;simona@ffwll.ch&gt; (maintainer:DRM DRIVERS)</span><br><span class="line">dri-devel@lists.freedesktop.org (open list:DRM DRIVERS)</span><br><span class="line">linux-kernel@vger.kernel.org (open list)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="ä½¿ç”¨-mutt"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-mutt"></a> ä½¿ç”¨ mutt</h3>
<p>æäº¤ Linux kernel patch å®é™…ä¸Šå°±æ˜¯ç”¨é‚®ä»¶å®¢æˆ·ç«¯å°†ç”Ÿæˆå¥½çš„ patch æ–‡ä»¶å‘é€ç»™ç›¸å…³çš„ maintainers å’Œ maillists. <code>git send-email</code> ä¹Ÿå¯ä»¥åšåŒæ ·çš„äº‹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ mutt. mutt çš„åŸºæœ¬å‘½ä»¤è¡Œæ ¼å¼æ˜¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mutt [-Enx] [-e cmd] [-F file] [-H file] [-i file] [-s subj] [-b addr] [-c addr] [-a file [...] --] addr|mailto_url [...]</span><br></pre></td></tr></table></figure>
<p>æœ¬ä¾‹ä¸­åªä½¿ç”¨åˆ°äº† <code>-H file</code> é€‰é¡¹ï¼Œå®ƒå°†åŒ…å«æœ‰é‚®ä»¶å¤´å’Œé‚®ä»¶ä¸»ä½“çš„ patch æ–‡ä»¶ä½œä¸ºå‚æ•°åˆ›å»ºé‚®ä»¶è‰ç¨¿ (æ„æ€æ˜¯è¯¥å‘½ä»¤æ‰§è¡Œåè¿˜ä¼šè®©ä½ å†ç¼–è¾‘é‚®ä»¶ï¼ŒåŒ…æ‹¬æ”¶ä»¶äººï¼Œé‚®ä»¶å†…å®¹å¢åˆ æ”¹ç­‰ï¼‰ã€‚æœ¬ä¾‹ä¸­ mutt çš„å”¯ä¸€å‚æ•°æ˜¯åé¢çš„æ”¶ä»¶äººåˆ—è¡¨ï¼Œå®ƒæ˜¯é€šè¿‡å†…æ ¸æºç æ ‘é‡Œçš„ä¸€ä¸ª<a href="https://elixir.bootlin.com/linux/latest/source/scripts/get_maintainer.pl">è„šæœ¬å·¥å…·</a>è‡ªåŠ¨è·å–çš„ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mutt -H /tmp/v2-0001-drm-vram-helper-fix-function-names-in-vram-helper.patch \</span><br><span class="line">    &quot;`./scripts/get_maintainer.pl --separator , --norolestats \</span><br><span class="line">    /tmp/v2-0001-drm-vram-helper-fix-function-names-in-vram-helper.patch`&quot;</span><br></pre></td></tr></table></figure>
<p>å¸¦æœ‰ <code>Fixes:</code> tag çš„patch åº”è¯¥ä¼šè¢« backport åˆ°ä»¥å‰å¿…è¦ -stable tree.</p>
<p><img src="/images/patch-submit/patch-backport.png" alt="patch-backport" /></p>
<h3 id="ä½¿ç”¨-git-send-email"><a class="markdownIt-Anchor" href="#ä½¿ç”¨-git-send-email"></a> ä½¿ç”¨ git send-email</h3>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git send-email --to dri-devel@lists.freedesktop.org --cc-cmd &quot;./scripts/get_maintainer.pl --nogit-fallback --norolestats&quot; /tmp/0001-drm-doc-Fix-doc-in-drm_file.patch</span><br></pre></td></tr></table></figure>
<h2 id="æ³¨æ„äº‹é¡¹"><a class="markdownIt-Anchor" href="#æ³¨æ„äº‹é¡¹"></a> æ³¨æ„äº‹é¡¹</h2>
<p><code>git send-email</code> åŒæ ·éœ€è¦é…ç½®å‘é€é‚®ä»¶æœåŠ¡å™¨ stmp</p>
<ul>
<li>
<p>å°† <a href="mailto:user@stmp.gmail.com">user@stmp.gmail.com</a> çš„å¯†ç é…ç½®åœ¨ ~/.gitconfig çš„ sendemail æ®µ</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[sendemail]</span><br><span class="line">    smtpserver = smtp.gmail.com</span><br><span class="line">    smtpencryption = tls</span><br><span class="line">    smtpserverport = 587</span><br><span class="line">    smtpuser = onion0709@gmail.com</span><br><span class="line">    smtppass = &lt;16 characters Google App Password&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>mutt éœ€è¦é…ç½® IMAP/SMTP, å³é‚®ä»¶æ”¶å‘åè®®é…ç½® (è¿™æ˜¯æ•´ä¸ªè¿‡ç¨‹ä¸­æœ€è´¹åŠ²çš„)<br />
mutt çš„é…ç½®æ–‡ä»¶é»˜è®¤è·¯å¾„æ˜¯ <code>$HOME/.mutt/muttrc</code></p>
</li>
<li>
<p>git éœ€è¦é…ç½®å®Œæ•´çš„ <code>user.name</code>, <code>user.email</code>.</p>
</li>
<li>
<p><code>git commit</code> æ—¶éœ€è¦åŠ  <code>-s</code> (<code>--signoff</code>) æ¥è‡ªåŠ¨å¢åŠ  Signed-off-by æ ‡ç­¾ (å¦‚æœä½  Signed-off-by æ ‡ç­¾çš„é‚®ä»¶åœ°å€å’Œå‘é€ patch çš„é‚®ç®±åœ°å€ä¸åŒçš„è¯ï¼Œè¿˜éœ€è¦åœ¨é‚®ä»¶ä¸»ä½“çš„ç¬¬ä¸€è¡Œæ‰‹åŠ¨æ·»åŠ  <code>From: Zhang San &lt;xxx@yourmail.com&gt;</code>, <a href="mailto:xxx@yourmail.com">xxx@yourmail.com</a> æ˜¯ä½ çš„ Signed-off-by é‚®ä»¶åœ°å€)</p>
</li>
<li>
<p>å¦‚æœ patch é‚®ä»¶å‘å‡ºå2,3å‘¨ï¼Œç”šè‡³ä¸€ä¸ªæœˆéƒ½æ²¡æœ‰æ”¶åˆ°ä»»ä½•å›åº”ï¼Œåœ¨ç¡®è®¤æ”¶ä»¶åœ°å€æ²¡é—®é¢˜çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å†æ¬¡ <code>git send-email</code> åŸæ¥çš„patch, åŒæ—¶<strong>åœ¨é‚®ä»¶ä¸»é¢˜æ‰‹åŠ¨åŠ ä¸Š RESEND</strong> æ ‡è¯†</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[PATCH RESEND] sub/sys: Condensed patch summary</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>git send-email -v 2 --in-reply-to=&quot;&lt;v1-message-id&gt; ...&quot;</code> é¿å…å› æä¾›è¡¥ä¸çš„ä¸‹ä¸€ä¸ªç‰ˆæœ¬è€Œä¸­æ–­çº¿ç¨‹ã€‚</p>
</li>
<li>
<p>å¯¹äºè¡¥ä¸é›† (Patch Series), ä¸€èˆ¬ Changelog ä¼šå†™åœ¨è¡¥ä¸é›†çš„ cover letter é‡Œã€‚å¯¹äºå•ä¸ªè¡¥ä¸ï¼Œå¦‚æœä¸æƒ³è®© Changelog å‡ºç°åœ¨ commit message é‡Œï¼Œä½†åˆæƒ³ç»™ Maintainer æä¾›è¡¥ä¸è¿­ä»£çš„ä¿¡æ¯ï¼Œå¯ä»¥åœ¨ <code>Signed-off-by</code> åé¢<strong>æ‰‹åŠ¨åŠ ä¸Š <code>---</code></strong>, ç„¶åå¼€å§‹å†™ Changelog(å¦‚ä¸‹), è¿™æ · Changelog å°±ä¸ä¼šå‡ºç°åœ¨æœ€ç»ˆçš„ Commit message é‡Œï¼Œ <strong>ä¿®æ”¹çš„æ—¶æœº</strong>å¯ä»¥åœ¨ <code>git commit -s</code> å†™æäº¤æ—¥å¿—æ—¶ï¼Œä¹Ÿå¯ä»¥åœ¨ <code>git send-email --to ...</code> å‘é€é‚®ä»¶æ—¶é€‰æ‹© <code>[e]dit</code></p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">Signed-off-by: Zhang San &lt;zhang.san@gmail.com&gt;</span><br><span class="line">---</span><br><span class="line">v3:</span><br><span class="line">- blablabla</span><br><span class="line">- asdfasdfasdf</span><br><span class="line">v2:</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://www.kernel.org/doc/html/latest/process/submitting-patches.html">Submitting patches: the essential guide to getting your code into the kernel</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>perf å’Œç«ç„°å›¾</title>
    <url>/lnx/perf/</url>
    <content><![CDATA[<p><img src="/images/perf/radeon.svg" alt="RedEclipse on R7340" /></p>
<span id="more"></span>
<h1 id="åŸç†"><a class="markdownIt-Anchor" href="#åŸç†"></a> åŸç†</h1>
<p>perf ä½¿ç”¨çš„æ˜¯é‡‡æ ·(Sampling)æŠ€æœ¯</p>
<h1 id="ç¯å¢ƒ-ç‰ˆæœ¬"><a class="markdownIt-Anchor" href="#ç¯å¢ƒ-ç‰ˆæœ¬"></a> ç¯å¢ƒ &amp; ç‰ˆæœ¬</h1>
<ul>
<li>Linux 5.10.16.3-microsoft-standard-WSL2 x86_64 x86_64</li>
<li>Ubuntu 20.04.2 LTS</li>
<li>perf version 5.10.16.3</li>
</ul>
<p>NOTE: å¦‚æœæ²¡æœ‰ç‰¹åˆ«è¯´æ˜ï¼Œä»¥ä¸‹<code>perf</code>å‘½ä»¤éƒ½åœ¨<code>root</code>æƒé™ä¸‹æ‰§è¡Œ</p>
<h1 id="æŸ¥è¯¢-ç½—åˆ—"><a class="markdownIt-Anchor" href="#æŸ¥è¯¢-ç½—åˆ—"></a> æŸ¥è¯¢ &amp; ç½—åˆ—</h1>
<p>åˆ—å‡ºVirtual Memoryç›¸å…³çš„<code>static tracepoint</code></p>
<ul>
<li>
<p><code>perf list 'vmscan:*'</code><br />
<img src="/images/perf/perf_list-vmscan.png" alt="" /></p>
</li>
<li>
<p>`perf list â€˜kmem:*â€™<br />
k</p>
</li>
<li>
<p><code>perf stat -a sleep</code><br />
<img src="/images/perf/perf_stat.png" alt="" /></p>
</li>
</ul>
<h1 id="tracepoint-ä½¿èƒ½"><a class="markdownIt-Anchor" href="#tracepoint-ä½¿èƒ½"></a> tracepoint ä½¿èƒ½</h1>
<p>é€šè¿‡ debugfs ä¸­çš„ç›¸åº”æ–‡ä»¶ä½¿èƒ½ tracepoint</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root@sie-luc:~# find /sys/kernel/debug/tracing/events/ -type d| grep -E &#x27;dma|gpu&#x27;</span><br><span class="line">/sys/kernel/debug/tracing/events/dma_fence</span><br><span class="line">/sys/kernel/debug/tracing/events/dma_fence/dma_fence_emit</span><br><span class="line">/sys/kernel/debug/tracing/events/dma_fence/dma_fence_init</span><br><span class="line">/sys/kernel/debug/tracing/events/dma_fence/dma_fence_destroy</span><br><span class="line">/sys/kernel/debug/tracing/events/dma_fence/dma_fence_enable_signal</span><br><span class="line">/sys/kernel/debug/tracing/events/dma_fence/dma_fence_signaled</span><br><span class="line">/sys/kernel/debug/tracing/events/dma_fence/dma_fence_wait_start</span><br><span class="line">/sys/kernel/debug/tracing/events/dma_fence/dma_fence_wait_end</span><br><span class="line">root@sie-luc:~# cat /sys/kernel/debug/tracing/events/dma_fence/dma_fence_enable_signal/</span><br><span class="line">cat: /sys/kernel/debug/tracing/events/dma_fence/dma_fence_enable_signal/: Is a directory</span><br><span class="line">root@sie-luc:~# cat /sys/kernel/debug/tracing/events/dma_fence/dma_fence_enable_signal/</span><br><span class="line">enable   filter   format   id       trigger</span><br><span class="line">root@sie-luc:~# cat /sys/kernel/debug/tracing/events/dma_fence/dma_fence_enable_signal/enable</span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<h1 id="å¸¸ç”¨å‘½ä»¤"><a class="markdownIt-Anchor" href="#å¸¸ç”¨å‘½ä»¤"></a> å¸¸ç”¨å‘½ä»¤</h1>
<ul>
<li><code>perf top -e cycles</code></li>
</ul>
<p><img src="/images/perf/perf_top-cycles.png" alt="perf top" /></p>
<ul>
<li>
<p><code>perf record -F 999 -p PID -g</code></p>
<ul>
<li>é»˜è®¤ä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆ perf.data, åé¢å¦‚æœå†æ‰§è¡Œä¹‹å‰çš„ perf.data ä¼šè‡ªåŠ¨é‡å‘½å perf.data.old</li>
</ul>
</li>
<li>
<p><code>perf script | /path/to/FlameGraph/stackcollapse-perf.pl | /path/to/FlameGraph/framegraph.pl &gt; result.svg</code></p>
<ul>
<li>
<p>ç”Ÿæˆç«ç„°å›¾éœ€è¦è¿™ä¸ªè„šæœ¬å·¥å…· <a href="https://github.com/brendangregg/FlameGraph">FlameGraph</a>ï¼Œè€Œä¸”å¦‚æœæƒ³çœ‹åˆ°è¯¦ç»†çš„è°ƒç”¨æ ˆéœ€è¦ç¼–è¯‘è·Ÿè¸ªå¯¹è±¡ä¸º <strong>Debug</strong> ç‰ˆæœ¬</p>
</li>
<li>
<p>æœ€è¿‘æœ‰ä¸€ä¸ª Rust å†™çš„ <a href="https://github.com/flamegraph-rs/flamegraph">flamegraph-rs/flamegraph</a> é¡¹ç›®ï¼Œç”¨ <code>flamegraph</code> äºŒè¿›åˆ¶å¯æ‰§è¡Œç¨‹åºä»£æ›¿äº†åŸæ¥çš„ Perl è„šæœ¬ï¼Œè€Œä¸”æŠŠåŸæ¥åˆ†åˆ«æ‰§è¡Œ <code>perf record</code> å’Œ <code>perf script</code> è¿™ä¸¤æ­¥åˆæˆä¸€æ­¥ï¼Œå³å¯ç”Ÿæˆç«ç„°å›¾</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">flamegraph -- vkgears</span><br></pre></td></tr></table></figure>
<p><img src="/images/perf/flamegraph.svg" alt="flamegraph-rs/flamegraph" /></p>
</li>
</ul>
</li>
</ul>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://github.com/brendangregg/FlameGraph">FlameGraph</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>perf</tag>
      </tags>
  </entry>
  <entry>
    <title>perfetto</title>
    <url>/lnx/perfetto/</url>
    <content><![CDATA[<h1 id="perfetto"><a class="markdownIt-Anchor" href="#perfetto"></a> <a href="https://perfetto.dev/">Perfetto</a></h1>
<p>Perfetto æ˜¯ä¸€ä¸ªç”¨äº Linux å’Œ Android ç³»ç»Ÿä¸Šè¿›è¡Œç³»ç»Ÿçº§å’Œåº”ç”¨çº§çš„è·Ÿè¸ªå’Œæ€§èƒ½åˆ†æçš„å¼€æºå·¥å…·ã€‚Perfetto æ†ç»‘äº†è®¸å¤šæ•°æ®æºï¼Œè¿™äº›æ•°æ®æºèƒ½å¤Ÿä»ä¸åŒçš„ç³»ç»Ÿæ¥å£æ”¶é›†è¯¦ç»†çš„æ€§èƒ½æ•°æ®ï¼ŒåŒ…æ‹¬ ftrace, /proc, /sys, native heap profiling ç­‰ã€‚Perfetto è¿˜æä¾›äº†ä¸€ä¸ªåŸºäº Web çš„ç”¨æˆ·ç•Œé¢ï¼Œç”¨äºè·Ÿè¸ªæ•°æ®çš„å¯è§†åŒ–å’Œåˆ†æã€‚è¿™é‡Œä¸»è¦æ˜¯å¯¹ç¬¬ä¸€æ¬¡ä½¿ç”¨ perfetto åšä¸€ä¸‹è®°å½•ï¼Œæ–¹ä¾¿ä»¥åç»§ç»­å­¦ä¹ å’Œæ•´ç†ã€‚</p>
<p><img src="/images/perfetto/perfetto.png" alt="perfetto" /></p>
<span id="more"></span>
<h1 id="perfetto-in-mesa"><a class="markdownIt-Anchor" href="#perfetto-in-mesa"></a> Perfetto in Mesa</h1>
<p>ç¬¬ä¸€æ¬¡ä½¿ç”¨ Perfetto æ˜¯ä» Mesa å¼€å§‹çš„ï¼Œè‡ªä» Mesa æœ‰äº† Perfetto çš„æ”¯æŒï¼Œå°±ä¸€ç›´æƒ³çœ‹çœ‹ Perfetto æ˜¯æ€ä¹ˆç©çš„ï¼Œæ­£å¥½æœ€è¿‘æƒ³æ¯”è¾ƒä¸€ä¸‹ Zink + LAVAPIPE å’Œç›´æ¥çš„ LLVMPIPE ä¸¤è€…çš„æ€§èƒ½å·®å¼‚ï¼Œå°±åœ¨æˆ‘çš„ WSL2 Ubuntu 23.04 ä¸ŠæŠ˜è…¾äº†ä¸€ç•ªã€‚ä¸‹é¢æœ‰å‡ ç‚¹åŸºæœ¬æƒ…å†µä¸‹è¯´æ˜ä¸€ä¸‹:</p>
<ul>
<li>Perfetto åœ¨ Mesa ä»“åº“é‡Œæ˜¯ä»¥ä¸€ä¸ª submodule å­˜åœ¨çš„ï¼Œè€Œä¸”æ„å»ºé€‰é¡¹é»˜è®¤æ˜¯å…³é—­çš„ (-Dperfetto=false)</li>
<li>å¯åŠ¨ perfetto æ—¶éœ€è¦é…ç½®æ–‡ä»¶ï¼ŒMesa ä»“åº“ä¹Ÿæœ‰å¥½å‡ ä¸ª<a href="https://gitlab.freedesktop.org/mesa/mesa/-/tree/main/src/tool/pps/cfg">é…ç½®æ–‡ä»¶</a></li>
<li>perfetto åœ¨ Linux çš„ä¸»è¦æ•°æ®æºæ˜¯ ftrace, /proc, /sys è¿™äº›ï¼Œå› ä¸ºæˆ‘æ˜¯åœ¨ WSL2 ä¸Šï¼Œ æ‰€ä»¥ tracefs é»˜è®¤æ˜¯æ²¡æœ‰æŒ‚è½½çš„ï¼Œéœ€è¦æ‰‹åŠ¨æŒ‚è½½ä¸€ä¸‹
<ul>
<li><code>sudo mount -t tracefs tracefs /sys/kernel/tracing</code></li>
<li>WSL2 çš„å†…æ ¸æœ‰äº›ä¸œè¥¿æ˜¯ä¸å¯ç”¨çš„ï¼Œè¿˜å¥½ <code>CONFIG_FTRACE=y</code>, <code>CONFIG_TRACING=y</code>, è¿™å°±çœå¾—é‡æ–°ç¼–è¯‘å†…æ ¸äº†</li>
</ul>
</li>
<li>perfetto ä»“åº“è‡ªå·±æä¾›äº†ä¸€äº›ç”¨äºæ„å»ºçš„ Python è„šæœ¬ï¼Œåªéœ€æŒ‰ç…§å®ƒçš„ <a href="https://perfetto.dev/docs/quickstart/linux-tracing">quickstart guide</a> æ„å»ºå°±è¡Œäº†ï¼Œä½†æœ‰ä¸€ç‚¹å¾ˆæ€ªï¼Œperfetto è¦ç”¨ google è‡ªå·±çš„ clang å·¥å…·é“¾(å®ƒçš„æ„å»ºè„šæœ¬é‡Œå¹¶æ²¡æœ‰ç»™ç”¨æˆ·æä¾›ä½¿ç”¨ç³»ç»Ÿå·²æœ‰çš„ Clang å·¥å…·é“¾çš„é€‰é¡¹)</li>
</ul>
<p>å®é™…ä¸Šä»æ„å»ºåˆ°ç”Ÿæˆ <code>/tmp/trace.perfetto-trace</code> (ä¸Šä¼ åˆ°<a href="https://ui.perfetto.dev/">ui.perfetto.dev</a> å³å¯)ï¼Œå…³é”®æ­¥éª¤æœ‰ä»¥ä¸‹å‡ ä¸ª:</p>
<ul>
<li><code>cd mesa/subproject/perfetto &amp;&amp; ./tools/install-build-deps</code>
<ul>
<li>ä¸è¦å¸¦ --no-toolchain, ä¸€å¼€å§‹ä¸‹è½½æ…¢ï¼Œç¯å¢ƒä¸Šä¹Ÿæœ‰ clang, å°±æƒ³ä¸ä¸‹è½½ clang, ç»“æœå‘ç°ä¸è¡Œ</li>
</ul>
</li>
<li><code>./tools/setup_all_configs.py --host-only</code>
<ul>
<li>ä¼šåœ¨å½“å‰ç›®å½•çš„ out ç›®å½•ä¸‹ç”Ÿæˆå¤šä¸ªç›®å½•ï¼Œä¸‹ä¸€æ­¥æŒ‡å®šç»™ <code>ninja -C</code></li>
</ul>
</li>
<li><code>ninja -C out/linux_clang_release</code>
<ul>
<li>å¦‚æœé¡ºåˆ©çš„è¯ï¼Œperfetto å°±æ„å»ºå®Œæˆäº†</li>
</ul>
</li>
<li><code>CONFIG=../../src/tool/pps/cfg/system.cfg OUT=out/linux_clang_release ./tools/tmux -n </code>
<ul>
<li>é…ç½®æ–‡ä»¶å¯ä»¥é€šè¿‡ CONFIG ç¯å¢ƒå˜é‡æŒ‡å®š, è¿™é‡Œçš„æˆ‘ç”¨ Mesa è‡ªå¸¦çš„ system.cfgã€‚è¿™é‡Œçš„ tmux æ˜¯ä¸€ä¸ª shell è„šæœ¬ï¼Œå®ƒä¼šå¯ä¸€ä¸ª tmux ä¼šè¯ï¼Œä½ åœ¨å¦å¤–ä¸€ä¸ªç»ˆç«¯å¯åŠ¨ä½ çš„åº”ç”¨ç¨‹åºåï¼Œåˆ‡å›è¿™ä¸ªä¼šè¯ Enter, perfetto å°±å¼€å§‹è®°å½•æ•°æ®äº†ï¼Œä¸€èˆ¬æœ‰ä¸€ä¸ªé»˜è®¤æ—¶é•¿ï¼Œå½“è®°å½•ç»“æŸåï¼Œä½ åªéœ€ <code>Ctrl-B D</code> å…³é—­è¿™ä¸ªä¼šè¯ï¼Œè®°å½•çš„æ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åœ¨ <code>/tmp/trace.perfetto-trace</code> æ–‡ä»¶ä¸­ã€‚</li>
</ul>
</li>
</ul>
<p>ä»ç¬¬ä¸€æ¬¡ä½¿ç”¨ perfetto çš„æƒ…å†µï¼Œæ„Ÿè§‰å®ƒæ¯”è¾ƒä¾èµ– KMD çš„å®ç°ï¼Œåƒ GPU çš„æ€§èƒ½è®¡æ•°å™¨ï¼Œåªæœ‰å†…æ ¸é©±åŠ¨å®ç°äº†ï¼Œæ‰èƒ½é€šè¿‡ perfetto æ”¶é›†åˆ°ï¼Œä¸è¿‡ perfetto æä¾›çš„åº“å’Œ UI ç¡®å®ç®€åŒ–äº†æ€§èƒ½æ•°æ®é‡‡é›†çš„è¿‡ç¨‹å’Œåˆ†æçš„éš¾åº¦ã€‚</p>
<h1 id="perfetto-in-android"><a class="markdownIt-Anchor" href="#perfetto-in-android"></a> Perfetto in Android</h1>
<p>Perfetto åœ¨ Android ä¸Šä¸»è¦æ˜¯å’Œ <a href="https://source.android.google.cn/devices/tech/debug/systrace?hl=zh-cn">systrace</a> é…åˆä½¿ç”¨ï¼Œå¼€å‘è€…å¯ä»¥åœ¨ Android è®¾å¤‡ä¸Šæ‰“å¼€ <strong>System Tracing</strong>, å°†è¿½è¸ªçš„ trace æ–‡ä»¶é€šè¿‡ Chrome æµè§ˆå™¨æ‰“å¼€ç½‘é¡µ <a href="https://ui.perfetto.dev/">ui.perfetto.dev</a> åŠ è½½è¿›è¡ŒæŸ¥çœ‹åˆ†æã€‚</p>
<p><img src="/images/perfetto/xiaomi-system-tracing.png" alt="xiaomi-system-tracing" /><br />
<img src="/images/perfetto/xiaomi-system-tracing-2.png" alt="xiaomi-system-tracing-2" /></p>
<p>NOTE: ä¸Šé¢çš„è·Ÿè¸ªæ—¥å¿—æ–‡ä»¶æ¥è‡ªæˆ‘çš„çº¢ç±³æ‰‹æœºï¼Œéœ€è¦å…ˆè®©<strong>å¼€å‘è€…é€‰é¡¹</strong>åœ¨<strong>è®¾ç½®</strong>ç•Œé¢å‡ºç°ï¼Œæ‰èƒ½æ‰“å¼€ System Tracing</p>
<ul>
<li>è°ƒå‡º<strong>å¼€å‘è€…é€‰é¡¹</strong></li>
</ul>
<pre><code class="highlight mermaid">flowchart LR
	Step_1@&#123; img: &quot;/images/perfetto/activate-system-tracing-1.png&quot;, w: 360, h: 720, constraint: &quot;on&quot; &#125;
	Step_2@&#123; img: &quot;/images/perfetto/activate-system-tracing-2.png&quot;, w: 360, h: 720, constraint: &quot;on&quot; &#125;
	Step_3@&#123; img: &quot;/images/perfetto/activate-system-tracing-3.png&quot;, w: 360, h: 720, constraint: &quot;on&quot; &#125;
    Step_1 --&gt; Step_2 --&gt; Step_3</code></pre>
<ul>
<li>æ‰“å¼€<strong>ç³»ç»Ÿè·Ÿè¸ª</strong></li>
</ul>
<pre><code class="highlight mermaid">flowchart LR
	Step_1@&#123; img: &quot;/images/perfetto/activate-system-tracing-4.png&quot;, w: 360, h: 720, constraint: &quot;on&quot; &#125;
	Step_2@&#123; img: &quot;/images/perfetto/activate-system-tracing-5.png&quot;, w: 360, h: 720, constraint: &quot;on&quot; &#125;
	Step_3@&#123; img: &quot;/images/perfetto/activate-system-tracing-6.jpg&quot;, w: 360, h: 720, constraint: &quot;on&quot; &#125;
    Step_1 --&gt; Step_2 --&gt; Step_3</code></pre>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://blog.csdn.net/Jason_Lee155/article/details/126691265">Android æ€§èƒ½åˆ†æå·¥å…·-systraceä½¿ç”¨</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>perf</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux Power Management</title>
    <url>/lnx/pm/</url>
    <content><![CDATA[<h1 id="power-state"><a class="markdownIt-Anchor" href="#power-state"></a> Power State</h1>
<table>
<thead>
<tr>
<th style="text-align:left">Level</th>
<th style="text-align:left">State</th>
<th style="text-align:left">Power</th>
<th style="text-align:left">Command<br>(systemctl)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">S0</td>
<td style="text-align:left">idle</td>
<td style="text-align:left">full</td>
<td style="text-align:left">N/A</td>
</tr>
<tr>
<td style="text-align:left">S1</td>
<td style="text-align:left">sleep</td>
<td style="text-align:left">low</td>
<td style="text-align:left">N/A</td>
</tr>
<tr>
<td style="text-align:left">S2</td>
<td style="text-align:left">deeper sleep</td>
<td style="text-align:left">lower</td>
<td style="text-align:left">N/A</td>
</tr>
<tr>
<td style="text-align:left">S3</td>
<td style="text-align:left">suspend to RAM</td>
<td style="text-align:left">CPU off RAM on</td>
<td style="text-align:left">suspend</td>
</tr>
<tr>
<td style="text-align:left">S4</td>
<td style="text-align:left">suspend to DISK</td>
<td style="text-align:left">Most devices off</td>
<td style="text-align:left">hibernate</td>
</tr>
<tr>
<td style="text-align:left">S5</td>
<td style="text-align:left">shutdown</td>
<td style="text-align:left">completely off</td>
<td style="text-align:left">poweroff</td>
</tr>
</tbody>
</table>
<span id="more"></span>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>PRIME</title>
    <url>/lnx/prime/</url>
    <content><![CDATA[<ol>
<li><a href="https://blog.csdn.net/hexiaolong2009/article/details/105961192">å…³äº DRM ä¸­ DUMB å’Œ PRIME åå­—çš„ç”±æ¥</a></li>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/10595">In case of prime, allocate linear_buffer from display GPU VRAM instead of render GPU</a></li>
<li><a href="https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/12788">loader/dri3: avoid reusing the same back buffer with DRI_PRIME</a></li>
</ol>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>DRM/KMS</tag>
      </tags>
  </entry>
  <entry>
    <title>Scheduler</title>
    <url>/lnx/sched/</url>
    <content><![CDATA[<h1 id="task-state"><a class="markdownIt-Anchor" href="#task-state"></a> Task State</h1>
<pre><code class="highlight mermaid">stateDiagram-v2
    R: running
    S: sleeping
    D: disk sleep
    T: stopped
    t: tracing stop
    X: dead
    Z: zombie
    P: parked
    I: idle

    R --&gt; S: schedule_timeout()
    R --&gt; D: Wait for Disk I/O
    R --&gt; T: SIGTSTP
    R --&gt; t: gdb/strace
    S --&gt; R: wake_up_process()
    D --&gt; R: I/O Completed
    T --&gt; R: SIGCONT
    T --&gt; t: gdb/strace
    T --&gt; Z: SIGKILL But Sth Wrong with Its Parent
    R --&gt; Z: Exit But Sth Wrong with Its Parent
    t --&gt; T: Quit gdb</code></pre>
<span id="more"></span>
<p>Notes:</p>
<ul>
<li><code>disk sleep</code> ä¹Ÿå°±æ˜¯ <strong>uninterruptible sleep</strong> çŠ¶æ€</li>
<li><code>zombie</code> çŠ¶æ€çš„è¿›ç¨‹åœ¨ <code>ps</code> ä¸­è¢«æ ‡è®°ä¸º <code>&lt;defunct&gt;</code></li>
<li>æ­£å¸¸çš„ç©ºé—²ç”¨æˆ·è¿›ç¨‹ä¸€èˆ¬æ˜¯ <code>sleeping</code> çŠ¶æ€ï¼Œç©ºé—²çš„ kthread æ˜¯ <code>idle</code> çŠ¶æ€</li>
</ul>
<h1 id="å†…æ ¸ä¸­å’Œè°ƒåº¦ç›¸å…³çš„-apis"><a class="markdownIt-Anchor" href="#å†…æ ¸ä¸­å’Œè°ƒåº¦ç›¸å…³çš„-apis"></a> å†…æ ¸ä¸­å’Œè°ƒåº¦ç›¸å…³çš„ APIs</h1>
<ul>
<li>
<p><code>signed long __sched shedule_timeout_interruptible(signed long timeout);</code></p>
<ul>
<li>è°ƒç”¨è€… task å¼€å§‹<em>ç¡çœ ç›´åˆ°è¶…æ—¶</em></li>
</ul>
</li>
<li>
<p><code>wait_event_timeout(wq_head, condition, timeout)</code></p>
<ul>
<li><code>wq_head</code>: æ­£åœ¨ç­‰å¾…çš„ä¸€ä¸ªé˜Ÿåˆ— <em>waitqueue</em>, æ¯æ¬¡ <em>wq_head</em> è¢«å”¤é†’ï¼Œ <em>condition</em> éƒ½ä¼šè¢«æ£€æŸ¥ä¸€æ¬¡</li>
</ul>
</li>
</ul>
<h1 id="å…¶å®ƒ"><a class="markdownIt-Anchor" href="#å…¶å®ƒ"></a> å…¶å®ƒ</h1>
<ul>
<li><code>static inline int signal_pending(struct task_struct *)</code>
<ul>
<li>æ£€æŸ¥å½“å‰ task æ˜¯å¦æœ‰ä¿¡å·å¤„ç†ï¼Œè¿”å›<em>é 0</em> è¡¨ç¤ºæœ‰ä¿¡å·éœ€è¦å¤„ç†</li>
</ul>
</li>
</ul>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://stackoverflow.com/questions/2147299/when-to-use-kernel-threads-vs-workqueues-in-the-linux-kernel">when-to-use-kernel-threads-vs-workqueues-in-the-linux-kernel</a></li>
<li><a href="https://lwn.net/Articles/511421/">Making workqueues non-reentrant</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/361409809">çŸ¥ä¹ï¼šLinux softirq, tasklet å’Œ workqueue</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>strace - System Call Tracing</title>
    <url>/lnx/strace/</url>
    <content><![CDATA[<figure class="highlight txt"><figcaption><span>strace -c -w -o glmark2.strace glmark2</span></figcaption><table><tr><td class="code"><pre><span class="line">% time     seconds  usecs/call     calls    errors syscall</span><br><span class="line">------ ----------- ----------- --------- --------- ------------------</span><br><span class="line"> 55.82   14.421660          55    258416           ioctl</span><br><span class="line"> 16.68    4.309981          18    238578    205238 recvmsg</span><br><span class="line"> 14.62    3.777039          17    210879        42 futex</span><br><span class="line">  5.06    1.306534          16     77652           getpid</span><br><span class="line">  2.73    0.705886          21     33276           writev</span><br><span class="line">  2.51    0.648318          17     36385           close</span><br><span class="line">  2.40    0.620114          18     33335           ppoll</span><br><span class="line">  0.04    0.011076          24       452           read</span><br><span class="line">  0.04    0.009150          32       281        47 openat</span><br><span class="line">  0.02    0.005639          30       187           mmap</span><br><span class="line">  0.01    0.003267          28       113           munmap</span><br><span class="line">  0.01    0.003240          21       152       120 readlinkat</span><br><span class="line">  0.01    0.002085          26        80           mprotect</span><br><span class="line">  0.01    0.002033          19       104           newfstatat</span><br><span class="line">  0.01    0.001976          26        75           brk</span><br><span class="line">  0.01    0.001364          71        19           recvfrom</span><br><span class="line">  0.00    0.001138          54        21           clone3</span><br><span class="line">  0.00    0.000778          18        43           rt_sigprocmask</span><br><span class="line">  0.00    0.000679          27        25           write</span><br><span class="line">  0.00    0.000645          29        22           getdents64</span><br><span class="line">  0.00    0.000493         492         1           execve</span><br><span class="line">  0.00    0.000323          17        18           lseek</span><br><span class="line">  0.00    0.000249          20        12           getrusage</span><br><span class="line">  0.00    0.000232          17        13           getrandom</span><br><span class="line">  0.00    0.000163          27         6           memfd_create</span><br><span class="line">  0.00    0.000150          24         6           sendmsg</span><br><span class="line">  0.00    0.000136          22         6           ftruncate</span><br><span class="line">  0.00    0.000131          16         8           fcntl</span><br><span class="line">  0.00    0.000054          18         3           geteuid</span><br><span class="line">  0.00    0.000054          18         3           getuid</span><br><span class="line">  0.00    0.000047          23         2         1 faccessat</span><br><span class="line">  0.00    0.000037          18         2           uname</span><br><span class="line">  0.00    0.000033          32         1           socket</span><br><span class="line">  0.00    0.000031          30         1           shutdown</span><br><span class="line">  0.00    0.000028          27         1           connect</span><br><span class="line">  0.00    0.000018          17         1           getpeername</span><br><span class="line">  0.00    0.000018          17         1           sched_getaffinity</span><br><span class="line">  0.00    0.000017          17         1           rt_sigaction</span><br><span class="line">  0.00    0.000017          16         1           prlimit64</span><br><span class="line">  0.00    0.000017          16         1           set_tid_address</span><br><span class="line">  0.00    0.000016          16         1           rseq</span><br><span class="line">  0.00    0.000016          16         1           set_robust_list</span><br><span class="line">------ ----------- ----------- --------- --------- ------------------</span><br><span class="line">100.00   25.834885          29    890185    205448 total</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p><a href="https://github.com/strace/strace">strace</a> ä¸»è¦æ˜¯ç”¨æ¥è·Ÿè¸ªåˆ†æ Linux ç³»ç»Ÿè°ƒç”¨çš„ï¼Œå› ä¸ºç³»ç»Ÿè°ƒç”¨æ˜¯ç”¨æˆ·ç¨‹åºä¸å†…æ ¸äº¤äº’çš„å”¯ä¸€é€”å¾„ï¼Œæ‰€ä»¥ strace å¯¹äºè°ƒè¯•åƒç”¨æˆ·æ€é©±åŠ¨ç¨‹åºè¿™æ ·çš„ç³»ç»Ÿè½¯ä»¶å¾ˆæœ‰å¸®åŠ©ã€‚</p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://gist.github.com/reveng007/3e1d7a692649d30a75e566684207880c">strace vs. ltrace vs. ptrace vs. ftrace</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>Sync File, the carrier of fences</title>
    <url>/lnx/sync_file/</url>
    <content><![CDATA[<p><img src="/images/dot/everything-is-file.svg" alt="everything is file" /></p>
<span id="more"></span>
<h1 id="introduction"><a class="markdownIt-Anchor" href="#introduction"></a> Introduction</h1>
<p>ä» Linux çš„ <em>ä¸€åˆ‡çš†æ–‡ä»¶</em> è®¾è®¡è§’åº¦æ¥çœ‹ï¼Œ Sync file å’Œ DMA-BUF, Sync object ç±»ä¼¼ï¼Œéƒ½æ˜¯ä¸ºäº†å°†å†…æ ¸ç©ºé—´çš„æŸä¸ªå¯¹è±¡æš´éœ²ç»™ç”¨æˆ·ç©ºé—´ï¼Œå¹¶èƒ½ä½¿è¿™ä¸ªå¯¹è±¡ä»¥ file descriptor çš„å½¢å¼åœ¨è¿›ç¨‹ä¹‹é—´ä¼ é€’åˆ†äº«ã€‚</p>
<p>DMA-BUF è§£å†³çš„æ˜¯ Buffer åœ¨è®¾å¤‡ä¹‹é—´(GPU ä¸ DISPLAY)ï¼Œé©±åŠ¨ä¹‹é—´(DRM ä¸ V4L2)ï¼Œä»¥åŠè¿›ç¨‹ä¹‹é—´(Compositor ä¸ Client)çš„å…±äº«é—®é¢˜ã€‚Sync object ä¸ Sync file ç›¸ä¼¼ï¼Œéƒ½æ˜¯è§£å†³å†…æ ¸åŒæ­¥åŸè¯­åœ¨è¿›ç¨‹é—´ä¼ é€’çš„é—®é¢˜ï¼Œå®ƒä»¬çš„åŒºåˆ«æ˜¯å‰è€…ä¸€ä¸ªå¯¹è±¡åªå°è£…<strong>ä¸€ä¸ª</strong> fence, è€Œåè€…æ”¯æŒä¸ä¸€ä¸ª dma-buf ç›¸å…³çš„<strong>å¤šä¸ª</strong> fences çš„é›†åˆã€‚</p>
<p>Sync file èµ·åˆæ˜¯ä» Android kernel å¼•å…¥çš„ï¼Œ å½“ Dave Airlie å’Œ Faith Ekstrand åˆ†åˆ«åœ¨ 2017 å¹´ å’Œ 2022 å¹´æäº¤äº† <a href="https://lists.freedesktop.org/archives/dri-devel/2017-June/143204.html">drm/syncobj: add sync_file interaction. (v1.2)</a> å’Œ <a href="https://patchwork.freedesktop.org/series/104898/">dma-buf: Add an API for exporting sync files (v15)</a> ä¸¤ä¸ªè¡¥ä¸é›†åï¼ŒSync file ä¾¿åˆ†åˆ«ä¸ DRM Syncobj å’Œ DMA-BUF äº§ç”Ÿäº†å…³è”ï¼Œè€Œåè€…çš„åˆå…¥æ ‡å¿—ç€Linux å›¾å½¢ä¸–ç•Œå·²ç»åœ¨ implicit sync å’Œ explicit sync ä¹‹é—´å»ºèµ·äº†ä¸€åº§æ¡¥æ¢ã€‚</p>
<h1 id="background"><a class="markdownIt-Anchor" href="#background"></a> Background</h1>
<h2 id="implicit-sync-vs-explicit-sync"><a class="markdownIt-Anchor" href="#implicit-sync-vs-explicit-sync"></a> Implicit sync vs Explicit sync</h2>
<p>ä»å®è§‚å±‚é¢è®²ï¼ŒImplicit sync æŒ‡åŒæ­¥ç”± UMD å’Œ KMD å®Œå…¨å¤„ç†ï¼Œ3D åº”ç”¨ç¨‹åºä¸å‚ä¸(3Dåº”ç”¨ç¨‹åºåŒ…æ‹¬ compositor)ï¼Œ ç›¸åï¼ŒExplicit sync æŒ‡ä»€ä¹ˆæ—¶å€™ç­‰å¾…ï¼Œç­‰å¾…è°ï¼Œéƒ½äº¤ç»™åº”ç”¨ç¨‹åºè‡ªå·±å†³å®šå’Œå¤„ç†ã€‚Android graphics ä»ä¸€å¼€å§‹å°±é‡‡ç”¨ Explicit sync æœºåˆ¶ï¼Œè€Œ Linux desktop åœ¨ Vulkan ä¹‹å‰åŸºæœ¬ä¸Šéƒ½æ˜¯é‡‡ç”¨ Implicit sync, å› ä¸º Vulkan API è¢«è®¾è®¡æˆæ”¯æŒ Explicit sync, å› ä¸ºåœ¨æ•´ä¸ªå›¾å½¢æ ˆé‡Œï¼Œä»æ¸²æŸ“åˆ°åˆæˆåˆ°æ˜¾ç¤ºï¼Œä»»ä½•ä¸€ä¸ªç¯èŠ‚åªè¦ä¸æ”¯æŒ Explicit syncï¼Œæ•´ä¸ªè·¯å¾„å°±åªèƒ½èµ° implicit sync, è¿™å°±å¯¼è‡´ Vulkan åº”ç”¨ä¸å…¶å®ƒé‡‡ç”¨ Implict sync çš„åº”ç”¨ä¹‹é—´ï¼Œå°¤å…¶æ˜¯ä¸ X Server ä¹‹é—´çš„åŒæ­¥å˜æˆä¸€ä¸ªé—®é¢˜ã€‚</p>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://zamundaaa.github.io/wayland/2024/04/05/explicit-sync.html">Explicit sync</a></li>
<li><a href="https://www.collabora.com/news-and-blog/blog/2022/06/09/bridging-the-synchronization-gap-on-linux/">Bridging the synchronization gap on Linux</a></li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>Syscall vs C routines</title>
    <url>/lnx/syscall/</url>
    <content><![CDATA[<p>ç³»ç»Ÿè°ƒç”¨æ˜¯ Linux ç”¨æˆ·æ€ç¨‹åºä¸å†…æ ¸é€šä¿¡çš„æ¥å£ã€‚ æ¯ä¸ªç‰¹å®šçš„æ–‡ä»¶ç³»ç»Ÿéƒ½ä¼šåœ¨è‡ªå·±çš„ <code>file_operations</code> é‡Œæä¾›å„ç§æ–‡ä»¶æ“ä½œæ¥å£ï¼Œåƒ <code>.open</code>, <code>.close</code>, <code>.ioctl</code>ã€‚ç³»ç»Ÿè°ƒç”¨ä¼šé€šè¿‡ VFS çš„æ¥å£è°ƒç”¨è¿™äº›å…·ä½“çš„å®ç°ï¼Œè€Œå¯¹äºåº”ç”¨ç¨‹åºæ¥è¯´ï¼Œä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæ˜¯è°ƒç”¨ C åº“å‡½æ•° (C routines).</p>
<p>ioctl è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„å£°æ˜å¤§æ¦‚æ˜¯è¿™æ ·:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">COMPAT_SYSCALL_DEFINE3(ioctl, unsigned int, fd, unsigned int, cmd, compat_ulong_t, arg)</span><br></pre></td></tr></table></figure>
<p>ioctl çš„ C åº“å‡½æ•° (Aarch64 å®ç°)ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">	.text</span><br><span class="line">ENTRY(__ioctl)</span><br><span class="line">    /* move ioctl syscall number to x8 register */</span><br><span class="line">	mov	x8, #__NR_ioctl</span><br><span class="line">    /* sign extend w0 to x0 */</span><br><span class="line">	sxtw	x0, w0</span><br><span class="line">    /* issue software interrupt to invoke syscall */</span><br><span class="line">	svc	#0x0</span><br><span class="line">    /* add 4095 to x0 and set flags according to result */</span><br><span class="line">	cmn	x0, #4095</span><br><span class="line">    /* if carry bit is set (previous addition carrys out), branch to Lsyscall_error */</span><br><span class="line">	b.cs	.Lsyscall_error</span><br><span class="line">	ret</span><br><span class="line">PSEUDO_END (__ioctl)</span><br><span class="line"></span><br><span class="line">/* symbol management, making __ioctl and ioctl effectively the same function */</span><br><span class="line">libc_hidden_def (__ioctl)</span><br><span class="line">weak_alias (__ioctl, ioctl)</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h1 id="è¿”å›å€¼"><a class="markdownIt-Anchor" href="#è¿”å›å€¼"></a> è¿”å›å€¼</h1>
<p>å› ä¸ºç³»ç»Ÿè°ƒç”¨å¤±è´¥æ—¶è¿”å›çš„éƒ½æ˜¯ <code>-errno</code>, æ‰€ä»¥å½“å¤±è´¥æ—¶ <code>cmn x0, #4095</code> çš„ç»“æœå¿…ç„¶å¯¼è‡´ carry æ ‡å¿—ä½è¢«ç½®ï¼Œåé¢çš„ <code>b.cs</code> (carry set branch) åˆ™ä¼šè·³è½¬åˆ° <code>Lsyscall_error</code> æ ‡ç­¾ç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥ C åº“å‡½æ•° <code>ioctl()</code> å¤±è´¥æ—¶çš„è¿”å›å€¼æ˜¯å¤šå°‘ï¼Œå°±è¦çœ‹ <code>Lsyscall_error</code> çš„å¤„ç†äº†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># if !IS_IN (libc)</span><br><span class="line">#  define SYSCALL_ERROR  .Lsyscall_error</span><br><span class="line">#  if RTLD_PRIVATE_ERRNO</span><br><span class="line">#   define SYSCALL_ERROR_HANDLER				\</span><br><span class="line">.Lsyscall_error:						\</span><br><span class="line">	adrp	x1, C_SYMBOL_NAME(rtld_errno);			\</span><br><span class="line">	neg     w0, w0;						\</span><br><span class="line">	str     w0, [x1, :lo12:C_SYMBOL_NAME(rtld_errno)];	\</span><br><span class="line">	mov	x0, -1;						\</span><br><span class="line">	RET;</span><br><span class="line">#  else</span><br><span class="line"></span><br><span class="line">#   define SYSCALL_ERROR_HANDLER				\</span><br><span class="line">.Lsyscall_error:						\</span><br><span class="line">	adrp	x1, :gottprel:errno;				\</span><br><span class="line">	neg	w2, w0;						\</span><br><span class="line">	ldr	PTR_REG(1), [x1, :gottprel_lo12:errno];		\</span><br><span class="line">	mrs	x3, tpidr_el0;					\</span><br><span class="line">	mov	x0, -1;						\</span><br><span class="line">	str	w2, [x1, x3];					\</span><br><span class="line">	RET;</span><br><span class="line">#  endif</span><br><span class="line"># else</span><br><span class="line">#  define SYSCALL_ERROR __syscall_error</span><br><span class="line">#  define SYSCALL_ERROR_HANDLER                                 \</span><br><span class="line">.Lsyscall_error:                                                \</span><br><span class="line">	b	__syscall_error;</span><br><span class="line"># endif</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ— è®ºæ˜¯ <code>#if</code> æˆ– <code>#else</code> å“ªä¸ªåˆ†æ”¯ï¼Œ éƒ½æœ‰ <code>mov x0, -1</code>, æ‰€ä»¥ç»“è®ºå°±æ˜¯ C åº“å‡½æ•° <code>ioctl()</code> çš„è¿”å›å€¼ï¼šæˆåŠŸ <code>0</code>, å¤±è´¥ <code>-1</code>. ç›¸åº”çš„é”™è¯¯ç ä¼šä¿å­˜åœ¨ <code>errno</code>.</p>
<p>è¿™é‡Œå†çœ‹ä¸€ä¸‹ <a href="https://gitlab.freedesktop.org/mesa/drm">libdrm</a> åº“å¯¹ ioctl çš„å°è£…å‡½æ•°  <code>drmIoctl()</code>, å®ƒçš„è¿”å›å€¼ä»ç„¶æ˜¯ï¼šæˆåŠŸ <code>0</code>, å¤±è´¥ <code>-1</code>. åªä¸è¿‡å®ƒå¯¹ <code>EINTR</code>(4, â€œInterrupted system callâ€) å’Œ <code>EAGAIN</code>(11, â€œTry againâ€) è¿™ä¸¤ç§é”™è¯¯ç è¿›è¡Œäº†é‡è¯•ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drm_public int</span><br><span class="line">drmIoctl(int fd, unsigned long request, void *arg)</span><br><span class="line">&#123;</span><br><span class="line">    int ret;</span><br><span class="line"></span><br><span class="line">    do &#123;</span><br><span class="line">        ret = ioctl(fd, request, arg);</span><br><span class="line">    &#125; while (ret == -1 &amp;&amp; (errno == EINTR || errno == EAGAIN));</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†çœ‹ä¸€ä¸ªè°ƒç”¨ <code>drmIoctl()</code> çš„ libdrm çš„åº“å‡½æ•°ï¼Œæ¯”å¦‚ <code>drmSyncobjWait()</code>, å®ƒçš„è¿”å›å€¼åœ¨å¤±è´¥æ—¶å˜æˆäº† <code>-errno</code>, å½“ç„¶è¿™æ ·é¿å…è®©ä¸Šå±‚è°ƒç”¨è€…å»æ£€æŸ¥ <code>errno</code>, ä½†å´æ‰“ç ´äº†æ¥å£çš„ä¸€è‡´æ€§ï¼Œæœ‰åˆ©æœ‰å¼Šå§ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drm_public int drmSyncobjWait(int fd, uint32_t *handles, unsigned num_handles,</span><br><span class="line">                              int64_t timeout_nsec, unsigned flags,</span><br><span class="line">                              uint32_t *first_signaled)</span><br><span class="line">&#123;</span><br><span class="line">    struct drm_syncobj_wait args;</span><br><span class="line">    int ret;</span><br><span class="line"></span><br><span class="line">    memclear(args);</span><br><span class="line">    args.handles = (uintptr_t)handles;</span><br><span class="line">    args.timeout_nsec = timeout_nsec;</span><br><span class="line">    args.count_handles = num_handles;</span><br><span class="line">    args.flags = flags;</span><br><span class="line"></span><br><span class="line">    ret = drmIoctl(fd, DRM_IOCTL_SYNCOBJ_WAIT, &amp;args);</span><br><span class="line">    if (ret &lt; 0)</span><br><span class="line">        return -errno;</span><br><span class="line"></span><br><span class="line">    if (first_signaled)</span><br><span class="line">        *first_signaled = args.first_signaled;</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
      </tags>
  </entry>
  <entry>
    <title>udev, sysfs &amp; libudev</title>
    <url>/lnx/udev/</url>
    <content><![CDATA[<h1 id="udev"><a class="markdownIt-Anchor" href="#udev"></a> udev</h1>
<p>udevæ˜¯Linuxç³»ç»Ÿç®¡ç†<code>/dev</code>çš„å†…æ ¸ç»„ä»¶ï¼Œå®ƒè´Ÿè´£åœ¨ç³»ç»Ÿè¿è¡Œæ—¶åŠ¨æ€çš„åˆ›å»ºå’Œåˆ é™¤<code>/dev</code>ä¸‹çš„è®¾å¤‡æ–‡ä»¶(èŠ‚ç‚¹)ã€‚</p>
<ul>
<li>å½“è®¾å¤‡è¢«æ£€æµ‹åˆ°æ—¶åˆ›å»ºè®¾å¤‡æ–‡ä»¶</li>
<li>å½“è®¾å¤‡è¢«ç§»é™¤æ—¶åˆ é™¤è®¾å¤‡æ–‡ä»¶</li>
<li><code>/etc/udev/rules.d</code>å…è®¸ç”¨æˆ·è‡ªå®šä¹‰è®¾å¤‡æ–‡ä»¶çš„æƒé™ï¼Œè·¯å¾„å’Œç¬¦å·é“¾æ¥</li>
</ul>
<p>udevæ˜¾ç„¶æ˜¯æ”¯æŒHotplug, è€Œä¸”ä¿è¯<code>/dev</code>ä¸‹çš„è®¾å¤‡èŠ‚ç‚¹æ˜¯å®æ—¶æ›´æ–°çš„ã€‚è€Œä¸”å®ƒå¼ºå¤§çš„ç”¨æˆ·è‡ªå®šä¹‰è¡Œä¸ºéå¸¸çµæ´»ã€‚ä½†å®ƒçš„é—®é¢˜æ˜¯ï¼š</p>
<ul>
<li>ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™çš„å­˜åœ¨è®©åº”ç”¨ç¨‹åºå¾ˆéš¾ç¡®å®šç‰¹å®šçš„è®¾å¤‡æ–‡ä»¶å’Œè®¾å¤‡ç±»å‹</li>
<li>åŒä¸€ç±»å‹çš„å¤šä¸ªè®¾å¤‡ï¼Œè®¾å¤‡æ–‡ä»¶çš„åˆ›å»ºé¡ºåºæ˜¯ä¸ç¡®å®šçš„</li>
</ul>
<h1 id="reference"><a class="markdownIt-Anchor" href="#reference"></a> Reference</h1>
<p><a href="https://blog.csdn.net/fjb2080/article/details/7528894">libudev and sysfs tutorial</a></p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>è§‚â€œè€çŸ³è°ˆèŠ¯â€è§†é¢‘è®°</title>
    <url>/misc/1percent/</url>
    <content><![CDATA[<h1 id="1å®šå¾‹"><a class="markdownIt-Anchor" href="#1å®šå¾‹"></a> 1%å®šå¾‹</h1>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python -c <span class="string">&quot;print(1.01**365)&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>37.78343433288728</strong></p>
<p>æ¯å¤©æå‡1%, ä¸€å¹´åæå‡è¿‘38å€ã€‚</p>
]]></content>
      <categories>
        <category>misc</category>
      </categories>
  </entry>
  <entry>
    <title>è¯»ä¹¦</title>
    <url>/misc/books/</url>
    <content><![CDATA[<p><img src="/images/books/The_pleasure_of_finding_things_out.jpg" alt="The pleasure of finding things out" /></p>
<span id="more"></span>
<h1 id="å‘ç°çš„ä¹è¶£-the-pleasure-of-finding-things-out"><a class="markdownIt-Anchor" href="#å‘ç°çš„ä¹è¶£-the-pleasure-of-finding-things-out"></a> å‘ç°çš„ä¹è¶£ The Pleasure of Finding Things Out</h1>
<ul>
<li><a href="https://calteches.library.caltech.edu/34/3/FeynmanLosAlamos.htm">Los Alamos From Below: Reminiscences</a></li>
<li><a href="https://web.pa.msu.edu/people/yang/RFeynman_plentySpace.pdf">Plenty of Room at the Bottom</a></li>
<li><a href="https://calteches.library.caltech.edu/51/2/CargoCult.htm">Cargo Cult Science</a></li>
<li><a href="https://calteches.library.caltech.edu/3570/1/Feynman.pdf">Feynmanâ€™s Challenger Investigation Insights</a></li>
<li><a href="https://calteches.library.caltech.edu/1575/1/Science.pdf">The Value of Science</a></li>
<li><a href="https://www.fotuva.org/feynman/what_is_science.html">What is Science</a></li>
<li><a href="https://calteches.library.caltech.edu/49/2/Religion.htm">The Relation of Science and Religion</a></li>
</ul>
]]></content>
      <categories>
        <category>misc</category>
      </categories>
  </entry>
  <entry>
    <title>è¿™å¹´åˆäºŒ</title>
    <url>/misc/chuer/</url>
    <content><![CDATA[<table>
<tr>
<td width="50%">
<img src="/images/chuer/fireworks.gif">
</td>
<td width="50%">
<p>å°å°çš„äººå„¿<br><br />
æ”¥ä¸ä½æµæ·Œçš„æ˜¼ä¸å¤œ<br><br />
å½“ä½ èˆåŠ¨æ‰‹ä¸­çš„ä»™å¥³æ£’<br><br />
å´ä»¿ä½›åœ¨æŒ¥æ´’é“¶æ²³</p>
<p>æ‚ä½åŒè€³<br><br />
ä¸ä¸ºé‚£å‡›å‡›çš„å†°å¯’<br><br />
åªç­‰èŠ±å„¿åœ¨æ˜Ÿæ˜Ÿçœ¼å‰å¼€æ”¾<br><br />
ä»æ€€æŠ±é™è°§å’Œå®‰ç„¶</p>
<p>è¿™å¹´åˆäºŒ<br><br />
æˆ‘ä»¬ä»¨<br><br />
å‡¤ç¿”åŸé‡Œçœ‹å‡¤ç¿”<br><br />
å¾€åä½™ç”Ÿ<br><br />
ç¿”å‡¤æ¡¥å¤´ä¸å½·å¾¨</p>
</td>
</tr>
</table>
]]></content>
      <categories>
        <category>misc</category>
      </categories>
      <tags>
        <tag>Star</tag>
      </tags>
  </entry>
  <entry>
    <title>My english is poor</title>
    <url>/misc/english/</url>
    <content><![CDATA[<blockquote>
<p>A language that doesnâ€™t affect the way you think about programming, is not worth knowing.</p>
<p>â€“ <cite>Alan J. Perlis, Recipient of 1966 Turing Award</cite></p>
</blockquote>
<span id="more"></span>
<h1 id="irc"><a class="markdownIt-Anchor" href="#irc"></a> IRC</h1>
<h2 id="ircinternet-relay-chat"><a class="markdownIt-Anchor" href="#ircinternet-relay-chat"></a> <a href="https://zh.wikipedia.org/wiki/IRC">IRC(Internet Relay Chat)</a></h2>
<ul>
<li>ä¸€ç§åº”ç”¨å±‚åè®®ï¼Œç”¨äºèŠå¤©æ²Ÿé€š</li>
<li>ä¸€ç§å¼€æºç¤¾åŒºå¸¸ç”¨çš„é€šè®¯æ–¹å¼</li>
<li>æœåŠ¡ç«¯å£å·6667[æ˜æ–‡], 6697[åŠ å¯†]</li>
<li><a href="https://webchat.oftc.net/">webchat.oftc.net</a>æ˜¯å…¶ä¸­ä¸€ç§åŸºäºwebçš„å®¢æˆ·ç«¯</li>
</ul>
<!--more-->
<h2 id="é¢‘é“-channels"><a class="markdownIt-Anchor" href="#é¢‘é“-channels"></a> é¢‘é“ Channels</h2>
<ul>
<li><a href="https://webchat.oftc.net/">#dri-devel</a></li>
<li><a href="https://webchat.oftc.net/">#llvm</a></li>
<li><a href="https://webchat.oftc.net/">#panfrost</a></li>
</ul>
<p>å¦‚æœä½ æƒ³çŸ¥é“è°åœ¨è·Ÿä½ äº¤æµæˆ–ä½ çš„é—®é¢˜åº”è¯¥@è°ï¼Œè¯·æŸ¥çœ‹<a href="https://dri.freedesktop.org/wiki/WhosWho/">Whoâ€™s Who on IRC</a></p>
<h2 id="çŸ­å¥-acronymphrases"><a class="markdownIt-Anchor" href="#çŸ­å¥-acronymphrases"></a> çŸ­å¥ Acronym/Phrases</h2>
<p><a href="https://gist.github.com/lucmann/a731f787fae96264c09f0bcdbef7f0dd">abbr.csv</a></p>
<h1 id="ç²˜è´´æœåŠ¡-paste-service"><a class="markdownIt-Anchor" href="#ç²˜è´´æœåŠ¡-paste-service"></a> ç²˜è´´æœåŠ¡ Paste Service</h1>
<p>åœ¨ IRC ä¸Šäº¤æµæ—¶ï¼Œæœ‰æ—¶å¯èƒ½éœ€è¦ç²˜è´´ Logï¼ŒConfig ä¹‹ç±»çš„å¤§æ®µæ–‡æœ¬ï¼Œä½†è¿™äº›åˆä¸ä¾¿ç›´æ¥ç²˜åˆ° IRC ä¸Šï¼Œè¿™æ—¶ä»¥ä¸‹åŸºäº Web çš„ Paste æœåŠ¡å¯èƒ½å¸®å¾—ä¸Šä½ </p>
<ul>
<li><a href="http://ix.io">http://ix.io</a></li>
<li><a href="https://paste.rs">https://paste.rs</a></li>
<li><a href="https://bpaste.net">https://bpaste.net</a></li>
<li><a href="https://gist.github.com">https://gist.github.com</a></li>
</ul>
<h1 id="çŸ­è¯­æ±‡"><a class="markdownIt-Anchor" href="#çŸ­è¯­æ±‡"></a> çŸ­è¯­æ±‡</h1>
<h2 id="wiggle-roomè¿›è¡Œè§£é‡Šæˆ–è¡¨è¾¾æ„è§æ‰€ç•™çš„ä½™åœ°-å›æ—‹ç©ºé—´"><a class="markdownIt-Anchor" href="#wiggle-roomè¿›è¡Œè§£é‡Šæˆ–è¡¨è¾¾æ„è§æ‰€ç•™çš„ä½™åœ°-å›æ—‹ç©ºé—´"></a> Wiggle Roomï¼ˆè¿›è¡Œè§£é‡Šæˆ–è¡¨è¾¾æ„è§æ‰€ç•™çš„ï¼‰ä½™åœ°ã€å›æ—‹ç©ºé—´ã€‚</h2>
<p>thereâ€™s pretty much zero wiggle room in semantics åœ¨è¯­ä¹‰ä¸Šæ²¡æœ‰ä»€ä¹ˆå¯è®¨è®ºçš„ã€‚</p>
<h2 id="hand-rollhand-rolled"><a class="markdownIt-Anchor" href="#hand-rollhand-rolled"></a> Hand Roll/Hand-rolled</h2>
<p>&quot;Hand roll&quot;æˆ–&quot;hand-rolled&quot;æ˜¯ä¸€ä¸ªè‹±è¯­è¯æ±‡ï¼Œé€šå¸¸ç”¨äºæè¿°æ‰‹å·¥åˆ¶ä½œçš„ä¸œè¥¿ã€‚è¿™ä¸ªè¯æ±‡å¯ä»¥ç”¨æ¥å½¢å®¹æ‰‹å·¥åˆ¶ä½œçš„é£Ÿå“ï¼Œå¦‚æ‰‹å·å¯¿å¸ï¼ˆhand-rolled sushiï¼‰ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥å½¢å®¹æ‰‹å·¥åˆ¶ä½œçš„çƒŸå·ï¼ˆhand-rolled cigarettesï¼‰æˆ–æ‰‹å·¥åˆ¶ä½œçš„çº¸å·ï¼ˆhand-rolled paperï¼‰ã€‚åœ¨å…¶ä»–é¢†åŸŸï¼Œ&quot;hand roll&quot;æˆ–&quot;hand-rolled&quot;ä¹Ÿå¯ä»¥æŒ‡æ‰‹å·¥åˆ¶ä½œçš„å®¶å…·ã€çººç»‡å“ã€ç å®ã€éŸ³ä¹ä¹å™¨ç­‰ã€‚</p>
<p>I think weâ€™re way past the point where drivers hand-rolling entire gem from nothing is ready for upstream</p>
<h2 id="rubberstamp-ä¸å¸¦æ£€æŸ¥åœ°-å…è®¸æˆ–é€šè¿‡"><a class="markdownIt-Anchor" href="#rubberstamp-ä¸å¸¦æ£€æŸ¥åœ°-å…è®¸æˆ–é€šè¿‡"></a> rubberstamp (ä¸å¸¦æ£€æŸ¥åœ°) å…è®¸æˆ–é€šè¿‡</h2>
<p>æ— è®ºè¿™ä¸ªæ˜¯å¦æœ‰åŠ©äº v10 ç‰ˆæœ¬ç¡¬ä»¶çš„é€†å‘ï¼Œæˆ‘éƒ½æ„¿æ„ç»™ä½ é€šè¿‡(ä¸æ£€æŸ¥), ä½†æˆ‘è¿˜æ˜¯æƒ³æ˜ç™½æˆ‘ä»¬æ‰€é¢ä¸´çš„é—®é¢˜ã€‚</p>
<p>Willing to rubberstamp regardless of this is helping v10 r/e, but I would like to understand what weâ€™re up against here.</p>
<h2 id="scaffolding-ä¸´æ—¶ç»“æ„å’Œä»£ç "><a class="markdownIt-Anchor" href="#scaffolding-ä¸´æ—¶ç»“æ„å’Œä»£ç "></a> scaffolding ä¸´æ—¶ç»“æ„å’Œä»£ç </h2>
<p>scaffolding æ˜¯æŒ‡è„šæ‰‹æ¶ï¼Œé€šå¸¸ç”¨äºå»ºç­‘æ–½å·¥ä¸­æ”¯æ’‘äººå‘˜å’Œææ–™çš„ä¸´æ—¶ç»“æ„ã€‚åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œscaffolding å¯ä»¥æŒ‡ä»£è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­çš„ä¸€äº›ä¸´æ—¶ç»“æ„å’Œä»£ç ï¼Œç”¨äºè¾…åŠ©å¼€å‘äººå‘˜å¿«é€Ÿå®ŒæˆæŸä¸ªåŠŸèƒ½æˆ–å®ç°æŸä¸ªç›®æ ‡ã€‚è¿™äº›ä¸´æ—¶ç»“æ„å’Œä»£ç é€šå¸¸ä¼šè¢«ç§»é™¤æˆ–é‡æ„ï¼Œåªç•™ä¸‹æœ€ç»ˆçš„ä»£ç å’Œç»“æ„</p>
<p>have the minimal scaffolding to support the preempt-ctx fence in drm_sched_entity</p>
<h2 id="scratching-my-head-æŒ å¤´è¡¨ç¤ºé‡åˆ°éš¾é¢˜æˆ–å›°æ‰°"><a class="markdownIt-Anchor" href="#scratching-my-head-æŒ å¤´è¡¨ç¤ºé‡åˆ°éš¾é¢˜æˆ–å›°æ‰°"></a> Scratching my head æŒ å¤´ï¼Œè¡¨ç¤ºé‡åˆ°éš¾é¢˜æˆ–å›°æ‰°</h2>
<p>â€œScratching my headâ€ å¯ä»¥ç¿»è¯‘ä¸ºâ€œæŒ å¤´â€ï¼Œè¡¨ç¤ºå›°æƒ‘ã€ç–‘æƒ‘æˆ–æ€è€ƒæ—¶çš„åŠ¨ä½œã€‚è¿™ä¸ªè¡¨è¾¾æ–¹å¼é€šå¸¸ç”¨äºæè¿°é‡åˆ°éš¾é¢˜æˆ–å›°æ‰°æ—¶çš„æƒ…å†µã€‚</p>
<h2 id="footgunfoot-gun-è‡ªä¼¤è¡Œä¸º-æŒ‡åœ¨å°è¯•è§£å†³é—®é¢˜æ—¶ä¸å°å¿ƒé‡‡ç”¨äº†å¯¼è‡´é—®é¢˜æ¶åŒ–çš„è¡ŒåŠ¨-ç±»ä¼¼äºæ¬èµ·çŸ³å¤´ç ¸è‡ªå·±çš„è„š"><a class="markdownIt-Anchor" href="#footgunfoot-gun-è‡ªä¼¤è¡Œä¸º-æŒ‡åœ¨å°è¯•è§£å†³é—®é¢˜æ—¶ä¸å°å¿ƒé‡‡ç”¨äº†å¯¼è‡´é—®é¢˜æ¶åŒ–çš„è¡ŒåŠ¨-ç±»ä¼¼äºæ¬èµ·çŸ³å¤´ç ¸è‡ªå·±çš„è„š"></a> footgun/foot-gun è‡ªä¼¤è¡Œä¸ºã€‚æŒ‡åœ¨å°è¯•è§£å†³é—®é¢˜æ—¶ï¼Œä¸å°å¿ƒé‡‡ç”¨äº†å¯¼è‡´é—®é¢˜æ¶åŒ–çš„è¡ŒåŠ¨ã€‚ç±»ä¼¼äºâ€œæ¬èµ·çŸ³å¤´ç ¸è‡ªå·±çš„è„šâ€</h2>
<p>â€œIs the suggested callback a giant foot-gun in the already treacherous territory of scheduling and fencing?â€</p>
<h1 id="ç»å¸¸è¯»é”™çš„è¯æ±‡"><a class="markdownIt-Anchor" href="#ç»å¸¸è¯»é”™çš„è¯æ±‡"></a> ç»å¸¸è¯»é”™çš„è¯æ±‡</h1>
<table>
<thead>
<tr>
<th style="text-align:left">word</th>
<th style="text-align:left">translation</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">deque / dÉ›k /</td>
<td style="text-align:left">n. åŒç«¯é˜Ÿåˆ—</td>
</tr>
<tr>
<td style="text-align:left">infinite / 'ÉªnfÉªnÉ™t /</td>
<td style="text-align:left">adj. æ— é™çš„ï¼Œéé™å®šçš„; n. æ— ç©·å¤§ï¼Œä¸Šå¸</td>
</tr>
<tr>
<td style="text-align:left">finite / 'fÉ‘ÉªnÉ‘Éªt /</td>
<td style="text-align:left">adj. æœ‰é™çš„ï¼Œé™å®šçš„; n. æœ‰é™ä¹‹ç‰©</td>
</tr>
<tr>
<td style="text-align:left">opaque / oÊŠâ€™peÉªk /</td>
<td style="text-align:left">adj. ä¸é€æ˜çš„ï¼Œéš¾æ‡‚çš„; n. ä¸é€æ˜ä½“</td>
</tr>
<tr>
<td style="text-align:left">width  / wÉªdÎ¸; wÉªtÎ¸ /</td>
<td style="text-align:left">n. å®½åº¦</td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>misc</category>
      </categories>
      <tags>
        <tag>Hobbies</tag>
      </tags>
  </entry>
  <entry>
    <title>Post-Mortem</title>
    <url>/misc/go-game/</url>
    <content><![CDATA[<p>å‡2çº§åçš„ç¬¬ä¸€ç›˜æ£‹é»‘ç«Ÿç„¶ä¸‹å‡ºäº†è¿ç»­11æ‰‹çš„AIä¸€é€‰ï¼ˆä»é»‘97åˆ°é»‘121), å½“ç„¶è¿™ä¹Ÿä¸ç™½çš„åº”æ‹›æœ‰å…³ç³»ã€‚ä¸è¿‡ å¯æƒœæœ€ç»ˆé»‘123è¿˜æ˜¯é”™å¤±ç¿»ç›˜æœºä¼šã€‚å±€åå¤ç›˜ï¼Œçœ‹åˆ°è¿ç»­11æ‰‹çš„ä¸€é€‰æœ‰ç‚¹æ¿€åŠ¨ï¼Œæ•…æ­¤è®°å½•</p>
<span id="more"></span>
<p><img src="/images/game/game.gif" alt="å¥”è·‘çš„Lucæ‰§é»‘ vs å¹´å¹´æœ‰é±¼æ‰§ç™½(210æ‰‹é»‘ä¸­ç›˜è´Ÿ)" /></p>
]]></content>
      <categories>
        <category>misc</category>
      </categories>
      <tags>
        <tag>Hobbies</tag>
      </tags>
  </entry>
  <entry>
    <title>æˆ‘åœ¨é‚®ä»¶åˆ—è¡¨é‡Œå­¦è‹±è¯­</title>
    <url>/misc/maillist/</url>
    <content><![CDATA[<blockquote>
<p>Communication is hard, especially with all the different personalities, languages, and<br />
cultures involved in an international community like this.</p>
<p>â€“ <cite>Faith Ekstrand</cite></p>
</blockquote>
<blockquote>
<p>It is rules and not our individual smarts that keep us from making mistakes.</p>
<p>â€“ <cite>Faith Ekstrand</cite></p>
</blockquote>
<span id="more"></span>
<p>å·²ç»è®¢é˜… <a href="mailto:dri-devel@lists.freedesktop.org">dri-devel@lists.freedesktop.org</a> æœ‰ä¸€å¹´å¤šäº†ï¼Œçœ‹åˆ°è¿‡å‡ æ¬¡æ¿€çƒˆçš„å…³äº drm å­ç³»ç»Ÿé‡Œçš„åƒ drm_sched, dma_fence çš„è®¨è®ºã€‚æ…¢æ…¢åœ°æˆ‘å‘ç°åœ¨ç¿»è¯‘å·¥å…·çš„å¸®åŠ©ä¸‹ï¼Œé‚®ä»¶åˆ—è¡¨é‡Œè¿™ç§çº¯æ–‡æœ¬çš„è®¨è®º å¯ä»¥æˆä¸ºå¾ˆå¥½çš„å­¦ä¹ è‹±è¯­çš„åœ°æ–¹ã€‚è¿™é‡Œçš„è¡¨è¾¾æ„Ÿè§‰ä»‹äºæ­£å¼çš„ä¹¦é¢è¯­å’Œéšæ„çš„å£è¯­ä¹‹é—´ï¼Œæ›´é‡è¦çš„ï¼Œåœ¨è®¨è®ºå½“ä¸­æœ‰å¾ˆå¤šæŠ€æœ¯æ€§çš„ä¸“ä¸šè¯æ±‡åŠä¿šè¯­ã€‚è¿™äº›ä¸ä»…æœ‰åŠ©äºæé«˜è‹±è¯­é˜…è¯»æ°´å¹³ï¼Œè€Œä¸”æœ‰åŠ©äºç†Ÿæ‚‰æŠ€æœ¯è®¨è®ºä¸­å¸¸ç”¨çš„è¡¨è¿°ä¹ æƒ¯å’Œè¯­å¥ç»„ç»‡ã€‚<br />
(å½“ç„¶è¿™äº›é‚®ä»¶å°±åƒä¼šè®®è®°å½•ä¸€èˆ¬ï¼Œå¯ä»¥è®©æˆ‘å¯¹äºæ‰€è®¨è®ºçš„é—®é¢˜æœ¬èº«åå¤åœ°é˜…è¯»ç›´åˆ°å®Œå…¨ç†è§£)</p>
<h1 id="å¦‚ä½•è®¢é˜…-dri-devel"><a class="markdownIt-Anchor" href="#å¦‚ä½•è®¢é˜…-dri-devel"></a> å¦‚ä½•è®¢é˜… dri-devel</h1>
<p>Easy! åªéœ€è¦è‡ªå·±æœ‰ä¸€ä¸ª E-mail åœ°å€ï¼Œç„¶ååœ¨è¿™ä¸ª<a href="https://lists.freedesktop.org/mailman/listinfo/dri-devel#:~:text=Subscribe%20to%20dri-devel%20by%20filling%20out%20the%20following,confirmation%2C%20to%20prevent%20others%20from%20gratuitously%20subscribing%20you.">ç½‘ç«™</a>å¡«ä¸€ä¸ªç®€å•çš„è¡¨æ ¼å°±å¯ä»¥äº†ã€‚</p>
<h1 id="é‚®ä»¶åˆ—è¡¨è®¢é˜…è€…çš„-digested-members-å’Œ-non-digested-members-æœ‰ä½•ä¸åŒ"><a class="markdownIt-Anchor" href="#é‚®ä»¶åˆ—è¡¨è®¢é˜…è€…çš„-digested-members-å’Œ-non-digested-members-æœ‰ä½•ä¸åŒ"></a> é‚®ä»¶åˆ—è¡¨è®¢é˜…è€…çš„ Digested Members å’Œ Non-digested Members æœ‰ä½•ä¸åŒï¼Ÿ</h1>
<p><a href="https://td.wku.edu/TDClient/34/Portal/KB/ArticleDet?ID=1620">é“¾æ¥:https://td.wku.edu/TDClient/34/Portal/KB/ArticleDet?ID=1620</a></p>
<h1 id="ç¿»è¯‘1"><a class="markdownIt-Anchor" href="#ç¿»è¯‘1"></a> ç¿»è¯‘1</h1>
<p>(å…³äº Linux ç¤¾åŒºå·¥ä½œæ–¹å¼)</p>
<p>And, to be clear, for the purposes of this discussion, weâ€™re ALL<br />
idiots, myself included.  If thereâ€™s one thing the DRM community has<br />
learned over the years, itâ€™s that drivers are so complex that we all<br />
turn into idiots at some point, relative to the complexity of the code<br />
and hardware behavior.  Thatâ€™s why things like dma_fence are written so<br />
incredibly defensively and why weâ€™re so harsh about the rules.  Itâ€™s<br />
the rules and not our individual smarts that keep us from making<br />
mistakes.  (Kinda like Rust, in a way.)  So while I appreciate the<br />
frustration of â€œIâ€™m just trying to do something thatâ€™s clearly correct<br />
hereâ€, that doesnâ€™t mean that then next person to come by and fix a bug<br />
by tweaking that callback isnâ€™t going to screw it up irreparably.  That<br />
person may even be you in 6 to 12 months after this e-mail thread is a<br />
distant memory.</p>
<p>å¹¶ä¸”ï¼Œå°±è®¨è®ºçš„ç›®çš„è€Œè¨€ï¼Œæˆ‘ä»¬éƒ½æ˜¯ç¬¨è›‹ï¼ŒåŒ…æ‹¬æˆ‘è‡ªå·±åœ¨å†…ã€‚å¤šå¹´æ¥ï¼ŒDRMç¤¾åŒºæ‰€å­¦åˆ°çš„ä¸€ä»¶äº‹å°±æ˜¯ï¼Œé©±åŠ¨ç¨‹åºæ˜¯å¦‚æ­¤å¤æ‚ï¼Œä»¥è‡³äºåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç›¸å¯¹äºä»£ç å’Œç¡¬ä»¶è¡Œä¸ºçš„å¤æ‚æ€§ï¼Œæˆ‘ä»¬éƒ½ä¼šå˜å¾—æ„šç¬¨ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåƒdma_fenceè¿™æ ·çš„ä¸œè¥¿è¢«ç¼–å†™å¾—å¦‚æ­¤è°¨æ…ï¼Œä»¥åŠä¸ºä»€ä¹ˆæˆ‘ä»¬å¯¹è§„åˆ™è¦æ±‚å¦‚æ­¤ä¸¥æ ¼çš„åŸå› ã€‚æ­£æ˜¯è§„åˆ™è€Œä¸æ˜¯æˆ‘ä»¬ä¸ªäººçš„èªæ˜æ‰æ™ºé˜²æ­¢äº†æˆ‘ä»¬çŠ¯é”™ã€‚ï¼ˆæŸç§ç¨‹åº¦ä¸Šç±»ä¼¼äºRustï¼‰æ‰€ä»¥è™½ç„¶æˆ‘ç†è§£â€œæˆ‘åªæ˜¯æƒ³åœ¨è¿™é‡Œåšä¸€äº›æ˜¾ç„¶æ­£ç¡®çš„äº‹æƒ…â€çš„æ²®ä¸§ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€æ¥ä¸‹æ¥çš„äººåœ¨è°ƒæ•´å›è°ƒå‡½æ•°ä»¥ä¿®å¤é”™è¯¯æ—¶ä¸ä¼šçŠ¯ä¸‹ä¸å¯æŒ½å›çš„é”™è¯¯ã€‚è¿™ä¸ªäººç”šè‡³å¯èƒ½å°±æ˜¯ä½ ï¼Œåœ¨è¿™ä¸ªé‚®ä»¶çº¿ç¨‹æˆä¸ºé¥è¿œè®°å¿†çš„6åˆ°12ä¸ªæœˆåã€‚ğŸ’ğŸ¤”</p>
<p><a href="https://patchwork.freedesktop.org/patch/525461/">è‹±æ–‡åŸæ–‡</a><br />
<a href="https://www.youtube.com/watch?v=3OqllZONTiQ&amp;t=9937s">ç›¸å…³è§†é¢‘</a></p>
<h1 id="ç¿»è¯‘2"><a class="markdownIt-Anchor" href="#ç¿»è¯‘2"></a> ç¿»è¯‘2</h1>
<p>(å…³äº DRM device reset æ–‡æ¡£å»ºè®¾)</p>
<p><a href="https://patchwork.freedesktop.org/patch/519860/">è‹±æ–‡åŸæ–‡</a><br />
<a href="https://patchwork.freedesktop.org/patch/544431/">è‹±æ–‡åŸæ–‡</a></p>
]]></content>
      <categories>
        <category>misc</category>
      </categories>
      <tags>
        <tag>Hobbies</tag>
      </tags>
  </entry>
  <entry>
    <title>ç”µå½±é‡Œçš„ç»å…¸å°è¯</title>
    <url>/misc/moive/</url>
    <content><![CDATA[<h1 id="scent-of-a-woman-1992"><a class="markdownIt-Anchor" href="#scent-of-a-woman-1992"></a> Scent of a woman (1992)</h1>
<p>No mistakes in the Tango, not like life. Itâ€™s simple, thatâ€™s what makes the Tango so great. If you make a mistake, get all tangled up, just Tango on.</p>
<h1 id="rudy-1993"><a class="markdownIt-Anchor" href="#rudy-1993"></a> Rudy (1993)</h1>
<p>Having dreams is what makes life tolerable</p>
<h1 id="the-shawshank-redemption-1994"><a class="markdownIt-Anchor" href="#the-shawshank-redemption-1994"></a> The Shawshank Redemption (1994)</h1>
<p>Get busy living or get busy dying</p>
]]></content>
      <categories>
        <category>misc</category>
      </categories>
      <tags>
        <tag>Hobbies</tag>
      </tags>
  </entry>
  <entry>
    <title>è¯æ±‡: nightly</title>
    <url>/misc/nightly/</url>
    <content><![CDATA[<p>æœ€è¿‘åœ¨ä¸¤ä¸ªåœ°æ–¹çœ‹åˆ°<strong>nightly</strong>è¿™ä¸ªè¯ï¼š</p>
<p><a href="https://cgit.freedesktop.org/drm-tip/">drm-tip</a>æˆ–<a href="https://cgit.freedesktop.org/drm/drm-tip/">drm/drm-tip</a> (æˆ‘ä¹Ÿä¸çŸ¥é“è¿™ä¸¤ä¸ªä»“åº“æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œé™¤äº†å®ƒä»¬çš„Ownerä¸åŒ)</p>
<p>DRM current development and <strong>nightly</strong> trees</p>
<span id="more"></span>
<p>å¦å¤–ä¸€ä¸ªåœ°æ–¹æ˜¯Rustçš„ç‰ˆæœ¬å‘å¸ƒç­–ç•¥ï¼Œå®ƒé‡‡ç”¨<a href="https://doc.rust-lang.org/book/appendix-07-nightly-rust.html">train schedule</a>. Rustæ€»å…±æœ‰3ä¸ªReleaseé€šé“:</p>
<ul>
<li>Nightly</li>
<li>Beta</li>
<li>Stable</li>
</ul>
<p>ä»ä¸Šåˆ°ä¸‹ï¼Œå„ä¸ªReleaseç‰ˆæœ¬çš„æ›´æ–°ç¨‹åº¦(åŒ…å«æ–°ç‰¹æ€§çš„å¤šå°‘)ä¾æ¬¡å‡å°‘ï¼Œç¨³å®šç¨‹åºä¾æ¬¡å¢åŠ ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºå¤§å¤šæ•°æ™®é€šçš„å¼€å‘è€…ï¼Œä¼šé€‰æ‹©å®‰è£…Stable, è€Œå¯¹äºé‚£äº›æƒ³å°è¯•Rustè¯­è¨€æœ€æ–°çš„ç‰¹æ€§çš„å¼€å‘è€…ï¼Œåˆ™ä¼šé€‰æ‹©å®‰è£…Nightlyæˆ–Betaç‰ˆæœ¬ã€‚</p>
<p>ä½ å¯ä»¥ä½¿ç”¨rust toolchainç®¡ç†å·¥å…·<code>rustup</code>æ¥å®‰è£…å’Œåˆ‡æ¢ä¸åŒçš„Releaseç‰ˆæœ¬ï¼Œä¾‹å¦‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rustup default nightly</span><br></pre></td></tr></table></figure>
<p>å°†å®‰è£…æœ€æ–°çš„Rust nightlyç‰ˆæœ¬(è¿™ç¯‡åšå®¢å†™äºFri Nov 19 15:28:25 CST 2021)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nightly-x86_64-unknown-linux-gnu installed - rustc 1.58.0-nightly (cc946fcd3 2021-11-18)</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ä¸¤ä¸ªNightlyçš„ç”¨æ³•çœ‹ï¼Œå®ƒåŸºæœ¬ä¸Šä»£è¡¨æœ€æ–°çš„ï¼Œæœ€è¿‘çš„ï¼Œè®©æˆ‘æƒ³åˆ°ä»¥å‰é¡¹ç›®çš„â€œæ¯æ—¥æ„å»ºç‰ˆæœ¬â€ã€‚</p>
]]></content>
      <categories>
        <category>misc</category>
      </categories>
  </entry>
  <entry>
    <title>å­¦å¼ˆ</title>
    <url>/misc/thinking-in-go/</url>
    <content><![CDATA[<h1 id="æ£‹ç†"><a class="markdownIt-Anchor" href="#æ£‹ç†"></a> æ£‹ç†</h1>
<p>æœ€è¿‘å’Œæœ‹å‹çš„å­©å­ä¸‹äº†å‡ ç›˜æ£‹ï¼Œåœ¨æƒŠå¹ç°åœ¨å­©å­çš„èªæ…§å’Œå­¦ä¹ èƒ½åŠ›ä¹‹ä½™ï¼Œä¹Ÿæ·±æ„Ÿè‡ªå·±çš„â€œæ£‹è‰ºâ€ç€å®æœ‰å¾…æé«˜ã€‚ä¾¿åˆæ‹£èµ·è’åºŸå·²ä¹…çš„å¼ˆåŸè´¦å·ï¼Œæƒ³ä¸‹å‡ ç›˜æ‰¾æ‰¾æ„Ÿè§‰ï¼Œç»“æœåˆä¸€æ¬¡åº”äº†é‚£å¥ï¼Œâ€œä¸šç²¾äºå‹¤ï¼Œè’äºå¬‰â€ã€‚å¤±è½ä¹‹ä½™ï¼Œç´¢æ€§å» B ç«™ï¼Œé‡çœ‹é‚±ç™¾ç‘è€å¸ˆçš„<a href="https://www.bilibili.com/video/BV1tt4y1G7KR/?p=2&amp;spm_id_from=pageDriver&amp;vd_source=b3ba1ad08e1b41cd7118d8dd88f0e670">å¸¦ä½ é›¶åŸºç¡€å­¦å›´æ£‹</a>.<br />
å†çœ‹ç¡®å®æœ‰ä¸ä¸€æ ·çš„æ„Ÿå—ã€‚å›´æ£‹çš„å¥¥å¦™å’Œé‚£äº›åƒå¤æµä¼ çš„æ£‹ç†è‡ªä¸å¿…å¤šè¯´ï¼Œæˆ‘æƒ³è‡ªå·±å­¦ä¹ ä¸‹æ£‹ï¼Œè¯•ç€äº†è§£æ£‹ç†çš„åŸå› ï¼Œä¹Ÿæ˜¯è¢«å›´æ£‹è¿™ç§â€œæ–¹å¯¸ä¹‹é—´æœ‰å¤©åœ°ï¼Œé»‘ç™½ä¹‹å¤„æ˜¾ä¹¾å¤â€çš„é­…åŠ›æ‰€æŠ˜æœã€‚</p>
<span id="more"></span>
<h1 id="å¾å­ä¸å¼•å¾"><a class="markdownIt-Anchor" href="#å¾å­ä¸å¼•å¾"></a> å¾å­ä¸å¼•å¾</h1>
<p>å¾å­ä¹Ÿå«â€œæ‰­ç¾Šå¤´â€ï¼Œæ˜¯åƒå­çš„ä¸€ç§æŠ€å·§ã€‚é‚±è€å¸ˆè¯´ï¼Œå¾å­æ—¢å‰å®³åˆå±é™©ã€‚ä¸€æ—¦å¾å­å¤±è´¥ï¼Œâ€œåŸæ¥è¿½åˆ«äººçš„æ£‹ç°åœ¨å…¨å˜æˆè‡ªå·±çš„æ–­ç‚¹ï¼Œåˆšæ‰è¿½å¾—å¾ˆé«˜å…´ï¼Œç°åœ¨å¤§æ¦‚ä¹Ÿæ­»å¾—å¾ˆæƒ¨â€ã€‚</p>
<p><img src="/images/thinking-in-go/ladder.png" alt="å¾å­" /></p>
<p>å…µå®¶æœ‰äº‘ï¼Œâ€œç©·å¯‡è«è¿½â€ã€‚è™½ç„¶æœ‰å¯èƒ½å°†å¯¹æ–¹èµ¶å°½æ€ç»ï¼Œä½†ä¹Ÿå¯èƒ½åœ¨è¿½çš„æ—¶å€™å°†è‡ªå·±ç½®äºå±é™©ä¹‹ä¸­ã€‚ç«äº‰ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå¦‚æœä¸€å‘³åœ°æƒ³è¶…è¶Šå¯¹æ‰‹ï¼Œå¾ˆå¯èƒ½æœ€åæŠŠè‡ªå·±æå¾—æƒ¨ä¸å¿ç¹ã€‚</p>
<h1 id="æ‰‘"><a class="markdownIt-Anchor" href="#æ‰‘"></a> æ‰‘</h1>
<p>å›´æ£‹é‡Œâ€œå‹‡æ•¢â€çš„è¡Œä¸ºï¼Œæ‰‘ (uchikaki, throw-in), å«æœ‰ç½®ä¹‹æ­»åœ°è€Œåç”Ÿä¹‹æ„ã€‚</p>
<p><img src="/images/thinking-in-go/uchikaki.png" alt="æ‰‘" /></p>
<h1 id="åŸºæœ¬æ£‹å½¢çš„æ­»æ´»"><a class="markdownIt-Anchor" href="#åŸºæœ¬æ£‹å½¢çš„æ­»æ´»"></a> åŸºæœ¬æ£‹å½¢çš„æ­»æ´»</h1>
<table>
<thead>
<tr>
<th style="text-align:left">æ£‹å½¢</th>
<th style="text-align:left">æ­»æ´»ç±»å‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ç›´ä¸‰</td>
<td style="text-align:left">åæ‰‹æ´»</td>
</tr>
<tr>
<td style="text-align:left">ç›´å››</td>
<td style="text-align:left">æ´»</td>
</tr>
<tr>
<td style="text-align:left">æ›²å››</td>
<td style="text-align:left">æ´»</td>
</tr>
<tr>
<td style="text-align:left">ä¸å››</td>
<td style="text-align:left">åæ‰‹æ´»</td>
</tr>
<tr>
<td style="text-align:left">æ–¹å››</td>
<td style="text-align:left">æ­»</td>
</tr>
<tr>
<td style="text-align:left">ç›´äº”</td>
<td style="text-align:left">æ´»</td>
</tr>
<tr>
<td style="text-align:left">æ›²äº”</td>
<td style="text-align:left">æ´»</td>
</tr>
<tr>
<td style="text-align:left">èšäº”</td>
<td style="text-align:left">åæ‰‹æ´»</td>
</tr>
<tr>
<td style="text-align:left">åˆ€æŠŠäº”</td>
<td style="text-align:left">åæ‰‹æ´»</td>
</tr>
<tr>
<td style="text-align:left">æ¿å…­</td>
<td style="text-align:left">æ´»</td>
</tr>
<tr>
<td style="text-align:left">æ¢…èŠ±å…­</td>
<td style="text-align:left">åæ‰‹æ´»</td>
</tr>
<tr>
<td style="text-align:left">èšä¸ƒ</td>
<td style="text-align:left">æ´»</td>
</tr>
</tbody>
</table>
<h1 id="å›´åœ°çš„å¸¸è¯†"><a class="markdownIt-Anchor" href="#å›´åœ°çš„å¸¸è¯†"></a> å›´åœ°çš„å¸¸è¯†</h1>
<p>å›´æ£‹çš„äº‰å¤ºä¸»è¦æœ‰ä¸¤å¤§éƒ¨åˆ†</p>
<ul>
<li>å›´æ€å¯¹æ–¹çš„å­</li>
<li>é«˜æ•ˆåœ°å›´åœ°</li>
</ul>
<p>é«˜æ•ˆåœ°å›´åœ°æ‰æ˜¯å†³å®šèƒœè´Ÿçš„å…³é”®ï¼Œè€Œå›´æ€å¯¹æ–¹çš„å­åªä¸è¿‡æ˜¯å…¶ä¸­ä¸€ç§æ‰‹æ®µç½¢äº†ã€‚</p>
<p><img src="/images/thinking-in-go/efficiency.png" alt="å›´åœ°çš„æ•ˆç‡" /></p>
<h1 id="ä¸­å›½è§„åˆ™çš„æ•°å­ä¸æ—¥æœ¬è§„åˆ™çš„æ•°ç›®"><a class="markdownIt-Anchor" href="#ä¸­å›½è§„åˆ™çš„æ•°å­ä¸æ—¥æœ¬è§„åˆ™çš„æ•°ç›®"></a> ä¸­å›½è§„åˆ™çš„æ•°å­ä¸æ—¥æœ¬è§„åˆ™çš„æ•°ç›®</h1>
<p>å›´æ£‹çš„ä¸­å›½è§„åˆ™æ˜¯ä»¥æ•°å­è®¡ç®—ï¼Œä»»æ„é€‰æ‹©ä¸€æ–¹æ¥æ•°æ£‹ç›˜ä¸Šçš„æ´»å­æ•°ä»¥åŠæ´»å­å›´æˆçš„ç©ºï¼ˆäº¤å‰ç‚¹ï¼‰ï¼Œä¸ºäº†è®¡ç®—æ–¹ä¾¿ï¼Œä¸€èˆ¬ä¼šç”¨å·±æ–¹çš„æ£‹å­å…ˆæŠŠå›´æˆçš„ç©ºå¡«æ»¡ã€‚</p>
<p>è€Œæ—¥æœ¬è§„åˆ™æ˜¯ç‚¹ç›®ï¼Œæ‰€è°“â€œç›®â€ï¼Œå³å›´æˆçš„ç©ºã€‚æ—¥æœ¬è§„åˆ™ä¹‹æ‰€ä»¥ä¸å»å…³å¿ƒæ£‹ç›˜ä¸Šçš„æ´»å­çš„æ•°é‡ï¼Œè€Œåªè®¡ç®—å›´æˆçš„ç©ºï¼Œæ˜¯å› ä¸ºå›´æ£‹ä¸€äººä¸€æ‰‹çš„è§„åˆ™å†³å®šäº†åŒæ–¹ç®—ä¸Šè¢«åƒçš„æ­»å­ï¼Œåœ¨æ£‹ç›˜ä¸Šæ”¾è¿‡çš„å­æ•°ä¸€å®šæ˜¯ç›¸ç­‰çš„ã€‚æ‰€ä»¥æ—¥æœ¬è§„åˆ™åœ¨ç‚¹ç›®å‰ï¼Œè¦å°†åƒæ‰çš„å¯¹æ–¹çš„æ­»å­å¡«å…¥å¯¹æ–¹å›´æˆçš„ç©ºä¸­ä¹‹åï¼Œå†æ¸…ç‚¹ç›®æ•°ã€‚ä¸€ç›®ä¹Ÿå³ä¸€ä¸ªäº¤å‰ç‚¹ã€‚è¿™ä¹Ÿæ˜¯å¸¸è¯´çš„â€œåƒä¸€å­çš„ä»·å€¼æ˜¯ä¸¤ç›®æ£‹â€çš„é“ç†ã€‚</p>
]]></content>
      <categories>
        <category>misc</category>
      </categories>
      <tags>
        <tag>Hobbies</tag>
      </tags>
  </entry>
  <entry>
    <title>å¼ˆåŸå›´æ£‹</title>
    <url>/misc/weiqi/</url>
    <content><![CDATA[<h1 id="ç®€ä»‹"><a class="markdownIt-Anchor" href="#ç®€ä»‹"></a> ç®€ä»‹</h1>
<p>å¼ˆåŸå›´æ£‹æ˜¯<a href="http://www.eweiqi.com/">å¼ˆåŸå›´æ£‹ç½‘</a>æ¨å‡ºçš„ä¸€æ¬¾å›´æ£‹å­¦ä¹ å’Œç½‘ç»œå¯¹æˆ˜çš„ App. å®ƒå¯å®‰è£…åœ¨åŒ…æ‹¬ Windows, Android, iOS, iPad, MacOS åœ¨å†…çš„å„ä¸ªå¹³å°ã€‚</p>
<span id="more"></span>
<p><img src="/images/weiqi/20220904092030.jpg" alt="å¼ˆåŸå›´æ£‹ App" /></p>
<h1 id="ä¸‹è½½å’Œå®‰è£…"><a class="markdownIt-Anchor" href="#ä¸‹è½½å’Œå®‰è£…"></a> ä¸‹è½½å’Œå®‰è£…</h1>
<p>ä»¥ Android æ‰‹æœºå¹³å°ä¸ºä¾‹ï¼Œå¸¸ç”¨çš„è…¾è®¯ â€œåº”ç”¨å®â€ æˆ–æ‰‹æœºè‡ªå¸¦çš„ â€œåº”ç”¨ä¸­å¿ƒâ€ é‡Œä¸€èˆ¬æœä¸åˆ°è¿™æ¬¾ App, æˆ‘ä»¬å¯ä»¥ç›´æ¥ä»æ‰‹æœºç™¾åº¦ä¸­æœç´¢ â€œå¼ˆåŸå›´æ£‹â€ å…³é”®å­—ï¼Œç»“æœä¸­çš„ç¬¬äºŒä¸ªå°±æ˜¯ï¼Œç„¶åä»æ‰‹æœºæµè§ˆå™¨é‡Œä¸‹è½½å®‰è£…å³å¯ã€‚</p>
<p><img src="/images/weiqi/202209040920307.jpg" alt="å¼ˆåŸå›´æ£‹ä¸‹è½½" /></p>
<h1 id="ä¸»è¦åŠŸèƒ½"><a class="markdownIt-Anchor" href="#ä¸»è¦åŠŸèƒ½"></a> ä¸»è¦åŠŸèƒ½</h1>
<p>â€œå¼ˆåŸå›´æ£‹â€æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ç½‘ç»œå›´æ£‹å¹³å°ï¼Œæ¶µç›–äº†ä¸­å›½ï¼ŒéŸ©å›½å’Œæ—¥æœ¬çš„èŒä¸šæ£‹æ‰‹å’Œä¸šä½™æ£‹æ‰‹ï¼Œä»¥åŠé€šè¿‡ç½‘ç»œå­¦æ£‹çš„è®¸å¤šå›´æ£‹çˆ±å¥½è€…ã€‚æ‰€ä»¥è¿™æ¬¾ App è®¾ç½®äº†è®¸å¤šä¸åŒçš„æˆ¿é—´ï¼Œä»¥ä¾¿æ±‡é›†ä¸åŒæ°´å¹³çš„æ£‹æ‰‹ã€‚ç”¨æˆ·å¯ä»¥ä»»æ„é€‰æ‹©è¿›å…¥æˆ¿é—´ï¼Œä¹Ÿå¯ä»¥éšæ„åˆ‡æ¢æˆ¿é—´ã€‚</p>
<p><img src="/images/weiqi/202209040920302.jpg" alt="å¼ˆåŸå›´æ£‹æˆ¿é—´è®¾ç½®" /></p>
<p>â€œå¼ˆåŸå›´æ£‹â€ App åˆ†åˆ«è®¾ç½®äº† 9 è·¯å’Œ 19 è·¯å¯¹å±€ä»¥åŠ AI 9 è·¯ï¼Œ AI 19 è·¯ï¼Œå¯¹äºåˆå­¦è€…ï¼Œå¯ä»¥ä» 9 è·¯å¯¹å±€å¼€å§‹ç»ƒä¹ ã€‚</p>
<p><img src="/images/weiqi/202209040920303.jpg" alt="å¼ˆåŸå›´æ£‹æ£‹è·¯è®¾ç½®" /></p>
<p>â€œå¼ˆåŸå›´æ£‹â€ å…·æœ‰æ‰“è°±å’Œå¤ç›˜çš„åŠŸèƒ½ï¼Œä¸ä»…ä¿å­˜æœ‰æµ·é‡èŒä¸šæ£‹è°±ï¼Œè€Œä¸”ä¿ç•™äº†è‡ªå·±ä»¥å¾€å¯¹å±€çš„æ¯ä¸€å¼ æ£‹è°±ï¼Œè¿˜æ”¯æŒæœç´¢åŠŸèƒ½ï¼Œæ–¹ä¾¿ä½ éšæ—¶å¤ç›˜ä»»æ„æ£‹å±€ã€‚</p>
<p><img src="/images/weiqi/202209040920304.jpg" alt="å¼ˆåŸå›´æ£‹æ£‹è°±è®¾ç½®" /><br />
<img src="/images/weiqi/202209040920306.jpg" alt="å¼ˆåŸå›´æ£‹å¤ç›˜è®¾ç½®" /></p>
]]></content>
      <categories>
        <category>misc</category>
      </categories>
      <tags>
        <tag>Hobbies</tag>
      </tags>
  </entry>
  <entry>
    <title>è§‚â€œè€çŸ³è°ˆèŠ¯â€è§†é¢‘ç¬”è®° (äºŒ)</title>
    <url>/misc/xiangshan/</url>
    <content><![CDATA[<h1 id="glossary"><a class="markdownIt-Anchor" href="#glossary"></a> Glossary</h1>
<ul>
<li>PoC: Proof of Concept, æ¦‚å¿µéªŒè¯</li>
<li>Chisel: tExtended on Scala</li>
<li>GDSII: ç‰ˆå›¾</li>
<li>RTL: Register-Transfer Level, RTL è¯­è¨€åŒ…æ‹¬ SystemVerilog, Verilog, VHDLç­‰</li>
<li>FIRRTL: Chisel çš„â€œç¿»è¯‘å™¨â€, Chisel -&gt; Verilog</li>
<li>shift left: æŠŠéªŒè¯å’Œè°ƒè¯•æ”¾åœ¨ tape in é˜¶æ®µ</li>
<li>GEM5: C Simulator for GPU</li>
<li>PPA: Power, Performance, Area, used in deciding how to optimize semiconductor designs</li>
</ul>
<span id="more"></span>
<h1 id="miscellaneous"><a class="markdownIt-Anchor" href="#miscellaneous"></a> Miscellaneous</h1>
<ul>
<li>ä¸­å›½ç§‘å­¦é™¢è®¡ç®—æ‰€</li>
<li>ä¸­å›½å¼€æ”¾æŒ‡ä»¤ç”Ÿæ€(RISC-V)è”ç›Ÿ</li>
<li>ä¸­å›½ç§‘å­¦é™¢å¤§å­¦ â€œä¸€ç”Ÿä¸€èŠ¯â€</li>
<li>RIOS: PicoRio</li>
</ul>
<h1 id="infrastructure"><a class="markdownIt-Anchor" href="#infrastructure"></a> Infrastructure</h1>
<ul>
<li>æµç¨‹ï¼šå·¥å…·åŒ–ï¼Œè‡ªåŠ¨åŒ–ï¼Œå¹³å°åŒ–</li>
<li>å¼€æºï¼šä»£ç å¼€æºï¼Œæµç¨‹å¼€æ”¾ï¼Œæ–‡æ¡£å¼€æ”¾</li>
<li>æŒ‡å¯¼ï¼šåŸºç¡€ä¸å®è·µå¹¶é‡ï¼ŒæŸç§ç¨‹åº¦ä¸Šï¼Œå®è·µå¯èƒ½æ¯”åŸºç¡€çŸ¥è¯†æ›´é‡è¦</li>
</ul>
<h1 id="my-opinions"><a class="markdownIt-Anchor" href="#my-opinions"></a> My Opinions</h1>
<blockquote>
<p>å†å²æ€»æ˜¯æƒŠäººçš„ç›¸ä¼¼ã€‚</p>
</blockquote>
<h1 id="related-talks"><a class="markdownIt-Anchor" href="#related-talks"></a> Related Talks</h1>
<p>[1]<a href="https://www.bilibili.com/video/BV1oV41127Hy/?spm_id_from=333.788.recommend_more_video.13&amp;vd_source=b3ba1ad08e1b41cd7118d8dd88f0e670">RISC-Våœ¨ä¸­å›½çš„å‘å±•çŠ¶å†µ</a><br />
[2]<a href="https://www.bilibili.com/video/BV1Mf4y1b7hm?spm_id_from=333.337.search-card.all.click&amp;vd_source=b3ba1ad08e1b41cd7118d8dd88f0e670">æ­ç§˜â€œé¦™å±±â€ï¼šé«˜æ€§èƒ½å¼€æºRISC-Vå¤„ç†å™¨</a><br />
[3]<a href="https://www.youtube.com/watch?v=lXdx0X2WHfY">RISC-V is the future of computing</a></p>
]]></content>
      <categories>
        <category>misc</category>
      </categories>
      <tags>
        <tag>RISC-V</tag>
      </tags>
  </entry>
  <entry>
    <title>å…³äºC++åº”è¯¥çŸ¥é“çš„é‚£äº›äº‹</title>
    <url>/prog/cpp-faqs/</url>
    <content><![CDATA[<h1 id="ç¼©ç•¥è¯­-abbreviation"><a class="markdownIt-Anchor" href="#ç¼©ç•¥è¯­-abbreviation"></a> ç¼©ç•¥è¯­ (Abbreviation)</h1>
<ul>
<li>RAII</li>
</ul>
<p>Resource Acquisition Is Initialization</p>
<p><a href="https://zhuanlan.zhihu.com/p/34660259">çŸ¥ä¹-RAIIåŸç†</a></p>
<span id="more"></span>
<ul>
<li>RTTI</li>
</ul>
<p>Runtime Type Identification</p>
<p><a href="https://blog.csdn.net/ljianhui/article/details/46487951">CSDN-RTTIåŸç†</a></p>
<ul>
<li>SFINAE</li>
</ul>
<p>Substitution Failure Is Not An Error</p>
<p>æ„æ€æ˜¯åœ¨å‡½æ•°æ¨¡æ¿æˆ–ç±»æ¨¡æ¿ï¼ˆåŒ…æ‹¬ç±»æ¨¡æ¿ç‰¹åŒ–ï¼‰ç±»å‹æ¨å¯¼æ—¶ï¼Œç”±äºç±»å‹æˆ–å€¼æ›¿æ¢å¯¼è‡´çš„Ill-formed code(Subsititution Failure)ä¸è¢«ä½œä¸ºä¸€ä¸ªç¼–è¯‘æ—¶é”™è¯¯ã€‚</p>
<h1 id=""><a class="markdownIt-Anchor" href="#"></a> </h1>
<ul>
<li>Donâ€™t declare objects <code>const</code> if you want to move from them.</li>
<li>Using <code>std::move</code> doesnâ€™t guarantee anything will be moved.</li>
</ul>
<h1 id="frequently-asked-questions"><a class="markdownIt-Anchor" href="#frequently-asked-questions"></a> Frequently Asked Questions</h1>
<ul>
<li>
<p>åœ¨ C++11 ä¹‹å‰ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šä¸ºä¸€ä¸ªç±»åˆ›å»ºçš„å‡½æ•°æœ‰å“ªäº›?</p>
</li>
<li>
<p>å¦‚æœè¦é˜»æ­¢ä¸€ä¸ªç±»çš„å¯¹è±¡è¢«å¤åˆ¶(copyable), æœ‰å“ªäº›åšæ³•?</p>
<ol>
<li>å°† copy æ„é€ å‡½æ•°å’Œ copy assignment æ“ä½œç¬¦å£°æ˜ä¸º private, å¹¶ä¸äºˆå®ç°ã€‚</li>
<li>å®ç°ä¸€ä¸ª base class, è¿™ä¸ª base class çš„ copy æ„é€ å‡½æ•°å’Œ copy assignment æ“ä½œç¬¦éƒ½ä¸º privateã€‚</li>
</ol>
</li>
<li>
<p>C++ Template parameters æœ‰å“ªå‡ ç§?</p>
<ol>
<li>
<p>non-type template parameter</p>
<ul>
<li>lvalue reference type</li>
<li>integral type</li>
<li>pointer type</li>
<li>pointer member type</li>
<li>enumeration type</li>
<li>std::nullptr_t (è‡ªä»C++11)</li>
<li>floating type (è‡ªä»C++20)</li>
</ul>
</li>
<li>
<p>type template parameter</p>
</li>
<li>
<p>template template parameter</p>
</li>
</ol>
</li>
<li>
<p>C++ Template å®šä¹‰ä¸ºä»€ä¹ˆé€šå¸¸éƒ½åœ¨å¤´æ–‡ä»¶ä¸­?</p>
<p>å› ä¸º Template å®šä¹‰å¿…é¡»åœ¨æ¨¡æ¿éšå¼å®ä¾‹åŒ–(<a href="https://lucmann.github.io/p/cpp-template/">implicit instantiation</a>)ä¹‹å‰ï¼Œé€šå¸¸æˆ‘ä»¬åœ¨<code>.cpp</code> æºæ–‡ä»¶é‡Œç›´æ¥ä½¿ç”¨æ¨¡æ¿éƒ½å±äºéšå¼å®ä¾‹åŒ–ã€‚æ‰€ä»¥å°†æ¨¡æ¿å®šä¹‰åœ¨å¤´æ–‡ä»¶ä¸­ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢æ¨¡æ¿å®ä¾‹åŒ–ä¹‹å‰æ²¡æœ‰å®šä¹‰ã€‚</p>
</li>
<li>
<p><code>std::endl</code> å’Œ <code>\n</code> æœ‰ä½•åŒºåˆ«ï¼Ÿ</p>
<p>å¯¹ <code>std::endl</code> çš„æ¯æ¬¡è°ƒç”¨éƒ½ä¼š flush output buffer</p>
</li>
<li>
<p>Qt</p>
<ul>
<li>ä¿¡å·ä¸æ§½</li>
<li>å¯¹è±¡ç®¡ç†</li>
</ul>
</li>
<li>
<p>pure virtual vs. virtual function</p>
</li>
<li>
<p>g++ æŒ‡å®š -std=c++11</p>
</li>
<li>
<p>å¹¶è¡Œç¼–ç¨‹æ¨¡å‹/æ¡†æ¶ï¼Œå¤šçº¿ç¨‹</p>
<ul>
<li>std::atomic</li>
<li>std::thread</li>
</ul>
</li>
</ul>
<h1 id="linux-c"><a class="markdownIt-Anchor" href="#linux-c"></a> Linux &amp; C</h1>
<ul>
<li>vim æœ‰å“ªå‡ ç§å·¥ä½œæ¨¡å¼</li>
</ul>
<p>Normal mode:</p>
<p>a<br />
10yy<br />
dgg<br />
dG<br />
10j</p>
<p>Command-line mode:</p>
<p>10,.y<br />
g/^$/d<br />
s/hello//<br />
s/hello//g<br />
s/Hello,/&amp; World/</p>
<ul>
<li>gdb common commands</li>
</ul>
<p>backtrace (bt)<br />
command (comm)<br />
continue Â©<br />
finish (fin)<br />
frame (frame)</p>
<ul>
<li>
<p>epoll vs. poll vs. select</p>
</li>
<li>
<p>C ä¸­çš„ <code>static</code> å…³é”®å­—å¸¸è§ç”¨æ³•</p>
</li>
</ul>
<h1 id="gpuimage-å¦‚æœä½¿ç”¨-opengl-es-20ä¸ºä»€ä¹ˆä¸èƒ½åœ¨-iphone-iphone-3g-å’Œ-1st-and-2nd-generation-ipod-touches-ä¸Šè¿è¡Œ"><a class="markdownIt-Anchor" href="#gpuimage-å¦‚æœä½¿ç”¨-opengl-es-20ä¸ºä»€ä¹ˆä¸èƒ½åœ¨-iphone-iphone-3g-å’Œ-1st-and-2nd-generation-ipod-touches-ä¸Šè¿è¡Œ"></a> GPUImage å¦‚æœä½¿ç”¨ OpenGL ES 2.0ï¼Œä¸ºä»€ä¹ˆä¸èƒ½åœ¨ iPhone, iPhone 3G å’Œ 1st and 2nd generation iPod touches ä¸Šè¿è¡Œ?</h1>
<h1 id="opengl-es-åˆ°ç›®å‰ä¸ºæ­¢ä¸€å…±æœ‰å‡ ä¸ªç‰ˆæœ¬"><a class="markdownIt-Anchor" href="#opengl-es-åˆ°ç›®å‰ä¸ºæ­¢ä¸€å…±æœ‰å‡ ä¸ªç‰ˆæœ¬"></a> OpenGL ES åˆ°ç›®å‰ä¸ºæ­¢ä¸€å…±æœ‰å‡ ä¸ªç‰ˆæœ¬ï¼Ÿ</h1>
<p>1.0, 1.1, 2.0 (å¼€å§‹æ”¯æŒ shader), 3.0, 3.1, 3.2</p>
<h1 id="glsl-è¯­è¨€é‡Œ-vs-fs-é‡Œçš„å†…ç½®å˜é‡å’Œå†…ç½®å‡½æ•°"><a class="markdownIt-Anchor" href="#glsl-è¯­è¨€é‡Œ-vs-fs-é‡Œçš„å†…ç½®å˜é‡å’Œå†…ç½®å‡½æ•°"></a> GLSL è¯­è¨€é‡Œ vs fs é‡Œçš„å†…ç½®å˜é‡å’Œå†…ç½®å‡½æ•°</h1>
<ul>
<li>vs
<ul>
<li><code>gl_VertexID</code></li>
<li><code>gl_InstanceID</code></li>
<li><code>gl_Position</code></li>
<li><code>gl_PointSize</code></li>
</ul>
</li>
<li>fs
<ul>
<li><code>in   highp   vec4    gl_FragCoord</code></li>
<li><code>in           bool    gl_FrontFacing</code></li>
<li><code>out  highp   float   gl_FragDepth</code></li>
<li><code>in   mediump vec2    gl_PointCoord</code></li>
</ul>
</li>
</ul>
<h1 id="glsl-è¯­è¨€é‡Œ-varying-vs-uniform-çš„åŒºåˆ«"><a class="markdownIt-Anchor" href="#glsl-è¯­è¨€é‡Œ-varying-vs-uniform-çš„åŒºåˆ«"></a> GLSL è¯­è¨€é‡Œ Varying vs Uniform çš„åŒºåˆ«</h1>
<h1 id="ä¸¾ä¸€ä¸ªæ»¤é•œçš„ä¾‹å­è¯´è¯´å®ƒçš„å®ç°å’Œç®—æ³•åŠä½¿ç”¨åˆ°çš„-opengl-es-çš„æ‰©å±•åŠŸèƒ½"><a class="markdownIt-Anchor" href="#ä¸¾ä¸€ä¸ªæ»¤é•œçš„ä¾‹å­è¯´è¯´å®ƒçš„å®ç°å’Œç®—æ³•åŠä½¿ç”¨åˆ°çš„-opengl-es-çš„æ‰©å±•åŠŸèƒ½"></a> ä¸¾ä¸€ä¸ªæ»¤é•œçš„ä¾‹å­ï¼Œè¯´è¯´å®ƒçš„å®ç°å’Œç®—æ³•ï¼ŒåŠä½¿ç”¨åˆ°çš„ OpenGL ES çš„æ‰©å±•/åŠŸèƒ½</h1>
<h1 id="è¯´è¯´-ogre-æ¸²æŸ“å¼•æ“çš„ä¼˜ç¼ºç‚¹"><a class="markdownIt-Anchor" href="#è¯´è¯´-ogre-æ¸²æŸ“å¼•æ“çš„ä¼˜ç¼ºç‚¹"></a> è¯´è¯´ OGRE æ¸²æŸ“å¼•æ“çš„ä¼˜ç¼ºç‚¹</h1>
]]></content>
      <categories>
        <category>programming</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
      </tags>
  </entry>
  <entry>
    <title>C++ Template</title>
    <url>/prog/cpp-template/</url>
    <content><![CDATA[<h1 id="cä¸­çš„æ¨¡æ¿"><a class="markdownIt-Anchor" href="#cä¸­çš„æ¨¡æ¿"></a> C++ä¸­çš„æ¨¡æ¿</h1>
<p>C++ä¸­çš„æ¨¡æ¿å¯åˆ†ä¸ºclass templateå’Œfunction template. å®ƒä»¬ä¹‹é—´å­˜åœ¨ä¸åŒï¼Œä¾‹å¦‚ï¼Œfunction templateä¸èƒ½partially specialized(åç‰¹åŒ–)</p>
<span id="more"></span>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">U</span>&gt; <span class="function">T <span class="title">f</span><span class="params">(U obj)</span></span>; <span class="comment">// Primary template</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">U</span>&gt; <span class="type">void</span> <span class="built_in">f</span>&lt;<span class="type">void</span>, U&gt;(U obj); <span class="comment">// Illegal</span></span><br></pre></td></tr></table></figure>
<h1 id="æ¨¡æ¿å®ä¾‹åŒ–template-instantiation"><a class="markdownIt-Anchor" href="#æ¨¡æ¿å®ä¾‹åŒ–template-instantiation"></a> æ¨¡æ¿å®ä¾‹åŒ–(Template Instantiation)</h1>
<p>æ¨¡æ¿çš„å®ä¾‹åŒ–åˆ†ä¸ºExplicit Instantiationå’ŒImplicit Instantiation.</p>
<h2 id="explicit-instantiation"><a class="markdownIt-Anchor" href="#explicit-instantiation"></a> Explicit Instantiation</h2>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::out &lt;&lt; s &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;  <span class="comment">// Primary template definition</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> <span class="type">void</span> <span class="built_in">f</span>&lt;<span class="type">double</span>&gt;(<span class="type">double</span>); <span class="comment">// explicit instantiation</span></span><br><span class="line"><span class="keyword">template</span> <span class="type">void</span> f&lt;&gt;(<span class="type">char</span>);  <span class="comment">// explicit instantiation, template args deduced</span></span><br><span class="line"><span class="function"><span class="keyword">template</span> <span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">int</span>)</span></span>;  <span class="comment">// explicit instantiation, template args deduced</span></span><br></pre></td></tr></table></figure>
<h2 id="implicit-instantiation"><a class="markdownIt-Anchor" href="#implicit-instantiation"></a> Implicit Instantiation</h2>
<p>å®é™…ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¨¡æ¿çš„å¤§å¤šæ•°æ—¶å€™éƒ½æ˜¯ implicit instantiation, å³æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šåƒä¸Šé¢ä¸€æ ·ï¼Œæ˜¾å¼åœ°å£°æ˜ä¸€ä¸ªå…·ä½“ç±»å‹çš„æ¨¡æ¿å®ä¾‹ï¼Œæ›´å¸¸è§çš„æ˜¯ç›´æ¥å£°æ˜ä¸€ä¸ªæ¨¡æ¿å®ä¾‹(type)çš„å¯¹è±¡(object)ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="type">int</span>... A&gt; <span class="keyword">class</span> <span class="title class_">NonTypeVariadicTemplate</span> &#123;&#125;;  <span class="comment">// should be in .h</span></span><br><span class="line"></span><br><span class="line">NonTypeVariadicTemplate&lt;<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>&gt; ntvt; <span class="comment">// implicit instantiation</span></span><br></pre></td></tr></table></figure>
<h1 id="æ¨¡æ¿ç‰¹åŒ–template-specialisation"><a class="markdownIt-Anchor" href="#æ¨¡æ¿ç‰¹åŒ–template-specialisation"></a> æ¨¡æ¿ç‰¹åŒ–(template specialisation)</h1>
<p>æ¨¡æ¿ç‰¹åŒ–æ˜¯C++æ³›å‹ç¼–ç¨‹çš„ä¸€ä¸ªé‡è¦æŠ€æœ¯ï¼Œå®ƒçš„ä¸€ä¸ªå…¸å‹åº”ç”¨å°±æ˜¯type traitçš„å®ç°</p>
<h2 id="å…¨ç‰¹åŒ–full-specialisation"><a class="markdownIt-Anchor" href="#å…¨ç‰¹åŒ–full-specialisation"></a> å…¨ç‰¹åŒ–(full specialisation)</h2>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">is_boolean</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">bool</span> value = <span class="literal">false</span>;</span><br><span class="line">&#125;; <span class="comment">// primary template</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">is_boolean</span>&lt;<span class="type">bool</span>&gt; &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">bool</span> value = <span class="literal">true</span>;</span><br><span class="line">&#125;; <span class="comment">// full specialization</span></span><br></pre></td></tr></table></figure>
<h2 id="åç‰¹åŒ–partial-specialisation"><a class="markdownIt-Anchor" href="#åç‰¹åŒ–partial-specialisation"></a> åç‰¹åŒ–(partial specialisation)</h2>
<p>è™½ç„¶æ¨¡æ¿ç±»çš„å…¨ç‰¹åŒ–æ˜¯ä¸€ä¸ªé‡è¦çš„æ³›å‹ç¼–ç¨‹æŠ€æœ¯ï¼Œä½†æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½éœ€è¦ä¸€ä¸ªä»‹äºå®Œå…¨æ³›åŒ–å’Œå…¨ç‰¹åŒ–ä¹‹é—´çš„ä¸€ä¸ªç‰¹åŒ–ç‰ˆæœ¬ï¼Œè¿™å°±æ˜¯åç‰¹åŒ–ã€‚ä¸‹é¢çš„ä¾‹å­<code>is_pointer&lt;T&gt;</code>ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®Œå…¨æ³›åŒ–çš„æ¨¡æ¿ç‰ˆæœ¬æ¥å¤„ç†æ‰€æœ‰<code>T</code>ä¸æ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹çš„æƒ…å½¢ï¼Œè€Œéœ€è¦ä¸€ä¸ªåç‰¹åŒ–ç‰ˆæœ¬æ¥å¤„ç†æ‰€æœ‰<code>T</code>æ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹çš„æƒ…å½¢ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">is_pointer</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">bool</span> value = <span class="literal">false</span>;</span><br><span class="line">&#125;; <span class="comment">// primary version that handles all the cases where T is not a pointer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">is_pointer</span>&lt;T*&gt; &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">bool</span> value = <span class="literal">true</span>;</span><br><span class="line">&#125;; <span class="comment">// partial specialisation to handle all the cases where T is a pointer</span></span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ä¸¤ä¸ªä¾‹å­<code>is_boolean&lt;T&gt;</code>å’Œ<code>is_pointer&lt;T&gt;</code>å¯ä»¥çœ‹å‡ºï¼Œå…¨ç‰¹åŒ–å’Œåç‰¹åŒ–çš„è¯­æ³•æœ‰æ˜æ˜¾åŒºåˆ«ï¼Œåç‰¹åŒ–åœ¨ç±»ååé¢çš„å°–æ‹¬å·<code>&lt;&gt;</code>é‡Œä»ç„¶åŒ…å«æ¨¡æ¿å‚æ•°ï¼Œåƒ <code>&lt;T*&gt;</code>, è€Œå…¨ç‰¹åŒ–ç±»ååé¢çš„<code>&lt;&gt;</code>é‡Œå·²ç»ä¸åŒ…å«ä»»ä½•æ¨¡æ¿å‚æ•° (å¦‚ <code>T</code>)ï¼Œè€Œå…¨éƒ¨æ˜¯å…·ä½“çš„ç±»å‹, åƒ <code>&lt;bool&gt;</code>ã€‚</p>
<p>ä¸‹é¢çš„ä¾‹å­æ˜¯ä¸€ä¸ªæ›´å¤æ‚çš„åç‰¹åŒ–çš„ä¾‹å­<code>remove_bounds&lt;T&gt;</code>, è¿™ä¸ªæ¨¡æ¿ç±»ä»…ä»…å®šä¹‰ä¸€ä¸ªä¸<code>T</code>ç±»å‹ç›¸åŒçš„typedefæˆå‘˜ç±»å‹ï¼Œä½†æ˜¯é«˜å±‚çš„æ•°ç»„å…³è”è¢«ç§»é™¤äº†ï¼Œè¿™æ ·çš„æ¨¡æ¿ç±»å¯ä»¥å®Œæˆä¸€ä¸ªç±»å‹çš„è½¬åŒ–</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">remove_bounds</span> &#123;</span><br><span class="line">    <span class="keyword">typedef</span> T type;</span><br><span class="line">&#125;; <span class="comment">// primary version</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, std::<span class="type">size_t</span> N&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">remove_bounds</span>&lt;T[N]&gt; &#123;</span><br><span class="line">    <span class="keyword">typedef</span> T type;</span><br><span class="line">&#125;; <span class="comment">// partial specialisation</span></span><br></pre></td></tr></table></figure>
<p>ä»è¿™ä¸ªä¾‹å­å¯ä»¥çœ‹å‡º:</p>
<ul>
<li>
<p>åç‰¹åŒ–ç‰ˆæœ¬çš„æ¨¡æ¿å‚æ•°(å½¢å‚)çš„ä¸ªæ•°ä¸ä¸€å®šå’Œé»˜è®¤æ¨¡æ¿çš„ç›¸ç­‰</p>
<ul>
<li>å³ <code>&lt;typename T, std::size_t N&gt;</code> æ¯”é»˜è®¤æ¨¡æ¿å¤šå‡ºäº† <code>std::size_t N</code></li>
</ul>
</li>
<li>
<p>åç‰¹åŒ–ç‰ˆæœ¬çš„ç±»ååé¢çš„æ¨¡æ¿å‚æ•°(å®å‚)çš„ä¸ªæ•°å’Œç±»å‹å¿…é¡»åŒ¹é…é»˜è®¤æ¨¡æ¿çš„å‚æ•°çš„ä¸ªæ•°å’Œç±»å‹</p>
<ul>
<li>å³ <code>remove_bounds&lt;T[N]&gt;</code> ä¸­çš„ <code>T[N]</code>, ä¸ªæ•°åŒ¹é…æŒ‡ <code>T[N]</code> å¯¹åº”ä¸»æ¨¡æ¿é‡Œ <code>T</code>ï¼Œ ç±»å‹åŒ¹é…æŒ‡ <code>T[N]</code> ä¸­çš„ <code>T</code> åŒ¹é…ä¸»æ¨¡æ¿é‡Œçš„ <code>T</code></li>
</ul>
</li>
</ul>
<h1 id="typename-vs-class"><a class="markdownIt-Anchor" href="#typename-vs-class"></a> <code>typename</code> vs <code>class</code></h1>
<p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ<code>typename</code>å’Œ<code>class</code>å¯ä»¥äº’æ¢ä½¿ç”¨ï¼Œä½†å®ƒä»¬ä¹Ÿæœ‰ä¸èƒ½äº’æ¢çš„æ—¶å€™ï¼Œä¸‹é¢çš„æƒ…å†µåªèƒ½ä½¿ç”¨<code>typename</code>å…³é”®å­—:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">Option</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">OptTraits</span> &#123;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> Option::ValueType ValueType;</span><br><span class="line">&#125;;  <span class="comment">// Indicates Option::ValueType is a type</span></span><br></pre></td></tr></table></figure>
<h1 id="template-parameters-vs-template-arguments"><a class="markdownIt-Anchor" href="#template-parameters-vs-template-arguments"></a> template parameters vs template arguments</h1>
<p>template parametersä¹‹äºtemplate argumentsç›¸å½“äºå‡½æ•°çš„å½¢å‚ä¹‹äºå®å‚ã€‚C++æ¨¡æ¿çš„é€šç”¨è¯­æ³•æ˜¯:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">template &lt;parameter-list&gt; declaration</span><br></pre></td></tr></table></figure>
<p>parameter-listä¸­çš„æ¯ä¸ªå½¢å‚éƒ½å¯ä»¥æ˜¯ä¸‹åˆ—3ç§ä¸­çš„ä»»ä½•ä¸€ç§:</p>
<ul>
<li>non-type template parameter</li>
<li>type template parameter</li>
<li>template template parameter</li>
</ul>
<h2 id="æ¨¡æ¿ç±»çš„æ¨¡æ¿æ„é€ å‡½æ•°"><a class="markdownIt-Anchor" href="#æ¨¡æ¿ç±»çš„æ¨¡æ¿æ„é€ å‡½æ•°"></a> æ¨¡æ¿ç±»çš„æ¨¡æ¿æ„é€ å‡½æ•°</h2>
<p>æ¨¡æ¿ç±»çš„æ¨¡æ¿æ„é€ å‡½æ•°ï¼Œæ„æ€æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»çš„ä¸€ä¸ªæ„é€ å‡½æ•°ä¹Ÿæ˜¯ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ã€‚è¿™ç§æƒ…å†µæœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„:</p>
<ul>
<li>æ¨¡æ¿ç±»çš„æ¨¡æ¿å‚æ•°åä¸èƒ½å’Œæ„é€ å‡½æ•°çš„æ¨¡æ¿å‚æ•°åç›¸åŒ (<em>template parameter</em> cannot share the same name)</li>
<li>ä¸èƒ½æ˜¾å¼åœ°æŒ‡å®šæ¨¡æ¿æ„é€ å‡½æ•°çš„æ¨¡æ¿å®å‚ (cannot explicitly specify <em>template argument</em> for constructor)</li>
</ul>
<p>è¿™ç§æƒ…å†µå¯ä»¥å¾ˆå¥½çš„ä½“ç°template parameterå’Œtemplate argumentçš„åŒºåˆ«ï¼Œè¯·çœ‹ä¸‹é¢çš„ä¾‹å­:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> OptName&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Option</span> &#123;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> OptName::ValueType ValueType;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Constructor</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="type">size_t</span> NumNamedValues&gt;</span></span><br><span class="line"><span class="function">    <span class="title">Option</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* shortName_</span></span></span><br><span class="line"><span class="params"><span class="function">         , <span class="type">const</span> <span class="type">char</span>* longName_</span></span></span><br><span class="line"><span class="params"><span class="function">         , <span class="type">const</span> <span class="type">char</span>* description_</span></span></span><br><span class="line"><span class="params"><span class="function">         , <span class="type">const</span> NamedValue&lt;ValueType&gt; (&amp;namedValues_)[NumNamedValues]</span></span></span><br><span class="line"><span class="params"><span class="function">         , <span class="type">const</span> <span class="type">char</span>* defaultValue_ = DE_NULL)</span></span></span><br><span class="line"><span class="function">         : shortName(shortName_)</span></span><br><span class="line"><span class="function">         , longName(longName_)</span></span><br><span class="line"><span class="function">         , description(description_)</span></span><br><span class="line"><span class="function">         , defaultValue(defaultValue_)</span></span><br><span class="line"><span class="function">         , parse((ParseFunc)DE_NULL)</span></span><br><span class="line"><span class="function">         , namedValues(DE_ARRAY_BEGIN(namedValues_))</span></span><br><span class="line"><span class="function">         , namedValuesEnd(DE_ARRAY_END(namedValues_))</span></span><br><span class="line"><span class="function">    &#123;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> NamedValue&lt;<span class="type">bool</span>&gt; s_enableNames[] = &#123;</span><br><span class="line">    &#123; <span class="string">&quot;enable&quot;</span>, <span class="literal">true</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;disable&quot;</span>, <span class="literal">false</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Instantiation to call constructor above</span></span><br><span class="line">Option&lt;TestOOM&gt; opt = <span class="built_in">Option</span>&lt;TestOOM&gt;(DE_NULL, <span class="string">&quot;deqp-test-oom&quot;</span>, <span class="string">&quot;Run tests that exhaust memory&quot;</span>, s_enableNames, <span class="string">&quot;disable&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>ä»è¿™ä¸ªä¾‹å­çœ‹åˆ°æ¨¡æ¿æ„é€ å‡½æ•°è¢«è°ƒç”¨æ—¶æœ¬è¯¥æŒ‡å®šçš„non-type template argument(size_t) <code>NumNamedValues</code>å¹¶æ²¡æœ‰è¢«æŒ‡å®š, åŸå› æ˜¯æ¨¡æ¿å‡½æ•°çš„template argument liståº”è¯¥ç´§è·Ÿåœ¨å‡½æ•°ååé¢ï¼Œä½†æ˜¯æ„å»ºå‡½æ•°æ¨¡æ¿(ç±»å‹è½¬æ¢å‡½æ•°æ¨¡æ¿conversion member function templateä¹Ÿæ˜¯åŒæ ·æƒ…å†µ)è¢«è°ƒç”¨çš„æ—¶å€™<strong>ä¸ä½¿ç”¨å‡½æ•°å</strong>ï¼Œæ‰€ä»¥æ²¡æœ‰ä¸€ç§æ–¹æ³•å¯ä»¥æ˜¾å¼åœ°æŒ‡å®š</p>
<ul>
<li>constructor member function template</li>
<li>conversion member function template</li>
</ul>
<p>çš„template argument list.</p>
<h1 id="constraints-rules"><a class="markdownIt-Anchor" href="#constraints-rules"></a> Constraints &amp; Rules</h1>
<ul>
<li>Explicit instantiationæ—¶ï¼Œå¦‚æœå¯ä»¥ä»function parameteræ¨å¯¼å‡ºç±»å‹ï¼Œå¯ä»¥çœå»template args.</li>
<li>Function templateæˆ–class templateçš„member functionçš„Explicitå®ä¾‹åŒ–ä¸èƒ½ä½¿ç”¨<code>inline</code>å’Œ<code>constexpr</code>å…³é”®å­—ã€‚</li>
<li>Different template instantiations are distinct types.</li>
</ul>
]]></content>
      <categories>
        <category>programming</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
      </tags>
  </entry>
  <entry>
    <title>LLVM</title>
    <url>/prog/llvm/</url>
    <content><![CDATA[<h1 id="llvm-llvm-project"><a class="markdownIt-Anchor" href="#llvm-llvm-project"></a> LLVM &amp; llvm-project</h1>
<p>LLVM æ˜¯ Low-Level Virtual Machine çš„ç®€å†™ï¼Œä½†äº‹å®ä¸Šå®ƒä¸è™šæ‹Ÿæœºå…³ç³»ä¸å¤§ã€‚æˆ‘ä»¬æ›´ç†Ÿæ‚‰å®ƒæ˜¯ä¸€å¥—å·¥å…·é“¾ï¼ŒåŒ…æ‹¬ clang <code>/'klÃ¦Å‹/</code>, lld, lldb ç­‰ç­‰ã€‚æ¥è§¦ LLVM æ˜¯å› ä¸º Mesa llvmpipe ä½¿ç”¨ LLVM, è¿˜æœ‰ AMDGPU å’Œ Radeon çš„ç¼–è¯‘å™¨åç«¯éƒ½ä½¿ç”¨ LLVM IRï¼Œæ‰€ä»¥è¦ç¼–è¯‘ Mesa çš„ <code>-Dgallium-drivers=llvmpipe,radeonsi</code> éƒ½ä¾èµ–äº LLVM çš„è¯¸å¤šç»„ä»¶, æ„å»º Linux å†…æ ¸çš„ <a href="https://massoudasadiblog.blogspot.com/2024/07/ebpf-on-wsl2-kernel-version-6x-ubuntu.html">eBPF</a> ç¨‹åºä¹Ÿä¾èµ– LLVM, æ„å»º <a href="https://perfetto.dev/docs/quickstart/linux-tracing#building-from-source">perfetto</a> ä¹Ÿä¾èµ– LLVMã€‚è¿™é‡Œä¸»è¦è®°å½• LLVM çš„æ„å»ºå’Œä½¿ç”¨çš„ä¸€äº›é—®é¢˜ã€‚</p>
<span id="more"></span>
<p>llvm-project æ˜¯ 2003 å¹´å¼€æºçš„ã€‚2022 å¹´åˆï¼Œllvm-project çš„æºç åº“å’Œ bug tracker è¢«ç§»åˆ°äº† <a href="https://github.com/llvm/llvm-project">GitHub</a>. ä¸€å¼€å§‹ï¼ŒLLVM çš„ç¤¾åŒºäº¤æµå’Œé¡¹ç›®æ²Ÿé€šä¸»è¦æ–¹å¼æ˜¯ Mailing Lists å’Œ <a href="https://lucmann.github.io/misc/english/">IRC</a>, åœ¨ 2019 å¹´ï¼ŒLLVM ç¤¾åŒºè½¬å‘ <a href="https://www.discourse.org/">Discourse</a> è¿™ä¸ªå¼€æºç¤¾åŒºäº¤æµå¹³å°ã€‚</p>
<h1 id="build-llvm"><a class="markdownIt-Anchor" href="#build-llvm"></a> Build LLVM</h1>
<ul>
<li><code>cmake -S llvm -B build</code>
<ul>
<li>llvm æ˜¯ llvm-project æ ¹ç›®å½•ä¸‹çš„ä¸€ä¸ªå­ç›®å½•ï¼Œæ˜¯æˆ‘ä»¬çš„ç¼–è¯‘å¯¹è±¡ï¼Œåƒ lld, è¿˜æœ‰ c++ è¿è¡Œæ—¶åº“è¿™é‡Œä¸éœ€è¦æ„å»º</li>
</ul>
</li>
<li><code>-G &quot;Ninja&quot;</code>
<ul>
<li>ä½¿ç”¨ ninja æ„å»ºç³»ç»Ÿ</li>
</ul>
</li>
<li><code>-DCMAKE_BUILD_TYPE=Debug</code>
<ul>
<li>é»˜è®¤æ˜¯ <code>-DCMAKE_BUILD_TYPE=Release</code></li>
</ul>
</li>
<li><code>-DCMAKE_EXPORT_COMPILE_COMMANDS=ON</code>
<ul>
<li>ç”Ÿæˆ compile_commands.json ç´¢å¼•æ•°æ®åº“(å¯¼å…¥ IDE)</li>
</ul>
</li>
<li><code>-DCMAKE_INSTALL_PREFIX=~/.local/llvm</code>
<ul>
<li>è‡ªå®šä¹‰å®‰è£…è·¯å¾„ï¼Œé»˜è®¤æ˜¯ /usr/local</li>
<li>å®‰è£…è·¯å¾„åœ¨å®‰è£…ä¹‹åä¹Ÿå¯ä»¥é€šè¿‡ <code>llvm-config --prefix --ldflags</code> æŸ¥åˆ°</li>
</ul>
</li>
<li><code>-DBUILD_SHARED_LIBS=ON</code>
<ul>
<li><code>BUILD_SHARED_LIBS</code> æ˜¯ä¸€ä¸ª CMake é€‰é¡¹ï¼Œå½“å®ƒå¼€å¯æ—¶ï¼Œé‚£äº›æ²¡æœ‰æŒ‡æ˜ STATIC, SHARED, MODULE çš„æ„å»ºç›®æ ‡éƒ½ä¼šè¢«æ„å»ºæˆ SHARED åº“ã€‚è¿™ä¸ªä¸€èˆ¬è¦å¼€å¯ï¼Œå¦åˆ™ä¼šå¯¼è‡´åœ¨é“¾æ¥å™¨è¿›ç¨‹å›  OOM è¢« Killed (å› ä¸ºå¯æ‰§è¡Œç¨‹åºç”±é™æ€åº“ä»¬ç»„è£…è€Œæˆ, å†…å­˜ä¸å¤Ÿç”¨)</li>
</ul>
</li>
<li><code>-DLLVM_LIBDIR_SUFFIX=64</code>
<ul>
<li>å¦‚æœæ˜¯ 64 ä½ç³»ç»Ÿï¼Œå®‰è£…è·¯å¾„ä¼šç”±åŸæ¥ <code>$&#123;CMAKE_INSTALL_PREFIX&#125;/lib</code> å˜æˆ <code>$&#123;CMAKE_INSTALL_PREFIX&#125;/lib64</code></li>
</ul>
</li>
<li><code>-DLLVM_BUILD_LLVM_DYLIB=OFF</code>
<ul>
<li>å¦‚æœ ONï¼Œå°†æ‰€æœ‰ LLVM ç»„ä»¶ç”Ÿæˆä¸€ä¸ªå•ä¸€çš„å…±äº«åº“ libLLVM, é€‚ç”¨äºå°† LLVM åµŒå…¥åˆ°å…¶å®ƒå·¥å…·ä¸­çš„æƒ…å†µ</li>
</ul>
</li>
<li><code>-DLLVM_ENABLE_PROJECTS=&quot;clang;lld&quot;</code>
<ul>
<li>åªæ„å»º clang å’Œ lld (LLVM Linker) å­é¡¹ç›®, å¯é€‰é¡¹ç›®åŒ…æ‹¬:
<ul>
<li>bolt;clang;clang-tools-extra;compiler-rt;cross-project-tests;libc;libclc;lld;lldb;mlir;openmp;polly</li>
</ul>
</li>
</ul>
</li>
<li><code>-DLLVM_ENABLE_RUNTIMES=&quot;libcxx;libcxxabi&quot;</code>
<ul>
<li>å‡çº§ <code>libc++.so.1</code>, æ¯”å¦‚è¦å°† clang++ æ”¯æŒçš„ c++ æ ‡å‡†åº“å‡çº§åˆ° c<ins>2x (clang-16 ä»¥ä¸Šæ”¯æŒ c</ins>20), å¯é€‰ runtime åŒ…æ‹¬ï¼š
<ul>
<li>libc;libunwind;libcxxabi;libcxx;compiler-rt;openmp;llvm-libgcc;offload</li>
</ul>
</li>
</ul>
</li>
<li><code>-DLLVM_TARGETS_TO_BUILD=&quot;BPF;AMDGPU;host&quot;</code>
<ul>
<li>æŒ‡å®šæ”¯æŒå“ªäº›åç«¯(ISA), è¿™é‡Œå¦‚æœæ˜¯ä¸ºäº†ç¼–è¯‘ Mesa Radeon/AMDGPU, <code>AMDGPU</code> target å¿…é¡»æŒ‡å®šã€‚<code>host</code>æ˜¯æŒ‡å½“å‰ç¼–è¯‘æœºå™¨ã€‚å¦å¤–æŒ‡å®šçš„è¶Šå¤šï¼Œç¼–è¯‘è¶Šè€—æ—¶</li>
<li>å®‰è£…åå¯é€šè¿‡ <code>llvm-config --targets-built</code> è·å–</li>
</ul>
</li>
<li><code>-DLLVM_PARALLEL_COMPILE_JOBS=1 -DLLVM_PARALLEL_LINK_JOBS=1</code>
<ul>
<li>åœ¨ç¼–è¯‘æœºé…ç½®ä¸é«˜çš„æ—¶å€™ï¼Œå‡å° <code>cc1plus</code> å’Œ <code>ld</code> è¢« OOM-Killed çš„é£é™©</li>
<li>å½“é…ç½® <code>-DCMAKE_BUILD_TYPE=Debug</code> æ—¶ï¼Œå³ä½¿å°†ä¸Šé¢ä¸¤ä¸ªé€‰é¡¹éƒ½é…ç½®ä¸º 1ï¼Œä»ç„¶å¾ˆå¤§å¯èƒ½ä¼šè¢« OOM-Killed (é—®é¢˜ä¸æ˜¯ CPU çº¿ç¨‹å¤šå°‘ï¼Œè€Œæ˜¯å†…å­˜éœ€æ±‚è¿‡å¤§)ã€‚è¿™æ—¶æœ€æè§£å†³æ–¹æ³•æ˜¯å¢å¤§ swap åˆ†åŒº:
<ul>
<li><code>sudo fallocate -l 4G /swapfile</code>
<ul>
<li>æ¯” <code>dd if=/dev/zero of=/swapfile bs=1 count=0 seek=4G</code> å¿«ä¸€ç‚¹</li>
<li>å½“ <code>-DBUILD_SHARED_LIBS=OFF</code> (æ„å»º LLVM ä¸ºé™æ€åº“) æ—¶ï¼Œæœ€å¥½ 10G<br />
<img src="/images/llvm/static-link.png" alt="how horrible static linking is" /></li>
</ul>
</li>
<li><code>sudo chmod 600 /swapfile</code></li>
<li><code>sudo mkswap /swapfile</code>
<ul>
<li>æ ¼å¼åŒ–æˆ swap åˆ†åŒº</li>
</ul>
</li>
<li><code>sudo swapon /swapfile</code>
<ul>
<li>æ¿€æ´» swap åˆ†åŒº</li>
</ul>
</li>
<li>å¢å¤§ swap åˆ†åŒºåçš„æ•ˆæœ<br />
<img src="/images/llvm/mkswap-4G.gif" alt="" /></li>
</ul>
</li>
</ul>
</li>
<li><code>-DLLVM_USE_LINKER=gold</code>
<ul>
<li>å°†é»˜è®¤é“¾æ¥å™¨ <code>bfd</code> æ¢æˆ <code>gold</code> (å¯èƒ½ä¼šé“¾æ¥å¾—å¿«ä¸€ç‚¹)</li>
<li>ä¸€èˆ¬ Linux ç³»ç»Ÿä¸Šé»˜è®¤å®‰è£…æœ‰ä¸¤ä¸ªé“¾æ¥å™¨
<ul>
<li>/usr/bin/ld -&gt; x86_64-linux-gnu-ld</li>
<li>/usr/bin/ld.bfd -&gt; x86_64-linux-gnu-ld.bfd</li>
<li>/usr/bin/ld.gold -&gt; x86_64-linux-gnu-ld.gold</li>
</ul>
</li>
<li><code>-DLLVM_USE_LINKER=gold</code><br />
<img src="/images/llvm/gold.gif" alt="/usr/bin/ld.gold" /></li>
</ul>
</li>
</ul>
<p>å®‰è£…åï¼Œæˆ‘ä»¬éœ€è¦å°† <code>bin</code> ç›®å½•åŠ å…¥ <code>PATH</code>, å¹¶åˆ›å»º <code>/etc/ld.so.conf.d/llvm.conf</code> åŒ…å«ä¸‹é¢ä¸€è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/home/luc/.local/llvm/lib64</span><br></pre></td></tr></table></figure>
<h1 id="building-llvmpipe"><a class="markdownIt-Anchor" href="#building-llvmpipe"></a> Building llvmpipe</h1>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">llvm-config found: YES (/home/luc/.local/llvm/bin/llvm-config) 15.0.0</span><br><span class="line">Run-time dependency LLVM (modules: bitwriter, core, engine, executionengine, instcombine, mcdisassembler, mcjit, native, scalaropts, transformutils, coroutines) found: YES 15.0.0</span><br><span class="line">Run-time dependency valgrind found: NO (tried pkgconfig)</span><br><span class="line">Program bison found: YES (/usr/bin/bison)</span><br><span class="line">Program bison found: YES (/usr/bin/bison)</span><br><span class="line">Program flex found: YES (/usr/bin/flex)</span><br><span class="line">Run-time dependency libunwind found: NO (tried pkgconfig and cmake)</span><br><span class="line">Run-time dependency OpenMP found: YES 4.5</span><br><span class="line">Run-time dependency x11 found: YES 1.6.9</span><br><span class="line">Run-time dependency xext found: YES 1.3.4</span><br><span class="line">Run-time dependency xfixes found: YES 5.0.3</span><br><span class="line">Run-time dependency xcb-glx found: NO (tried pkgconfig and cmake)</span><br><span class="line">Message: Configuration summary:</span><br><span class="line"></span><br><span class="line">        prefix:          /usr</span><br><span class="line">        libdir:          lib/x86_64-linux-gnu</span><br><span class="line">        includedir:      include</span><br><span class="line"></span><br><span class="line">        OpenGL:          yes (ES1: yes ES2: yes)</span><br><span class="line">        OSMesa:          no</span><br><span class="line"></span><br><span class="line">        DRI platform:    drm</span><br><span class="line">        DRI drivers:     no</span><br><span class="line">        DRI driver dir:  /usr/lib/x86_64-linux-gnu/dri</span><br><span class="line"></span><br><span class="line">        GLX:             DRI-based</span><br><span class="line"></span><br><span class="line">        EGL:             yes</span><br><span class="line">        EGL drivers:     builtin:egl_dri2 builtin:egl_dri3</span><br><span class="line">        EGL/Vulkan/VL platforms:   x11 surfaceless drm xcb</span><br><span class="line">        GBM:             yes</span><br><span class="line">        GBM backends path: /usr/lib/x86_64-linux-gnu/gbm</span><br><span class="line"></span><br><span class="line">        Vulkan drivers:  swrast</span><br><span class="line">        Vulkan ICD dir:  share/vulkan/icd.d</span><br><span class="line"></span><br><span class="line">        llvm:            yes</span><br><span class="line">        llvm-version:    15.0.0</span><br><span class="line"></span><br><span class="line">        Gallium drivers: swrast</span><br><span class="line">        Gallium st:      mesa</span><br><span class="line">        HUD lmsensors:   no</span><br><span class="line"></span><br><span class="line">        Shared-glapi:    yes</span><br><span class="line"></span><br><span class="line">        Perfetto:        no</span><br><span class="line">        Perfetto ds:     auto</span><br><span class="line"></span><br><span class="line">Build targets in project: 174</span><br></pre></td></tr></table></figure>
<p>å½“ç¼–è¯‘ Mesa æ—¶ï¼Œé‡åˆ°çš„ç¬¬ä¸€ä¸ªç¼–è¯‘é”™è¯¯æ˜¯ <code>No such file or directory</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">../src/gallium/auxiliary/gallivm/lp_bld_init.c:52:10: fatal error: llvm-c/Transforms/Coroutines.h: No such file or directory                                                                                                                       52 | #include &lt;llvm-c/Transforms/Coroutines.h&gt;                                                                             |          ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                                                       compilation terminated.</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªé—®é¢˜ä¼¼ä¹ä¸å¥½è§£å†³ï¼Œæˆ‘è½¬å‘æ„å»º LLVM 14.0.6</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  llvm-project git:(14.0.6) cmake -S llvm -B build -G Ninja -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=On -DLLVM_ENABLE_PROJECTS=<span class="string">&quot;clang;lld&quot;</span> -DLLVM_ENABLE_RUNTIMES=<span class="string">&quot;libcxx;libcxxabi&quot;</span> -DCMAKE_INSTALL_PREFIX=~/.local/llvm-14 -DLLVM_LIBDIR_SUFFIX=<span class="string">&quot;64&quot;</span> -DLLVM_TARGETS_TO_BUILD=<span class="string">&quot;host&quot;</span> -DLLVM_BUILD_LLVM_DYLIB=On -DBUILD_SHARED_LIBS=On -DLLVM_PARALLEL_COMPILE_JOBS=1 -DLLVM_PARALLEL_LINK_JOBS=1 -DLLVM_USE_LINKER=gold</span><br></pre></td></tr></table></figure>
<p>ä½†åˆé‡åˆ°ä¸‹é¢çš„é”™è¯¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CMake Error at /home/luc/gh/llvm-project/libcxx/CMakeLists.txt:880 (message):                                             LIBCXX_ABI_NAMESPACE &#x27;__1&#x27; is reserved for use by libc++.                                                                                                                                                                                                                                                                                                             -- Configuring incomplete, errors occurred!</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹ <code>libcxx/CMakeLists.txt</code> å‘ç° <code>LIBCXX_ABI_NAMESPACE</code> æ˜¯ä¸€ä¸ª CMake å˜é‡, è€Œä¸”è¢«ç¼“å­˜äº†ï¼Œéš¾æ€ªç¬¬ä¸€æ¬¡æ„å»ºæ—¶æ²¡æœ‰æŠ¥è¿™ä¸ªé”™è¯¯ï¼Œæ‰€ä»¥åœ¨ç¼–è¯‘æ–°çš„ LLVM ä¹‹å‰ä¸€æ¬¡è®°å¾—å°†åŸæ¥çš„æ„å»ºç›®å½•åˆ é™¤ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set(LIBCXX_ABI_NAMESPACE &quot;&quot; CACHE STRING &quot;The inline ABI namespace used by libc++. It defaults to __n where `n` is the  current ABI version.&quot;)</span><br></pre></td></tr></table></figure>
<h1 id="llvm-jit"><a class="markdownIt-Anchor" href="#llvm-jit"></a> LLVM JIT</h1>
<ul>
<li>Just-In-Time</li>
<li>Ahead-Of-Time</li>
</ul>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://sh4dy.com/2024/11/24/learning_llvm_03/">Learning LLVM Part-3</a></li>
</ul>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>Compiler</tag>
      </tags>
  </entry>
  <entry>
    <title>å¤šçº¿ç¨‹ä¸­çš„åŒæ­¥</title>
    <url>/prog/mt/</url>
    <content><![CDATA[<h1 id="åŒæ­¥åŸè¯­"><a class="markdownIt-Anchor" href="#åŒæ­¥åŸè¯­"></a> åŒæ­¥åŸè¯­</h1>
<p>åŒæ­¥åŸè¯­(Synchronization Primitive)çš„<a href="https://www.cs.columbia.edu/~hgs/os/sync.html">ç¡®åˆ‡å®šä¹‰æ²¡æœ‰ä¸€ä¸ªå®˜æ–¹çš„</a>ã€‚ä½†å¤§ä½“æ¥è¯´åŒæ­¥åŸè¯­å¯èƒ½æœ‰ä»¥ä¸‹å‡ ç§:</p>
<ul>
<li>semaphores</li>
<li>mutex</li>
<li>locks</li>
<li>condition variables</li>
<li>test-and-set machine instructions</li>
</ul>
<span id="more"></span>
<p>ä½†è¿™äº›åŒæ­¥åŸè¯­æ˜¯å¦‚ä½•å®ç°å¤šçº¿ç¨‹åŒæ­¥çš„å‘¢ï¼Ÿ</p>
<ul>
<li>å½“æˆ‘ä»¬è°ˆè®ºçº¿ç¨‹åŒæ­¥æ—¶ï¼Œæˆ‘ä»¬åœ¨è¯´ä»€ä¹ˆï¼Ÿ</li>
</ul>
<p>å½“æˆ‘ä»¬è°ˆè®ºçº¿ç¨‹åŒæ­¥æ—¶ï¼Œæ‰€è°“åŒæ­¥ï¼Œå°±æ˜¯å¿…é¡»ä¿è¯å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€æ•°æ®çš„é¢„æœŸè®¿é—®æ¬¡åºï¼Œä¹Ÿå°±æ˜¯&quot;ä¸´ç•ŒåŒº&quot;çš„ä¿æŠ¤ã€‚ä¹‹æ‰€ä»¥å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€æ•°æ®çš„è®¿é—®å¯èƒ½ä¼šäº§ç”Ÿä¸é¢„æœŸçš„ç»“æœï¼Œæ˜¯å› ä¸ºå†…å­˜(è¿™å—å…¨å±€å¯è§å­˜å‚¨)ä¸­çš„æ•°æ®å¯èƒ½ä¼šå› ä¸ºCPUè¯»å†™é¡ºåºçš„å·®å¼‚å¯¼è‡´å…¶ä¸å„ä¸ªCPU(æ ¸å¿ƒ)æœ¬åœ°ç¼“å­˜ä¸­çš„æ•°æ®ä¸ä¸€è‡´ã€‚æ‰€ä»¥çº¿ç¨‹åŒæ­¥ï¼Œå®è´¨ä¸Šå°±æ˜¯éœ€è¦ä¿è¯å¦‚æœä¸€ä¸ªCPUæ ¸å¿ƒè¦è¯»å†…å­˜ä¹‹å‰ï¼Œå¦ä¸€ä¸ªCPUå·²ç»å°†æ–°å€¼å†™å…¥é‚£ä¸ªåœ°å€çš„å†…å­˜ï¼Œå¦‚æœæ²¡æœ‰å†™å…¥ï¼Œå°±è¦è®©æ‰€æœ‰å‡†å¤‡æ‰§è¡Œè¯»æ“ä½œçš„CPUæ ¸å¿ƒåœä¸‹æ¥ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­æˆ‘ä»¬ä¸éš¾å‘ç°æœ‰ä¸¤ä¸ªå…³é”®ç‚¹: CPUæ‰€æ‰§è¡ŒæŒ‡ä»¤(è¯»å†™æ“ä½œ)çš„åŸå­æ€§å’Œå†…å­˜æ•°æ®çš„å¯è§æ€§(æœ¬åœ°ç¼“å­˜æ˜¯å¦æ›´æ–°åˆ°å†…å­˜)ã€‚</p>
<ul>
<li>åŸå­æ“ä½œ</li>
<li>å†…å­˜å±éšœ</li>
</ul>
<h2 id="xshmfence"><a class="markdownIt-Anchor" href="#xshmfence"></a> xshmfence</h2>
<ul>
<li>åŸºäº futex å’ŒåŸå­æ“ä½œå®ç°  <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">xshmfence_await</span><span class="params">(<span class="keyword">struct</span> xshmfence *f)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (__sync_val_compare_and_swap(&amp;f-&gt;v, <span class="number">0</span>, <span class="number">-1</span>) != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (futex_wait(&amp;f-&gt;v, <span class="number">-1</span>)) &#123; <span class="comment">// blocking the caller process until f-&gt;v reaches to 0</span></span><br><span class="line">            <span class="keyword">if</span> (errno != EWOULDBLOCK)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>åŸºäº pthread æ¡ä»¶å˜é‡å®ç°</li>
</ul>
<h1 id="posix-threads-å®ç°-lpthread"><a class="markdownIt-Anchor" href="#posix-threads-å®ç°-lpthread"></a> POSIX Threads å®ç° - <code>-lpthread</code></h1>
<h2 id="spinlock"><a class="markdownIt-Anchor" href="#spinlock"></a> Spinlock</h2>
<p>è‡ªæ—‹é”æ˜¯è§£å†³å¤šå¤„ç†å™¨å…±äº«å†…å­˜ä½¿ç”¨çš„ä¸€ç§åº•å±‚åŒæ­¥æœºåˆ¶ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å–ä¸€ä¸ªå·²ç»è¢«å¦ä¸€ä¸ªçº¿ç¨‹å æœ‰çš„è‡ªæ—‹é”æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹å°†ä»¥å¾ªç¯æ£€æŸ¥è‡ªæ—‹é”æ˜¯å¦è¢«é‡Šæ”¾çš„æ–¹å¼(è‡ªæ—‹)é˜»å¡ã€‚ä¸€ä¸ªçº¿ç¨‹ä¸åº”è¯¥é•¿æ—¶é—´å æœ‰ä¸€ä¸ªè‡ªæ—‹é”ï¼Œå› ä¸ºè¢«é˜»å¡çš„çº¿ç¨‹ä»ç„¶æ¶ˆè€—CPUèµ„æº (CPU cycles)</p>
<h3 id="posix-interfaces"><a class="markdownIt-Anchor" href="#posix-interfaces"></a> POSIX interfaces</h3>
<h4 id="initializing-a-spinlock"><a class="markdownIt-Anchor" href="#initializing-a-spinlock"></a> Initializing a Spinlock</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pthread_spin_init</span><span class="params">(<span class="type">pthread_spinlock_t</span> *lock, <span class="type">int</span> pshared)</span>; </span><br></pre></td></tr></table></figure>
<p><code>pshared</code>å±æ€§å¯ä»¥å–ä»¥ä¸‹å€¼çš„å…¶ä¸­ä¹‹ä¸€:</p>
<p>PTHREAD_PROCESS_SHARED - è¿™ä¸ªè‡ªæ—‹é”å¯ä»¥è¢«ä»»ä½•çº¿ç¨‹æ“ä½œï¼Œå³ä½¿è¿™äº›çº¿ç¨‹å±äºä¸åŒçš„è¿›ç¨‹ï¼Œåªè¦ç”³è¯·è¿™ä¸ªè‡ªæ—‹é”çš„å†…å­˜æ˜¯è¢«è¿™äº›è¿›ç¨‹å…±äº«çš„ã€‚</p>
<p>PTHREAD_PROCESS_PRIVATE - è¿™ä¸ªè‡ªæ—‹é”åªèƒ½è¢«é‚£äº›ä¸åˆå§‹åŒ–å®ƒçš„çº¿ç¨‹åŒå±ä¸€ä¸ªè¿›ç¨‹çš„çº¿ç¨‹æ“ä½œã€‚</p>
<h4 id="acquiring-a-spinlock"><a class="markdownIt-Anchor" href="#acquiring-a-spinlock"></a> Acquiring a Spinlock</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pthread_spin_lock</span><span class="params">(<span class="type">pthread_spinlock_t</span> *lock)</span>;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœè¢«è¯·æ±‚çš„è‡ªæ—‹é”æ²¡æœ‰è¢«å…¶å®ƒçº¿ç¨‹å æœ‰ï¼Œåˆ™è¯·æ±‚å®ƒçš„çº¿ç¨‹æˆåŠŸè·å–è¿™ä¸ªé”ï¼Œå¦åˆ™è¿™ä¸ªçº¿ç¨‹ä¸ä»<code>pthread_spin_lock</code>ä¸­è¿”å›(é˜»å¡)ï¼Œç›´åˆ°è¿™ä¸ªé”è¢«é‡Šæ”¾ã€‚ä¸€ä¸ªçº¿ç¨‹å°è¯•è·å–è¢«å®ƒè‡ªå·±å æœ‰çš„è‡ªæ—‹é”æ˜¯æœªå®šä¹‰çš„è¡Œä¸ºã€‚</p>
<h4 id="acquiring-a-non-blocking-spinlock"><a class="markdownIt-Anchor" href="#acquiring-a-non-blocking-spinlock"></a> Acquiring a Non-Blocking Spinlock</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pthread_spin_trylock</span><span class="params">(<span class="type">pthread_spinlock_t</span> *lock)</span>;</span><br></pre></td></tr></table></figure>
<p>å°è¯•è·å–ä¸€ä¸ªè‡ªæ—‹é”ï¼Œä¸<code>pthread_spin_lock</code>ä¸åŒçš„æ˜¯ï¼Œå¦‚æœæ‰€è¯·æ±‚çš„é”è¢«å¦ä¸€ä¸ªçº¿ç¨‹å æœ‰ï¼Œä¸é˜»å¡ï¼Œè€Œæ˜¯ç«‹å³è¿”å›å¤±è´¥(Non-Blocking).</p>
<h4 id="unlocking-a-spinlock"><a class="markdownIt-Anchor" href="#unlocking-a-spinlock"></a> Unlocking a Spinlock</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pthread_spin_unlock</span><span class="params">(<span class="type">pthread_spinlock_t</span> *lock)</span>;</span><br></pre></td></tr></table></figure>
<p>é‡Šæ”¾è¢«é”çš„è‡ªæ—‹é”ã€‚æˆåŠŸè¿”å›0ï¼Œå¦åˆ™è¿”å›ä»¥ä¸‹é”™è¯¯ç ä¹‹ä¸€:</p>
<p>EPERM - è°ƒç”¨çº¿ç¨‹ä¸æŒæœ‰è¿™ä¸ªé”</p>
<p>EINVAL - lockæŒ‡å‘çš„ä¸æ˜¯ä¸€ä¸ªå·²åˆå§‹åŒ–çš„è‡ªæ—‹é”å¯¹è±¡</p>
<h4 id="destroying-a-spinlock"><a class="markdownIt-Anchor" href="#destroying-a-spinlock"></a> Destroying a Spinlock</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pthread_spin_destroy</span><span class="params">(<span class="type">pthread_spinlock_t</span> *lock)</span>;</span><br></pre></td></tr></table></figure>
<h1 id="æ— é”é˜Ÿåˆ—"><a class="markdownIt-Anchor" href="#æ— é”é˜Ÿåˆ—"></a> æ— é”é˜Ÿåˆ—</h1>
<p>æ— é”é˜Ÿåˆ—çš„å®ç°ä¾é çš„æ˜¯CPUæä¾›çš„åŸå­æ“ä½œæŒ‡ä»¤(atomic) å’Œæ¯”è¾ƒå’Œäº¤æ¢æŒ‡ä»¤ (cas). å…¶ä¸­cas æŒ‡ä»¤è¿˜æœ‰ä¸€ç§ double-width cas (dwcas), å°±æ˜¯èƒ½åœ¨ 64ä½æœºå™¨ä¸ŠåŸå­åœ°è¿›è¡Œ 128ä½(dword)å€¼çš„cas (åœ¨ aarch64 cas å’Œ dwcas æ˜¯åŒä¸€æ¡æŒ‡ä»¤)ï¼ŒCPUæ˜¯å¦æ”¯æŒdwcas, å½±å“å®ç°æ— é”é˜Ÿåˆ—æ—¶çš„ä¸€ä¸ªç­–ç•¥ï¼Œå³é˜Ÿåˆ—å®¹é‡æ˜¯å¦å›ºå®šã€‚</p>
<h2 id="aba-é—®é¢˜"><a class="markdownIt-Anchor" href="#aba-é—®é¢˜"></a> ABA é—®é¢˜</h2>
<p>æ— é”æ•°æ®ç»“æ„é€šå¸¸é‡‡ç”¨çš„æ˜¯ä¸€ç§ç®€å•çš„â€œé‡è¯•â€ç­–ç•¥ï¼Œå®ƒçš„æ€æƒ³æ˜¯çº¿ç¨‹0 è·å–ä¸€ä¸ªptr, è®¿é—®å®ƒæŒ‡å‘çš„æ•°æ®ï¼Œç„¶åå°è¯•æ›´æ–°è¿™ä¸ª ptrçš„å€¼(é€šè¿‡ cas), å¦‚æœå‘ç°è¿™ä¸ª ptr å·²ç»å˜äº†(cas æ¯”è¾ƒæµ‹è¯•å¤±è´¥), é‚£å°±é‡æ–°è·å–æœ‰æ–°å€¼çš„ptr, å†è®¿é—®æ–°ptr æŒ‡å‘çš„æ•°æ®ã€‚</p>
<p>ABA é—®é¢˜å‡ºç°çš„åœºæ™¯æ˜¯ï¼Œåœ¨çº¿ç¨‹0ï¼Œå‰åä¸¤æ¬¡è¯»åˆ°ptr çš„å€¼çš„ä¸­é—´ï¼Œæœ‰å¯èƒ½çº¿ç¨‹1ï¼Œå·²ç»ä¿®æ”¹è¿‡ ptr çš„å€¼ç”±A åˆ° Bï¼Œè€Œååˆåœ¨çº¿ç¨‹0 cas æ“ä½œå‰ï¼Œçº¿ç¨‹1åˆ<strong>æ°å·§</strong>åœ¨åœ°å€Aç”³è¯·åˆ°ä¸€ä¸ªå…ƒç´ é‚å°†ptr çš„å€¼åˆæ”¹å›A, ç»“æœå°±æ˜¯çº¿ç¨‹1å¯¹ptr çš„ä¿®æ”¹(A-&gt;B-&gt;A)å¯¹çº¿ç¨‹0ä¸å¯è§ï¼Œè€Œå®é™…ä¸ŠAæŒ‡å‘çš„å†…å®¹å¯èƒ½å·²ç»å‘ç”Ÿå˜åŒ–ï¼Œå¯¹çº¿ç¨‹0æ¥è¯´å¯èƒ½å¯¼è‡´æœªé¢„æœŸçš„ç»“æœã€‚</p>
<p>è¿™ç§åœºæ™¯çš„ABAé—®é¢˜å¯ä»¥é€šè¿‡å°†åŸæ¥å•ç‹¬çš„ä¸€ä¸ªptr (64ä½ç³»ç»Ÿä¸Šsizeof(ptr) = 8), æ›¿æ¢æˆä¸€å¯¹(ptr, counter)æ¥è§£å†³ã€‚æ¯æ¬¡ptr è¢«ä¿®æ”¹ï¼Œcounterå°±+1, è¿™æ ·å³ä½¿æœ€åptr æ˜¯ç›¸ç­‰çš„(A-&gt;B-&gt;A), ä½†counter ä¹Ÿä¸ç›¸ç­‰ï¼Œè¿™æ ·åªè¦åŒæ—¶å¯¹(ptr, counter) åš cas æ¯”è¾ƒå°±å¯ä»¥å‡†ç¡®åˆ¤å®šptr æ˜¯å¦è¢«ä¿®æ”¹è¿‡(å¦‚æœä¿®æ”¹è¿‡ï¼Œå³ä½¿ç°åœ¨çš„å€¼å’Œä¹‹å‰çš„å€¼ç›¸ç­‰ï¼Œä»ç„¶è¦é‡æ–°è·å–è¿™ä¸ªå€¼ï¼Œå†æ¬¡è®¿é—®å®ƒæŒ‡å‘çš„å†…å®¹)ã€‚ä½†ç°åœ¨è¦æ¯”è¾ƒçš„æ•°æ®ç”±åŸæ¥çš„8å­—èŠ‚å˜æˆ16å­—èŠ‚ï¼Œæ‰€ä»¥å°±éœ€è¦ dwcas æŒ‡ä»¤ã€‚</p>
<p>ç”±ä¸Šé¢ABAé—®é¢˜çš„åˆ†æå¯ä»¥çœ‹åˆ°ï¼Œä¹‹æ‰€ä»¥å¯¹çº¿ç¨‹0æ¥è¯´ï¼ŒAæŒ‡å‘çš„å†…å®¹å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼ŒåŸå› æ˜¯ä¸­é—´å­˜åœ¨ç”³è¯·å†…å­˜çš„æ“ä½œã€‚æ‰€ä»¥åªè¦ä¿è¯åœ¨æ•´ä¸ªé˜Ÿåˆ—æ“ä½œä¸­ï¼Œä¸ä¼šåŠ¨æ€ç”³è¯·å…ƒç´ (æ²¡æœ‰äº†çº¿ç¨‹1æ°å·§åˆé‡æ–°åˆ†é…çš„Aè¿™ä¸ªåœ°å€çš„å¯èƒ½)ï¼Œè¿™ç§åœºæ™¯çš„ABAé—®é¢˜ä¹Ÿå°±ä¸å­˜åœ¨äº†ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ CPU å¦‚æœä¸æ”¯æŒ dwcas, åˆ™æ— é”é˜Ÿåˆ—çš„å®¹é‡å¿…é¡»æ˜¯å›ºå®šå¤§å°çš„ã€‚</p>
<h2 id="boostlockfreequeue-æºç åˆ†æ"><a class="markdownIt-Anchor" href="#boostlockfreequeue-æºç åˆ†æ"></a> boost::lockfree::queue æºç åˆ†æ</h2>
<h3 id="ç®—æ³•"><a class="markdownIt-Anchor" href="#ç®—æ³•"></a> ç®—æ³•</h3>
<ul>
<li>å‡ºé˜Ÿ</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pop(Q: pointer to <span class="built_in">queue</span>, ret: pointer to data type): boolean</span><br><span class="line">D1:    loop                             # Keep trying until pop is done</span><br><span class="line">D2:      head = Q-&gt;Head                 # Read Head</span><br><span class="line">D3:      tail = Q-&gt;Tail                 # Read Tail</span><br><span class="line">D4:      next = head-&gt;next              # Read Head.ptr-&gt;next</span><br><span class="line">D5:      <span class="keyword">if</span> head == Q-&gt;Head             # Are head, tail, and next consistent?</span><br><span class="line">D6:        <span class="keyword">if</span> head.ptr == tail.ptr      # Is <span class="built_in">queue</span> empty or Tail falling bebind?</span><br><span class="line">D7:          <span class="keyword">if</span> next.ptr == <span class="literal">NULL</span>        # Is <span class="built_in">queue</span> empty?</span><br><span class="line">D8:            <span class="keyword">return</span> FALSE             # Queue is empty, couldn<span class="number">&#x27;</span>t pop</span><br><span class="line">D9:          endif</span><br><span class="line">             # Tail is falling behind. Try to advance it</span><br><span class="line">D10:         CAS(&amp;Q-&gt;Tail, tail, &lt;next.ptr, tail.count+<span class="number">1</span>&gt;)</span><br><span class="line">D11:       <span class="keyword">else</span>                         # No need to deal with Tail</span><br><span class="line">             # Read value before CAS, otherwise another pop might <span class="built_in">free</span> the next node</span><br><span class="line">D12:         *ret = next.ptr-&gt;value</span><br><span class="line">             # Try to swing Head to the next node</span><br><span class="line">D13:         <span class="keyword">if</span> CAS(&amp;Q-&gt;Head, head, &lt;next.ptr, head.count+<span class="number">1</span>&gt;)</span><br><span class="line">D14:           <span class="keyword">break</span>                    # Pop is done, Exit loop</span><br><span class="line">D15:         endif</span><br><span class="line">D16:       endif</span><br><span class="line">D17:     endif</span><br><span class="line">D18:   endloop</span><br><span class="line">D19:   <span class="built_in">free</span>(head.ptr)                   # It is safe now to <span class="built_in">free</span> the old dummy node</span><br><span class="line">D20:   <span class="keyword">return</span> TRUE                      # Queue was not empty, pop succeeded </span><br></pre></td></tr></table></figure>
<h3 id="cå®ç°"><a class="markdownIt-Anchor" href="#cå®ç°"></a> C++å®ç°</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">private:</span><br><span class="line">    <span class="built_in">std</span>::atomic&lt; tagged_node_handle &gt; head_;</span><br><span class="line">    <span class="built_in">std</span>::atomic&lt; tagged_node_handle &gt; tail_;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><a href="https://en.cppreference.com/w/cpp/atomic/memory_order">std::memory_order</a></p>
  <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">memory_order</span> &#123;</span></span><br><span class="line">    memory_order_relaxed,</span><br><span class="line">    memory_order_consume,</span><br><span class="line">    memory_order_acquire,</span><br><span class="line">    memory_order_release,</span><br><span class="line">    memory_order_acq_rel,</span><br><span class="line">    memory_order_seq_cst, <span class="comment">// Sequentially-consistent ordering</span></span><br><span class="line">&#125; memory_order;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªmemory_orderçš„é¡ºåºï¼Œç”±ä¸Šåˆ°ä¸‹å¯¹åŸå­å˜é‡çš„æ“ä½œå’Œè¯»å†™é¡ºåºçš„ä¿è¯åº”è¯¥æ˜¯è¶Šæ¥è¶Šä¸¥æ ¼çš„(æ²¡æœ‰è¯»å†™é¡ºåºä¿è¯-&gt;å•ä¸ªåŸå­å˜é‡è¯»å†™é¡ºåºä¿è¯-&gt;å…¨å±€è¯»å†™é¡ºåºä¸€è‡´)ã€‚</p>
<ul>
<li>
<p><code>memory_order_relaxed</code>åªä¿è¯åŸå­æ“ä½œï¼Œä¸ä¿è¯æŒ‡ä»¤é¡ºåºã€‚</p>
</li>
<li>
<p><code>memory_order_acquire</code></p>
<ul>
<li>ç”¨äº <code>atomic&lt;T&gt;::load()</code></li>
<li>å¯¹äºä½¿ç”¨memory_order_acquireçš„æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤åé¢çš„æ‰€æœ‰è¯»å†™æ“ä½œ<strong>ä¸èƒ½é‡æ’åœ¨è¯¥æŒ‡ä»¤ä¹‹å‰</strong></li>
<li>å½“å‰çº¿ç¨‹æ‰§è¡Œçš„memory_order_acquireæŒ‡ä»¤èƒ½å¤Ÿä¿è¯è¯»åˆ°å…¶ä»–çº¿ç¨‹memory_order_releaseæŒ‡ä»¤ä¹‹å‰çš„æ‰€æœ‰å†…å­˜å†™å…¥æ“ä½œ</li>
</ul>
</li>
<li>
<p><code>memory_order_release</code></p>
<ul>
<li>ç”¨äº <code>atomic&lt;T&gt;::store()</code></li>
<li>å¯¹äºä½¿ç”¨memory_order_releaseçš„æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤ä¹‹å‰çš„æ‰€æœ‰è¯»å†™æ“ä½œ<strong>ä¸èƒ½é‡æ’åœ¨è¯¥æŒ‡ä»¤ä¹‹å</strong></li>
<li>å½“å‰çº¿ç¨‹memory_order_releaseæŒ‡ä»¤ä¹‹å‰çš„æ‰€æœ‰å†…å­˜å†™æ“ä½œå¯¹äºå…¶ä»–çº¿ç¨‹çš„memory_order_acquireæŒ‡ä»¤éƒ½å¯è§ã€‚</li>
</ul>
</li>
<li>
<p><code>memory_order_acq_rel</code></p>
<ul>
<li>ç”¨äº <code>atomic&lt;T&gt;::fetch_add()</code>, <code>atomic&lt;T&gt;::compare_exchange_weak()</code> è¿™ç±» read-modify-write æ“ä½œã€‚å¦‚æœç”¨åœ¨æ™®é€šçš„ <code>atomic&lt;T&gt;::load()</code>ï¼Œæ•ˆæœä¸ç”¨memory_order_acquire æ— å¼‚ã€‚</li>
<li>æŠŠ memory_order_acquire å’Œ memory_order_release ç»“åˆèµ·æ¥ï¼Œå®ƒå¯ä»¥ä¿è¯å•ä¸ªåŸå­å˜é‡çš„è¯»å†™é¡ºåºï¼Œä¸‹é¢çš„ä¾‹å­å°±æ˜¯ä¸é€‚ç”¨ memory_order_acq_rel çš„</li>
</ul>
  <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::atomic&lt;<span class="type">bool</span>&gt; x = &#123;<span class="literal">false</span>&#125;;</span><br><span class="line"><span class="built_in">std</span>::atomic&lt;<span class="type">bool</span>&gt; y = &#123;<span class="literal">false</span>&#125;;</span><br><span class="line"><span class="built_in">std</span>::atomic&lt;<span class="type">int</span>&gt; z = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_x</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    x.store(<span class="literal">true</span>, <span class="built_in">std</span>::memory_order_acq_rel);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_y</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    y.store(<span class="literal">true</span>, <span class="built_in">std</span>::memory_order_acq_rel);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">read_x_then_y</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (!x.load(<span class="built_in">std</span>::memory_order_acq_rel))</span><br><span class="line">        ;</span><br><span class="line">    <span class="keyword">if</span> (y.load(<span class="built_in">std</span>::memory_order_acq_rel))</span><br><span class="line">        ++z;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">read_y_then_x</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (!y.load(<span class="built_in">std</span>::memory_order_acq_rel))</span><br><span class="line">        ;</span><br><span class="line">    <span class="keyword">if</span> (x.load(<span class="built_in">std</span>::memory_order_acq_rel))</span><br><span class="line">        ++z;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">std</span>::thread <span class="title function_">a</span><span class="params">(write_x)</span>;</span><br><span class="line">    <span class="built_in">std</span>::thread <span class="title function_">b</span><span class="params">(write_y)</span>;</span><br><span class="line">    <span class="built_in">std</span>::thread <span class="title function_">c</span><span class="params">(read_x_then_y)</span>;</span><br><span class="line">    <span class="built_in">std</span>::thread <span class="title function_">d</span><span class="params">(read_y_then_x)</span>;</span><br><span class="line">    a.join(); b.join(); c.join(); d.join();</span><br><span class="line">    assert(z.load() != <span class="number">0</span>); <span class="comment">// will never happen</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä¾‹å­ä¿®æ”¹è‡ª <a href="https://en.cppreference.com/w/cpp/atomic/memory_order">cppreference.com/atomic/memory_order Sequentially-consistent ordering</a> éƒ¨åˆ†ã€‚ç†è®ºä¸Šè¿™ä¸ªä¾‹å­åº”è¯¥èƒ½å¤Ÿè¯´æ˜ memory_order_acq_rel ä¸ memory_order_seq_cst çš„åŒºåˆ«ï¼Œå½“æŠŠåŸä¾‹ä¸­çš„ seq_cst æ¢æˆ acq_relï¼Œåº”è¯¥æ˜¯æœ‰å¯èƒ½è§¦å‘ <code>z.load() == 0</code>çš„æƒ…å†µçš„(è‡³å°‘åœ¨ aarch64 ä¸Šï¼Œå› ä¸ºx86çš„å­˜å‚¨å™¨æ¨¡å‹æœ¬èº«å°±æ˜¯æŒ‰åºä¸€è‡´æ€§æ¨¡å‹)ã€‚ä½†å®é™…ä¸Šå´æ²¡æœ‰è§¦å‘ï¼Œå…¶åŸå› åœ¨ <a href="https://stackoverflow.com/questions/67397460/does-stlrb-provide-sequential-consistency-on-arm64">stackoverflow ä¸Šæœ‰è§£é‡Š</a>ã€‚ é€šè¿‡åœ¨ <a href="https://godbolt.org/z/8KbxMEY6s">godbolt.org</a> ä¸ŠæŸ¥çœ‹è¿™ä¸ªç¨‹åºçš„æ±‡ç¼–ä»£ç ï¼Œç¡®å® <code>y.load(std::memory_order_acq_rel)</code>å’Œ<code>y.store(true, std::memory_order_acq_rel)</code>æ˜¯è¢«åˆ†åˆ«ç¿»è¯‘æˆäº† <code>ldarb</code> å’Œ <code>stlrb</code>ã€‚</p>
</li>
<li>
<p><code>memory_order_seq_cst</code></p>
<ul>
<li>æä¾›æœ€ä¸¥æ ¼çš„å…¨å±€è¯»å†™é¡ºåºä¸€è‡´æ€§ä¿è¯ï¼Œä¸Šé¢çš„ä¾‹å­å°±åªèƒ½ä½¿ç”¨ memory_order_seq_cst</li>
<li>å¯¹äºä½¿ç”¨memory_order_seq_cst çš„ <code>atomic&lt;T&gt;::store()</code> æŒ‡ä»¤æ¥è¯´ï¼Œå®ƒå¼ºåˆ¶flush æ¯ä¸ªCPUæ ¸å¿ƒçš„store buffer, æ‰€ä»¥è¿™ä¸ªstore æ“ä½œåé¢çš„ load (è¯»æ“ä½œ)å°†è¢«å»¶è¿Ÿç›´åˆ°store æ“ä½œå®Œæˆæ‰€æœ‰ store buffer çš„åˆ·æ–°(å³å¯¹å…¨å±€å¯è§)ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>std::atomic&lt;T&gt;::load(std::memory_order order = std::memory_order_seq_cst)</code></p>
</li>
<li>
<p><a href="https://en.cppreference.com/w/cpp/atomic/atomic/compare_exchange"><code>std::atomic&lt;T&gt;::compare_exchange_*()</code></a></p>
<p>C++ std::atomic<T> çš„ cas æœ‰8ä¸ªä¸åŒçš„å£°æ˜ï¼Œä¸»è¦åŒºåˆ†åœ¨ weak/strong, å‚æ•°å’Œæ˜¯å¦æœ‰ volatile. è€Œboost::lockfree::queue é‡Œä½¿ç”¨çš„æ˜¯ä¸‹é¢ä¸¤ä¸ªç‰ˆæœ¬:</p>
<ul>
<li>
<p><code>std::atomic&lt;T&gt;::compare_exchange_strong(T&amp; expected, T desired, std::memory_order    order = std::memory_order_seq_cst)</code></p>
</li>
<li>
<p><code>std::atomic&lt;T&gt;::compare_exchange_weak(T&amp; expected, T desired, std::memory_order order = std::memory_order_seq_cst)</code></p>
</li>
<li>
<p>ä¸ºä»€ä¹ˆ <code>expected</code> å‚æ•°æ˜¯ä¸€ä¸ªå¼•ç”¨ç±»å‹ï¼Œè€Œ<code>desired</code>å‚æ•°æ˜¯ä¸€ä¸ªå€¼ä¼ é€’ï¼Ÿ</p>
</li>
</ul>
</li>
</ul>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://www.cs.rochester.edu/u/scott/papers/1996_PODC_queues.pdf">Simple, Fast, and Practical Non-Blocking and Blocking Concurrent Queue Algorithms</a></li>
<li><a href="https://github.com/boostorg/lockfree/blob/develop/include/boost/lockfree/detail/tagged_ptr_dcas.hpp#L120">boost::lockfree::queue</a></li>
<li><a href="https://github.com/fangcun010/inline_asm_lockfree_queue">inline_asm_lockfree_queue</a></li>
<li><a href="https://blog.lse.epita.fr//2013/02/27/implementing-generic-double-word-compare-and-swap.html">Implementing generic double-word compare and swap for x86/64</a></li>
<li><a href="https://www.openeuler.org/zh/blog/wangshuo/Linux_Futex_Principle_Analysis/Linux_Futex_Principle_Analysis.html">linux - futex åŸç†åˆ†æ</a></li>
<li><a href="https://coffeebeforearch.github.io/2020/08/04/atomic-vs-mutex.html">Mutex vs Atomic</a></li>
</ul>
]]></content>
      <categories>
        <category>programming</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
      </tags>
  </entry>
  <entry>
    <title>LEA: Load Effective Address</title>
    <url>/prog/null-deref/</url>
    <content><![CDATA[<h1 id="segfault"><a class="markdownIt-Anchor" href="#segfault"></a> Segfault ?</h1>
<p>ä¸‹é¢çš„ç¨‹åºä¼šæ®µé”™è¯¯å—ï¼Ÿ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> a;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">f</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%016lx\n&quot;</span>, &amp;f-&gt;a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h1 id="segfault-2"><a class="markdownIt-Anchor" href="#segfault-2"></a> Segfault</h1>
<p>æ®µé”™è¯¯æ˜¯æŒ‡ç¨‹åºè¯•å›¾<strong>è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨æˆ–æ²¡æœ‰æƒé™è®¿é—®çš„å†…å­˜ä½ç½®</strong>æ—¶æ“ä½œç³»ç»Ÿå‘å‡ºçš„ä¿¡å·ï¼Œä¸€èˆ¬éƒ½ä¼šä½¿ç¨‹åºä¸­æ­¢ã€‚å¦‚æœä¸Šé¢çš„ç¨‹åºçš„ printf æ”¹ä¸º</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;0x%016lx\n&quot;</span>, f-&gt;a);</span><br></pre></td></tr></table></figure>
<p>åˆ™ä¸€å®šæ®µé”™è¯¯ï¼Œçœ‹çœ‹ CPU æ‰§è¡Œçš„æŒ‡ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0000000000001149 &lt;main&gt;:</span><br><span class="line">    1149:       f3 0f 1e fa             endbr64</span><br><span class="line">    114d:       55                      push   %rbp</span><br><span class="line">    114e:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">    1151:       48 83 ec 20             sub    $0x20,%rsp</span><br><span class="line">    1155:       89 7d ec                mov    %edi,-0x14(%rbp)</span><br><span class="line">    1158:       48 89 75 e0             mov    %rsi,-0x20(%rbp)</span><br><span class="line">    115c:       48 c7 45 f8 00 00 00    movq   $0x0,-0x8(%rbp)</span><br><span class="line">    1163:       00</span><br><span class="line">    1164:       48 8b 45 f8             mov    -0x8(%rbp),%rax</span><br><span class="line">    1168:       48 8b 00                mov    (%rax),%rax</span><br><span class="line">    116b:       48 89 c6                mov    %rax,%rsi</span><br><span class="line">    116e:       48 8d 05 8f 0e 00 00    lea    0xe8f(%rip),%rax        # 2004 &lt;_IO_stdin_used+0x4&gt;</span><br><span class="line">    1175:       48 89 c7                mov    %rax,%rdi</span><br><span class="line">    1178:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">    117d:       e8 ce fe ff ff          call   1050 &lt;printf@plt&gt;</span><br><span class="line">    1182:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">    1187:       c9                      leave</span><br><span class="line">    1188:       c3                      ret</span><br></pre></td></tr></table></figure>
<p>è§¦å‘æ®µé”™è¯¯çš„æ˜¯ç¬¬ 11 è¡Œçš„ <code>mov (%rax),%rax</code>, å› ä¸º <code>rax</code> å¯„å­˜å™¨çš„å€¼æ˜¯ 0ï¼Œ è¿™æ¡ MOV æŒ‡ä»¤é‡Œçš„ <code>(%rax)</code> å®é™…ä¸Šå°±æ˜¯å»å†…å­˜åœ°å€ 0 å–æ•°æ®ã€‚å†çœ‹çœ‹ä¸Šé¢ä¸ä¼šæ®µé”™è¯¯çš„ç¨‹åºçš„æŒ‡ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0000000000001149 &lt;main&gt;:</span><br><span class="line">    1149:       f3 0f 1e fa             endbr64</span><br><span class="line">    114d:       55                      push   %rbp</span><br><span class="line">    114e:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">    1151:       48 83 ec 20             sub    $0x20,%rsp</span><br><span class="line">    1155:       89 7d ec                mov    %edi,-0x14(%rbp)</span><br><span class="line">    1158:       48 89 75 e0             mov    %rsi,-0x20(%rbp)</span><br><span class="line">    115c:       48 c7 45 f8 00 00 00    movq   $0x0,-0x8(%rbp)</span><br><span class="line">    1163:       00</span><br><span class="line">    1164:       48 8b 45 f8             mov    -0x8(%rbp),%rax</span><br><span class="line">    1168:       48 89 c6                mov    %rax,%rsi</span><br><span class="line">    116b:       48 8d 05 92 0e 00 00    lea    0xe92(%rip),%rax        # 2004 &lt;_IO_stdin_used+0x4&gt;</span><br><span class="line">    1172:       48 89 c7                mov    %rax,%rdi</span><br><span class="line">    1175:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">    117a:       e8 d1 fe ff ff          call   1050 &lt;printf@plt&gt;</span><br><span class="line">    117f:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">    1184:       c9                      leave</span><br><span class="line">    1185:       c3                      ret</span><br></pre></td></tr></table></figure>
<p>åŸæ¥çš„ç¬¬ 11 è¡Œ <code>mov (%rax),%rax</code> å˜æˆäº†</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1168:       48 89 c6                mov    %rax,%rsi</span><br><span class="line">116b:       48 8d 05 92 0e 00 00    lea    0xe92(%rip),%rax        # 2004 &lt;_IO_stdin_used+0x4&gt;</span><br></pre></td></tr></table></figure>
<p>å®ƒå¹¶æ²¡æœ‰ç›´æ¥å»å†…å­˜åœ°å€ 0 å»å–æ•°æ®ï¼Œè€Œæ˜¯å°†æŒ‡ä»¤å¯„å­˜å™¨ <code>rip</code> çš„å½“å‰å€¼åŠ ä¸Š <code>0xe92</code> åå°†ç»“æœå­˜å…¥ <code>rax</code> å¯„å­˜å™¨ã€‚</p>
<p>æ‰€ä»¥ä¸Šé¢çš„ç¨‹åºæ˜¯ä¸æ˜¯ä¼šæ®µé”™è¯¯ï¼Œå°±è¦çœ‹ CPU æ˜¯ä¸æ˜¯<strong>è®¿é—®</strong>äº† <code>f (NULL)</code> è¿™ä¸ª 0 åœ°å€ã€‚</p>
<h2 id="mov-vs-lea"><a class="markdownIt-Anchor" href="#mov-vs-lea"></a> MOV vs LEA</h2>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://stackoverflow.com/questions/1658294/whats-the-purpose-of-the-lea-instruction">Whatâ€™s the purpose of the LEA instruction?</a></li>
<li><a href="https://eli.thegreenplace.net/2012/01/03/understanding-the-x64-code-models">Understanding the x86 code models</a></li>
</ul>
]]></content>
      <categories>
        <category>programming</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello, Rust</title>
    <url>/prog/rust/</url>
    <content><![CDATA[
<span id="more"></span>
<h1 id="hello-world"><a class="markdownIt-Anchor" href="#hello-world"></a> Hello world</h1>
<p>å®‰è£… rust çš„æ–¹å¼æœ‰å¥½å‡ ç§ï¼Œä½†æœ€æ–¹ä¾¿çš„åº”è¯¥æ˜¯é€šè¿‡ <strong>rustup</strong> è„šæœ¬ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl --proto &#x27;=https&#x27; --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br></pre></td></tr></table></figure>
<p>rustup é»˜è®¤å®‰è£…æœ€æ–°çš„ stable å·¥å…·é“¾åˆ° <code>$HOME/.cargo</code> ç›®å½•ä¸‹ï¼Œå®‰è£…çš„ç»„ä»¶åŒ…æ‹¬</p>
<ul>
<li>Rust æ„å»ºç³»ç»Ÿå’ŒåŒ…ç®¡ç†å™¨ <code>cargo</code></li>
<li>Rust é™æ€ä»£ç åˆ†æå·¥å…· <code>clippy</code></li>
<li>Rust ç¦»çº¿æ–‡æ¡£ <strong>rust-docs</strong></li>
<li>Rust æ ‡å‡†åº“ <strong>rust-std</strong></li>
<li>Rust ç¼–è¯‘å™¨ <code>rustc</code></li>
<li>Rust ä»£ç æ ¼å¼å·¥å…· <code>rustfmt</code></li>
</ul>
<p>è¿™äº›ç»„ä»¶å®‰è£…åï¼Œ Rust ç¯å¢ƒåŸºæœ¬ä¸Šå°± OK äº†ï¼Œå¯ä»¥å†™ä¸€ä¸ª hello world æµ‹è¯•ä¸€ä¸‹</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello, world!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>rustc</code> æ¥ç¼–è¯‘å®ƒï¼Œå°±åƒä½¿ç”¨ gcc é‚£æ ·</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rustc main.rs -o main</span><br></pre></td></tr></table></figure>
<h1 id="rustup"><a class="markdownIt-Anchor" href="#rustup"></a> rustup</h1>
<p>rustup æ˜¯ä¸€ä¸ª rust å·¥å…·é“¾ç®¡ç†å·¥å…·ï¼Œå¯ä»¥è½»æ¾åœ¨ä¸€ä¸ªæœºå™¨ä¸Šéƒ¨ç½²å¤šä¸ªç‰ˆæœ¬çš„ rust å·¥å…·é“¾ï¼Œå¹¶åœ¨å®ƒä»¬ä¹‹é—´è½»æ¾åˆ‡æ¢ã€‚ä¾‹å¦‚å®‰è£… stable, nightly, 1.82.0</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rustup install stable</span><br><span class="line">rustup install nightly</span><br><span class="line">rustup install 1.82.0</span><br></pre></td></tr></table></figure>
<ul>
<li>æŸ¥çœ‹å½“å‰å·¥å…·é“¾ç‰ˆæœ¬
<ul>
<li><code>rustup default</code></li>
</ul>
</li>
<li>è®¾ç½®å½“å‰å·¥å…·é“¾ä¸º 1.82.0
<ul>
<li><code>rustup default 1.82.0</code></li>
</ul>
</li>
<li>å¦‚æœå­˜åœ¨å¤šä¸ªç‰ˆæœ¬çš„å·¥å…·é“¾ï¼Œä¸º cargo æŒ‡å®šç‰¹å®šå·¥å…·é“¾
<ul>
<li><code>cargo +1.82.0 install --path /some/rust/project/dir</code></li>
</ul>
</li>
</ul>
<p>å½“ç„¶æ¨èçš„æ–¹æ³•æ˜¯ä½¿ç”¨ <code>cargo</code>, å°±åƒç¼–è¯‘ C æ—¶å¤§å¤šç”¨ <code>make</code> ä¸€æ ·ã€‚ <code>cargo</code> æ˜¯ rust çš„åŒ…ç®¡ç†å·¥å…·ï¼Œå¸®åŠ©ç®¡ç†é¡¹ç›®ä¸­åŒ…çš„ä¾èµ–åŠåº”ç”¨çš„æ„å»ºï¼Œåˆ›å»ºä¸€ä¸ª Rust é¡¹ç›®ï¼Œé€šå¸¸ç¬¬ä¸€æ­¥æ˜¯æ‰§è¡Œ <code>cargo init</code>, å®ƒè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª <strong>Rust binary (application) package</strong>, è¿™æ ·çš„åŒ…é‡Œä¼šåŒ…å«ä¸€ä¸ª <strong>Cargo.toml</strong> æ–‡ä»¶(è‡ªåŠ¨ç”Ÿæˆ)ï¼Œ åé¢ <code>cargo build</code> å°±æ˜¯æ ¹æ®è¿™ä¸ªæ–‡ä»¶å†…å®¹æ¥ç¼–è¯‘ Rust é¡¹ç›®ã€‚(å¦‚æœè¦æ¸…ç†æ„å»ºçš„ç»“æœï¼Œä½¿ç”¨ <code>cargo clean</code>)</p>
<h1 id="cargo"><a class="markdownIt-Anchor" href="#cargo"></a> <a href="https://doc.rust-lang.org/cargo/index.html">cargo</a></h1>
<p>Rust çš„åŒ…å« <strong>crate</strong>, <strong>cargo</strong> æ—¢æ˜¯åŒ…ç®¡ç†å™¨ï¼Œä¹Ÿæ˜¯ Rust é¡¹ç›®çš„æ„å»ºç³»ç»Ÿã€‚</p>
<h2 id="æ„å»º"><a class="markdownIt-Anchor" href="#æ„å»º"></a> æ„å»º</h2>
<p>å¸¸ç”¨çš„ cargo æ„å»ºå‘½ä»¤, æ¯ä¸ªå‘½ä»¤å¯èƒ½æ”¯æŒè‹¥å¹²é€‰é¡¹ï¼Œå¦‚ <code>cargo build --bin hello_world</code>, å½“ä¸€ä¸ª crate ä¸‹å­˜åœ¨å¤šä¸ªç›®æ ‡æ—¶ï¼Œ <code>--bin</code> æŒ‡å®šæ„å»ºæŸä¸ªç›®æ ‡</p>
<ul>
<li><code>cargo new</code></li>
<li><code>cargo init</code></li>
<li><code>cargo build</code></li>
<li><code>cargo clean</code></li>
<li><code>cargo modules structure --package XXX</code>
<ul>
<li>æ˜¾ç¤ºæŸä¸ª crate çš„æ¡†æ¶ (å¦‚æœ‰å“ªäº›å‡½æ•°, ç±»ç­‰)</li>
</ul>
</li>
<li><code>cargo doc</code>
<ul>
<li><code>cargo doc --open --manifest-path=/path/to/Cargo.toml</code>
<ul>
<li>ç”ŸæˆæŒ‡å®š crate (ä»¥åŠä¾èµ–) çš„æ–‡æ¡£ï¼Œå¹¶å¯åŠ¨æµè§ˆå™¨æ‰“å¼€<br />
<img src="/images/rust/rustlings-doc.png" alt="cargo doc --open" /></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="rust-hello-world"><a class="markdownIt-Anchor" href="#rust-hello-world"></a> Rust Hello World</h1>
<p>Rust ç›¸å¯¹äº C æ˜¯å¤æ‚çš„ï¼Œé‚£æˆ‘ä»¬ä¹Ÿæ¥ä¸€ä¸ª Non-trivial ç‰ˆæœ¬çš„ Hello worldã€‚è¿™ä¸ª Hello World ä¸ä½¿ç”¨æ ‡å‡†åº“ï¼Œè€Œæ˜¯é€šè¿‡<strong>æ±‡ç¼–æŒ‡ä»¤(x86)</strong> ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨ (write), æ¥å°†&quot;Hello world&quot;,é€åˆ°æ ‡å‡†è¾“å‡ºã€‚</p>
<p>Rust çš„æ ‡å‡†åº“ä¾èµ– C åº“ libc.so.6ã€‚ä½† Rust è¯­è¨€å…è®¸ä½ ç¦ç”¨æ ‡å‡†åº“ï¼Œä»è€Œä¸ä¾èµ– C åº“ã€‚è¦è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œéœ€è¦å¯¹ Hello world ç¨‹åºå’Œç¼–è¯‘è¿‡ç¨‹åšäº›<a href="https://github.com/lucmann/pmp/tree/master/rust">ä¿®æ”¹</a></p>
<ul>
<li><code>#![no_std]</code> æ˜ç¡®å‘Šè¯‰ rustc ä¸è¦ç”¨æ ‡å‡†åº“ï¼Œ é‚£å°±æ„å‘³ç€ä¸èƒ½è°ƒç”¨ <code>println!</code> å®åœ¨æ ‡å‡†è¾“å‡ºä¸Šæ‰“å°å­—ç¬¦, å¯ä»¥é€šè¿‡å†…è”æ±‡ç¼–è°ƒç”¨ <code>write</code> ç³»ç»Ÿè°ƒç”¨ç›´æ¥å°†å­—ç¬¦é€åˆ°æ ‡å‡†è¾“å‡ºã€‚ä¸è¦ rust æ ‡å‡†åº“ï¼Œä¹Ÿå°±ä¸è¦ C æ ‡å‡†åº“ï¼Œé‚£ä¹Ÿå°±è°ƒç”¨ä¸äº† crt1.o é‡Œçš„ <code>_start</code> å‡½æ•°ï¼Œ æ‰€ä»¥è¿™ä¹Ÿæ„å‘³ç€è¦è‡ªå·±å®ç° <code>_start</code></li>
<li><code>#![no_main]</code> ä¸è¦ main å‡½æ•°ï¼Œå› ä¸ºç¨‹åºçœŸæ­£çš„å…¥å£ç‚¹æ˜¯ <code>_start</code> å‡½æ•°ï¼Œ æ—¢ç„¶æˆ‘ä»¬ç›´æ¥å®ç° <code>_start()</code>, é‚£ä¹Ÿå°±æ²¡å¿…è¦æä¾› <code>main</code> è¿™ä¸ªå…¥å£äº†ã€‚</li>
<li>è¦æä¾›ä¸€ä¸ª <code>panic_handler</code>, ä¸”éœ€è¦å°† <code>panic</code> çš„è§¦å‘äº‹ä»¶æ”¹ä¸º <code>abort</code> (é»˜è®¤ <code>panic=unwind</code>)</li>
</ul>
<p><code>cargo build</code> æ—¶å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ <code>RUSTFLAGS</code> å‘Šè¯‰ç¼–è¯‘å™¨å’Œé™æ€é“¾æ¥å™¨ä»¥ä¸Šè¿™äº›ä¿¡æ¯</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">RUSTFLAGS=&quot;-Clink-arg=-nostartfiles -Cpanic=abort&quot; cargo build --bin hello_nostd</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="meta">#![no_std]</span></span><br><span class="line"><span class="meta">#![no_main]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> core::panic::PanicInfo;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[panic_handler]</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">panic</span>(_: &amp;PanicInfo) <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;&#125; <span class="comment">// Loop forever to halt the program</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="meta">#[cfg(target_arch = <span class="string">&quot;x86_64&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">fn</span> <span class="title function_">_start</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">message</span> = <span class="string">b&quot;Hello, world!\n&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">fd</span>: <span class="type">usize</span> = <span class="number">1</span>; <span class="comment">// File descriptor for stdout</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">syscall_no</span>: <span class="type">usize</span> = <span class="number">1</span>; <span class="comment">// Syscall number for write in Linux x86_64</span></span><br><span class="line">    <span class="comment">// Use inline asm macro to perform the syscall</span></span><br><span class="line">    core::arch::asm!(</span><br><span class="line">        <span class="string">&quot;syscall&quot;</span>,</span><br><span class="line">        <span class="title function_ invoke__">in</span>(<span class="string">&quot;rax&quot;</span>) syscall_no, <span class="comment">// syscall number</span></span><br><span class="line">        <span class="title function_ invoke__">in</span>(<span class="string">&quot;rdi&quot;</span>) fd,         <span class="comment">// file descriptor</span></span><br><span class="line">        <span class="title function_ invoke__">in</span>(<span class="string">&quot;rsi&quot;</span>) message.<span class="title function_ invoke__">as_ptr</span>(), <span class="comment">// pointer to the message</span></span><br><span class="line">        <span class="title function_ invoke__">in</span>(<span class="string">&quot;rdx&quot;</span>) message.<span class="title function_ invoke__">len</span>(), <span class="comment">// length of the message</span></span><br><span class="line">        <span class="title function_ invoke__">out</span>(<span class="string">&quot;rcx&quot;</span>) _, <span class="title function_ invoke__">out</span>(<span class="string">&quot;r11&quot;</span>) _, <span class="comment">// telling compiler these registers will</span></span><br><span class="line">                                    <span class="comment">// be clobbered by syscalls</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Exit the program with status code 0</span></span><br><span class="line">    core::arch::asm!(</span><br><span class="line">        <span class="string">&quot;syscall&quot;</span>,</span><br><span class="line">        <span class="title function_ invoke__">in</span>(<span class="string">&quot;rax&quot;</span>) <span class="number">60</span>, <span class="comment">// syscall number for exit</span></span><br><span class="line">        <span class="title function_ invoke__">in</span>(<span class="string">&quot;rdi&quot;</span>) <span class="number">0</span>,  <span class="comment">// exit status code</span></span><br><span class="line">        <span class="title function_ invoke__">out</span>(<span class="string">&quot;rcx&quot;</span>) _, <span class="title function_ invoke__">out</span>(<span class="string">&quot;r11&quot;</span>) _, <span class="comment">// telling compiler these registers will</span></span><br><span class="line">                                    <span class="comment">// be clobbered by syscalls</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="rust-for-linux"><a class="markdownIt-Anchor" href="#rust-for-linux"></a> Rust for Linux</h1>
<p>Rust æ˜¯ 2022 å¹´ 10 æœˆéš Linux 6.1-rc1 è¿›å…¥å†…æ ¸ä¸»çº¿çš„ã€‚Linux å†…æ ¸ä»æ­¤å°±å˜æˆäº†ä¸€ä¸ªåŒè¯­è¨€é¡¹ç›®ï¼Œé¦–å…ˆè¦è§£å†³çš„é—®é¢˜ä¹‹ä¸€å°±æ˜¯ C å’Œ Rust å‡½æ•°äº’ç›¸è°ƒç”¨çš„é—®é¢˜ï¼Œè¿™å°±éœ€è¦ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆ <strong>Rust FFI bindings to C</strong> çš„å·¥å…· <a href="https://github.com/rust-lang/rust-bindgen">bindgen</a>, æ‰€ä»¥ bindgen ä¹Ÿæ˜¯æ„å»ºå†…æ ¸ä¸­ Rust ä»£ç çš„ä¾èµ–ä¹‹ä¸€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo pacman -S rust-bindgen</span><br></pre></td></tr></table></figure>
<p>å†…æ ¸æœ‰ä¸ªç‰¹æ®Šä¹‹å¤„å°±æ˜¯å®ƒä¸èƒ½é“¾æ¥ C æ ‡å‡†åº“ï¼Œæ‰€ä»¥å®ƒè‡ªç„¶ä¹Ÿä¸èƒ½é“¾æ¥ Rust æ ‡å‡†åº“ï¼Œæ‰€ä»¥ç¼–è¯‘å¼€å¯ Rust (<code>CONFIG_RUST</code>) å†…æ ¸éœ€è¦å®‰è£… Rust æ ‡å‡†åº“çš„æºç ï¼Œè¿™æ­¥å¯ä»¥é€šè¿‡ rustup å®Œæˆ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rustup component add rust-src</span><br></pre></td></tr></table></figure>
<p>è¿™äº›å®Œæˆåï¼Œåœ¨å†…æ ¸æºç æ ‘æ ¹ç›®å½•ä¸‹è¿è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">make rustavailable</span><br></pre></td></tr></table></figure>
<p>æ£€æŸ¥ç¼–è¯‘å†…æ ¸çš„ Rust ç¯å¢ƒæ˜¯å¦å·²ç»å‡†å¤‡ OK.</p>
<p>å†…æ ¸ Rust æ„å»ºç³»ç»Ÿæä¾›å¯¹ VSCode <strong>rust-analyzer</strong> æ’ä»¶çš„æ”¯æŒ(å› ä¸º Rust for Linux ä¸ç”¨ Cargo, æ‰€ä»¥é»˜è®¤æƒ…å†µä¸‹ rust-analyzer server æ˜¯æ— æ³•æ­£å¸¸å·¥ä½œçš„), è¿è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">make rust-analyzer</span><br></pre></td></tr></table></figure>
<p>ä¼šç”Ÿæˆ <strong>rust-project.json</strong>, æœ‰äº†è¿™ä¸ªæ–‡ä»¶ï¼Œrust-ananlyzer æ’ä»¶å¯ä»¥è¿è¡Œã€‚ä½†æ˜¯æ³¨æ„ <code>rust-analyzer</code> ç›®æ ‡å¿…é¡»åœ¨å†…æ ¸é…ç½®è¿‡ä¹‹åæ‰èƒ½ make</p>
<p>ç¼–è¯‘å†…æ ¸ç¬¬ä¸€æ­¥ï¼Œæ˜¯å¾—åˆ° <code>.config</code> é…ç½®æ–‡ä»¶, é…ç½®é¡¹ <code>Rust support</code> çš„ä½ç½®åœ¨ <code>General setup</code> -&gt; <code>Rust support</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>
<h1 id="learn-rust-from-rust-for-linux"><a class="markdownIt-Anchor" href="#learn-rust-from-rust-for-linux"></a> Learn Rust from Rust for Linux</h1>
<p>å°±åƒä¹‹å‰çš„ <a href="https://lucmann.github.io/utils/make/">Learn Makefile from Linux Build System</a> ä¸€æ ·ï¼Œè¿™æ¬¡æˆ‘æƒ³ä¸€è¾¹é˜…è¯» Linux å†…æ ¸ä¸­çš„ Rust é©±åŠ¨ä»£ç ï¼Œä¸€è¾¹å­¦ä¹  Rust è¯­è¨€ï¼Œå¥½å¤„æ˜¯å¯ä»¥äº†è§£ä¸€ä¸ªå®é™…çš„é¡¹ç›®ä¸­ï¼Œåƒ Rust è¿™æ ·çš„è¯­è¨€çš„æœ€ä½³å®è·µæ˜¯æ€æ ·çš„ï¼Œè¿™é‡Œå°±å½“æ˜¯å­¦ä¹ ç¬”è®°å§</p>
<h1 id="nightly-vs-stable-rustc"><a class="markdownIt-Anchor" href="#nightly-vs-stable-rustc"></a> Nightly vs. Stable rustc</h1>
<p>Nightly rustc æ¯æ—¥è‡ªåŠ¨æ„å»ºï¼ŒåŒ…å«äº†æ‰€æœ‰æœ€æ–°çš„è¯­è¨€åŠŸèƒ½å’Œæ ‡å‡†åº“åŠŸèƒ½ï¼Œæ‰€ä»¥ç¨³å®šæ€§ä¹Ÿä½ï¼Œæœ‰å¯èƒ½æœ‰Bugã€‚Rust for Linux çš„å®˜æ–¹æ–‡æ¡£è™½ç„¶æ²¡æœ‰æ˜ç¡®è¯´æ„å»ºå†…æ ¸ Rust ä½¿ç”¨ Stable ç¼–è¯‘å™¨è¿˜æ˜¯ Nightly ç¼–è¯‘å™¨ï¼Œä½†æœ€å¥½ä½¿ç”¨ Stable, åŸå› æ˜¯ Nightly æ¯å¤©å¯èƒ½éƒ½æœ‰æ›´æ–°ï¼ŒRust for Linux ä¹Ÿæ¯å¤©éƒ½åœ¨æ›´æ–°ï¼Œå¦‚æœä½¿ç”¨ Nightly ç‰ˆæœ¬çš„ç¼–è¯‘å™¨ï¼Œå°±éœ€è¦äºŒè€…åŒæ—¶éƒ½æ˜¯æœ€æ–°ï¼Œå¦åˆ™å¯èƒ½å‡ºç°åƒä¸‹é¢çš„æƒ…å†µï¼Œç¼–è¯‘å™¨çš„ç‰ˆæœ¬å·å·²ç»æ˜¯ <code>1.91.0</code> äº†ï¼Œä½†ç›¸åº”çš„åŠŸèƒ½è¿˜æ²¡æ›´æ–°ä¸Š(å¯¹äº Nightly ç‰ˆæœ¬æ¥è¯´ï¼Œæ‰€æœ‰çš„æ–°åŠŸèƒ½ä¸æ˜¯åœ¨ä¸€å¤©å†…æ›´æ–°è¿›å»çš„)</p>
<figure class="highlight rust"><figcaption><span>$srctree/scripts/generate_rust_target.rs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> cfg.<span class="title function_ invoke__">rustc_version_atleast</span>(<span class="number">1</span>, <span class="number">91</span>, <span class="number">0</span>) &#123;</span><br><span class="line">    ts.<span class="title function_ invoke__">push</span>(<span class="string">&quot;target-pointer-width&quot;</span>, <span class="number">64</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ts.<span class="title function_ invoke__">push</span>(<span class="string">&quot;target-pointer-width&quot;</span>, <span class="string">&quot;64&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>rustup install nightly</code>
<ul>
<li><code>nightly-x86_64-unknown-linux-gnu installed - rustc 1.91.0-nightly (1ebbd87a6 2025-08-11)</code></li>
</ul>
</li>
<li><code>rustup update nightly</code>
<ul>
<li>æ›´æ–° nightly ç‰ˆæœ¬çš„ rustc  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">info: syncing channel updates for &#x27;nightly-x86_64-unknown-linux-gnu&#x27;</span><br><span class="line"></span><br><span class="line">    nightly-x86_64-unknown-linux-gnu unchanged - rustc 1.92.0-nightly (c8905eaa6 2025-09-28)</span><br><span class="line"></span><br><span class="line">info: checking for self-update</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><code>rustup default nightly</code>
<ul>
<li><code>nightly-x86_64-unknown-linux-gnu unchanged - rustc 1.91.0-nightly (1ebbd87a6 2025-08-11)</code></li>
<li><code>rustc --version</code></li>
</ul>
</li>
<li><code>rustup component add rust-src</code>
<ul>
<li><code>make rustavailable</code></li>
<li>å®‰è£… rustc nightly ååŒæ ·å¿…é¡»å®‰è£… nightly rust-src,å¦åˆ™ <code>make rustavailable</code> ä¼šå¤±è´¥</li>
</ul>
</li>
<li><code>rustup default nightly</code> or <code>rustup default stable</code>
<ul>
<li>åœ¨ nightly å’Œ stable ä¹‹é—´åˆ‡æ¢</li>
</ul>
</li>
<li><code>rustup override set stable</code>
<ul>
<li>åªæ”¹å˜ current working directory çš„ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼Œä¸å½±å“ç³»ç»Ÿçš„ç¼–è¯‘å™¨ç‰ˆæœ¬é…ç½®</li>
</ul>
</li>
</ul>
<h1 id="macros"><a class="markdownIt-Anchor" href="#macros"></a> Macros</h1>
<p>Rust ä¸­çš„å®è™½è¯´æ˜¯å¼ºå¤§ï¼Œä½†ä¹Ÿéå¸¸å¤æ‚ï¼Œå•çœ‹å®ƒæ–‡æ¡£é‡Œçš„<strong>å£°æ˜å®</strong>çš„è¯­æ³•å®šä¹‰å°±å¤´å¤§äº†ï¼Œæ›´ä¸ç”¨è¯´è¿‡ç¨‹å®äº†ã€‚ä½† Rust çš„å®å¼ºå¤§å°±å¼ºå¤§åœ¨<strong>è¿‡ç¨‹å®</strong>ï¼Œå£°æ˜å®åªæ˜¯å‡å°‘ä»£ç é‡ï¼Œè€Œè¿‡ç¨‹å®èƒ½è®©ç¼–è¯‘å™¨<strong>è‡ªåŠ¨ç”Ÿæˆä»£ç </strong>ã€‚</p>
<ul>
<li><a href="https://doc.rust-lang.org/reference/macros-by-example.html">https://doc.rust-lang.org/reference/macros-by-example.html</a></li>
</ul>
<h2 id="declarative-macros-å£°æ˜å¼å®-macro_rules"><a class="markdownIt-Anchor" href="#declarative-macros-å£°æ˜å¼å®-macro_rules"></a> Declarative Macros å£°æ˜å¼å® <code>macro_rules!</code></h2>
<p>Rust å£°æ˜å¼å®ç»™äººçš„æ„Ÿè§‰å°±å¥½åƒæ˜¯æŠŠç¼–è¯‘å™¨å‰ç«¯çš„<strong>è¯æ³•åˆ†æ(Lexical)</strong>, <strong>è¯­æ³•åˆ†æ(Syntactic)</strong> å¼€æ”¾ç»™äº†ç”¨æˆ·ï¼Œç”¨æˆ·æ ¹æ®è¿™å¥—è¯­æ³•åˆ†æé€»è¾‘è‡ªå·±å®šä¹‰ä»£ç ã€‚å®šä¹‰ä¸€ä¸ªå£°æ˜å¼å®çš„ä¸€èˆ¬è¯­æ³•æ˜¯</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="built_in">macro_rules!</span> MACRO_NAME &#123;</span><br><span class="line">    ( PATTERN ) =&gt; &#123;</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å£°æ˜å¼å®æœ‰ç‚¹åƒ<strong>æ¨¡å¼åŒ¹é…</strong>(è‡³å°‘å®ƒä»¬éƒ½ç”¨åˆ° <code>=&gt;</code>ğŸ¶), è°ƒç”¨å®æ—¶ä¼ å…¥çš„<strong>é‚£æ®µå­—ä¸²</strong>ä¼šä¸ <strong>PATTERN</strong> çš„ç»“æ„åŒ¹é…ï¼Œä¸€æ—¦åŒ¹é…å°±ä¼šæŒ‰<strong>å±•å¼€è§„åˆ™</strong>è¿›è¡Œå±•å¼€ï¼Œè¿™é‡Œçš„<strong>å±•å¼€è§„åˆ™</strong>æœ¬èº«çš„å†™æ³•å¾ˆå¤æ‚ï¼Œä½†ä¹Ÿå¾ˆå¼ºå¤§ã€‚</p>
<p>å†…æ ¸ä¸­çš„ <code>dev_dbg</code> å°±æ˜¯ä¸€ä¸ªå£°æ˜å¼å®ï¼Œå®é™…ä¸Š <code>crate::dev_printk</code> è¿˜æ˜¯ä¸€ä¸ªå£°æ˜å¼å®</p>
<ul>
<li>dev_dbg å®å®šä¹‰</li>
</ul>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> dev_dbg &#123;</span><br><span class="line">    ($($f:tt)*) =&gt; &#123; $crate::dev_printk!(pr_dbg, $($f)*); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>dev_printk å®å®šä¹‰</li>
</ul>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="meta">#[doc(hidden)]</span></span><br><span class="line"><span class="meta">#[macro_export]</span></span><br><span class="line"><span class="built_in">macro_rules!</span> dev_printk &#123;</span><br><span class="line">    ($method:ident, $dev:expr, $($f:tt)*) =&gt; &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            ($dev).$<span class="title function_ invoke__">method</span>(::core::<span class="built_in">format_args!</span>($($f)*));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>dev_dbg å®ä½¿ç”¨</li>
</ul>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">dev_dbg!(dev, <span class="string">&quot;GPU instance built\n&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢3æ®µä»£ç çœ‹ï¼ŒRust å£°æ˜å®ä¸ C å®æœ¬è´¨ä¸Šå·®ä¸å¤šï¼Œå½¢å¼ä¸Šå·®å¾—å¤šã€‚ä» <code>dev_dbg</code> çš„å®šä¹‰çœ‹ï¼Œè¿™ä¸ªå®çš„å‚æ•°æ˜¯ä¸€ä¸ª <strong>TokenTree (tt)</strong>, è¿™ä¸ªå‚æ•°çš„åå­—å°±æ˜¯ <code>$f</code>, å®ƒçš„å±•å¼€å°±æ˜¯ä»¥ <code>pr_dbg</code> è¿™ä¸ª<strong>Identifier (ident)</strong> ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°è°ƒç”¨ <code>dev_printk</code> å®ï¼Œå…¶å®ƒå‚æ•°é€ä¼ è¿‡å»ã€‚</p>
<p>è€Œ <code>dev_printk</code> å®æœ‰3ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>ç¬¬1ä¸ªæ˜¯ä¸€ä¸ª <strong>Identifier</strong>, å‚æ•°åæ˜¯ <code>$method</code></li>
<li>ç¬¬2ä¸ªæ˜¯ä¸€ä¸ª <strong>Expression</strong>, å‚æ•°åæ˜¯ <code>$dev</code></li>
<li>ç¬¬3ä¸ªæ˜¯ä¸€ä¸ª <strong>TokenTree</strong>,  å‚æ•°åæ˜¯ <code>$f</code></li>
</ul>
<p><code>dev_dbg!(dev, &quot;GPU instance built\n&quot;)</code> æœ€ç»ˆå±•å¼€åå°±æ˜¯ <code>dev.pr_dbg(::core::format_args!(&quot;GPU instance built\n&quot;))</code></p>
<h2 id="procedural-macros-è¿‡ç¨‹å®-rust-code-that-generates-rust-code"><a class="markdownIt-Anchor" href="#procedural-macros-è¿‡ç¨‹å®-rust-code-that-generates-rust-code"></a> Procedural Macros è¿‡ç¨‹å® Rust code that generates rust code</h2>
<ul>
<li>Function-like macros</li>
<li>derive macros</li>
<li>attribute macros</li>
</ul>
<h3 id="function-like-macros"><a class="markdownIt-Anchor" href="#function-like-macros"></a> Function-like macros</h3>
<p>å‡½æ•°å¼è¿‡ç¨‹å®çš„ä¸€èˆ¬è¯­æ³•æ˜¯</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mod</span> foo;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[proc_macro_derive(Name)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">foo_bar</span>(input: TokenStream) <span class="punctuation">-&gt;</span> TokenStream &#123;</span><br><span class="line">    foo::<span class="title function_ invoke__">foo_bar</span>(input.<span class="title function_ invoke__">into</span>())).<span class="title function_ invoke__">into</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…·ä½“çš„å®çš„å®ç°(å¦‚ä½•æŠŠinput TokenStream å˜æˆç»“æœ TokenStream) ä¸€èˆ¬åœ¨ä¸€ä¸ªå•ç‹¬çš„ rust mod é‡Œã€‚</p>
<h3 id="derive-macros-derivedebug"><a class="markdownIt-Anchor" href="#derive-macros-derivedebug"></a> derive macros <code>#[derive(Debug)]</code></h3>
<h3 id="attribute-macros-bitfield"><a class="markdownIt-Anchor" href="#attribute-macros-bitfield"></a> attribute macros <code>#[bitfield]</code></h3>
<ul>
<li>Outer attribute
<ul>
<li><code>#[...]</code>
<ul>
<li>ä»…ä¿®é¥°ç´§è·Ÿç€å®ƒçš„é¡¹ (fn, struct, trait)</li>
</ul>
</li>
</ul>
</li>
<li>Inner attribute
<ul>
<li><code>#![...]</code>
<ul>
<li>ä¿®é¥°å®ƒæ‰€åœ¨çš„æ•´ä¸ªé¡¹ (crate, mod)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="traits"><a class="markdownIt-Anchor" href="#traits"></a> Traits</h1>
<h1 id="closures-é—­åŒ…åŒ¿åå‡½æ•°"><a class="markdownIt-Anchor" href="#closures-é—­åŒ…åŒ¿åå‡½æ•°"></a> Closures é—­åŒ…(åŒ¿åå‡½æ•°)</h1>
<p>Rust closure å’Œ C++ çš„ lambda ç±»ä¼¼ï¼Œéƒ½æ˜¯å®ç°<strong>åŒ¿åå‡½æ•°</strong>ï¼Œéƒ½æ˜¯ä¸€ç§è¯­æ³•ç³–ï¼Œä¹Ÿéƒ½æ˜¯<strong>é›¶å¼€é”€æŠ½è±¡</strong>ã€‚Rust closure çš„ä¸€èˆ¬è¯­æ³•æ˜¯</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">a_closure</span> = || &#123; .... &#125;;</span><br><span class="line"><span class="comment">// now you can call it</span></span><br><span class="line"><span class="title function_ invoke__">a_closure</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>å½“å‡½æ•°ä½“åªæœ‰ä¸€ä¸ªè¡¨è¾¾å¼æ—¶ï¼ŒèŠ±æ‹¬å·éƒ½å¯ä»¥çœç•¥</p>
</li>
<li>
<p>Rust closure çš„å˜é‡æ•è·ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºå®ƒæ˜¯ç”±ç¼–è¯‘å™¨éšå¼åœ°è‡ªåŠ¨å®Œæˆçš„(æ ¹æ®ä½ ä½¿ç”¨å˜é‡çš„æ–¹å¼)</p>
</li>
<li>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ closure çš„ä¾‹å­</p>
  <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">_</span>: <span class="type">Result</span> = util::<span class="title function_ invoke__">wait_on</span>(Delta::<span class="title function_ invoke__">from_micros</span>(<span class="number">10</span>), || <span class="literal">None</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><code>util::wait_on()</code> çš„ç¬¬2ä¸ªå‚æ•°çš„ç±»å‹ <code>F</code>, æ˜¯ä¸€ä¸ªå®ç°äº† <code>Fn()</code> trait ä¸”è¿”å›å€¼ç±»å‹æ˜¯ <code>Option&lt;R&gt;</code> çš„ç±»å‹</p>
</li>
<li>
<p>ç¬¬2ä¸ªå®å‚ï¼š <code>|| None</code> (è¿™ä¸ªé—­åŒ…å¤Ÿç®€å•å§) ç¬¦åˆè¿™ä¸ªç±»å‹çš„è¦æ±‚</p>
</li>
<li>
<p><code>Option&lt;T&gt;</code> æ˜¯ä¸ªæ³›å‹æšä¸¾ç±»å‹ï¼Œ<code>None</code> å°±æ˜¯å®ƒçš„ä¸€ä¸ªæšä¸¾å€¼</p>
</li>
<li>
<p><a href="https://elixir.bootlin.com/linux/v6.17-rc6/source/drivers/gpu/nova-core/util.rs#L35"><code>util::wait_on()</code></a>çš„å®ç°å¦‚ä¸‹</p>
  <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">wait_on</span>&lt;R, F: <span class="title function_ invoke__">Fn</span>() <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;R&gt;&gt;(timeout: Delta, cond: F) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;R&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">start_time</span> = Instant::&lt;Monotonic&gt;::<span class="title function_ invoke__">now</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(ret) = <span class="title function_ invoke__">cond</span>() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>(ret);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> start_time.<span class="title function_ invoke__">elapsed</span>().<span class="title function_ invoke__">as_nanos</span>() &gt; timeout.<span class="title function_ invoke__">as_nanos</span>() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(ETIMEDOUT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h1 id="æ¦‚å¿µåŒºåˆ†"><a class="markdownIt-Anchor" href="#æ¦‚å¿µåŒºåˆ†"></a> æ¦‚å¿µåŒºåˆ†</h1>
<h2 id="å¼•ç”¨å’Œå€Ÿç”¨"><a class="markdownIt-Anchor" href="#å¼•ç”¨å’Œå€Ÿç”¨"></a> å¼•ç”¨å’Œå€Ÿç”¨</h2>
<p><a href="https://course.rs/basic/ownership/borrowing.html"><strong>è·å–å˜é‡å¼•ç”¨çš„è¿‡ç¨‹å«å€Ÿç”¨(Borrowing)</strong></a>ã€‚å€Ÿç”¨è¿™ä¸€æ¦‚å¿µæ˜¯ Rust æ‰€æœ‰æƒçš„æ ¸å¿ƒã€‚</p>
<h2 id="string-vs-str-vs-str"><a class="markdownIt-Anchor" href="#string-vs-str-vs-str"></a> <code>String</code> vs <code>str</code> vs <code>&amp;str</code></h2>
<ul>
<li><code>str</code> æ˜¯ rust è¯­è¨€çº§åˆ«çš„å­—ç¬¦ä¸²ç±»å‹ï¼Œ <code>String</code> æ˜¯ rust æ ‡å‡†åº“é‡Œå®ç°çš„ä¼—å¤šå­—ç¬¦ä¸²ç±»å‹ä¹‹ä¸€, <code>&amp;str</code> æ˜¯å­—ç¬¦ä¸²åˆ‡ç‰‡
<ul>
<li>é™¤äº† <code>std::string::String</code> ä¹‹å¤–ï¼Œæ ‡å‡†åº“è¿˜å®šä¹‰äº†è¿™äº›å­—ç¬¦ä¸²ç±»å‹
<ul>
<li><code>std::ffi::OsString</code>, <code>std::ffi::OsStr</code></li>
<li><code>std::ffi::CString</code>, <code>std::ffi::CStr</code></li>
<li><code>std::path::PathBuf</code>, <code>std::path::Path</code></li>
</ul>
</li>
</ul>
</li>
<li><code>str</code> ç±»å‹çš„å­—ç¬¦ä¸²æ˜¯ç¡¬ç¼–ç è¿›å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸”ä¸å¯ä¿®æ”¹ï¼Œ<code>String</code>æ˜¯ä¸€ä¸ªå¯å¢é•¿ã€å¯ä¿®æ”¹ä¸”å…·æœ‰æ‰€æœ‰æƒçš„ UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²</li>
<li><code>&amp;str</code> å’Œ <code>String</code> ä¹‹é—´çš„è½¬æ¢
<ul>
<li><code>&amp;str</code> =&gt; <code>String</code>
<ul>
<li><code>String::from(&quot;hello,world&quot;)</code></li>
<li><code>&quot;hello,world&quot;.to_string()</code></li>
</ul>
</li>
<li><code>String</code> =&gt; <code>&amp;str</code>  <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span> () &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">s</span> = <span class="type">String</span>::<span class="title function_ invoke__">from</span>(<span class="string">&quot;hello,world!&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">say_hello</span>(&amp;s);</span><br><span class="line">    <span class="title function_ invoke__">say_hello</span>(&amp;s[..]);</span><br><span class="line">    <span class="title function_ invoke__">say_hello</span>(s.<span class="title function_ invoke__">as_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">say_hello</span>(s: &amp;<span class="type">str</span>) &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span> ,s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="none-vs"><a class="markdownIt-Anchor" href="#none-vs"></a> <code>None</code> vs <code>()</code></h2>
<p><code>None</code> æ˜¯ä¸€ä¸ªå€¼ï¼Œ<code>enum Option&lt;T&gt;</code> ä¸­çš„ä¸€ä¸ªæšä¸¾å€¼ï¼Œè¡¨ç¤ºä¸€ä¸ª<strong>ä¸å­˜åœ¨çš„å€¼</strong></p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Option</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(T),</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œ <code>()</code> æ˜¯ä¸€ä¸ªç±»å‹ï¼Œåœ¨æ³›å‹ä¸­æœ‰æ—¶è¢«ç”¨ä½œ<strong>å ä½ç¬¦</strong>ï¼Œè¡¨ç¤ºè¿™é‡Œéœ€è¦ä¸€ä¸ªç±»å‹ï¼Œä½†å¹¶ä¸å…³å¿ƒå…·ä½“æ˜¯ä»€ä¹ˆç±»å‹</p>
<figure class="highlight rust"><figcaption><span>$srctree/drivers/gpu/nova-core/falcon.rs</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">_</span> = util::<span class="title function_ invoke__">wait_on</span>(Delta::<span class="title function_ invoke__">from_micros</span>(<span class="number">150</span>), || &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">r</span> = regs::NV_PFALCON_FALCON_HWCFG2::<span class="title function_ invoke__">read</span>(bar, E::BASE);</span><br><span class="line">    <span class="keyword">if</span> r.<span class="title function_ invoke__">reset_ready</span>() &#123;</span><br><span class="line">        <span class="title function_ invoke__">Some</span>(())</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">None</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://doc.rust-lang.org/cargo/index.html">The Cargo Book</a></li>
<li><a href="https://course.rs/basic/variable.html">Rust è¯­è¨€åœ£ç»</a>ğŸ‘</li>
<li><a href="https://github.com/rust-lang/rustlings">Rustling</a>ğŸ¦€</li>
<li><a href="https://rust-for-linux.com/">Rust for Linux</a>ğŸ‘€</li>
<li><a href="https://rust.docs.kernel.org/kernel/">rust.docs.kernel.org</a></li>
<li><a href="https://github.com/dtolnay/proc-macro-workshop">The best way to learn procedural macros is by writing them</a></li>
<li><a href="https://doc.rust-lang.org/book/ch20-05-macros.html">The Rust Programming Language - Macros</a></li>
<li><a href="https://doc.rust-lang.org/book/ch13-01-closures.html">The Rust Programming Language - Closures: Anonymous Functions That Capture Their Environment</a></li>
</ul>
]]></content>
      <categories>
        <category>programming</category>
      </categories>
      <tags>
        <tag>Rust</tag>
      </tags>
  </entry>
  <entry>
    <title>Smart Pointer</title>
    <url>/prog/smart-pointer/</url>
    <content><![CDATA[<p>smart pointeræ˜¯C<ins>11å¼•å…¥çš„ï¼Œè¢«åŒ…å«åœ¨C</ins>æ ‡å‡†åº“ä¸­ã€‚smart pointeræ˜¯ä¸ºäº†ç®¡ç†å¯¹è±¡çš„æ‰€å±(object ownership)è€Œè®¾è®¡çš„ï¼Œsmart pointerå¯¹è±¡è´Ÿè´£è‡ªåŠ¨åœ°é”€æ¯æ‰€å…³è”å¯¹è±¡ã€‚å¸¸è§çš„smart pointeræœ‰:</p>
<span id="more"></span>
<ul>
<li><code>std::shared_ptr</code></li>
<li><code>std::unique_ptr</code></li>
<li><code>std::weak_ptr</code></li>
</ul>
<h1 id="shared_ptr"><a class="markdownIt-Anchor" href="#shared_ptr"></a> <code>shared_ptr</code></h1>
<p>shared_pträ¸»è¦ç”¨åœ¨å¤šä¸ªå¯¹è±¡å…±äº«åŒä¸€ä¸ªèµ„æºçš„åœºæ™¯(sharing ownership)ã€‚å®ƒå…è®¸å½“æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡åœ¨ä»»ä½•åœ°æ–¹éƒ½ä¸å†è¢«ä½¿ç”¨çš„æ—¶å€™è‡ªåŠ¨é”€æ¯æ‰€æŒ‡å¯¹è±¡ã€‚C++å¼•å…¥å®ƒçš„ç›®çš„æ˜¯æ¶ˆé™¤å†…å­˜æ³„æ¼(memory leak)å’Œé‡æŒ‡é’ˆ(dangling pointer). ä»å®ç°çš„è§’åº¦çœ‹ï¼Œshared_ptræ˜¯é€šè¿‡æ¶ˆè€—æ›´å¤šçš„å†…å­˜æ¥æ¢å–ç¨‹åºçš„å¥å£®æ€§ã€‚æ¯ä¸ªshared_ptrå¯¹è±¡çš„å†…éƒ¨éƒ½æŒ‡å‘ä¸¤å—å†…å­˜åŒºåŸŸ:</p>
<ul>
<li>Pointer to object</li>
<li>Pointer to control data that is used for reference counting</li>
</ul>
<div align=center><img src="/prog/smart-pointer/shared_ptr.png" class="" title="shared_ptr memory layout"></div>
<p>é€šå¸¸ä¸€ä¸ª<code>shared_ptr</code>å¯¹è±¡çš„å†…å­˜å¤§å°ä¸å°äº40å­—èŠ‚ï¼Œè¿™æ˜¯32ä½å¹³å°æ™®é€šæŒ‡é’ˆå˜é‡å¤§å°çš„10å€ã€‚<code>shared_ptr</code>çš„destructorå’Œè™šæˆå‘˜å‡½æ•°æ„å‘³ç€è¿™äº›æˆå‘˜å‡½æ•°çš„è°ƒç”¨æ˜¯åŠ¨æ€è§£æçš„ï¼Œè¿™å°±å¢åŠ äº†é¢å¤–çš„è¿è¡Œæ—¶å¼€é”€ã€‚</p>
<h2 id="creation"><a class="markdownIt-Anchor" href="#creation"></a> creation</h2>
<ul>
<li>
<p>binding a <code>shared_ptr</code> object with raw pointer</p>
<p><code>std::shared_ptr&lt;int&gt; p1(new int());</code></p>
</li>
<li>
<p>using <code>std::make_shared</code></p>
<p><code>std::shared_ptr&lt;int&gt; p1 = std::make_shared&lt;int&gt;();</code></p>
</li>
</ul>
<h2 id="reference-counting"><a class="markdownIt-Anchor" href="#reference-counting"></a> reference counting</h2>
<p><code>p1.use_count();</code></p>
<h2 id="detachment"><a class="markdownIt-Anchor" href="#detachment"></a> detachment</h2>
<ul>
<li>
<p>calling <code>reset()</code> with no parameter</p>
<p><code>p1.reset();</code></p>
<p>è¿™ä¸ªè°ƒç”¨å°†<code>p1</code>çš„reference countå‡1ï¼Œ å¦‚æœreference countå˜æˆ0ï¼Œåˆ™è‡ªåŠ¨åˆ é™¤<code>p1</code>å…³è”çš„raw pointer.</p>
</li>
<li>
<p>calling <code>reset()</code> with parameter</p>
<p><code>p1.reset(new int(42));</code></p>
<p>è¿™ä¸ªè°ƒç”¨å°†<code>p1</code>å…³è”åˆ°ä¸€ä¸ªæ–°çš„raw pointer, å› æ­¤<code>p1</code>çš„reference countè¿˜æ˜¯1.</p>
</li>
<li>
<p>using <code>nullptr</code></p>
<p><code>p1 = nullptr;</code></p>
</li>
</ul>
<h2 id="psuedo-pointer"><a class="markdownIt-Anchor" href="#psuedo-pointer"></a> psuedo pointer</h2>
<h1 id="unique_ptr"><a class="markdownIt-Anchor" href="#unique_ptr"></a> <code>unique_ptr</code></h1>
<p><code>unique_ptr</code>åŒæ ·æ˜¯ä¸ºäº†ç®¡ç†å¯¹è±¡çš„æ‰€å±(unique ownership)ï¼Œä½†ä¸<code>shared_ptr</code>ç›¸åï¼Œ<code>unique_ptr</code>å…è®¸åœ¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸçš„ä»»ä½•æ—¶å€™åªæœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å¯¹è±¡ï¼Œæ‰€ä»¥<code>unique_ptr</code>æ˜¯ä¸å¯å¤åˆ¶çš„ã€‚</p>
<h1 id="weak_ptr"><a class="markdownIt-Anchor" href="#weak_ptr"></a> <code>weak_ptr</code></h1>
]]></content>
      <categories>
        <category>programming</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
      </tags>
  </entry>
  <entry>
    <title>C++ æ ‡å‡†åº“</title>
    <url>/prog/std/</url>
    <content><![CDATA[<h1 id="stdallocator"><a class="markdownIt-Anchor" href="#stdallocator"></a> <a href="https://en.cppreference.com/w/cpp/memory/allocator">std::allocator</a></h1>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt; <span class="keyword">class</span> <span class="title class_">T</span> &gt; <span class="keyword">struct</span> <span class="title class_">allocator</span>;</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p><code>std::allocator</code>æœ¬è´¨ä¸Šå°±æ˜¯ new/delete, ä½†æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å®ƒå‘¢ï¼Ÿ</p>
<ul>
<li>åˆ†ç¦» allocation å’Œ construction(æˆ–è€…åˆ†ç¦» deallocation å’Œ destruction)</li>
<li>ä¸»è¦çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯åœ¨å®ç°containeræ—¶</li>
</ul>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://stackoverflow.com/questions/31358804/whats-the-advantage-of-using-stdallocator-instead-of-new-in-c">Whatâ€™s advantage of using std::allocator instead of new in C++?</a></li>
</ul>
]]></content>
      <categories>
        <category>programming</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¼–è¯‘ï¼Œé“¾æ¥å’Œè¿è¡Œ</title>
    <url>/utils/build/</url>
    <content><![CDATA[<p><img src="/images/build/execve.svg" alt="" /></p>
<p>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»â€“é“¾æ¥ï¼Œè£…è½½ä¸åº“ã€‹è¿™æœ¬ä¹¦æ˜¯åœ¨è¯»ç ”æ—¶æ‰çœ‹çš„ï¼Œå°è±¡å¾ˆæ·±ï¼Œç°åœ¨æƒ³æƒ³è¿™æœ¬ä¹¦è®²çš„éƒ½æ˜¯ç¨‹åºå‘˜ï¼Œå°¤å…¶æ˜¯ä»äº‹ç³»ç»Ÿç¼–ç¨‹éœ€è¦çš„çŸ¥è¯†ã€‚è¿™é‡Œæˆ‘å°†å¹³æ—¶ä½¿ç”¨çš„è·Ÿç¼–è¯‘ï¼Œé“¾æ¥å’Œæ„å»ºåº”ç”¨ç¨‹åºåŠåº“ç›¸å…³çš„çŸ¥è¯†è®°å½•ä¸‹æ¥ï¼Œå¸Œæœ›ä»¥åèƒ½æ¸©æ•…çŸ¥æ–°ã€‚</p>
<span id="more"></span>
<h1 id="ç¼–è¯‘å™¨ä¸é“¾æ¥å™¨"><a class="markdownIt-Anchor" href="#ç¼–è¯‘å™¨ä¸é“¾æ¥å™¨"></a> ç¼–è¯‘å™¨ä¸é“¾æ¥å™¨</h1>
<ul>
<li>
<p>gcc</p>
</li>
<li>
<p><a href="https://gcc.gnu.org/projects/cxx-status.html">g++</a></p>
</li>
<li>
<p>clang</p>
</li>
<li>
<p><a href="https://clang.llvm.org/cxx_status.html">clang++</a></p>
</li>
<li>
<p>bfd (ä½¿ç”¨ Binary File Descriptor åº“æ„å»ºçš„ Linker, Ubuntu ä¸Šé»˜è®¤çš„ ld)</p>
</li>
<li>
<p>gold (<a href="https://android.googlesource.com/toolchain/binutils/+/53b6ed3bceea971857c996b6dcb96de96b99335f/binutils-2.19/gold"><strong>go</strong>ogle <strong>l</strong>oa<strong>d</strong>er</a>)</p>
</li>
<li>
<p>mold (<a href="https://github.com/rui314/mold"><strong>mo</strong>dern <strong>l</strong>oa<strong>d</strong>er</a>)</p>
</li>
</ul>
<h2 id="gcc-çš„ä¼˜åŒ–çº§åˆ«"><a class="markdownIt-Anchor" href="#gcc-çš„ä¼˜åŒ–çº§åˆ«"></a> gcc çš„ä¼˜åŒ–çº§åˆ«</h2>
<p><code>-O</code> å’Œ <code>-O1</code> æ˜¯ç­‰ä»·çš„ã€‚ <code>-O</code> ä¼šå¯¹ç›®æ ‡æ–‡ä»¶å¤§å°å’Œæ‰§è¡Œæ—¶é—´è¿›è¡Œä¼˜åŒ–ï¼Œä½†ä¸ä¼šè¿›è¡Œéå¸¸è€—æ—¶çš„ä¼˜åŒ–ï¼Œä»¥ä¸‹æ˜¯ <code>-O</code> æ‰“å¼€çš„ä¼˜åŒ–: (å…¶ä¸­çº¢è‰²çš„æ˜¯ <code>-Og</code> å…³é—­çš„)</p>
<ul>
<li>-fauto-inc-dec</li>
<li><span style="color:red">-fbranch-count-reg</span></li>
<li>-fcombine-stack-adjustments</li>
<li>-fcompare-elim</li>
<li>-fcprop-registers</li>
<li>-fdce</li>
<li>-fdefer-pop</li>
<li><span style="color:red">-fdelayed-branch</span></li>
<li><span style="color:red">-fdse</span></li>
<li>-fforward-propagate</li>
<li>-fguess-branch-probability</li>
<li><span style="color:red">-fif-conversion</span></li>
<li><span style="color:red">-fif-conversion2</span></li>
<li><span style="color:red">-finline-functions-called-once</span></li>
<li>-fipa-modref</li>
<li>-fipa-profile</li>
<li>-fipa-reference</li>
<li>-fipa-reference-addressable</li>
<li>-fmerge-constants</li>
<li><span style="color:red">-fmove-loop-invariants</span></li>
<li><span style="color:red">-fmove-loop-stores</span></li>
<li>-fomit-frame-pointer</li>
<li>-freorder-blocks</li>
<li>-fshrink-wrap</li>
<li>-fshrink-wrap-separate</li>
<li>-fsplit-wide-types</li>
<li>-fssa-backprop</li>
<li><span style="color:red">-fssa-phiopt</span></li>
<li><span style="color:red">-ftree-bit-ccp</span></li>
<li>-ftree-ccp</li>
<li>-ftree-ch</li>
<li>-ftree-coalesce-vars</li>
<li>-ftree-copy-prop</li>
<li>-ftree-dce</li>
<li>-ftree-dominator-opts</li>
<li><span style="color:red">-ftree-dse</span></li>
<li>-ftree-forwprop</li>
<li>-ftree-fre</li>
<li>-ftree-phiprop</li>
<li><span style="color:red">-ftree-pta</span></li>
<li>-ftree-scev-cprop</li>
<li>-ftree-sink</li>
<li>-ftree-slsr</li>
<li><span style="color:red">-ftree-sra</span></li>
<li>-ftree-ter</li>
<li>-funit-at-a-time</li>
</ul>
<h2 id="ç¼–è¯‘å™¨èƒŒååšçš„äº‹"><a class="markdownIt-Anchor" href="#ç¼–è¯‘å™¨èƒŒååšçš„äº‹"></a> ç¼–è¯‘å™¨èƒŒååšçš„äº‹</h2>
<ul>
<li>å½“ä½ ç¼–è¯‘ä¸€ä¸ª hello world C ç¨‹åºæ—¶ï¼Œä¸€èˆ¬å¹¶ä¸ä¼šæŒ‡å®š <code>-lc</code> é“¾æ¥é€‰é¡¹ï¼Œé‚£ä¸ºä»€ä¹ˆä¼šè‡ªåŠ¨é“¾æ¥ libc.so.6 å‘¢ï¼Ÿ</li>
</ul>
<p>åŸå› æ˜¯ gcc æœ‰ä¸€å¥—å†…ç½®çš„é“¾æ¥è§„åˆ™ï¼Œé€šè¿‡ <code>gcc -dumpspecs</code> å¯ä»¥çœ‹åˆ°å®ƒï¼Œè¿™å¥—è§„åˆ™è§„å®šåœ¨æ»¡è¶³æ¡ä»¶æ—¶ï¼Œgcc ä¼šé»˜è®¤ä¸ºä½ åŠ ä¸Š <code>-lc</code> é€‰é¡¹</p>
<h1 id="åŠ¨æ€é“¾æ¥å™¨-vs-é™æ€é“¾æ¥å™¨"><a class="markdownIt-Anchor" href="#åŠ¨æ€é“¾æ¥å™¨-vs-é™æ€é“¾æ¥å™¨"></a> åŠ¨æ€é“¾æ¥å™¨ vs é™æ€é“¾æ¥å™¨</h1>
<p><strong>åŠ¨æ€é“¾æ¥å™¨ <code>/lib64/ld-linux-x86-64.so.2</code></strong> æ˜¯ç¨‹åºè¿è¡Œæ—¶è°ƒç”¨çš„ï¼Œå®ƒç”±æ“ä½œç³»ç»Ÿå†…æ ¸é€šè¿‡ execve æ—ç³»ç»Ÿè°ƒç”¨åŠ è½½åˆ°å†…å­˜ï¼Œè¿›è€Œç”±å®ƒåŠ è½½å…¶å®ƒç”¨åˆ°çš„åŠ¨æ€é“¾æ¥åº“ã€‚å®ƒæœ¬èº«æ˜¯ä¸€ä¸ªé™æ€é“¾æ¥åº“ï¼Œä¸ä¾èµ–å…¶å®ƒåº“ã€‚</p>
<p><strong>é™æ€é“¾æ¥å™¨ <code>/usr/bin/ld</code></strong> æ˜¯æ„å»ºç¨‹åºæˆ–åº“æ—¶è°ƒç”¨çš„ï¼Œå®ƒç”±ç¼–è¯‘å™¨(å¦‚ gcc)è°ƒç”¨, å®ƒæœ¬èº«æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œè€Œä¸”å¯ä»¥è¯»å…¥é“¾æ¥è„šæœ¬(linker script)æ¥æ”¹å˜å®ƒçš„è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œå¸¸è§çš„ <code>/lib/x86_64-linux-gnu/libc.so</code> å°±æ˜¯ä¸€ä¸ª<strong>é“¾æ¥å™¨è„šæœ¬æ–‡ä»¶(çº¯ASCII text)</strong>, è€Œä¸æ˜¯<s>å…±äº«å¯¹è±¡(shared object) Binary æ–‡ä»¶</s>, è¿™ä¸ªé“¾æ¥è„šæœ¬çš„å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/* GNU ld script</span><br><span class="line">   Use the shared library, but some functions are only in</span><br><span class="line">   the static library, so try that secondarily.  */</span><br><span class="line">OUTPUT_FORMAT(elf64-x86-64)</span><br><span class="line">GROUP (</span><br><span class="line">  /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">  /usr/lib/x86_64-linux-gnu/libc_nonshared.a</span><br><span class="line">  AS_NEEDED ( /lib64/ld-linux-x86-64.so.2 )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>è™½ç„¶é™æ€é“¾æ¥å™¨å’ŒåŠ¨æ€é“¾æ¥å™¨è¿è¡Œåœ¨ä¸¤ä¸ªä¸åŒçš„é˜¶æ®µï¼Œä½†é™æ€é“¾æ¥å™¨ä¹Ÿå¯ä»¥å½±å“åˆ°åŠ¨æ€é“¾æ¥å™¨çš„è¡Œä¸ºï¼Œæ¯”å¦‚ <code>-Wl,-rpath,/path/to/lib</code>, ä¹Ÿå°±æ˜¯å¸¸è¯´çš„ Runtime PATH, è¿™ä¸ªå‚æ•°å¯ä»¥è®©åŠ¨æ€é“¾æ¥å™¨å»æŒ‡å®š<strong>ç›®å½•</strong>ä¸‹æœç´¢çš„ç›®æ ‡åŠ¨æ€åº“ã€‚</p>
<ul>
<li><code>-L/path/to/lib</code>          ç¼–è¯‘æ—¶æœç´¢è·¯å¾„</li>
<li><code>-Wl,-rpath,/path/to/lib</code> è¿è¡Œæ—¶æœç´¢è·¯å¾„</li>
</ul>
<h2 id="åŠ¨æ€åº“éƒ½å»å“ªå„¿å‘¢"><a class="markdownIt-Anchor" href="#åŠ¨æ€åº“éƒ½å»å“ªå„¿å‘¢"></a> åŠ¨æ€åº“éƒ½å»å“ªå„¿å‘¢</h2>
<ul>
<li>pkg-config</li>
</ul>
<p><strong>pkg-config (symbolic link to <code>/usr/bin/pkgconf</code>)</strong> æ˜¯ç”¨æ¥è·å–ç³»ç»Ÿä¸Šå®‰è£…çš„åº“çš„ä¿¡æ¯çš„ç¨‹åºã€‚cmake, meson è¿™äº›æ„å»ºç³»ç»Ÿåº•å±‚éƒ½æ˜¯é å®ƒæ¥è§£æä¾èµ–åŒ…çš„ã€‚ ä¸‹é¢çš„å‘½ä»¤å¯ä»¥æŸ¥çœ‹ pkg-config å·¥ä½œæ—¶æ‰€æœç´¢çš„è·¯å¾„å’Œä¼˜å…ˆæ¬¡åºï¼Œ ç”¨æˆ·ä¹Ÿå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ <strong><code>PKG_CONFIG_PATH</code></strong> æ¥æŒ‡å®šè‡ªå·±æƒ³è¦ä¼˜å…ˆæœç´¢çš„è·¯å¾„ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pkg-config --variable pc_path pkg-config | sed <span class="string">&#x27;s/:/\n/g&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/lib/x86_64-linux-gnu/pkgconfig</span><br><span class="line">/usr/local/lib/pkgconfig</span><br><span class="line">/usr/local/share/pkgconfig</span><br><span class="line">/usr/lib/x86_64-linux-gnu/pkgconfig</span><br><span class="line">/usr/lib/pkgconfig</span><br><span class="line">/usr/share/pkgconfig</span><br></pre></td></tr></table></figure>
<p><code>pkg-config</code> æ˜¯äºŒè¿›åˆ¶å¯æ‰§è¡Œç¨‹åº <code>/usr/bin/pkgconf</code> çš„ä¸€ä¸ªç¬¦å·é“¾æ¥æ–‡ä»¶ï¼Œå®ƒæ˜¯ CMake, meson ç­‰æ„å»ºç³»ç»Ÿä¸»è¦ä½¿ç”¨çš„ç³»ç»ŸåŠ¨æ€åº“æ£€æµ‹çš„å·¥å…·ã€‚<code>pkg-config</code> æœ¬è´¨ä¸Šæ˜¯åœ¨è§£æ <code>*.pc</code> æ–‡ä»¶ã€‚ä¸‹é¢æ˜¯å¸¸è§çš„ Mesa OpenGL Library çš„ .pc æ–‡ä»¶ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">âœ  piglit git:(main) âœ— find /usr -name &#x27;gl.pc&#x27; -ls</span><br><span class="line">    78674      4 -rw-r--r--   1 root     root          205 Jan  3  2023 /usr/lib/x86_64-linux-gnu/pkgconfig/gl.pc</span><br><span class="line">    72985      4 -rw-r--r--   1 root     root          362 Jun  7 18:16 /usr/local/lib/x86_64-linux-gnu/pkgconfig/gl.pc</span><br><span class="line">âœ  piglit git:(main) âœ— bat /usr/local/lib/x86_64-linux-gnu/pkgconfig/gl.pc</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">       â”‚ File: /usr/local/lib/x86_64-linux-gnu/pkgconfig/gl.pc</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   1   â”‚ prefix=/usr/local</span><br><span class="line">   2   â”‚ includedir=$&#123;prefix&#125;/include</span><br><span class="line">   3   â”‚ libdir=$&#123;prefix&#125;/lib/x86_64-linux-gnu</span><br><span class="line">   4   â”‚</span><br><span class="line">   5   â”‚ glx_tls=yes</span><br><span class="line">   6   â”‚</span><br><span class="line">   7   â”‚ Name: gl</span><br><span class="line">   8   â”‚ Description: Mesa OpenGL Library</span><br><span class="line">   9   â”‚ Version: 24.2.0-devel</span><br><span class="line">  10   â”‚ Requires.private: x11, xext, xfixes, x11-xcb, xcb, xcb-glx &gt;=  1.8.1, xcb-dri2 &gt;=  1.8, xxf86vm, libdrm &gt;=  2.4.75</span><br><span class="line">  11   â”‚ Libs: -L$&#123;libdir&#125; -lGL</span><br><span class="line">  12   â”‚ Libs.private: -lpthread -pthread -lm</span><br><span class="line">  13   â”‚ Cflags: -I$&#123;includedir&#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">âœ  piglit git:(main) âœ— bat /usr/lib/x86_64-linux-gnu/pkgconfig/gl.pc</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">       â”‚ File: /usr/lib/x86_64-linux-gnu/pkgconfig/gl.pc</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">   1   â”‚ prefix=/usr</span><br><span class="line">   2   â”‚ includedir=$&#123;prefix&#125;/include</span><br><span class="line">   3   â”‚ libdir=$&#123;prefix&#125;/lib/x86_64-linux-gnu</span><br><span class="line">   4   â”‚</span><br><span class="line">   5   â”‚ Name: GL</span><br><span class="line">   6   â”‚ Description: Legacy OpenGL and GLX library and headers.</span><br><span class="line">   7   â”‚ Version: 1.2</span><br><span class="line">   8   â”‚ Libs: -L$&#123;libdir&#125; -lGL</span><br><span class="line">   9   â”‚ Cflags: -I$&#123;includedir&#125;</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br></pre></td></tr></table></figure>
<ul>
<li><code>lib*-dev</code> ä¸ <code>lib*</code> çš„åŒºåˆ«</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ dpkg -L libxcb1</span><br><span class="line">/.</span><br><span class="line">/usr</span><br><span class="line">/usr/lib</span><br><span class="line">/usr/lib/x86_64-linux-gnu</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libxcb.so.1.1.0</span><br><span class="line">/usr/share</span><br><span class="line">/usr/share/doc</span><br><span class="line">/usr/share/doc/libxcb1</span><br><span class="line">/usr/share/doc/libxcb1/changelog.Debian.gz</span><br><span class="line">/usr/share/doc/libxcb1/copyright</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libxcb.so.1</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ dpkg -L libxcb1-dev</span><br><span class="line">/.</span><br><span class="line">/usr</span><br><span class="line">/usr/include</span><br><span class="line">/usr/include/xcb</span><br><span class="line">/usr/include/xcb/bigreq.h</span><br><span class="line">/usr/include/xcb/xc_misc.h</span><br><span class="line">/usr/include/xcb/xcb.h</span><br><span class="line">/usr/include/xcb/xcbext.h</span><br><span class="line">/usr/include/xcb/xproto.h</span><br><span class="line">/usr/lib</span><br><span class="line">/usr/lib/x86_64-linux-gnu</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libxcb.a</span><br><span class="line">/usr/lib/x86_64-linux-gnu/pkgconfig</span><br><span class="line">/usr/lib/x86_64-linux-gnu/pkgconfig/xcb.pc</span><br><span class="line">/usr/share</span><br><span class="line">/usr/share/doc</span><br><span class="line">/usr/share/doc/libxcb1-dev</span><br><span class="line">/usr/share/doc/libxcb1-dev/copyright</span><br><span class="line">/usr/lib/x86_64-linux-gnu/libxcb.so</span><br><span class="line">/usr/share/doc/libxcb1-dev/changelog.Debian.gz</span><br></pre></td></tr></table></figure>
<ul>
<li><code>/usr/sbin/ldconfig</code></li>
</ul>
<p>Configure Dynamic Linker Run Time Bindings</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>  <span class="built_in">test</span> <span class="variable">$#</span> = 0							\</span><br><span class="line">    &amp;&amp; <span class="built_in">test</span> x<span class="string">&quot;<span class="variable">$LDCONFIG_NOTRIGGER</span>&quot;</span> = x				\</span><br><span class="line"> &amp;&amp; <span class="built_in">test</span> x<span class="string">&quot;<span class="variable">$DPKG_MAINTSCRIPT_PACKAGE</span>&quot;</span> != x			\</span><br><span class="line"> &amp;&amp; dpkg-trigger --check-supported 2&gt;/dev/null</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="keyword">if</span> dpkg-trigger --no-await ldconfig; <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">test</span> x<span class="string">&quot;<span class="variable">$LDCONFIG_TRIGGER_DEBUG</span>&quot;</span> != x; <span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">&quot;ldconfig: wrapper deferring update (trigger activated)&quot;</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		<span class="built_in">exit</span> 0</span><br><span class="line">	<span class="keyword">fi</span>	</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> /sbin/ldconfig.real <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="got-plt-pic"><a class="markdownIt-Anchor" href="#got-plt-pic"></a> GOT, PLT &amp; PIC</h2>
<ul>
<li>GOT Global Offset Table</li>
<li>PLT Procedure Linkage Table</li>
<li>PIC Position Independent Code</li>
</ul>
<h1 id="æ„å»ºç³»ç»Ÿ"><a class="markdownIt-Anchor" href="#æ„å»ºç³»ç»Ÿ"></a> æ„å»ºç³»ç»Ÿ</h1>
<ul>
<li>autotools</li>
<li>cmake</li>
<li>make</li>
<li>meson</li>
<li>ninja</li>
<li>scons</li>
</ul>
<h2 id="autotools"><a class="markdownIt-Anchor" href="#autotools"></a> autotools</h2>
<pre><code class="highlight mermaid">flowchart LR
  autoreconf((&quot;autoreconf&lt;br&gt;[Perl script]&quot;))
  autoconf(autoconf)
  aclocal(aclocal)
  automake(automake)
  autoheader(autoheader)
  gettextize(gettextize)
  libtoolize(libtoolize)

  am@&#123;shape: docs, label: &quot;Makefile.am&quot;&#125;
  in@&#123;shape: docs, label: &quot;Makefile.in&quot;&#125;
  mk@&#123;shape: docs, label: &quot;Makefile&quot;&#125;
  ac@&#123;shape: paper-tape, label: &quot;configure.ac&quot;&#125;
  co@&#123;shape: paper-tape, label: &quot;configure&lt;br&gt;[Shell script]&quot;&#125;

  autoreconf --&gt; autoconf
  autoreconf -.-&gt; aclocal
  autoreconf -.-&gt; automake
  autoreconf -.-&gt; autoheader
  autoreconf -.-&gt; gettextize
  autoreconf -.-&gt; libtoolize

  am --&gt; automake --&gt; in
  ac --&gt; autoconf --&gt; co
  in --&gt; co --&gt; mk</code></pre>
<p><a href="https://stackoverflow.com/questions/4071880/what-are-the-differences-between-autotools-cmake-and-scons"><strong>autotools</strong> çš„å”¯ä¸€çš„å¯å–å¤„å°±æ˜¯ GNU é¡¹ç›®å¹¿æ³›ä½¿ç”¨å®ƒ</a>ã€‚ä½¿ç”¨å®ƒçš„é¡¹ç›®çš„æ„å»ºæ­¥éª¤ä¸€èˆ¬æ˜¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./autogen.sh</span><br><span class="line">./configure --prefix=<span class="variable">$PREFIX</span></span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<p>å½“ä½ é‡åˆ° <code>./autogen.sh: 13: autoreconf: not found</code> è¿™æ ·çš„é”™è¯¯æ—¶ï¼Œä½ å¯èƒ½éœ€è¦å®‰è£…è¿™äº›è½¯ä»¶åŒ…</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install autoconf automake libtool gettext</span><br></pre></td></tr></table></figure>
<h2 id="cmake"><a class="markdownIt-Anchor" href="#cmake"></a> cmake</h2>
<ul>
<li>use <code>gold</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cmake -B build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_EXPORT_COMPILE_COMMANDS=On -DCMAKE_EXE_LINKER_FLAGS=-fuse-ld=gold</span><br></pre></td></tr></table></figure>
<h2 id="meson"><a class="markdownIt-Anchor" href="#meson"></a> meson</h2>
<ul>
<li><a href="https://mesonbuild.com/Builtin-options.html#details-for-buildtype">-D buildtype</a></li>
</ul>
<p>meson çš„ buildtype æ˜¯ç”¨æ¥è®¾å®šç¼–è¯‘ä¼˜åŒ–çº§åˆ« (optimization levels: -O0, -O1, -O2, -O3, -Os) å’Œæ˜¯å¦æœ‰è°ƒè¯•ä¿¡æ¯ (debug: -g)ã€‚ å®é™…ä¸Šï¼Œmeson æä¾›ä¸¤ä¸ªåˆ†å¼€çš„é€‰é¡¹åˆ†åˆ«æ§åˆ¶ç¼–è¯‘ä¼˜åŒ–çº§åˆ«å’Œè°ƒè¯•ä¿¡æ¯</p>
<ul>
<li>
<p>-Doptimization (plain|0|2|3|s, plain æŒ‡ä¸è®¾ç½®ä»»ä½• optimization flags)</p>
</li>
<li>
<p>-Ddebug (true|false)</p>
</li>
<li>
<p>åªç¼–è¯‘æŸä¸ª target</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ninja -C build target</span><br></pre></td></tr></table></figure>
<ul>
<li>meson install --tags tag1,tag2</li>
</ul>
<p>Installation tags æ˜¯ä¸“é—¨ä¸ºæ‰“åŒ… (packaging) è®¾è®¡çš„ï¼Œå› ä¸ºæ‰“åŒ…æ—¶å¼€å‘æ–‡ä»¶åŒ…(å¤´æ–‡ä»¶)ï¼Œæ–‡æ¡£åŒ… (mannul) å’ŒäºŒè¿›åˆ¶åŒ… (shared libraries) ä¸€èˆ¬æ˜¯åˆ†å¼€çš„ 3 ä¸ªåŒ…ã€‚æ‰€ä»¥ <code>meson install --tags</code> å¯ä»¥è®©ç”¨æˆ·åˆ† 3 æ¬¡å®‰è£…ï¼Œæ¯æ¬¡åªå®‰è£…è¿™ä¸ªåŒ…æ‰€éœ€çš„æ–‡ä»¶ã€‚meson æœ‰å‡ ä¸ªé¢„å®šä¹‰çš„ tags (ä¸ç”¨ç”¨æˆ·è‡ªå·±ä½¿ç”¨ <code>install_tag</code> å…³é”®å­—å»æŒ‡å®š tag å)</p>
<table>
<thead>
<tr>
<th style="text-align:left">tags</th>
<th style="text-align:left">files</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">devel</td>
<td style="text-align:left">static_library(), install_headers(), .a, .pc</td>
</tr>
<tr>
<td style="text-align:left">runtime</td>
<td style="text-align:left">executable(), shared_library(), shared_module(), .so, .dll</td>
</tr>
<tr>
<td style="text-align:left">man</td>
<td style="text-align:left">install_man()</td>
</tr>
<tr>
<td style="text-align:left">doc</td>
<td style="text-align:left">hotdoc.generate_doc()</td>
</tr>
<tr>
<td style="text-align:left">i18n</td>
<td style="text-align:left">i18n.gettext(), files installed into <code>localedir</code></td>
</tr>
<tr>
<td style="text-align:left">bin</td>
<td style="text-align:left">scripts and executables bundled with a library used by end users</td>
</tr>
<tr>
<td style="text-align:left">bin-devel</td>
<td style="text-align:left">scripts and executables bundled with  a library used by developers</td>
</tr>
</tbody>
</table>
<ul>
<li>use <code>gold</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">meson build --prefix=/usr -D&#123;c,cpp&#125;_args=-fuse-ld=gold -Dflavors=x11-gl,x11-glesv2</span><br></pre></td></tr></table></figure>
<h1 id="è¿è¡Œ"><a class="markdownIt-Anchor" href="#è¿è¡Œ"></a> è¿è¡Œ</h1>
<p>ä¸€ä¸ª ELF å¯æ‰§è¡Œæ–‡ä»¶çš„çœŸæ­£å…¥å£ç‚¹æ˜¯ <strong><code>_start()</code></strong></p>
<p><img src="/images/build/start_main.svg" alt="" /></p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://en.cppreference.com/w/cpp/compiler_support">C++ compiler support</a></li>
</ul>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>CLion ä½¿ç”¨ç¬”è®°</title>
    <url>/utils/clion/</url>
    <content><![CDATA[<h1 id="choice-of-clion"><a class="markdownIt-Anchor" href="#choice-of-clion"></a> Choice of CLion</h1>
<span id="more"></span>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CLion 2020.2.5</span><br><span class="line">Build #CL-202.8194.17, built on November 26, 2020</span><br><span class="line">Licensed to CLion Evaluator</span><br><span class="line">Expiration date: October 3, 2022</span><br><span class="line">Runtime version: 11.0.9+11-b944.49 amd64</span><br><span class="line">VM: OpenJDK 64-Bit Server VM by JetBrains s.r.o.</span><br><span class="line">Windows 10 10.0</span><br><span class="line">GC: ParNew, ConcurrentMarkSweep</span><br><span class="line">Memory: 1987M</span><br><span class="line">Cores: 8</span><br><span class="line">Registry: run.processes.with.pty=TRUE</span><br><span class="line">Non-Bundled Plugins: IdeaVIM, Lua, io.zhile.research.ide-eval-resetter, zielu.gittoolbox</span><br></pre></td></tr></table></figure>
<h1 id="on-clion-with-wsl"><a class="markdownIt-Anchor" href="#on-clion-with-wsl"></a> On CLion with WSL</h1>
<h2 id="avoid-annoying-event-notification-every-startup"><a class="markdownIt-Anchor" href="#avoid-annoying-event-notification-every-startup"></a> Avoid annoying event notification every startup</h2>
<ul>
<li>filesystem case-sensitivity mismatch</li>
</ul>
<p>åŸå› ï¼š<a href="https://confluence.jetbrains.com/display/IDEADEV/Filesystem+Case-Sensitivity+Mismatch">WSL Ubuntu æ˜¯ case-sensitive OS, è€Œ Host ä¾§çš„ Windows 11 æ˜¯ case-insensitive OS</a></p>
<ul>
<li>external file changes sync may be slow</li>
</ul>
<p>åŸå› ï¼š<a href="https://intellij-support.jetbrains.com/hc/en-us/community/posts/115000013130-External-file-changes-sync-may-be-slow">Native file watcher will not work for the shared and network folders</a></p>
<p>è¿™ä¸¤ä¸ªé—®é¢˜å…¶å®éƒ½æ˜¯æˆ‘åœ¨ä½¿ç”¨ WSL çš„åŸå› ï¼Œé¿å…æ–¹æ³•ä¹Ÿå¾ˆç®€å• <code>C:\Users\whoami\AppData\Roaming\JetBrains\CLion2020.2\idea.properties</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">idea.case.sensitive.fs=true</span><br><span class="line">idea.filewatcher.disabled=true</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>CMake ä¸æ˜¯ä¸€ä¸ªæ„å»ºç³»ç»Ÿ</title>
    <url>/utils/cmake/</url>
    <content><![CDATA[<p>æœ€è¿‘çœ‹äº†ä¸€äº›å…³äºModern CMake(since 3.0.0)çš„æ•™ç¨‹ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹.</p>
<span id="more"></span>
<h1 id="modern-cmake"><a class="markdownIt-Anchor" href="#modern-cmake"></a> Modern CMake</h1>
<p>ä½œä¸ºä¸€ä¸ª<em>Build System Generator</em>, ç°ä»£CMakeå¯ä»¥å¸®åŠ©æˆ‘ä»¬åšå“ªäº›äº‹æƒ…å‘¢ï¼Ÿ</p>
<ul>
<li>Build</li>
<li>Install</li>
<li>Test</li>
<li>Package</li>
</ul>
<h1 id="command-options"><a class="markdownIt-Anchor" href="#command-options"></a> Command Options</h1>
<ul>
<li>
<p>cmake -B build</p>
<ul>
<li>Buildçš„å·¥ä½œä¸»è¦åŒ…æ‹¬è§£å†³ä¾èµ–å…³ç³»ï¼Œæ„å»ºç›®æ ‡(åº“,åº”ç”¨,æµ‹è¯•ç”¨ä¾‹)ã€‚<code>cmake</code>å‘½ä»¤æœ‰å¾ˆå¤šé€‰é¡¹å¯ä»¥å¸®åŠ©æˆ‘ä»¬çµæ´»æœ‰æ•ˆåœ°æ„å»ºç›®æ ‡ï¼Œ ä¾‹å¦‚ï¼šOut-of-sourceæ„å»ºï¼Œæ„æ€æ˜¯ä¸æ±¡æŸ“æºä»£ç ç›®å½•ï¼Œåœ¨æŒ‡å®šçš„å•ç‹¬çš„ç›®å½•ä¸‹ç”Ÿæˆæ„å»ºç³»ç»Ÿ, å¦‚æœbuildä¸å­˜åœ¨ï¼Œcmakeä¼šåˆ›å»ºå®ƒ</li>
<li><code>-B</code>ï¼Œ<code>-S</code> é€‰é¡¹æ˜¯ä» CMake <strong>3.13</strong> ç‰ˆæœ¬å¼•å…¥çš„</li>
</ul>
</li>
<li>
<p>cmake -B build --graphviz=file.dot</p>
<ul>
<li>å°†æ„å»ºç›®æ ‡é—´çš„ä¾èµ–å…³ç³»è¾“å‡ºGraphivz dot, ç”Ÿæˆçš„<code>file.dot</code>å¯ä»¥ç”¨dotå‘½ä»¤ç”Ÿæˆå›¾ç‰‡<code>dot -Tpng -o file.png file.dot</code></li>
</ul>
</li>
<li>
<p>cmake --build build</p>
<ul>
<li>å¼€å§‹æ„å»º, é€šè¿‡<code>-B</code>, <code>--build</code>é€‰é¡¹å¯ä»¥çœå»<code>mkdir build &amp;&amp; cd build &amp;&amp; cmake .. &amp;&amp; make</code>ç¹ççš„æ“ä½œ</li>
</ul>
</li>
<li>
<p>cmake --build build --clean-first</p>
<ul>
<li>å…¨é‡æ„å»º, å¦‚æœæ˜¯ <code>-G &quot;Ninja&quot;</code>, åˆ™ <code>ninja -C build clean</code>, ç„¶åå†é‡æ–° <code>ninja -C build</code></li>
</ul>
</li>
<li>
<p>cmake --build build --target lib1</p>
<ul>
<li>åªæ„å»ºæŒ‡å®šçš„ç›®æ ‡<code>lib1</code>, å¦‚æœ<code>lib1</code>ä¾èµ–å…¶å®ƒç›®æ ‡ï¼Œè¢«ä¾èµ–çš„ç›®æ ‡ä¹Ÿä¼šè¢«æ„å»º</li>
</ul>
</li>
<li>
<p>cmake --install build</p>
<ul>
<li>å®‰è£…</li>
</ul>
</li>
<li>
<p>cmake -L build</p>
<ul>
<li>æŸ¥è¯¢CMAKEå˜é‡é…ç½®å€¼ï¼ŒåŒ…æ‹¬å†…ç½®å˜é‡å’Œè‡ªå®šä¹‰å˜é‡</li>
</ul>
</li>
<li>
<p>cmake --build build --target help</p>
<ul>
<li>åˆ—å‡ºç”Ÿæˆçš„Makefileé‡Œæœ‰æ•ˆçš„<code>target</code></li>
</ul>
</li>
</ul>
<h1 id="built-in-variables"><a class="markdownIt-Anchor" href="#built-in-variables"></a> Built-in Variables</h1>
<ul>
<li>
<p><code>-DCMAKE_EXE_LINKER_FLAGS=&quot;-fuse-ld=gold&quot;</code></p>
<ul>
<li>å°† linker ç”±é»˜è®¤çš„ bfd æ¢æˆ gold, CMake 3.29+ ä½¿ç”¨ <code>-DCMAKE_LINKER=gold</code></li>
</ul>
</li>
<li>
<p><code>-DCMAKE_EXPORT_COMPILE_COMMANDS=on</code></p>
<ul>
<li>ç”Ÿæˆ compile_commands.json</li>
</ul>
</li>
<li>
<p><code>-DCMAKE_CXX_FLAGS=&quot;-Wno-error=missing-field-initializers&quot;</code></p>
<ul>
<li>å°† <code>missing-field-initializers</code> ç”± error è½¬ä¸º warning</li>
</ul>
</li>
<li>
<p><code>-DCMAKE_CXX_FLAGS=&quot;-stdlib=libc++ -fexperimental-library&quot;</code></p>
<ul>
<li>å½“ä½ ä½¿ç”¨ LLVM çš„ c++ runtimes æ—¶ï¼Œ éœ€è¦é¢å¤–æŒ‡å®šè¿™ä¸¤ä¸ªç¼–è¯‘é€‰é¡¹ï¼Œå¦åˆ™ç¼–è¯‘å™¨ä»ç„¶ä¼šä½¿ç”¨ <code>libstdc++.so.1</code></li>
</ul>
</li>
<li>
<p><code>-DCMAKE_EXE_LINKER_FLAGS=&quot;-nostartfiles&quot;</code></p>
<ul>
<li>è§£å†³ â€œScrt1.o: undefined reference to <code>main</code>â€</li>
</ul>
</li>
<li>
<p>CMAKE_SOURCE_DIR</p>
<ul>
<li>æŒ‡æ‰€åœ¨å·¥ç¨‹é¡¶å±‚ç›®å½•ç»å¯¹è·¯å¾„ï¼Œä¸€èˆ¬æºç git-cloneä¸‹æ¥åå°±ç¡®å®šäº†</li>
</ul>
</li>
<li>
<p>CMAKE_CURRENT_SOURCE_DIR</p>
<ul>
<li>æŒ‡CMakeLists.txtæ‰€åœ¨ç›®å½•çš„ç»å¯¹è·¯å¾„ï¼Œéšç€CMakeLists.txtä½ç½®å˜åŒ–</li>
</ul>
</li>
<li>
<p><code>-DCMAKE_VERBOSE_MAKEFILE=ON</code></p>
<ul>
<li>äº§ç”Ÿéå¸¸è¯¦ç»†çš„ç¼–è¯‘è¿‡ç¨‹æ—¥å¿—ï¼ŒåŒ…æ‹¬ç›®å½•æ”¹å˜ï¼Œç¼–è¯‘å™¨é€‰é¡¹å’Œé“¾æ¥å™¨é€‰é¡¹</li>
</ul>
</li>
<li>
<p>CMAKE_INSTALL_PREFIX</p>
<ul>
<li>è‡ªå®šä¹‰å®‰è£…è·¯å¾„, é»˜è®¤ /usr/local</li>
</ul>
</li>
<li>
<p>`-DCMAKE_CXX_STANDARD=14</p>
<ul>
<li>C++ ç‰ˆæœ¬å·, å¦‚ 11, 14</li>
</ul>
</li>
<li>
<p><code>-DCMAKE_CXX_COMPILER_ID=GNU</code></p>
<ul>
<li>å¦‚ GNU, Clang, Intel, MSVC, ä½œç”¨å’Œ <code>CC=gcc CXX=g++</code> ä¸€æ ·</li>
</ul>
</li>
<li>
<p><code>-DCMAKE_CXX_FLAGS=&quot;-std=c++11&quot;</code></p>
<ul>
<li>C++ ç¼–è¯‘å™¨é€‰é¡¹ï¼Œ å¦‚ -std=c++11</li>
</ul>
</li>
</ul>
<h2 id="guideline"><a class="markdownIt-Anchor" href="#guideline"></a> Guideline</h2>
<ul>
<li>Declare your module with <code>ADD_LIBRARY</code> or <code>ADD_EXECUTABLE</code>.</li>
<li>Declare your build flags with <code>TARGET_xxx()</code>.</li>
<li>Declare your dependencies with <code>TARGET_LINK_LIBRARIES</code></li>
<li>Specify what is <code>PUBLIC</code> and what is <code>PRIVATE</code></li>
<li>Donâ€™t make any assumption about the platform and compiler.</li>
<li>Make sure that all your projects can be built both standalone and as a subproject of another project.</li>
<li>Always add namespaced aliases for libraries.<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">add_library(foo STATIC</span><br><span class="line">  foo1.cpp</span><br><span class="line">  foo2.cpp</span><br><span class="line">  )</span><br><span class="line">add_library(my::foo ALIAS foo)</span><br></pre></td></tr></table></figure>
</li>
<li>Donâ€™t make libraries STATIC/SHARED unless they cannot be built otherwise.</li>
<li>Leave the control of BUILD_SHARED_LIBS to your clients.</li>
<li>Create macros to wrap commands that have output parameters. Otherwise, creat a function.</li>
<li>Modern CMake is about Targets and Properties!</li>
<li>Avoid custom variables in the arguments of project commands.</li>
<li>CMake is not a build system, but a build system generator.</li>
<li>Forget those commands:
<ul>
<li>add_compile_options()</li>
<li>include_directories()</li>
<li>link_directories()</li>
<li>link_libraries()</li>
</ul>
</li>
<li>Non-INTERFACE_ properties define the build specification of a targt</li>
<li>INTERFACE_ properties define the usage requirements of a target</li>
<li>Use target_link_libraries() to express direct dependencies</li>
<li>Donâ€™t use <code>TARGET_LINK_LIBRARIES()</code> without specifying <code>PUBLIC</code>, <code>PRIVATE</code> or <code>INTERFACE</code>.</li>
</ul>
<h2 id="targets-and-properties"><a class="markdownIt-Anchor" href="#targets-and-properties"></a> Targets and Properties</h2>
<p>Modern CMakeæ›´åƒä¸€ä¸ªé¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ï¼Œ Targetsæ˜¯Objects, å®ƒä»¬æœ‰Properties(Member Variables)å’ŒCommands(Methods),<br />
Targetsçš„PropertiesåŒ…æ‹¬ç¼–è¯‘è¿™ä¸ªTargetçš„æºæ–‡ä»¶ï¼Œç¼–è¯‘é€‰é¡¹ï¼Œä»¥åŠæœ€åé“¾æ¥çš„åº“è¿™äº›éƒ½æ˜¯ä¸€ä¸ªTargetçš„Properties. åªè¦æ˜¯Propertiesï¼Œå°±æœ‰è¿™ä¸ªPropertyçš„ä½œç”¨åŸŸ(Scope). Propertiesä¹Ÿæœ‰ä½œç”¨åŸŸçš„æ¦‚å¿µ(scope), å¯¹åº”<code>INTERFACE</code>å’Œ<code>PRIVATE</code>.<br />
INTERFACE propertiesæ˜¯å¤–éƒ¨ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯ç»™å¯¼å…¥æˆ–ä½¿ç”¨æœ¬Targetsçš„å…¶å®ƒTargetsç”¨çš„ã€‚PRIVATE propertiesæ˜¯Targetså†…éƒ¨ç”¨çš„ã€‚</p>
<h2 id="cmake-inheritance"><a class="markdownIt-Anchor" href="#cmake-inheritance"></a> CMake Inheritance</h2>
<h3 id="include-inheritance"><a class="markdownIt-Anchor" href="#include-inheritance"></a> Include Inheritance</h3>
<p>åœ¨ CMake ä¸­ï¼Œåœ¨é¢„å¤„ç†é˜¶æ®µæœç´¢å¤´æ–‡ä»¶æ˜¯ä» <code>INCLUDE_DIRECTORIES</code> å’Œ <code>INTERFACE_INCLUDE_DIRECTORIES</code> è¿™ä¸¤ä¸ªå˜é‡é‡ŒåŒ…å«çš„è·¯å¾„ä¸­æœç´¢ã€‚<code>target_include_directories</code> ä¼šå°†æŒ‡å®šçš„è·¯å¾„éƒ½åŠ å…¥ <code>INCLUDE_DIRECTORIES</code>, ä½†æ˜¯ä¼šä¾æ® <code>&lt;PRIVATE|PUBLIC|INTERFACE&gt;</code> æœ‰é€‰æ‹©åœ°å°†æŒ‡å®šè·¯å¾„åŠ å…¥ <code>INTERFACE_INCLUDE_DIRECTORIES</code>. <code>INCLUDE_DIRECTORIES</code> åŒ…å«çš„è·¯å¾„åªä¼šè¢«<strong>å½“å‰ target</strong> ä½œä¸ºæœç´¢è·¯å¾„, è€Œ <code>INTERFACE_INCLUDE_DIRECTORIES</code> åŒ…å«çš„è·¯å¾„ä¼šè¢«åŠ åˆ°ä»»ä½•ä¾èµ–å½“å‰ target çš„ target çš„ <code>INCLUDE_DIRECTORIES</code>.</p>
<h2 id="generator-expressions"><a class="markdownIt-Anchor" href="#generator-expressions"></a> Generator Expressions</h2>
<p>Generator Expressionsï¼ˆç”Ÿæˆè¡¨è¾¾å¼ï¼‰æ˜¯æŒ‡åœ¨ç”Ÿæˆæ„å»ºç³»ç»Ÿçš„è¿‡ç¨‹ä¸­ï¼ˆå¦‚æœæ˜¯Makeæ„å»ºç³»ç»Ÿï¼Œå°±æ˜¯åœ¨ç”ŸæˆMakefileçš„è¿‡ç¨‹ä¸­ï¼‰é’ˆå¯¹æ¯ä¸ªæ„å»ºé…ç½®ç”Ÿæˆç‰¹å®šçš„å€¼. ç”Ÿæˆè¡¨è¾¾å¼æœ‰3ç±»:</p>
<ul>
<li>Logical Expressions</li>
<li>Informational Expressions</li>
<li>Output Expressions</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">target_compile_definitions(foo PRIVATE</span><br><span class="line">    &quot;VERBOSITY=$&lt;IF:$&lt;CONFIG:Debug&gt;,30,10&gt;&quot;</span><br><span class="line">)    </span><br></pre></td></tr></table></figure>
<p>ä¸Šä¾‹ä¸­ä½¿ç”¨äº†åµŒå¥—çš„generator expressions, <code>$&lt;CONFIG:cfg&gt;</code>åµŒå¥—åœ¨<code>$&lt;IF:?,true-value...,false-value...&gt;</code>, ä¸¤è€…éƒ½æ˜¯logical expressions, æ³¨æ„åè€…æ˜¯CMake 3.8æ‰æœ‰çš„ã€‚<code>$&lt;CONFIG:Debug&gt;</code>çš„æ„æ€æ˜¯å¦‚æœ<code>CONFIG</code>æ˜¯<code>Debug</code>,é‚£ä¹ˆè¿™ä¸ªè¡¨è¾¾å¼çš„å€¼æ˜¯<code>1</code>,å¦åˆ™æ˜¯<code>0</code>, æ³¨æ„è¿™ä¸ªæ¯”è¾ƒæ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„å­—ç¬¦ä¸²æ¯”è¾ƒã€‚<code>$&lt;IF:?,true-value...,false-value...&gt;</code>å°±åƒä¸‰å…ƒè¡¨è¾¾å¼<code>a ? b : c</code>ä¸€æ ·ã€‚</p>
<p>æ³¨æ„<code>0</code>å’Œ<code>1</code>æ˜¯ä¸¤ä¸ªbasic logical expressions,æ‰€æœ‰å…¶å®ƒlogical expressionsçš„æœ€ç»ˆå€¼éƒ½æ˜¯<code>0</code>æˆ–<code>1</code>,æ‰€ä»¥ä¸‹é¢çš„è¡¨è¾¾å¼æ˜¯æœ‰æ•ˆçš„</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo></mrow><annotation encoding="application/x-tex">&lt;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span></span></span></span><a href="CONFIG:Debug">CONFIG:Debug</a>:DEBUG_MODE&gt;</p>
<p>å®ƒå±•å¼€åæ˜¯<code>$&lt;0:DEBUG_MODE&gt;</code>æˆ–<code>$&lt;1:DEBUG_MODE&gt;</code>,æ‰€ä»¥æ•´ä¸ªè¡¨è¾¾å¼æœ€ç»ˆå€¼æ˜¯<code>DEBUG_MODE</code>æˆ–ç©ºã€‚</p>
<h2 id="find_package"><a class="markdownIt-Anchor" href="#find_package"></a> <code>find_package()</code></h2>
<p>å¦‚æœcmakeå¯ä»¥æˆåŠŸæ‰§è¡Œ <code>find_package(PACKAGE)</code>ï¼Œé‚£ä¹ˆè¯´æ˜ä½ çš„ç³»ç»Ÿä¸Šä¸€å®šå­˜åœ¨ä¸€ä¸ª <code>FindPACKAGE.cmake</code>çš„æ–‡ä»¶</p>
<ul>
<li><code>find_package(Threads REQUIRED)</code>: FindThreads.cmake æ–‡ä»¶ç¡®å®šä¸€ä¸ªç³»ç»Ÿä¸Šçš„ thread åº“ï¼Œå¦‚æœåœ¨Linux ä¸‹ï¼Œå¦‚æœæ‰¾åˆ°çš„è¯å°±æ˜¯ <code>libpthread.so</code> (C++ std::thread ä¾èµ– <code>libpthread.so</code>)</li>
</ul>
<h2 id="pkg_check_modules"><a class="markdownIt-Anchor" href="#pkg_check_modules"></a> <code>pkg_check_modules()</code></h2>
<p>ä½¿ç”¨ <code>pkg_check_modules()</code> å‰éœ€è¦å…ˆ(å› ä¸ºpkg_check_modules() åº•å±‚æ˜¯ä¾é  pkg-config)</p>
<ul>
<li><code>find_package(PkgConfig)</code></li>
</ul>
<p>ä¾‹å¦‚æ‰¾åˆ°ç³»ç»Ÿä¸Šçš„ <a href="http://libdrm.so">libdrm.so</a> (å› ä¸ºcmakeå’Œlibdrmæœ¬èº«æ²¡æœ‰æä¾› FindLibDRM.cmake), å°±éœ€è¦</p>
<ul>
<li><code>pkg_check_modules(LIBDRM REQUIRED libdrm)</code></li>
</ul>
<p>è¿™é‡Œ <code>LIBDRM</code> æ˜¯è‡ªå®šä¹‰çš„ï¼Œä½†è¦ä¸åé¢ä½¿ç”¨çš„å˜é‡åå¯¹é½ï¼Œ<a href="http://xn--libdrm-hh4kt54g.so">å¦‚æœlibdrm.so</a> è¢«æ‰¾åˆ°ï¼Œåˆ™ä»¥ä¸‹å˜é‡ä¼šè¢«ç½®æˆç›¸åº”çš„è·¯å¾„æˆ–å€¼(åŸºæœ¬ä¸Šå°±æ˜¯pkg-config èƒ½æŸ¥åˆ°çš„æ‰€æœ‰ä¿¡æ¯)</p>
<ul>
<li>LIBDRM_FOUND</li>
<li>LIBDRM_LIBRARIES</li>
<li>LIBDRM_LIBRARY_DIRS</li>
<li>LIBDRM_LDFLAGS</li>
<li>LIBDRM_LDFLAGS_OTHER</li>
<li>LIBDRM_INCLUDE_DIRS</li>
<li>LIBDRM_CFLAGS</li>
<li>LIBDRM_CFLAGS_OTHER</li>
</ul>
<h2 id="ctest"><a class="markdownIt-Anchor" href="#ctest"></a> CTest</h2>
<ul>
<li>
<p>æ‰“å¼€CTest, åç»­å¯ä»¥ç›´æ¥é€šè¿‡ <code>make [-C builddir] test</code> è¿è¡Œæµ‹è¯•ç”¨ä¾‹</p>
<ul>
<li><code>enable_testing()</code></li>
</ul>
</li>
<li>
<p>å¢åŠ æµ‹è¯•ç”¨ä¾‹</p>
<ul>
<li><code>add_test(NAME PALBench.test_cpu_read_vram COMMAND test_cpu_access_vram -size 1048576 -access read)</code></li>
</ul>
</li>
</ul>
<h1 id="notes"><a class="markdownIt-Anchor" href="#notes"></a> NOTES</h1>
<h2 id="-fpic"><a class="markdownIt-Anchor" href="#-fpic"></a> -fPIC</h2>
<ul>
<li>-fPIC æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨é€‰é¡¹ï¼Œè€Œä¸æ˜¯é“¾æ¥å™¨é€‰é¡¹ã€‚</li>
<li>å½“ä½ æ­£åœ¨æ„å»ºçš„ä¸€ä¸ªåŠ¨æ€åº“(<a href="http://xn--libPAL-hh4k.so">å¦‚libPAL.so</a>)ä¾èµ–å¦ä¸€ä¸ªé™æ€åº“(å¦‚libADT.a), è¿™æ—¶å¿…é¡»åœ¨ <code>add_library(ADT STATIC ...)</code> ä¹‹åå¢åŠ ç¼–è¯‘é€‰é¡¹ <code>-fPIC</code>, è¿™æ—¶éœ€è¦ä½¿ç”¨
<ul>
<li><code>target_compile_options(ADT PRIVATE &quot;-fPIC&quot;)</code><br />
è€Œä¸æ˜¯</li>
<li><code>target_link_options(ADT PUBLIC &quot;-fPIC&quot;)</code></li>
</ul>
</li>
</ul>
<h2 id="_gnu_source"><a class="markdownIt-Anchor" href="#_gnu_source"></a> _GNU_SOURCE</h2>
<ul>
<li>ç¼–è¯‘å™¨è«åå…¶å¦™åœ°æŠ¥undeclaredé”™è¯¯ï¼Œå¦‚ <code>O_CLOEXEC</code> æœªå£°æ˜ï¼Œå³ä½¿å·²ç»åŒ…å«äº†å®ƒçš„å¤´æ–‡ä»¶ <code>fcntl.h</code> ä¹Ÿè¿˜æŠ¥ï¼Œè¿™å¯èƒ½éœ€è¦å®šä¹‰ä¸€ä¸‹<code>_GNU_SOURCE</code>:
<ul>
<li><code>target_compile_definitions(target PUBLIC _GNU_SOURCE)</code></li>
</ul>
</li>
</ul>
<h1 id="å°è´´å£«"><a class="markdownIt-Anchor" href="#å°è´´å£«"></a> å°è´´å£«</h1>
<ul>
<li><code>time ninja -C build | while read line; do echo $(date +%s.%N) $&#123;line&#125;; done</code>
<ul>
<li>è¾“å‡ºç¼–è¯‘æ—¶é—´</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>find</title>
    <url>/utils/find/</url>
    <content><![CDATA[<h1 id="find-å‘½ä»¤"><a class="markdownIt-Anchor" href="#find-å‘½ä»¤"></a> <code>find</code> å‘½ä»¤</h1>
<p><code>find</code> å‘½ä»¤ç”¨æ¥åœ¨ç›®å½•æ ‘é‡ŒæŸ¥æ‰¾æ–‡ä»¶ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç» GNU find. å®ƒä»æ¯ä¸ª starting-point å¼€å§‹é€’å½’æœç´¢ï¼Œé€šè¿‡æ±‚å€¼ expression çš„çœŸå€¼æ¥ç¡®å®šè¾“å‡ºç»“æœã€‚</p>
<h1 id="find-çš„å‘½ä»¤è¡Œç»„æˆ"><a class="markdownIt-Anchor" href="#find-çš„å‘½ä»¤è¡Œç»„æˆ"></a> <code>find</code> çš„å‘½ä»¤è¡Œç»„æˆ</h1>
<p><img src="/images/find/find.drawio.png" alt="example-of-find" /></p>
<ul>
<li>Options</li>
<li>Starting-point</li>
<li>Expression
<ul>
<li>Tests</li>
<li>Actions</li>
<li>Global options</li>
<li>Position options</li>
<li>Operators</li>
</ul>
</li>
</ul>
<h1 id="examples"><a class="markdownIt-Anchor" href="#examples"></a> Examples</h1>
<ul>
<li>
<p>åªåœ¨å½“å‰ç›®å½•æœç´¢ï¼ˆä¸é€’å½’ï¼‰ä¸ä»¥ f æˆ– g æˆ– h å¼€å¤´çš„ç›®å½•</p>
<ul>
<li><code>find . -maxdepth 1 -name '[^fgh]*' -type d</code>
<ul>
<li><code>-type d</code>: æ‰¾ç›®å½•</li>
<li><code>-type f</code>: æ‰¾æ–‡ä»¶(ä¸åŒ…æ‹¬ symbolic link)</li>
<li><code>-type l</code>: æ‰¾ç¬¦å·é“¾æ¥æ–‡ä»¶</li>
</ul>
</li>
</ul>
</li>
<li>
<p>æ’é™¤/proc å’Œ /tmp è¿™ä¸¤ä¸ªç›®å½•</p>
<ul>
<li><code>find / -path /proc -prune -o -path /tmp -prune -o -name &quot;README.md&quot;</code>
<ul>
<li><code>-prune</code> å‘Šè¯‰ find è·³è¿‡å‰é¢çš„ç›®å½•ï¼Œä¹Ÿå¯ä»¥ç”¨ <code>\( -o \)</code> å°†å¤šä¸ª <code>-path</code> åˆå¹¶ï¼Œåªä¿ç•™ä¸€ä¸ª <code>-prune</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>åªåœ¨å½“å‰ç›®å½•æŸ¥æ‰¾é™¤äº†æŒ‡å®šåŠéšè—ç›®å½•ä»¥å¤–çš„æ‰€æœ‰ç›®å½•ï¼Œæ‰“å°å¹¶åˆ é™¤</p>
<ul>
<li><code>find -maxdepth 1 \( -path ./gh -o -path ./aaa -o -path ./mesa-install -o -path ./1.3.290.0 -o -path ./1.3.280.1 \) -prune -o -type d ! -name &quot;.*&quot; -print -exec rm -rf &#123;&#125; \;</code>
<ul>
<li>æ³¨æ„åŒ¹é…éšè—ç›®å½•æ—¶ç”¨ <code>.*</code>, <code>.</code> åœ¨ shell é‡Œä¸æ˜¯é€šé…ç¬¦</li>
<li><code>-print</code>ï¼š ä¸è®© <code>./gh</code>, <code>./aaa</code> è¿™äº›ç›®å½•å‡ºç°åœ¨ <code>find</code> å‘½ä»¤çš„è¾“å‡ºç»“æœä¸­</li>
</ul>
</li>
</ul>
</li>
<li>
<p>æŸ¥æ‰¾ ~/gh ç›®å½•ä¸‹åªæœ‰æ–‡ä»¶å±ä¸»(u)æœ‰æ‰§è¡Œæƒé™(x)çš„æ–‡ä»¶ (ç²¾ç¡®åŒ¹é…æ–‡ä»¶çš„ permission bits)</p>
<ul>
<li><code>find ~/gh -perm u=x -type f</code></li>
</ul>
</li>
<li>
<p>æŸ¥æ‰¾ ~/gh ç›®å½•ä¸‹æ–‡ä»¶å±ä¸»(u)æœ‰æ‰§è¡Œæƒé™(x) çš„æ–‡ä»¶ï¼ˆç»„ç”¨æˆ·(g)æˆ–å…¶å®ƒç”¨æˆ·(o)å¯èƒ½æœ‰æˆ–æ²¡æœ‰æ‰§è¡Œæƒé™ï¼‰</p>
<ul>
<li><code>find ~/gh -perm -u=x -type f</code></li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>GNU Debugger - gdb</title>
    <url>/utils/gdb/</url>
    <content><![CDATA[<h1 id="gdb-cheat-sheet"><a class="markdownIt-Anchor" href="#gdb-cheat-sheet"></a> <a href="https://github.com/lucmann/x-cheatsheet">GDB Cheat Sheet</a></h1>
<p><img src="/images/gdb/gdb-cheatsheet-1.png" alt="gdb cheatsheet1" /></p>
<span id="more"></span>
<p><img src="/images/gdb/gdb-cheatsheet-2.png" alt="gdb cheatsheet2" /></p>
<h1 id="gdb-init-file"><a class="markdownIt-Anchor" href="#gdb-init-file"></a> GDB Init File</h1>
<p>GDB Init File åŒ…å«ä¸€ç»„ gdb å‘½ä»¤ï¼Œæ¯æ¬¡å¯åŠ¨ gdb æ—¶è‡ªåŠ¨æ‰§è¡Œï¼Œè¿™ä¸ªæ–‡ä»¶å¯ä»¥æœ‰ 3 ä¸ªä½ç½®</p>
<ul>
<li><code>~/.config/gdb/gdbinit</code></li>
<li><code>~/.gdbinit</code></li>
<li><code>./.gdbinit</code></li>
</ul>
<h1 id="gdb-script-file"><a class="markdownIt-Anchor" href="#gdb-script-file"></a> GDB Script File</h1>
<p>å°†ä¸‹é¢çš„ gdb å‘½ä»¤å†™å…¥ä¸€ä¸ª script æ–‡ä»¶é‡Œ <code>gdbscript.txt</code>ï¼Œæ‰§è¡Œ <code>gdb glxgears -x gdbscript.txt</code>, gdb ä¼šè‡ªåŠ¨æ‰§è¡Œè¿™ä¸ª script æ–‡ä»¶é‡Œçš„å‘½ä»¤ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Avoid keyboard input</span><br><span class="line">set pagination off</span><br><span class="line"></span><br><span class="line"># Save log to file</span><br><span class="line">set logging file llvmpipe.log</span><br><span class="line">set logging enabled on</span><br><span class="line"></span><br><span class="line"># Avoid prompt that &quot;Make breakpoint pending on future shared library load?&quot;</span><br><span class="line">set breakpoint pending on</span><br><span class="line"></span><br><span class="line"># Add breakpoint at llvmpipe_flush()</span><br><span class="line">break llvmpipe_flush</span><br><span class="line">    command 1</span><br><span class="line">    shell date +&quot;%T.%3N&quot; &gt;&gt; llvmpipe.log # Append a timestamp to log file</span><br><span class="line">    backtrace</span><br><span class="line">    continue</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"># Start the program</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line">continue</span><br><span class="line"></span><br><span class="line">set logging off</span><br><span class="line">quit</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>P.S. <a href="https://pastebin.com/bCEBrwAW">llvmpipe.log</a></p>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>Debugger</tag>
      </tags>
  </entry>
  <entry>
    <title>GNU Compiler Collection - gcc/g++</title>
    <url>/utils/gcc/</url>
    <content><![CDATA[<h1 id="__attribute__"><a class="markdownIt-Anchor" href="#__attribute__"></a> <code>__attribute__</code></h1>
<p><code>__attribute__</code> is a keyword introduced by GCC. It is regarded as an extension of a language. It helps the compiler optimize calls, check code more carefully for correctness, control memory placement and code generation options.</p>
<span id="more"></span>
<h2 id="syntax"><a class="markdownIt-Anchor" href="#syntax"></a> Syntax</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__attribute__ ((attribute-list))</span><br></pre></td></tr></table></figure>
<p>where an attribute-list is a possibly empty comma-separated sequence of attributes. Say:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">static void _init( void ) __attribute__((constructor));</span><br></pre></td></tr></table></figure>
<h2 id="categories"><a class="markdownIt-Anchor" href="#categories"></a> Categories</h2>
<ul>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Function-Attributes.html#Function-Attributes">Function Attributes</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Variable-Attributes.html#Variable-Attributes">Variable Attribute</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Type-Attributes.html#Type-Attributes">Type Attributes</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Label-Attributes.html#Label-Attributes">Label Attributes</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Enumerator-Attributes.html#Enumerator-Attributes">Enumerator Attributes</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Statement-Attributes.html#Statement-Attributes">Statement Attributes</a></li>
</ul>
<p>Letâ€™s say to specify an attribute of variables.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">extern __thread struct _glapi_table * _glapi_tls_Dispatch</span><br><span class="line">    __attribute__((tls_model(&quot;initial-exec&quot;)));</span><br></pre></td></tr></table></figure>
<p>where the <code>tls_model</code> attribute sets thread-local storage model of a particular thread variable, overriding <code>-ftls-model=</code> command-line switch on a per-variable basis. The <a href="https://docs.oracle.com/cd/E53394_01/html/E54813/man-tlsam.html#scrolltoc"><code>tls_model</code></a> argument should be one of <code>global-dynamic</code>, <code>local-dynamic</code>, <code>initial-exec</code>, or <code>local-exec</code>.</p>
<h3 id="visibility"><a class="markdownIt-Anchor" href="#visibility"></a> <a href="http://anadoxin.org/blog/control-over-symbol-exports-in-gcc.html">Visibility</a></h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__attribute__((visibility(&quot;default&quot;)));</span><br></pre></td></tr></table></figure>
<p>this attribute involves with the visibility of exported symbols in a shared object, overriding <code>-fvisibility=hidden</code> command-line option during the compilation. The visibility argument should be one of <code>default</code>, <code>hidden</code>, <code>internal</code>, or <code>protected</code>.</p>
<h1 id="å†…ç½®å®"><a class="markdownIt-Anchor" href="#å†…ç½®å®"></a> å†…ç½®å®</h1>
<p>ç¼–è¯‘å™¨ä¼šé¢„å®šä¹‰è®¸å¤šå®ï¼Œå°¤å…¶åœ¨äº¤å‰ç¼–è¯‘æ—¶ï¼Œä¸åŒçš„å·¥å…·é“¾ç¼–è¯‘å™¨ä¼šå®šä¹‰ä¸åŒçš„å®ã€‚ä¾‹å¦‚:</p>
<ul>
<li><strong>aarch64</strong></li>
<li>__ARM_ARCH_7A</li>
<li>__ARM_ARCH_8A</li>
</ul>
<p>å¦‚æœä½¿ç”¨<strong>armv7</strong>çš„å·¥å…·é“¾ï¼Œé‚£ä¹ˆåªæœ‰<code>__ARM_ARCH_7A</code>ä¼šè¢«å®šä¹‰ï¼Œè€Œå¦‚æœä½¿ç”¨<strong>armv8</strong>çš„å·¥å…·é“¾ï¼Œé‚£ä¹ˆåªæœ‰<code>__ARM_ARCH_8A</code>ä¼šè¢«å®šä¹‰ã€‚ä½†ä»¥ä¸Šä¸¤ä¸ªç¼–è¯‘å™¨éƒ½ä¼šå®šä¹‰<code>__aarch64__</code>.</p>
<h2 id="how-to-check-macros-predefined-by-compiler"><a class="markdownIt-Anchor" href="#how-to-check-macros-predefined-by-compiler"></a> How to Check Macros Predefined by Compiler</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">aarch64-linux-gnu-gcc -march=armv8-a -E -dM - &lt; /dev/null</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-E</code> æ˜¯<code>gcc</code>çš„ä¸€ä¸ª<code>common option</code>, æŒ‡ç¤ºç¼–è¯‘å™¨åªåšé¢„å¤„ç†</li>
<li><code>-d&lt;letters&gt;</code> æ˜¯<code>gcc</code>çš„ä¸€ä¸ª<code>common option</code>, æ‰“å¼€ç”±å­—æ¯æŒ‡å®šçš„compiler passçš„dump
<ul>
<li><code>-dM</code> æ‰“å°é¢„å¤„ç†é˜¶æ®µæ‰€æœ‰çš„å®<code>#define</code>, åŒ…æ‹¬é¢„å®šä¹‰å®ã€‚</li>
<li><code>-dD</code> åŠŸèƒ½å’Œ<code>-dM</code>ç±»ä¼¼ï¼Œä½†å®ƒä¸åŒ…å«é¢„å®šä¹‰å®ï¼Œè€Œä¸”å®ƒåŒæ—¶è¾“å‡º<code>#define</code>å’Œé¢„å¤„ç†ç»“æœã€‚</li>
<li><code>-dN</code> åŠŸèƒ½å’Œ<code>-dD</code>ç±»ä¼¼ï¼Œä½†åªè¾“å‡ºå®åï¼Œä¸å±•å¼€å®ã€‚</li>
<li><code>-dI</code> é™¤äº†é¢„å¤„ç†ç»“æœå¤–ï¼Œè¿˜è¾“å‡º<code>#include</code>.</li>
<li><code>-dU</code> åŠŸèƒ½å’Œ<code>-dD</code>ç±»ä¼¼ï¼Œä½†åªè¾“å‡ºé‚£äº›è¢«å±•å¼€çš„å®æˆ–åœ¨é¢„å¤„ç†ä¸­è¢«<code>#if</code>, <code>#ifndef</code>æµ‹è¯•è¿‡çš„å®ã€‚</li>
</ul>
</li>
</ul>
<h2 id="__builtin_offsetof"><a class="markdownIt-Anchor" href="#__builtin_offsetof"></a> <a href="https://gcc.gnu.org/onlinedocs/gcc/Offsetof.html"><code>__builtin_offsetof</code></a></h2>
<ul>
<li>C/C++ å® <code>offsetof</code> åŒ…å«åœ¨å¤´æ–‡ä»¶ <code>stddef.h</code></li>
</ul>
<h1 id="å†…ç½®å‡½æ•°"><a class="markdownIt-Anchor" href="#å†…ç½®å‡½æ•°"></a> å†…ç½®å‡½æ•°</h1>
<h2 id="__builtin_clz"><a class="markdownIt-Anchor" href="#__builtin_clz"></a> <a href="https://gcc.gnu.org/onlinedocs/gcc/Other-Builtins.html"><code>__builtin_clz</code></a></h2>
<p><code>int __builtin_clz(unsigned int x);</code></p>
<p>è¿”å›ä¸€ä¸ªæ•°çš„é«˜ä½ç«¯çš„ <code>0</code> çš„ä¸ªæ•°</p>
<h2 id="åŸå­æ“ä½œå‡½æ•°æ—"><a class="markdownIt-Anchor" href="#åŸå­æ“ä½œå‡½æ•°æ—"></a> <a href="https://gcc.gnu.org/onlinedocs/gcc/_005f_005fatomic-Builtins.html">åŸå­æ“ä½œå‡½æ•°æ—</a></h2>
<ul>
<li><code>type __atomic_add_fetch(type *ptr, type val, int memorder)</code></li>
</ul>
<p>ä»¥åŸå­æ–¹å¼ç»™ <code>ptr</code> æŒ‡å‘çš„å†…å­˜å€¼åŠ ä¸Š <code>val</code>, å¹¶è¿”å› <code>ptr</code> æŒ‡å‘å†…å­˜åŠ å®Œåçš„å€¼ã€‚å®ƒä¸ GCC çš„ <code>__sync_add_and_fetch()</code> æœ‰ä½•åŒºåˆ«å‘¢ï¼Ÿ å”¯ä¸€çš„åŒºåˆ«æ˜¯ <code>__atomic_add_fetch</code> æ›´æ–°ã€‚</p>
<ul>
<li><code>bool __atomic_compare_exchange_n(type *ptr, type *expected, type desired, bool weak, int success_memorder, int failure_memorder)</code></li>
</ul>
<p>åŸå­ CAS æ“ä½œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if (*ptr == *expected); then</span><br><span class="line">   *ptr = desired  // read-modify-write</span><br><span class="line">else</span><br><span class="line">   *expected = *ptr // read</span><br></pre></td></tr></table></figure>
<p><code>type __sync_val_compare_and_swap (type *ptr, type oldval, type newval, ...)</code></p>
<p>å†…ç½®çš„åŸå­æ¯”è¾ƒå’Œäº¤æ¢æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ <code>*ptr</code> çš„å½“å‰å€¼æ˜¯ <code>oldval</code>, åˆ™æŠŠ <code>newval</code> å†™å…¥ <code>*ptr</code>, å¹¶ä¸”è¿”å›å†™å…¥å‰çš„ <code>*ptr</code> å€¼ã€‚</p>
<h1 id="ä¸ç¼–è¯‘å™¨ç›¸å…³çš„-keywords"><a class="markdownIt-Anchor" href="#ä¸ç¼–è¯‘å™¨ç›¸å…³çš„-keywords"></a> ä¸ç¼–è¯‘å™¨ç›¸å…³çš„ keywords</h1>
<h2 id="volatile-vs-register"><a class="markdownIt-Anchor" href="#volatile-vs-register"></a> volatile vs. register</h2>
<table>
<thead>
<tr>
<th style="text-align:left">volatile</th>
<th style="text-align:left">register</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">type qualifier</td>
<td style="text-align:left">storage class</td>
</tr>
<tr>
<td style="text-align:left">force (compiler)</td>
<td style="text-align:left">hint (compiler)</td>
</tr>
<tr>
<td style="text-align:left">latency</td>
<td style="text-align:left">fast</td>
</tr>
<tr>
<td style="text-align:left">OK for global variables</td>
<td style="text-align:left">NOT for global variables</td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>Compiler</tag>
      </tags>
  </entry>
  <entry>
    <title>Git Cheat Sheet</title>
    <url>/utils/git/</url>
    <content><![CDATA[<pre><code class="highlight mermaid">gitGraph
  commit id: &quot;1(good)&quot;
  commit id: &quot;2&quot;
  commit id: &quot;3&quot;
  branch test-commit-4
  commit id: &quot;4(good)&quot;
  branch test-commit-5-if-commit-6-is-bad
  commit id: &quot;5(first bad)&quot;
  branch test-commit-6-if-commit-4-is-good
  commit id: &quot;6(bad)&quot;
  commit id: &quot;7(bad)&quot;</code></pre>
<span id="more"></span>
<h1 id="git-am"><a class="markdownIt-Anchor" href="#git-am"></a> git am</h1>
<ul>
<li><code>git am foo.patch</code>
<ul>
<li>åº”ç”¨è¡¥ä¸ foo.patch (æ³¨æ„ä¸ <code>git apply</code> çš„åŒºåˆ«ï¼Œ<code>git am</code> åŒæ—¶ä¼šå°†commit log ä¹Ÿåº”ç”¨ä¸Šå»)</li>
</ul>
</li>
<li><code>git am -i -3 /tmp/patches/*</code>
<ul>
<li><code>-i</code>ï¼šäº¤äº’å¼åœ° apply patch, å³æ¯ä¸ª Patch éƒ½è¯¢é—® <em>Apply? [y]es/[n]o/[e]dit/[v]iew patch/[a]ccept all:</em></li>
<li><code>-3</code>: å½“æœ‰å†²çªæ—¶è¿›å…¥ 3way merge æ¨¡å¼ï¼Œå³å…è®¸ä½ æ‰‹åŠ¨è§£å†³å†²çª(å¦‚æœ git è‡ªåŠ¨è§£å†³ä¸äº†)ï¼Œç„¶å <code>git am -i --continue</code></li>
</ul>
</li>
</ul>
<h1 id="git-bisect"><a class="markdownIt-Anchor" href="#git-bisect"></a> git bisect</h1>
<ul>
<li><code>git bisect start &lt;end-commit&gt; &lt;start-commit&gt;</code>
<ul>
<li>ä¸€èˆ¬ <em>end-commit</em> æ˜¯æœ€è¿‘çš„æäº¤(å¦‚ HEAD), <em>start-commit</em> æ˜¯æ¯”è¾ƒè€çš„æäº¤</li>
<li>æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œä»£ç åº“ä¼š checkout åˆ°è¿™ä¸ªèŒƒå›´<strong>æ­£å½“ä¸­</strong>çš„é‚£ä¸ªæäº¤ï¼Œæ¥ä¸‹æ¥ä½ å¯ä»¥åšä¸€äº›æµ‹è¯•å’ŒéªŒè¯</li>
</ul>
</li>
<li><code>git bisect good</code> æˆ– <code>git bisect bad</code>
<ul>
<li>æ ¹æ®å‰é¢æµ‹è¯•çš„ç»“æœï¼Œè®¾ç½®å½“å‰çš„æäº¤æ˜¯ <em>good</em> è¿˜æ˜¯ <em>bad</em></li>
<li>å¦‚æ­¤é‡å¤å‰ä¸¤æ­¥ï¼Œç›´åˆ°æ‰¾åˆ°é—®é¢˜æäº¤</li>
</ul>
</li>
<li><code>git bisect log &gt; file.txt</code>
<ul>
<li>æ‰“å°å‡ºå‰ä¸¤æ­¥çš„è¿‡ç¨‹è®°å½•</li>
</ul>
</li>
<li><code>git bisect replay file.txt</code>
<ul>
<li>å°† bisect è¿‡ç¨‹è®°å½•åŠ ä»¥ä¿®æ”¹ï¼Œé‡æ–°æ‰§è¡Œ</li>
</ul>
</li>
<li><code>git bisect reset</code>
<ul>
<li>å°†ä»“åº“ç”±<strong>äºŒåˆ†æŸ¥æ‰¾</strong>çŠ¶æ€æ¢å¤åˆ°åŸæ¥çŠ¶æ€</li>
</ul>
</li>
</ul>
<h1 id="git-clone"><a class="markdownIt-Anchor" href="#git-clone"></a> git clone</h1>
<ul>
<li><code>git clone --recurse-submodules</code>
<ul>
<li>å…‹éš†ä»“åº“æ—¶è¿åŒå­ä»“åº“ä¸€åŒå…‹éš†</li>
</ul>
</li>
</ul>
<h1 id="git-describe"><a class="markdownIt-Anchor" href="#git-describe"></a> git describe</h1>
<ul>
<li>
<p><code>git describe &lt;commit&gt;</code></p>
<ul>
<li>æ‰¾åˆ°ç¦» <code>&lt;commit&gt;</code> æœ€è¿‘çš„ tag</li>
</ul>
</li>
<li>
<p><code>git describe --contains &lt;commit&gt;</code></p>
<ul>
<li>æ‰¾åˆ°<strong>åŒ…å«</strong> <code>&lt;commit&gt;</code> çš„ tag</li>
<li>ä¾‹ï¼š<code>git describe --contains a6149f03</code>
<ul>
<li><code>v6.8-rc1~111^2~23^2~81</code></li>
</ul>
</li>
<li>å®ƒå’Œä¸åŠ  <code>--contains</code> çš„åŒºåˆ«æ˜¯ï¼Œ<code>git describe</code> ä»…ä»…æ˜¯<strong>ç¦»å¾—æœ€è¿‘</strong>ï¼Œä»å‰å¾€åéƒ½ç®—ï¼Œè€Œ <code>git describe --contains</code> æ˜¯ <strong>åŒ…å«</strong>ï¼Œä¸Šé¢ä¾‹å­ä¸­å‘½ä»¤çš„è¾“å‡º <code>v6.8-rc1~111^2~23^2~81</code>ï¼Œ è¡¨ç¤ºåœ¨ v6.8 ä¸­ä¸€å®šåŒ…å« <code>a6149f03</code> è¿™ä¸ª commit, è€Œä¸”å®ƒæŒ‡å‡ºäº†å…·ä½“çš„ä½ç½®ï¼šä» <code>v6.8-rc1</code> è¿™ä¸ª tag çš„ commit å¾€åç¬¬ 111 ä¸ª commit (<code>^2</code> è¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ª <strong>merge commit</strong>), ä»è¿™ä¸ª merge commit å†å¾€åç¬¬ 23 ä¸ª commit (ä»ç„¶æ˜¯ä¸€ä¸ª merge commit), ä»è¿™ä¸ª commit å†å¾€åç¬¬ 81 ä¸ª commitï¼Œ å°±æ˜¯ <code>a6149f03</code></li>
</ul>
</li>
</ul>
<h1 id="git-for-each-ref"><a class="markdownIt-Anchor" href="#git-for-each-ref"></a> git for-each-ref</h1>
<ul>
<li>`git for-each-ref --sort=taggerdate --format=â€˜%(align:12)%(refname:short)%(end) | %(taggerdate:short)â€™ â€˜refs/tags/v6.17*â€™
<ul>
<li>
<p>æ ¼å¼åŒ–è¾“å‡ºæ‰€æœ‰ä»¥ <code>v6.17</code> å¼€å¤´çš„ tags</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">v6.17-rc1    | 2025-08-10</span><br><span class="line">v6.17-rc2    | 2025-08-17</span><br><span class="line">v6.17-rc3    | 2025-08-24</span><br><span class="line">v6.17-rc4    | 2025-08-31</span><br><span class="line">v6.17-rc5    | 2025-09-07</span><br><span class="line">v6.17-rc6    | 2025-09-14</span><br><span class="line">v6.17-rc7    | 2025-09-21</span><br><span class="line">v6.17        | 2025-09-28</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>git çš„ <code>--format</code> æƒ³è¦è¾¾åˆ° C printf çš„ <code>%-12s</code> çš„æ•ˆæœéœ€è¦ä½¿ç”¨ <code>%(align:N)%(fieldname:short)%(end)</code></p>
</li>
</ul>
</li>
</ul>
<h1 id="git-log"><a class="markdownIt-Anchor" href="#git-log"></a> git log</h1>
<ul>
<li><code>git log -S&lt;regex&gt; --pickaxe-regex /path/to/a/file</code>
<ul>
<li>æŸ¥æ‰¾åŒ¹é…çš„å­—ä¸²åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å‡ºç°çš„æ¬¡æ•°å‘ç”Ÿå˜åŒ–çš„ commit</li>
</ul>
</li>
<li><code>git log -G&lt;regex&gt; /path/to/a/file</code>
<ul>
<li>æŸ¥æ‰¾åˆ°æ¶‰åŠä¿®æ”¹æ–‡ä»¶ <code>file</code> çš„å†…å®¹åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ <regex> çš„ commit</li>
</ul>
</li>
<li><code>git log --diff-filter=D --summary --oneline</code>
<ul>
<li>æ‰¾å‡ºæœ‰æ–‡ä»¶åˆ é™¤è®°å½•çš„ commit, å¹¶æ˜¾ç¤ºå‡ºå“ªäº›æ–‡ä»¶è¢«åˆ é™¤</li>
<li>filters æœ‰:
<ul>
<li>A: Added</li>
<li>C: Copied</li>
<li>D: Deleted</li>
<li>M: Modified</li>
<li>R: Renamed</li>
</ul>
</li>
<li>å½“ filters ä½¿ç”¨å°å†™æ—¶ï¼Œè¡¨ç¤º<strong>ä¸åŒ…å«</strong>è¿™äº›å˜æ›´ç±»å‹</li>
</ul>
</li>
<li><code>git log --oneline --grep &quot;fix:&quot;</code>
<ul>
<li>tig ç±»ä¼¼çš„å‚æ•°æ˜¯ <code>--grep=&quot;fix:&quot;</code></li>
</ul>
</li>
</ul>
<h1 id="git-ls-remote"><a class="markdownIt-Anchor" href="#git-ls-remote"></a> git ls-remote</h1>
<ul>
<li><code>git ls-remote upstream</code>
<ul>
<li>å½“æœ‰å¤šä¸ª remote åŒæ—¶å­˜åœ¨æ—¶ï¼ŒæŒ‡å®šæŸ¥çœ‹æŸä¸ª remote çš„ refs</li>
</ul>
</li>
</ul>
<h1 id="git-remote"><a class="markdownIt-Anchor" href="#git-remote"></a> git remote</h1>
<ul>
<li><code>git remote prune &lt;remote&gt;</code>
<ul>
<li>å°†ç»™å®šçš„ <code>&lt;remote&gt;</code> è¿œç«¯ä¸å­˜åœ¨çš„<strong>æœ¬åœ°åˆ†æ”¯</strong>å…¨éƒ¨åˆ é™¤(æ³¨æ„: rm -rf è­¦å‘Šï¼Œæœ€å¥½å…ˆ <code>git remote prune --dry-run &lt;remote&gt;</code>)</li>
</ul>
</li>
</ul>
<h1 id="git-shortlog"><a class="markdownIt-Anchor" href="#git-shortlog"></a> git shortlog</h1>
<ul>
<li>`git shortlog -sne --author=â€œName Surnameâ€
<ul>
<li>ç»Ÿè®¡æŸä¸ªè´¡çŒ®è€…çš„æäº¤ï¼Œåƒè¿™æ ·ï¼š<code>17  Luc Ma &lt;luc@sietium.com&gt;</code></li>
</ul>
</li>
</ul>
<h1 id="git-submodule"><a class="markdownIt-Anchor" href="#git-submodule"></a> git submodule</h1>
<ul>
<li><code>git submodule init</code>
<ul>
<li>åœ¨ä¸»ä»“åº“åˆå§‹åŒ–ä¸€ä¸ªå­ä»“åº“</li>
</ul>
</li>
<li><code>git submodule update</code>
<ul>
<li>æ›´æ–°æ‰€æœ‰å­ä»“åº“
<ul>
<li><code>git submodule update --recursive</code>
<ul>
<li>é€’å½’åœ°æ›´æ–°æ‰€æœ‰å­ä»“åº“ï¼Œæœ‰æ—¶å€™å­ä»“åº“é‡Œåˆæœ‰å­ä»“åº“ï¼Œå¦‚<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Submodule path &#x27;thirdparty/snappy&#x27;: checked out &#x27;6af9287fbdb913f0794d0148c6aa43b58e63c8e3&#x27;</span><br><span class="line">Submodule path &#x27;thirdparty/snappy/third_party/benchmark&#x27;: checked out &#x27;d572f4777349d43653b21d6c2fc63020ab326db2&#x27;</span><br><span class="line">Submodule path &#x27;thirdparty/snappy/third_party/googletest&#x27;: checked out &#x27;b796f7d44681514f58a683a3a71ff17c94edb0c1&#x27;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>fatal: remote error: upload-pack: not our ref e15ab44e64c70b54fc375c019c95bddc066a84cf fatal: Fetched in submodule path 'submodules/ImGuiScope', but it did not contain e15ab44e64c70b54fc375c019c95bddc066a84cf. Direct fetching of that commit failed</code>
<ul>
<li>å¦‚æœä½ éœ€è¦åœ¨ä¸€ä¸ª submodule ä»“åº“é‡Œæ·»åŠ è‡ªå·±çš„ä¿®æ”¹ï¼Œé‚£ä¹ˆå¯èƒ½éœ€è¦å°† <code>.gitmodules</code> æ–‡ä»¶é‡Œå¯¹åº”ä»“åº“çš„ <code>url</code> å˜æˆä½ è‡ªå·±çš„<strong>è¿œç¨‹å¯å†™</strong>ä»“åº“çš„ URL</li>
</ul>
</li>
</ul>
<h1 id="gitignore"><a class="markdownIt-Anchor" href="#gitignore"></a> .gitignore</h1>
<h2 id="è®°å‡ ä¸ªä¸gitignoreç›¸å…³çš„å‘½ä»¤"><a class="markdownIt-Anchor" href="#è®°å‡ ä¸ªä¸gitignoreç›¸å…³çš„å‘½ä»¤"></a> è®°å‡ ä¸ªä¸gitignoreç›¸å…³çš„å‘½ä»¤ï¼š</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git check-ignore -v file # è¾“å‡ºfileæ˜¯å†™åœ¨å“ªä¸ª.gitignoreæ–‡ä»¶ä¸­</span><br><span class="line">git status -s --ignored # æŸ¥çœ‹æ‰€æœ‰è¢«ignoredçš„æ–‡ä»¶</span><br><span class="line">git ls-tree -r --name-only master # æŸ¥çœ‹æ‰€æœ‰è¢«trackedçš„æ–‡ä»¶</span><br><span class="line">git rm --cached file # æ°¸ä¹…æ’¤é”€å¯¹fileæ–‡ä»¶çš„è·Ÿè¸ª</span><br></pre></td></tr></table></figure>
<h2 id="è®°å‡ ä¸ªä¸gitignoreç›¸å…³çš„è¦ç‚¹"><a class="markdownIt-Anchor" href="#è®°å‡ ä¸ªä¸gitignoreç›¸å…³çš„è¦ç‚¹"></a> è®°å‡ ä¸ªä¸gitignoreç›¸å…³çš„è¦ç‚¹ï¼š</h2>
<ul>
<li>gitæ”¯æŒåµŒå¥—çš„<code>.gitignore</code>æ–‡ä»¶ï¼Œå°±æ˜¯è¯´å¯ä»¥åœ¨repoä¸‹çš„æŸä¸ªå­ç›®å½•é‡Œå†™ä¸€ä¸ª<code>.gitignore</code>æ–‡ä»¶ï¼Œä½†æ˜¯è¿™ä¸ª<code>.gitignore</code>åªèƒ½å½±å“è¿™ä¸ªç›®å½•ä¸‹çš„å†…å®¹</li>
<li><code>.gitignore</code>æ–‡ä»¶é‡Œçš„è®°å½•<em>åªå½±å“untracked</em>çš„æ–‡ä»¶ï¼Œå°±æ˜¯è¯´å¦‚æœæƒ³ignoreä¸€ä¸ªä¹‹å‰å·²ç»è·Ÿè¸ªäº†çš„æ–‡ä»¶ï¼Œå°±å¿…é¡»å…ˆå¯¹è¿™ä¸ªæ–‡ä»¶æ‰§è¡Œ<code>git rm --cached</code>ï¼Œå¦åˆ™å³ä½¿æŠŠè¿™ä¸ªæ–‡ä»¶å†™åˆ°<code>.gitignore</code>ä¸­ä¹Ÿä¸ç”Ÿæ•ˆã€‚è€Œä¸”ä¼šäº§ç”Ÿç–‘æƒ‘ï¼Œæ˜æ˜å·²ç»æŠŠæŸä¸ªæ–‡ä»¶åŠ åˆ°<code>.gitignore</code>ä¸­äº†ï¼Œä¸ºä»€ä¹ˆä»ç„¶è¢«è·Ÿè¸ª? è¿™æ—¶æœ€å¥½ä½¿ç”¨<code>git ls-tree -r --name-only master</code>å‘½ä»¤ç¡®è®¤é‚£ä¸ªæ–‡ä»¶æ˜¯å¦è¿˜åœ¨è¢«è·Ÿè¸ªã€‚</li>
</ul>
<h1 id="github"><a class="markdownIt-Anchor" href="#github"></a> GitHub</h1>
<h2 id="ssh-connect-to-host-githubcom-port-22-connection-timed-out"><a class="markdownIt-Anchor" href="#ssh-connect-to-host-githubcom-port-22-connection-timed-out"></a> <code>ssh: connect to host github.com port 22: Connection timed out</code></h2>
<p>ä¹‹å‰å¥½å¥½çš„ï¼Œçªç„¶ <code>git pull</code>, <code>git clone</code> ç­‰è¿™ä¸ªé”™è¯¯ï¼Œä¸¤ç§è§£å†³æ–¹æ³•</p>
<ul>
<li>ä¿®æ”¹ git é…ç½®</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git config --global &quot;url.ssh://git@ssh.github.com:443/.insteadOf&quot; git@github.com:</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¿®æ”¹ ssh é…ç½®</li>
</ul>
<figure class="highlight vim"><figcaption><span>~/.ssh/config</span></figcaption><table><tr><td class="code"><pre><span class="line">Host github.<span class="keyword">com</span></span><br><span class="line">    Hostname ssh.github.<span class="keyword">com</span></span><br><span class="line">    Port <span class="number">443</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>Blog using Hexo</title>
    <url>/utils/hexo/</url>
    <content><![CDATA[<h1 id="npm"><a class="markdownIt-Anchor" href="#npm"></a> npm</h1>
<p>hexo ä¾èµ–çš„å¾ˆå¤š nodejs åŒ…éƒ½è¿‡æœŸäº†ï¼Œä½†å‘ç°åœ¨Ubuntu 23.04 ä¸Šå¾ˆéš¾æ›´æ–°(ç¼–è¯‘node-sass è¦ç”¨çš„ python2 éƒ½éœ€è¦è‡ªå·±æºç ç¼–è¯‘å®‰è£…)ï¼Œç´¢æ€§å…ˆæç½®å§ã€‚</p>
<span id="more"></span>
<ul>
<li><code>npm install</code> æ…¢
<ul>
<li><code>npm config get registry</code></li>
<li><code>npm config set registry=https://registry.npmmirror.com</code></li>
</ul>
</li>
<li><code>FetchError: request to https://registry.npm.taobao.org/ansi-regex failed, reason: certificate has expired</code>
<ul>
<li><code>npm config set strict-ssl false</code></li>
<li><code>npm cache clean --force</code></li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>Installable Client Driver</title>
    <url>/utils/icd/</url>
    <content><![CDATA[<h1 id="æ¥è‡ª-chatgpt-çš„è§£é‡Š"><a class="markdownIt-Anchor" href="#æ¥è‡ª-chatgpt-çš„è§£é‡Š"></a> æ¥è‡ª <a href="https://openprompt.co/ChatGPT">ChatGPT</a> çš„è§£é‡Š</h1>
<h2 id="what-is-vulkan-icd"><a class="markdownIt-Anchor" href="#what-is-vulkan-icd"></a> What is Vulkan ICD?</h2>
<blockquote>
<p>Vulkan ICD (Installable Client Driver) is a software component that enables the Vulkan API (Application Programming Interface) to interact with the hardware of a computer system. Vulkan is a low-level graphics API developed by the Khronos Group, which provides developers with more control over hardware resources, leading to improved performance and efficiency in graphics-intensive applications such as video games. The Vulkan ICD is responsible for managing the communication between the Vulkan API and the graphics hardware of a system. It is typically provided by the manufacturer of the graphics card as a driver for the system.</p>
</blockquote>
<span id="more"></span>
<h2 id="what-is-opencl-icd"><a class="markdownIt-Anchor" href="#what-is-opencl-icd"></a> What is OpenCL ICD?</h2>
<blockquote>
<p>OpenCL ICD (Installable Client Driver) is a component of OpenCL (Open Computing Language) that enables a computer system to access the processing power of multiple devices, such as CPUs and GPUs, as a unified compute resource. OpenCL is a framework for programming heterogeneous systems, which means systems that consist of multiple processing units with different architectures. The OpenCL ICD manages the communication between the OpenCL API and the devices available on the system, allowing developers to write code that can run on a variety of devices. It provides flexibility to the developers in choosing the device based on the requirements of the application. The OpenCL ICD is typically provided by the manufacturer of the device as a driver for the system.</p>
</blockquote>
<h1 id="mesa-opencl-icd-ä¸-intel-opencl-icd-çš„å¯¹æ¯”"><a class="markdownIt-Anchor" href="#mesa-opencl-icd-ä¸-intel-opencl-icd-çš„å¯¹æ¯”"></a> <code>mesa-opencl-icd</code> ä¸ <code>intel-opencl-icd</code> çš„å¯¹æ¯”</h1>
<h2 id="mesa-opencl-icd"><a class="markdownIt-Anchor" href="#mesa-opencl-icd"></a> <code>mesa-opencl-icd</code></h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./etc/</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./etc/OpenCL/</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./etc/OpenCL/vendors/</span><br><span class="line">-rw-r--r-- root/root        19 2022-03-09 00:37 ./etc/OpenCL/vendors/mesa.icd</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./usr/</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./usr/lib/</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./usr/lib/x86_64-linux-gnu/</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./usr/lib/x86_64-linux-gnu/gallium-pipe/</span><br><span class="line">-rw-r--r-- root/root  10555528 2022-03-09 00:37 ./usr/lib/x86_64-linux-gnu/gallium-pipe/pipe_iris.so</span><br><span class="line">-rw-r--r-- root/root   7895008 2022-03-09 00:37 ./usr/lib/x86_64-linux-gnu/gallium-pipe/pipe_nouveau.so</span><br><span class="line">-rw-r--r-- root/root   6214144 2022-03-09 00:37 ./usr/lib/x86_64-linux-gnu/gallium-pipe/pipe_r300.so</span><br><span class="line">-rw-r--r-- root/root   7228928 2022-03-09 00:37 ./usr/lib/x86_64-linux-gnu/gallium-pipe/pipe_r600.so</span><br><span class="line">-rw-r--r-- root/root   7677888 2022-03-09 00:37 ./usr/lib/x86_64-linux-gnu/gallium-pipe/pipe_radeonsi.so</span><br><span class="line">-rw-r--r-- root/root   6449632 2022-03-09 00:37 ./usr/lib/x86_64-linux-gnu/gallium-pipe/pipe_swrast.so</span><br><span class="line">-rw-r--r-- root/root   6217504 2022-03-09 00:37 ./usr/lib/x86_64-linux-gnu/gallium-pipe/pipe_vmwgfx.so</span><br><span class="line">-rw-r--r-- root/root   1549288 2022-03-09 00:37 ./usr/lib/x86_64-linux-gnu/libMesaOpenCL.so.1.0.0</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./usr/share/</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./usr/share/bug/</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./usr/share/bug/mesa-opencl-icd/</span><br><span class="line">-rw-r--r-- root/root        44 2022-03-09 00:37 ./usr/share/bug/mesa-opencl-icd/control</span><br><span class="line">-rwxr-xr-x root/root       448 2022-03-09 00:37 ./usr/share/bug/mesa-opencl-icd/script</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./usr/share/doc/</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./usr/share/doc/mesa-opencl-icd/</span><br><span class="line">-rw-r--r-- root/root       823 2022-03-09 00:37 ./usr/share/doc/mesa-opencl-icd/changelog.Debian.gz</span><br><span class="line">-rw-r--r-- root/root     14241 2022-03-09 00:37 ./usr/share/doc/mesa-opencl-icd/copyright</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./usr/share/lintian/</span><br><span class="line">drwxr-xr-x root/root         0 2022-03-09 00:37 ./usr/share/lintian/overrides/</span><br><span class="line">-rw-r--r-- root/root        49 2022-03-09 00:37 ./usr/share/lintian/overrides/mesa-opencl-icd</span><br><span class="line">lrwxrwxrwx root/root         0 2022-03-09 00:37 ./usr/lib/x86_64-linux-gnu/libMesaOpenCL.so -&gt; libMesaOpenCL.so.1</span><br><span class="line">lrwxrwxrwx root/root         0 2022-03-09 00:37 ./usr/lib/x86_64-linux-gnu/libMesaOpenCL.so.1 -&gt; libMesaOpenCL.so.1.0.0</span><br></pre></td></tr></table></figure>
<h2 id="intel-opencl-icd"><a class="markdownIt-Anchor" href="#intel-opencl-icd"></a> <code>intel-opencl-icd</code></h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drwxr-xr-x root/root         0 2020-04-09 03:55 ./</span><br><span class="line">drwxr-xr-x root/root         0 2020-04-09 03:55 ./etc/</span><br><span class="line">drwxr-xr-x root/root         0 2020-04-09 03:55 ./etc/OpenCL/</span><br><span class="line">drwxr-xr-x root/root         0 2020-04-09 03:55 ./etc/OpenCL/vendors/</span><br><span class="line">-rw-r--r-- root/root        52 2020-04-09 03:55 ./etc/OpenCL/vendors/intel.icd</span><br><span class="line">drwxr-xr-x root/root         0 2020-04-09 03:55 ./usr/</span><br><span class="line">drwxr-xr-x root/root         0 2020-04-09 03:55 ./usr/bin/</span><br><span class="line">-rwxr-xr-x root/root    406064 2020-04-09 03:55 ./usr/bin/ocloc</span><br><span class="line">drwxr-xr-x root/root         0 2020-04-09 03:55 ./usr/lib/</span><br><span class="line">drwxr-xr-x root/root         0 2020-04-09 03:55 ./usr/lib/x86_64-linux-gnu/</span><br><span class="line">drwxr-xr-x root/root         0 2020-04-09 03:55 ./usr/lib/x86_64-linux-gnu/intel-opencl/</span><br><span class="line">-rw-r--r-- root/root   5049688 2020-04-09 03:55 ./usr/lib/x86_64-linux-gnu/intel-opencl/libigdrcl.so</span><br><span class="line">drwxr-xr-x root/root         0 2020-04-09 03:55 ./usr/share/</span><br><span class="line">drwxr-xr-x root/root         0 2020-04-09 03:55 ./usr/share/doc/</span><br><span class="line">drwxr-xr-x root/root         0 2020-04-09 03:55 ./usr/share/doc/intel-opencl-icd/</span><br><span class="line">-rw-r--r-- root/root       389 2020-04-09 03:55 ./usr/share/doc/intel-opencl-icd/changelog.Debian.gz</span><br><span class="line">-rw-r--r-- root/root      5085 2020-04-06 17:05 ./usr/share/doc/intel-opencl-icd/copyright</span><br></pre></td></tr></table></figure>
<p>å®‰è£… <code>*-opencl-icd</code> è½¯ä»¶åŒ…å¹¶ä¸ä¼šå®‰è£… OpenCL å¼€å‘ç›¸å…³å¤´æ–‡ä»¶ï¼š<code>&lt;CL/cl.h&gt;</code></p>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>Vulkan</tag>
      </tags>
  </entry>
  <entry>
    <title>lspci å­¦ä¹ ç¬”è®°</title>
    <url>/utils/lspci/</url>
    <content><![CDATA[<h1 id="ä¸-pci-è®¾å¤‡ç›¸å…³çš„ä¸€äº›-ids"><a class="markdownIt-Anchor" href="#ä¸-pci-è®¾å¤‡ç›¸å…³çš„ä¸€äº›-ids"></a> ä¸ PCI è®¾å¤‡ç›¸å…³çš„ä¸€äº› IDs</h1>
<ul>
<li>Device ID: 4 ä½åå…­è¿›åˆ¶æ•°å­—</li>
<li>Vendor ID: 4 ä½åå…­è¿›åˆ¶æ•°å­—</li>
<li>Domain ID: 4 ä½åå…­è¿›åˆ¶æ•°å­—</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">3772:00:00.0 0100: 1af4:1049 (rev 01)</span><br><span class="line">5401:00:00.0 0880: 1af4:105a (rev 01)</span><br><span class="line">b30b:00:00.0 0302: 1414:008e</span><br><span class="line">c4c5:00:00.0 0100: 1af4:1049 (rev 01)</span><br><span class="line">cdbf:00:00.0 0100: 1af4:1049 (rev 01)</span><br></pre></td></tr></table></figure>
<p><code>lspci -Dn</code> çš„è¾“å‡ºæ ¼å¼æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;domain&gt;:&lt;bus&gt;:&lt;slot&gt;.&lt;func&gt;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ <code>slot</code> å…¶å®å°±æ˜¯ <code>device</code>, è€Œä¸”åªåŒ…å« 2 ä½åå…­è¿›åˆ¶æ•°å­—ã€‚æˆ‘ä»¬å¯ä»¥ä» <code>lspci</code> çš„<a href="https://github.com/pciutils/pciutils/blob/master/lspci.c">æºç </a>çœ‹åˆ°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">show_slot_path</span><span class="params">(<span class="keyword">struct</span> device *d)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pci_dev</span> *<span class="title">p</span> =</span> d-&gt;dev;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (opt_path)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">bus</span> *<span class="title">bus</span> =</span> d-&gt;parent_bus;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">bridge</span> *<span class="title">br</span> =</span> bus-&gt;parent_bridge;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (br &amp;&amp; br-&gt;br_dev)</span><br><span class="line">	&#123;</span><br><span class="line">	  show_slot_path(br-&gt;br_dev);</span><br><span class="line">	  <span class="keyword">if</span> (opt_path &gt; <span class="number">1</span>)</span><br><span class="line">	    <span class="built_in">printf</span>(<span class="string">&quot;/%02x:%02x.%d&quot;</span>, p-&gt;bus, p-&gt;dev, p-&gt;func);</span><br><span class="line">	  <span class="keyword">else</span></span><br><span class="line">	    <span class="built_in">printf</span>(<span class="string">&quot;/%02x.%d&quot;</span>, p-&gt;dev, p-&gt;func);</span><br><span class="line">	  <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%02x:%02x.%d&quot;</span>, p-&gt;bus, p-&gt;dev, p-&gt;func);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>lspci ä¹‹æ‰€ä»¥åªä½¿ç”¨ 2 ä½åå…­è¿›åˆ¶æ•°å­—åˆ†åˆ«è¡¨ç¤º <code>bus</code>, <code>slot</code>(<code>dev</code>), æ˜¯å› ä¸ºå®ƒä»¬è¢«å®šä¹‰æˆ 8 ä½ä½å®½</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pci_dev</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pci_dev</span> *<span class="title">next</span>;</span>			<span class="comment">/* Next device in the chain */</span></span><br><span class="line">  u16 domain_16;			<span class="comment">/* 16-bit version of the PCI domain for backward compatibility */</span></span><br><span class="line">					<span class="comment">/* 0xffff if the real domain doesn&#x27;t fit in 16 bits */</span></span><br><span class="line">  u8 bus, dev, func;			<span class="comment">/* Bus inside domain, device and function */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* These fields are set by pci_fill_info() */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> known_fields;		<span class="comment">/* Set of info fields already known (see pci_fill_info()) */</span></span><br><span class="line">  u16 vendor_id, device_id;		<span class="comment">/* Identity of the device */</span></span><br><span class="line">  u16 device_class;			<span class="comment">/* PCI device class */</span></span><br><span class="line">  <span class="type">int</span> irq;				<span class="comment">/* IRQ number */</span></span><br><span class="line">  <span class="type">pciaddr_t</span> base_addr[<span class="number">6</span>];		<span class="comment">/* Base addresses including flags in lower bits */</span></span><br><span class="line">  <span class="type">pciaddr_t</span> size[<span class="number">6</span>];			<span class="comment">/* Region sizes */</span></span><br><span class="line">  <span class="type">pciaddr_t</span> rom_base_addr;		<span class="comment">/* Expansion ROM base address */</span></span><br><span class="line">  <span class="type">pciaddr_t</span> rom_size;			<span class="comment">/* Expansion ROM size */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pci_cap</span> *<span class="title">first_cap</span>;</span>		<span class="comment">/* List of capabilities */</span></span><br><span class="line">  <span class="type">char</span> *phy_slot;			<span class="comment">/* Physical slot */</span></span><br><span class="line">  <span class="type">char</span> *module_alias;			<span class="comment">/* Linux kernel module alias */</span></span><br><span class="line">  <span class="type">char</span> *label;				<span class="comment">/* Device name as exported by BIOS */</span></span><br><span class="line">  <span class="type">int</span> numa_node;			<span class="comment">/* NUMA node */</span></span><br><span class="line">  <span class="type">pciaddr_t</span> flags[<span class="number">6</span>];			<span class="comment">/* PCI_IORESOURCE_* flags for regions */</span></span><br><span class="line">  <span class="type">pciaddr_t</span> rom_flags;			<span class="comment">/* PCI_IORESOURCE_* flags for expansion ROM */</span></span><br><span class="line">  <span class="type">int</span> domain;				<span class="comment">/* PCI domain (host bridge) */</span></span><br><span class="line">  <span class="type">pciaddr_t</span> bridge_base_addr[<span class="number">4</span>];	<span class="comment">/* Bridge base addresses (without flags) */</span></span><br><span class="line">  <span class="type">pciaddr_t</span> bridge_size[<span class="number">4</span>];		<span class="comment">/* Bridge sizes */</span></span><br><span class="line">  <span class="type">pciaddr_t</span> bridge_flags[<span class="number">4</span>];		<span class="comment">/* PCI_IORESOURCE_* flags for bridge addresses */</span></span><br><span class="line">  u8 prog_if, rev_id;			<span class="comment">/* Programming interface for device_class and revision id */</span></span><br><span class="line">  u16 subsys_vendor_id, subsys_id;	<span class="comment">/* Subsystem vendor id and subsystem id */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pci_dev</span> *<span class="title">parent</span>;</span>		<span class="comment">/* Parent device, does not have to be always accessible */</span></span><br><span class="line">  <span class="type">int</span> no_config_access;			<span class="comment">/* No access to config space for this device */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Fields used internally */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pci_access</span> *<span class="title">access</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pci_methods</span> *<span class="title">methods</span>;</span></span><br><span class="line">  u8 *cache;				<span class="comment">/* Cached config registers */</span></span><br><span class="line">  <span class="type">int</span> cache_len;</span><br><span class="line">  <span class="type">int</span> hdrtype;				<span class="comment">/* Cached low 7 bits of header type, -1 if unknown */</span></span><br><span class="line">  <span class="type">void</span> *aux;				<span class="comment">/* Auxiliary data for use by the back-end */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pci_property</span> *<span class="title">properties</span>;</span>	<span class="comment">/* A linked list of extra properties */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pci_cap</span> *<span class="title">last_cap</span>;</span>		<span class="comment">/* Last capability in the list */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="xorg-config-ä¹‹-device-section"><a class="markdownIt-Anchor" href="#xorg-config-ä¹‹-device-section"></a> Xorg config ä¹‹ <code>Device</code> Section</h1>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Section &quot;Device&quot;</span><br><span class="line">Identifier &quot;name&quot;</span><br><span class="line">Driver &quot;driver&quot;</span><br><span class="line">BusID &quot;bus-id&quot;</span><br><span class="line">EndSection</span><br></pre></td></tr></table></figure>
<p><code>Device</code> Section ä¸­ <code>BusID</code> çš„æ ¼å¼æ˜¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PCI:bus:device:func</span><br></pre></td></tr></table></figure>
<h1 id="xorg-log-ä¸­çš„-pci-ä¿¡æ¯æ ¼å¼"><a class="markdownIt-Anchor" href="#xorg-log-ä¸­çš„-pci-ä¿¡æ¯æ ¼å¼"></a> Xorg log ä¸­çš„ PCI ä¿¡æ¯æ ¼å¼</h1>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">xf86Msg(X_PROBED, <span class="string">&quot;PCI:%s(%u@%u:%u:%u) %04x:%04x:%04x:%04x &quot;</span>, prim,</span><br><span class="line">        info-&gt;bus, info-&gt;domain, info-&gt;dev, info-&gt;func,</span><br><span class="line">        info-&gt;vendor_id, info-&gt;device_id,</span><br><span class="line">        info-&gt;subvendor_id, info-&gt;subdevice_id);</span><br></pre></td></tr></table></figure>
<p>æ—¥å¿—ä¸­çš„ PCI BusID æ ¼å¼æ˜¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bus@domain:device:func</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>Make Cheatsheet</title>
    <url>/utils/make/</url>
    <content><![CDATA[<figure class="highlight make"><table><tr><td class="code"><pre><span class="line">target ... : prerequisites ...</span><br><span class="line">  recipe</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<ul>
<li><strong>target â€¦</strong> è¯´æ˜åœ¨ä¸€æ¡è§„åˆ™é‡Œ target å¯ä»¥æœ‰å¤šä¸ª</li>
<li><strong>prerequisites</strong> å¯ä»¥ä¸ºç©º</li>
<li><strong>recipe</strong> å¯ä»¥ä¸ºç©º, è¿™æ—¶ make ç›¸åº”çš„ target ä¼šæç¤º
<ul>
<li><code>Nothing to be done for 'target'.</code></li>
<li>å¯ä»¥é€šè¿‡ <code>;</code> åˆ†å·æ˜¾ç¤ºåœ°æŒ‡å‡º recipe æ˜¯ç©º
<ul>
<li><code>target: ;</code></li>
</ul>
</li>
</ul>
</li>
<li>å¦‚æœ make å‘½ä»¤è¡Œæ²¡æœ‰æŒ‡å®šä»»ä½•ç›®æ ‡ï¼Œmake ä¼šå°† Makefile é‡Œè§£æå‡ºæ¥çš„<strong>ç¬¬ä¸€ä¸ªç›®æ ‡</strong>ä½œä¸ºé»˜è®¤ç›®æ ‡</li>
</ul>
<h1 id="make-åŸºæœ¬åŸç†"><a class="markdownIt-Anchor" href="#make-åŸºæœ¬åŸç†"></a> Make åŸºæœ¬åŸç†</h1>
<h2 id="static-pattern-rules"><a class="markdownIt-Anchor" href="#static-pattern-rules"></a> Static Pattern Rules</h2>
<figure class="highlight make"><table><tr><td class="code"><pre><span class="line">targets ...: target-pattern: prereq-patterns ...</span><br><span class="line">  recipe</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<h2 id="static-pattern-rules-vs-implicit-rules"><a class="markdownIt-Anchor" href="#static-pattern-rules-vs-implicit-rules"></a> Static Pattern Rules vs. Implicit Rules</h2>
<figure class="highlight make"><table><tr><td class="code"><pre><span class="line">target-pattern : prereq-patterns</span><br><span class="line">  recipe</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<h1 id="make-å¸¸ç”¨å‚æ•°"><a class="markdownIt-Anchor" href="#make-å¸¸ç”¨å‚æ•°"></a> Make å¸¸ç”¨å‚æ•°</h1>
<h2 id="-d-debugflags"><a class="markdownIt-Anchor" href="#-d-debugflags"></a> -d, --debug=FLAGS</h2>
<ul>
<li>æ‰€æœ‰æ”¯æŒçš„ FLAGS (å¤šä¸ª flags ç”¨<code>,</code> åˆ†å¼€)</li>
<li>Debug Level Specification (GNU Make 4.3)</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">æ ‡å¿—</th>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">a</td>
<td style="text-align:left">All</td>
<td style="text-align:left">å¯ç”¨æ‰€æœ‰è°ƒè¯•è¾“å‡ºï¼ˆç­‰æ•ˆäºå•ç‹¬ä½¿ç”¨ -dï¼‰</td>
</tr>
<tr>
<td style="text-align:left">b</td>
<td style="text-align:left">Basic</td>
<td style="text-align:left">åŸºæœ¬è°ƒè¯•ï¼šæ˜¾ç¤ºç›®æ ‡é‡å»ºå†³ç­–ã€è¿‡æœŸæ£€æŸ¥ç­‰æ ¸å¿ƒä¿¡æ¯</td>
</tr>
<tr>
<td style="text-align:left">v</td>
<td style="text-align:left">Verbose</td>
<td style="text-align:left">è¯¦ç»†æ¨¡å¼ï¼šæ¯” b æ›´è¯¦ç»†çš„æ‰§è¡Œä¿¡æ¯</td>
</tr>
<tr>
<td style="text-align:left">i</td>
<td style="text-align:left">Implicit</td>
<td style="text-align:left">éšå¼è§„åˆ™ï¼šæ˜¾ç¤ºéšå¼è§„åˆ™æœç´¢/åº”ç”¨è¿‡ç¨‹</td>
</tr>
<tr>
<td style="text-align:left">j</td>
<td style="text-align:left">Jobs</td>
<td style="text-align:left">ä½œä¸šæ§åˆ¶ï¼šè¾“å‡ºå­è¿›ç¨‹æ‰§è¡Œç»†èŠ‚ï¼ˆå‘½ä»¤/PID/é€€å‡ºç ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">m</td>
<td style="text-align:left">Makefile</td>
<td style="text-align:left">Makefile å¤„ç†ï¼šè·Ÿè¸ª include/é‡è§£æè¿‡ç¨‹</td>
</tr>
<tr>
<td style="text-align:left">r</td>
<td style="text-align:left">Remaking</td>
<td style="text-align:left">é‡åˆ¶æ£€æŸ¥ï¼šæ˜¾ç¤º makefile è‡ªèº«çš„é‡åˆ¶å†³ç­–</td>
</tr>
<tr>
<td style="text-align:left">n</td>
<td style="text-align:left">None</td>
<td style="text-align:left">ç¦ç”¨æ‰€æœ‰è°ƒè¯•ï¼ˆç‰¹æ®Šç”¨é€”ï¼‰</td>
</tr>
</tbody>
</table>
<!--more-->
<h1 id="make-å¸¸ç”¨å˜é‡"><a class="markdownIt-Anchor" href="#make-å¸¸ç”¨å˜é‡"></a> Make å¸¸ç”¨å˜é‡</h1>
<h2 id="make-å˜é‡èµ‹å€¼æ“ä½œç¬¦"><a class="markdownIt-Anchor" href="#make-å˜é‡èµ‹å€¼æ“ä½œç¬¦"></a> Make å˜é‡èµ‹å€¼æ“ä½œç¬¦</h2>
<figure class="highlight make"><table><tr><td class="code"><pre><span class="line">immediate = deferred</span><br><span class="line">immediate ?= deferred</span><br><span class="line">immediate := immediate</span><br><span class="line">immediate ::= immediate</span><br><span class="line">immediate :::= immediate-with-escape</span><br><span class="line">immediate += deferred or immediate</span><br><span class="line">immediate != immediate</span><br></pre></td></tr></table></figure>
<ul>
<li><code>!=</code> ç”¨äºå°† shell å‘½ä»¤æ‰§è¡Œçš„ç»“æœèµ‹ç»™å˜é‡ï¼Œç­‰ä»·äº <code>variable := $(shell shell_cmd)</code></li>
</ul>
<h2 id="makecmdgoals"><a class="markdownIt-Anchor" href="#makecmdgoals"></a> MAKECMDGOALS</h2>
<p>è¡¨ç¤ºæ‰§è¡Œ make å‘½ä»¤æ—¶ç”¨æˆ·ç»™å…¥çš„ targets, è¿™é‡Œ<em>æ‰§è¡Œ make å‘½ä»¤æ—¶</em> ä¸ä»…åŒ…æ‹¬ä»ç»ˆç«¯å‘½ä»¤è¡Œæ‰§è¡Œ make, ä¹ŸåŒ…æ‹¬åœ¨ Makefile è§„åˆ™é‡Œæ‰§è¡Œ <code>make -f ...</code></p>
<figure class="highlight make"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(info <span class="variable">$(MAKECMDGOALS)</span>)</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ‰§è¡Œ <code>make</code>, å®ƒä¸ä¼šæ‰“å°ä»»ä½•ä¸œè¥¿ï¼Œä½†å¦‚æœæ‰§è¡Œ <code>make all</code>, å®ƒçš„è¾“å‡ºæ˜¯ <code>all</code></p>
<h2 id="makefile_list"><a class="markdownIt-Anchor" href="#makefile_list"></a> MAKEFILE_LIST</h2>
<p>è¢« make è§£æè¿‡çš„æ‰€æœ‰ Makefile æ–‡ä»¶ååˆ—è¡¨ï¼ŒæŒ‰ç…§è§£æçš„å…ˆåé¡ºåºç”±å·¦åˆ°å³ç½—åˆ—ã€‚å¦‚æœå½“å‰çš„ Makefile é‡Œä½¿ç”¨äº† <code>include</code>, å¦‚ <code>include inc.mk</code>, é‚£ä¹ˆ <code>inc.mk</code> å°±ä¼šæˆä¸ºè¿™ä¸ªåˆ—è¡¨çš„æœ€åä¸€ä¸ªã€‚æ³¨æ„å®ƒæ˜¯<strong>æ–‡ä»¶å</strong>åˆ—è¡¨ï¼Œä¸æ˜¯æ–‡ä»¶è·¯å¾„åˆ—è¡¨</p>
<h2 id="curdir"><a class="markdownIt-Anchor" href="#curdir"></a> CURDIR</h2>
<p>Makefile æ‰€åœ¨çš„ç›®å½•çš„<strong>ç»å¯¹è·¯å¾„</strong></p>
<figure class="highlight make"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(info <span class="variable">$(CURDIR)</span>)</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœè¿™ä¸ª Makefile ä½äº <code>/home/luc/gh/Makefile</code>, å®ƒæ‰“å°çš„å°±æ˜¯ <code>/home/luc/gh</code></p>
<h1 id="make-å¸¸ç”¨å‡½æ•°"><a class="markdownIt-Anchor" href="#make-å¸¸ç”¨å‡½æ•°"></a> Make å¸¸ç”¨å‡½æ•°</h1>
<h2 id="info-error-warning"><a class="markdownIt-Anchor" href="#info-error-warning"></a> info, error, warning</h2>
<ul>
<li>åŸå‹<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$(info text...)</span><br><span class="line">$(error text...)</span><br><span class="line">$(warning text...)</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™3ä¸ªå‡½æ•°è¢«æ”¾åœ¨ GNU Make å®˜æ–¹æ–‡ä»¶ <a href="https://www.gnu.org/software/make/manual/html_node/Make-Control-Functions.html">8.13 Functions That Control Make</a> ç« èŠ‚ï¼Œè¿™é‡ŒæŠŠå®ƒä»¬æ”¾åœ¨å¸¸ç”¨å‡½æ•°æœ€å‰é¢ï¼Œæ˜¯å› ä¸ºå®ƒä»¬å¯¹äºéªŒè¯è°ƒè¯• Makefile éå¸¸æœ‰ç”¨</li>
<li><code>$(info text...)</code> ç›¸å½“äº <code>printf()</code></li>
<li><code>$(error text...)</code> ç›¸å½“äº <code>assert(0)</code></li>
<li>info å’Œ warning çš„åŒºåˆ«æ˜¯å‰è€…æ‰“å°åœ¨ <strong>stdout</strong>, åè€…æ‰“å°åœ¨ <strong>stderr</strong></li>
<li>åŸæ ·æ‰“å°ï¼Œä¸æ”¯æŒè½¬ä¹‰å­—ç¬¦å¦‚ <code>\n</code></li>
<li>info, warning, error å‡½æ•°æ‰“å°è°ƒè¯• makefile ä¹‹æ‰€ä»¥æ¯”åœ¨è§„åˆ™é‡Œä½¿ç”¨ <code>echo</code> æ–¹ä¾¿ï¼Œæ˜¯å› ä¸ºå®ƒä»¬ä½œä¸ºå†…ç½®å‡½æ•°å¯ä»¥åœ¨ makefile çš„ä»»ä½•åœ°æ–¹å•ç‹¬å‡ºç°ï¼Œè€Œä¸åƒ echo åªèƒ½åœ¨è§„åˆ™é‡Œå‡ºç°</li>
<li>make é‡Œçš„å‡½æ•°ä¹Ÿä¼š<strong>å±•å¼€ expansion</strong>, ç›¸å½“äº make å‡½æ•°éƒ½æœ‰è¿”å›å€¼ï¼Œinfo, warning å‡½æ•°å±•å¼€åéƒ½æ˜¯ç©ºå­—ä¸²</li>
</ul>
</li>
</ul>
<h2 id="dir-notdir"><a class="markdownIt-Anchor" href="#dir-notdir"></a> dir, notdir</h2>
<ul>
<li>åŸå‹<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$(dir names...)</span><br><span class="line">$(notdir names...)</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™ä¸¤ä¸ªå†…ç½®å‡½æ•°è¢«æ”¾åœ¨ GNU Make å®˜æ–¹æ–‡æ¡£ <a href="https://www.gnu.org/software/make/manual/html_node/File-Name-Functions.html">8.3 Functions for File Names</a> ç« èŠ‚çš„å¤´ä¸¤ä¸ªï¼Œå¯è§å®ƒä»¬çš„ä½¿ç”¨ä¹‹å¤šã€‚è¿™ä¸€ç« èŠ‚çš„å‡½æ•°éƒ½æ˜¯ä¸“é—¨ç”¨æ¥<strong>æ‹†åˆ†</strong>æ–‡ä»¶è·¯å¾„çš„ã€‚</li>
<li><code>$(dir names...)</code> åªå–å‡ºåé¢æ–‡ä»¶è·¯å¾„(æˆ–æ–‡ä»¶è·¯å¾„åˆ—è¡¨)çš„ç›®å½•éƒ¨åˆ†, ç›¸å½“äº shell é‡Œçš„ <code>dirname</code></li>
<li><code>$(notdir names...)</code> åªå–å‡ºåé¢æ–‡ä»¶è·¯å¾„(æˆ–æ–‡ä»¶è·¯å¾„åˆ—è¡¨)çš„æ–‡ä»¶åéƒ¨åˆ†, ç›¸å½“äº shell é‡Œçš„ <code>basename</code></li>
<li>ä¸¾ä¸ªä¾‹å­ Linux kernel <code>scripts/Kbuild.include</code> ä¸­ <code>dot-target</code> å®šä¹‰çš„ä¾‹å­:
<ul>
<li>`dot-target = $(dir <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">@</mi><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">@).</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">@</span><span class="mclose">)</span><span class="mord">.</span></span></span></span>(notdir $@)</li>
<li>è¿™ä¸ª dot-target å…¶å®å°±æ˜¯æŠŠ <code>foo/bar.o</code> å˜æˆ <code>foo/.bar.o</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="filter-filter-out"><a class="markdownIt-Anchor" href="#filter-filter-out"></a> filter, filter-out</h2>
<ul>
<li>åŸå‹<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$(filter pattern...,text)</span><br><span class="line">$(filter-out pattern...,text)</span><br></pre></td></tr></table></figure>
<ul>
<li>filter å‡½æ•°è¿”å› <code>text</code> ä¸­æ‰€æœ‰<strong>åŒ¹é…</strong> <code>pattern...</code> çš„å•è¯</li>
<li><code>pattern...</code> è¡¨ç¤ºå¯ä»¥æä¾›å¤šä¸ªç”¨<strong>ç©ºç™½åˆ†éš”</strong>çš„ pattern</li>
<li>filter-out æ˜¯è¿”å›é‚£äº›<strong>ä¸åŒ¹é…</strong>çš„ï¼Œå³å®ƒçš„ç»“æœä¸ filter æ­£å¥½ç›¸å</li>
</ul>
</li>
</ul>
<h2 id="foreach"><a class="markdownIt-Anchor" href="#foreach"></a> foreach</h2>
<ul>
<li>åŸå‹<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$(foreach var, list, text)</span><br></pre></td></tr></table></figure>
<ul>
<li>expansion æ—¶æœºï¼š<code>var</code>, <code>list</code> åœ¨ä¸€å¼€å§‹å°±å±•å¼€ï¼Œè€Œ <code>text</code> æ˜¯åœ¨åé¢æ‰å±•å¼€</li>
<li><code>list</code> æ˜¯ä¸€ä¸ªç©ºç™½åˆ†éš”çš„å­—ç¬¦ä¸²</li>
<li><code>text</code> çš„å¤šæ¬¡å±•å¼€ä¹Ÿè¢«<strong>ç©ºç™½</strong>è¿æ¥æˆä¸€æ•´ä¸ªé•¿å­—ç¬¦ä¸²</li>
</ul>
</li>
</ul>
<h2 id="if"><a class="markdownIt-Anchor" href="#if"></a> if</h2>
<ul>
<li>åŸå‹<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$(if condition, then-part[, else-part])</span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœ <em>condition</em> å±•å¼€åæ˜¯ <strong>éç©ºå­—ä¸²</strong>non-empty string, åˆ™ä¸ºçœŸï¼Œå¦‚æœæ˜¯<strong>ç©ºå­—ä¸²</strong>ï¼Œåˆ™æ‰§è¡Œ <code>else-part</code>(å¦‚æœæœ‰çš„è¯)</li>
<li><em>then-part</em> å’Œ <em>else-part</em> æ°¸è¿œåªèƒ½æœ‰ä¸€ä¸ªè¢«æ±‚å€¼ (evaluated)</li>
<li>if å‡½æ•°åŒæ ·æœ‰è¿”å›å€¼ï¼Œæ¡ä»¶çœŸæ—¶ï¼Œè¿”å› <em>then-part</em> çš„æ±‚å€¼ç»“æœ; æ¡ä»¶å‡æ—¶ï¼Œè¿”å› <em>else-part</em> çš„æ±‚å€¼ç»“æœ, å¦‚æœæ²¡æœ‰ <em>else-part</em>, è¿”å›ç©ºå­—ä¸²</li>
</ul>
</li>
</ul>
<h2 id="or-and"><a class="markdownIt-Anchor" href="#or-and"></a> or, and</h2>
<ul>
<li>åŸå‹<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$(or condition1[,condition2[,condition3...]]ï¼‰</span><br><span class="line">$(and condition1[,condition2[,condition3...]]ï¼‰</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>çŸ­è·¯æˆ–(short-circuiting OR)</strong>(ä¸æ˜¯éª‚äººğŸ¶), å³ä¸€ä¸ªæŒ¨ä¸€ä¸ªå±•å¼€ <em>condition</em>, åªè¦é‡åˆ°ä¸€ä¸ªå±•å¼€ä¸º<strong>éç©ºå­—ä¸²</strong>ï¼Œå°±åœæ­¢ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›çš„å°±æ˜¯å±•å¼€çš„é‚£ä¸ªå­—ä¸²ï¼Œå¦‚æœæ‰€æœ‰ <em>condition</em> å±•å¼€éƒ½æ˜¯ç©ºï¼Œåˆ™è¿”å›ç©ºå­—ä¸²</li>
<li><strong>çŸ­è·¯ä¸(short-circuiting AND)</strong>, å³ä¸€ä¸ªæŒ¨ä¸€ä¸ªå±•å¼€ <em>condition</em>, åªè¦é‡åˆ°ä¸€ä¸ªå±•å¼€ä¸º<strong>ç©ºå­—ä¸²</strong>ï¼Œå°±åœæ­¢ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›çš„å°±æ˜¯ç©ºå­—ä¸²ï¼Œå¦‚æœæ‰€æœ‰ <em>condition</em> å±•å¼€éƒ½æ˜¯éç©ºå­—ä¸²ï¼Œè¿”å›<strong>æœ€åä¸€ä¸ªå­—ä¸²</strong></li>
<li><em>condition</em> å¯ä»¥æœ‰ 1 åˆ° n ä¸ª</li>
</ul>
</li>
</ul>
<h2 id="origin"><a class="markdownIt-Anchor" href="#origin"></a> origin</h2>
<ul>
<li>åŸå‹<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$(origin variable)</span><br></pre></td></tr></table></figure>
<ul>
<li><em>variable</em> ä¸éœ€è¦åŠ  <code>$</code> ç¬¦å·</li>
<li>å®ƒçš„åŠŸèƒ½ç±»ä¼¼ shell é‡Œçš„ <code>which</code> æˆ– <code>type</code> (å‘Šè¯‰ä½ ä¸€ä¸ªå‘½ä»¤æ˜¯ä¸æ˜¯ shell å†…ç½®å‘½ä»¤)</li>
<li>å®ƒçš„è¿”å›å€¼æœ‰ä»¥ä¸‹è¿™äº›(éƒ½æ˜¯å­—ä¸²)
<ul>
<li>undefined</li>
<li>default</li>
<li>environment</li>
<li>environment override</li>
<li>file</li>
<li>command line</li>
<li>override</li>
<li>automatic</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°"><a class="markdownIt-Anchor" href="#ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°"></a> ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°</h2>
<p>åƒå…¶å®ƒè¯­è¨€ä¸€æ ·ï¼Œåœ¨ Makefile é‡Œä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰å‡½æ•°ï¼Œ ä¾‹å¦‚</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">rust_exports = <span class="variable">$(NM)</span> -p --defined-only $(1) | awk &#x27;$$2~/(T|R|D|B)/ &amp;&amp; $$3!~/__(pfx|cfi|odr_asan)/ &#123; printf $(2),$$3 &#125;&#x27;</span><br></pre></td></tr></table></figure>
<ul>
<li>Makefile é‡Œå®šä¹‰å‡½æ•°ï¼Œæ„Ÿè§‰è¿˜æ˜¯åœ¨<strong>å®šä¹‰å˜é‡</strong></li>
<li>å‡½æ•°åæ˜¯ <code>rust_exports</code></li>
<li>å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•° <code>$(1)</code>, <code>$(2)</code></li>
<li>å‡½æ•°ä¸­å¯ä»¥ä½¿ç”¨ Makefile å˜é‡ï¼Œå¦‚ <code>$(NM)</code></li>
<li><a href="https://gist.github.com/lucmann/3a30f9cc06bb8773a77aa5ccc945c3e5">å½“å‡½æ•°ä¸­çš„å‚æ•°æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ <code>=</code>ï¼Œè€Œä¸æ˜¯ <code>:=</code>, å› ä¸ºæœ‰å‚æ•°æ—¶éœ€è¦å°†<strong>å‚æ•°å»¶è¿Ÿå±•å¼€</strong></a></li>
</ul>
<p>å¦‚ä½•è°ƒç”¨å®ƒ</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">call</span> rust_exports,<span class="variable">$&lt;</span>,&quot;EXPORT_SYMBOL_RUST_GPL(%s)</span>;\n<span class="string">&quot;)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨è‡ªå®šä¹‰å‡½æ•°ä½¿ç”¨ Make å†…ç½®å‡½æ•° <code>$(call variable,param,param,...)</code></li>
<li>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œç¬¬1ä¸ªå®å‚æ˜¯ <code>$&lt;</code>, ç¬¬2ä¸ªå®å‚æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®é™…ä¸Šæ˜¯ awk printf å‡½æ•°æ¥å—çš„<strong>æ ¼å¼å­—ç¬¦ä¸²(format string)</strong></li>
</ul>
<h3 id="å‡½æ•°-ä¾‹2"><a class="markdownIt-Anchor" href="#å‡½æ•°-ä¾‹2"></a> å‡½æ•° ä¾‹2</h3>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">if_makefile_exists = <span class="variable">$(<span class="built_in">if</span> $(<span class="built_in">if</span>-exist-cond)</span>,<span class="variable">$(cmd)</span>,@ï¼š)</span><br><span class="line">if-exist-cond = <span class="variable">$(<span class="built_in">wildcard</span> $(1)</span>/Makefile)</span><br><span class="line">cmd = make -C $(1) $(2)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>if_makefile_exists</code> å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œ
<ul>
<li>å‚æ•°1ï¼šç›®å½•å</li>
<li>å‚æ•°2ï¼šTarget</li>
</ul>
</li>
<li>åŠŸèƒ½æ˜¯å¦‚æœ<strong>å‚æ•°1</strong>æŒ‡å®šçš„ç›®å½•ä¸‹å­˜åœ¨ Makefile, åˆ™æ„å»º<strong>å‚æ•°2</strong>æŒ‡å®šçš„ç›®æ ‡ï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åš(<code>@:</code>)</li>
<li>è°ƒç”¨æ–¹æ³•ï¼š<code>$(call if_makefile_exists,images/dot,all)</code></li>
</ul>
<h1 id="make-ç”¨æˆ·æ‰‹å†Œ"><a class="markdownIt-Anchor" href="#make-ç”¨æˆ·æ‰‹å†Œ"></a> Make ç”¨æˆ·æ‰‹å†Œ</h1>
<ul>
<li><a href="https://www.gnu.org/software/make/manual/make.html">Make Manual</a></li>
</ul>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>CUDA on WSL2</title>
    <url>/utils/nvidia-docker/</url>
    <content><![CDATA[
<p>References:</p>
<ol>
<li><a href="https://developer.nvidia.com/blog/announcing-cuda-on-windows-subsystem-for-linux-2/">Announcing CUDA on Windows Subsystem for Linux 2</a></li>
</ol>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>QEMU</title>
    <url>/utils/qemu/</url>
    <content><![CDATA[<h1 id="qemu"><a class="markdownIt-Anchor" href="#qemu"></a> QEMU</h1>
<table>
<thead>
<tr>
<th style="text-align:left">ç‰¹æ€§</th>
<th style="text-align:left">QEMU</th>
<th style="text-align:left">VirtualBox</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">å¼€å‘è€…</td>
<td style="text-align:left">å¼€æºï¼ˆQEMU é¡¹ç›®, æœ€åˆç”± Fabrice Bellard å¼€å‘ï¼‰</td>
<td style="text-align:left">Oracleï¼ˆåŸ Sun Microsystemsï¼‰</td>
</tr>
<tr>
<td style="text-align:left">å¼€æº/é—­æº</td>
<td style="text-align:left">å®Œå…¨å¼€æºï¼ˆGPLv2ï¼‰</td>
<td style="text-align:left">éƒ¨åˆ†å¼€æºï¼ˆæ‰©å±•åŒ…é—­æºï¼‰</td>
</tr>
<tr>
<td style="text-align:left">æ”¯æŒæ¶æ„</td>
<td style="text-align:left">x86, ARM, RISC-V, MIPS, LoongArch, SPARCç­‰</td>
<td style="text-align:left">ä»… x86_64</td>
</tr>
<tr>
<td style="text-align:left">æ˜¯å¦æ”¯æŒçº¯è½¯ä»¶æ¨¡æ‹Ÿ</td>
<td style="text-align:left">æ”¯æŒï¼ˆTCG æ¨¡æ‹Ÿ,ä¹Ÿæ”¯æŒ KVM åŠ é€Ÿï¼‰</td>
<td style="text-align:left">ä¸æ”¯æŒï¼ˆå¿…é¡» Intel VT-x/AMD-Vï¼‰</td>
</tr>
<tr>
<td style="text-align:left">é€‚ç”¨åœºæ™¯</td>
<td style="text-align:left">åµŒå…¥å¼å¼€å‘, è·¨æ¶æ„ä»¿çœŸ</td>
<td style="text-align:left">æ¡Œé¢ç”¨æˆ·è¿è¡Œ Win/Linux</td>
</tr>
</tbody>
</table>
<span id="more"></span>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>virtualization</tag>
      </tags>
  </entry>
  <entry>
    <title>Regular Expression</title>
    <url>/utils/regex/</url>
    <content><![CDATA[<h1 id="regular-expressions"><a class="markdownIt-Anchor" href="#regular-expressions"></a> Regular Expressions</h1>
<ul>
<li>
<p><a href="https://www.regular-expressions.info/posix.html#bre">POSIX Basic Regular Expression</a></p>
<ul>
<li>grep</li>
</ul>
</li>
<li>
<p><a href="https://www.regular-expressions.info/gnu.html#ere">POSIX Extended Regular Expression</a></p>
<ul>
<li>egrep</li>
<li>awk</li>
<li>emacs</li>
</ul>
</li>
</ul>
<h1 id="gnu-extensions"><a class="markdownIt-Anchor" href="#gnu-extensions"></a> GNU Extensions</h1>
<h2 id="shorthand-classes"><a class="markdownIt-Anchor" href="#shorthand-classes"></a> Shorthand Classes</h2>
<table>
<thead>
<tr>
<th style="text-align:left">shorthand</th>
<th style="text-align:left">equivalence</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>\w</code></td>
<td style="text-align:left"><code>[[:alnum:]_]</code></td>
</tr>
<tr>
<td style="text-align:left"><code>\W</code></td>
<td style="text-align:left"><code>[^[:alnum:]_]</code></td>
</tr>
<tr>
<td style="text-align:left"><code>\s</code></td>
<td style="text-align:left"><code>[[:space:]]</code></td>
</tr>
<tr>
<td style="text-align:left"><code>\S</code></td>
<td style="text-align:left"><code>[^[:space:]]</code></td>
</tr>
</tbody>
</table>
<h2 id="word-boundaries"><a class="markdownIt-Anchor" href="#word-boundaries"></a> Word Boundaries</h2>
<table>
<thead>
<tr>
<th style="text-align:left">shorthand</th>
<th style="text-align:left">matches</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>\b</code></td>
<td style="text-align:left">position at a word boundary</td>
</tr>
<tr>
<td style="text-align:left"><code>\B</code></td>
<td style="text-align:left">position not at a word boundary</td>
</tr>
<tr>
<td style="text-align:left"><code>\&lt;</code></td>
<td style="text-align:left">position at the start of a word</td>
</tr>
<tr>
<td style="text-align:left"><code>\&gt;</code></td>
<td style="text-align:left">position at the end of a word</td>
</tr>
<tr>
<td style="text-align:left"><code>\`</code> (backtick)</td>
<td style="text-align:left">position at the start of subject string</td>
</tr>
<tr>
<td style="text-align:left"><code>\'</code> (single quote)</td>
<td style="text-align:left">position at the end of subject string</td>
</tr>
</tbody>
</table>
<h1 id="perl-compatiable-regular-expression-pcre"><a class="markdownIt-Anchor" href="#perl-compatiable-regular-expression-pcre"></a> Perl Compatiable Regular Expression (PCRE)</h1>
<h2 id="grep-multiline-mode"><a class="markdownIt-Anchor" href="#grep-multiline-mode"></a> <code>grep</code> multiline mode</h2>
<ul>
<li><code>-P</code>: ä½¿ç”¨ Perl æ­£åˆ™è¡¨è¾¾å¼æ‰©å±•</li>
<li><code>-z</code>: è®© grep æŠŠè¾“å…¥çš„è¡Œçœ‹æˆæ˜¯ä¸€ä¸ªå¤šä¸ªè¡Œçš„é›†åˆï¼Œä¸€ä¸ªæ•´ä½“</li>
<li><code>.*?</code>: åé¢çš„ <code>?</code> è¡¨ç¤º <code>.*</code> æŒ‰ <strong>non-greedy</strong> æ¨¡å¼åŒ¹é…ï¼Œä¹Ÿå°±æ˜¯å°½å¯èƒ½å°‘(çŸ­)çš„åŒ¹é…</li>
<li><code>(?s)</code>: è®© <code>.</code> åŒ¹é…åŒ…æ‹¬ <code>\n</code> åœ¨å†…çš„ä»»æ„å­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ <strong>dot all</strong> flag.</li>
</ul>
<h2 id="rg-multiline-mode"><a class="markdownIt-Anchor" href="#rg-multiline-mode"></a> <code>rg</code> multiline mode</h2>
<ul>
<li>
<p><code>-U, --multiline</code> ä½¿èƒ½å¤šè¡ŒåŒ¹é…ï¼Œå…è®¸æ­£åˆ™è¡¨è¾¾å¼é‡ŒåŒ…å« <code>\n</code> (æ™®é€šæ¨¡å¼ä¸‹ä¸å…è®¸)ï¼Œä½† <code>-U</code> å¹¶ä¸ä¼šæ”¹å˜ <code>.</code> çš„è¯­ä¹‰ï¼Œæ‰€ä»¥ä½ ä»ç„¶éœ€è¦æ˜¾å¼åœ°ç»™ <code>.</code> æŒ‡å®š <code>(?s)</code> flag</p>
<ul>
<li><code>rg -U 'struct file_operations .*? = ?\&#123;(?s).*?\.mmap = (?s).*?\&#125;;' -tc drivers/gpu</code><br />
è¿™ä¸ªä¾‹å­æ‰¾å‡ºå†…æ ¸ GPU é©±åŠ¨ä¸­æ‰€æœ‰é‡å†™äº† <code>mmap</code> file operation æ–¹æ³•çš„cæ–‡ä»¶</li>
</ul>
</li>
</ul>
<h1 id="lookarounds-lookahead-lookbehind"><a class="markdownIt-Anchor" href="#lookarounds-lookahead-lookbehind"></a> Lookarounds: Lookahead, Lookbehind</h1>
<table>
<thead>
<tr>
<th style="text-align:left">è¯­æ³•</th>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">(?=foo)</td>
<td style="text-align:left">æ­£å‘å…ˆè¡Œæ–­è¨€ Positive Lookahead</td>
<td style="text-align:left">å‘å‰(å³) å­—ç¬¦ä¸²é‡Œå¿…é¡»æœ‰ foo</td>
</tr>
<tr>
<td style="text-align:left">(?!foo)</td>
<td style="text-align:left">è´Ÿå‘å…ˆè¡Œæ–­è¨€ Negative Lookahead</td>
<td style="text-align:left">å‘å‰(å³) å­—ç¬¦ä¸²é‡Œä¸èƒ½æœ‰ foo</td>
</tr>
<tr>
<td style="text-align:left">(?&lt;=foo)</td>
<td style="text-align:left">æ­£å‘åè¡Œæ–­è¨€ Positive Lookbehind</td>
<td style="text-align:left">å‘å(å·¦) å­—ç¬¦ä¸²é‡Œå¿…é¡»æœ‰ foo</td>
</tr>
<tr>
<td style="text-align:left">(?&lt;!foo)</td>
<td style="text-align:left">è´Ÿå‘åè¡Œæ–­è¨€ Negative Lookbehind</td>
<td style="text-align:left">å‘å(å·¦) å­—ç¬¦ä¸²é‡Œä¸èƒ½æœ‰ foo</td>
</tr>
</tbody>
</table>
<ul>
<li>å®ƒä»¬åªæ˜¯<strong>æ£€æŸ¥æ˜¯å¦åŒ¹é…ï¼Œä¸ä½œä¸ºæœ€ç»ˆåŒ¹é…ç»“æœçš„ä¸€éƒ¨åˆ†</strong>ï¼Œå³æ‰€è°“&quot;æ–­è¨€&quot;</li>
<li>å®ƒä»¬å¯ä»¥è§£å†³ Non greedy åŒ¹é…æœ‰æ—¶è§£å†³ä¸äº†çš„é—®é¢˜</li>
<li><code>rg</code> (<a href="https://github.com/BurntSushi/ripgrep">ripgrep</a>) é»˜è®¤ä¸æ”¯æŒ lookahead, lookbehind, éœ€è¦åŠ  <code>-P</code> æˆ– <code>--pcre2</code> é€‰é¡¹</li>
</ul>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>Sanitizers</title>
    <url>/utils/sanitizer/</url>
    <content><![CDATA[<p><img src="/images/sanitizer/shadowed-process-memory.png" alt="shadowed process memory" /></p>
<span id="more"></span>
<h1 id="sanitizer-ç®€ä»‹"><a class="markdownIt-Anchor" href="#sanitizer-ç®€ä»‹"></a> Sanitizer ç®€ä»‹</h1>
<p>Sanitizer æ˜¯ä¸€ä¸ªåŠ¨æ€ Bug æ£€æµ‹çš„å·¥å…·ï¼Œå®ƒå¯ä»¥æ£€æµ‹çš„ Bug æœ‰ä»¥ä¸‹å‡ ç±»ï¼š</p>
<ul>
<li>å†…å­˜è¶Šç•Œ</li>
<li>å†…å­˜æœªåˆå§‹åŒ–</li>
<li>å†…å­˜æ³„æ¼</li>
<li>æ­»é”</li>
<li>æœªå®šä¹‰è¡Œä¸º (UB)</li>
</ul>
<h1 id="å†…å­˜-bug"><a class="markdownIt-Anchor" href="#å†…å­˜-bug"></a> å†…å­˜ Bug</h1>
<p>Sanitizer æ£€æµ‹å†…å­˜è¶Šç•Œï¼Œæœªåˆå§‹åŒ–ï¼Œæ³„æ¼çš„åŸç†æ˜¯è®©ç¼–è¯‘å™¨åœ¨ç¨‹åºçœŸæ­£ä½¿ç”¨çš„å†…å­˜å‘¨å›´åŠ ä¸Šé¢å¤–çš„å†…å­˜ <strong>(Red Zone)</strong>ï¼Œ å¹¶åœ¨è¿™äº› Red Zone é‡Œå¡«ä¸Šä¸åŒçš„å€¼ã€‚</p>
<p><img src="/images/sanitizer/redzones.png" alt="various red zones" /></p>
<p>è¦å®Œæˆè¿™äº›éœ€è¦è®©ç¨‹åºé“¾æ¥ä¸€ä¸ªå« <strong><code>libasan.so</code></strong> çš„è¿è¡Œæ—¶åŠ¨æ€åº“ï¼Œä»¥åŠåœ¨ç¼–è¯‘å’Œé“¾æ¥æ—¶æŒ‡å®š <strong><code>-fsanitize=address</code></strong>ã€‚</p>
<ul>
<li>AddressSanitizer (ASan <strong><code>-fsanitizer=address</code></strong>):
<ul>
<li>use-after-free</li>
<li>double-free</li>
<li>buffer (heap, stack, and global buffer) overflows</li>
<li>memory leak</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">    <span class="type">int</span> a[<span class="number">100</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Foo *foo = <span class="keyword">new</span> Foo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/sanitizer/leak-sanitizer.png" alt="Leak Sanitizer" /></p>
<ul>
<li>MemorySanitizer (MSan <strong><code>-fsanitizer=memory -fsanitizer-memory-track-origins</code></strong>):
<ul>
<li>uninitialized memory reads</li>
</ul>
</li>
</ul>
<h1 id="æ­»é”"><a class="markdownIt-Anchor" href="#æ­»é”"></a> æ­»é”</h1>
<ul>
<li>ThreadSanitizer: data races, deadlocks</li>
</ul>
<h1 id="æœªå®šä¹‰è¡Œä¸º"><a class="markdownIt-Anchor" href="#æœªå®šä¹‰è¡Œä¸º"></a> æœªå®šä¹‰è¡Œä¸º</h1>
<ul>
<li>UndefinedBehaviorSanitizer (UBSan <strong><code>-fsanitizer=undefined</code></strong>)
<ul>
<li>signed integer overflow</li>
<li>use-of-null-pointer</li>
<li>division by zero</li>
</ul>
</li>
</ul>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="https://microblink.com/be-wise-sanitize-keeping-your-c-code-free-from-bugs/">Be wise, sanitize: Keeping your C++ code free from bugs</a></li>
<li><a href="https://github.com/google/sanitizers/wiki/AddressSanitizerFlags">AddressSanitizer flags</a></li>
<li><a href="https://llvm.org/devmtg/2016-01/slides/ModernCplusplusDevelopment.pdf">An LLVM developer setup: Modern C++ development tools</a></li>
<li><a href="https://www.bilibili.com/video/BV1YT411Q7BU/?spm_id_from=333.788.top_right_bar_window_history.content.click&amp;vd_source=b3ba1ad08e1b41cd7118d8dd88f0e670">Sanitizer åœ¨å­—èŠ‚è·³åŠ¨ C++ ä¸­çš„å®è·µ</a></li>
</ul>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>Advanced Shell</title>
    <url>/utils/shell/</url>
    <content><![CDATA[<h1 id="åŸºç¡€çŸ¥è¯†-å˜é‡å’Œå‡½æ•°"><a class="markdownIt-Anchor" href="#åŸºç¡€çŸ¥è¯†-å˜é‡å’Œå‡½æ•°"></a> åŸºç¡€çŸ¥è¯† - å˜é‡å’Œå‡½æ•°</h1>
<p>Linux ä¸‹çš„ Shell æœ‰å¾ˆå¤šï¼Œ sh, bash, csh, zsh ç­‰, è¿™é‡Œä¸»è¦è®°å½•ä¸€ä¸‹ bash å’Œ zsh çš„ä¸€äº›ä¸åŒä¹‹å¤„</p>
<h2 id="ç‰¹æ®Šå˜é‡"><a class="markdownIt-Anchor" href="#ç‰¹æ®Šå˜é‡"></a> ç‰¹æ®Šå˜é‡</h2>
<ul>
<li><code>$!</code> æœ€åä¸€ä¸ªåå°å‘½ä»¤çš„ PID
<ul>
<li><code>(glmark2 &amp; PID=$!; echo &quot;PID: $PID&quot;)</code>
<ul>
<li>åœ¨å­ Shell ä¸­å¯åŠ¨ glmark2, å¹¶æ‰“å° glmark2 è¿›ç¨‹çš„ PID</li>
<li><code>(...)</code> ç”¨æ¥åœ¨æ–°çš„å­ Shell é‡Œæ‰§è¡Œå‘½ä»¤</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="parameter-expansion"><a class="markdownIt-Anchor" href="#parameter-expansion"></a> Parameter Expansion</h2>
<h3 id="use-an-alternate-value"><a class="markdownIt-Anchor" href="#use-an-alternate-value"></a> Use an alternate value</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$&#123;var:+WORD&#125;</span></span><br><span class="line"><span class="variable">$&#123;var+WORD&#125;</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœ <code>var</code> æ²¡æœ‰è®¾ç½®æˆ–ä¸ºç©ºï¼Œåˆ™è¿™ä¸ªå˜é‡å±•å¼€ä¸º Nothing (æ³¨æ„ï¼šä¸æ˜¯ç©º empty, æ˜¯ nothing), å¦‚æœè¢«è®¾ç½®äº†ï¼ˆä¸åŒ…æ‹¬è¢«è®¾ç½®æˆç©ºï¼‰ï¼Œå®ƒå±•å¼€ä¸º <code>+</code> åé¢çš„ WORD.</p>
<p>å¦‚æœå†’å·è¢«çœç•¥ï¼Œåˆ™ <code>var</code> å³ä½¿è¢«è®¾ç½®ä¸ºç©ºï¼Œå®ƒä¹Ÿå±•å¼€ä¸º <code>+</code> åé¢çš„ WORD</p>
<h3 id="indirect"><a class="markdownIt-Anchor" href="#indirect"></a> Indirect</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$&#123;!var&#125;</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœ <code>var</code> çš„å€¼æ˜¯ <code>MESA_DEBUG</code>, é‚£ä¹ˆè¿™ä¸ªå½¢å¼å±•å¼€åæ˜¯å˜é‡ <code>MESA_DEBUG</code> çš„å€¼ï¼Œä¾‹å¦‚ <code>export MESA_DEBUG=1</code>, <code>var=MESA_DEBUG</code>, åˆ™æœ€åçš„å±•å¼€ç»“æœæ˜¯ <code>1</code></p>
<h3 id="quoted"><a class="markdownIt-Anchor" href="#quoted"></a> Quoted</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="variable">$&#123;var@Q&#125;</span></span><br></pre></td></tr></table></figure>
<p>å¸¦ <code>@Q</code> æŒ‡å˜é‡å±•å¼€åçš„å€¼è¢«å•å¼•å·å¼•èµ·æ¥ï¼Œä¾‹å¦‚ <code>export ABC=abc</code>, <code>echo &quot;ABC=$&#123;ABC@Q&#125;&quot;</code> çš„ç»“æœæ˜¯ <code>ABC='abc'</code></p>
<h2 id="åæ–œæ -backslash"><a class="markdownIt-Anchor" href="#åæ–œæ -backslash"></a> åæ–œæ  backslash \</h2>
<p><code>\</code> åœ¨ shell ä¸­æ˜¯ç”¨æ¥è½¬ä¹‰å­—ç¬¦çš„ï¼Œå°±æ˜¯è¯´ <code>echo &quot;\\\\&quot;</code> æ˜¾ç¤ºçš„å®é™…åªæœ‰ä¸€ä¸ª <code>\</code>, è€Œä¸” <code>while read var</code> æ—¶è¦æ³¨æ„åŠ  <code>-r</code> é€‰é¡¹ï¼Œè¯»å…¥åŸå§‹å­—ä¸²</p>
<h1 id="ç»å…¸å‘½ä»¤"><a class="markdownIt-Anchor" href="#ç»å…¸å‘½ä»¤"></a> ç»å…¸å‘½ä»¤</h1>
<h2 id="exec"><a class="markdownIt-Anchor" href="#exec"></a> exec</h2>
<p><code>exec</code> å‘½ä»¤æœ‰ 2 ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li>ç›´æ¥è¦†ç›–å½“å‰è¿›ç¨‹ï¼Œå°±æ˜¯è¯´è¿›ç¨‹ PID ä¸å˜ï¼Œä½†æ‰§è¡Œçš„ä»£ç è¢«æ›´æ¢äº†</li>
<li>åŸæ¥çš„ shell ç¯å¢ƒè¢«é”€æ¯ï¼Œè¿™æ ·å½“å‰çš„ä»£ç ç»“æŸåï¼Œä¹Ÿå°±ä¸ä¼šè¿”å›åŸ shell(æ²¡å¾—è¿”å›)ï¼Œ ç›´æ¥é€€å‡º, æ‰€ä»¥<strong>å¾ªç¯ä¸­æ…ç”¨ exec</strong></li>
<li>å¯ä»¥æŠŠå®ƒæƒ³åƒæˆç³»ç»Ÿè°ƒç”¨ <code>execve()</code></li>
</ul>
<p>ä¸‹é¢æ˜¯ linux kernel å®‰è£… bzImage çš„ä¸€æ®µä»£ç ï¼Œå…¶ä¸­å°±ä½¿ç”¨äº† <code>exec</code>, ä¿è¯åˆ—å‡ºçš„ 4 ä¸ªå®‰è£…è„šæœ¬ä¸­ï¼Œåªæ‰§è¡Œç¬¬ 1 ä¸ªå­˜åœ¨çš„ï¼Œä¸ä¼šé‡å¤å®‰è£…</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">User/arch may have a custom install script</span></span><br><span class="line">for file in &quot;$&#123;HOME&#125;/bin/$&#123;INSTALLKERNEL&#125;&quot;		\</span><br><span class="line">	    &quot;/sbin/$&#123;INSTALLKERNEL&#125;&quot;			\</span><br><span class="line">	    &quot;$&#123;srctree&#125;/arch/$&#123;SRCARCH&#125;/install.sh&quot;	\</span><br><span class="line">	    &quot;$&#123;srctree&#125;/arch/$&#123;SRCARCH&#125;/boot/install.sh&quot;</span><br><span class="line">do</span><br><span class="line">	if [ ! -x &quot;$&#123;file&#125;&quot; ]; then</span><br><span class="line">		continue</span><br><span class="line">	fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">installkernel(8) says the parameters are like follows:</span></span><br><span class="line"><span class="meta prompt_">	#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">	<span class="comment">#   installkernel version zImage System.map [directory]</span></span></span><br><span class="line">	exec &quot;$&#123;file&#125;&quot; &quot;$&#123;KERNELRELEASE&#125;&quot; &quot;$&#123;KBUILD_IMAGE&#125;&quot; System.map &quot;$&#123;INSTALL_PATH&#125;&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h2 id="timeout"><a class="markdownIt-Anchor" href="#timeout"></a> timeout</h2>
<p><code>timeout</code> å‘½ä»¤ç”¨æ¥ç»™ä¸€ä¸ª <em>COMMAND</em> è®¾å®šä¸€ä¸ª <em>DURATION</em>ï¼Œ è¿™åœ¨è‡ªåŠ¨åŒ–ä¸­å¾ˆæœ‰ç”¨ï¼Œæ¯”å¦‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">for i in `fd --type x`; do timeout -k 0.1 10 ./$i; done</span><br></pre></td></tr></table></figure>
<p>å‡å¦‚å½“å‰åœ¨ <a href="https://github.com/SaschaWillems/Vulkan">VulkanExamples</a> çš„ bin ç›®å½•ä¸‹ï¼Œä¸Šé¢çš„å‘½ä»¤è¡¨ç¤ºè®©æ¯ä¸ª demo æ‰§è¡Œ <strong>10s</strong> åç»“æŸ(<code>timeout</code> ç»™å®ƒå‘ <code>TERM</code> ä¿¡å·), å¦‚æœå‘äº† <code>TERM</code> ä¿¡å·åï¼Œåˆç»è¿‡ <strong>0.1s (<code>-k 0.1</code>)</strong>ï¼Œè¿™ä¸ª demo è¿˜æœªèƒ½é€€å‡ºï¼Œå°±å†å‘ <code>KILL</code> ä¿¡å·ï¼Œå¼ºåˆ¶ç»“æŸå®ƒ</p>
<h2 id="tree"><a class="markdownIt-Anchor" href="#tree"></a> tree</h2>
<p><code>tree</code> åƒä¸€ä¸ªç®€å•çš„æ–‡ä»¶æµè§ˆå™¨ï¼Œä½†å®ƒå¹¶ä¸æ˜¯ shell å†…ç½®çš„å‘½ä»¤ï¼Œ<code>apt install tree</code> æˆ– <code>pacman -S tree</code> éƒ½å¯ä»¥å®‰è£…ã€‚æœ‰æ—¶ä¸€ä¸ªç›®å½•ä¸­åŒ…å«å¤ªå¤šçš„æ–‡ä»¶ï¼Œtree çš„é»˜è®¤è¾“å‡ºå°±ä¸å¤ªå¥½æµè§ˆï¼Œè¿™æ—¶å¯ä»¥åªæ‰“å°ç›®å½•ï¼Œå¹¶é™åˆ¶æœç´¢æ·±åº¦</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tree -L 2 -d</span><br></pre></td></tr></table></figure>
<h2 id="crontab"><a class="markdownIt-Anchor" href="#crontab"></a> crontab</h2>
<p><code>crontab -e</code> (æ·»åŠ å®šæ—¶ä»»åŠ¡)ï¼Œ ä¸å…‰å¯ä»¥æ·»åŠ å‘¨æœŸæ€§çš„å®šæ—¶ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥æ·»åŠ å¼€æœºæ—¶ä¸€æ¬¡æ€§ä»»åŠ¡</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">@reboot /home/luc/mystart.sh</span><br></pre></td></tr></table></figure>
<p>crontab æ˜¯æ¯ç”¨æˆ·çš„ï¼Œ å°±æ˜¯è¯´å½“å‰ç”¨æˆ·è®¾å®šçš„ä»»åŠ¡ï¼Œåªæœ‰å½“å‰ç”¨æˆ·çš„æƒé™ï¼Œæ‰€ä»¥å¦‚æœæœ‰äº›æƒ…å†µä¸‹ä»»åŠ¡æ‰§è¡Œéœ€è¦ root æƒé™ï¼Œå°±éœ€è¦åˆ‡æ¢åˆ° root ç”¨æˆ·å <code>crontab -e</code></p>
<h1 id="æ–‡æœ¬å¤„ç†-awk-sed-greprg-ä¸‰å‰‘å®¢"><a class="markdownIt-Anchor" href="#æ–‡æœ¬å¤„ç†-awk-sed-greprg-ä¸‰å‰‘å®¢"></a> æ–‡æœ¬å¤„ç† - awk, sed, grep(rg) ä¸‰å‰‘å®¢</h1>
<p>Linux ä¸‹çš„æ–‡æœ¬å¤„ç†ä¸‰å‰‘å®¢: grep, sed, awk, é™¤äº†å®ƒä»¬å…¶å®è¿˜æœ‰ä¸€äº›å°å·§çš„å‘½ä»¤ï¼Œå¦‚ <code>tr</code>, <code>cut</code> ä¹Ÿå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå¤„ç†å’Œæ ¼å¼åŒ–æ–‡æœ¬ã€‚<br />
ä¸‹é¢ä»¥ä¸€ä¸ªä¾‹å­ä¸ºä¾‹ã€‚</p>
<h2 id="awk"><a class="markdownIt-Anchor" href="#awk"></a> awk</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">awk &#x27;program&#x27; inputfile1 inputfile2 ...</span><br></pre></td></tr></table></figure>
<p>awk çš„è°ƒç”¨å½¢å¼å°±æ˜¯ä¸Šé¢è¿™æ ·çš„ï¼Œè€Œå…¶ä¸­çš„ <em>program</em> ç”±è‹¥å¹²æ¡ rules ç»„æˆï¼Œè€Œä¸€æ¡ <em>rule</em> ç”±ä¸€ä¸ª <em>pattern</em> å’Œä¸€ä¸ª <em>action</em> ç»„æˆ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pattern &#123; action &#125;</span><br><span class="line">pattern &#123; action &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ul>
<li><code>awk '&#123;$1=$1&#125;;1'</code>
<ul>
<li>å°†ä¸€ä¸ªå­—æ®µå‰åçš„ç©ºç™½(ç©ºæ ¼å’Œ Tab) å…¨éƒ¨æ¸…é™¤</li>
</ul>
</li>
</ul>
<h2 id="sed"><a class="markdownIt-Anchor" href="#sed"></a> sed</h2>
<p>sed å’Œ awk ä¸€æ ·ï¼Œéƒ½æ˜¯æŒ‰è¡Œå¤„ç†æ–‡æœ¬çš„ã€‚</p>
<ul>
<li><code>sed -n '2 &#123;s/^/#/; p; q&#125;' file</code>
<ul>
<li>sed é»˜è®¤ä¼šå°†æ¯ä¸€è¡Œéƒ½æ‰“å°å‡ºæ¥ï¼Œ <code>-n</code> å–æ¶ˆè¿™ä¸€è¡Œä¸º</li>
<li>sed å¯ä»¥åœ¨æ“ä½œçš„å‰é¢æŒ‡å®šä½ç½®å’ŒèŒƒå›´ï¼Œ å¦‚
<ul>
<li>è¡Œå·</li>
<li>æ­£åˆ™è¡¨è¾¾å¼ <code>/^foo/</code></li>
<li>ä¸¤ä¸ªæ­£åˆ™è¡¨è¾¾å¼é”å®šèŒƒå›´ <code>/^foo/, /bar$/</code></li>
</ul>
</li>
<li>å¦‚æœ <code>-n</code> åï¼Œå®Œå…¨éƒ½ä¸æ‰“å°äº†ï¼Œä½†å¦‚æœåˆæƒ³å°†å¤„ç†åçš„è¡Œæ‰“å°å‡ºæ¥ï¼Œä½¿ç”¨ <code>p</code> å‘½ä»¤</li>
<li><code>q</code> å‘½ä»¤çš„ä½œç”¨æ˜¯<strong>ç«‹å³é€€å‡º</strong>ï¼Œsed çš„é»˜è®¤è¡Œä¸ºæ˜¯å¯¹ç¬¬2è¡Œå¤„ç†å®Œåï¼Œè™½ç„¶åé¢çš„è¡Œéƒ½ä¸éœ€è¦å¤„ç†ï¼Œä½† sed ä»ç„¶ä¼šç»§ç»­å°†åé¢çš„æ¯è¡Œå¾€<strong>æ¨¡å¼ç©ºé—´</strong>åŠ è½½ã€‚</li>
</ul>
</li>
</ul>
<h2 id="grepripgrep"><a class="markdownIt-Anchor" href="#grepripgrep"></a> grep/ripgrep</h2>
<ul>
<li>
<p><strong>åœ¨ Linux å†…æ ¸æºç ç›®å½•ä¸‹ï¼Œæœç´¢ <code>drivers/gpu/drm</code> ä¸‹æ‰€æœ‰çš„ <code>DRIVER_NAME</code> å®šä¹‰ï¼Œå¹¶æ’åºåæ ¼å¼åŒ–è¾“å‡º</strong></p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rg <span class="string">&#x27;#define DRIVER_NAME&#x27;</span> drivers/gpu/drm --no-heading \</span><br><span class="line">	| <span class="built_in">tr</span> -s <span class="string">&#x27;\t&#x27;</span> | <span class="built_in">tr</span> <span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27; &#x27;</span> | <span class="built_in">tr</span> -s <span class="string">&#x27; &#x27;</span> \</span><br><span class="line">	| awk -F<span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;printf(&quot;%-52s%-40s\n&quot;,$1,$2)&#125;&#x27;</span> \</span><br><span class="line">	| <span class="built_in">sort</span> -k4</span><br></pre></td></tr></table></figure>
<ul>
<li><code>rg</code> (<a href="https://github.com/BurntSushi/ripgrep">ripgrep</a>) æ¯” grep æ›´å¿«ï¼Œæ›´å¼ºå¤§</li>
<li><code>tr</code> åœ¨ä¸å¸¦ä»»ä½•é€‰é¡¹æ—¶ï¼Œé»˜è®¤æ‰§è¡Œæ›¿æ¢ï¼Œä¾‹å­æ˜¯ä¸­å°† tab æ›¿æ¢æˆ ç©ºæ ¼, <code>-s</code> è¡¨ç¤º <code>squeeze-repeats</code>, å°±æ˜¯å»æ‰é‡å¤çš„å­—ç¬¦ï¼Œä¾‹å¦‚å¤šä¸ªç©ºæ ¼åªä¿ç•™ä¸€ä¸ª</li>
<li><code>awk</code> å¤©ç”Ÿæ”¯æŒ C-Style printf</li>
</ul>
</li>
<li>
<p><code>rg '\[package\]' -ttoml --glob '!Cargo.lock'</code></p>
<ul>
<li>åœ¨ä¸€ä¸ª rust é¡¹ç›®é¡¶å±‚ç›®å½•ï¼Œåªæœç´¢ .toml æ–‡ä»¶ä¸­çš„ <code>[package]</code>, è€Œå¿½ç•¥æ‰€æœ‰ Cargo.lock æ–‡ä»¶</li>
</ul>
</li>
</ul>
<h2 id="å¼•å·"><a class="markdownIt-Anchor" href="#å¼•å·"></a> å¼•å·</h2>
<p>å½“æ··åˆä½¿ç”¨ awk å’Œ sed æ—¶ï¼Œæ¯”è¾ƒä¾¿åˆ©åœ°å¤„ç†å¼•å·çš„æ–¹æ³•æ˜¯å®šä¹‰ awk å˜é‡ <code>-v Q=&quot;'&quot;</code></p>
<ul>
<li>awk çš„ <code>printf()</code> å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»ä½¿ç”¨åŒå¼•å· <code>printf(&quot;%s: %s%d%s\n&quot;, $1, Q, $2, Q)</code>
<ul>
<li>awk ä¸­çš„ç”¨æˆ·è‡ªå®šä¹‰å˜é‡å’Œå†…ç½®å˜é‡ï¼Œä½¿ç”¨æ—¶éƒ½ä¸éœ€è¦åŠ  <code>$</code>ï¼Œ å¦‚ <code>NR</code>, <code>NF</code></li>
</ul>
</li>
<li>awk å’Œ sed çš„å‘½ä»¤å­—ä¸²å¿…é¡»ç”¨å¼•å·æ‹¬èµ·æ¥ï¼Œå½“ç”¨ awk ç”Ÿæˆ sed å‘½ä»¤æ—¶ï¼Œå°†å•å¼•å·å®šä¹‰ä¸º awk å˜é‡å°¤å…¶æ–¹ä¾¿ï¼Œå¯è¯»æ€§ä¹Ÿå¼º</li>
</ul>
<h2 id="è¡ŒèŒƒå›´-line-range"><a class="markdownIt-Anchor" href="#è¡ŒèŒƒå›´-line-range"></a> è¡ŒèŒƒå›´ (Line range)</h2>
<p>sed, awk éƒ½æ”¯æŒè¡ŒèŒƒå›´ï¼Œå¦‚ <code>sed -n '3,5p'</code>, <code>awk 'NR &gt;= 3 &amp;&amp; NR &lt;= 5'</code>ï¼Œå®ƒä»¬çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯åªæ‰“å°ç»™å®šæ–‡ä»¶çš„ 3 åˆ° 5 è¡Œï¼Œ é™¤äº†<strong>è¡Œå·</strong>ï¼Œ sed, awk è¿˜æ”¯æŒé€šè¿‡<strong>æ­£åˆ™åŒ¹é…</strong>æ¥æŒ‡å®šè¡Œä½ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sed -n &#x27;/foo/,$p&#x27;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>$</code> è¡¨ç¤ºæœ€åä¸€è¡Œ</li>
<li><code>p</code> æ˜¯ sed <code>print</code> å‘½ä»¤çš„ç¼©å†™</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">awk &#x27;/foo/ &#123;f=1&#125; f&#x27;</span><br></pre></td></tr></table></figure>
<ul>
<li>awk å®ç°è¡ŒèŒƒå›´çš„æ–¹å¼ä¸ sed ç¨æœ‰ä¸åŒï¼Œå®ƒåœ¨æ»¡è¶³åŒ¹é… <code>foo</code> è¿™ä¸ªæ¡ä»¶æ—¶ï¼Œå°†<strong>å¸ƒå°”</strong>å˜é‡ <code>f</code> è®¾ç½®ä¸º 1ï¼Œç›¸å½“äºä»è¿™ä¸€è¡Œå¼€å§‹ï¼Œå¼€å¯ <code>print</code> æ‰“å°è¿™ä¸ªé»˜è®¤æ“ä½œ</li>
<li>awk çš„ä¸€æ¡ rule é‡Œï¼Œå¯ä»¥çœç•¥ <em>pattern</em>, æˆ–è€…çœç•¥ <em>action</em>, ä½†<strong>ä¸èƒ½åŒæ—¶ä¸¤ä¸ªéƒ½çœç•¥</strong>ï¼›å¦‚æœçœç•¥ <em>pattern</em>, åˆ™å¯¹æ¯ä¸ªè¾“å…¥è¡Œéƒ½æ‰§è¡Œ <em>action</em>, å¦‚æœçœç•¥ <em>action</em>, åˆ™å¯¹æ¯ä¸ªåŒ¹é…è¡Œæ‰§è¡Œ <code>print</code> <em>action</em>ã€‚è¿™ä¸ªä¾‹å­é‡Œé¢ï¼Œ awk çš„ <em>program</em> åŒ…æ‹¬ä¸¤æ¡ <em>rules</em>
<ul>
<li><code>/foo/ &#123;f=1&#125;</code> è¿™æ¡ <em>rule</em> ä»€ä¹ˆéƒ½æ²¡æœ‰çœç•¥</li>
<li><code>f</code> è¿™æ¡ <em>rule</em> çœç•¥äº† <em>action</em>, æ‰€ä»¥å¯¹æ¯ä¸ªè¾“å…¥è¡Œæ‰§è¡Œ <code>print</code> <em>action</em></li>
</ul>
</li>
</ul>
<p>å®ƒä»¬ä¸¤ä¸ªçš„æ•ˆæœä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ä»ç¬¬ä¸€ä¸ªåŒ¹é… <code>foo</code> çš„è¡Œå¼€å§‹ï¼Œä¸€ç›´æ‰“å°åˆ°æ–‡ä»¶ç»“æŸã€‚</p>
<h2 id="æ­£åˆ™åŒ¹é…-regex-match"><a class="markdownIt-Anchor" href="#æ­£åˆ™åŒ¹é…-regex-match"></a> æ­£åˆ™åŒ¹é… (Regex match)</h2>
<p>awk ä¸­ä¸€ä¸ª <em>rule</em> ä¸­çš„ <em>pattern</em> éƒ¨åˆ†å¯ä»¥åªæ˜¯ä¸€æ¡ <code>/</code> æ‹¬èµ·æ¥çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œé»˜è®¤è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„<strong>åŒ¹é…</strong>å¯¹è±¡æ˜¯ <code>$0</code>, ä¹Ÿå°±æ˜¯<strong>æ•´è¡Œ</strong>ï¼Œ å¦‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">awk &#x27;/foo/&#x27;</span><br></pre></td></tr></table></figure>
<p>å®ƒå®é™…ä¸Šæ˜¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">awk &#x27;$0~/foo/ &#123;print $0&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>å®ƒæ„æ€æ˜¯åªè¦å½“å‰è¡Œé‡ŒåŒ…å« <code>foo</code> è¿™ä¸ªå­—ä¸²ï¼Œå°±æ‰“å°è¿™ä¸€è¡Œã€‚æ‰€ä»¥ awk çš„æ­£åˆ™ <em>pattern</em>, å‡†ç¡®æ¥è¯´æ˜¯ç”¨æ¥<strong>æœç´¢</strong>çš„</p>
<p>é»˜è®¤æƒ…å†µä¸‹æ˜¯ <code>$0~/foo/</code>, é‚£ä¹ˆä¸é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ä»¥æŒ‡å®šå“ªä¸ª <code>field</code> å»â€œåŒ¹é…â€ï¼Œ å¦‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">awk &#x27;$1~/foo/ &amp;&amp; $3!~/bar/ &#123;print&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>å®ƒæ„æ€æ˜¯å½“å‰è¿™æ¡è®°å½•ï¼Œå¦‚æœç¬¬1ä¸ªå­—æ®µåŒ…å« <code>foo</code> <strong>ä¸”</strong> ç¬¬3ä¸ªå­—æ®µ<strong>ä¸åŒ…å«</strong> <code>bar</code>, é‚£ä¹ˆå°±æ‰“å°æ•´æ¡è®°å½•</p>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>TeX/LaTex</title>
    <url>/utils/texlive/</url>
    <content><![CDATA[<h1 id="texlatex"><a class="markdownIt-Anchor" href="#texlatex"></a> TeX/LaTeX</h1>
<p>TeX æ˜¯é«˜å¾·çº³(Donald Knuth)å‘æ˜çš„ç¼–ç¨‹å¼æ’ç‰ˆè¯­è¨€ï¼Œè€Œ LaTeX æ˜¯è±æ–¯åˆ©Â·å…°æ³¢ç‰¹(Leslie Lamport)åœ¨ TeX çš„åŸºç¡€ä¸Šå¼€å‘çš„ TeX çš„æ‰©å±•å®é›†ã€‚</p>
<h2 id="ç”Ÿæˆ-pdf-çš„å·¥å…·"><a class="markdownIt-Anchor" href="#ç”Ÿæˆ-pdf-çš„å·¥å…·"></a> ç”Ÿæˆ PDF çš„å·¥å…·</h2>
<ul>
<li><a href="https://github.com/jgm/pandoc">pandoc</a> æ ‡è®°è¯­è¨€è½¬æ¢é¢†åŸŸçš„&quot;ç‘å£«å†›åˆ€&quot;
<ul>
<li>å°† Markdown ç”Ÿæˆ PDF</li>
</ul>
</li>
<li><a href="https://ftp.ntou.edu.tw/ctan/systems/texlive/Images/">TexLive</a> å¼€å‘æœ€ä¸ºæ´»è·ƒçš„ TeX å‘è¡Œç‰ˆä¹‹ä¸€
<ul>
<li>TexLive æ˜¯è·¨å¹³å°çš„ï¼Œä½†ä¸€èˆ¬åœ¨ Linux ä¸‹å®‰è£…ï¼ŒMacOS ä¸‹æ˜¯ MacTeX, Windows ä¸‹æ˜¯ MiKTeX.</li>
</ul>
</li>
<li><a href="https://github.com/Wandmalfarbe/pandoc-latex-template">eisvogel</a> ç®€æ´çš„ pandoc LaTex æ¨¡æ¿
<ul>
<li>eisvogel è¦æ±‚ä¸€ä¸ªå®Œæ•´çš„ TexLive çš„å®‰è£…ç¯å¢ƒï¼Œä½†é€šå¸¸åƒ CentOS è¿™æ ·çš„ Linux å‘è¡Œç‰ˆè‡ªå¸¦çš„ TexLive å¹¶ä¸å®Œæ•´ã€‚</li>
</ul>
</li>
</ul>
<h1 id="how-to-install-texliveiso"><a class="markdownIt-Anchor" href="#how-to-install-texliveiso"></a> How to Install <a href="https://www.tug.org/texlive/acquire-iso.html"><code>texlive.iso</code></a></h1>
<h2 id="quick-install"><a class="markdownIt-Anchor" href="#quick-install"></a> <a href="https://www.tug.org/texlive/quickinstall.html">Quick Install</a></h2>
<p>å°† TexLive çš„é•œåƒä¸‹è½½å¹¶æŒ‚è½½åï¼Œé€šè¿‡é¡¶å±‚ç›®å½•ä¸‹çš„ <code>install-tl</code> è¿™ä¸ª Perl è„šæœ¬ç¨‹åºå®‰è£…ï¼Œæ•´ä¸ªå®‰è£…è¿‡ç¨‹è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ã€‚</p>
<h2 id="mount-iso-image"><a class="markdownIt-Anchor" href="#mount-iso-image"></a> mount ISO image</h2>
<p>å‡è®¾åœ¨ Linux ä¸‹ï¼Œé€šè¿‡ root ç”¨æˆ·æˆ– <code>sudo</code> æŒ‚è½½é•œåƒæ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /mnt/iso</span><br><span class="line">mount /path/to/texlive.iso /mnt/iso -o loop</span><br></pre></td></tr></table></figure>
<p>å› ä¸º ISO æ–‡ä»¶ç³»ç»Ÿæ˜¯åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥å¦‚æœæƒ³åœ¨ <code>/mnt/iso</code> å†™å…¥æ—¶ï¼Œè¿˜éœ€è¦å€ŸåŠ© Linux çš„ <strong>OverlayFS</strong> è¿›è¡Œå†æ¬¡æŒ‚è½½ï¼Œä¹‹ååœ¨ç›®å½• <code>/mnt/merged</code> é‡Œå°±æœ‰ä¸€ä»½å¯å†™ç‰ˆçš„é•œåƒäº†</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /mnt/&#123;upper,work,merged&#125;</span><br><span class="line">mount -t overlay overlay -o lowerdir=/mnt/iso,upperdir=/mnt/upper,workdir=/mnt/work /mnt/merged</span><br></pre></td></tr></table></figure>
<h2 id="run-installer"><a class="markdownIt-Anchor" href="#run-installer"></a> run installer</h2>
<p>TexLive çš„ installer æ˜¯ä¸€ä¸ª perl script, æä¾› text mode å’Œ GUI mode ä¸¤ç§å®‰è£…æ¨¡å¼.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">======================&gt; TeX Live installation procedure &lt;=====================</span><br><span class="line"></span><br><span class="line">======&gt;   Letters/digits in &lt;angle brackets&gt; indicate   &lt;=======</span><br><span class="line">======&gt;   menu items for actions or customizations      &lt;=======</span><br><span class="line">= help&gt;   https://tug.org/texlive/doc/install-tl.html   &lt;=======</span><br><span class="line"></span><br><span class="line"> Detected platform: GNU/Linux on x86_64</span><br><span class="line"></span><br><span class="line"> &lt;B&gt; set binary platforms: 1 out of 6</span><br><span class="line"></span><br><span class="line"> &lt;S&gt; set installation scheme: scheme-full</span><br><span class="line"></span><br><span class="line"> &lt;C&gt; set installation collections:</span><br><span class="line">     40 collections out of 41, disk space required: 7262 MB (free: 168365 MB)</span><br><span class="line"></span><br><span class="line"> &lt;D&gt; set directories:</span><br><span class="line">   TEXDIR (the main TeX directory):</span><br><span class="line">     !! default location: /usr/local/texlive/2022</span><br><span class="line">     !! is not writable or not allowed, please select a different one!</span><br><span class="line">   TEXMFLOCAL (directory for site-wide local files):</span><br><span class="line">     /usr/local/texlive/texmf-local</span><br><span class="line">   TEXMFSYSVAR (directory for variable and automatically generated data):</span><br><span class="line">     /usr/local/texlive/2022/texmf-var</span><br><span class="line">   TEXMFSYSCONFIG (directory for local config):</span><br><span class="line">     /usr/local/texlive/2022/texmf-config</span><br><span class="line">   TEXMFVAR (personal directory for variable and automatically generated data):</span><br><span class="line">     ~/.texlive2022/texmf-var</span><br><span class="line">   TEXMFCONFIG (personal directory for local config):</span><br><span class="line">     ~/.texlive2022/texmf-config</span><br><span class="line">   TEXMFHOME (directory for user-specific files):</span><br><span class="line">     ~/texmf</span><br><span class="line"></span><br><span class="line"> &lt;O&gt; options:</span><br><span class="line">   [ ] use letter size instead of A4 by default</span><br><span class="line">   [X] allow execution of restricted list of programs via \write18</span><br><span class="line">   [X] create all format files</span><br><span class="line">   [X] install macro/font doc tree</span><br><span class="line">   [X] install macro/font source tree</span><br><span class="line">   [ ] create symlinks to standard directories</span><br><span class="line">   [X] after install, set CTAN as source for package updates</span><br><span class="line"></span><br><span class="line"> &lt;V&gt; set up for portable installation</span><br><span class="line"></span><br><span class="line">Actions:</span><br><span class="line"> &lt;I&gt; start installation to hard disk</span><br><span class="line"> &lt;P&gt; save installation profile to &#x27;texlive.profile&#x27; and exit</span><br><span class="line"> &lt;Q&gt; quit</span><br><span class="line"></span><br><span class="line">Enter command:</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>D</code></strong>: è®¾ç½®å®‰è£…è·¯å¾„ï¼Œç›¸å½“äºæŒ‡å®š <code>--prefix</code></li>
<li><strong><code>P</code></strong>: ä¿å­˜å®‰è£…çš„é…ç½®åˆ°æ–‡ä»¶ <code>texlive.profile</code>, ä¹‹åå¯ä»¥ç›´æ¥ç¼–è¾‘è¿™ä¸ªæ–‡ä»¶ï¼Œè¿è¡Œ <code>install-tl</code> æ—¶é€šè¿‡ <code>--profile</code> å¯ä»¥ç›´æ¥è¯»å–è¿™ä¸ªæ–‡ä»¶ä¸­çš„å®‰è£…é…ç½®</li>
</ul>
<h2 id="create-symlinks-to-standard-directories"><a class="markdownIt-Anchor" href="#create-symlinks-to-standard-directories"></a> create symlinks to standard directories</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Options customization:</span><br><span class="line"></span><br><span class="line"> &lt;P&gt; use letter size instead of A4 by default: [ ]</span><br><span class="line"> &lt;E&gt; execution of restricted list of programs: [X]</span><br><span class="line"> &lt;F&gt; create all format files:                  [X]</span><br><span class="line"> &lt;D&gt; install font/macro doc tree:              [X]</span><br><span class="line"> &lt;S&gt; install font/macro source tree:           [X]</span><br><span class="line"> &lt;L&gt; create symlinks in standard directories:  [X]</span><br><span class="line">            binaries to: /usr/bin</span><br><span class="line">            manpages to: /usr/man</span><br><span class="line">                info to: /usr/info</span><br><span class="line"> &lt;Y&gt; after install, set CTAN as source for package updates:</span><br><span class="line">                                               [X]</span><br></pre></td></tr></table></figure>
<p>æœ€å¥½å‹¾é€‰æ­¤é€‰é¡¹ï¼Œé¿å…ä½¿ç”¨ TexLive æ—¶å„ç§ <code>Not Found</code>, åŸå› æ˜¯ TexLive é»˜è®¤å®‰è£…è·¯å¾„å¹¶ä¸æ˜¯æ ‡å‡† Linux å¯æ‰§è¡Œç¨‹åºçš„è·¯å¾„(å¦‚ <code>/usr/bin</code>), è€Œæ˜¯ <code>/usr/local/texlive</code>, å¦‚åœ¨ x86_64 å®‰è£… <code>texlive2022.iso</code>, åˆ™å¯æ‰§è¡Œç¨‹åºè¢«å®‰è£…åœ¨ <code>/usr/local/texlive/2022/bin/x86_64-linux</code>. å‡å¦‚ä¸æƒ³å› ä¸ºè¯¥è·¯å¾„æ²¡æœ‰åœ¨ <code>PATH</code> é‡Œï¼Œæœ€å¥½å°±æ˜¯åœ¨å®‰è£…æ—¶ç›´æ¥åœ¨ <code>/usr/bin</code> ä¸‹åˆ›å»ºç›¸åº”ç¬¦å·é“¾æ¥ã€‚</p>
<h2 id="non-interactive-installation"><a class="markdownIt-Anchor" href="#non-interactive-installation"></a> Non-interactive Installation</h2>
<p>å½“ä½ æœ‰ä¸€ä»½ <code>texlive.profile</code> æ—¶ï¼Œå°±å¯ä»¥æ‰§è¡Œéäº¤äº’å¼å®‰è£…ï¼Œ<code>install-tl</code> ä¼šç›´æ¥æŒ‰ç…§ <code>texlive.profile</code> æ–‡ä»¶é‡Œçš„é…ç½®å®‰è£…ï¼Œæ— éœ€å¹²é¢„</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./install-tl --no-interaction --profile=texlive.profile</span><br></pre></td></tr></table></figure>
<h1 id="texlive-full"><a class="markdownIt-Anchor" href="#texlive-full"></a> texlive-full</h1>
<p>åœ¨ä½¿ç”¨ xelatex, pdflatex ç­‰ latex ç¨‹åºæ—¶ï¼Œå¯ä»¥å¸¸å¸¸é‡åˆ°ç±»ä¼¼</p>
<p><code>! LaTeX Error: File 'fontawesome.sty' not found</code></p>
<p>xxx.sty è¿™æ ·çš„æŠ¥é”™ï¼Œä¸€èˆ¬æ˜¯ç¼ºå°‘æŸä¸ª texlive åŒ…ï¼Œä½† texlive çš„åŒ…å¤ªå¤šäº†ï¼Œå¦‚æœæ‡’å¾—ä¸€ä¸ªä¸€ä¸ªå®‰è£…ï¼Œå¯ä»¥</p>
<p><code>sudo apt install texlive-full</code></p>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>update-alternatives</title>
    <url>/utils/update-alternatives/</url>
    <content><![CDATA[<h1 id="whats-the-problem"><a class="markdownIt-Anchor" href="#whats-the-problem"></a> Whatâ€™s the problem</h1>
<p>æœ‰æ—¶åœ¨ä½ çš„ç³»ç»Ÿä¸Šå¯èƒ½å·²ç»å®‰è£…äº†å¤šä¸ªgccç‰ˆæœ¬(gcc-4.8, gcc-8, gcc-9)æˆ–Pythonç‰ˆæœ¬(Python, Python 2.7, Python 3.8), é‚£ä¹ˆå½“ä½ æ‰§è¡Œgccæˆ–pythonå‘½ä»¤æ—¶ï¼Œåˆ°åº•ç”¨çš„æ˜¯å“ªä¸ªgccæˆ–pythonç‰ˆæœ¬å‘¢ï¼Ÿè€Œä¸”å¦‚ä½•æ–¹ä¾¿åœ°æŒ‡å®šæˆ‘ä»¬æœŸæœ›ä½¿ç”¨çš„ç‰ˆæœ¬å‘¢ï¼Ÿåœ¨å¤§å¤šæ•°Linuxå‘è¡Œç‰ˆéƒ½æœ‰ä¸€ä¸ª<strong>update-alternatives</strong>å‘½ä»¤ä¸“é—¨å¤„ç†è¿™ç§æƒ…å†µã€‚</p>
<span id="more"></span>
<h1 id="how-to-solve-it"><a class="markdownIt-Anchor" href="#how-to-solve-it"></a> How to solve it</h1>
<p><code>update-alternatives</code>é€šè¿‡åœ¨<code>/etc/alternatives/</code>ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªç¬¦å·é“¾æ¥æ–‡ä»¶ï¼Œé€šè¿‡ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶çš„æŒ‡å‘è¾¾åˆ°è½»æ¾æ›´æ¢åƒgccæˆ–Pythonè¿™ç±»ç³»ç»Ÿè½¯ä»¶çš„ç‰ˆæœ¬çš„ç›®çš„ã€‚</p>
<h2 id="synopsis"><a class="markdownIt-Anchor" href="#synopsis"></a> Synopsis</h2>
<p>update-alternatives [optionâ€¦] command</p>
<h2 id="commands"><a class="markdownIt-Anchor" href="#commands"></a> Commands</h2>
<p>â€“install <u>link</u> <u>name</u> <u>path</u> <u>priority</u></p>
<p>â€“set <u>name</u> <u>path</u></p>
<p>â€“remove <u>name</u> <u>path</u></p>
<p>â€“display <u>name</u></p>
<figure class="highlight shell"><figcaption><span>update-alternatives --display python</span></figcaption><table><tr><td class="code"><pre><span class="line">python - auto mode</span><br><span class="line">  link best version is /usr/bin/python3</span><br><span class="line">  link currently points to /usr/bin/python3</span><br><span class="line">  link python is /usr/bin/python</span><br><span class="line">/usr/bin/python3 - priority 5</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><figcaption><span>sudo update-alternatives --install</span><a href="/usr/bin/python">python /usr/bin/python3 3</a></figcaption><table><tr><td class="code"><pre><span class="line">update-alternatives: ä½¿ç”¨ /usr/bin/python3 æ¥åœ¨è‡ªåŠ¨æ¨¡å¼ä¸­æä¾› /usr/bin/python (python)</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><figcaption><span>python -V</span></figcaption><table><tr><td class="code"><pre><span class="line">Python 3.12.2</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>Sogou IM on Ubuntu Jammy Jellyfish</title>
    <url>/utils/upgrade-ubuntu/</url>
    <content><![CDATA[<h1 id="reminiscence"><a class="markdownIt-Anchor" href="#reminiscence"></a> Reminiscence</h1>
<span id="more"></span>
<h1 id="display-drivers-for-nvidia-gt-520m"><a class="markdownIt-Anchor" href="#display-drivers-for-nvidia-gt-520m"></a> Display Drivers for NVIDIA GT 520M</h1>
<p><img src="/images/upgrade-ubuntu/before-install-driver.png" alt="Before NVIDIA Display Driver Installed" /></p>
<h2 id="what-will-be-installed-by-this-installer"><a class="markdownIt-Anchor" href="#what-will-be-installed-by-this-installer"></a> What Will Be Installed By This Installer?</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /usr/lib/modules -name <span class="string">&#x27;*nvidia*.ko&#x27;</span> -<span class="built_in">exec</span> <span class="built_in">ls</span> -l --time-style=long-iso &#123;&#125; \;| awk <span class="string">&#x27;&#123;print $(NF-2), substr($NF, 43)&#125;&#x27;</span> | <span class="built_in">sort</span></span><br><span class="line"></span><br><span class="line">2022-07-12 drivers/i2c/busses/i2c-nvidia-gpu.ko</span><br><span class="line">2022-07-12 drivers/platform/x86/nvidia-wmi-ec-backlight.ko</span><br><span class="line">2022-07-12 drivers/usb/typec/altmodes/typec_nvidia.ko</span><br><span class="line">2022-07-12 drivers/video/fbdev/nvidia/nvidiafb.ko</span><br><span class="line">2022-10-13 drivers/i2c/busses/i2c-nvidia-gpu.ko</span><br><span class="line">2022-10-13 drivers/platform/x86/nvidia-wmi-ec-backlight.ko</span><br><span class="line">2022-10-13 drivers/usb/typec/altmodes/typec_nvidia.ko</span><br><span class="line">2022-10-13 drivers/video/fbdev/nvidia/nvidiafb.ko</span><br><span class="line">2022-11-11 drivers/video/nvidia-drm.ko</span><br><span class="line">2022-11-11 drivers/video/nvidia.ko</span><br><span class="line">2022-11-11 drivers/video/nvidia-modeset.ko</span><br><span class="line">2022-11-11 drivers/video/nvidia-uvm.ko</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤–ï¼ŒInstaller å…è®¸ä½ å¤‡ä»½åŸæ¥çš„ Xorg.conf, ä½¿ç”¨æ–°çš„ nvidia.conf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ find /etc -newercc /usr/lib/modules/5.15.0-52-generic/kernel/drivers/video/nvidia.ko</span><br><span class="line"></span><br><span class="line">/etc/X11/xorg.conf</span><br><span class="line">/etc/X11/xorg.conf.nvidia-xconfig-original</span><br></pre></td></tr></table></figure>
<h1 id="sogou-im"><a class="markdownIt-Anchor" href="#sogou-im"></a> Sogou IM</h1>
<p>Sogou è¾“å…¥æ³•çœŸå¿ƒåšå¾—ä¸é”™ï¼Œæ”¯æŒä¸»æµçš„å›½äº§ Linux æ“ä½œç³»ç»Ÿã€‚ä»Šå¤©å°†ç³»ç»Ÿå‡çº§åˆ° Ubuntu 22.04.1 LTS åä¹‹å‰å®‰è£…çš„ Sogoupinyin çªç„¶ä¸å·¥ä½œäº†ã€‚åˆšå¼€å§‹æ²¡æƒ³åˆ°æ˜¯ç¼ºå°‘ <code>libqt5qml5</code> è¿™ä¸ªä¾èµ–ï¼Œä¸€é¡¿é‡è£… fcitx, sogoupinyin æ“ä½œåï¼Œè¿˜æ˜¯ä¸è¡Œï¼Œgoogle åæ‰å‘ç°åŸæ¥ sogoupinyin å®‰è£…åï¼Œå¯æ‰§è¡Œç¨‹åºéƒ½åœ¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/opt/sogoupinyin/files/bin</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è¿è¡Œè¿™ä¸ªç›®å½•ä¸‹çš„ <code>sogoupinyin-service</code> è¿™ä¸ªç¨‹åºåæ‰å‘ç°å®ƒæ— æ³•åŠ è½½ libqt5qml5.</p>
<p>å¦å¤–ï¼Œ<code>sogoupinyin-configtool</code> ä¹Ÿåœ¨ä¸Šé¢è¿™ä¸ªç›®å½•ï¼Œè€Œä¸” sogoupinyin ä¹Ÿæ”¯æŒäº”ç¬”</p>
<p><img src="/images/upgrade-ubuntu/sogoupinyin-configtool.png" alt="sogoupinyin config interface" /></p>
<h1 id="alacritty"><a class="markdownIt-Anchor" href="#alacritty"></a> Alacritty</h1>
<p><a href="https://github.com/alacritty/alacritty">Alacritty</a>æ˜¯ä¸€ä¸ª GPU åŠ é€Ÿçš„ Terminal Emulator.</p>
<p>å‡çº§ç³»ç»Ÿåï¼Œæ„Ÿè§‰ç³»ç»Ÿé»˜è®¤çš„ <code>gnome-terminal</code> çš„æ ‡é¢˜æ å¾ˆç¢çœ¼ï¼Œæ‰€ä»¥æƒ³æ¢ä¸€ä¸ªæ–°çš„ Terminal Emulator è¯•è¯•ï¼Œå°±é€‰æ‹©äº†ä¹‹å‰åœ¨å­¦ä¹  Rust æ—¶å¬è¯´è¿‡çš„ Alacritty, ä½†ç›®å‰ Jammy Jellyfish çš„å®˜æ–¹ PPA é‡Œå¹¶æ²¡æœ‰å®ƒçš„å®‰è£…åŒ…ã€‚ä¸‹é¢è¿™ä¸ª PPA å®‰è£…è¿‡ç¨‹å¾ˆä¸æ»‘, è€Œä¸”å®ƒè‡ªåŠ¨å°†å®‰è£…å¥½çš„ <code>/usr/bin/alacritty</code> è®¾ç½®ä¸ºé»˜è®¤çš„ <code>x-terminal-emulator</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:aslatter/ppa</span><br></pre></td></tr></table></figure>
<p>å®‰è£…åï¼Œ<code>Ctrl-Alt-T</code>ï¼ŒGood Looking</p>
<p><img src="/images/upgrade-ubuntu/alacritty-first-sight.png" alt="Alacritty" /></p>
]]></content>
      <categories>
        <category>misc</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>vim é€ŸæŸ¥æ‰‹å†Œ</title>
    <url>/utils/vim/</url>
    <content><![CDATA[<h1 id="visual-block-selection"><a class="markdownIt-Anchor" href="#visual-block-selection"></a> Visual Block Selection</h1>
<ul>
<li>
<p>é€‰æ‹© <code>&#123;&#125;</code>(curly braces) ä¹‹é—´çš„è¡Œ(åŒ…æ‹¬ <code>&#123;&#125;</code>)</p>
<ul>
<li><code>v%</code></li>
</ul>
</li>
<li>
<p>é€‰æ‹© <code>&#123;&#125;</code>(curly braces) ä¹‹é—´çš„è¡Œ(ä¸åŒ…æ‹¬ <code>&#123;&#125;</code>)</p>
<ul>
<li><code>vi&#123;</code></li>
</ul>
</li>
</ul>
<p>æ³¨æ„ï¼šå…‰æ ‡å¿…é¡»æ”¾åœ¨ <code>&#123;</code> æˆ–è€… <code>&#125;</code></p>
<h1 id="copy-paste"><a class="markdownIt-Anchor" href="#copy-paste"></a> Copy &amp; Paste</h1>
<h2 id="copy-to-clipboard"><a class="markdownIt-Anchor" href="#copy-to-clipboard"></a> Copy to clipboard</h2>
<ul>
<li>Normal æ¨¡å¼
<ul>
<li><code>&quot;+y</code></li>
</ul>
</li>
</ul>
<h2 id="paste-from-clipboard"><a class="markdownIt-Anchor" href="#paste-from-clipboard"></a> Paste from clipboard</h2>
<p>X11 window system æœ‰ 3 ä¸ª selections:</p>
<ul>
<li>PRIMARY è¡¨ç¤ºå½“å‰çš„å¯è§ selection</li>
<li>SECONDARY</li>
<li>CLIPBOARD é€šå¸¸æ‰€è¯´çš„å‰ªè´´æ¿ï¼Œç”¨æ¥å®Œæˆå‰ªè´´ï¼Œå¤åˆ¶å’Œç²˜è´´æ“ä½œ</li>
</ul>
<p>Vim æœ‰ä¸¤ä¸ªä¸“é—¨çš„å¯„å­˜å™¨åˆ†åˆ«ä¸ PRIMARY selection å’Œ CLIPBOARD selection å¯¹åº”</p>
<ul>
<li><code>&quot;*</code> (quotestar) PRIMARY</li>
<li><code>&quot;+</code> (quoteplus) CLIPBOARD</li>
</ul>
<p>å¦‚æœè¦åœ¨ Vim å†…éƒ¨å‰ªè´´ï¼Œå¤åˆ¶/ç²˜è´´å°±ä½¿ç”¨ <strong>quotestar</strong>, å¦‚æœè¦å°†å†…å®¹å‰ªè´´ï¼Œå¤åˆ¶/ç²˜è´´åˆ°ç³»ç»Ÿå‰ªè´´æ¿ï¼Œå°±ä½¿ç”¨ <strong>quoteplus</strong></p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ WSL Ubuntu é‡Œå¦‚æœæƒ³ç²˜è´´ Windows å‰ªè´´æ¿é‡Œçš„å†…å®¹åˆ° vim (æœ€å¥½æ˜¯ neovim, å› ä¸º vim å¯èƒ½æœªä½¿èƒ½ clipboard)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &quot;Hello, world!&quot; | clip.exe</span><br></pre></td></tr></table></figure>
<ul>
<li>Normal æ¨¡å¼
<ul>
<li><code>&quot;+p</code></li>
</ul>
</li>
</ul>
<p>å¦‚æœæƒ³ç²˜è´´ Ubuntu å‰ªè´´æ¿é‡Œçš„å†…å®¹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &quot;Hello, world!&quot; | xclip</span><br></pre></td></tr></table></figure>
<ul>
<li>Normal æ¨¡å¼
<ul>
<li><code>&quot;*p</code></li>
</ul>
</li>
</ul>
<h2 id="copy-from-above-or-below"><a class="markdownIt-Anchor" href="#copy-from-above-or-below"></a> Copy from above or below</h2>
<p>åœ¨ Insert æ¨¡å¼ä¸‹</p>
<ul>
<li><code>&lt;ctrl-y&gt;</code> copies the character from the line above</li>
<li><code>&lt;ctrl-e&gt;</code> copies the character from the line below (æœ¬è¡Œå°±æ˜¯è¿™æ ·è¾“å…¥çš„)</li>
</ul>
<h1 id="search-replace"><a class="markdownIt-Anchor" href="#search-replace"></a> Search &amp; Replace</h1>
<h2 id="åˆ é™¤å¤šè¡Œ-c-style-æ³¨é‡Š"><a class="markdownIt-Anchor" href="#åˆ é™¤å¤šè¡Œ-c-style-æ³¨é‡Š"></a> åˆ é™¤å¤šè¡Œ C-style æ³¨é‡Š</h2>
<ul>
<li>
<p><code>s;/\*\_.\&#123;-&#125;\*/;;</code></p>
<ul>
<li>
<p><code>;</code> å› ä¸ºè¦åŒ¹é… <code>/</code>, ä¸ºäº†çœå»è½¬ä¹‰ <code>/</code> çš„éº»çƒ¦ï¼Œå°† search å‘½ä»¤çš„åˆ†éš”ç¬¦ç”± <code>/</code> æ”¹ä¸º <code>;</code></p>
</li>
<li>
<p><code>/\*</code> åŒ¹é…å¼€å§‹çš„ <code>/*</code></p>
</li>
<li>
<p><code>\_.</code> åŒ¹é…ä»»æ„å­—ç¬¦ï¼ŒåŒ…æ‹¬ <code>\n</code>, æ‰€ä»¥å¸¸ç”¨åœ¨å¤šè¡ŒåŒ¹é…</p>
</li>
<li>
<p><code>\&#123;-&#125;</code> æŒ‡éè´ªå©ª (non-greedy) åŒ¹é…ï¼Œå³åŒ¹é…æœ€çŸ­çš„å­—ä¸²ï¼Œé»˜è®¤æ˜¯è´ªå©ªåŒ¹é…ï¼ŒåŒ¹é…æœ€é•¿çš„å­—ä¸²</p>
</li>
<li>
<p><code>\*/</code> åŒ¹é…ç»“å°¾çš„ <code>*/</code></p>
</li>
<li>
<p><code>;;</code> æŒ‡ä½¿ç”¨ç©ºæ›¿æ¢åŒ¹é…ç»“æœï¼Œå³åˆ é™¤</p>
</li>
<li>
<p>ä»¥ä¸‹æ˜¯ vim ä¸­åœ¨å•è¡Œä¸­ä½¿ç”¨çš„é€šé…ç¬¦ (wildcard), è¿™äº›é€šé…ç¬¦ä¸€èˆ¬ä¸èƒ½åŒ¹é…æ¢è¡Œ <code>\n</code></p>
<ul>
<li><code>.</code> åŒ¹é…é™¤äº† <code>\n</code> çš„ä»»æ„å­—ç¬¦</li>
<li><code>^</code> è¡Œé¦–ï¼Œå³é”šç‚¹ (anchor)</li>
<li><code>$</code> è¡Œå°¾ï¼Œå³é”šç‚¹</li>
<li><code>\s</code> åŒ¹é… space, tab, ä½†ä¸åŒ¹é… <code>\n</code></li>
</ul>
</li>
<li>
<p>ä»¥ä¸Šé€šé…ç¬¦åŠ ä¸Š <code>\_</code> åå¯ä»¥åœ¨å¤šè¡ŒåŒ¹é…ä¸­ä½¿ç”¨ï¼Œå³ä¹Ÿå¯ä»¥åŒ¹é… <code>\n</code></p>
<ul>
<li><code>\_.</code> åŒ¹é…ä»»æ„å­—ç¬¦ï¼ŒåŒ…æ‹¬ <code>\n</code></li>
<li><code>\_^</code> å¤šè¡Œä¸­ç¬¬ä¸€è¡Œè¡Œé¦–</li>
<li><code>\_$</code> å¤šè¡Œä¸­æœ€åä¸€è¡Œè¡Œå°¾</li>
<li><code>\_s</code> åŒ¹é… space, tab å’Œ <code>\n</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="åˆ é™¤ç©ºç™½è¡Œ"><a class="markdownIt-Anchor" href="#åˆ é™¤ç©ºç™½è¡Œ"></a> åˆ é™¤ç©ºç™½è¡Œ</h2>
<ul>
<li>
<p><code>g/^\s*$/d</code></p>
<ul>
<li><code>g</code> æŒ‡æ‰€æœ‰è¡Œæœç´¢ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„å…‰æ ‡æ‰€åœ¨è¡Œ</li>
<li><code>^\s*$</code> åŒ¹é…è¡Œé¦–åˆ°è¡Œå°¾ä¹‹é—´ä»»æ„ä¸ªç©ºç™½å­—ç¬¦ï¼Œå³ç©ºç™½è¡Œ</li>
<li><code>d</code> åˆ é™¤å‘½ä»¤ (delete)</li>
</ul>
</li>
</ul>
<h2 id="æœç´¢ä¸åŒ¹é…æŸæ¨¡å¼çš„è¡Œå³åå‘æœç´¢"><a class="markdownIt-Anchor" href="#æœç´¢ä¸åŒ¹é…æŸæ¨¡å¼çš„è¡Œå³åå‘æœç´¢"></a> æœç´¢ä¸åŒ¹é…æŸæ¨¡å¼çš„è¡Œï¼Œå³åå‘æœç´¢</h2>
<ul>
<li>
<p><code>/^\(\(^# .*$\)\@!.\)*$</code></p>
<ul>
<li><code>/</code> æŸ¥æ‰¾å‘½ä»¤ (search) çš„æç¤ºç¬¦</li>
<li><code>^\(\(The_Regex\)\@!.\)*$</code> åå‘æŸ¥æ‰¾çš„å‘½ä»¤å›ºå®šæ¨¡å¼ï¼Œæœ¬ä¾‹ä¸­ <code>The_Regex</code> æ˜¯ <code>^# .*$</code> å³ä»¥ <code># </code> å¼€å¤´çš„è¡Œï¼Œæ‰€ä»¥æ•´ä¸ªè¡¨è¾¾å¼åŒ¹é…çš„å°±æ˜¯ä¸ä»¥ <code># </code> å¼€å¤´çš„æ‰€æœ‰è¡Œ</li>
</ul>
</li>
<li>
<p><code>:v/^# .*$/p</code></p>
<ul>
<li>ä¸ä¸Šé¢çš„åå‘æŸ¥æ‰¾å‘½ä»¤åŠŸèƒ½ç›¸åŒ, ä½†ä¼šå°†åŒ¹é…ç»“æœæ˜¾ç¤ºåœ¨ Visual æ¨¡å¼ä¸‹</li>
</ul>
</li>
</ul>
<h2 id="å¤§å°å†™è½¬æ¢"><a class="markdownIt-Anchor" href="#å¤§å°å†™è½¬æ¢"></a> å¤§å°å†™è½¬æ¢</h2>
<ul>
<li>
<p><code>s/\(^# .*$\)/\L\1/</code></p>
<ul>
<li><code>\(The_Regex\)</code> ä¸ºäº†<strong>å‘å‰ç´¢å¼•</strong>ï¼Œå³åé¢ <code>\1</code> æ‰€æŒ‡çš„éƒ¨åˆ†ï¼Œæœ¬ä¾‹ä¸­ <code>The_Regex</code> æ˜¯ <code>^# .*$</code>, æ„æ€åŒä¸Š</li>
<li><code>\L\1</code> <code>\L</code> æŒ‡ <strong>L</strong>owercase, å³å°† <code>\1</code> åŒ¹é…çš„ç»“æœä¸­çš„æ‰€æœ‰å­—æ¯éƒ½æ¢æˆå°å†™</li>
</ul>
</li>
<li>
<p><code>s/\(^# .*$\)/\U\1/</code></p>
<ul>
<li>ä¸ä¸Šé¢çš„è¡¨è¾¾å¼åŠŸèƒ½ç›¸åï¼Œå³å°† <code>\1</code> åŒ¹é…çš„ç»“æœä¸­çš„æ‰€æœ‰å­—æ¯éƒ½æ¢æˆå¤§å†™ (<strong>U</strong>ppercase)</li>
</ul>
</li>
</ul>
<h2 id="expression-register"><a class="markdownIt-Anchor" href="#expression-register"></a> expression register</h2>
<p>å‡å¦‚ä½ åœ¨ markdown æ–‡ä»¶é‡Œç¼–è¾‘ä¸€ä¸ª Table, table çš„ç¬¬1åˆ—æ˜¯ <code>find</code> çš„è¾“å‡ºï¼šä¸€ä¸ªå¾ˆé•¿çš„æ–‡ä»¶åˆ—è¡¨ï¼Œä¸”æ–‡ä»¶åé•¿çŸ­ä¸ä¸€(å‡å¦‚æœ€é•¿çš„æ–‡ä»¶åæ˜¯ 100 ä¸ªå­—ç¬¦)ï¼Œä½ å¦‚ä½•åœ¨ 100 åˆ—æ’å…¥ vertical bar (|)?</p>
<ul>
<li>
<p><code>N,Ms/.*/\=printf('%-101s|', submatch(0))/</code></p>
<ul>
<li><code>N,M</code> æŒ‡å®šæ›¿æ¢çš„èŒƒå›´</li>
<li><code>\=</code> è¡¨ç¤ºä½¿ç”¨ expression register, è¿™é‡Œç›¸å½“äºæŠŠ <code>printf()</code> å‡½æ•°çš„è¾“å‡ºå¯¼å…¥åˆ°è¿™é‡Œ</li>
</ul>
</li>
</ul>
<h1 id="tohtml"><a class="markdownIt-Anchor" href="#tohtml"></a> TOhtml</h1>
<p><strong>vim</strong> æœ‰ä¸€ä¸ªå†…ç½®çš„æ‰©å±• <strong>TOhtml</strong>, å¯ä»¥å°† vim çš„ buffer è‡ªåŠ¨è½¬æˆ html æ–‡ä»¶ï¼Œè¿™ä¸ªåŠŸèƒ½å¯¹äº <strong>vimdiff</strong> æ—¶å°¤å…¶æœ‰ç”¨ã€‚</p>
<ol>
<li><code>:[range]TOhtml</code> <em>range</em> æ²¡æœ‰æ—¶é»˜è®¤æ˜¯æ•´ä¸ª buffer (vimdiff æ—¶åŒ…æ‹¬å·¦å³ä¸¤ä¸ª window å“¦)</li>
<li><code>:wqa</code> ç”Ÿæˆçš„ html é»˜è®¤ä¿å­˜ä¸º <a href="https://pastebin.com/nEtsC1Ce">Diff.html</a></li>
<li>å¯ä»¥å°†ç”Ÿæˆçš„ html å†…å®¹ç›´æ¥ç²˜è´´åˆ° <a href="https://jsbin.com/cikulin/edit?html,output">jsbin.com</a>, ç„¶åå°±å¯ä»¥åˆ†äº«ç»™ä»–äºº</li>
</ol>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>tools</tag>
      </tags>
  </entry>
  <entry>
    <title>virtio</title>
    <url>/utils/virtio/</url>
    <content><![CDATA[<h1 id="virtio-åŠè™šæ‹ŸåŒ–è®¾å¤‡æ ‡å‡†"><a class="markdownIt-Anchor" href="#virtio-åŠè™šæ‹ŸåŒ–è®¾å¤‡æ ‡å‡†"></a> virtio - åŠè™šæ‹ŸåŒ–è®¾å¤‡æ ‡å‡†</h1>
<table>
<thead>
<tr>
<th><strong>å¯¹æ¯”é¡¹</strong></th>
<th><strong>å…¨è™šæ‹ŸåŒ–</strong>ï¼ˆEmulatedï¼‰</th>
<th><strong>Virtio</strong>ï¼ˆåŠè™šæ‹ŸåŒ–ï¼‰</th>
<th><strong>SR-IOV</strong>ï¼ˆç›´é€šï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ€§èƒ½</strong></td>
<td>âŒ ä½ï¼ˆæ¨¡æ‹Ÿå¼€é”€å¤§ï¼‰</td>
<td>âœ… é«˜</td>
<td>âœ…âœ… è¶…é«˜ï¼ˆç¡¬ä»¶ç›´é€šï¼‰</td>
</tr>
<tr>
<td><strong>é©±åŠ¨æ”¯æŒ</strong></td>
<td>æ— éœ€é¢å¤–é©±åŠ¨ï¼ˆä½†æ…¢ï¼‰</td>
<td>éœ€è¦<strong>Virtio é©±åŠ¨</strong></td>
<td>éœ€è¦<strong>ç‰©ç†è®¾å¤‡é©±åŠ¨</strong></td>
</tr>
<tr>
<td><strong>é€‚ç”¨åœºæ™¯</strong></td>
<td>é€‚ç”¨äºæ—  Virtio æ”¯æŒçš„æ—§ OS</td>
<td>æ™®éé€‚ç”¨äº VM</td>
<td>é€‚ç”¨äºé«˜æ€§èƒ½ç½‘ç»œå­˜å‚¨</td>
</tr>
<tr>
<td><strong>ç¡¬ä»¶éœ€æ±‚</strong></td>
<td>æ— ç‰¹æ®Šéœ€æ±‚</td>
<td>æ— ç‰¹æ®Šéœ€æ±‚</td>
<td>éœ€è¦<strong>ç¡¬ä»¶æ”¯æŒ</strong></td>
</tr>
</tbody>
</table>
<span id="more"></span>
<h1 id="vfio"><a class="markdownIt-Anchor" href="#vfio"></a> vfio</h1>
<h1 id="å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#å‚è€ƒèµ„æ–™"></a> å‚è€ƒèµ„æ–™</h1>
<ul>
<li><a href="https://lore.kernel.org/all/20250903221111.3866249-1-zhiw@nvidia.com/">[RFC v2 00/14] Introduce NVIDIA GPU Virtualization (vGPU) Support</a></li>
</ul>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>virtualization</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows Subsystem for Linux</title>
    <url>/utils/wsl/</url>
    <content><![CDATA[<h1 id="wsl"><a class="markdownIt-Anchor" href="#wsl"></a> WSL</h1>
<p><a href="https://zh.wikipedia.org/zh-cn/%E9%80%82%E7%94%A8%E4%BA%8ELinux%E7%9A%84Windows%E5%AD%90%E7%B3%BB%E7%BB%9F">WSL (Windows Subsystem for Linux)</a>æ˜¯ä¸€ä¸ªèƒ½å¤Ÿåœ¨ Windows ç³»ç»Ÿ(Windows 10åŠä»¥ä¸Šç‰ˆæœ¬)ä¸ŠåŸç”Ÿè¿è¡Œ Linux å¯æ‰§è¡Œæ–‡ä»¶çš„å…¼å®¹å±‚ã€‚ç›®å‰æœ‰ä¸¤ä¸ªç‰ˆæœ¬: WSL, WSL2</p>
<span id="more"></span>
<p>æŸ¥çœ‹ Windows ç³»ç»Ÿä¸Šçš„ WSL ç‰ˆæœ¬</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">wsl <span class="literal">-l</span> <span class="literal">-v</span></span><br></pre></td></tr></table></figure>
<h1 id="wslg"><a class="markdownIt-Anchor" href="#wslg"></a> WSLg</h1>
<p>Microsoftåœ¨<code>Build 21364.co_release</code>ç‰ˆæœ¬å†…å‘å¸ƒäº†<a href="https://github.com/microsoft/wslg">WSLg</a>åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½å…è®¸åœ¨<strong>WSL</strong>é‡Œè¿è¡Œ<strong>X11</strong>å’Œ<strong>Wayland</strong>çš„å®¢æˆ·ç«¯ç¨‹åº(GUI Application).</p>
<p><img src="/images/wsl/xeyes.gif" alt="xeyes on WSL2" /></p>
<p>å¦‚æœä½ å·²ç»åŠ å…¥<a href="https://insider.windows.com/zh-cn/">Windows Insider Program</a>è®¡åˆ’å¹¶ä¸”ä¹Ÿæ­£åœ¨ä½¿ç”¨<strong>WSL2</strong>, é‚£ä¹ˆåªéœ€è¦å¦‚ä¸‹æ“ä½œå³å¯æ¿€æ´»<strong>WSLg</strong>åŠŸèƒ½ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PS C:\Windows\system32&gt; wsl --update</span><br><span class="line">æ­£åœ¨æ£€æŸ¥æ›´æ–°...</span><br><span class="line">æ­£åœ¨ä¸‹è½½æ›´æ–°...</span><br><span class="line">æ­£åœ¨å®‰è£…æ›´æ–°...</span><br><span class="line">æ­¤æ›´æ”¹å°†åœ¨ WSL ä¸‹æ¬¡å®Œå…¨é‡å¯æ—¶ç”Ÿæ•ˆã€‚è‹¥è¦å¼ºåˆ¶é‡å¯ï¼Œè¯·è¿è¡Œâ€œwsl --shutdownâ€ã€‚</span><br><span class="line">å†…æ ¸ç‰ˆæœ¬ï¼š 5.10.60.1</span><br></pre></td></tr></table></figure>
<p>å‡çº§ WSL2 åï¼Œåœ¨ <code>/mnt</code> ç›®å½•ä¸‹ä¼šæ¯”åŸæ¥å¤šå‡ºä¸€ä¸ª <code>wslg</code> çš„ç›®å½•</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">âœ  ~ cd /mnt/</span><br><span class="line">c/     wsl/   wslg/</span><br></pre></td></tr></table></figure>
<h2 id="nautilus"><a class="markdownIt-Anchor" href="#nautilus"></a> nautilus</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apt install nautilus -y</span><br></pre></td></tr></table></figure>
<p><img src="/images/wsl/wslg-nautilus.png" alt="WSLg nautilus" /></p>
<h2 id="glmark2"><a class="markdownIt-Anchor" href="#glmark2"></a> glmark2</h2>
<p><img src="/images/wsl/wslg-glmark2.png" alt="WSLg glmark2" /></p>
<h1 id="wsl-å¦‚ä½•æ”¯æŒ-nvidia"><a class="markdownIt-Anchor" href="#wsl-å¦‚ä½•æ”¯æŒ-nvidia"></a> WSL å¦‚ä½•æ”¯æŒ Nvidia</h1>
<p>åœ¨ <code>/usr/lib/wsl/lib</code> ä¸‹é»˜è®¤å®‰è£…äº†è¿™äº› shared libraries (usermode driver). è€Œä¸”æ­é…äº†è‡ªåŠ¨ç”Ÿæˆçš„ <code>/etc/ld.so.conf.d/ld.wsl.conf</code> æ–‡ä»¶ï¼Œèƒ½å¤Ÿè®©åŠ¨æ€åº“åŠ è½½å™¨æ­£ç¡®æ‰¾åˆ° nvidia ç›¸å…³çš„åº“ã€‚</p>
<ul>
<li><a href="http://libcuda.so">libcuda.so</a></li>
<li>libcuda.so.1</li>
<li>libcuda.so.1.1</li>
<li><a href="http://libd3d12.so">libd3d12.so</a></li>
<li><a href="http://libd3d12core.so">libd3d12core.so</a></li>
<li><a href="http://libdxcore.so">libdxcore.so</a></li>
<li><a href="http://libnvcuvid.so">libnvcuvid.so</a></li>
<li>libnvcuvid.so.1</li>
<li><a href="http://libnvdxdlkernels.so">libnvdxdlkernels.so</a></li>
<li><a href="http://libnvidia-encode.so">libnvidia-encode.so</a></li>
<li>libnvidia-encode.so.1</li>
<li>libnvidia-ml.so.1</li>
<li><a href="http://libnvidia-opticalflow.so">libnvidia-opticalflow.so</a></li>
<li>libnvidia-opticalflow.so.1</li>
<li><a href="http://libnvwgf2umx.so">libnvwgf2umx.so</a></li>
<li>nvidia-smi</li>
</ul>
<h1 id="å…³äº-wsl2-éœ€è¦çŸ¥é“çš„å‡ ä»¶äº‹"><a class="markdownIt-Anchor" href="#å…³äº-wsl2-éœ€è¦çŸ¥é“çš„å‡ ä»¶äº‹"></a> å…³äº WSL2 éœ€è¦çŸ¥é“çš„å‡ ä»¶äº‹</h1>
<ul>
<li>WSL2 æ‰€æœ‰çš„ Distros ä½¿ç”¨åŒä¸€ä¸ªå†…æ ¸ï¼Œä½ å¯ä»¥åœ¨åŒä¸€ä¸ª WSL2 å®‰è£… Ubuntu, å®‰è£… Debian, å®‰è£… Kali, ä½†ä¸ç®¡å®‰è£…å¤šå°‘ä¸ª Distros, å®ƒä»¬éƒ½ç”¨åŒä¸€ä¸ª Linux å†…æ ¸</li>
<li>WSL2 ä¸­æ‰€æœ‰å†…æ ¸æ¨¡å—éƒ½æ˜¯ç›´æ¥è¢«ç¼–è¯‘è¿›å†…æ ¸çš„</li>
<li>WSL2 ä¸­æ²¡æœ‰å†…æ ¸çº¿ç¨‹ï¼Œæˆ–è€…è¯´ä½ çœ‹ä¸åˆ°å®ƒä»¬</li>
</ul>
]]></content>
      <categories>
        <category>utilities</category>
      </categories>
      <tags>
        <tag>virtualization</tag>
      </tags>
  </entry>
  <entry>
    <title>ARB_explicit_uniform_location</title>
    <url>/gfx/ARB/ARB_explicit_uniform_location/</url>
    <content><![CDATA[<h1 id="overview"><a class="markdownIt-Anchor" href="#overview"></a> <a href="https://www.khronos.org/registry/OpenGL/extensions/ARB/ARB_explicit_uniform_location.txt">Overview</a></h1>
<p>Numbers <strong>ARB Extension #128</strong></p>
<span id="more"></span>
<p>Requires <strong>OpenGL 3.3 or <a href="https://www.khronos.org/registry/OpenGL/extensions/ARB/ARB_explicit_attrib_location.txt">ARB_explicit_attrib_location</a></strong></p>
<p>Interacts <strong>ARB_shader_subroutine</strong></p>
<p>Since <strong>OpenGL 4.3 Core Profile Specification</strong></p>
<p>è¿™ä¸ªæ‰©å±•ç›¸å…³çš„è¯é¢˜æ˜¯<strong>Uniform Variable</strong>ã€‚å®ƒç»™åº”ç”¨ç¨‹åºæä¾›ä¸€ä¸ªå¯ä»¥é¢„å…ˆåˆ†é…é»˜è®¤uniformå—ä¸­çš„uniformå˜é‡çš„uniform locationçš„æ–¹æ³•ï¼Œä¹ŸåŒ…æ‹¬subroutineä¸­çš„uniformå˜é‡ã€‚è¿™æ ·åº”ç”¨ç¨‹åºå°±å¯ä»¥ä¸é€šè¿‡è°ƒç”¨ç±»ä¼¼ä¸‹é¢çš„å‘½ä»¤å»æŸ¥è¯¢uniform locationè€Œç›´æ¥ä¿®æ”¹uniformå˜é‡çš„å€¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GetUniformLocation</span><br><span class="line">GetSubroutineUniformLocation</span><br><span class="line">GetSubroutineIndex</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>GL_ARB_geometry_shader4</title>
    <url>/gfx/ARB/ARB_geometry_shader4/</url>
    <content><![CDATA[<h1 id="geometry-shader-input-layout-qualifiers"><a class="markdownIt-Anchor" href="#geometry-shader-input-layout-qualifiers"></a> Geometry Shader Input Layout Qualifiers</h1>
<p>Geometry shaderåªèƒ½åœ¨æ¥å£é™å®šç¬¦(interface qualifier)<strong>in</strong>å‰åŠ Input Layout Qualifiers, ä¸èƒ½åœ¨è¾“å…¥å—(input block), å—æˆå‘˜(block member), æˆ–å˜é‡å£°æ˜(variable declaration)å‰åŠ Input Layout Qualifiersã€‚</p>
<p>è¿™äº›Input Layout Qualifiersæœ‰</p>
<span id="more"></span>
<ul>
<li><strong>points</strong></li>
<li><strong>lines</strong></li>
<li><strong>lines_adjacency</strong></li>
<li><strong>triangles</strong></li>
<li><strong>triangles_adjacency</strong></li>
</ul>
<p><a href="https://www.khronos.org/registry/OpenGL/extensions/ARB/ARB_gpu_shader5.txt">GL_ARB_gpu_shader5</a>(4.0)å¢åŠ äº†å¯¹instanced geometry shaderçš„æ”¯æŒï¼Œè¿™ä¸ªæ‰©å±•å¼•å…¥äº†ä¸€ä¸ªæ–°çš„Input Layout Qualifier</p>
<ul>
<li><strong>invocation</strong> = <em>num_instances</em></li>
</ul>
<p>æ³¨æ„ï¼Œè¿™é‡Œçš„instancedå’Œinstanced renderingæ˜¯ä¸¤ç äº‹ï¼Œè¿™é‡Œçš„instancedæ˜¯ä¸“é—¨é’ˆå¯¹GSè¯´çš„ï¼Œæ„æ€æ˜¯GSå¯ä»¥å¯¹åŒä¸€ä¸ªè¾“å…¥å›¾å…ƒæ‰§è¡Œå¤šæ¬¡ã€‚å¯¹ä¸€ä¸ªè¾“å…¥å›¾å…ƒçš„æ¯æ¬¡è°ƒç”¨(invocation)éƒ½ä¼šæœ‰ä¸€ä¸ªä¸åŒçš„<code>gl_InvocationID</code>å€¼ã€‚è¯·æ³¨æ„è¿™é‡Œçš„&quot;<strong>ä¸€ä¸ªå›¾å…ƒ</strong>&quot;, å¦‚æœä½ æœ‰ä¸¤ä¸ªå›¾å…ƒï¼Œ<code>num_instances = 3</code>, é‚£ä¹ˆGSè¢«æ‰§è¡Œçš„é¡ºåºå’Œ<code>gl_InvocationID</code>çš„å€¼æ˜¯è¿™æ ·çš„</p>
<ol start="0">
<li>(prim0, inst0)</li>
<li>(prim0, inst1)</li>
<li>(prim0, inst2)</li>
<li>(prim1, inst0)</li>
<li>(prim1, inst1)</li>
<li>(prim1, inst2)</li>
</ol>
<p>è¿™å°±æ˜¯&quot;å¯¹ä¸€ä¸ªè¾“å…¥å›¾å…ƒçš„æ¯æ¬¡è°ƒç”¨<code>gl_InvocationID</code>éƒ½ä¼šæœ‰ä¸€ä¸ªä¸åŒçš„å€¼&quot;çš„å«ä¹‰ã€‚</p>
<h1 id="geometry-shader-output-layout-qualifiers"><a class="markdownIt-Anchor" href="#geometry-shader-output-layout-qualifiers"></a> Geometry Shader Output Layout Qualifiers</h1>
<p>Geometry shaderåªèƒ½åœ¨æ¥å£é™å®šç¬¦<strong>out</strong>å‰åŠ Output Layout Qualifiers, ä¸èƒ½åœ¨è¾“å‡ºå—(output block)æˆ–å˜é‡å£°æ˜å‰åŠ Output Layout Qualifiersã€‚</p>
<p>è¿™äº›Output Layout Qualifiersæœ‰</p>
<ul>
<li><strong>points</strong></li>
<li><strong>line_strip</strong></li>
<li><strong>triangle_strip</strong></li>
<li><strong>max_vertices</strong> = <em>integer-constant</em></li>
</ul>
<h1 id="geometry-shader-built-in-variables"><a class="markdownIt-Anchor" href="#geometry-shader-built-in-variables"></a> Geometry Shader Built-in Variables</h1>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">in gl_PerVertex &#123;</span><br><span class="line">    vec4 gl_Position;</span><br><span class="line">    float gl_PointSize;</span><br><span class="line">    float gl_ClipDistance[];</span><br><span class="line">&#125; gl_in[];</span><br><span class="line"></span><br><span class="line">in int gl_PrimitiveIDIn;</span><br><span class="line"></span><br><span class="line">out gl_PerVertex &#123;</span><br><span class="line">    vec4 gl_Position;</span><br><span class="line">    float gl_PointSize;</span><br><span class="line">    float gl_ClipDistance[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">out int gl_PrimitiveID;</span><br><span class="line">out int gl_Layer;</span><br></pre></td></tr></table></figure>
<h1 id="geometry-shader-built-in-functions"><a class="markdownIt-Anchor" href="#geometry-shader-built-in-functions"></a> Geometry Shader Built-in Functions</h1>
<ul>
<li>
<p><code>void EmitVertex()</code></p>
<p>å‘å½“å‰çš„è¾“å‡ºå›¾å…ƒå¢åŠ ä¸€ä¸ªé¡¶ç‚¹ï¼Œä¹Ÿå³è¡¨ç¤ºä¸€ä¸ªé¡¶ç‚¹å®Œæˆäº†ã€‚å¢åŠ ä¸€ä¸ªé¡¶ç‚¹çš„æ„æ€æ˜¯ï¼Œä½¿ç”¨ GS ä¸­è¾“å‡ºå˜é‡çš„å½“å‰å€¼åšä¸ºè¿™ä¸ªé¡¶ç‚¹çš„ç›¸å…³å€¼ï¼Œä¸€æ—¦ <code>EmitVertex()</code> è¿”å›åï¼Œè¿™äº›è¾“å‡ºå˜é‡çš„å€¼éƒ½å°†å˜æˆæœªå®šä¹‰çš„ï¼Œè¿™äº›è¾“å‡ºå˜é‡åŒ…æ‹¬</p>
<ul>
<li><code>gl_Position</code> (vec4)</li>
<li><code>gl_PointSize</code> (float)</li>
<li><code>gl_ClipDistance</code> (float)</li>
<li><code>gl_PrimitiveID</code> (integer)</li>
<li><code>gl_Layer</code> (integer)</li>
</ul>
<p>å‰3ä¸ªå…¶å®å°±æ˜¯ <code>gl_PerVertex</code></p>
</li>
<li>
<p><code>void EndPrimitive()</code></p>
<p>è¡¨ç¤ºå½“å‰çš„å›¾å…ƒè¾“å‡ºå®Œæˆï¼Œå¼€å§‹ç”±åç»­çš„ <code>EmitVertex()</code> è¾“å‡ºä¸‹ä¸€ä¸ªå›¾å…ƒã€‚å¦‚æœ GS åªå†™ä¸€ä¸ªå›¾å…ƒï¼Œå¯ä»¥ä¸ç”¨è°ƒ <code>EndPrimitive()</code>ã€‚</p>
</li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>ARB_indirect_parameters</title>
    <url>/gfx/ARB/ARB_indirect_parameters/</url>
    <content><![CDATA[<h1 id="overview"><a class="markdownIt-Anchor" href="#overview"></a> <a href="https://www.khronos.org/registry/OpenGL/extensions/ARB/ARB_indirect_parameters.txt">Overview</a></h1>
<p>Numbers <strong>ARB Extension #154</strong></p>
<p>Requires <strong>OpenGL 4.2</strong></p>
<p>Since <strong>OpenGL 4.6 Core Profile Specification</strong></p>
<span id="more"></span>
<p>å’Œå®ƒç›¸å…³çš„OpenGLæ¦‚å¿µæ˜¯<strong>Indirect Draw</strong>, ç›¸å…³çš„æ‰©å±•æ˜¯<a href="https://www.khronos.org/registry/OpenGL/extensions/ARB/ARB_draw_indirect.txt">GL_ARB_draw_indirect</a>(since OpenGL 3.2 Compatible Profile and since OpenGL 4.0 Core Profile)å’Œ<a href="https://www.khronos.org/registry/OpenGL/extensions/ARB/ARB_multi_draw_indirect.txt">GL_ARB_multi_draw_indirect</a>(since OpenGL 4.1 Core Profile). è¿™ä¸ªæ‰©å±•å¼•å…¥äº†&quot;parameter buffer&quot;çš„æ¦‚å¿µï¼Œå¯ä»¥è®©indirect drawçš„å¤§é‡çš„å‚æ•°é›†åˆå­˜å‚¨åœ¨buffer object, ç„¶åç”¨ä¸€ä¸ªAPIè°ƒç”¨åˆ†å‘æ•´ä¸ªindirect drawåˆ—è¡¨ï¼Œä»è€Œæé«˜OpenGLç®¡çº¿çš„æ‰§è¡Œæ•ˆç‡ã€‚</p>
<p>æ›´ç¡®åˆ‡åœ°è¯´ï¼Œè¿™ä¸ªæ‰©å±•æ–°å¢äº†ä¸€ä¸ªbuffer targetï¼Œä¸“é—¨ç”¨æ¥å­˜æ”¾æŸä¸ªindirect drawing commandçš„å‚æ•°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PARAMETER_BUFFER_ARB    0x80EE</span><br></pre></td></tr></table></figure>
<p>å®ƒå¯ä»¥ä½œä¸ºä¸‹åˆ—å‘½ä»¤çš„å‚æ•°</p>
<ul>
<li>BindBuffer</li>
<li>BufferData</li>
<li>BufferSubData</li>
<li>MapBuffer</li>
<li>UnmapBuffer</li>
<li>GetBufferSubData</li>
<li>GetBufferPointerv</li>
<li>MapBufferRange</li>
<li>FlushMappedBufferRange</li>
<li>GetBufferParameteriv</li>
<li>CopyBufferSubData</li>
</ul>
<p>æ–°å¢çš„<strong>MultiDraw*Indirect</strong>å‘½ä»¤çš„å˜ç§æ˜¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MultiDrawArraysIndirectCountARB</span><br><span class="line">MultiDrawElementsIndirectCountARB</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>ARB_point_parameters</title>
    <url>/gfx/ARB/ARB_point_parameters/</url>
    <content><![CDATA[<h1 id="æ¦‚è¿°14"><a class="markdownIt-Anchor" href="#æ¦‚è¿°14"></a> æ¦‚è¿°(#14)</h1>
<p>ARB_point_parameterså…è®¸ç”¨æˆ·è®¾ç½®ç‚¹çš„æ‰©å±•å‡ ä½•ç‰¹å¾ã€‚è¿™äº›ç‚¹çš„å‡ ä½•ç‰¹å¾ä¸»è¦ç”¨æ¥æ¸²æŸ“ç²’å­æˆ–å¾®å°å…‰æºï¼Œé€šå¸¸è¢«ç§°ä¸ºå…‰ç‚¹(Light Points).</p>
<span id="more"></span>
<p>å…‰æ …åŒ–åçš„ç‚¹çš„æ˜äº®åº¦ç”±å¤šä¸ªå› ç´ å†³å®š: ç‚¹çš„é¢ç§¯(Area), ç‚¹çš„é¢œè‰²(Color), ç‚¹çš„é€æ˜åº¦(Transparency), ä»¥åŠç”µå­æªå’Œç£·å…‰ç²‰ä¹‹é—´çš„ååº”ã€‚è€Œç‚¹çš„é¢ç§¯å’Œç‚¹çš„é€æ˜åº¦ç”±ç‚¹çš„å¤§å°(Size)æ¨å¯¼è€Œæ¥ï¼Œåœ¨ARB_point_parametersä¹‹å‰ï¼Œç‚¹çš„å¤§å°<code>size</code>è¿™ä¸ªå‚æ•°ç”± <code>glPointSize</code>æŒ‡å®šã€‚</p>
<p>ARB_point_parametersæ‰©å±•ä¸»è¦å®ç°ä¸¤ä¸ªç›®çš„:</p>
<ol>
<li>ç‚¹çš„å¤§å°(Size)è¦å—è·ç¦»è¡°å‡çš„å½±å“ï¼Œå°±æ˜¯ç‚¹çš„å¤§å°è¦éšç€ç‚¹ç¦»è§‚å¯Ÿç‚¹çš„è·ç¦»çš„å¢å¤§è€Œå‡å°ã€‚</li>
</ol>
<p>è¿™ä¸ªæ‰©å±•å®šä¹‰çš„ç‚¹çš„æ˜äº®åº¦çš„è·ç¦»è¡°å‡å…¬å¼æ˜¯:</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>u</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mi>a</mi><mo>+</mo><mi>b</mi><mo>Ã—</mo><mi>d</mi><mo>+</mo><mi>c</mi><mo>Ã—</mo><msup><mi>d</mi><mn>2</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">Attenuation(d) = \frac{1}{a + b \times d + c \times d^2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal">t</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.09077em;vertical-align:-0.7693300000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>B</mi><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>n</mi><mi>e</mi><mi>s</mi><mi>s</mi><mo stretchy="false">(</mo><mi>P</mi><mi>e</mi><mo stretchy="false">)</mo><mo>=</mo><mi>B</mi><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>n</mi><mi>e</mi><mi>s</mi><mi>s</mi><mo>Ã—</mo><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>u</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">(</mo><mo stretchy="false">âˆ£</mo><mi>P</mi><mi>e</mi><mo stretchy="false">âˆ£</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Brightness(Pe) = Brightness \times Attenuation(\lvert Pe \rvert)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal">t</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">u</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mopen">âˆ£</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">e</span><span class="mclose">âˆ£</span><span class="mclose">)</span></span></span></span></span></p>
<p>è¿™é‡Œï¼Œ</p>
<ul>
<li><strong>Pe</strong> æŒ‡åœ¨çœ¼ç›åæ ‡ç³»é‡Œçš„ä¸€ä¸ªç‚¹(Point in eye coordinates)</li>
<li><strong>Brightness</strong> æ˜¯ä¸ç‚¹çš„å¤§å°æˆæ­£æ¯”çš„ä¸€ä¸ªåˆå§‹å€¼</li>
<li><strong>a</strong>, <strong>b</strong>, <strong>c</strong> æ˜¯ç”±<code>glPointParameterfv()</code>é€šè¿‡å‚æ•°<code>GL_POINT_DISTANCE_ATTENUATION</code>ä¼ å…¥çš„è¡°å‡å› å­</li>
</ul>
<ol start="2">
<li>ç‚¹çš„å¤§å°(Size)åˆ°ç‚¹çš„é¢ç§¯å’Œé€æ˜åº¦çš„æ˜ å°„è¦å—ä¸€ä¸ªé—¨é™çš„æ§åˆ¶ï¼Œå°±æ˜¯ç‚¹çš„é¢ç§¯å°äºä¸€ä¸ªé—¨é™åï¼Œç‚¹çš„Alphaåˆ†é‡(ä¸€èˆ¬æ˜¯Colorçš„ç¬¬4ä¸ªåˆ†é‡ï¼Œå®ƒå†³å®šé€æ˜åº¦ï¼ŒAlphaç­‰äº0ï¼Œè¡¨ç¤ºå®Œå…¨é€æ˜)è¦éšé¢ç§¯çš„å‡å°è€Œå‡å°ã€‚</li>
</ol>
<p>è¿™ä¸ªæ‰©å±•å®šä¹‰çš„ç‚¹çš„æœ€ç»ˆçš„Alpha(Pe)åˆ†é‡çš„è®¡ç®—å…¬å¼æ˜¯:</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mi>r</mi><mi>e</mi><mi>a</mi><mo stretchy="false">(</mo><mi>P</mi><mi>e</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.3599999999999999em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>B</mi><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>n</mi><mi>e</mi><mi>s</mi><mi>s</mi><mo stretchy="false">(</mo><mi>P</mi><mi>e</mi><mo stretchy="false">)</mo><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>ifÂ </mtext><mi>B</mi><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>n</mi><mi>e</mi><mi>s</mi><mi>s</mi><mo stretchy="false">(</mo><mi>P</mi><mi>e</mi><mo stretchy="false">)</mo><mo>â‰¥</mo><mi>T</mi><mi>h</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>h</mi><mi>o</mi><mi>l</mi><mi>d</mi><mi>A</mi><mi>r</mi><mi>e</mi><mi>a</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>T</mi><mi>h</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>h</mi><mi>o</mi><mi>l</mi><mi>d</mi><mi>A</mi><mi>r</mi><mi>e</mi><mi>a</mi><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwiseÂ </mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">Area(Pe) = \begin{cases}
  Brightness(Pe), &amp; \text{if } Brightness(Pe) \geq ThresholdArea \\
  ThresholdArea,  &amp; \text{otherwise }
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0000299999999998em;vertical-align:-1.25003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mpunct">,</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">d</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mpunct">,</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">ifÂ </span></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">â‰¥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">d</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwiseÂ </span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>F</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy="false">(</mo><mi>P</mi><mi>e</mi><mo stretchy="false">)</mo><mo>=</mo><mi>B</mi><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>n</mi><mi>e</mi><mi>s</mi><mi>s</mi><mo stretchy="false">(</mo><mi>P</mi><mi>e</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>T</mi><mi>h</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>h</mi><mi>o</mi><mi>l</mi><mi>d</mi><mi>A</mi><mi>r</mi><mi>e</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">Factor(Pe) = Brightness(Pe) / ThresholdArea
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span><span class="mord mathnormal">t</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">d</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span></span></span></span></span></p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mi>l</mi><mi>p</mi><mi>h</mi><mi>a</mi><mo stretchy="false">(</mo><mi>P</mi><mi>e</mi><mo stretchy="false">)</mo><mo>=</mo><mi>Î±</mi><mo>âˆ—</mo><mi>F</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>o</mi><mi>r</mi><mo stretchy="false">(</mo><mi>P</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Alpha(Pe) = \alpha * Factor(Pe)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">p</span><span class="mord mathnormal">h</span><span class="mord mathnormal">a</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.46528em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span></span></span></p>
<p>è¿™é‡Œï¼Œ</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î±</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> æ˜¯ç‚¹çš„Color(RGBA)çš„ç¬¬4ä¸ªåˆ†é‡</li>
<li><strong>ThresholdArea</strong> æ˜¯ä¸<code>glPointParameterf()</code>é€šè¿‡å‚æ•°<code>GL_POINT_FADE_THRESHOLD_SIZE</code>ä¼ å…¥çš„å€¼çš„å¹³æ–¹æˆæ­£æ¯”çš„ä¸€ä¸ªé—¨é™å€¼</li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenGL Draw å‘½ä»¤</title>
    <url>/gfx/ARB/ARB_multi_draw_indirect/</url>
    <content><![CDATA[<h1 id="overview"><a class="markdownIt-Anchor" href="#overview"></a> Overview</h1>
<p>OpenGL æœ‰å¾ˆå¤š Draw å‘½ä»¤ï¼Œ å¤§ä½“åˆ†ä¸º 4 ç±»:</p>
<ul>
<li>DrawArrays</li>
<li>DrawElements (Indexed)</li>
<li>DrawInstanced</li>
<li>DrawIndirect</li>
</ul>
<span id="more"></span>
<p>æ‰€è°“çš„ç»˜åˆ¶ï¼Œå¦‚æœä»pipelineçš„è§’åº¦çœ‹ï¼Œå®é™…ä¸Šä¸»è¦æ˜¯é¡¶ç‚¹ç€è‰²(vertex shading)çš„è¿‡ç¨‹ã€‚æ‰€ä»¥è¿™äº›ç»˜åˆ¶æ–¹å¼ä¸­ä¸»è¦æ¶‰åŠçš„é—®é¢˜æ˜¯é¡¶ç‚¹(vertices)åŠè¿™äº›é¡¶ç‚¹å¦‚æœæ„æˆå›¾å…ƒ(primitives)ã€‚è¿™äº›ç»˜åˆ¶æ–¹å¼çš„ä¸åŒä¸»è¦åœ¨äºå®ƒä»¬å„è‡ªæ˜¯å¦‚ä½•çœ‹å¾…é¡¶ç‚¹ï¼Œä¾‹å¦‚ï¼Œåœ¨Basicç»˜åˆ¶ä¸­ï¼Œé¡¶ç‚¹å°±æ˜¯é¡¶ç‚¹ï¼Œè€Œåœ¨Indexedç»˜åˆ¶ä¸­ï¼Œé™¤äº†é¡¶ç‚¹æœ¬èº«å¤–ï¼Œè¿˜ç»™å‡ºäº†æ„é€ ä¸‰è§’å½¢çš„é¡¶ç‚¹ç´¢å¼•ï¼Œè¿™åœ¨ç‰¹å®šåœºæ™¯ä¸‹ï¼Œæ˜¯ä¸€ç§æ›´æœ‰æ•ˆç‡çš„ç»˜åˆ¶æ–¹å¼ã€‚</p>
<p>OpenGLä¸­çš„Draw Commandsæ˜¯ä¸€ç»„ç”ŸæˆGPUæ¸²æŸ“Command Streamçš„APIï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬ç®€å•åˆ†ä¸º4ç±»:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Drawing</th>
<th style="text-align:left">é€‚ç”¨åœºæ™¯</th>
<th style="text-align:left">Vertex Attributes Buffer Object Bindingç±»å‹</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Array</td>
<td style="text-align:left">æ™®é€š</td>
<td style="text-align:left">GL_ARRAY_BUFFER</td>
</tr>
<tr>
<td style="text-align:left">Indexed</td>
<td style="text-align:left">é‡å¤çš„é¡¶ç‚¹</td>
<td style="text-align:left">GL_ELEMENT_ARRAY_BUFFER</td>
</tr>
<tr>
<td style="text-align:left">Instanced</td>
<td style="text-align:left">é‡å¤çš„æ¨¡å‹(Instance/Model)</td>
<td style="text-align:left">GL_ARRAY_BUFFER<br>GL_ELEMENT_ARRAY_BUFFER</td>
</tr>
<tr>
<td style="text-align:left">Indirect</td>
<td style="text-align:left">Drawingå‘½ä»¤çš„å‚æ•°ç›´æ¥æ”¾åœ¨GPU</td>
<td style="text-align:left">GL_DRAW_INDIRECT_BUFFER</td>
</tr>
</tbody>
</table>
<p>Array Drawingæ˜¯æœ€åŸºæœ¬çš„Drawå‘½ä»¤ï¼Œå…¶å®ƒ3ç±»éƒ½æ˜¯ä»å®ƒè¡ç”Ÿæ¥çš„ï¼Œä¸ºäº†æŸç§ç»˜åˆ¶ä¾¿åˆ©æˆ–é¡¶ç‚¹å¤ç”¨å¯¹Array Drawing APIè¿›è¡Œæ‰©å±•ï¼Œä»è€Œå¾—åˆ°ç›¸åº”çš„ç´¢å¼•ç»˜åˆ¶ã€å®ä¾‹ç»˜åˆ¶ã€é—´æ¥ç»˜åˆ¶ã€‚</p>
<h1 id="drawarrays"><a class="markdownIt-Anchor" href="#drawarrays"></a> DrawArrays</h1>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glDrawArrays</span><span class="params">(GLenum mode,</span></span><br><span class="line"><span class="params">                  GLint first,</span></span><br><span class="line"><span class="params">                  GLsizei count)</span>;</span><br></pre></td></tr></table></figure>
<p><code>glDrawArrays</code>æ˜¯OpenGLä¸­æœ€åŸºæœ¬çš„ç»˜åˆ¶å‘½ä»¤ï¼Œ<code>mode</code>æ¥å—çš„å›¾å…ƒç±»å‹æ˜¯ä¸‹é¢çš„ä¸€ä¸ªå­é›†:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Primitives */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_POINTS                         0x0000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_LINES                          0x0001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_LINE_LOOP                      0x0002</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_LINE_STRIP                     0x0003</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_TRIANGLES                      0x0004</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_TRIANGLE_STRIP                 0x0005</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_TRIANGLE_FAN                   0x0006</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_QUADS                          0x0007</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_QUAD_STRIP                     0x0008</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_POLYGON                        0x0009</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_LINES_ADJACENCY                0x000A (since OpenGL 3.2) </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_LINE_STRIP_ADJACENCY           0x000B (since OpenGL 3.2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_TRIANGLES_ADJACENCY            0x000C (since OpenGL 3.2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_TRIANGLE_STRIP_ADJACENCY       0x000D (since OpenGL 3.2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GL_PATCHES                        0x000E (since OpenGL 3.2)</span></span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚é¡¶ç‚¹æ•°ç»„å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">    vertices</span><br><span class="line">   ----------</span><br><span class="line"><span class="number">0</span> | (<span class="number">-1</span>,  <span class="number">1</span>) |</span><br><span class="line"><span class="number">1</span> | (<span class="number">-1</span>, <span class="number">-1</span>) |</span><br><span class="line"><span class="number">2</span> | ( <span class="number">1</span>, <span class="number">-1</span>) |</span><br><span class="line"><span class="number">3</span> | ( <span class="number">1</span>,  <span class="number">1</span>) |</span><br><span class="line">   ----------</span><br></pre></td></tr></table></figure>
<p>ç”¨3ä¸ªé¡¶ç‚¹ç»˜åˆ¶ä¸€ä¸ªä¸‰è§’å½¢ï¼Œè°ƒç”¨å‘½ä»¤å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">glDrawArrays(GL_TRIANGLES, <span class="number">0</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<h1 id="drawelements"><a class="markdownIt-Anchor" href="#drawelements"></a> DrawElements</h1>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glDrawElements</span><span class="params">(GLenum mode,</span></span><br><span class="line"><span class="params">                    GLsizei count,</span></span><br><span class="line"><span class="params">                    GLenum type,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> <span class="type">void</span>* indices)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">glDrawElementsBaseVertex</span><span class="params">(GLenum mode,</span></span><br><span class="line"><span class="params">                              GLsizei count,</span></span><br><span class="line"><span class="params">                              GLenum type,</span></span><br><span class="line"><span class="params">                              <span class="type">void</span>* indices</span></span><br><span class="line"><span class="params">                              GLint basevertex)</span>;</span><br></pre></td></tr></table></figure>
<p><code>glDrawElements</code>ä¸æ˜¯ç›´æ¥ç”¨é¡¶ç‚¹æ•°ç»„å»ç»˜åˆ¶ï¼Œè€Œæ˜¯ç”¨é¡¶ç‚¹æ•°ç»„çš„ç´¢å¼•å»ç»˜åˆ¶ï¼Œä¾‹å¦‚è¿˜æ˜¯ç”¨3ä¸ªé¡¶ç‚¹ç»˜åˆ¶ä¸€ä¸ªä¸‰è§’å½¢</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">    vertices</span><br><span class="line">   ----------</span><br><span class="line"><span class="number">0</span> | (<span class="number">-1</span>,  <span class="number">1</span>) |</span><br><span class="line"><span class="number">1</span> | (<span class="number">-1</span>, <span class="number">-1</span>) |</span><br><span class="line"><span class="number">2</span> | ( <span class="number">1</span>, <span class="number">-1</span>) |</span><br><span class="line"><span class="number">3</span> | ( <span class="number">1</span>,  <span class="number">1</span>) |</span><br><span class="line">   ----------</span><br></pre></td></tr></table></figure>
<p>è¿™æ¬¡é™¤äº†é¡¶ç‚¹æ•°ç»„å¤–ï¼Œæˆ‘ä»¬è¿˜è¦ä¸Šä¼ ä¸€ä¸ªé¡¶ç‚¹ç´¢å¼•æ•°ç»„</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  indices</span><br><span class="line">   -----</span><br><span class="line"><span class="number">0</span> |  <span class="number">0</span>  |</span><br><span class="line"><span class="number">1</span> |  <span class="number">1</span>  |</span><br><span class="line"><span class="number">2</span> |  <span class="number">2</span>  |</span><br><span class="line">   -----</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨å‘½ä»¤å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">glDrawElements(GL_TRIANGLES, <span class="number">3</span>, GL_UNSIGNED_BYTE, &amp;indices);</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ä¸Šé¢è¿™ä¸ªåªæœ‰3ä¸ªé¡¶ç‚¹çš„ä¾‹å­ä½“ç°ä¸å‡ºæ¥<code>glDrawElements</code>çš„å¤ç”¨é¡¶ç‚¹çš„å¥½å¤„ï¼Œä½†æ˜¯åœ¨ä¸‰è§’å½¢å¾ˆå¤šä¸”è¿™äº›ä¸‰è§’å½¢çš„é¡¶ç‚¹æœ‰å¾ˆå¤šé‡å¤çš„æƒ…å½¢ä¸‹å°±ä¸åŒäº†ï¼Œå®ƒçš„ä¼˜åŠ¿å°±ä½“ç°å‡ºæ¥äº†:</p>
<ul>
<li>è™½ç„¶æˆ‘ä»¬é¢å¤–å¢åŠ äº†ä¸€ä¸ªç´¢å¼•æ•°ç»„indiceså»å­˜å‚¨æ‰€ç»˜åˆ¶é¡¶ç‚¹çš„ç´¢å¼•ï¼Œä½†ç›¸æ¯”ä¸€ä¸ªé¡¶ç‚¹æœ€å¤š4ä¸ªfloatç±»å‹çš„æ•°æ®é‡æ¥è¯´ï¼Œç”¨ä¸€ä¸ªunsigned byteæ¥è¡¨ç¤ºä¸€ä¸ªé¡¶ç‚¹è¿˜æ˜¯åˆ’ç®—çš„ã€‚</li>
<li>åœ¨é¡¶ç‚¹åæ ‡ä¸€æ ·ï¼Œåªéœ€æ”¹å˜é¡¶ç‚¹é¡ºåºçš„å›¾å…ƒç»˜åˆ¶ä¸­ï¼Œå°†å¤§å¤§å‡å°‘æ•°æ®é‡ã€‚</li>
</ul>
<p><code>glDrawElementsBaseVertex</code>çš„è¡Œä¸ºå’Œ<code>glDrawElements</code>ä¸€æ ·ï¼Œé™¤äº†åœ¨æ‰€å–åˆ°çš„ç´¢å¼•æ•°ç»„ç›¸åº”å…ƒç´ å€¼ä¸ŠåŠ basevertex. è€ƒè™‘å¦‚ä¸‹æƒ…å†µ:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">    vertices                indices</span><br><span class="line">   ----------                -----</span><br><span class="line"><span class="number">0</span> | (<span class="number">-1</span>,  <span class="number">1</span>) |            <span class="number">0</span> |  <span class="number">0</span>  |</span><br><span class="line"><span class="number">1</span> | (<span class="number">-1</span>, <span class="number">-1</span>) |            <span class="number">1</span> |  <span class="number">1</span>  |</span><br><span class="line"><span class="number">2</span> | ( <span class="number">1</span>, <span class="number">-1</span>) |            <span class="number">2</span> |  <span class="number">2</span>  |</span><br><span class="line"><span class="number">3</span> | ( <span class="number">1</span>,  <span class="number">1</span>) |            <span class="number">3</span> |  <span class="number">3</span>  |</span><br><span class="line">   ----------             <span class="number">4</span> |  <span class="number">0</span>  |</span><br><span class="line">                          <span class="number">5</span> |  <span class="number">2</span>  |</span><br><span class="line">                             -----</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šè°ƒç”¨</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">glDrawElements(GL_TRIANGLES, <span class="number">6</span>, GL_UNSIGNED_BYTE, &amp;indices);</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯å¦‚æœæ‰€ç´¢å¼•çš„é¡¶ç‚¹ä¸åœ¨é¡¶ç‚¹æ•°ç»„çš„å¼€å§‹ï¼Œè€Œæ˜¯ä»ç¬¬100ä¸ªé¡¶ç‚¹å¼€å§‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">      vertices                indices2</span><br><span class="line">     ----------                -----</span><br><span class="line">        ....                <span class="number">0</span> | <span class="number">100</span> |</span><br><span class="line"><span class="number">100</span> | (<span class="number">-1</span>,  <span class="number">1</span>) |            <span class="number">1</span> | <span class="number">101</span> |</span><br><span class="line"><span class="number">101</span> | (<span class="number">-1</span>, <span class="number">-1</span>) |            <span class="number">2</span> | <span class="number">102</span> |</span><br><span class="line"><span class="number">102</span> | ( <span class="number">1</span>, <span class="number">-1</span>) |            <span class="number">3</span> | <span class="number">103</span> |</span><br><span class="line"><span class="number">103</span> | ( <span class="number">1</span>,  <span class="number">1</span>) |            <span class="number">4</span> | <span class="number">100</span> |</span><br><span class="line">        ....                <span class="number">5</span> | <span class="number">102</span> |</span><br><span class="line">     ----------                -----</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æƒ…å†µä¸‹åŸæ¥çš„indicesä¸èƒ½ç”¨äº†ï¼Œåªèƒ½å†åˆ›å»ºå¹¶ç»‘å®šä¸€ä¸ªæ–°çš„VBO <code>indices2</code>, è€Œåˆ›å»ºç»‘å®šVBOæ˜¯å†…å­˜æ“ä½œå¼€é”€å¾ˆå¤§ï¼Œ<code>glDrawElementsBaseVertex</code>å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨åŸæ¥çš„ç´¢å¼•å€¼ä¸ŠåŠ ä¸€ä¸ªoffset</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">glDrawElementsBaseVertex(GL_TRIANGLES, <span class="number">6</span>, GL_UNSIGNED_BYTE, &amp;indices, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<h1 id="drawinstanced"><a class="markdownIt-Anchor" href="#drawinstanced"></a> Draw*Instanced</h1>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glDrawArraysInstanced</span><span class="params">(GLenum mode,</span></span><br><span class="line"><span class="params">                           GLint first,</span></span><br><span class="line"><span class="params">                           GLsizei count,</span></span><br><span class="line"><span class="params">                           GLsizei instancecount)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">glDrawArraysInstancedBaseInstance</span><span class="params">(GLenum mode,</span></span><br><span class="line"><span class="params">                                       GLint first,</span></span><br><span class="line"><span class="params">                                       GLsizei count,</span></span><br><span class="line"><span class="params">                                       GLsizei instancecount,</span></span><br><span class="line"><span class="params">                                       GLuint baseinstance)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">glDrawElementsInstanced</span><span class="params">(GLenum mode,</span></span><br><span class="line"><span class="params">                             GLsizei count,</span></span><br><span class="line"><span class="params">                             GLenum type,</span></span><br><span class="line"><span class="params">                             <span class="type">const</span> <span class="type">void</span>* indices,</span></span><br><span class="line"><span class="params">                             GLsizei instancecount)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">glDrawElementsInstancedBaseInstance</span><span class="params">(GLenum mode,</span></span><br><span class="line"><span class="params">                                         GLsizei count,</span></span><br><span class="line"><span class="params">                                         GLenum type,</span></span><br><span class="line"><span class="params">                                         <span class="type">const</span> <span class="type">void</span>* indices,</span></span><br><span class="line"><span class="params">                                         GLsizei instancecount,</span></span><br><span class="line"><span class="params">                                         GLuint baseinstance)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">glDrawElementsInstancedBaseVertex</span><span class="params">(GLenum mode,</span></span><br><span class="line"><span class="params">                                       GLsizei count,</span></span><br><span class="line"><span class="params">                                       GLenum type,</span></span><br><span class="line"><span class="params">                                       <span class="type">void</span>* indices,</span></span><br><span class="line"><span class="params">                                       GLsizei instancecount,</span></span><br><span class="line"><span class="params">                                       GLint basevertex)</span>;</span><br></pre></td></tr></table></figure>
<p>è¦ç†è§£ä¸Šé¢è¿™äº›OpenGL Instanced Drawå‘½ä»¤ï¼Œé¦–å…ˆæˆ‘ä»¬è¦ç†è§£ä¸€ä¸ªOpenGLé‡Œå¹¶ä¸å­˜åœ¨çš„Drawå‘½ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void glDrawArraysOneInstance(GLenum mode,</span><br><span class="line">                             GLint first,</span><br><span class="line">                             GLsizei count,</span><br><span class="line">                             GLint instance,</span><br><span class="line">                             GLuint baseinstance);</span><br></pre></td></tr></table></figure>
<p>Instanced Drawingç®€å•è¯´å°±æ˜¯ä¸€æ¬¡Draw Callç»˜åˆ¶å¤šä¸ªå®ä¾‹ï¼Œæ¯”å¦‚ä¸€ä¸ªå¸ƒæ»¡æ ‘å¶çš„åœºæ™¯ï¼Œæ¯ç‰‡æ ‘å¶çš„é¡¶ç‚¹æ•°æ®å¯èƒ½æ˜¯ç›¸ä¼¼çš„ï¼Œå¯èƒ½å°±æ˜¯åœ¨ä¸–ç•Œåæ ‡ç³»ä¸­çš„ä½ç½®ä¸åŒï¼Œå…¶å®ƒé¡¶ç‚¹å±æ€§å¯èƒ½éƒ½ç›¸åŒã€‚é‚£ä¹ˆInstanced Drawingæ˜¯å¦‚ä½•å¤åˆ¶ç›¸åŒçš„å®ä¾‹åˆ°ä¸åŒçš„ä½ç½®ä¸Šçš„å‘¢?</p>
<p>OpenGLä¸»è¦é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªå˜é‡æ§åˆ¶Instanced Drawing</p>
<ul>
<li>gl_InstanceID (Vertex Shader)</li>
<li>divisor (glVertexAttribDivisor)</li>
</ul>
<h2 id="gl_instanceid"><a class="markdownIt-Anchor" href="#gl_instanceid"></a> gl_InstanceID</h2>
<p>gl_InstanceIDæ˜¯Vertex Shaderé‡Œçš„å†…ç½®å˜é‡ï¼Œå¦‚æœä½ è¿™æ ·è°ƒç”¨</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">glDrawArraysInstanced(GL_TRIANGLES, <span class="number">0</span>, <span class="number">3</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆ<code>gl_InstanceID</code>çš„å–å€¼èŒƒå›´å°±æ˜¯[0, 99]</p>
<h2 id="divisor"><a class="markdownIt-Anchor" href="#divisor"></a> divisor</h2>
<p>å‡è®¾locationä¸º2çš„Vertex Attributeç”¨æ¥è®¾ç½®æ¯ä¸ªå®ä¾‹çš„ä½ç½®åç§»ï¼Œshaderå¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#version 330 core</span></span><br><span class="line">layout (location = <span class="number">0</span>) in vec2 aPos;</span><br><span class="line">layout (location = <span class="number">1</span>) in vec3 aColor;</span><br><span class="line">layout (location = <span class="number">2</span>) in vec2 aOffset;</span><br><span class="line"></span><br><span class="line">out vec3 fColor;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    gl_Position = vec4(aPos + aOffset, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    fColor = aColor;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„APIå‘Šè¯‰OpenGL, æ¯ç”»ä¸€ä¸ªå®ä¾‹æ›´æ–°ä¸€ä¸‹index=2è¿™ä¸ªå±æ€§ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ï¼Œæ¯ä¸€ä¸ªé¡¶ç‚¹æ›´æ–°ä¸€æ¬¡å±æ€§ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">glEnableVertexAttribArray(<span class="number">2</span>);</span><br><span class="line">glBindBuffer(GL_ARRAY_BUFFER, instanceVBO);</span><br><span class="line">glVertexAttribPointer(<span class="number">2</span>, <span class="number">2</span>, GL_FLOAT, GL_FALSE, <span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="type">float</span>), (<span class="type">void</span>*)<span class="number">0</span>);</span><br><span class="line">glBindBuffer(GL_ARRAY_BUFFER, <span class="number">0</span>);</span><br><span class="line">glVertexAttribDivisor(<span class="number">2</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<h1 id="drawindirect"><a class="markdownIt-Anchor" href="#drawindirect"></a> Draw*Indirect</h1>
<p>Indirect Drawingæ˜¯å°†Array/Indexed Drawingå‘½ä»¤çš„å‚æ•°å­˜å…¥ä¸“é—¨çš„Buffer Objectï¼Œä¹Ÿå°±æ˜¯GPU Storageé‡Œï¼Œè¿™é‡Œçš„Buffer Objectçš„ç»‘å®šç±»å‹æ˜¯<code>GL_DRAW_INDIRECT_BUFFER</code>ã€‚ä¹‹æ‰€ä»¥è¿™æ ·åšï¼Œæ˜¯ä¸ºäº†èƒ½è®©GPUç›´æ¥å†™å›è¿™äº›å€¼ï¼Œæ¯”æ–¹Compute Shader, æˆ–è€…ä¸ºTransform Feedbackè®¾è®¡çš„Geometry Shader, äº¦æˆ–æ˜¯OpenCL/CUDA kernelå‡½æ•°ã€‚è¿™æ ·é¿å…äº†è¿™äº›å‚æ•°åœ¨GPUå’ŒCPUä¹‹é—´æ¥å›åœ°å¤åˆ¶(round-trip)</p>
<h2 id="drawarraysindirect"><a class="markdownIt-Anchor" href="#drawarraysindirect"></a> DrawArraysIndirect</h2>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glDrawArraysIndirect</span><span class="params">(GLenum mode, <span class="type">const</span> <span class="type">void</span> *indirect)</span>;</span><br></pre></td></tr></table></figure>
<p>åœ¨OpenGL ES 3.1åŠä»¥ä¸Šï¼ŒDrawArraysIndirectçš„Draw Parametersè¢«å®šä¹‰æˆä¸‹é¢çš„ç»“æ„ä½“:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    uint count;</span><br><span class="line">    uint instanceCount;</span><br><span class="line">    uint first;</span><br><span class="line">    uint reservedMustBeZero;</span><br><span class="line">&#125; DrawArraysIndirectCommand;</span><br></pre></td></tr></table></figure>
<p>åœ¨OpenGL 4.0åŠä»¥ä¸Šï¼ŒDrawArraysIndirectçš„Draw Parametersè¢«å®šä¹‰æˆä¸‹é¢çš„ç»“æ„ä½“:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    uint count;</span><br><span class="line">    uint instanceCount;</span><br><span class="line">    uint first;</span><br><span class="line">    uint baseInstance;</span><br><span class="line">&#125; DrawArraysIndirectCommand;</span><br></pre></td></tr></table></figure>
<p>ä¹‹æ‰€ä»¥ ES çš„ DrawIndirectCommand é‡Œæ²¡æœ‰ <code>baseInstance</code>ï¼Œæ˜¯å› ä¸º ES æ²¡æœ‰ä¸‹é¢çš„å‘½ä»¤:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">glDrawArraysIntancedBaseInstance</span><span class="params">(GLenum mode,</span></span><br><span class="line"><span class="params">				      GLint first,</span></span><br><span class="line"><span class="params">				      GLsizei count,</span></span><br><span class="line"><span class="params">				      GLsizei instancecount,</span></span><br><span class="line"><span class="params">				      GLuint baseinstance)</span>;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤åœ¨ ES ä¸­ï¼Œ<code>glDrawArraysIndirect()</code> å¯ä»¥åˆ†è§£æˆ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DrawArraysIndirectCommand *cmd = (DrawArraysIndirectCommand *)indirect;</span><br><span class="line">DrawArraysInstanced(mode, cmd-&gt;first, cmd-&gt;count, cmd-&gt;instanceCount);</span><br></pre></td></tr></table></figure>
<p>è€Œåœ¨OpenGLä¸­ï¼Œ<code>glDrawArraysIndirect()</code> å¯ä»¥åˆ†è§£æˆ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DrawArraysIndirectCommand *cmd = (DrawArraysIndirectCommand *)indirect;</span><br><span class="line">DrawArraysInstancedBaseInstance(mode, cmd-&gt;first, cmd-&gt;count,</span><br><span class="line">                cmd-&gt;instanceCount, cmd-&gt;baseInstance);</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ <a href="https://github.com/linzj/sb7code_withmedia/blob/master/src/multidrawindirect/multidrawindirect.cpp">SuperBible7 multidrawindirect</a> ä¸­ MultiDraw çš„å®ç° (<a href="https://registry.khronos.org/OpenGL/extensions/ARB/ARB_multi_draw_indirect.txt">GL_ARB_multi_draw_indirect</a> æ˜¯ 4.1 å¼•å…¥çš„æ–°æ‰©å±•)ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (mode == MODE_MULTIDRAW)</span><br><span class="line">&#123;</span><br><span class="line">    glMultiDrawArraysIndirect(GL_TRIANGLES, <span class="literal">NULL</span>, NUM_DRAWS, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (mode == MODE_SEPARATE_DRAWS)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; NUM_DRAWS; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        GLuint first, count;</span><br><span class="line">        object.get_sub_object_info(j % object.get_sub_object_count(), first, count);</span><br><span class="line">        glDrawArraysInstancedBaseInstance(GL_TRIANGLES,</span><br><span class="line">                                          first,</span><br><span class="line">                                          count,</span><br><span class="line">                                          <span class="number">1</span>, j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="drawelementsindirect"><a class="markdownIt-Anchor" href="#drawelementsindirect"></a> DrawElementsIndirect</h2>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void glDrawElementsIndirect(GLenum mode, GLenum type, const void *indirect);</span><br></pre></td></tr></table></figure>
<p>åœ¨ES 3.1ä¸­, DrawElementsIndirectçš„Draw Parametersè¢«å®šä¹‰æˆä¸‹é¢è¿™ä¸ªç»“æ„ä½“:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    uint count;</span><br><span class="line">    uint instanceCount;</span><br><span class="line">    uint firstIndex;</span><br><span class="line">    <span class="type">int</span>  baseVertex;</span><br><span class="line">    uint reservedMustBeZero;</span><br><span class="line">&#125; DrawElementsIndirectCommand;</span><br></pre></td></tr></table></figure>
<p>è€Œåœ¨OpenGL 4.0åŠä»¥ä¸Š, DrawElementsIndirectçš„<code>indirect</code>æŒ‡å‘çš„Draw Parametersè¢«å®šä¹‰æˆä¸‹é¢çš„ç»“æ„ä½“:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    uint count;</span><br><span class="line">    uint primCount;</span><br><span class="line">    uint firstIndex;</span><br><span class="line">    uint baseVertex;</span><br><span class="line">    uint baseInstance;</span><br><span class="line">&#125; DrawElementsIndirectCommand;</span><br></pre></td></tr></table></figure>
<h2 id="mesa-å®ç°-indirect-draw"><a class="markdownIt-Anchor" href="#mesa-å®ç°-indirect-draw"></a> Mesa å®ç° Indirect Draw</h2>
<p>åº”è¯¥å¾ˆå°‘æœ‰ç›´æ¥æ”¯æŒ Indirect Draw çš„ç¡¬ä»¶ï¼ŒMesa ä¸­æä¾›ä¸€ä¸ª utility å‡½æ•° <code>util_draw_indirect()</code>, å®ƒå°† indirect buffer ä¸­çš„å‚æ•°åˆ†æåæŠŠ indirect draw å±•å¼€æˆæ™®é€šçš„ gallium-&gt;draw_vbo(), åƒ sb7code ä¸­ multidrawindirect è¿™ä¸ª demo, å±•å¼€åçš„å¾ªç¯æ¬¡æ•°æ˜¯ 50000 æ¬¡ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* This extracts the draw arguments from the indirect resource,</span></span><br><span class="line"><span class="comment"> * puts them into a new instance of pipe_draw_info, and calls draw_vbo on it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">util_draw_indirect</span><span class="params">(<span class="keyword">struct</span> pipe_context *pipe,</span></span><br><span class="line"><span class="params">                   <span class="type">const</span> <span class="keyword">struct</span> pipe_draw_info *info_in,</span></span><br><span class="line"><span class="params">                   <span class="type">unsigned</span> drawid_offset,</span></span><br><span class="line"><span class="params">                   <span class="type">const</span> <span class="keyword">struct</span> pipe_draw_indirect_info *indirect)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">   <span class="keyword">for</span> (<span class="type">unsigned</span> i = <span class="number">0</span>; i &lt; draw_count; i++) &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">pipe_draw_start_count_bias</span> <span class="title">draw</span>;</span></span><br><span class="line"></span><br><span class="line">      draw.count = params[<span class="number">0</span>];</span><br><span class="line">      info.instance_count = params[<span class="number">1</span>];</span><br><span class="line">      draw.start = params[<span class="number">2</span>];</span><br><span class="line">      draw.index_bias = info_in-&gt;index_size ? params[<span class="number">3</span>] : <span class="number">0</span>;</span><br><span class="line">      info.start_instance = info_in-&gt;index_size ? params[<span class="number">4</span>] : params[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">      pipe-&gt;draw_vbo(pipe, &amp;info, i + drawid_offset, <span class="literal">NULL</span>, &amp;draw, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      params += indirect-&gt;stride / <span class="number">4</span>;</span><br><span class="line">   &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="references"><a class="markdownIt-Anchor" href="#references"></a> References</h1>
<ul>
<li><a href="https://learnopengl.com/Advanced-OpenGL/Instancing">https://learnopengl.com/Advanced-OpenGL/Instancing</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>ARB_program_interface_query</title>
    <url>/gfx/ARB/ARB_program_interface_query/</url>
    <content><![CDATA[<h1 id="overview"><a class="markdownIt-Anchor" href="#overview"></a> <a href="https://www.khronos.org/registry/OpenGL/extensions/ARB/ARB_program_interface_query.txt">Overview</a></h1>
<p>Numbers <strong>ARB Extension #134</strong></p>
<p>Requires <strong>OpenGL 2.0</strong></p>
<span id="more"></span>
<p>Affected By</p>
<ul>
<li>ARB_transform_feedback</li>
<li>EXT_transform_feedback</li>
<li>ARB_uniform_buffer_object</li>
<li>ARB_shader_subroutine</li>
<li>ARB_shader_atomic_counters</li>
<li>ARB_shader_storage_buffer_object</li>
<li>ARB_arrays_of_arrays</li>
<li>ARB_compute_shader</li>
<li>ARB_explicit_uniform_location</li>
</ul>
<p>Since <strong>OpenGL 4.3 Core Profile Specification</strong></p>
<p>è¿™ä¸ªæ‰©å±•ç»™åº”ç”¨ç¨‹åºæä¾›ä¸€ç»„ç»Ÿä¸€çš„æŸ¥è¯¢å‘½ä»¤ã€‚è¿™ç»„å‘½ä»¤ç”¨æ¥æŸ¥è¯¢è¢«program objectsç”¨æ¥ä¸åº”ç”¨ç¨‹åºä»£ç æˆ–å…¶å®ƒprogram objecté€šä¿¡çš„å„ç§interfaceså’Œresourcesçš„å±æ€§ã€‚</p>
<p>è¿™ä¸ªæ‰©å±•å®šä¹‰äº†ä¸¤ä¸ªæ¦‚å¿µï¼š<strong>interfaces</strong>å’Œ<strong>active resources</strong></p>
<h2 id="interfaces"><a class="markdownIt-Anchor" href="#interfaces"></a> Interfaces</h2>
<p>Provides a way for the program to communicate with application code, fixed-function OpenGL pipeline stages, and other programs.</p>
<p>ä¾‹å¦‚ï¼š</p>
<ul>
<li>inputs</li>
<li>outputs</li>
<li>uniforms</li>
<li>uniform blocks</li>
<li>subroutines and subroutine uniforms</li>
<li>atomic counter buffers</li>
</ul>
<h2 id="active-resources"><a class="markdownIt-Anchor" href="#active-resources"></a> Active Resources</h2>
<p>Each interface of a program has a set of active resources used by the program.</p>
<pre><code class="highlight mermaid">graph TD
    A[Data]
    B[Vertex Shader]
    C[Tess Control Shader]
    D[Tess Eval Shader]
    E[Geometry Shader]
    F[Fragment Shader]
    G[Output]

    A --&gt; B
    B --&gt; C
    C --&gt; D
    D --&gt; E
    E --&gt; F
    F --&gt; G</code></pre>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>ARB_shader_ballot</title>
    <url>/gfx/ARB/ARB_shader_ballot/</url>
    <content><![CDATA[<h1 id="æ¦‚è¿°183"><a class="markdownIt-Anchor" href="#æ¦‚è¿°183"></a> æ¦‚è¿°(#183)</h1>
<p>ARB_shader_ballotç»™ä¸€ç»„çº¿ç¨‹(a group of invocations)æä¾›æŸäº›å½¢å¼çš„çº¿ç¨‹é—´(cross-invocation)é€šä¿¡çš„èƒ½åŠ›ã€‚å®ƒè¦ä¹ˆæ˜¯é€šè¿‡å¹¿æ’­æŸä¸ªçº¿ç¨‹ä½œç”¨åŸŸé‡Œçš„å€¼ï¼Œè¦ä¹ˆæ˜¯é€šè¿‡ä¸€ä¸ªä½æ•°ç»„(bitarray)è¡¨ç¤ºä¸€ç»„çº¿ç¨‹ä¸­æ¯ä¸ªçº¿ç¨‹ä½œç”¨åŸŸé‡Œçš„å¯èƒ½çš„å€¼ã€‚</p>
<span id="more"></span>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>GL_ARB_shader_storage_buffer_object</title>
    <url>/gfx/ARB/ARB_shader_storage_buffer_object/</url>
    <content><![CDATA[<h1 id="overview"><a class="markdownIt-Anchor" href="#overview"></a> <a href="https://www.khronos.org/registry/OpenGL/extensions/ARB/ARB_shader_storage_buffer_object.txt">Overview</a></h1>
<p>Numbers <strong>ARB Extension #137</strong></p>
<span id="more"></span>
<p>Requires <strong>ARB_program_interface_query</strong></p>
<p>Interacts</p>
<ul>
<li>ARB_compute_shader</li>
<li>ARB_program_interface_query</li>
</ul>
<p>Since <strong>OpenGL 4.3 Core Profile Specification</strong></p>
<p>è¿™ä¸ªæ‰©å±•æä¾›èƒ½è®©åº”ç”¨Shader Codeå¯¹å­˜å‚¨åœ¨buffer objectä¸­çš„å˜é‡è¿›è¡Œéšæœºçš„è¯»å†™ï¼ŒåŸå­å­˜å‚¨æ“ä½œçš„èƒ½åŠ›ã€‚è¿™é‡Œçš„buffer objectså³ä¸º**â€œshader storage buffersâ€**.</p>
<h1 id="gl_arb_uniform_buffer_object"><a class="markdownIt-Anchor" href="#gl_arb_uniform_buffer_object"></a> <a href="https://www.khronos.org/registry/OpenGL/extensions/ARB/ARB_uniform_buffer_object.txt">GL_ARB_uniform_buffer_object</a></h1>
<p><strong>GL_ARB_uniform_buffer_object</strong>å¼•å…¥äº†ä¸€ä¸ªæ–°çš„æ¦‚å¿µ<strong>uniform block</strong>ç”¨æ¥å­˜æ”¾ä¸€ç»„uniformå˜é‡ï¼Œè°ƒç”¨APIå°†uinform blocksä¸buffer objectsç»‘å®šã€‚å®é™…ä¸Šç›¸å½“äºè®©shaderå¯ä»¥è®¿é—®buffer objectsé‡Œçš„uniforms.</p>
<p>ä¸ UBO ç›¸æ¯”ï¼Œ SSBO æœ‰ä»¥ä¸‹ç‰¹ç‚¹</p>
<ul>
<li>å¤§å®¹é‡æ•°æ®å­˜å‚¨
<ul>
<li>SSBO çš„å¤§å°å¯ä»¥è¾¾åˆ° 128MB ç”šè‡³æ›´å¤š</li>
</ul>
</li>
<li>è¯»å†™æ“ä½œ
<ul>
<li>SSBO æ”¯æŒè¯»å†™æ“ä½œï¼Œè€Œ UBO é€šå¸¸æ˜¯<strong>åªè¯»</strong>çš„ã€‚è¿™ä½¿ç”¨ SSBO åœ¨éœ€è¦é¢‘ç¹æ›´æ–°æ•°æ®çš„åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ã€‚</li>
</ul>
</li>
<li>çµæ´»çš„æ•°æ®ç»“æ„
<ul>
<li>SSBO å¯ä»¥åŒ…å«<strong>å¯å˜é•¿åº¦</strong>çš„æ•°æ®ï¼Œè¿™åœ¨å¤„ç†åŠ¨æ€æ•°æ®æ—¶éå¸¸æ–¹ä¾¿</li>
</ul>
</li>
</ul>
<h1 id="ä½¿ç”¨æ–¹æ³•"><a class="markdownIt-Anchor" href="#ä½¿ç”¨æ–¹æ³•"></a> ä½¿ç”¨æ–¹æ³•</h1>
<ul>
<li>å£°æ˜ SSBO</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">layout(std430, binding = 0) buffer BufferName &#123;</span><br><span class="line">    vec4 data[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>åˆ›å»ºå’Œåˆå§‹åŒ– SSBO</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GLuint ssbo;</span><br><span class="line">glGenBuffers(1, &amp;ssbo);</span><br><span class="line">glBindBuffer(GL_SHADER_STORAGE_BUFFER, ssbo);</span><br><span class="line">glBufferData(GL_SHADER_STORAGE_BUFFER, bufferSize, NULL, GL_DYNAMIC_COPY);</span><br><span class="line">glBindBufferBase(GL_SHADER_STORAGE_BUFFER, bindingPoint, ssbo);</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ä¸uniform blocksæœ€å¤§çš„ä¸åŒæ˜¯ï¼Œuniform blocksæ˜¯åªè¯»çš„ï¼Œè€Œinterface blocksä¹Ÿå³<strong>shader storage buffer</strong>æ˜¯å¯è¯»å¯å†™çš„ã€‚<br />
ä¹Ÿå³å¤šä¸ªç‹¬ç«‹çš„shaderå¯ä»¥è¯»å†™åŒä¸€å—å†…å­˜ã€‚æ‰€ä»¥è¿™é‡ŒåŒæ ·æœ‰å†…å­˜äº’æ–¥è®¿é—®çš„é—®é¢˜å­˜åœ¨ã€‚OpenGL Specificationå’ŒShading Languageéƒ½æä¾›äº†ä¸€äº›æœºåˆ¶æ¥æ§åˆ¶å†…å­˜è®¿é—®ã€‚</p>
<ul>
<li>OpenGL API</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">glMemoryBarrier()</span><br></pre></td></tr></table></figure>
<ul>
<li>GLSL</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">memoryBarrier()</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>ARB_shading_language_420pack</title>
    <url>/gfx/ARB/ARB_shading_language_420pack/</url>
    <content><![CDATA[<h1 id="overview"><a class="markdownIt-Anchor" href="#overview"></a> <a href="https://www.khronos.org/registry/OpenGL/extensions/ARB/ARB_shading_language_420pack.txt">Overview</a></h1>
<p>Numbers <strong>ARB Extension #108</strong></p>
<span id="more"></span>
<p>Interacts</p>
<ul>
<li><a href="https://www.khronos.org/registry/OpenGL/extensions/ARB/ARB_shader_image_load_store.txt">ARB_shader_image_load_store</a></li>
</ul>
<p>Since <strong>OpenGL 4.2 Core Profile Specification</strong></p>
<p>è¿™ä¸ªæ‰©å±•æ˜¯ä¸€ä¸ª<strong>Language feature only extension</strong>, å³å®ƒå®Œå…¨åªè·ŸGLSLç›¸å…³ã€‚å®ƒå¢åŠ äº†ä»¥ä¸‹æ”¹å˜</p>
<ul>
<li>å¢åŠ ç»­è¡Œç¬¦<code>\</code></li>
<li>æŠŠGLSLçš„å­—ç¬¦é›†ç”±ASCIIæ”¹ä¸ºUTF-8</li>
<li>å…è®¸éšå¼åœ°å°†è¿”å›å€¼ç±»å‹è½¬æ¢ä¸ºå‡½æ•°å£°æ˜çš„ç±»å‹</li>
<li><strong>const</strong>å…³é”®å­—å¯ä»¥åœ¨å‡½æ•°ä½“å†…å£°æ˜å˜é‡ï¼ŒåŒæ—¶å…è®¸ä½¿ç”¨ä¸€ä¸ªéå¸¸é‡è¡¨è¾¾å¼åˆå§‹åŒ–è¯¥å˜é‡</li>
<li>å˜é‡å£°æ˜çš„ä¿®é¥°ç¬¦ä¸å†å¿…é¡»æœ‰ä¸¥æ ¼çš„é¡ºåºã€‚<strong>layout qualifier</strong>å¯ä»¥è¢«ä½¿ç”¨å¤šæ¬¡ï¼Œå¤šä¸ª<strong>parameter qualifiers</strong>å¯ä»¥è¢«ç”¨ï¼Œä½†å¹¶ä¸æ˜¯è¯´å˜é‡å£°æ˜å¯ä»¥æœ‰ä»»æ„çš„åˆå§‹åŒ–åˆ—è¡¨ã€‚åªæ˜¯è¯´æŸä¸€ç±»çš„ä¿®é¥°ç¬¦åªå¯ä»¥ç”¨ä¸€ä¸ªï¼Œå®ƒä»¬ä¹‹é—´çš„é¡ºåºé™åˆ¶è¢«å–æ¶ˆäº†ã€‚</li>
<li>å¢åŠ layout qualifier identifier <code>binding</code>ç”¨æ¥ç»‘å®šä¸€ä¸ªuniform blockçš„location. uniform blockæœ¬èº«éœ€è¦GLSL 1.4çš„æ”¯æŒã€‚</li>
<li>å¢åŠ layout qualifier identifier <code>binding</code>ç”¨æ¥ç»‘å®šunitsåˆ°samplerå’Œimage variableå£°æ˜ã€‚</li>
<li>å¢åŠ Cè¯­è¨€é£æ ¼çš„åˆå§‹åŒ–åˆ—è¡¨ï¼Œå³ <code>a[10] = &#123; 0 &#125;;</code></li>
<li>å¢åŠ vectorså’Œmatricesçš„<code>.length()</code>æ–¹æ³•ï¼Œè¿”å›vectorçš„åˆ†é‡ä¸ªæ•°æˆ–matrixçš„åˆ—æ•°ã€‚</li>
<li>å…è®¸æ ‡é‡çš„swizzleæ“ä½œã€‚</li>
<li>å¢åŠ å†…ç½®å¸¸é‡<code>gl_MinProgramTexelOffset</code>å’Œ<code>gl_MaxProgramTexelOffset</code></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>ARB_sparse_texture</title>
    <url>/gfx/ARB/ARB_sparse_texture/</url>
    <content><![CDATA[<h1 id="overview158"><a class="markdownIt-Anchor" href="#overview158"></a> Overview(#158)</h1>
<p>å¤æ‚çš„OpenGLåº”ç”¨å’Œå¯¹é«˜åˆ†è¾¨ç‡çš„è¿½æ±‚ä½¿çº¹ç†çš„å¤§å°å·¨å¢ï¼Œä½†æ˜¯å¯ä¾›ä¸€ä¸ªGPUä½¿ç”¨çš„ç‰©ç†å†…å­˜æ˜¯æœ‰é™çš„ï¼Œä¸€æ—¦å†…å­˜ä½¿ç”¨æ®†å°½ï¼Œå†…å­˜æ¢é¡µå°±å¯èƒ½å‘ç”Ÿï¼Œæ€§èƒ½ä¸¥é‡ä¸‹é™ï¼Œæˆ–è€…æ›´ç³Ÿï¼Œåº”ç”¨ç›´æ¥æŒ‚äº†ã€‚ä½†å¦ä¸€æ–¹é¢GPUå¯è®¿é—®çš„åœ°å€ç©ºé—´ç›®å‰å·²ç»å¯ä»¥è¾¾åˆ°GBï¼Œç”šè‡³TB.</p>
<span id="more"></span>
<p>ARB_sparse_textureå…è®¸ä½ ä½¿ç”¨ä¸€ä¸ªæ¯”GPUç‰©ç†å†…å­˜å¤§å¾—å¤šçš„çº¹ç†(e.g. 16384x16384 32bpp)ï¼Œå®ƒä½¿ç”¨ä¸€ç§è™šæ‹Ÿé¡µçš„æ–¹æ³•å°†å¤§çš„çº¹ç†åˆ†æˆå¤šä¸ªé¡µï¼Œ è¿™äº›é¡µæœ‰çš„é©»ç•™åœ¨ç‰©ç†å†…å­˜ï¼Œæœ‰çš„æ²¡æœ‰ï¼Œåªæœ‰å½“éœ€è¦çš„æ—¶å€™æ‰åŠ è½½å®ƒä»¬ã€‚æ¯”æ–¹æˆ‘ä»¬æ ¹æ®ç›¸æœºçš„è§†è§’å˜åŒ–ï¼ŒåªåŠ è½½é‚£äº›åœ¨è§†é‡èŒƒå›´å†…å¯è§çš„pages. å› æ­¤sparse textureä¹Ÿå«åštiled textureæˆ–mega texture.</p>

<h1 id="restrictions"><a class="markdownIt-Anchor" href="#restrictions"></a> Restrictions</h1>
<ul>
<li>åªæœ‰Immutable-Format Textureæ‰èƒ½ä½œä¸ºSparse Texture</li>
<li>ä¸æ˜¯æ‰€æœ‰çš„internalformatéƒ½å¯ä»¥ä½œä¸ºSparse Texture, å…·ä½“å“ªäº›æ”¯æŒå‚è§<a href="https://www.khronos.org/registry/OpenGL/extensions/ARB/ARB_sparse_texture.txt">ARB_sparse_texture spec</a></li>
</ul>
<h1 id="how-to-use"><a class="markdownIt-Anchor" href="#how-to-use"></a> How to Use</h1>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">GLuint page_texture;</span><br><span class="line"></span><br><span class="line">glGenTextures(<span class="number">1</span>, &amp;page_texture);</span><br><span class="line">glBindTexture(GL_TEXTURE_2D, page_texture);</span><br><span class="line"></span><br><span class="line">glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_SPARSE_ARB, GL_TRUE);</span><br><span class="line">glTexStorage2D(GL_TEXTURE_2D, <span class="number">15</span>, GL_RGBA32F, <span class="number">16384</span>, <span class="number">16384</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// commit a level 0 page.</span></span><br><span class="line">glTexPageCommitmentARB(GL_TEXTURE_2D, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">64</span>, <span class="number">64</span>, <span class="number">0</span>, GL_TRUE);</span><br><span class="line"><span class="comment">// 4KB increase here.</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>ARB_texture_storage</title>
    <url>/gfx/ARB/ARB_texture_storage/</url>
    <content><![CDATA[<h1 id="overview117"><a class="markdownIt-Anchor" href="#overview117"></a> Overview(#117)</h1>
<p>ARB_texture_storageçš„ä¸»è¦ç›®çš„æ˜¯ç®€åŒ–çº¹ç†ä¸€è‡´æ€§(consistency)å’Œå®Œæ•´æ€§(completeness)æ£€æŸ¥ï¼Œä»¥å‡å°å®ç°çš„å¼€é”€ã€‚</p>
<span id="more"></span>
<p>åœ¨ARB_texture_storageä¹‹å‰ï¼ŒOpenGLå…è®¸ç»™æ¯ä¸ªMipmapçº§åˆ«åˆ†åˆ«æŒ‡å®šä¸åŒçš„å¤§å°ï¼Œåƒç´ æ ¼å¼(format), æ•°æ®ç±»å‹(type)ç­‰ç­‰ï¼ŒæŠŠçº¹ç†ä¸€è‡´æ€§æ£€æŸ¥æ”¾åœ¨draw timeé˜¶æ®µï¼Œè¿™ç»™å®ç°å¢åŠ äº†å¼€é”€ã€‚</p>
<p>è€ŒARB_texture_storageå¯ä»¥ä¸€æ¬¡æ€§(in a single call)æŒ‡å®šçº¹ç†çš„æ•´ä¸ªç»“æ„ï¼ŒæŠŠä¸€è‡´æ€§æ£€æŸ¥å’Œå†…å­˜ç”³è¯·æå‰ã€‚ä¸€æ—¦æŒ‡å®šï¼Œè¿™ä¸ªçº¹ç†çš„åƒç´ æ ¼å¼å’Œç»´åº¦éƒ½ä¸å¯å†å˜(Immutable)ï¼Œè¿™æ ·å°±ç®€åŒ–äº†çº¹ç†å®Œæ•´æ€§æ£€æŸ¥çš„å®ç°ã€‚</p>
<p>ä½¿ç”¨ARB_texture_storage, å°±ä¸èƒ½å†ç”¨<code>TexImage*</code>ä¸Šä¼ çº¹ç†æ•°æ®äº†(mutable), è€Œæ˜¯ç”¨<code>TexSubImage*</code>(immutable)ã€‚æˆ–æ˜¯ç”¨å…¶å®ƒæ–¹å¼åŠ¨æ€ç”Ÿæˆçº¹ç†æ•°æ®(immutable), æ¯”å¦‚<em>render-to-texture, mipmap generation, rendering to a sibling EGLImage</em>.</p>
<h1 id="immutable-format-texture-images"><a class="markdownIt-Anchor" href="#immutable-format-texture-images"></a> Immutable-Format Texture Images</h1>
<p>Immutable-Format Textureä¸ARB_texture_storageæœ‰ç›´æ¥çš„å…³ç³»ã€‚æ‰€è°“Immutable-Format Textureï¼Œå°±æ˜¯æœ‰ä¸€ç»„GLå‘½ä»¤ï¼Œä»–ä»¬å¯ä»¥ä¸€æ¬¡æ€§è®¾å®šçº¹ç†æ‰€æœ‰levelçš„å±æ€§ï¼Œä¸€æ—¦è°ƒç”¨æˆåŠŸï¼Œæ‰€æœ‰levelçš„formatå’Œdimensionséƒ½ä¸èƒ½å†æ”¹å˜ï¼Œé™¤éå®ƒæ˜¯ä¸€ä¸ªä»£ç†çº¹ç†ã€‚ç„¶è€Œå®ƒçš„å†…å®¹å’Œçº¹ç†parametersä»ç„¶å¯ä»¥ä¿®æ”¹ï¼Œè¿™æ ·çš„çº¹ç†å°±æ˜¯Immutable-Format Texture.</p>
<h2 id="a-set-of-commands-for-immutable-format-texture"><a class="markdownIt-Anchor" href="#a-set-of-commands-for-immutable-format-texture"></a> A set of commands for immutable-format texture</h2>
<ul>
<li>glTexStorage1D</li>
<li>glTexStorage2D</li>
<li>glTexStorage3D</li>
<li>glTexStorage2DMultisample</li>
<li>glTexStorage3DMultisample</li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>ARB_texture_swizzle</title>
    <url>/gfx/ARB/ARB_texture_swizzle/</url>
    <content><![CDATA[<h1 id="æ¦‚è¿°84"><a class="markdownIt-Anchor" href="#æ¦‚è¿°84"></a> æ¦‚è¿°(#84)</h1>
<p>ä¼ ç»Ÿçš„OpenGLçº¹ç†æ ¼å¼(texture format)çš„çº¹ç†æ•°æ®å­˜å‚¨å’Œè§£é‡Šæ˜¯ç»Ÿä¸€çš„ï¼Œçº¹ç†å°±æ˜¯è¢«è§£é‡Šæˆé¢œè‰²ã€‚è€Œåœ¨ç°ä»£OpenGLåº”ç”¨ä¸­ï¼Œå¤§å¤šæ•°çº¹ç†å¹¶ä¸æ˜¯ä»£è¡¨é¢œè‰²ï¼Œè€Œæ˜¯ä»£è¡¨åƒshadow maps, normal maps, page tables, occlusion dataç­‰ç­‰è¿™æ ·çš„æ•°æ®ã€‚å¯¹äºåè€…ï¼Œæˆ‘ä»¬å°†çº¹ç†æ•°æ®ç§°ä½œ&quot;RGBA&quot;ï¼Œåªæ˜¯å¯¹æ•°æ®åœ¨ç°æœ‰æ¨¡å‹ä¸Šçš„ä¸€ç§æ–¹ä¾¿çš„æ˜ å°„ï¼Œä½†å¹¶ä¸æ˜¯æ•°æ®å®é™…ä¸Šçš„å‡†ç¡®è§£é‡Šã€‚</p>
<span id="more"></span>
<p>å·²æœ‰çš„çº¹ç†æ ¼å¼å‡ ä¹æ˜¯çº¹ç†æ•°æ®çš„ç±»å‹ï¼Œåˆ†é‡çš„ä¸ªæ•°ï¼Œåˆ†é‡çš„ä½æ•°çš„é›†åˆçš„æ­£äº¤ç»„åˆï¼Œä½†æ˜¯å¯¹äºç€è‰²å™¨æˆ–å›ºå®šç®¡çº¿æ‰€è¯»å–çš„æ•°æ®å¦‚ä½•è§£è§£å¹¶ä¸é‚£ä¹ˆæ­£äº¤ã€‚ä¹‹å‰çš„æ‰©å±•ä¹Ÿå¢åŠ äº†ä¸€äº›æœ€è¿«åˆ‡è¦æ±‚çš„çº¹ç†æ ¼å¼ï¼Œä½†é—®é¢˜æ²¡æœ‰è¢«å®Œå…¨è§£å†³ã€‚</p>
<p>ARB_texture_swizzleæä¾›äº†ä¸€ç§è¢«ä½¿ç”¨ä¹‹å‰æˆ–è€…è¢«ç€è‰²å™¨è¯»å–ä¹‹å‰ï¼Œé‡æ’ä¸€ä¸ªçº¹ç†åƒç´ çš„åˆ†é‡çš„æœºåˆ¶ã€‚æ¯”æ–¹è¯´å¯ä»¥è®¾ç½®è®©shaderè¯»å–çº¹ç†æ•°æ®æ—¶åªå–Redåˆ†é‡ã€‚</p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>ARB_texture_view</title>
    <url>/gfx/ARB/ARB_texture_view/</url>
    <content><![CDATA[<h1 id="æ¦‚è¿°124"><a class="markdownIt-Anchor" href="#æ¦‚è¿°124"></a> æ¦‚è¿°(#124)</h1>
<p>ARB_texture_viewçš„ä¸»è¦ç›®çš„æ˜¯é€šè¿‡åˆ›å»ºå·²æœ‰çº¹ç†å¯¹è±¡çš„è§†å›¾(view), æ¥äº§ç”Ÿæ–°çš„çº¹ç†å¯¹è±¡ï¼Œä»¥è¾¾åˆ°å…±äº«åŒä¸€çº¹ç†å­˜å‚¨(data store)çš„ç›®çš„ã€‚å®ƒå¯ä»¥ä»ä»¥ä¸‹3ä¸ªæ–¹é¢åˆ›å»ºçº¹ç†è§†å›¾ï¼š</p>
<span id="more"></span>
<ul>
<li>texture type å®ƒå¯ä»¥æŒ‡å®šä¸€ä¸ªæ–°çš„çº¹ç†ç±»å‹(åœ¨çº¦æŸèŒƒå›´å†…)æ¥åˆ›å»ºæ–°çš„çº¹ç†å¯¹è±¡</li>
<li>internal format å®ƒå¯ä»¥å®šä¹‰ä¸€ä¸ªæ–°çš„çº¹ç†æ ¼å¼(åœ¨çº¦æŸèŒƒå›´å†…)æ¥è§£é‡Šå·²æœ‰çš„data store</li>
<li>sub mipmap/array range å®ƒå¯ä»¥ä»å·²æœ‰çº¹ç†çš„mipmap levelsæˆ–array slicesä¸­æˆªå–ä¸€ä¸ªå­é›†ä½œä¸ºæ–°çš„çº¹ç†å¯¹è±¡</li>
</ul>
<p>NOTE: ä¸Šè¿°æœ€åä¸€ç§æ–¹å¼åªæŒ‡å®šæ–°çš„èŒƒå›´(level/index)ï¼Œè€Œä¸è¿›è¡Œdata storeæ‹·è´ã€‚</p>
<p>æ²¡æœ‰å¢åŠ æ–°çš„çº¹ç†ç±»å‹ï¼ŒåŸæ¥çš„çº¹ç†å¯¹è±¡è¢«åˆ’åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†:</p>
<ul>
<li>æ•°æ®å­˜å‚¨(Data Store)</li>
<li>çŠ¶æ€ä¿¡æ¯ï¼Œç”¨æ¥æè¿°Data Storeçš„å“ªä¸€éƒ¨åˆ†è¢«ä½¿ç”¨ï¼Œå¦‚ä½•è§£é‡Šæ‰€ç”¨çš„æ•°æ®å…ƒç´ </li>
<li>åµŒå…¥çš„é‡‡æ ·å™¨å¯¹è±¡(Sampler)</li>
<li>å„ç§å…¶å®ƒçº¹ç†å‚æ•°ï¼ŒåƒFilter, Mipmapç­‰</li>
</ul>
<h1 id="åŸåˆ™"><a class="markdownIt-Anchor" href="#åŸåˆ™"></a> åŸåˆ™</h1>
<p>ARB_texture_viewè§„å®šçš„å…³äºåˆ›å»ºTexture Viewçš„å‡ ä¸ªåŸåˆ™(é™åˆ¶)ä¸»è¦æœ‰ä»¥ä¸‹3ä¸ª:</p>
<ul>
<li>åªèƒ½ç»™Immutableçº¹ç†åˆ›å»ºView,ä¹Ÿå°±æ˜¯é‚£äº›ç”±TexStorageåˆ›å»ºçš„çº¹ç†</li>
<li>åŸçº¹ç†å’Œæ–°çº¹ç†çš„æ ¼å¼è¦å…¼å®¹</li>
<li>åŸçº¹ç†å’Œæ–°çº¹ç†çš„ç±»å‹è¦å…¼å®¹</li>
</ul>
<h2 id="ä¸ºä»€ä¹ˆåªç»™immutableçº¹ç†ç±»å‹åˆ›å»ºtexture-view"><a class="markdownIt-Anchor" href="#ä¸ºä»€ä¹ˆåªç»™immutableçº¹ç†ç±»å‹åˆ›å»ºtexture-view"></a> ä¸ºä»€ä¹ˆåªç»™Immutableçº¹ç†ç±»å‹åˆ›å»ºTexture View</h2>
<p>Texture Viewæœ¬è´¨ä¸Šå¹¶æ²¡æœ‰ä¸Šä¼ çº¹ç†data store, è€Œæ˜¯åƒæŒ‡é’ˆä¸€æ ·ï¼Œå¢åŠ äº†å¯¹å·²æœ‰çº¹ç†å¯¹è±¡çš„å¼•ç”¨ã€‚å¦‚æœæ˜¯Mutableçº¹ç†ï¼Œé‚£ä¹ˆå®ƒçš„æ ¼å¼ï¼Œå¤§å°ç­‰éƒ½æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œè¿™æ ·å°±æ— æ³•ä¿è¯çº¹ç†çš„consistencyå’Œcompleteness. è€ŒImmutableçº¹ç†ä¸ä¼šå­˜åœ¨è¿™æ ·çš„é—®é¢˜ã€‚</p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>GL_ARB_transform_feedback</title>
    <url>/gfx/ARB/ARB_transform_feedback3/</url>
    <content><![CDATA[<h1 id="transform-feedback"><a class="markdownIt-Anchor" href="#transform-feedback"></a> <a href="https://www.khronos.org/opengl/wiki/Transform_Feedback">Transform Feedback</a> å¼•å…¥</h1>
<p>Transform Feedbacké¦–å…ˆæ˜¯DirectX3Då¼•å…¥çš„ï¼Œä½†åœ¨DirectX3Dä¸­å®ƒä¸å«TF, è€Œæ˜¯å«<strong>Stream Output Stage</strong>. å®ƒç¬¬ä¸€æ¬¡è¢«å¼•å…¥OpenGLæ˜¯åœ¨2006å¹´ï¼Œä½†å½“æ—¶æ˜¯ä»¥æ‰©å±•çš„å½¢å¼<a href="https://www.khronos.org/registry/OpenGL/extensions/EXT/EXT_transform_feedback.txt">GL_EXT_transform_feedback</a>å¼•å…¥çš„ï¼Œå®ƒæ­£å¼æˆä¸ºOpenGL Required Core Featuresæ˜¯åœ¨OpenGL 3.0(2008), åœ¨è¿™ä¹‹åï¼ŒOpenGL 4.0, 4.2, 4.6åˆåˆ†åˆ«å¼•å…¥äº†ä¸€äº›TFç›¸å…³çš„æ–°ç‰¹æ€§ã€‚</p>
<span id="more"></span>
<table>
<thead>
<tr>
<th style="text-align:left">Extensions</th>
<th style="text-align:left">OpenGL Version</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GL_EXT_transform_feedback</td>
<td style="text-align:left">3.0</td>
</tr>
<tr>
<td style="text-align:left">GL_ARB_transform_feedback2</td>
<td style="text-align:left">4.0</td>
</tr>
<tr>
<td style="text-align:left">GL_ARB_transform_feedback3</td>
<td style="text-align:left">4.0</td>
</tr>
<tr>
<td style="text-align:left">GL_ARB_transform_feedback_instanced</td>
<td style="text-align:left">4.2</td>
</tr>
<tr>
<td style="text-align:left">GL_ARB_transform_feedback_overflow_query</td>
<td style="text-align:left">4.6</td>
</tr>
</tbody>
</table>
<h1 id="transform-feedback-æ˜¯ä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#transform-feedback-æ˜¯ä»€ä¹ˆ"></a> Transform Feedback æ˜¯ä»€ä¹ˆ</h1>
<p>TFæ˜¯å°†Vertex_Processingé˜¶æ®µäº§ç”Ÿçš„å›¾å…ƒçš„é¡¶ç‚¹å±æ€§(vertex attributes)ä¿å­˜(capture/record)åœ¨<strong>Transform Feedback Buffer</strong>, ä¿å­˜ä¹‹åä½ å¯ä»¥:</p>
<ul>
<li>CPUä¾§è¯»å–è¿™äº›æ•°æ®é‡æ–°åº”ç”¨åˆ°ä½ çš„æ¸²æŸ“å¼•æ“</li>
<li>GPUç›´æ¥å°†è¿™äº›æ•°æ®åé¦ˆåˆ°å¦ä¸€ä¸ªDraw Call</li>
</ul>
<p>æŸç§æ„ä¹‰ä¸Šè®²ï¼ŒTFæ˜¯OpenGLç¬¬ä¸€ç§compute shaderçš„å½¢å¼ï¼Œåœ¨TFä¹‹å‰ï¼Œå”¯ä¸€èƒ½ä»shaderçš„è¾“å‡ºè¯»å–æ•°æ®çš„æ–¹å¼æ˜¯<code>glReadPixels</code>å’Œå…¶åŒæ—API.</p>
<p><img src="/images/tf-gles-31.jpg" alt="OpenGL 3.1 Pipeline" /></p>
<h2 id="vertex-processing"><a class="markdownIt-Anchor" href="#vertex-processing"></a> <a href="https://www.khronos.org/opengl/wiki/Vertex_Processing">Vertex Processing</a></h2>
<p>TFçš„è¾“å…¥æ¥è‡ªVertex Processing, æ‰€ä»¥é¦–å…ˆè¦ç¡®å®šVertex Processingé˜¶æ®µéƒ½åšä»€ä¹ˆï¼Œè¾“å‡ºä»€ä¹ˆã€‚Vertex Processingçš„è¾“å‡ºæ˜¯å›¾å…ƒ(Primitives), å®ƒè‡³å°‘åŒ…å«ä¸€ä¸ªvertex shader.</p>
<table>
<thead>
<tr>
<th style="text-align:left">ç€è‰²å™¨</th>
<th style="text-align:left">æ˜¯å¦å¿…éœ€</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">VERTEX</td>
<td style="text-align:left">Y</td>
</tr>
<tr>
<td style="text-align:left">TESSELLATION</td>
<td style="text-align:left">N</td>
</tr>
<tr>
<td style="text-align:left">GEOMETRY</td>
<td style="text-align:left">N</td>
</tr>
</tbody>
</table>
<h2 id="capturing"><a class="markdownIt-Anchor" href="#capturing"></a> Capturing</h2>
<p>å½“Vertex Processingæœ€åçš„shaderæ˜¯geometryæˆ–tessellation evaluationæ—¶ï¼Œåˆ™æ‰€è®°å½•çš„å›¾å…ƒå°±æ˜¯geometryæˆ–tessellation evaluationè¾“å‡ºçš„å›¾å…ƒï¼Œå¦åˆ™é‚£äº›é¡¶ç‚¹æ•°æ®æ¥è‡ªvertex shader. å¦å¤–æ‰€è®°å½•çš„é¡¶ç‚¹æ•°æ®ä¹Ÿä¸ä¸€å®šéƒ½ä¿å­˜åœ¨åŒä¸€ä¸ªbufferé‡Œï¼Œè¿™å³ä¸º<code>bufferMode</code>çš„å«ä¹‰ã€‚</p>
<h3 id="capturing-setting"><a class="markdownIt-Anchor" href="#capturing-setting"></a> Capturing Setting</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void glTransformFeedbackVaryings(GLuint program,</span><br><span class="line">				 GLsizei count,</span><br><span class="line">				 const char **varyings,</span><br><span class="line">				 GLenum bufferMode);</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªAPIè®¾ç½®:</p>
<ul>
<li>
<p>å“ªäº›programçš„è¾“å‡ºå˜é‡è¢«<strong>captured</strong></p>
</li>
<li>
<p>capturingæ¨¡å¼ï¼Œ capturingæ¨¡å¼æœ‰ä¸¤ç§</p>
<ul>
<li><code>GL_INTERLEAVED_ATTRIBS</code></li>
<li><code>GL_SEPARATE_ATTRIBS</code></li>
</ul>
</li>
<li>
<p>interleaved mode</p>
</li>
</ul>
<p>è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰capturedçš„è¾“å‡ºè¢«ä¿å­˜åœ¨åŒä¸€ä¸ªbuffer object.</p>
<ul>
<li>separate mode</li>
</ul>
<p>è¿™ç§æ¨¡å¼ä¸‹ï¼Œè¾“å‡ºæœªå¿…è¢«capturedåˆ°ä¸åŒçš„buffer object, å®ƒä»…ä»…æ˜¯æŒ‡è¾“å‡ºè¢«capturedåˆ°ä¸åŒçš„<strong>buffer binding points</strong>. å› ä¸ºåŒä¸€ä¸ªbuffer objectçš„ä¸åŒåŒºåŸŸä¹Ÿå¯ä»¥è¢«ç»‘å®šåˆ°ä¸åŒçš„<strong>buffer binding points</strong>.</p>
<h3 id="captured-output-variables"><a class="markdownIt-Anchor" href="#captured-output-variables"></a> Captured Output Variables</h3>
<p>é‚£ä¹ˆå¯ä»¥è®°å½•çš„é¡¶ç‚¹å±æ€§æœ‰å¤šå°‘ä¸ªå‘¢ï¼Ÿå¤§å°å¦‚ä½•ï¼Ÿ</p>
<h3 id="å¤šå°‘é¡¶ç‚¹å±æ€§æˆ–æ€»å…±å¤šå°‘æ•°æ®å¯ä»¥è¢«è®°å½•"><a class="markdownIt-Anchor" href="#å¤šå°‘é¡¶ç‚¹å±æ€§æˆ–æ€»å…±å¤šå°‘æ•°æ®å¯ä»¥è¢«è®°å½•"></a> å¤šå°‘é¡¶ç‚¹å±æ€§æˆ–æ€»å…±å¤šå°‘æ•°æ®å¯ä»¥è¢«è®°å½•</h3>
<ul>
<li>separate capture</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">Limitation</th>
<th style="text-align:center">Minimal Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GL_MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS</td>
<td style="text-align:center">4</td>
</tr>
<tr>
<td style="text-align:left">GL_MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS</td>
<td style="text-align:center">4</td>
</tr>
</tbody>
</table>
<ul>
<li>interleaved capture</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">Limitation</th>
<th style="text-align:center">Minimal Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GL_MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS</td>
<td style="text-align:center">64</td>
</tr>
</tbody>
</table>
<ul>
<li>advanced interleaved capture (ä¸åŒçš„å˜é‡æ”¾åœ¨ä¸åŒçš„buffers)</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">Limitation</th>
<th style="text-align:center">Minimal Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GL_MAX_TRANSFORM_FEEDBACK_BUFFERS</td>
<td style="text-align:center">64</td>
</tr>
</tbody>
</table>
<p>æ³¨æ„åˆ°åœ¨interleaved capture modeä¸‹ï¼Œæ²¡æœ‰é¡¶ç‚¹å±æ€§ä¸ªæ•°çš„é™åˆ¶ï¼ŒåŸå› æ˜¯åœ¨interleaved modeä¸‹ï¼Œæ‰€æœ‰é¡¶ç‚¹å±æ€§éƒ½æ˜¯åœ¨åŒä¸€ä¸ªbufferä¸­ï¼Œæ‰€ä»¥é™åˆ¶äº†æ€»çš„componentsçš„ä¸ªæ•°åï¼Œæ— è®ºä½ è®°å½•å¤šå°‘ä¸ªå±æ€§ï¼Œè¿™äº›å±æ€§æ€»çš„componentsä¸ªæ•°ä¸èƒ½è¶…è¿‡è¿™ä¸ªæœ€å¤§å€¼, è€Œåœ¨separate modeä¸‹ï¼Œæ¯ä¸ªåˆ—å‡ºçš„å˜é‡æ˜¯ä¿å­˜åœ¨å„è‡ªä¸åŒçš„bufferä¸­ï¼Œæ‰€ä»¥é™¤äº†å¯¹componentsè®¾é™å¤–ï¼Œè¿˜è¦å¯¹å±æ€§ä¸ªæ•°è®¾é™ã€‚æ‰€ä»¥è¿™é‡Œ<code>GL_MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS</code>çš„ä¸€ä¸ªæ›´å¥½çš„åå­—åº”è¯¥æ˜¯<code>GL_MAX_TRANSFORM_FEEDBACK_SEPARATE_BUFFERS</code>.</p>
<h3 id="é¡¶ç‚¹å±æ€§çš„æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#é¡¶ç‚¹å±æ€§çš„æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆ"></a> é¡¶ç‚¹å±æ€§çš„æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆ</h3>
<ul>
<li>structs</li>
<li>arrays</li>
<li>members of interface blocks</li>
</ul>
<h2 id="varyings"><a class="markdownIt-Anchor" href="#varyings"></a> Varyings</h2>
<h1 id="transform-feedback-å¤„ç†è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#transform-feedback-å¤„ç†è¿‡ç¨‹"></a> Transform Feedback å¤„ç†è¿‡ç¨‹</h1>
<h2 id="feedback-buffer-binding"><a class="markdownIt-Anchor" href="#feedback-buffer-binding"></a> Feedback Buffer Binding</h2>
<p>å½“è®¾ç½®å¥½è¦capturing programä¸­çš„å“ªäº›è¾“å‡ºå˜é‡ï¼Œä»¥ä½•ç§æ¨¡å¼capturedåï¼Œæ¥ä¸‹æ¥å°±è¦è®¾ç½®(ç”³è¯·)ä¿å­˜capturedçš„æ•°æ®çš„buffer objects.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void glBindBufferRange(GLenum target,</span><br><span class="line">		       GLuint index,</span><br><span class="line">		       GLuint buffer,</span><br><span class="line">		       GLintptr offset,</span><br><span class="line">		       GLsizeiptr size);</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ<code>target</code>å°±æ˜¯<code>GL_TRANSFORM_FEEDBACK_BUFFER</code>. <code>offset</code>å¿…é¡»æ˜¯4å­—èŠ‚å¯¹é½ï¼Œå¦‚æœå­˜è¿›bufferçš„å€¼åŒ…å«<strong>double-precision</strong>, åˆ™éœ€è¦8å­—èŠ‚å¯¹é½ã€‚</p>
<h2 id="feedback-beginend"><a class="markdownIt-Anchor" href="#feedback-beginend"></a> Feedback Begin/End</h2>
<p>Captureè®¾ç½®å¥½ï¼ŒBufferç»‘å®šå¥½ä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹<strong>Recording</strong> Vertex Processingäº§å‡ºçš„æ•°æ®äº†ã€‚é€šè¿‡è°ƒç”¨ä¸‹é¢çš„APIå¼€å§‹Feedback:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void glBeginTransformFeedback(GLenum primitiveMode);</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ<code>primitiveMode</code>åªèƒ½æ˜¯ä»¥ä¸‹3ç§ä¹‹ä¸€:</p>
<ul>
<li>GL_POINTS</li>
<li>GL_LINES</li>
<li>GL_TRIANGLES</li>
</ul>
<p>Transform Feedbackæ¨¡å¼è¢«æ¿€æ´»åï¼Œåœ¨æ²¡æœ‰è°ƒç”¨<code>glPauseTransformFeedback</code>æˆ–<code>glEndTransformFeedback</code>ä¹‹å‰ï¼Œä»¥ä¸‹è¡Œä¸ºä¸è¢«å…è®¸:</p>
<ul>
<li>ä¿®æ”¹<code>GL_TRANSFORM_FEEDBACK_BUFFER</code>çš„bindings</li>
<li>ä»»ä½•å¯¹è¿™äº›ç»‘å®šçš„<code>GL_TRANSFORM_FEEDBACK_BUFFER</code>çš„è¯»å†™æ“ä½œ</li>
<li>é‡æ–°ç”³è¯·è¿™äº›ç»‘å®šçš„<code>GL_TRANSFORM_FEEDBACK_BUFFER</code>çš„å­˜å‚¨</li>
<li>ä¿®æ”¹å½“å‰ä½¿ç”¨çš„program, ä¹Ÿå°±æ˜¯ä¸èƒ½è°ƒç”¨<code>glUseProgram</code>æˆ–<code>glBindProgramPipeline</code>, è¿˜æœ‰<code>glUseProgramStages</code></li>
</ul>
<p>é€€å‡ºTransform Feedbackæ¨¡å¼è°ƒç”¨:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void glEndTransformFeedback();</span><br></pre></td></tr></table></figure>
<h2 id="feedback-objects"><a class="markdownIt-Anchor" href="#feedback-objects"></a> Feedback Objects</h2>
<p>è·Ÿå…¶å®ƒOpenGLçš„åŠŸèƒ½ä¸€æ ·ï¼ŒTransform Feedbackä¹Ÿæœ‰ä¸€å¤§å †stateéœ€è¦track, æ‰€ä»¥è¿™äº›stateè¢«å°è£…è¿›<strong>Transform Feedback Objects</strong>, è¿™äº›Feedback Objectså’Œå…¶å®ƒOpenGL Objectä¸€æ ·éœ€è¦<code>Gen</code>, <code>Delete</code>å’Œ<code>Bind</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void glGenTransformFeedbacks(GLsizei n, GLuint *ids);</span><br><span class="line">void glDeleteTransformFeedbacks(GLsizei n, const GLuint *ids);</span><br><span class="line">void glBindTransformFeedback(GLenum target, GLuint id);</span><br></pre></td></tr></table></figure>
<p>NOTE:</p>
<ul>
<li><code>glBindTransformFeedback</code>çš„<code>target</code>æ°¸è¿œæ˜¯<code>GL_TRANSFORM_FEEDBACK</code></li>
<li>ä¸èƒ½ç»‘å®šä¸€ä¸ªFeedback Objectï¼Œå¦‚æœå½“å‰çš„Feedback Objectè¿˜æ˜¯activeæˆ–æ²¡æœ‰è¢«paused.</li>
</ul>
<p>é‚£ä¹ˆFeedback Objecté‡Œå°è£…äº†å“ªäº›Transform Feedback stateå‘¢ï¼Ÿ</p>
<ul>
<li>generic buffer bindings, å³è°ƒç”¨<code>glBindBuffer(GL_TRANSFORM_FEEDBACK_BUFFER, ...)</code>ç»‘å®šçš„é‚£äº›buffers</li>
<li>indexed buffer bindings, å³è°ƒç”¨<code>glBindBufferRange(GL_TRANSFORM_FEEDBACK, ...)</code>ç»‘å®šçš„é‚£äº›buffers</li>
<li>transform feedbackæ˜¯å¦æ˜¯activeè¿˜æ˜¯paused</li>
<li>è¢«å½“å‰çš„feedbackæ“ä½œè®°å½•çš„count of primitivesç­‰ç­‰</li>
</ul>
<h2 id="feedback-rendering"><a class="markdownIt-Anchor" href="#feedback-rendering"></a> Feedback Rendering</h2>
<p>OK, æˆ‘ä»¬ç°åœ¨è·å¾—äº†Vertex Processingçš„ç»“æœï¼Œå¹¶è®°å½•äº†è¿™æ¬¡Transform Feedbackæ“ä½œçš„çŠ¶æ€åˆ°Transform Feedback Objects(ä¾‹å¦‚captured count of primitives, the number of vertices). ä½†æ˜¯æˆ‘ä»¬å¦‚ä½•åˆ©ç”¨è¿™äº›capturedæ•°æ®å‘¢ï¼Ÿ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void glDrawTransformFeedback(GLenum mode,</span><br><span class="line">			     GLuint id);</span><br><span class="line"></span><br><span class="line">void glDrawTransformFeedbackInstanced(GLenum mode,</span><br><span class="line">				      GLuint id,</span><br><span class="line">				      GLsizei instancecount);</span><br><span class="line">void glDrawTransformFeedbackStream(GLenum mode,</span><br><span class="line">				   GLuint id,</span><br><span class="line">				   GLuint stream);</span><br><span class="line">void glDrawTransformFeedbackStreamInstanced(GLenum mode,</span><br><span class="line">					    GLuint id,</span><br><span class="line">					    GLuint stream,</span><br><span class="line">					    GLsizei instancecount);</span><br></pre></td></tr></table></figure>
<p>NOTE:</p>
<ul>
<li>åœ¨è°ƒç”¨è¿™äº›<code>Draw</code>å‘½ä»¤å‰ï¼Œä¸€å®šè¦å…ˆè°ƒç”¨<code>glEndTransformFeedback</code>, å› ä¸ºåªæœ‰å½“è°ƒç”¨äº†<code>glEndTransformFeedback</code>åï¼ŒOpenGLçŠ¶æ€æœºæ‰çŸ¥é“ä¸€æ¬¡å®Œæ•´çš„Transform Feedbackæ“ä½œå®Œæˆäº†ã€‚</li>
</ul>
<h1 id="transform-feedback-åº”ç”¨"><a class="markdownIt-Anchor" href="#transform-feedback-åº”ç”¨"></a> Transform Feedback åº”ç”¨</h1>
<p>TFæœ€å¸¸è§çš„åº”ç”¨æ˜¯ç²’å­ç³»ç»Ÿ(Particle System), å³åŒ…å«è®¸è®¸å¤šå¤šå°é¢—ç²’çš„åœºæ™¯ï¼Œå¦‚çƒŸï¼Œé›¾ï¼Œç«ç­‰ï¼Œè¿™äº›åœºæ™¯çš„å…±åŒç‚¹æ˜¯åŒ…å«å¤§é‡é¡¶ç‚¹ï¼Œè€Œä¸”é¡¶ç‚¹å±æ€§åœ¨ä¸æ–­å˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰TF, ä¼šå¤§å¤§å¢åŠ CPUå‘GPUä¼ é€é¡¶ç‚¹æ•°æ®çš„å¼€é”€ï¼Œä¸è®ºæ˜¯æ€»çº¿çš„å¸¦å®½è¿˜æ˜¯CPUçš„ä½¿ç”¨ç‡éƒ½å¯èƒ½æ— æ³•æ‰¿å—ã€‚</p>
<h2 id="ä¾‹å­-springmass"><a class="markdownIt-Anchor" href="#ä¾‹å­-springmass"></a> ä¾‹å­ springmass</h2>
<ul>
<li>ä¸¤ä¸ªShader programs
<ul>
<li><code>m_update_program</code>, ç”¨æ¥æ›´æ–°(é‡æ–°è®¡ç®—)é¡¶ç‚¹å±æ€§</li>
<li><code>m_render_program</code>, ç”¨æ¥æ¸²æŸ“æœ€åçš„ç”»é¢</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void render(double t)</span><br><span class="line">&#123;</span><br><span class="line">    int i;</span><br><span class="line">    glUseProgram(m_update_program);</span><br><span class="line"></span><br><span class="line">    glEnable(GL_RASTERIZER_DISCARD);</span><br><span class="line"></span><br><span class="line">    for (i = iterations_per_frame; i != 0; --i)</span><br><span class="line">    &#123;</span><br><span class="line">        glBindVertexArray(m_vao[m_iteration_index &amp; 1]);</span><br><span class="line">        glBindTexture(GL_TEXTURE_BUFFER, m_pos_tbo[m_iteration_index &amp; 1]);</span><br><span class="line">        m_iteration_index++;</span><br><span class="line">        glBindBufferBase(GL_TRANSFORM_FEEDBACK_BUFFER, 0, m_vbo[POSITION_A + (m_iteration_index &amp; 1)]);</span><br><span class="line">        glBindBufferBase(GL_TRANSFORM_FEEDBACK_BUFFER, 1, m_vbo[VELOCITY_A + (m_iteration_index &amp; 1)]);</span><br><span class="line">        glBeginTransformFeedback(GL_POINTS);</span><br><span class="line">        glDrawArrays(GL_POINTS, 0, POINTS_TOTAL);</span><br><span class="line">        glEndTransformFeedback();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    glDisable(GL_RASTERIZER_DISCARD);</span><br><span class="line"></span><br><span class="line">    static const GLfloat black[] = &#123; 0.0f, 0.0f, 0.0f, 0.0f &#125;;</span><br><span class="line"></span><br><span class="line">    glViewport(0, 0, info.windowWidth, info.windowHeight);</span><br><span class="line">    glClearBufferfv(GL_COLOR, 0, black);</span><br><span class="line"></span><br><span class="line">    glUseProgram(m_render_program);</span><br><span class="line"></span><br><span class="line">    if (draw_points)</span><br><span class="line">    &#123;</span><br><span class="line">        glPointSize(4.0f);</span><br><span class="line">        glDrawArrays(GL_POINTS, 0, POINTS_TOTAL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (draw_lines)</span><br><span class="line">    &#123;</span><br><span class="line">        glBindBuffer(GL_ELEMENT_ARRAY_BUFFER, m_index_buffer);</span><br><span class="line">        glDrawElements(GL_LINES, CONNECTIONS_TOTAL * 2, GL_UNSIGNED_INT, NULL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™æ®µ<code>render()</code>å‡½æ•°çš„å‰åŠæ®µæ˜¯ä¸€ä¸ªåŒç¼“å†²äº¤æ›¿çš„æ¨¡å¼, ç”¨æ¥å€’æ¢TFBå’ŒVertex Array Bufferçš„æ•°æ®ã€‚ååŠæ®µæ˜¯ç®€å•çš„<code>DrawArrays()</code>æˆ–<code>DrawElements()</code>ã€‚æˆ‘ä»¬ç®€å•è¯´ä¸‹å‰åŠæ®µçš„for-loop.</p>
<p>é¦–å…ˆå®šä¹‰äº†3ä¸ªBufferæ•°ç»„ï¼šåˆ†åˆ«ç”¨ä½œVertex Array Buffer, Transform Feedback Bufferå’ŒTexture Buffer</p>
<ul>
<li><code>m_vao[2] = &#123;1, 2&#125;</code></li>
<li><code>m_vbo[5] = &#123;1, 2, 3, 4, 5&#125;</code></li>
<li><code>m_pos_tbo[2] = &#123;1, 2&#125;</code></li>
</ul>
<p>å¾ªç¯å±•å¼€å:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 0</span></span><br><span class="line">glBindVertexArray(<span class="number">1</span>);</span><br><span class="line">glBindTexture(GL_TEXTURE_BUFFER, <span class="number">1</span>);</span><br><span class="line">m_iteration_index++;</span><br><span class="line">glBindBufferBase(GL_TRANSFORM_FEEDBACK_BUFFER, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">glBindBufferBase(GL_TRANSFORM_FEEDBACK_BUFFER, <span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">glBeginTransformFeedback(GL_POINTS);</span><br><span class="line">glDrawArrays(GL_POINTS, <span class="number">0</span>ï¼ŒPOINTS_TOTAL);</span><br><span class="line">glEndTransformFeedback();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line">glBindVertexArray(<span class="number">2</span>);</span><br><span class="line">glBindTexture(GL_TEXTURE_BUFFER, <span class="number">2</span>);</span><br><span class="line">m_iteration_index++;</span><br><span class="line">glBindBufferBase(GL_TRANSFORM_FEEDBACK_BUFFER, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">glBindBufferBase(GL_TRANSFORM_FEEDBACK_BUFFER, <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">glBeginTransformFeedback(GL_POINTS);</span><br><span class="line">glDrawArrays(GL_POINTS, <span class="number">0</span>ï¼ŒPOINTS_TOTAL);</span><br><span class="line">glEndTransformFeedback();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line">glBindVertexArray(<span class="number">1</span>);</span><br><span class="line">glBindTexture(GL_TEXTURE_BUFFER, <span class="number">1</span>);</span><br><span class="line">m_iteration_index++;</span><br><span class="line">glBindBufferBase(GL_TRANSFORM_FEEDBACK_BUFFER, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">glBindBufferBase(GL_TRANSFORM_FEEDBACK_BUFFER, <span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">glBeginTransformFeedback(GL_POINTS);</span><br><span class="line">glDrawArrays(GL_POINTS, <span class="number">0</span>ï¼ŒPOINTS_TOTAL);</span><br><span class="line">glEndTransformFeedback();</span><br></pre></td></tr></table></figure>
<p><img src="/images/ompparticles.png" alt="ompparticles" /></p>
<p><a href="https://github.com/lwtbn1/OpenGL_Superbible_7th/blob/master/src/ompparticles/ompparticles.cpp">ompparticles.cpp</a></p>
<h1 id="å‚è€ƒ"><a class="markdownIt-Anchor" href="#å‚è€ƒ"></a> å‚è€ƒ</h1>
<ul>
<li><a href="http://jason-blog.jlekstrand.net/2018/10/transform-feedback-is-terrible-so-why.html">Transform Feedback Is Terrible, So Why Are We Doing It</a></li>
<li><a href="https://community.arm.com/cn/b/blog/posts/transform-feedback-1547554897">Transform Feedbackçš„å‰ä¸–ä»Šç”Ÿ(ä¸€)</a></li>
<li><a href="https://ogldev.org/www/tutorial28/tutorial28.html">Particle System using Transform Feedback</a></li>
</ul>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>OpenGL</tag>
      </tags>
  </entry>
  <entry>
    <title>Build X Server (Xorg) from Source</title>
    <url>/gfx/X/build-xserver/</url>
    <content><![CDATA[<h1 id="motivation"><a class="markdownIt-Anchor" href="#motivation"></a> Motivation</h1>
<p>Given that a difficulty to add a custom X11 device driver or module or extension for Xserver, I try to find out how an Xserver is built and its dependent drivers and modules and extensions are orgnized together by building it from <a href="https://gitlab.freedesktop.org/xorg/xserver.git">source</a>.</p>
<span id="more"></span>
<h1 id="build"><a class="markdownIt-Anchor" href="#build"></a> Build</h1>
<p>Xorg çš„æºç åº“å…‹éš†ä¸‹æ¥åï¼Œcheckout åˆ°ç›®æ ‡åˆ†æ”¯æˆ– tag, å‡è®¾æˆ‘ä»¬æƒ³ç¼–è¯‘ xorg-server-1.20.4 è¿™ä¸ªç‰ˆæœ¬</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git checkout xorg-server-1.20.4 -b 1.20.4  // å°†è¿™ä¸ª tag æ£€å‡ºåå‘½åä¸º 1.20.4 åˆ†æ”¯</span><br></pre></td></tr></table></figure>
<p>X Server çš„æºç åº“ä¸­é™¤äº† Xorgï¼Œè¿˜åŒ…å« modesetting_drv.so, xnest, xwin, xvfb ç­‰ï¼Œè¿™äº›ç»„ä»¶å¹¶ä¸å…¨éƒ½éœ€è¦ï¼Œå¦‚æœå…¨éƒ½ç¼–è¯‘ï¼Œå¯èƒ½ä¼šæœ‰æ›´å¤šçš„ä¾èµ–ã€‚<br />
å¦å¤–ï¼ŒXorg æœ¬èº«å®‰è£…åœ¨ /usr/bin/ ç›®å½•, å…¶å®ƒç›¸å…³ DDX é©±åŠ¨å®‰è£…åœ¨ /usr/lib/xorg/modules ç›®å½•ï¼Œä¸ºäº†è®©ç¼–è¯‘å¥½çš„ Xorg å’Œç›¸å…³é©±åŠ¨å®‰è£…åèƒ½å¤Ÿè¦†ç›–åŸæ¥çš„ï¼Œéœ€è¦é€šè¿‡æŒ‡å®š meson çš„ <code>prefix</code> å’Œ <code>libdir</code> æ„å»ºå˜é‡</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">meson build -Dprefix=/usr -Dlibdir=lib -Dxnest=false -Dxwin=false -Dxvfb=false</span><br></pre></td></tr></table></figure>
<p>NOTES: é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>prefix=/usr/local</code>, <code>libdir=lib/x86_64-linux-gnu</code></p>
<p>æ„å»ºé…ç½®å®Œæˆåï¼Œè¿›è¡Œç¼–è¯‘</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ninja -C build</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å®Œæˆåï¼Œä½¿ç”¨ sudo è¿›è¡Œå®‰è£…</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo ninja install -C build</span><br></pre></td></tr></table></figure>
<p>å®‰è£…æˆåŠŸåï¼Œä½¿ç”¨ systemd é‡å¯ X Server æœåŠ¡ ï¼ˆå‡è®¾ä½¿ç”¨çš„çª—å£ç®¡ç†å™¨æ˜¯ lightdm)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo systemctl restart lightdm</span><br></pre></td></tr></table></figure>
<p>It is easy to find what are built with <code>find build -type f -perm /a+x -regex '.*[^0-9h]$'</code></p>
<pre>
./build/meson-private/sanitycheckc.exe
./build/test/tests
./build/test/simple-xinit
./build/hw/xnest/Xnest
./build/hw/vfb/Xvfb
./build/hw/xfree86/gtf
./build/hw/xfree86/vgahw/libvgahw.so
./build/hw/xfree86/libxorgserver.so
./build/hw/xfree86/fbdevhw/libfbdevhw.so
./build/hw/xfree86/drivers/modesetting/modesetting_drv.so
./build/hw/xfree86/dixmods/libglx.so
./build/hw/xfree86/dixmods/libwfb.so
./build/hw/xfree86/dixmods/libshadow.so
./build/hw/xfree86/shadowfb/libshadowfb.so
./build/hw/xfree86/cvt
./build/hw/xfree86/exa/libexa.so
./build/hw/xfree86/Xorg
./build/hw/xfree86/int10/libint10.so
./build/hw/xfree86/loader/xorg_symbol_test
</pre>
<p>where <code>./build/hw/xfree86/Xorg</code> is newly built Xserver.</p>
<h2 id="replacement"><a class="markdownIt-Anchor" href="#replacement"></a> Replacement</h2>
<p>Now that we have an Xorg out there, we can try it. I have an <em>xrdp</em> installed on my WSL as its desktop environment. We can replace <code>xorgxrdp</code> with this new one for testing. To do it, we need to modify xrdpâ€™s init configuration file <code>/etc/xrdp/sesman.ini</code></p>
<pre>
[Xorg]
; Specify the path of non-suid Xorg executable. It might differ depending
; on your distribution and version. The typical path is shown as follows:
;
; Fedora 26 or later    :  param=/usr/libexec/Xorg
; Debian 9 or later     :  param=/usr/lib/xorg/Xorg
; Ubuntu 16.04 or later :  param=/usr/lib/xorg/Xorg
; Arch Linux            :  param=/usr/lib/xorg-server/Xorg
; CentOS 7              :  param=/usr/bin/Xorg or param=Xorg
;
;param=/usr/lib/xorg/Xorg
;
param=/home/luc/github/xserver/build/hw/xfree86/Xorg
</pre>
<p>But it failed on restart xrdp.service. We check the log and <code>/etc/X11/xrdp/xorg.conf</code>. It turns out some drivers related xrdp do not exist. It is xrdp that customizes Xorg.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grep &#x27;(EE) Failed to&#x27; ~/.xorgxrdp.25.log</span><br></pre></td></tr></table></figure>
<pre>
[ 22862.100] (EE) Failed to load module "glx" (module does not exist, 0)
[ 22862.100] (EE) Failed to load module "int10" (module does not exist, 0)
[ 22862.100] (EE) Failed to load module "vbe" (module does not exist, 0)
[ 22862.100] (EE) Failed to load module "glamoregl" (module does not exist, 0)
[ 22862.100] (EE) Failed to load module "xorgxrdp" (module does not exist, 0)
[ 22862.100] (EE) Failed to load module "xrdpdev" (module does not exist, 0)
[ 22862.100] (EE) Failed to load module "xrdpmouse" (module does not exist, 0)
[ 22862.100] (EE) Failed to load module "xrdpkeyb" (module does not exist, 0)
</pre>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grep -E &#x27;(Driver | Load)&#x27; /etc/X11/xrdp/xorg.conf</span><br></pre></td></tr></table></figure>
<pre>
    Load "dbe"
    Load "ddc"
    Load "extmod"
    Load "glx"
    Load "int10"
    Load "record"
    Load "vbe"
    Load "glamoregl"
    Load "xorgxrdp"
    Load "fb"
    Driver "xrdpkeyb"
    Driver "xrdpmouse"
    Driver "xrdpdev"
</pre>
<h2 id="conclusion"><a class="markdownIt-Anchor" href="#conclusion"></a> Conclusion</h2>
<p>Xserver/Xorg is built in a flexible and easy way. We can implement our own device-dependent functionality and add it to Xserver as its another driver or module.</p>
<h1 id="xserver-ç›¸å…³å·¥å…·"><a class="markdownIt-Anchor" href="#xserver-ç›¸å…³å·¥å…·"></a> Xserver ç›¸å…³å·¥å…·</h1>
<h2 id="xinit"><a class="markdownIt-Anchor" href="#xinit"></a> xinit</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">âœ  ~ dpkg --contents /var/cache/apt/archives/xinit_1.4.1-0ubuntu2_amd64.deb | awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span> | rg -v <span class="string">&#x27;/$&#x27;</span></span><br><span class="line">./etc/X11/xinit/xinitrc</span><br><span class="line">./etc/X11/xinit/xserverrc</span><br><span class="line">./usr/bin/startx</span><br><span class="line">./usr/bin/xinit</span><br><span class="line">./usr/share/doc/xinit/NEWS.Debian.gz</span><br><span class="line">./usr/share/doc/xinit/changelog.Debian.gz</span><br><span class="line">./usr/share/doc/xinit/copyright</span><br><span class="line">./usr/share/man/man1/startx.1.gz</span><br><span class="line">./usr/share/man/man1/xinit.1.gz</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>X11</tag>
      </tags>
  </entry>
  <entry>
    <title>Debugging X11 with tcpdump</title>
    <url>/gfx/X/debug-x11-with-tcpdump/</url>
    <content><![CDATA[<p>X11 is designed as client-server mode. The communication between the X client and server complies with TCP protocol. Recently I have a Windows X server VcXsrv installed on my Windows 10 and I debug an OpenGL demo glxgears on the WSL2 with tcpdump.</p>
<h2 id="environment"><a class="markdownIt-Anchor" href="#environment"></a> Environment</h2>
<p>WSL2 is equipped with its own networking interface like a virtual machine.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifconfig</span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.28.233.193  netmask 255.255.240.0  broadcast 172.28.239.255</span><br><span class="line">        inet6 fe80::215:5dff:fe27:9562  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 00:15:5d:27:95:62  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 221579  bytes 15160108 (15.1 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 306691  bytes 15714800233 (15.7 GB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 392  bytes 43340 (43.3 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 392  bytes 43340 (43.3 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ /mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe -C <span class="string">&quot;ipconfig&quot;</span></span><br><span class="line"></span><br><span class="line">Windows IP Configuration</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Ethernet adapter vEthernet (WSL):</span><br><span class="line"></span><br><span class="line">   Connection-specific DNS Suffix  . : </span><br><span class="line">   Link-<span class="built_in">local</span> IPv6 Address . . . . . : fe80::412b:ad3:5548:67ba%38</span><br><span class="line">   IPv4 Address. . . . . . . . . . . : 172.28.224.1</span><br><span class="line">   Subnet Mask . . . . . . . . . . . : 255.255.240.0</span><br><span class="line">   Default Gateway . . . . . . . . . : </span><br><span class="line"></span><br><span class="line">Wireless LAN adapter Â±Â¾ÂµÃ˜ÃÂ¬Â½Ã“* 1:</span><br><span class="line"></span><br><span class="line">   Media State . . . . . . . . . . . : Media disconnected</span><br><span class="line">   Connection-specific DNS Suffix  . : </span><br><span class="line"></span><br><span class="line">Wireless LAN adapter Â±Â¾ÂµÃ˜ÃÂ¬Â½Ã“* 10:</span><br><span class="line"></span><br><span class="line">   Media State . . . . . . . . . . . : Media disconnected</span><br><span class="line">   Connection-specific DNS Suffix  . : </span><br><span class="line"></span><br><span class="line">Wireless LAN adapter WLAN:</span><br><span class="line"></span><br><span class="line">   Connection-specific DNS Suffix  . : DHCP HOST</span><br><span class="line">   Link-<span class="built_in">local</span> IPv6 Address . . . . . : fe80::954b:e66f:4065:20af%20</span><br><span class="line">   IPv4 Address. . . . . . . . . . . : 192.168.2.100</span><br><span class="line">   Subnet Mask . . . . . . . . . . . : 255.255.255.0</span><br><span class="line">   Default Gateway . . . . . . . . . : 192.168.2.1</span><br></pre></td></tr></table></figure>
<p>After starting up the X server VcXsrv, you need to export the environmnet variable <strong><code>DISPLAY</code></strong> on the WSL. In case of the vEthernet configuration changed after rebooting youâ€™d better do it like this:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> DISPLAY=$(grep <span class="string">&#x27;nameserver&#x27;</span> /etc/resolv.conf | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>):0</span><br></pre></td></tr></table></figure>
<p>NOTE: The Firewall between the host and WSL2 must be disabled or your X client can not connect VcXsrv.</p>
<h2 id="debugging"><a class="markdownIt-Anchor" href="#debugging"></a> Debugging</h2>
<p>I trace the demo glxgears using gdb and tcpdump at the same time.</p>
<ul>
<li>gdb</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gdb -q -tui glxgears</span><br></pre></td></tr></table></figure>
<ul>
<li>tcpdump</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo tcpdump -vvX not icmp and not arp and not udp and portrange 37900-37999 -w x110224.pcap</span><br></pre></td></tr></table></figure>
<ul>
<li>vv: verboser than -v</li>
<li>X: show the packetâ€™s content</li>
<li>not icmp: filter out icmp packets</li>
<li>not arp: filter out arp packets</li>
<li>not udp: filter out udp packets</li>
<li>portrange 37900-37999: listening on the ports from 37900 to 37999</li>
<li>w x110224.pcap: save the packet captures into the file</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump -X -r x110224.pcap</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">reading from file /home/luc/github/x110224.pcap, link-type EN10MB (Ethernet)</span><br><span class="line">09:11:56.659816 IP 172.28.233.193.37950 &gt; 172.28.224.1.x11: Flags [P.], seq 2796598646:2796598658, ack 1053772981, win 259, length 12</span><br><span class="line">	0x0000:  4500 0034 1d84 4000 4006 fb43 ac1c e9c1  E..4..@.@..C....</span><br><span class="line">	0x0010:  ac1c e001 943e 1770 a6b0 b576 3ecf 4cb5  .....&gt;.p...v&gt;.L.</span><br><span class="line">	0x0020:  5018 0103 2223 0000 6200 0300 0400 0000  P...&quot;#..b.......</span><br><span class="line">	0x0030:  4452 4932                                DRI2</span><br><span class="line">09:11:56.660218 IP 172.28.224.1.x11 &gt; 172.28.233.193.37950: Flags [P.], seq 1:33, ack 12, win 8211, length 32</span><br><span class="line">	0x0000:  4500 0048 d9d7 4000 8006 fedb ac1c e001  E..H..@.........</span><br><span class="line">	0x0010:  ac1c e9c1 1770 943e 3ecf 4cb5 a6b0 b582  .....p.&gt;&gt;.L.....</span><br><span class="line">	0x0020:  5018 2013 cf36 0000 0100 0a00 0000 0000  P....6..........</span><br><span class="line">	0x0030:  0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">	0x0040:  0000 0000 0000 0000                      ........</span><br><span class="line">09:11:56.660232 IP 172.28.233.193.37950 &gt; 172.28.224.1.x11: Flags [.], ack 33, win 259, length 0</span><br><span class="line">	0x0000:  4500 0028 1d85 4000 4006 fb4e ac1c e9c1  E..(..@.@..N....</span><br><span class="line">	0x0010:  ac1c e001 943e 1770 a6b0 b582 3ecf 4cd5  .....&gt;.p....&gt;.L.</span><br><span class="line">	0x0020:  5010 0103 2217 0000                      P...&quot;...</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>what codes sends and receives these packets? The first two twenty-byted segments are IP header (20 bytes without option) and TCP header (20 bytes without option) separately in these packets.</p>
<p>The source code snippet:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Bool</span><br><span class="line"><span class="title function_">XQueryExtension</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="keyword">register</span> Display *dpy,</span></span><br><span class="line"><span class="params">    _Xconst <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params">    <span class="type">int</span> *major_opcode,  <span class="comment">/* RETURN */</span></span></span><br><span class="line"><span class="params">    <span class="type">int</span> *first_event,   <span class="comment">/* RETURN */</span></span></span><br><span class="line"><span class="params">    <span class="type">int</span> *first_error)</span>	<span class="comment">/* RETURN */</span></span><br><span class="line">&#123;</span><br><span class="line">    xQueryExtensionReply rep;</span><br><span class="line">    <span class="keyword">register</span> xQueryExtensionReq *req;</span><br><span class="line"></span><br><span class="line">    LockDisplay(dpy);</span><br><span class="line">    GetReq(QueryExtension, req);</span><br><span class="line">    req-&gt;nbytes = name ? <span class="built_in">strlen</span>(name) : <span class="number">0</span>;</span><br><span class="line">    req-&gt;length += (req-&gt;nbytes+(<span class="type">unsigned</span>)<span class="number">3</span>)&gt;&gt;<span class="number">2</span>;</span><br><span class="line">    _XSend(dpy, name, (<span class="type">long</span>)req-&gt;nbytes);</span><br><span class="line">    (<span class="type">void</span>) _XReply (dpy, (xReply *)&amp;rep, <span class="number">0</span>, xTrue);</span><br><span class="line">    *major_opcode = rep.major_opcode;</span><br><span class="line">    *first_event = rep.first_event;</span><br><span class="line">    *first_error = rep.first_error;</span><br><span class="line">    UnlockDisplay(dpy);</span><br><span class="line">    SyncHandle();</span><br><span class="line">    <span class="keyword">return</span> (rep.present);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The gdb log:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Starting program: /mnt/c/Users/lulu/Documents/github/demos/src/xdemos/glxgears </span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, XextAddDisplay (extinfo=0x7ffff7e77380 &lt;_dri2Info_data&gt;, dpy=0x55555555d2a0, </span><br><span class="line">    ext_name=0x7ffff7e76780 &lt;dri2ExtensionName&gt; &quot;DRI2&quot;, hooks=0x7ffff7e767a0 &lt;dri2ExtensionHooks&gt;, nevents=0, data=0x0)</span><br><span class="line">    at extutil.c:103</span><br><span class="line">XInitExtension (dpy=dpy@entry=0x55555555d2a0, name=name@entry=0x7ffff7e76780 &lt;dri2ExtensionName&gt; &quot;DRI2&quot;)</span><br><span class="line">    at InitExt.c:44</span><br><span class="line">XQueryExtension (dpy=dpy@entry=0x55555555d2a0, name=name@entry=0x7ffff7e76780 &lt;dri2ExtensionName&gt; &quot;DRI2&quot;, </span><br><span class="line">    major_opcode=major_opcode@entry=0x7fffffffd984, first_event=first_event@entry=0x7fffffffd988, </span><br><span class="line">    first_error=first_error@entry=0x7fffffffd98c) at QuExt.c:39</span><br><span class="line">$2 = &#123;</span><br><span class="line">  reqType = 0x62, </span><br><span class="line">  pad = 0x0, </span><br><span class="line">  length = 0x3, </span><br><span class="line">  nbytes = 0x4, </span><br><span class="line">  pad1 = 0x0, </span><br><span class="line">  pad2 = 0x0</span><br><span class="line">&#125;</span><br><span class="line">$3 = &#123;</span><br><span class="line">  type = 0x1, </span><br><span class="line">  pad1 = 0x0, </span><br><span class="line">  sequenceNumber = 0xa, </span><br><span class="line">  length = 0x0, </span><br><span class="line">  present = 0x0, </span><br><span class="line">  major_opcode = 0x0, </span><br><span class="line">  first_event = 0x0, </span><br><span class="line">  first_error = 0x0, </span><br><span class="line">  pad3 = 0x0, </span><br><span class="line">  pad4 = 0x0, </span><br><span class="line">  pad5 = 0x0, </span><br><span class="line">  pad6 = 0x0, </span><br><span class="line">  pad7 = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>$2</code> is <strong>Request</strong> packet content to VcXsrv, <code>$3</code> is <strong>Reply</strong> packet content from VcXsrv. Even that we can notice the three-way handshake of TCP from the zero-lengthed packet in x110224.pcap.</p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>X11</tag>
      </tags>
  </entry>
  <entry>
    <title>Kylin V10 çª—å£é€æ˜é—®é¢˜</title>
    <url>/gfx/X/kylin-alpha-issue/</url>
    <content><![CDATA[<p>æœ€è¿‘åœ¨çœ‹<a href="https://gitlab.freedesktop.org/xorg/xserver">X11 Serverçš„ä»£ç </a>,é¡ºæ‰‹åšä¸‹ç¬”è®°ã€‚X11 Serverçš„ä»£ç å¾ˆå¤è€äº†ï¼Œæœ‰çš„æ˜¯1993å¹´å†™çš„ï¼Œç›®å‰çš„X Serverå®ç°<a href="https://zh.wikipedia.org/wiki/X.Org_Server">X.org</a>æ˜¯ä»æœ€æ—©çš„ä¸€ä¸ªX Serverå®ç°<a href="https://zh.wikipedia.org/wiki/XFree86">XFree86</a> 4.4 RC2ç‰ˆæœ¬(2004å¹´)æ´¾ç”Ÿå‡ºæ¥çš„ã€‚</p>
<span id="more"></span>
<p>X11 Serverç¼–è¯‘åä¼šç”Ÿæˆè‹¥å¹²åŠ¨æ€é“¾æ¥åº“å½¢å¼çš„é©±åŠ¨ç¨‹åºå’Œä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºXorg. Xorgæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæœåŠ¡å™¨ç¨‹åºï¼Œåƒå…¶å®ƒæ‰€æœ‰æœåŠ¡å™¨ç¨‹åºä¸€æ ·ï¼Œå®ƒçš„mainå‡½æ•°é‡Œæœ‰ä¸€ä¸ªwhileå¾ªç¯ï¼Œä»¥ä¿è¯åœ¨ç¨‹åºå¯åŠ¨åï¼Œåˆ°ç¨‹åºé€€å‡ºå‰èƒ½å¤Ÿä¸ºå®¢æˆ·ç«¯æŒç»­æä¾›æœåŠ¡ã€‚Xorgçš„å¦ä¸€ä¸ªç‰¹ç‚¹æ˜¯æå…·æ‰©å±•æ€§ï¼Œæ‰€æœ‰åŠ¨æ€é“¾æ¥åº“å½¢å¼çš„DDX(Device Dependent X)é©±åŠ¨éƒ½æ˜¯ä»¥Xorg Moduleçš„æ–¹å¼åŠ¨æ€åŠ è½½çš„ï¼Œå…·ä½“åŠ è½½å“ªä¸ªDDX Driverç”±Xorgçš„Configæ–‡ä»¶é…ç½®ã€‚</p>
<h1 id="åŒä¸€ä¸ªä½¿ç”¨glfwçš„openglç¨‹åºåœ¨kylin-v10ç³»ç»Ÿä¸Šå¯ä»¥ä¿®æ”¹alphaé€šé“æ”¹å˜çª—å£èƒŒæ™¯çš„é€æ˜åº¦è€Œåœ¨ubuntu-focal-fossaç³»ç»Ÿä¸Šå´ä¸èƒ½"><a class="markdownIt-Anchor" href="#åŒä¸€ä¸ªä½¿ç”¨glfwçš„openglç¨‹åºåœ¨kylin-v10ç³»ç»Ÿä¸Šå¯ä»¥ä¿®æ”¹alphaé€šé“æ”¹å˜çª—å£èƒŒæ™¯çš„é€æ˜åº¦è€Œåœ¨ubuntu-focal-fossaç³»ç»Ÿä¸Šå´ä¸èƒ½"></a> åŒä¸€ä¸ªä½¿ç”¨glfwçš„OpenGLç¨‹åºåœ¨Kylin V10ç³»ç»Ÿä¸Šå¯ä»¥ä¿®æ”¹alphaé€šé“æ”¹å˜çª—å£èƒŒæ™¯çš„é€æ˜åº¦ï¼Œè€Œåœ¨Ubuntu Focal Fossaç³»ç»Ÿä¸Šå´ä¸èƒ½ï¼Ÿ</h1>
<p>Alphaé€šé“æ§åˆ¶çª—å£çš„é€æ˜åº¦(transparency)ã€‚è€ŒX11çª—å£ç³»ç»Ÿä¸Šï¼Œalphaé€šé“æ˜¯å¦å¯ç”¨ï¼Œå’ŒX11 Serverçš„RENDERæ‰©å±•æœ‰å…³ï¼Œä¸‹é¢æ¥è‡ªglfwçš„ä»£ç æ˜¯è‡ªæ˜çš„(self-explanatory)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GLFWbool _glfwIsVisualTransparentX11(Visual* visual)</span><br><span class="line">&#123;</span><br><span class="line">    if (!_glfw.x11.xrender.available)</span><br><span class="line">        return GLFW_FALSE;</span><br><span class="line"></span><br><span class="line">    XRenderPictFormat* pf = XRenderFindVisualFormat(_glfw.x11.display, visual);</span><br><span class="line">    return pf &amp;&amp; pf-&gt;direct.alphaMask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…³äºç³»ç»Ÿä¸Šçš„ X11 Server çš„ RENDER æ‰©å±•çš„ä¿¡æ¯å¯ä»¥é€šè¿‡ <code>xdpyinfo</code> å‘½ä»¤æŸ¥çœ‹(æ­¤å‘½ä»¤è¾“å‡ºå¾ˆå¤šä¿¡æ¯)</p>
<ul>
<li>Render formats</li>
</ul>
<p><code>xdpyinfo -ext RENDER | awk '/Render formats/,/Screen formats/'</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> Render formats :</span><br><span class="line"> pict format:</span><br><span class="line">format id:    0x25</span><br><span class="line">type:         Direct</span><br><span class="line">depth:        1</span><br><span class="line">alpha:         0 mask 0x1</span><br><span class="line">red:           0 mask 0x0</span><br><span class="line">green:         0 mask 0x0</span><br><span class="line">blue:          0 mask 0x0</span><br><span class="line"> pict format:</span><br><span class="line"> ...</span><br><span class="line"> pict format:</span><br><span class="line">format id:    0x40</span><br><span class="line">type:         Direct</span><br><span class="line">depth:        32</span><br><span class="line">alpha:         0 mask 0x0</span><br><span class="line">red:           0 mask 0x3ff</span><br><span class="line">green:        10 mask 0x3ff</span><br><span class="line">blue:         20 mask 0x3ff</span><br><span class="line"> Screen formats :</span><br></pre></td></tr></table></figure>
<ul>
<li>Screen formats</li>
</ul>
<p><code>xdpyinfo -ext RENDER | awk '/Screen formats/,/depth formats/'</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Screen formats :</span><br><span class="line">  Screen 0 (sub-pixel order Unknown)</span><br><span class="line">    filters: nearest, bilinear, convolution, fast(nearest), good(bilinear), best(bilinear)</span><br><span class="line">    visual format:</span><br><span class="line">      visual id:      0x23</span><br><span class="line">      pict format id: 0x2c</span><br><span class="line">      ...</span><br><span class="line">    visual format:</span><br><span class="line">      visual id:      0x3a0</span><br><span class="line">      pict format id: 0x28</span><br><span class="line">   depth formats:</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä½¿ç”¨ <code>xdpyinfo</code> å‘½ä»¤å¾—åˆ°ä¸¤å¼ è¡¨ï¼š</p>
<ul>
<li><strong>Render formats</strong> è¡¨åˆ—å‡ºäº†æ‰€æœ‰ RENDER æ‰©å±•æ”¯æŒçš„é¢œè‰²æ ¼å¼çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å®ƒä»¬çš„ä½æ·± (depth), ä»¥åŠæ¯ä¸ª Component çš„ä½æ·± (mask)</li>
<li><strong>Screen formats</strong> è¡¨å®é™…ä¸Šåˆ—å‡ºçš„æ˜¯æ‰€æœ‰ X Visual ä¸ Render formats çš„ç»‘å®šå…³ç³»</li>
</ul>
<p>æ¥ä¸‹æ¥åªéœ€è¦æŸ¥çœ‹ä¸€ä¸‹ç¨‹åº(æˆ–è€… GLFW )é€‰å–çš„ X Visual çš„ Render format çš„ Alpha åˆ†é‡çš„ä½æ·±æ˜¯å¦ä¸º 0ã€‚ 0 æ„å‘³ç€ GLFW è·å–çš„ <code>GLFW_TRANSPARENT_FRAMEBUFFER</code> å±æ€§æ˜¯<code>FALSE</code>, ä¹Ÿå°±æ„å‘³ç€ GLFW åˆ›å»ºçš„è¿™ä¸ªçª—å£ä¸­ï¼Œæ— æ³•é€šè¿‡ä¿®æ”¹é¢œè‰²çš„ Alpha åˆ†é‡æ¥æ”¹å˜çª—å£çš„é€æ˜åº¦, å› ä¸ºåº”ç”¨çš„çª—å£å’Œæ¡Œé¢èƒŒæ™¯çš„èåˆ(ä½ æ˜¯å¦èƒ½é€è¿‡çª—å£çœ‹åˆ°æ¡Œé¢)æ˜¯ X11 æ§åˆ¶çš„ã€‚</p>
<p>æˆ‘ç³»ç»Ÿä¸Š(WSL Ubuntu 20.04)ç»å¤§éƒ¨åˆ†VISUALå¯¹åº”çš„éƒ½æ˜¯è¿™ä¸ªIDä¸º<code>0x2c</code>çš„<strong>pict format</strong>, æ‰€ä»¥æˆ‘ä¸èƒ½é€šè¿‡ä¿®æ”¹alphaé€šé“æ”¹å˜çª—å£èƒŒæ™¯æˆ–å†…å®¹çš„é€æ˜åº¦ï¼Œé™¤éæˆ‘å¼ºåˆ¶è®©glfwé€‰æ‹©å…¶å®ƒçš„VISUAL(å¯¹åº”çš„<strong>pict format</strong>ä¸æ˜¯<code>0x2c</code>)ã€‚</p>
<p>ä¸ºäº†ç¡®å®šè¿™ä¸ªé—®é¢˜çš„ç¡®æ˜¯VISUALæƒ¹çš„ç¥¸ï¼Œæˆ‘æƒ³æ‘†è„±glfwï¼Œåœ¨å•çº¯çš„GLXç¯å¢ƒä¸‹æµ‹è¯•ä¸€ä¸‹ï¼Œæ­£å¥½<a href="https://gitlab.freedesktop.org/mesa/demos">mesa/demos</a>è¿™ä¸ªå·¥ç¨‹ä¸‹æœ‰ä¸€ä¸ª<strong>glxgears_fbconfig</strong>ï¼Œè¿™ä¸ªdemoå…è®¸é€šè¿‡<code>GLX_FBCONFIG_ID</code>æ¥æŒ‡å®šä½ æƒ³è¦çš„ <code>GLXFBConfig</code>ï¼Œ è€Œ <code>GLXFBConfig</code> å’Œ <code>XVisualInfo</code> è™½ç„¶æ˜¯ä¸åŒç»„ä»¶é‡Œå®šä¹‰çš„æè¿° FB é…ç½®çš„æ•°æ®ç»“æ„(å‰è€…æ˜¯ <strong>Mesa GLX</strong> é‡Œå®šä¹‰çš„ï¼Œè€Œåè€…æ˜¯ <strong>X11 Util</strong> é‡Œå®šä¹‰çš„), ä½†ä¸¤è€…å­˜åœ¨ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚</p>
<p><img src="/images/kylin-alpha-issue/fbconfig.png" alt="GLXFBConfig vs XVisualInfo" /></p>
<ul>
<li>
<p>visual id: 0x5b, pict format id 0x28</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pict format:</span><br><span class="line">      format id:    0x28</span><br><span class="line">      type:         Direct</span><br><span class="line">      depth:        32</span><br><span class="line">      alpha:        24 mask 0xff</span><br><span class="line">      red:          16 mask 0xff</span><br><span class="line">      green:         8 mask 0xff</span><br><span class="line">      blue:          0 mask 0xff</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>visual id: 0x23, pict format id 0x2c</p>
</li>
</ul>
<p>æ³¨æ„ï¼Œä¸ºäº†æ›´æ¸…æ¥šåœ°çœ‹å‡ºä¸åŒï¼Œæˆ‘ä½¿ç”¨<code>glClearBufferfv</code>å°†èƒŒæ™¯è®¾ç½®ä¸ºåŠé€æ˜</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/xdemos/glxgears_fbconfig.c b/src/xdemos/glxgears_fbconfig.c</span></span><br><span class="line"><span class="comment">index 8806dd1c..7d6cbd29 100644</span></span><br><span class="line"><span class="comment">--- a/src/xdemos/glxgears_fbconfig.c</span></span><br><span class="line"><span class="comment">+++ b/src/xdemos/glxgears_fbconfig.c</span></span><br><span class="line">@@ -35,0 +36 @@</span><br><span class="line"><span class="addition">+#define GL_GLEXT_PROTOTYPES</span></span><br><span class="line">@@ -242,0 +244 @@ draw(void)</span><br><span class="line"><span class="addition">+    static const GLfloat bg[] = &#123;0.0, 0.0, 0.0, 0.5&#125;;</span></span><br><span class="line"><span class="addition">+    @@ -243,0 +246 @@ draw(void)</span></span><br><span class="line"><span class="addition">+    +   glClearBufferfv(GL_COLOR, 0, bg);</span></span><br><span class="line"><span class="addition">+    @@ -439,0 +443 @@ make_window( Display *dpy, const char *name,</span></span><br><span class="line"><span class="addition">+    +            GLX_VISUAL_ID,     0x23,)</span></span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ç»“æœå¦‚ä¸‹:</p>
<p><img src="/images/kylin-alpha-issue/visual_0x23.png" alt="VisualID=0x23" /><br />
<img src="/images/kylin-alpha-issue/visual_0x5b.png" alt="VisualID=0x5b" /></p>
<p>ä»æµ‹è¯•ç»“æœçœ‹ï¼Œåœ¨<code>VisualID=0x23</code>çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªVISUALå¯¹åº”çš„<code>pict format</code>æ²¡æœ‰alphaé€šé“ï¼Œæ‰€ä»¥ä¿®æ”¹<code>bg</code>çš„alphaå€¼ä¸ä¼šå¯¹çª—å£èƒŒæ™¯çš„é€æ˜åº¦æœ‰ä»»ä½•å½±å“ã€‚</p>
<h1 id="glx-visual-å’Œ-fbconfig-ä¸æ˜¯ä¸€å›äº‹"><a class="markdownIt-Anchor" href="#glx-visual-å’Œ-fbconfig-ä¸æ˜¯ä¸€å›äº‹"></a> glx visual å’Œ fbconfig ä¸æ˜¯ä¸€å›äº‹</h1>
<p>æ‰€ä»¥ <strong>GLX_VISUAL_ID</strong> å’Œ <strong>GLX_FBCONFIG_ID</strong> ä¹Ÿä¸æ˜¯ä¸€å›äº‹ï¼Œ è™½ç„¶å®ƒä¿©éƒ½æ˜¯ <code>XID</code>, ä½† mesa çš„å®ç°è™½ç„¶å°† glx visual å’Œ fbconfig ç»Ÿä¸€ç”¨ <code>glx_config</code> æ¥è¡¨ç¤º, ä½†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_GLX_PUBLIC XVisualInfo *</span><br><span class="line"><span class="title function_">glXChooseVisual</span><span class="params">(Display * dpy, <span class="type">int</span> screen, <span class="type">int</span> *attribList)</span>;</span><br><span class="line"></span><br><span class="line">_GLX_PUBLIC GLXFBConfig *</span><br><span class="line"><span class="title function_">glXChooseFBConfig</span><span class="params">(Display * dpy, <span class="type">int</span> screen, <span class="type">const</span> <span class="type">int</span> *attribList, <span class="type">int</span> *nitems)</span></span><br></pre></td></tr></table></figure>
<p>æ˜¯å®Œå…¨ä¸åŒçš„å®ç°ï¼Œè€Œä¸” mesa çš„ <code>glXChooseVisual()</code> å®é™…ä¸Šæ— æ³•é€šè¿‡æŒ‡å®š <strong>GLX_VISUAL_ID</strong> æ¥é€‰æ‹©æŸä¸ªç‰¹å®šçš„ X Visual (è¿™å¯èƒ½æ˜¯ä¸€ä¸ª Bug)ã€‚</p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>X11</tag>
      </tags>
  </entry>
  <entry>
    <title>Pixmap in X</title>
    <url>/gfx/X/pixmap/</url>
    <content><![CDATA[<h1 id="xypixmap"><a class="markdownIt-Anchor" href="#xypixmap"></a> XYPixmap</h1>
<p>The data for a XYPixmap is organized as a set of bitmaps representing individual bit planes, with the planes appearing from MSB to LSB in bit order just as demonstrated below. Every pixel value is 0x55 (bâ€™01010101) in this example.</p>
<span id="more"></span>
<pre>
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚1111111111111111111111111111â”‚        
                            â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”1â”‚
                            â”‚0000000000000000000000000000â”‚1â”‚        
                          â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”0â”‚1â”‚
                          â”‚1111111111111111111111111111â”‚0â”‚1â”‚        
                        â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”1â”‚0â”‚1â”‚
                        â”‚0000000000000000000000000000â”‚1â”‚0â”‚1â”‚        
                      â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”0â”‚1â”‚0â”‚1â”‚
                      â”‚1111111111111111111111111111â”‚0â”‚1â”‚0â”‚1â”‚        
                    â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”1â”‚0â”‚1â”‚0â”‚1â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ plane_7 
                    â”‚0000000000000000000000000000â”‚1â”‚0â”‚1â”‚0â”‚â”€â”˜        
                  â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”0â”‚1â”‚0â”‚1â”‚0â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ plane_6 
                  â”‚1111111111111111111111111111â”‚0â”‚1â”‚0â”‚1â”‚â”€â”˜       
                â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”1â”‚0â”‚1â”‚0â”‚1â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ plane_5 
                â”‚0000000000000000000000000000â”‚1â”‚0â”‚1â”‚0â”‚â”€â”˜      
                â”‚0000000000000000000000000000â”‚1â”‚0â”‚1â”‚0â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ plane_4       
                â”‚0000000000000000000000000000â”‚1â”‚0â”‚1â”‚â”€â”˜      
                â”‚0000000000000000000000000000â”‚1â”‚0â”‚1â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ plane_3       
                â”‚0000000000000000000000000000â”‚1â”‚0â”‚â”€â”˜      
                â”‚0000000000000000000000000000â”‚1â”‚0â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ plane_2  
                â”‚0000000000000000000000000000â”‚1â”‚â”€â”˜       
                â”‚0000000000000000000000000000â”‚1â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ plane_1        
                â”‚0000000000000000000000000000â”‚â”€â”˜       
                â”‚0000000000000000000000000000â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ plane_0       
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
<h1 id="pixel-buffer"><a class="markdownIt-Anchor" href="#pixel-buffer"></a> Pixel buffer</h1>
<p>As a core feature of GLX &amp; EGL, pixel buffer or pBuffer is allowed for off-screen rendering. Pixel buffer is essentially a renderable area allocated by OpenGL itself (most likely a framebuffer) and is bound to an OpenGL rendering context.</b><br />
With respect to GLX, <code>glXCreatePbuffer</code> creates a pixel buffer and return its <code>XID</code>. In the implementation of Mesa, it calls <code>XCreatPixmap</code> to get an <code>XID</code> which is bound to the pixel buffer.</p>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>X11</tag>
      </tags>
  </entry>
  <entry>
    <title>mesaä¸­çš„winsyså±‚</title>
    <url>/gfx/X/winsys/</url>
    <content><![CDATA[<h1 id="winsysæœ‰ä»€ä¹ˆç”¨"><a class="markdownIt-Anchor" href="#winsysæœ‰ä»€ä¹ˆç”¨"></a> winsysæœ‰ä»€ä¹ˆç”¨</h1>
<p>winsysåƒä¸€ä¸ªæ¡¥æ¢ï¼Œå®ƒè¦å°†GPUæ¸²æŸ“çš„ç»“æœä¼ è¾“åˆ°çª—å£ç³»ç»Ÿçš„framebufferï¼Œç”±æ˜¾ç¤ºç³»ç»Ÿå°†å…¶å‘ˆç°åœ¨å±å¹•ä¸Šã€‚</p>
<span id="more"></span>
<img src="/gfx/X/winsys/winsys-Page-2.drawio.png" class="" title="winsys">
<h1 id="mesaä¸­çš„å®ç°"><a class="markdownIt-Anchor" href="#mesaä¸­çš„å®ç°"></a> mesaä¸­çš„å®ç°</h1>
<p>mesaä¸­winsysæœ‰ä¸¤ç§å®ç°: ä¸€ç§æ˜¯åŸºäºdriçš„ï¼Œå¦ä¸€ç§æ˜¯ä¸åŸºäºdriçš„ã€‚ä¸¤è€…çš„ä¸»è¦åŒºåˆ«åœ¨ä»¥ä¸‹å‡ ç‚¹:</p>
<ul>
<li>winsysæä¾›çš„FBO(ä¸Šå›¾ä¸­çš„framebuffer)çš„æ¥æº</li>
</ul>
<h2 id="åŸºäºdri"><a class="markdownIt-Anchor" href="#åŸºäºdri"></a> åŸºäºdri</h2>
<ul>
<li>amdgpu_winsys</li>
<li>radeon_winsys</li>
<li>nouveau_winsys</li>
</ul>
<p>åŸºäºdriçš„winsysçš„å®ç°ä»£ç åœ¨<code>src/gallium/frontends/dri</code>ç›®å½•</p>
<h3 id="åŸºäºdri-winsysçš„gallium-driverçš„åŠ è½½"><a class="markdownIt-Anchor" href="#åŸºäºdri-winsysçš„gallium-driverçš„åŠ è½½"></a> åŸºäºdri winsysçš„gallium driverçš„åŠ è½½</h3>
<p>æ‰€æœ‰ä½¿ç”¨åŸºäºdriçš„winsysçš„gallium driverséƒ½ä¼šåˆ©ç”¨ä¸‹é¢çš„å®å£°æ˜å’Œå®šä¹‰ä¸€ä¸ªå‡½æ•°ç¬¦å·(é™¤äº†swrast)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#define DEFINE_LOADER_DRM_ENTRYPOINT(drivername)                          \</span><br><span class="line">const __DRIextension **__driDriverGetExtensions_##drivername(void);       \</span><br><span class="line">PUBLIC const __DRIextension **__driDriverGetExtensions_##drivername(void) \</span><br><span class="line">&#123;                                                                         \</span><br><span class="line">   globalDriverAPI = &amp;galliumdrm_driver_api;                              \</span><br><span class="line">   return galliumdrm_driver_extensions;                                   \</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼Œ<code>const __DRIextension **__driDriverGetExtensions_r600(void);</code>. ä½ å¯ä»¥åœ¨ç›¸åº”çš„åŠ¨æ€åº“é‡ŒæŸ¥æ‰¾åˆ°è¯¥ç¬¦å·ã€‚<br />
ä¸Šé¢å®ä¸­çš„<code>galliumdrm_driver_api</code>å’Œ<code>galliumdrm_driver_extensions</code>éƒ½æ˜¯å…¨å±€çš„ã€‚</p>
<ul>
<li><code>galliumdrm_driver_api</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">const struct __DriverAPIRec galliumdrm_driver_api = &#123;</span><br><span class="line">   .InitScreen = dri2_init_screen,</span><br><span class="line">   .DestroyScreen = dri_destroy_screen,</span><br><span class="line">   .CreateContext = dri_create_context,</span><br><span class="line">   .DestroyContext = dri_destroy_context,</span><br><span class="line">   .CreateBuffer = dri2_create_buffer,</span><br><span class="line">   .DestroyBuffer = dri_destroy_buffer,</span><br><span class="line">   .MakeCurrent = dri_make_current,</span><br><span class="line">   .UnbindContext = dri_unbind_context,</span><br><span class="line"></span><br><span class="line">   .AllocateBuffer = dri2_allocate_buffer,</span><br><span class="line">   .ReleaseBuffer  = dri2_release_buffer,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>galliumdrm_driver_extensions</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/* This is the table of extensions that the loader will dlsym() for. */</span><br><span class="line">const __DRIextension *galliumdrm_driver_extensions[] = &#123;</span><br><span class="line">    &amp;driCoreExtension.base,</span><br><span class="line">    &amp;driImageDriverExtension.base,</span><br><span class="line">    &amp;driDRI2Extension.base,</span><br><span class="line">    &amp;gallium_config_options.base,</span><br><span class="line">    NULL</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå‡ºç°çš„4ä¸ªæ•°ç»„å…ƒç´ éƒ½æ˜¯<code>__DRIextension</code>çš„å­ç±»ï¼ŒåŒæ—¶ä»–ä»¬éƒ½æ˜¯å…¨å±€çš„ã€‚ä¾‹å¦‚<code>driImageDriverExtension</code>è¢«å®šä¹‰åœ¨<code>src/mesa/drivers/dri/common/dri_util.c</code>æ–‡ä»¶ä¸­:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/** Image driver interface */</span><br><span class="line">const __DRIimageDriverExtension driImageDriverExtension = &#123;</span><br><span class="line">    .base = &#123; __DRI_IMAGE_DRIVER, 1 &#125;,</span><br><span class="line"></span><br><span class="line">    .createNewScreen2           = driCreateNewScreen2,</span><br><span class="line">    .createNewDrawable          = driCreateNewDrawable,</span><br><span class="line">    .getAPIMask                 = driGetAPIMask,</span><br><span class="line">    .createContextAttribs       = driCreateContextAttribs,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>é™¤äº†è¿™ä¸ª<code>driImageDriverExtension</code>ï¼ŒåŸºäºdriçš„winsysè¿˜å®šä¹‰äº†ä¸€ä¸ªä¸<code>__DRIimage</code>æœ‰å…³çš„<code>__DRIextension</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/* The image loader extension record for DRI3</span><br><span class="line"> */</span><br><span class="line">static const __DRIimageLoaderExtension imageLoaderExtension = &#123;</span><br><span class="line">   .base = &#123; __DRI_IMAGE_LOADER, 3 &#125;,</span><br><span class="line"></span><br><span class="line">   .getBuffers          = loader_dri3_get_buffers,</span><br><span class="line">   .flushFrontBuffer    = dri3_flush_front_buffer,</span><br><span class="line">   .flushSwapBuffers    = dri3_flush_swap_buffers,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ‰€è°“çš„image loader extensionæ˜¯åœ¨å¤šGPUçš„åœºæ™¯ä¸‹ä¼šç”¨åˆ°ï¼Œä¹Ÿå°±æ˜¯å½“ç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨ä¸¤ä¸ªGPUæ—¶ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®mesaæä¾›çš„ç¯å¢ƒå˜é‡<code>DRI_PRIME</code>ï¼Œå¯ç”¨PRIMEæ¨¡å¼ï¼Œæ­¤æ—¶å…¶ä¸­ä¸€ä¸ªGPUä½œä¸ºDisplay GPU(server GPU), ç”¨åšX11æ˜¾ç¤ºï¼Œå¦å¤–ä¸€ä¸ªGPUä½œä¸ºRender GPU, ç”¨åš3Dæ¸²æŸ“ï¼Œå½“æˆ‘ä»¬ç”³è¯·<code>__DRI_IMAGE_BUFFER_FRONT</code>æ—¶ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨pixmap,<br />
å› ä¸ºæ‰€æœ‰pixmapséƒ½æ˜¯è¢«server GPUæ‰€æœ‰ï¼Œè¿™ç§pixmapçš„æ ¼å¼å¯èƒ½ä¸èƒ½è¢«render GPUæ‰€ç†è§£ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨<code>loader_dri3_get_buffers</code>ä¸­ï¼Œä¼šåœ¨render GPUçš„VRAMé‡Œåˆ›å»ºä¸€ä¸ªFake Front Buffer, æœ€å<code>dri3_flush_front_buffer</code>ä¼šå°†Fake Front Bufferçš„å†…å®¹åŒæ­¥åˆ°çœŸæ­£çš„Front Bufferï¼Œå³display GPUçš„pixmapé‡Œã€‚</p>
<ul>
<li><code>xcb_dri3_pixmap_from_buffer</code></li>
</ul>
<p>è¿™ä¸ªå‡½æ•°æ˜¯ç”±<code>c_client.py</code>è‡ªåŠ¨ç”Ÿæˆçš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xcb_void_cookie_t</span><br><span class="line">xcb_dri3_pixmap_from_buffer (xcb_connection_t *c,</span><br><span class="line">                             xcb_pixmap_t      pixmap,</span><br><span class="line">                             xcb_drawable_t    drawable,</span><br><span class="line">                             uint32_t          size,</span><br><span class="line">                             uint16_t          width,</span><br><span class="line">                             uint16_t          height,</span><br><span class="line">                             uint16_t          stride,</span><br><span class="line">                             uint8_t           depth,</span><br><span class="line">                             uint8_t           bpp,</span><br><span class="line">                             int32_t           pixmap_fd)</span><br><span class="line">&#123;</span><br><span class="line">    static const xcb_protocol_request_t xcb_req = &#123;</span><br><span class="line">        .count = 2,</span><br><span class="line">        .ext = &amp;xcb_dri3_id,</span><br><span class="line">        .opcode = XCB_DRI3_PIXMAP_FROM_BUFFER,</span><br><span class="line">        .isvoid = 1</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    struct iovec xcb_parts[4];</span><br><span class="line">    xcb_void_cookie_t xcb_ret;</span><br><span class="line">    xcb_dri3_pixmap_from_buffer_request_t xcb_out;</span><br><span class="line">    int fds[1];</span><br><span class="line">    int fd_index = 0;</span><br><span class="line"></span><br><span class="line">    xcb_out.pixmap = pixmap;</span><br><span class="line">    xcb_out.drawable = drawable;</span><br><span class="line">    xcb_out.size = size;</span><br><span class="line">    xcb_out.width = width;</span><br><span class="line">    xcb_out.height = height;</span><br><span class="line">    xcb_out.stride = stride;</span><br><span class="line">    xcb_out.depth = depth;</span><br><span class="line">    xcb_out.bpp = bpp;</span><br><span class="line"></span><br><span class="line">    xcb_parts[2].iov_base = (char *) &amp;xcb_out;</span><br><span class="line">    xcb_parts[2].iov_len = sizeof(xcb_out);</span><br><span class="line">    xcb_parts[3].iov_base = 0;</span><br><span class="line">    xcb_parts[3].iov_len = -xcb_parts[2].iov_len &amp; 3;</span><br><span class="line"></span><br><span class="line">    fds[fd_index++] = pixmap_fd;</span><br><span class="line">    xcb_ret.sequence = xcb_send_request_with_fds(c, 0, xcb_parts + 2, &amp;xcb_req, 1, fds);</span><br><span class="line">    return xcb_ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€ŒX Serveræ”¶åˆ°è¿™ä¸ªrequeståçš„å¤„ç†å‡½æ•°å¦‚ä¸‹:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">int</span><br><span class="line">dri3_pixmap_from_fds(PixmapPtr *ppixmap, ScreenPtr screen,</span><br><span class="line">                     CARD8 num_fds, const int *fds,</span><br><span class="line">                     CARD16 width, CARD16 height,</span><br><span class="line">                     const CARD32 *strides, const CARD32 *offsets,</span><br><span class="line">                     CARD8 depth, CARD8 bpp, CARD64 modifier)</span><br><span class="line">&#123;</span><br><span class="line">    dri3_screen_priv_ptr        ds = dri3_screen_priv(screen);</span><br><span class="line">    const dri3_screen_info_rec *info = ds-&gt;info;</span><br><span class="line">    PixmapPtr                   pixmap;</span><br><span class="line"></span><br><span class="line">    if (!info)</span><br><span class="line">        return BadImplementation;</span><br><span class="line"></span><br><span class="line">    if (info-&gt;version &gt;= 2 &amp;&amp; info-&gt;pixmap_from_fds != NULL) &#123;</span><br><span class="line">        pixmap = (*info-&gt;pixmap_from_fds) (screen, num_fds, fds, width, height,</span><br><span class="line">                                           strides, offsets, depth, bpp, modifier);</span><br><span class="line">    &#125; else if (info-&gt;pixmap_from_fd != NULL &amp;&amp; num_fds == 1) &#123;</span><br><span class="line">        pixmap = (*info-&gt;pixmap_from_fd) (screen, fds[0], width, height,</span><br><span class="line">                                          strides[0], depth, bpp);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return BadImplementation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!pixmap)</span><br><span class="line">        return BadAlloc;</span><br><span class="line"></span><br><span class="line">    *ppixmap = pixmap;</span><br><span class="line">    return Success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆæ˜¯è°ƒç”¨äº†<code>pixmap_from_fds</code>æˆ–<code>pixmap_from_fd</code>, æ¥ä¸‹æ¥çš„å·¥ä½œç”±display GPUçš„kmdå®Œæˆï¼Œæœ€åå½“display GPU <code>gbm_bo_import</code>è°ƒç”¨äº†<code>drmPrimeFDToHandle</code>å‡½æ•°åï¼ŒX Serverè¿›ç¨‹è¿›å…¥å†…æ ¸æ€ï¼Œæ¥ä¸‹æ¥å†…æ ¸DRMå­ç³»ç»Ÿçš„ioctlä¼šè°ƒç”¨<code>drm_prime_fd_to_handle_ioctl</code>, å®ƒä¼šè°ƒç”¨display GPUçš„<code>prime_fd_to_handle</code> callback. æ•´ä¸ªè¿‡ç¨‹å…¶å®æ˜¯å°†æ˜¾å­˜(buffer, ç¡®åˆ‡è¯´æ˜¯back buffer)æŠ½è±¡æˆdma-buf(dma-bufå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥å®ƒæœ‰fd, å¯ä¾›åœ¨è¿›ç¨‹é—´ä¼ é€’)æ¥å®ç°ç”¨æˆ·åº”ç”¨è¿›ç¨‹ä¸X Serverè¿›ç¨‹é—´çš„Bufferå…±äº«ã€‚</p>
<img src="/gfx/X/winsys/winsys-Page-9.drawio.png" class="" title="dma-buf">
<p>ä¸‹é¢æ˜¯å†…æ ¸å‡½æ•°<code>dma_buf_get</code>çš„å®ç°ï¼Œä»è¿™ä¸ªå°å‡½æ•°çš„å®ç°æˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°fd -&gt; file -&gt; dma_bufçš„è½¬æ¢</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * dma_buf_get - returns the struct dma_buf related to an fd</span></span><br><span class="line"><span class="comment"> * @fd:	[in]	fd associated with the struct dma_buf to be returned</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * On success, returns the struct dma_buf associated with an fd; uses</span></span><br><span class="line"><span class="comment"> * file&#x27;s refcounting done by fget to increase refcount. returns ERR_PTR</span></span><br><span class="line"><span class="comment"> * otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> dma_buf *<span class="title function_">dma_buf_get</span><span class="params">(<span class="type">int</span> fd)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line"></span><br><span class="line">	file = fget(fd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!file)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-EBADF);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!is_dma_buf_file(file)) &#123;</span><br><span class="line">		fput(file);</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> file-&gt;private_data;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(dma_buf_get);</span><br></pre></td></tr></table></figure>
<h3 id="åŸºäºdri-winsysçš„gallium-driverçš„winsyså®ç°"><a class="markdownIt-Anchor" href="#åŸºäºdri-winsysçš„gallium-driverçš„winsyså®ç°"></a> åŸºäºdri winsysçš„gallium driverçš„winsyså®ç°</h3>
<p>winsysæ˜¯ä¸€ä¸ªæ¡¥æ¢ï¼Œå®ƒä¸»è¦è¦å®ç°çš„å°±æ˜¯å°†color bufferä¼ è¾“åˆ°çª—å£ç³»ç»Ÿçš„framebuffer.é‚£ä¹ˆåŸºäºdriçš„winsysæ˜¯æ€ä¹ˆå®ç°è¿™ä¸ªæ¡¥æ¢çš„? å®ƒä¸»è¦ä¾èµ–ä¸‹é¢ä¸¤ä¸ªå¯¹è±¡:</p>
<ul>
<li>DRIimage
<ul>
<li><code>__DRIimageRec</code></li>
<li><code>__DRIimageExtensionRec</code></li>
</ul>
</li>
</ul>
<p>DRIimageé€šè¿‡è°ƒç”¨<code>pipe_screen.resource_create</code>å‡½æ•°åˆ›å»ºï¼Œåˆ›å»ºåè¿˜éœ€è¦queryImageä¸€äº›ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ä¸ºX11æ‰€éœ€è¦ã€‚</p>
<ul>
<li>PIPE_RESOURCE_PARAM_NPLANES</li>
<li>PIPE_RESOURCE_PARAM_STRIDE</li>
<li>PIPE_RESOURCE_PARAM_OFFSET</li>
<li>PIPE_RESOURCE_PARAM_MODIFIER</li>
<li>PIPE_RESOURCE_PARAM_HANDLE_TYPE_FD</li>
</ul>
<p><code>PIPE_RESOURCE_PARAM_HANDLE_TYPE_FD</code>é€šè¿‡å‘kernelå‘é€ä¸‹é¢è¯·æ±‚ï¼Œç”±ä¸€ä¸ªgem handleè¿”å›ä¸€ä¸ªfile descriptor. æœ‰äº†è¿™ä¸ªFD, ä¸åŒçš„è¿›ç¨‹é—´å°±å¯ä»¥å…±äº«å†…å­˜ã€‚æ¯”æ–¹ï¼Œå½“xserverè·å–åˆ°è¿™ä¸ªFDåï¼Œå®ƒå¯ä»¥é€šè¿‡<code>DRM_IOCTL_PRIME_FD_TO_HANDLE</code>åˆé‡æ–°è·å–åˆ°gem boçš„handle.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">int</span><br><span class="line">panfrost_bo_export(struct panfrost_bo *bo)</span><br><span class="line">&#123;</span><br><span class="line">        struct drm_prime_handle args = &#123;</span><br><span class="line">                .handle = bo-&gt;gem_handle,</span><br><span class="line">                .flags = DRM_CLOEXEC,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        int ret = drmIoctl(bo-&gt;dev-&gt;fd, DRM_IOCTL_PRIME_HANDLE_TO_FD, &amp;args);</span><br><span class="line">        if (ret == -1)</span><br><span class="line">                return -1;</span><br><span class="line"></span><br><span class="line">        bo-&gt;flags |= PAN_BO_SHARED;</span><br><span class="line">        return args.fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>X11 present extension</li>
</ul>
<h2 id="édri"><a class="markdownIt-Anchor" href="#édri"></a> édri</h2>
<ul>
<li>sw_winsys</li>
</ul>
<p>édriçš„winsysçš„å®ç°ä»£ç åœ¨<code>src/gallium/winsys/sw/xlib</code>ç›®å½•</p>
<p>ä¸åŒçš„winsyså®é™…ä¸Šæ˜¯ä¸åŒçš„æ¥å£(å‡½æ•°)ï¼Œä¸‹é¢ä»¥sw_winsysä¸ºä¾‹è¯´æ˜ä¸€ä¸‹mesaé‡Œçš„winsysçš„æ¥å£ä¸å®ç°ã€‚</p>
<table>
<thead>
<tr>
    <th>æ¥å£</th>
    <th>å®ç°</th>
    <th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody>
<tr>
    <td>void<br>(*destroy)(struct sw_winsys *ws);</td>
    <td>xlib_displaytarget_destroy</td>
    <td>é”€æ¯è¿™ä¸ªwinsys</td>
</tr>
<tr>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
    <td></td>
    <td></td>
    <td></td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>X11</tag>
      </tags>
  </entry>
  <entry>
    <title>X11ä¸­çš„Display, Screen, Depthå’ŒVisual</title>
    <url>/gfx/X/x-display/</url>
    <content><![CDATA[<h1 id="xçª—å£ç³»ç»Ÿ"><a class="markdownIt-Anchor" href="#xçª—å£ç³»ç»Ÿ"></a> Xçª—å£ç³»ç»Ÿ</h1>
<p><a href="https://en.wikipedia.org/wiki/X_Window_System">Xçª—å£ç³»ç»Ÿ</a>è¯ç”Ÿäº1984å¹´MITçš„ç ”ç©¶ï¼Œåæ¥æˆä¸ºUnix, ç±»UNIXç­‰æ“ä½œç³»ç»Ÿæ‰€ä¸€è‡´é€‚ç”¨çš„æ ‡å‡†åŒ–è½¯ä»¶å·¥å…·åŒ…åŠæ˜¾ç¤ºæ¶æ„çš„è¿ä½œåè®®ã€‚ç›®å‰ä½¿ç”¨æœ€æ™®éæœ€å—æ¬¢è¿çš„ä¸€ä¸ªå®ç°æ˜¯<a href="https://www.x.org/wiki/">X.Org</a>ï¼Œå®ƒæ‰€ç”¨çš„åè®®ç‰ˆæœ¬æ˜¯<strong>X11</strong>, æ‰€ä»¥Xorgä¹Ÿç»å¸¸è¢«å«åšX11ã€‚</p>
<span id="more"></span>
<h1 id="å®ƒä»¬æ˜¯ä»€ä¹ˆ"><a class="markdownIt-Anchor" href="#å®ƒä»¬æ˜¯ä»€ä¹ˆ"></a> å®ƒä»¬æ˜¯ä»€ä¹ˆ</h1>
<h2 id="display"><a class="markdownIt-Anchor" href="#display"></a> Display</h2>
<p>Display datatype maintaining display specific data. The contents of this structure are implementation dependent. A Display should be treated as oqaque by application code.</p>
<h2 id="screen"><a class="markdownIt-Anchor" href="#screen"></a> Screen</h2>
<pre><code>Information about the screen. The contents of this structure are implementation dependent. A Screen should be treated as opaque by application code.
</code></pre>
<h2 id="depth"><a class="markdownIt-Anchor" href="#depth"></a> Depth</h2>
<pre><code>Depth structure; contains information for each possible depth.
</code></pre>
<h2 id="visual"><a class="markdownIt-Anchor" href="#visual"></a> Visual</h2>
<pre><code>Visual structure; contains information about colormapping possible.
</code></pre>
<p>ä»¥ä¸Š4ä¸ªç»“æ„ä½“éƒ½è¢«å®šä¹‰åœ¨<a href="https://gitlab.freedesktop.org/xorg/lib/libx11/-/blob/master/include/X11/Xlib.h">Xlib.h</a>,å®ƒä»¬å››è€…ä¹‹é—´çš„å…³ç³»æ˜¯å‰è€…åŒ…å«å¤šä¸ªåè€…ï¼Œä¾æ¬¡ç±»æ¨ã€‚è¿™é‡Œæ³¨æ„åŒºåˆ†ä¸¤ç»„æ¦‚å¿µ:</p>
<table>
<caption><em>Comparison between Display and DISPLAY</em></caption>
<tr><th><th>Display<th>DISPLAY
<tr><th>Category<td>struct<td>env var
<tr><th>Usage<td>Display *dpy<br>as most Xlib API's first argument<td>e.g. export DISPLAY=:0
</table>
<h1 id="å®ƒä»¬ä¹‹é—´çš„å±‚çº§å…³ç³»"><a class="markdownIt-Anchor" href="#å®ƒä»¬ä¹‹é—´çš„å±‚çº§å…³ç³»"></a> å®ƒä»¬ä¹‹é—´çš„å±‚çº§å…³ç³»</h1>
<pre><code class="highlight mermaid">graph TD
    D[Display]
    D --&gt; s0(Screen0)
    D --&gt; s1(Screen1)
    D --&gt; sN(ScreenN)
    subgraph Screen0
    s0 --&gt; d0(Depth0)
    s0 --&gt; d1(Depth1)
    s0 --&gt; d2(Depth2)
    s0 --&gt; d3(Depth3)
    s0 --&gt; dN(DepthN)
    end
    subgraph Depth0
    d0 --&gt; v0(Visual0)
    d0 --&gt; v1(Visual1)
    d0 --&gt; v2(Visual2)
    d0 --&gt; v3(Visual3)
    d0 --&gt; v4(Visual4)
    d0 --&gt; v5(Visual5)
    d0 --&gt; vN(VisualN)
    end</code></pre>
<h1 id="xdpyinfo"><a class="markdownIt-Anchor" href="#xdpyinfo"></a> <code>xdpyinfo</code></h1>
<p><code>xdpyinfo</code>æ¥è‡ªX11çš„å·¥å…·åŒ…<code>x11-utils</code>, å®ƒå¯ä»¥æ‰“å°å½“å‰<code>DISPLAY</code>çš„Display, Screen, Depth, Visualä¿¡æ¯ï¼Œå½“ç„¶å’Œå…¶å®ƒçš„Xçš„å·¥å…·ä¸€æ ·ï¼Œä½¿ç”¨å‰è¦ç¡®ä¿ç¯å¢ƒå˜é‡<code>DISPLAY</code>å·²ç»ä¸ºæœ‰æ•ˆå€¼ã€‚ä¸‹é¢æ˜¯åœ¨Xorgä½œä¸ºX Serveræ—¶æŸ¥çœ‹åˆ°çš„ç³»ç»ŸX11 Windowçš„ç›¸å…³ä¿¡æ¯ã€‚(åªæˆªå–å‰é¢éƒ¨åˆ†)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">name of display:    :18.0</span><br><span class="line">version number:    11.0</span><br><span class="line">vendor string:    The X.Org Foundation</span><br><span class="line">vendor release number:    12008000</span><br><span class="line">X.Org version: 1.20.8</span><br><span class="line">maximum request size:  16777212 bytes</span><br><span class="line">motion buffer size:  256</span><br><span class="line">bitmap unit, bit order, padding:    32, LSBFirst, 32</span><br><span class="line">image byte order:    LSBFirst</span><br><span class="line">number of supported pixmap formats:    7</span><br><span class="line">supported pixmap formats:</span><br><span class="line">    depth 1, bits_per_pixel 1, scanline_pad 32</span><br><span class="line">    depth 4, bits_per_pixel 8, scanline_pad 32</span><br><span class="line">    depth 8, bits_per_pixel 8, scanline_pad 32</span><br><span class="line">    depth 15, bits_per_pixel 16, scanline_pad 32</span><br><span class="line">    depth 16, bits_per_pixel 16, scanline_pad 32</span><br><span class="line">    depth 24, bits_per_pixel 32, scanline_pad 32</span><br><span class="line">    depth 32, bits_per_pixel 32, scanline_pad 32</span><br><span class="line">keycode range:    minimum 8, maximum 255</span><br><span class="line">focus:  window 0x300000f, revert to PointerRoot</span><br><span class="line">number of extensions:    25</span><br><span class="line">    BIG-REQUESTS</span><br><span class="line">    DAMAGE</span><br><span class="line">    DOUBLE-BUFFER</span><br><span class="line">    DRI2</span><br><span class="line">    GLX</span><br><span class="line">    Generic Event Extension</span><br><span class="line">    MIT-SCREEN-SAVER</span><br><span class="line">    MIT-SHM</span><br><span class="line">    Present</span><br><span class="line">    RANDR</span><br><span class="line">    RECORD</span><br><span class="line">    RENDER</span><br><span class="line">    SECURITY</span><br><span class="line">    SHAPE</span><br><span class="line">    SYNC</span><br><span class="line">    X-Resource</span><br><span class="line">    XC-MISC</span><br><span class="line">    XFIXES</span><br><span class="line">    XFree86-DGA</span><br><span class="line">    XFree86-VidModeExtension</span><br><span class="line">    XINERAMA</span><br><span class="line">    XInputExtension</span><br><span class="line">    XKEYBOARD</span><br><span class="line">    XTEST</span><br><span class="line">    XVideo</span><br><span class="line">default screen number:    0</span><br><span class="line">number of screens:    1</span><br><span class="line"></span><br><span class="line">screen #0:</span><br><span class="line">  dimensions:    1920x1080 pixels (508x286 millimeters)</span><br><span class="line">  resolution:    96x96 dots per inch</span><br><span class="line">  depths (7):    24, 1, 4, 8, 15, 16, 32</span><br><span class="line">  root window id:    0x34d</span><br><span class="line">  depth of root window:    24 planes</span><br><span class="line">  number of colormaps:    minimum 1, maximum 1</span><br><span class="line">  default colormap:    0x20</span><br><span class="line">  default number of colormap cells:    256</span><br><span class="line">  preallocated pixels:    black 0, white 16777215</span><br><span class="line">  options:    backing-store NO, save-unders NO</span><br><span class="line">  largest cursor:    1920x1080</span><br><span class="line">  current input event mask:    0xfa800f</span><br><span class="line">    KeyPressMask             KeyReleaseMask           ButtonPressMask          </span><br><span class="line">    ButtonReleaseMask        ExposureMask             StructureNotifyMask      </span><br><span class="line">    SubstructureNotifyMask   SubstructureRedirectMask FocusChangeMask          </span><br><span class="line">    PropertyChangeMask       ColormapChangeMask       </span><br><span class="line">  number of visuals:    240</span><br><span class="line">  default visual id:  0x21</span><br><span class="line">  visual:</span><br><span class="line">    visual id:    0x21</span><br><span class="line">    class:    TrueColor</span><br><span class="line">    depth:    24 planes</span><br><span class="line">    available colormap entries:    256 per subfield</span><br><span class="line">    red, green, blue masks:    0xff0000, 0xff00, 0xff</span><br><span class="line">    significant bits in color specification:    8 bits</span><br><span class="line">  visual:</span><br><span class="line">    visual id:    0x22</span><br><span class="line">    class:    DirectColor</span><br><span class="line">    depth:    24 planes</span><br><span class="line">    available colormap entries:    256 per subfield</span><br><span class="line">    red, green, blue masks:    0xff0000, 0xff00, 0xff</span><br><span class="line">    significant bits in color specification:    8 bits</span><br><span class="line">  visual:</span><br><span class="line">    visual id:    0x25e</span><br><span class="line">    class:    TrueColor</span><br><span class="line">    depth:    24 planes</span><br><span class="line">    available colormap entries:    256 per subfield</span><br><span class="line">    red, green, blue masks:    0xff0000, 0xff00, 0xff</span><br><span class="line">    significant bits in color specification:    8 bits</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>graphics</category>
      </categories>
      <tags>
        <tag>X11</tag>
      </tags>
  </entry>
</search>
